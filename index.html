<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juego de Adivinar Banderas</title>
    
    <!-- Favicon y iconos móviles -->
    <link rel="icon" type="image/jpeg" href="https://martinpenalva.github.io/Juego_Banderas/OIG1.jpg">
    <link rel="apple-touch-icon" href="https://martinpenalva.github.io/Juego_Banderas/OIG1.jpg">
    <link rel="manifest" href="https://martinpenalva.github.io/Juego_Banderas/manifest.json">
    
    <!-- Meta tags para PWA -->
    <meta name="theme-color" content="#764ba2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Banderas">
    <meta name="description" content="Juego interactivo de adivinar banderas de países con sistema de racha y comodines">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-size: 400% 400%;
            animation: fullWindowBackgroundMove 20s ease infinite;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        /* Fondo animado siempre activo en la ventana de selección */
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: 
                radial-gradient(circle at 30% 40%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 70% 60%, rgba(255, 255, 255, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 50% 80%, rgba(255, 255, 255, 0.06) 0%, transparent 50%);
            animation: fullWindowRadialMove 25s ease-in-out infinite;
            z-index: 0;
            pointer-events: none;
        }

        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.05) 50%, transparent 70%);
            animation: fullWindowShine 10s linear infinite;
            z-index: 0;
            pointer-events: none;
        }

        /* Sobrescribir cuando hay modos de juego activos */
        body.hell-mode,
        body.war-mode,
        body.easy-mode,
        body.god-mode {
            background-size: 100% 100%;
            animation: none;
        }

        body.hell-mode::before,
        body.war-mode::before,
        body.easy-mode::before,
        body.god-mode::before,
        body.hell-mode::after,
        body.war-mode::after,
        body.easy-mode::after,
        body.god-mode::after {
            display: none;
        }

        @keyframes fullWindowBackgroundMove {
            0%, 100% {
                background-position: 0% 50%;
            }
            25% {
                background-position: 100% 50%;
            }
            50% {
                background-position: 100% 100%;
            }
            75% {
                background-position: 0% 100%;
            }
        }

        @keyframes fullWindowRadialMove {
            0%, 100% {
                transform: translate(0, 0) rotate(0deg) scale(1);
            }
            33% {
                transform: translate(50px, -50px) rotate(120deg) scale(1.2);
            }
            66% {
                transform: translate(-50px, 50px) rotate(240deg) scale(0.8);
            }
        }

        @keyframes fullWindowShine {
            0% {
                transform: translateX(-100%) translateY(-100%) rotate(45deg);
            }
            100% {
                transform: translateX(200%) translateY(200%) rotate(45deg);
            }
        }

        body.hell-mode {
            background: linear-gradient(180deg, #1a0000 0%, #4a0000 30%, #8b0000 60%, #ff4500 100%);
            background-size: 100% 100%;
            animation: none;
            /* Desactivar animación de parpadeo para mejor rendimiento */
            /* animation: hellFlicker 0.5s ease-in-out infinite alternate; */
        }

        body.hell-mode::before,
        body.hell-mode::after {
            display: none;
        }

        body.war-mode {
            background: linear-gradient(180deg, #1a1a1a 0%, #2d1b1b 25%, #3d2525 50%, #4a2a2a 75%, #5a3535 100%);
            background-size: 100% 100%;
            animation: warFlicker 0.5s ease-in-out infinite alternate;
            position: relative;
            overflow-x: hidden;
        }

        body.war-mode::before,
        body.war-mode::after {
            display: none;
        }

        @keyframes warFlicker {
            0% {
                filter: brightness(0.9) contrast(1.1);
            }
            100% {
                filter: brightness(1) contrast(1.2);
            }
        }

        body.easy-mode {
            background: linear-gradient(135deg, #2d5016 0%, #4a7c2a 30%, #6ba84f 60%, #8bc34a 100%);
            position: relative;
            overflow-x: hidden;
        }

        body.god-mode {
            background: linear-gradient(135deg, #0f0c29 0%, #1a0d3a 20%, #2d1b69 40%, #4c1d95 60%, #6366f1 80%, #8b5cf6 100%);
            background-size: 400% 400%;
            animation: galacticBackground 15s ease infinite;
            position: relative;
            overflow-x: hidden;
        }

        body.god-mode::before,
        body.god-mode::after {
            display: none;
        }

        @keyframes galacticBackground {
            0%, 100% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
        }

        /* Overlay para modo galáctico */
        .galactic-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        body.god-mode .galactic-overlay {
            opacity: 1;
        }

        /* Estrellas galácticas */
        .galactic-star {
            position: absolute;
            width: 3px;
            height: 3px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 6px rgba(255, 255, 255, 0.8),
                        0 0 12px rgba(167, 139, 250, 0.6),
                        0 0 18px rgba(139, 92, 246, 0.4);
            animation: starTwinkleGalactic 3s ease-in-out infinite;
        }

        .galactic-star.large {
            width: 5px;
            height: 5px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 1),
                        0 0 20px rgba(167, 139, 250, 0.8),
                        0 0 30px rgba(139, 92, 246, 0.6);
        }

        @keyframes starTwinkleGalactic {
            0%, 100% {
                opacity: 0.3;
                transform: scale(1);
            }
            50% {
                opacity: 1;
                transform: scale(1.5);
            }
        }

        /* Nebulosa galáctica */
        .galactic-nebula {
            position: absolute;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, 
                rgba(139, 92, 246, 0.3) 0%, 
                rgba(167, 139, 250, 0.2) 30%,
                rgba(99, 102, 241, 0.1) 60%,
                transparent 100%);
            border-radius: 50%;
            filter: blur(40px);
            animation: nebulaFloat 20s ease-in-out infinite;
        }

        @keyframes nebulaFloat {
            0%, 100% {
                transform: translate(0, 0) scale(1);
                opacity: 0.5;
            }
            33% {
                transform: translate(100px, -50px) scale(1.2);
                opacity: 0.7;
            }
            66% {
                transform: translate(-50px, 100px) scale(0.8);
                opacity: 0.6;
            }
        }

        /* Efectos en el contenedor cuando está en modo galáctico */
        body.god-mode .container {
            background: linear-gradient(135deg, rgba(30, 27, 75, 0.95) 0%, rgba(49, 46, 129, 0.95) 50%, rgba(76, 29, 149, 0.95) 100%);
            box-shadow: 0 20px 60px rgba(99, 102, 241, 0.5), 
                        0 0 50px rgba(139, 92, 246, 0.4),
                        inset 0 0 30px rgba(167, 139, 250, 0.2);
            border: 2px solid rgba(167, 139, 250, 0.5);
        }

        body.god-mode .container h1,
        body.god-mode .container .score,
        body.god-mode .container .streak-text,
        body.god-mode .container .lives-text {
            color: #e9d5ff;
            text-shadow: 0 0 10px rgba(167, 139, 250, 0.8), 
                         0 0 20px rgba(139, 92, 246, 0.6),
                         0 2px 4px rgba(0, 0, 0, 0.5);
        }

        body.god-mode .container .score {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a78bfa 100%);
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.6),
                        inset 0 0 15px rgba(167, 139, 250, 0.3);
        }

        body.god-mode .container .streak-text {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a78bfa 100%);
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.6),
                        inset 0 0 15px rgba(167, 139, 250, 0.3);
        }

        /* Overlay para modo guerra */
        .war-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        body.war-mode .war-overlay {
            opacity: 1;
        }

        /* Overlay para modo fácil */
        .nature-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        body.easy-mode .nature-overlay {
            opacity: 1;
        }

        /* Elementos de batalla */
        .smoke {
            position: absolute;
            width: 120px;
            height: 120px;
            background: radial-gradient(circle, rgba(50, 50, 50, 0.8) 0%, rgba(30, 30, 30, 0.5) 50%, transparent 70%);
            border-radius: 50%;
            animation: smokeRise 8s ease-out infinite;
            filter: blur(5px);
        }

        .explosion {
            position: absolute;
            width: 80px;
            height: 80px;
            background: radial-gradient(circle, rgba(255, 50, 50, 1) 0%, rgba(255, 100, 0, 0.8) 30%, rgba(200, 0, 0, 0.4) 60%, transparent 100%);
            border-radius: 50%;
            animation: explosionFlash 1.5s ease-out infinite;
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.8);
        }

        .bullet {
            position: absolute;
            width: 5px;
            height: 5px;
            background: #ff3333;
            border-radius: 50%;
            box-shadow: 0 0 15px #ff0000, 0 0 25px #ff3333;
            animation: bulletFly 3s linear infinite;
        }

        /* Elementos de naturaleza */
        .leaf {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #4a7c2a;
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            animation: leafFall 8s ease-in-out infinite;
        }

        .bird {
            position: absolute;
            font-size: 1.5em;
            animation: birdFly 15s linear infinite;
        }

        .wave {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 80px;
            background: linear-gradient(to top, 
                rgba(64, 150, 200, 0.4) 0%,
                rgba(64, 150, 200, 0.2) 50%,
                transparent 100%
            );
            animation: waveMove 3s ease-in-out infinite;
            clip-path: polygon(
                0% 100%,
                10% 80%,
                20% 90%,
                30% 70%,
                40% 85%,
                50% 75%,
                60% 90%,
                70% 70%,
                80% 85%,
                90% 75%,
                100% 100%
            );
        }

        .breeze {
            position: absolute;
            width: 2px;
            height: 30px;
            background: rgba(255, 255, 255, 0.3);
            animation: breezeMove 4s ease-in-out infinite;
        }

        @keyframes smokeRise {
            0% {
                transform: translateY(100vh) translateX(0) scale(0.5);
                opacity: 0.8;
            }
            50% {
                opacity: 0.6;
            }
            100% {
                transform: translateY(-100px) translateX(100px) scale(2);
                opacity: 0;
            }
        }

        @keyframes explosionFlash {
            0%, 100% {
                transform: scale(1);
                opacity: 0.8;
            }
            50% {
                transform: scale(1.5);
                opacity: 1;
            }
        }

        @keyframes bulletFly {
            0% {
                transform: translate(0, 100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translate(200px, -100px) rotate(360deg);
                opacity: 0;
            }
        }

        @keyframes leafFall {
            0% {
                transform: translateY(-100px) translateX(0) rotate(0deg);
                opacity: 1;
            }
            50% {
                transform: translateY(50vh) translateX(100px) rotate(180deg);
            }
            100% {
                transform: translateY(100vh) translateX(200px) rotate(360deg);
                opacity: 0;
            }
        }

        @keyframes birdFly {
            0% {
                transform: translateX(-100px) translateY(0);
            }
            50% {
                transform: translateX(50vw) translateY(-50px);
            }
            100% {
                transform: translateX(calc(100vw + 100px)) translateY(0);
            }
        }

        @keyframes waveMove {
            0%, 100% {
                transform: translateX(0);
            }
            50% {
                transform: translateX(-20px);
            }
        }

        @keyframes breezeMove {
            0% {
                transform: translateX(0) translateY(0) rotate(0deg);
                opacity: 0.3;
            }
            25% {
                transform: translateX(20px) translateY(-10px) rotate(5deg);
                opacity: 0.5;
            }
            50% {
                transform: translateX(40px) translateY(-20px) rotate(0deg);
                opacity: 0.3;
            }
            75% {
                transform: translateX(60px) translateY(-10px) rotate(-5deg);
                opacity: 0.5;
            }
            100% {
                transform: translateX(80px) translateY(0) rotate(0deg);
                opacity: 0.3;
            }
        }

        /* Overlay de fuego para modo imposible */
        .hell-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        body.hell-mode .hell-overlay {
            opacity: 1;
        }

        .flame {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 200px;
            background: linear-gradient(to top, 
                rgba(255, 69, 0, 0.8) 0%,
                rgba(255, 140, 0, 0.6) 30%,
                rgba(255, 200, 0, 0.4) 60%,
                transparent 100%
            );
            /* Animación más lenta para mejor rendimiento */
            animation: flameFlicker 1.5s ease-in-out infinite alternate;
            clip-path: polygon(
                0% 100%,
                5% 80%,
                10% 90%,
                15% 70%,
                20% 85%,
                25% 75%,
                30% 90%,
                35% 65%,
                40% 80%,
                45% 70%,
                50% 85%,
                55% 75%,
                60% 90%,
                65% 70%,
                70% 85%,
                75% 75%,
                80% 90%,
                85% 70%,
                90% 85%,
                95% 75%,
                100% 100%
            );
            will-change: transform, filter;
            transform: translateZ(0); /* Aceleración por hardware */
        }

        .flame:nth-child(1) {
            left: 0;
            animation-delay: 0s;
        }

        .flame:nth-child(2) {
            left: 25%;
            animation-delay: 0.2s;
            height: 180px;
        }

        .flame:nth-child(3) {
            left: 50%;
            animation-delay: 0.4s;
            height: 220px;
        }

        .flame:nth-child(4) {
            left: 75%;
            animation-delay: 0.1s;
            height: 190px;
        }

        .flame:nth-child(5) {
            right: 0;
            animation-delay: 0.3s;
            height: 200px;
        }

        .hell-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
        }

        .hell-particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #ff4500;
            border-radius: 50%;
            box-shadow: 0 0 10px #ff4500, 0 0 20px #ff4500;
            animation: particleFloat 3s ease-in-out infinite;
            will-change: transform, opacity;
            transform: translateZ(0); /* Aceleración por hardware */
        }

        /* Mini llamas que salpican */
        .spark {
            position: absolute;
            bottom: 0;
            width: 8px;
            height: 8px;
            background: radial-gradient(circle, #ff6b00 0%, #ff4500 50%, transparent 100%);
            border-radius: 50% 50% 50% 0;
            box-shadow: 0 0 15px #ff4500, 0 0 25px #ff6b00;
            animation: sparkFly 1.5s ease-out forwards;
            pointer-events: none;
            will-change: transform, opacity;
            transform: translateZ(0); /* Aceleración por hardware */
        }

        @keyframes sparkFly {
            0% {
                transform: translateY(0) translateX(0) scale(1) rotate(0deg);
                opacity: 1;
            }
            50% {
                opacity: 0.8;
            }
            100% {
                transform: translateY(-200px) translateX(var(--spark-x, 50px)) scale(0.3) rotate(360deg);
                opacity: 0;
            }
        }

        @keyframes hellFlicker {
            0% {
                filter: brightness(1) contrast(1);
            }
            50% {
                filter: brightness(1.1) contrast(1.1);
            }
            100% {
                filter: brightness(0.95) contrast(1.05);
            }
        }

        @keyframes flameFlicker {
            0% {
                transform: scaleY(1) scaleX(1);
                opacity: 0.8;
            }
            50% {
                transform: scaleY(1.1) scaleX(1.05);
                opacity: 1;
            }
            100% {
                transform: scaleY(0.9) scaleX(0.95);
                opacity: 0.7;
            }
        }

        @keyframes particleFloat {
            0% {
                transform: translateY(100vh) translateX(0) scale(0);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) translateX(50px) scale(1);
                opacity: 0;
            }
        }

        /* Efectos en el contenedor cuando está en modo infierno */
        body.hell-mode .container {
            background: linear-gradient(135deg, #2a1a1a 0%, #3d2525 50%, #2a1a1a 100%);
            box-shadow: 0 20px 60px rgba(255, 69, 0, 0.5), 
                        0 0 50px rgba(255, 140, 0, 0.3),
                        inset 0 0 30px rgba(255, 69, 0, 0.2);
            border: 2px solid rgba(255, 69, 0, 0.5);
            /* Desactivar animación de parpadeo para mejor rendimiento */
            /* animation: containerFlicker 0.4s ease-in-out infinite alternate; */
            color: #f0f0f0;
        }

        body.hell-mode .container h1,
        body.hell-mode .container .score,
        body.hell-mode .container .streak-text,
        body.hell-mode .container .lives-text {
            color: #ffcc99;
            text-shadow: 0 0 10px rgba(255, 140, 0, 0.5);
        }

        /* Efectos en el contenedor cuando está en modo guerra */
        body.war-mode .container {
            background: linear-gradient(135deg, #2a1a1a 0%, #3d2525 30%, #2a1a1a 60%, #1f1414 100%);
            box-shadow: 0 20px 60px rgba(139, 0, 0, 0.6), 
                        0 0 40px rgba(200, 0, 0, 0.4),
                        inset 0 0 30px rgba(100, 0, 0, 0.3);
            border: 3px solid rgba(139, 0, 0, 0.7);
            color: #ffcccc;
            position: relative;
        }

        body.war-mode .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 2px,
                    rgba(139, 0, 0, 0.03) 2px,
                    rgba(139, 0, 0, 0.03) 4px
                );
            pointer-events: none;
            border-radius: 20px;
        }

        body.war-mode .container h1 {
            color: #ff6666;
            text-shadow: 0 0 10px rgba(255, 0, 0, 0.8), 
                         0 0 20px rgba(255, 100, 100, 0.6),
                         0 2px 4px rgba(0, 0, 0, 0.5);
            animation: textGlow 2s ease-in-out infinite alternate;
        }

        body.war-mode .container .score {
            background: linear-gradient(135deg, #8b0000 0%, #a00000 50%, #8b0000 100%);
            color: #ffcccc;
            text-shadow: 0 0 8px rgba(255, 0, 0, 0.6), 
                         0 2px 4px rgba(0, 0, 0, 0.5);
            box-shadow: 0 4px 15px rgba(139, 0, 0, 0.5),
                        inset 0 0 10px rgba(255, 0, 0, 0.2);
        }

        body.war-mode .container .streak-text {
            background: linear-gradient(135deg, #8b0000 0%, #a00000 50%, #8b0000 100%);
            color: #ffcccc;
            text-shadow: 0 0 8px rgba(255, 0, 0, 0.6), 
                         0 2px 4px rgba(0, 0, 0, 0.5);
            box-shadow: 0 4px 15px rgba(139, 0, 0, 0.5),
                        inset 0 0 10px rgba(255, 0, 0, 0.2);
        }

        body.war-mode .container .lives-text {
            color: #ff9999;
            text-shadow: 0 0 8px rgba(255, 0, 0, 0.5), 
                         0 2px 4px rgba(0, 0, 0, 0.5);
        }

        @keyframes textGlow {
            0% {
                text-shadow: 0 0 10px rgba(255, 0, 0, 0.8), 
                             0 0 20px rgba(255, 100, 100, 0.6),
                             0 2px 4px rgba(0, 0, 0, 0.5);
            }
            100% {
                text-shadow: 0 0 15px rgba(255, 0, 0, 1), 
                             0 0 30px rgba(255, 100, 100, 0.8),
                             0 2px 4px rgba(0, 0, 0, 0.5);
            }
        }

        /* Efectos en el contenedor cuando está en modo fácil */
        body.easy-mode .container {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 50%, #e8f5e9 100%);
            box-shadow: 0 20px 60px rgba(76, 175, 80, 0.3), 
                        0 0 30px rgba(129, 199, 132, 0.2);
            border: 2px solid rgba(76, 175, 80, 0.4);
        }

        body.easy-mode .container h1,
        body.easy-mode .container .score,
        body.easy-mode .container .streak-text,
        body.easy-mode .container .lives-text {
            color: #2e7d32;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
        }

        @keyframes containerFlicker {
            0% {
                box-shadow: 0 20px 60px rgba(255, 69, 0, 0.5), 
                            0 0 50px rgba(255, 140, 0, 0.3),
                            inset 0 0 30px rgba(255, 69, 0, 0.2);
            }
            100% {
                box-shadow: 0 20px 60px rgba(255, 140, 0, 0.6), 
                            0 0 60px rgba(255, 200, 0, 0.4),
                            inset 0 0 40px rgba(255, 140, 0, 0.3);
            }
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
            text-align: center;
        }

        .title-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            gap: 15px;
        }

        h1 {
            color: #333;
            margin: 0;
            font-size: 2.5em;
            flex: 1;
        }

        .score {
            font-size: 1.5em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 700;
            margin-bottom: 15px;
            padding: 12px 25px;
            border-radius: 50px;
            display: inline-block;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            letter-spacing: 1px;
        }

        .streak-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .streak-fire {
            font-size: 2.5em;
            animation: fireFlicker 0.5s ease-in-out infinite alternate;
            filter: drop-shadow(0 0 10px rgba(255, 69, 0, 0.8));
            transition: all 0.3s ease;
        }

        .streak-fire.hot {
            font-size: 3em;
            filter: drop-shadow(0 0 20px rgba(255, 140, 0, 1));
            animation: fireFlicker 0.3s ease-in-out infinite alternate;
        }

        @keyframes fireFlicker {
            0% {
                transform: scale(1) rotate(-2deg);
                filter: drop-shadow(0 0 10px rgba(255, 69, 0, 0.8));
            }
            100% {
                transform: scale(1.1) rotate(2deg);
                filter: drop-shadow(0 0 15px rgba(255, 140, 0, 1));
            }
        }

        .streak-text {
            font-size: 1.3em;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            font-weight: 700;
            padding: 10px 20px;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            letter-spacing: 1px;
        }

        .lives-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-size: 200% 200%;
            animation: gradientFlow 3s ease infinite;
            padding: 15px 25px;
            border-radius: 50px;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4), 0 0 30px rgba(118, 75, 162, 0.3);
            position: relative;
            overflow: hidden;
        }

        .lives-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
            animation: rotate 4s linear infinite;
        }

        .lives-text {
            font-size: 1.2em;
            color: white;
            font-weight: 700;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            letter-spacing: 1px;
            position: relative;
            z-index: 1;
        }

        .hearts {
            font-size: 2.2em;
            letter-spacing: 10px;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .hearts .heart-full {
            animation: heartFloat 2s ease-in-out infinite;
            display: inline-block;
            filter: drop-shadow(0 0 10px rgba(255, 20, 147, 0.8));
            transform-origin: center;
        }

        .hearts .heart-full:nth-child(1) {
            animation-delay: 0s;
        }

        .hearts .heart-full:nth-child(2) {
            animation-delay: 0.3s;
        }

        .hearts .heart-full:nth-child(3) {
            animation-delay: 0.6s;
        }

        .hearts .heart-empty {
            opacity: 0.4;
            filter: grayscale(100%) drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
            transform: scale(0.9);
            transition: all 0.3s ease;
        }

        @keyframes gradientFlow {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes heartFloat {
            0%, 100% {
                transform: translateY(0) scale(1) rotate(0deg);
                filter: drop-shadow(0 0 10px rgba(255, 20, 147, 0.8));
            }
            25% {
                transform: translateY(-8px) scale(1.1) rotate(-5deg);
                filter: drop-shadow(0 0 15px rgba(255, 20, 147, 1));
            }
            50% {
                transform: translateY(-12px) scale(1.15) rotate(0deg);
                filter: drop-shadow(0 0 20px rgba(255, 20, 147, 1));
            }
            75% {
                transform: translateY(-8px) scale(1.1) rotate(5deg);
                filter: drop-shadow(0 0 15px rgba(255, 20, 147, 1));
            }
        }

        .joker-message {
            font-size: 1em;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            font-weight: 600;
            padding: 8px 15px;
            border-radius: 50px;
            box-shadow: 0 4px 10px rgba(245, 87, 108, 0.4);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            animation: jokerPulse 2s ease-in-out infinite;
        }

        @keyframes jokerPulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 4px 10px rgba(245, 87, 108, 0.4);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 6px 15px rgba(245, 87, 108, 0.6);
            }
        }

        /* Alertas estilizadas */
        .alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            animation: fadeIn 0.3s ease;
        }

        .alert-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
            max-width: 400px;
            width: 90%;
        }

        .alert-box.success {
            border-top: 5px solid #48bb78;
        }

        .alert-box.error {
            border-top: 5px solid #f56565;
        }

        .alert-icon {
            font-size: 4em;
            margin-bottom: 20px;
            animation: bounce 0.5s ease;
        }

        .alert-message {
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .alert-box.success .alert-message {
            color: #22543d;
        }

        .alert-box.error .alert-message {
            color: #742a2a;
        }

        .alert-details {
            font-size: 1em;
            color: #718096;
            margin-top: 10px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-20px);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        /* Estilos para cohetes */
        .rocket {
            position: fixed;
            font-size: 2.5em;
            pointer-events: none;
            z-index: 3000;
            filter: drop-shadow(0 0 10px rgba(255, 140, 0, 0.8));
            animation: rocketTrail 2s ease-out forwards;
        }

        @keyframes rocketTrail {
            0% {
                opacity: 1;
                filter: drop-shadow(0 0 10px rgba(255, 140, 0, 0.8));
            }
            50% {
                opacity: 0.8;
                filter: drop-shadow(0 0 20px rgba(255, 200, 0, 1));
            }
            100% {
                opacity: 0;
                filter: drop-shadow(0 0 30px rgba(255, 255, 255, 0.5));
            }
        }

        .joker-btn-inline {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 1em;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
            transition: all 0.3s ease;
            animation: jokerPulse 2s ease-in-out infinite;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            letter-spacing: 0.5px;
        }

        .joker-btn-inline:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px rgba(245, 87, 108, 0.6);
        }

        .joker-btn-inline:active {
            transform: translateY(0) scale(1);
        }

        @keyframes jokerPulse {
            0%, 100% {
                box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 6px 20px rgba(245, 87, 108, 0.8);
                transform: scale(1.05);
            }
        }

        .flag-container {
            margin: 30px 0;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f5f5f5;
            border-radius: 15px;
            padding: 20px;
        }

        .flag {
            font-size: 8em;
            line-height: 1;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
        }

        .flag div {
            font-size: 10em;
            line-height: 1;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.2));
        }

        .flag img {
            width: auto;
            height: auto;
            max-width: 100%;
            max-height: 180px;
            min-height: 100px;
            object-fit: contain;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            background: white;
            padding: 5px;
        }

        .timer-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
        }

        .timer-circle {
            position: relative;
            width: 80px;
            height: 80px;
        }

        .timer-svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .timer-circle-bg {
            fill: none;
            stroke: #e0e0e0;
            stroke-width: 8;
        }

        .timer-circle-progress {
            fill: none;
            stroke: #667eea;
            stroke-width: 8;
            stroke-linecap: round;
            stroke-dasharray: 283;
            stroke-dashoffset: 0;
            transition: stroke-dashoffset 1s linear, stroke 0.3s ease;
        }

        .timer-circle-progress.warning {
            stroke: #ff9800;
        }

        .timer-circle-progress.danger {
            stroke: #f44336;
        }

        .timer-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.8em;
            font-weight: 700;
            color: #333;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        body.hell-mode .timer-circle-progress {
            stroke: #ff4500;
        }

        body.hell-mode .timer-circle-progress.warning {
            stroke: #ff6b00;
        }

        body.hell-mode .timer-circle-progress.danger {
            stroke: #ff0000;
        }

        body.hell-mode .timer-text {
            color: #ffcccc;
            text-shadow: 0 0 10px rgba(255, 0, 0, 0.8);
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 30px 0;
        }

        .option {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .option:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .option:active {
            transform: translateY(0);
        }

        .end-attempt-btn {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 20px auto;
            display: block;
            box-shadow: 0 4px 15px rgba(245, 101, 101, 0.4);
            width: fit-content;
        }

        .end-attempt-btn:hover {
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 101, 101, 0.6);
        }

        .end-attempt-btn:active {
            transform: translateY(0);
        }

        .option.correct {
            background: #48bb78;
        }

        .option.incorrect {
            background: #f56565;
        }

        .option:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        .next-btn {
            background: #764ba2;
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
            font-weight: 600;
            display: none;
        }

        .next-btn:hover {
            background: #653a8a;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(118, 75, 162, 0.4);
        }

        .next-btn.show {
            display: inline-block;
        }

        .message {
            margin-top: 20px;
            font-size: 1.2em;
            font-weight: bold;
            min-height: 30px;
        }

        .message.correct {
            color: #48bb78;
        }

        .message.incorrect {
            color: #f56565;
        }

        .loading {
            font-size: 1.2em;
            color: #667eea;
            margin: 20px 0;
        }

        .difficulty-selector {
            text-align: center;
            padding: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .creator-info-btn {
            margin-top: 30px;
            background: rgba(102, 126, 234, 0.1);
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: 50px;
            padding: 12px 24px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 100;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            backdrop-filter: blur(5px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            color: #667eea;
            font-weight: 600;
        }

        .creator-info-btn:hover {
            background: rgba(102, 126, 234, 0.2);
            border-color: rgba(102, 126, 234, 0.5);
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .creator-info-profile-picture {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 20px;
            overflow: hidden;
            border: 3px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
        }

        .creator-info-profile-picture img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .creator-info-profile-picture .placeholder {
            font-size: 2.5em;
        }

        /* Estilos para modal de información del grupo */
        .group-info-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            animation: fadeIn 0.3s ease;
        }

        .group-info-modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        .group-info-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .group-info-modal-header h2 {
            margin: 0;
            color: #333;
            font-size: 1.8em;
        }

        .group-info-modal-close {
            background: #f56565;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .group-info-modal-close:hover {
            background: #e53e3e;
            transform: rotate(90deg);
        }

        .group-info-picture-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }

        .group-info-picture {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            overflow: hidden;
            border: 4px solid white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .group-info-picture img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .group-change-picture-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .group-change-picture-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .group-add-members-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .group-add-members-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.4);
        }

        .group-info-name {
            text-align: center;
            font-size: 1.5em;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
        }

        .group-info-members h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 1.2em;
        }

        .group-info-members-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .group-member-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f7fafc;
            border-radius: 10px;
            transition: background 0.3s ease;
        }

        .group-member-item:hover {
            background: #e2e8f0;
        }

        .group-member-picture {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            overflow: hidden;
            background: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            flex-shrink: 0;
        }

        .group-member-picture img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .group-member-info {
            flex: 1;
        }

        .group-member-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }

        .group-member-role {
            font-size: 0.85em;
            color: #666;
        }

        .group-member-role.admin {
            color: #667eea;
            font-weight: 600;
        }

        .group-member-actions {
            display: flex;
            gap: 8px;
        }

        .group-member-action-btn {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s ease;
        }

        .group-member-action-btn:hover {
            background: #e2e8f0;
        }

        .group-member-action-btn.admin-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }

        .group-member-action-btn.admin-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .group-member-action-btn.remove-btn {
            background: #fee;
            color: #c33;
            border-color: #fcc;
        }

        .group-member-action-btn.remove-btn:hover {
            background: #fcc;
        }

        .creator-info-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }

        .creator-info-modal.active {
            display: flex;
        }

        .creator-info-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            position: relative;
            color: white;
            text-align: center;
            animation: slideUp 0.4s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .creator-info-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .creator-info-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg) scale(1.1);
        }

        .creator-info-header {
            margin-bottom: 30px;
        }

        .creator-info-header h3 {
            font-size: 2em;
            margin: 0 0 10px 0;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .creator-info-header p {
            font-size: 1.1em;
            opacity: 0.9;
            margin: 0;
        }

        .creator-info-body {
            margin-bottom: 30px;
        }

        .creator-info-body p {
            font-size: 1.1em;
            line-height: 1.6;
            margin-bottom: 15px;
            white-space: pre-line;
        }

        .creator-info-message {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border-left: 4px solid rgba(255, 255, 255, 0.5);
            font-style: italic;
            backdrop-filter: blur(10px);
        }

        .creator-info-footer {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }

        .recommendations-btn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.4);
        }

        .recommendations-btn:hover {
            background: #b91c1c;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.6);
        }

        .recommendations-btn:active {
            transform: translateY(0);
        }

        .difficulty-selector h2 {
            color: #333;
            margin-bottom: 30px;
            font-size: 1.8em;
        }

        .difficulty-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .difficulty-btn {
            background: white;
            border: 2px solid #667eea;
            padding: 20px 30px;
            border-radius: 10px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
            color: #333;
            min-width: 180px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .difficulty-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .difficulty-btn.easy {
            border-color: #48bb78;
            background: #f0fff4;
            color: #22543d;
        }

        .difficulty-btn.easy:hover {
            background: #48bb78;
            color: white;
        }

        .difficulty-btn.hard {
            border-color: #f56565;
            background: #fff5f5;
            color: #742a2a;
        }

        .difficulty-btn.hard:hover {
            background: #f56565;
            color: white;
        }

        .difficulty-btn.impossible {
            border-color: #2d3748;
            background: #2d3748;
            color: white;
        }

        .difficulty-btn.impossible:hover {
            background: #4a5568;
        }

        .difficulty-btn.god {
            border-color: #6366f1;
            background: #6366f1;
            color: white;
        }

        .difficulty-btn.god:hover {
            background: #8b5cf6;
        }

        .difficulty-btn small {
            display: block;
            font-size: 0.7em;
            margin-top: 5px;
            font-weight: 400;
            opacity: 0.8;
        }

        /* Botones de clasificación */
        .ranking-buttons-container {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #e2e8f0;
            position: relative;
            z-index: 10;
        }

        .ranking-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            position: relative;
            z-index: 10;
        }

        .ranking-btn {
            background: white;
            border: 2px solid #667eea;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            color: #333;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 10;
            pointer-events: auto;
        }

        .ranking-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .ranking-btn-easy {
            border-color: #48bb78;
        }

        .ranking-btn-easy:hover {
            background: #48bb78;
            color: white;
        }

        .ranking-btn-hard {
            border-color: #f56565;
        }

        .ranking-btn-hard:hover {
            background: #f56565;
            color: white;
        }

        .ranking-btn-impossible {
            border-color: #2d3748;
        }

        .ranking-btn-impossible:hover {
            background: #2d3748;
            color: white;
        }

        .ranking-btn-god {
            border-color: #6366f1;
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #4c1d95 100%);
            color: white;
        }

        .ranking-btn-god:hover {
            background: linear-gradient(135deg, #312e81 0%, #4c1d95 50%, #6366f1 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.5);
        }

        .game-over {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .game-over-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .game-over-content h2 {
            color: #f56565;
            font-size: 2.5em;
            margin-bottom: 30px;
        }

        .game-over-stats {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-item {
            background: #f7fafc;
            padding: 20px;
            border-radius: 10px;
        }

        .stat-label {
            font-size: 0.9em;
            color: #718096;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .name-input-container {
            margin: 20px 0;
        }

        .name-input {
            width: 100%;
            padding: 12px;
            font-size: 1em;
            border: 2px solid #667eea;
            border-radius: 8px;
            margin-bottom: 10px;
            text-align: center;
            box-sizing: border-box;
        }

        .name-input:focus {
            outline: none;
            border-color: #764ba2;
        }

        .save-score-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1em;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
            font-weight: 600;
            width: 100%;
        }

        .save-score-btn:hover {
            transform: scale(1.05);
        }

        .save-score-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        /* Botón para ver ranking */
        .view-ranking-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 25%, #4facfe 50%, #00f2fe 75%, #43e97b 100%);
            background-size: 300% 300%;
            animation: gradientShift 3s ease infinite;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2), 0 0 20px rgba(255, 255, 255, 0.3) inset;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .view-ranking-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .view-ranking-btn:hover::before {
            left: 100%;
        }

        .view-ranking-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.3), 0 0 30px rgba(255, 255, 255, 0.4) inset;
        }

        .view-ranking-btn:active {
            transform: translateY(-1px) scale(1.02);
        }

        @keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        .ranking-container {
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
        }

        .ranking-container h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        /* Ranking principal en la pantalla del juego */
        .main-ranking-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        /* Estilos para modo imposible */
        body.hell-mode .main-ranking-container {
            background: linear-gradient(135deg, #2a1a1a 0%, #3d2525 50%, #2a1a1a 100%);
            box-shadow: 0 4px 15px rgba(255, 69, 0, 0.3), 
                        0 0 30px rgba(255, 140, 0, 0.2);
            border: 2px solid rgba(255, 69, 0, 0.5);
        }

        body.hell-mode .main-ranking-container h2 {
            color: #ffcc99;
            text-shadow: 0 0 10px rgba(255, 140, 0, 0.5);
        }

        .ranking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .main-ranking-container h2 {
            color: #667eea;
            margin: 0;
            font-size: 1.8em;
        }

        .close-ranking-btn {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(245, 101, 101, 0.4);
            position: relative;
            overflow: hidden;
        }

        .close-ranking-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }

        .close-ranking-btn:hover::before {
            width: 100%;
            height: 100%;
        }

        .close-ranking-btn:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 6px 20px rgba(245, 101, 101, 0.6);
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
        }

        .close-ranking-btn:active {
            transform: scale(0.95) rotate(90deg);
        }

        .main-ranking-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 400px;
            overflow-y: auto;
        }

        .main-ranking-item {
            background: #f7fafc;
            padding: 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #667eea;
            transition: transform 0.2s;
            overflow: visible;
        }

        /* Estilos para items en modo imposible */
        body.hell-mode .main-ranking-item {
            background: rgba(61, 37, 37, 0.7) !important;
            border-left-color: rgba(255, 69, 0, 0.6) !important;
        }

        body.hell-mode .main-ranking-item:hover {
            background: rgba(61, 37, 37, 0.9) !important;
            border-left-color: rgba(255, 140, 0, 0.8) !important;
        }

        body.hell-mode .main-ranking-item.top {
            background: rgba(139, 69, 19, 0.8) !important;
            border-left-color: rgba(255, 140, 0, 0.9) !important;
        }

        .main-ranking-item:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .main-ranking-item.top {
            border-left-color: #fbbf24;
            background: linear-gradient(135deg, #fffbeb 0%, #fff4d6 50%, #fffbeb 100%);
            background-size: 200% 200%;
            animation: topGradient 3s ease infinite;
            position: relative;
            overflow: visible !important;
            box-shadow: 0 4px 20px rgba(251, 191, 36, 0.4), 0 0 30px rgba(251, 191, 36, 0.2);
        }
        
        /* Estilos para foto de perfil Top 1 */
        .main-ranking-item.top .ranking-profile-picture {
            position: relative;
            border: 4px solid #fbbf24;
            box-shadow: 0 0 25px rgba(251, 191, 36, 0.8), 
                        0 0 50px rgba(251, 191, 36, 0.6),
                        0 0 75px rgba(251, 191, 36, 0.4),
                        inset 0 0 15px rgba(251, 191, 36, 0.4);
            animation: topPhotoGlow 2s ease-in-out infinite;
            z-index: 5;
        }
        
        .main-ranking-item.top .ranking-profile-picture::after {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            border-radius: 50%;
            background: radial-gradient(circle, 
                rgba(251, 191, 36, 0.4) 0%, 
                rgba(251, 191, 36, 0.2) 40%,
                transparent 70%);
            animation: topAura 3s ease-in-out infinite;
            pointer-events: none;
            z-index: -1;
        }
        
        @keyframes topAura {
            0%, 100% {
                transform: scale(1);
                opacity: 0.6;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.9;
            }
        }
        
        @keyframes topPhotoGlow {
            0%, 100% {
                box-shadow: 0 0 20px rgba(251, 191, 36, 0.6), 
                            0 0 40px rgba(251, 191, 36, 0.4),
                            inset 0 0 10px rgba(251, 191, 36, 0.3);
            }
            50% {
                box-shadow: 0 0 30px rgba(251, 191, 36, 0.8), 
                            0 0 50px rgba(251, 191, 36, 0.6),
                            inset 0 0 15px rgba(251, 191, 36, 0.5);
            }
        }
        
        @keyframes topPhotoShine {
            0%, 100% {
                opacity: 0.4;
                transform: rotate(0deg);
            }
            50% {
                opacity: 0.7;
                transform: rotate(180deg);
            }
        }
        
        @keyframes topGradient {
            0%, 100% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
        }
        
        @keyframes crownFloat {
            0%, 100% {
                transform: translateY(-50%) rotate(-5deg);
            }
            50% {
                transform: translateY(-60%) rotate(5deg);
            }
        }
        
        @keyframes topShine {
            0%, 100% {
                opacity: 0.3;
            }
            50% {
                opacity: 0.6;
            }
        }
        
        .main-ranking-item.top .main-ranking-position {
            color: #f59e0b;
            font-size: 1.3em;
            font-weight: 900;
            text-shadow: 0 2px 4px rgba(251, 191, 36, 0.5);
        }
        
        .main-ranking-item.top .main-ranking-position::before {
            content: '👑';
            font-size: 1.5em;
            animation: crownFloat 2s ease-in-out infinite;
            filter: drop-shadow(0 2px 4px rgba(251, 191, 36, 0.6));
        }
        
        .main-ranking-item.top .main-ranking-name {
            font-weight: 700;
            color: #92400e;
        }
        
        .main-ranking-item.top .main-ranking-score {
            color: #f59e0b;
            font-size: 1.3em;
            font-weight: 900;
            text-shadow: 0 2px 4px rgba(251, 191, 36, 0.5);
        }

        /* Estilos para Top 2 (Plata) */
        .main-ranking-item.second {
            border-left-color: #94a3b8;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 50%, #f1f5f9 100%);
            background-size: 200% 200%;
            animation: secondGradient 3s ease infinite;
            position: relative;
            overflow: visible !important;
            box-shadow: 0 4px 15px rgba(148, 163, 184, 0.3), 0 0 20px rgba(148, 163, 184, 0.15);
        }
        
        /* Estilos para foto de perfil Top 2 */
        .main-ranking-item.second .ranking-profile-picture {
            position: relative;
            border: 4px solid #94a3b8;
            box-shadow: 0 0 20px rgba(148, 163, 184, 0.7), 
                        0 0 40px rgba(148, 163, 184, 0.5),
                        0 0 60px rgba(148, 163, 184, 0.3),
                        inset 0 0 12px rgba(148, 163, 184, 0.3);
            animation: secondPhotoGlow 2.5s ease-in-out infinite;
            z-index: 5;
        }
        
        .main-ranking-item.second .ranking-profile-picture::after {
            content: '';
            position: absolute;
            top: -8px;
            left: -8px;
            right: -8px;
            bottom: -8px;
            border-radius: 50%;
            background: radial-gradient(circle, 
                rgba(148, 163, 184, 0.3) 0%, 
                rgba(148, 163, 184, 0.15) 40%,
                transparent 70%);
            animation: secondAura 3s ease-in-out infinite;
            pointer-events: none;
            z-index: -1;
        }
        
        @keyframes secondAura {
            0%, 100% {
                transform: scale(1);
                opacity: 0.5;
            }
            50% {
                transform: scale(1.15);
                opacity: 0.8;
            }
        }
        
        @keyframes secondPhotoGlow {
            0%, 100% {
                box-shadow: 0 0 15px rgba(148, 163, 184, 0.5), 
                            0 0 30px rgba(148, 163, 184, 0.3),
                            inset 0 0 8px rgba(148, 163, 184, 0.2);
            }
            50% {
                box-shadow: 0 0 25px rgba(148, 163, 184, 0.7), 
                            0 0 40px rgba(148, 163, 184, 0.5),
                            inset 0 0 12px rgba(148, 163, 184, 0.4);
            }
        }
        
        @keyframes secondPhotoShine {
            0%, 100% {
                opacity: 0.3;
                transform: rotate(0deg);
            }
            50% {
                opacity: 0.6;
                transform: rotate(180deg);
            }
        }
        
        @keyframes secondGradient {
            0%, 100% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
        }
        
        @keyframes medalFloat {
            0%, 100% {
                transform: translateY(-50%) rotate(-3deg);
            }
            50% {
                transform: translateY(-55%) rotate(3deg);
            }
        }
        
        @keyframes secondShine {
            0%, 100% {
                opacity: 0.25;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        .main-ranking-item.second .main-ranking-position {
            color: #64748b;
            font-size: 1.2em;
            font-weight: 800;
            text-shadow: 0 1px 3px rgba(148, 163, 184, 0.4);
        }
        
        .main-ranking-item.second .main-ranking-position::before {
            content: '🥈';
            font-size: 1.3em;
            animation: medalFloat 2s ease-in-out infinite;
            filter: drop-shadow(0 2px 4px rgba(148, 163, 184, 0.5));
        }
        
        .main-ranking-item.second .main-ranking-name {
            font-weight: 700;
            color: #475569;
        }
        
        .main-ranking-item.second .main-ranking-score {
            color: #64748b;
            font-size: 1.2em;
            font-weight: 800;
            text-shadow: 0 1px 3px rgba(148, 163, 184, 0.4);
        }

        /* Estilos para Top 3 (Bronce) */
        .main-ranking-item.third {
            border-left-color: #d97706;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 50%, #fef3c7 100%);
            background-size: 200% 200%;
            animation: thirdGradient 3s ease infinite;
            position: relative;
            overflow: visible !important;
            box-shadow: 0 4px 15px rgba(217, 119, 6, 0.3), 0 0 20px rgba(217, 119, 6, 0.15);
        }
        
        /* Estilos para foto de perfil Top 3 */
        .main-ranking-item.third .ranking-profile-picture {
            position: relative;
            border: 4px solid #d97706;
            box-shadow: 0 0 20px rgba(217, 119, 6, 0.7), 
                        0 0 40px rgba(217, 119, 6, 0.5),
                        0 0 60px rgba(217, 119, 6, 0.3),
                        inset 0 0 12px rgba(217, 119, 6, 0.3);
            animation: thirdPhotoGlow 2.5s ease-in-out infinite;
            z-index: 5;
        }
        
        .main-ranking-item.third .ranking-profile-picture::after {
            content: '';
            position: absolute;
            top: -8px;
            left: -8px;
            right: -8px;
            bottom: -8px;
            border-radius: 50%;
            background: radial-gradient(circle, 
                rgba(217, 119, 6, 0.3) 0%, 
                rgba(217, 119, 6, 0.15) 40%,
                transparent 70%);
            animation: thirdAura 3s ease-in-out infinite;
            pointer-events: none;
            z-index: -1;
        }
        
        @keyframes thirdAura {
            0%, 100% {
                transform: scale(1);
                opacity: 0.5;
            }
            50% {
                transform: scale(1.15);
                opacity: 0.8;
            }
        }
        
        @keyframes thirdPhotoGlow {
            0%, 100% {
                box-shadow: 0 0 15px rgba(217, 119, 6, 0.5), 
                            0 0 30px rgba(217, 119, 6, 0.3),
                            inset 0 0 8px rgba(217, 119, 6, 0.2);
            }
            50% {
                box-shadow: 0 0 25px rgba(217, 119, 6, 0.7), 
                            0 0 40px rgba(217, 119, 6, 0.5),
                            inset 0 0 12px rgba(217, 119, 6, 0.4);
            }
        }
        
        @keyframes thirdPhotoShine {
            0%, 100% {
                opacity: 0.3;
                transform: rotate(0deg);
            }
            50% {
                opacity: 0.6;
                transform: rotate(180deg);
            }
        }
        
        @keyframes thirdGradient {
            0%, 100% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
        }
        
        @keyframes thirdShine {
            0%, 100% {
                opacity: 0.25;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        .main-ranking-item.third .main-ranking-position {
            color: #b45309;
            font-size: 1.15em;
            font-weight: 800;
            text-shadow: 0 1px 3px rgba(217, 119, 6, 0.4);
        }
        
        .main-ranking-item.third .main-ranking-position::before {
            content: '🥉';
            font-size: 1.3em;
            animation: medalFloat 2s ease-in-out infinite;
            filter: drop-shadow(0 2px 4px rgba(217, 119, 6, 0.5));
        }
        
        .main-ranking-item.third .main-ranking-name {
            font-weight: 700;
            color: #92400e;
        }
        
        .main-ranking-item.third .main-ranking-score {
            color: #b45309;
            font-size: 1.15em;
            font-weight: 800;
            text-shadow: 0 1px 3px rgba(217, 119, 6, 0.4);
        }

        /* Contenedor de ranking en la pantalla de selección de dificultad */
        .difficulty-ranking-container {
            margin-top: 30px;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 10;
        }

        .difficulty-ranking-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 500px;
            overflow-y: auto;
            overflow-x: visible;
        }

        .difficulty-ranking-item {
            background: #f7fafc;
            padding: 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #667eea;
            transition: transform 0.2s;
            overflow: visible;
        }

        .difficulty-ranking-item:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .difficulty-ranking-item.top {
            border-left-color: #fbbf24;
            background: linear-gradient(135deg, #fffbeb 0%, #fff4d6 50%, #fffbeb 100%);
            background-size: 200% 200%;
            animation: topGradient 3s ease infinite;
            position: relative;
            overflow: visible !important;
            box-shadow: 0 4px 20px rgba(251, 191, 36, 0.4), 0 0 30px rgba(251, 191, 36, 0.2);
        }

        /* Estilos para foto de perfil Top 1 en difficulty ranking */
        .difficulty-ranking-item.top .ranking-profile-picture {
            position: relative;
            border: 4px solid #fbbf24;
            box-shadow: 0 0 25px rgba(251, 191, 36, 0.8), 
                        0 0 50px rgba(251, 191, 36, 0.6),
                        0 0 75px rgba(251, 191, 36, 0.4),
                        inset 0 0 15px rgba(251, 191, 36, 0.4);
            animation: topPhotoGlow 2s ease-in-out infinite;
            z-index: 5;
        }
        
        .difficulty-ranking-item.top .ranking-profile-picture::after {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            border-radius: 50%;
            background: radial-gradient(circle, 
                rgba(251, 191, 36, 0.4) 0%, 
                rgba(251, 191, 36, 0.2) 40%,
                transparent 70%);
            animation: topAura 3s ease-in-out infinite;
            pointer-events: none;
            z-index: -1;
        }

        .difficulty-ranking-item.second {
            border-left-color: #94a3b8;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 50%, #f1f5f9 100%);
            background-size: 200% 200%;
            animation: secondGradient 3s ease infinite;
            position: relative;
            overflow: visible !important;
            box-shadow: 0 4px 15px rgba(148, 163, 184, 0.3), 0 0 20px rgba(148, 163, 184, 0.15);
        }

        /* Estilos para foto de perfil Top 2 en difficulty ranking */
        .difficulty-ranking-item.second .ranking-profile-picture {
            position: relative;
            border: 4px solid #94a3b8;
            box-shadow: 0 0 20px rgba(148, 163, 184, 0.7), 
                        0 0 40px rgba(148, 163, 184, 0.5),
                        0 0 60px rgba(148, 163, 184, 0.3),
                        inset 0 0 12px rgba(148, 163, 184, 0.3);
            animation: secondPhotoGlow 2.5s ease-in-out infinite;
            z-index: 5;
        }
        
        .difficulty-ranking-item.second .ranking-profile-picture::after {
            content: '';
            position: absolute;
            top: -8px;
            left: -8px;
            right: -8px;
            bottom: -8px;
            border-radius: 50%;
            background: radial-gradient(circle, 
                rgba(148, 163, 184, 0.3) 0%, 
                rgba(148, 163, 184, 0.15) 40%,
                transparent 70%);
            animation: secondAura 3s ease-in-out infinite;
            pointer-events: none;
            z-index: -1;
        }

        .difficulty-ranking-item.third {
            border-left-color: #d97706;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 50%, #fef3c7 100%);
            background-size: 200% 200%;
            animation: thirdGradient 3s ease infinite;
            position: relative;
            overflow: visible !important;
            box-shadow: 0 4px 15px rgba(217, 119, 6, 0.3), 0 0 20px rgba(217, 119, 6, 0.15);
        }

        /* Estilos para foto de perfil Top 3 en difficulty ranking */
        .difficulty-ranking-item.third .ranking-profile-picture {
            position: relative;
            border: 3px solid #d97706;
            box-shadow: 0 0 15px rgba(217, 119, 6, 0.5), 
                        0 0 30px rgba(217, 119, 6, 0.3),
                        inset 0 0 8px rgba(217, 119, 6, 0.2);
            animation: thirdPhotoGlow 2.5s ease-in-out infinite;
        }
        
        
        .difficulty-ranking-item.third .ranking-profile-picture::after {
            content: '';
            position: absolute;
            top: -6px;
            left: -6px;
            right: -6px;
            bottom: -6px;
            border-radius: 50%;
            background: linear-gradient(45deg, 
                rgba(217, 119, 6, 0.3) 0%, 
                transparent 30%, 
                transparent 70%);
            animation: thirdAura 3s ease-in-out infinite;
            pointer-events: none;
            z-index: -1;
        }

        .difficulty-ranking-item.top .difficulty-ranking-position,
        .difficulty-ranking-item.top .difficulty-ranking-score {
            color: #f59e0b;
            font-size: 1.3em;
            font-weight: 900;
            text-shadow: 0 2px 4px rgba(251, 191, 36, 0.5);
        }
        
        .difficulty-ranking-item.top .difficulty-ranking-position::before {
            content: '👑';
            font-size: 1.5em;
            animation: crownFloat 2s ease-in-out infinite;
            filter: drop-shadow(0 2px 4px rgba(251, 191, 36, 0.6));
        }

        .difficulty-ranking-item.top .difficulty-ranking-name {
            font-weight: 700;
            color: #92400e;
        }

        .difficulty-ranking-item.second .difficulty-ranking-position,
        .difficulty-ranking-item.second .difficulty-ranking-score {
            color: #64748b;
            font-size: 1.2em;
            font-weight: 800;
            text-shadow: 0 1px 3px rgba(148, 163, 184, 0.4);
        }
        
        .difficulty-ranking-item.second .difficulty-ranking-position::before {
            content: '🥈';
            font-size: 1.3em;
            animation: medalFloat 2s ease-in-out infinite;
            filter: drop-shadow(0 2px 4px rgba(148, 163, 184, 0.5));
        }

        .difficulty-ranking-item.second .difficulty-ranking-name {
            font-weight: 700;
            color: #475569;
        }

        .difficulty-ranking-item.third .difficulty-ranking-position,
        .difficulty-ranking-item.third .difficulty-ranking-score {
            color: #b45309;
            font-size: 1.15em;
            font-weight: 800;
            text-shadow: 0 1px 3px rgba(217, 119, 6, 0.4);
        }
        
        .difficulty-ranking-item.third .difficulty-ranking-position::before {
            content: '🥉';
            font-size: 1.3em;
            animation: medalFloat 2s ease-in-out infinite;
            filter: drop-shadow(0 2px 4px rgba(217, 119, 6, 0.5));
        }

        .difficulty-ranking-item.third .difficulty-ranking-name {
            font-weight: 700;
            color: #92400e;
        }

        .difficulty-ranking-position {
            font-weight: bold;
            color: #667eea;
            min-width: 40px;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .difficulty-ranking-name {
            flex: 1;
            text-align: left;
            margin-left: 15px;
            font-weight: 600;
            font-size: 1.05em;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
            overflow: visible;
            position: relative;
        }

        .difficulty-ranking-score {
            font-weight: bold;
            color: #667eea;
            font-size: 1.1em;
        }

        .main-ranking-position {
            font-weight: bold;
            color: #667eea;
            min-width: 40px;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Estilos para posición en modo imposible */
        body.hell-mode .main-ranking-position {
            color: #ff9999 !important;
            text-shadow: 0 0 5px rgba(255, 140, 0, 0.5);
        }

        .main-ranking-name {
            flex: 1;
            text-align: left;
            margin-left: 15px;
            font-weight: 600;
            font-size: 1.05em;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
            overflow: visible;
            position: relative;
        }

        .ranking-profile-picture {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            border: 2px solid white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            overflow: visible;
            position: relative;
            overflow: visible;
            position: relative;
        }

        .ranking-profile-picture img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .ranking-profile-picture .placeholder {
            font-size: 1.2em;
            color: white;
        }

        /* Estilos para nombres en modo imposible */
        body.hell-mode .main-ranking-name {
            color: #ffcc99 !important;
            text-shadow: 0 0 5px rgba(255, 140, 0, 0.5), 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .main-ranking-score {
            font-weight: bold;
            color: #764ba2;
            font-size: 1.2em;
        }

        /* Estilos para puntuación en modo imposible */
        body.hell-mode .main-ranking-score {
            color: #ffcc99 !important;
            text-shadow: 0 0 5px rgba(255, 140, 0, 0.5);
        }

        /* Estilos para puntuación en modo imposible */
        body.hell-mode .main-ranking-score {
            color: #ffcc99;
            text-shadow: 0 0 5px rgba(255, 140, 0, 0.3);
        }

        .ranking-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .ranking-item {
            background: #f7fafc;
            padding: 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #667eea;
        }

        .ranking-item.top {
            border-left-color: #fbbf24;
            background: #fffbeb;
        }

        .ranking-position {
            font-weight: bold;
            color: #667eea;
            min-width: 30px;
        }

        .ranking-name {
            flex: 1;
            text-align: left;
            margin-left: 10px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ranking-score {
            font-weight: bold;
            color: #764ba2;
            font-size: 1.1em;
        }

        .restart-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s;
            font-weight: 600;
            width: 100%;
            margin-top: 10px;
        }

        .restart-btn:hover {
            transform: scale(1.05);
        }

        .show-ranking-btn {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1em;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
            font-weight: 600;
            width: 100%;
            margin-top: 10px;
        }

        .show-ranking-btn:hover {
            transform: scale(1.05);
        }

        /* Estilos para autenticación */
        .auth-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .auth-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
        }

        .auth-box h2 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2em;
        }

        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .auth-tab.active {
            background: #667eea;
            color: white;
        }

        .auth-tab:hover {
            transform: translateY(-2px);
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .auth-input {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .auth-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .auth-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .auth-btn:hover {
            transform: scale(1.02);
        }

        .auth-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .auth-message {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9em;
            min-height: 20px;
        }

        .auth-message.error {
            background: #fed7d7;
            color: #c53030;
        }

        .auth-message.success {
            background: #c6f6d5;
            color: #22543d;
        }

        /* Estilos para círculo de foto de perfil */
        .profile-picture-container {
            position: relative;
            flex-shrink: 0;
        }

        .profile-picture-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            border: 3px solid white;
            overflow: visible;
            position: relative;
        }

        .profile-picture-circle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .profile-picture-circle > img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
            position: relative;
            z-index: 1;
        }

        .profile-picture-placeholder {
            font-size: 2em;
            color: white;
        }

        /* Estilos para modal de perfil */
        .profile-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .profile-modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .profile-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .profile-modal-header h2 {
            margin: 0;
            color: #333;
            font-size: 1.8em;
        }

        .profile-modal-close {
            background: #f56565;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .profile-modal-close:hover {
            background: #e53e3e;
            transform: rotate(90deg);
        }

        .profile-modal-body {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        /* Modal de llamada entrante */
        .call-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 5000;
            animation: fadeIn 0.3s ease;
        }

        .call-modal.active {
            display: flex;
        }

        .call-modal-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 30px;
            padding: 50px 40px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .call-modal-content::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 0.5;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }
        }

        .call-modal-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: ring 1.5s ease-in-out infinite;
            position: relative;
            z-index: 1;
        }

        @keyframes ring {
            0%, 100% {
                transform: scale(1) rotate(0deg);
            }
            25% {
                transform: scale(1.1) rotate(-5deg);
            }
            50% {
                transform: scale(1.15) rotate(0deg);
            }
            75% {
                transform: scale(1.1) rotate(5deg);
            }
        }

        .call-modal-title {
            color: white;
            font-size: 1.8em;
            font-weight: 600;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .call-modal-caller {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.3em;
            margin-bottom: 40px;
            position: relative;
            z-index: 1;
        }

        .call-modal-actions {
            display: flex;
            gap: 20px;
            justify-content: center;
            position: relative;
            z-index: 1;
        }

        .call-modal-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 2em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .call-modal-btn-accept {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
        }

        .call-modal-btn-accept:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(72, 187, 120, 0.5);
        }

        .call-modal-btn-accept:active {
            transform: scale(0.95);
        }

        .call-modal-btn-reject {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            color: white;
        }

        .call-modal-btn-reject:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(245, 101, 101, 0.5);
        }

        .call-modal-btn-reject:active {
            transform: scale(0.95);
        }

        /* Modal de llamada saliente */
        .outgoing-call-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 5000;
            animation: fadeIn 0.3s ease;
        }

        .outgoing-call-modal.active {
            display: flex;
        }

        .outgoing-call-modal-content {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            border-radius: 30px;
            padding: 50px 40px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .outgoing-call-modal-content::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: pulse 2s ease-in-out infinite;
        }

        .outgoing-call-modal-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: callingAnimation 1.5s ease-in-out infinite;
            position: relative;
            z-index: 1;
        }

        @keyframes callingAnimation {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }

        .outgoing-call-modal-title {
            color: white;
            font-size: 1.8em;
            font-weight: 600;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .outgoing-call-modal-recipient {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.3em;
            margin-bottom: 40px;
            position: relative;
            z-index: 1;
        }

        .outgoing-call-modal-actions {
            display: flex;
            gap: 20px;
            justify-content: center;
            position: relative;
            z-index: 1;
        }

        .outgoing-call-modal-btn-cancel {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 2em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            color: white;
        }

        .outgoing-call-modal-btn-cancel:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(245, 101, 101, 0.5);
        }

        .outgoing-call-modal-btn-cancel:active {
            transform: scale(0.95);
        }

        .profile-picture-large-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .profile-picture-large {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            border: 5px solid white;
            overflow: visible;
            position: relative;
        }

        .profile-picture-large > img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
            position: relative;
            z-index: 1;
        }


        .profile-picture-large-placeholder {
            font-size: 5em;
            color: white;
        }

        .profile-upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .profile-upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        /* Selector de estilos para foto de perfil */
        .profile-style-selector {
            margin-top: 15px;
            width: 100%;
        }

        .profile-style-selector-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        .profile-style-selector-toggle:hover {
            background: #edf2f7;
            border-color: #667eea;
        }

        .profile-style-selector-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #333;
            font-size: 0.95em;
            margin: 0;
        }

        .profile-style-selector-arrow {
            transition: transform 0.3s ease;
            font-size: 1.2em;
            color: #667eea;
        }

        .profile-style-selector-toggle.expanded .profile-style-selector-arrow {
            transform: rotate(180deg);
        }

        .profile-style-selector-content {
            display: none;
        }

        .profile-style-selector-toggle.expanded + .profile-style-selector-content {
            display: block;
        }

        .profile-style-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .profile-style-option {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            border: 3px solid transparent;
            overflow: hidden;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
        }

        .profile-style-option:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .profile-style-option.selected {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3), 0 4px 15px rgba(102, 126, 234, 0.5);
        }

        /* Botón de expandir estilos */
        .profile-style-expand-btn,
        .profile-decoration-expand-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            border: 3px dashed #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            color: #667eea;
            font-weight: bold;
        }

        .profile-decoration-expand-btn {
            width: 60px;
            height: 60px;
            font-size: 1.5em;
        }

        .profile-style-expand-btn:hover,
        .profile-decoration-expand-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
            border-color: #764ba2;
        }

        /* Opciones adicionales ocultas */
        .profile-style-options-extra,
        .profile-decoration-options-extra {
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 10px;
            animation: fadeInExpand 0.3s ease;
        }

        .profile-decoration-options-extra {
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
        }

        .profile-style-options-extra.show,
        .profile-decoration-options-extra.show {
            display: grid;
        }

        @keyframes fadeInExpand {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .profile-style-option .style-preview {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        /* Estilos de foto de perfil */
        /* .profile-picture-style-classic usa los estilos por defecto */

        .profile-picture-style-gold {
            border-color: #ffd700 !important;
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.6), 0 0 20px rgba(255, 215, 0, 0.3) !important;
        }

        .profile-picture-style-gradient {
            border: 5px solid transparent !important;
            background: linear-gradient(white, white) padding-box,
                        linear-gradient(135deg, #667eea, #764ba2, #f093fb) border-box !important;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5) !important;
        }

        .profile-picture-style-neon {
            border-color: #00ffff !important;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.8), 
                        0 0 40px rgba(0, 255, 255, 0.4),
                        0 8px 25px rgba(0, 0, 0, 0.3) !important;
        }

        .profile-picture-style-vintage {
            border-color: #8b4513 !important;
            box-shadow: 0 8px 25px rgba(139, 69, 19, 0.5),
                        inset 0 0 20px rgba(139, 69, 19, 0.2) !important;
            filter: sepia(20%);
        }

        .profile-picture-style-rainbow {
            border: 5px solid transparent !important;
            background: linear-gradient(white, white) padding-box,
                        linear-gradient(45deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3) border-box !important;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5) !important;
        }

        .profile-picture-style-diamond {
            border-color: #c0c0c0 !important;
            box-shadow: 0 0 30px rgba(192, 192, 192, 0.8),
                        0 8px 25px rgba(0, 0, 0, 0.3) !important;
        }

        .profile-picture-style-fire {
            border-color: #ff4500 !important;
            box-shadow: 0 0 25px rgba(255, 69, 0, 0.8),
                        0 0 50px rgba(255, 140, 0, 0.4),
                        0 8px 25px rgba(0, 0, 0, 0.3) !important;
        }

        .profile-picture-style-ice {
            border-color: #87ceeb !important;
            box-shadow: 0 0 25px rgba(135, 206, 235, 0.8),
                        0 0 50px rgba(173, 216, 230, 0.4),
                        0 8px 25px rgba(0, 0, 0, 0.3) !important;
        }

        .profile-picture-style-heart {
            border-color: #ff69b4 !important;
            box-shadow: 0 0 20px rgba(255, 105, 180, 0.6),
                        0 8px 25px rgba(0, 0, 0, 0.3) !important;
        }

        .profile-picture-style-silver {
            border-color: #a8a8a8 !important;
            box-shadow: 0 0 20px rgba(168, 168, 168, 0.6),
                        0 8px 25px rgba(0, 0, 0, 0.3) !important;
        }

        .profile-picture-style-copper {
            border-color: #b87333 !important;
            box-shadow: 0 0 20px rgba(184, 115, 51, 0.6),
                        0 8px 25px rgba(0, 0, 0, 0.3) !important;
        }

        .profile-picture-style-emerald {
            border-color: #50c878 !important;
            box-shadow: 0 0 25px rgba(80, 200, 120, 0.7),
                        0 8px 25px rgba(0, 0, 0, 0.3) !important;
        }

        .profile-picture-style-sapphire {
            border-color: #0f52ba !important;
            box-shadow: 0 0 25px rgba(15, 82, 186, 0.7),
                        0 8px 25px rgba(0, 0, 0, 0.3) !important;
        }

        .profile-picture-style-ruby {
            border-color: #e0115f !important;
            box-shadow: 0 0 25px rgba(224, 17, 95, 0.7),
                        0 8px 25px rgba(0, 0, 0, 0.3) !important;
        }

        .profile-picture-style-amethyst {
            border-color: #9966cc !important;
            box-shadow: 0 0 25px rgba(153, 102, 204, 0.7),
                        0 8px 25px rgba(0, 0, 0, 0.3) !important;
        }

        .profile-picture-style-sunset {
            border: 5px solid transparent !important;
            background: linear-gradient(white, white) padding-box,
                        linear-gradient(135deg, #ff6b6b, #ffa500, #ffd700) border-box !important;
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.5) !important;
        }

        .profile-picture-style-ocean {
            border: 5px solid transparent !important;
            background: linear-gradient(white, white) padding-box,
                        linear-gradient(135deg, #006994, #00a8cc, #87ceeb) border-box !important;
            box-shadow: 0 8px 25px rgba(0, 105, 148, 0.5) !important;
        }

        .profile-picture-style-forest {
            border: 5px solid transparent !important;
            background: linear-gradient(white, white) padding-box,
                        linear-gradient(135deg, #2d5016, #4a7c2a, #6ba84f) border-box !important;
            box-shadow: 0 8px 25px rgba(45, 80, 22, 0.5) !important;
        }

        .profile-picture-style-cosmic {
            border-color: #8b00ff !important;
            box-shadow: 0 0 30px rgba(139, 0, 255, 0.8),
                        0 0 60px rgba(139, 0, 255, 0.4),
                        0 8px 25px rgba(0, 0, 0, 0.3) !important;
        }

        /* Estilos animados */
        .profile-picture-style-burning {
            border-color: #ff4500 !important;
            position: relative;
            animation: burningEffect 2s ease-in-out infinite !important;
            box-shadow: 0 0 30px rgba(255, 69, 0, 0.8),
                        0 0 60px rgba(255, 140, 0, 0.6),
                        0 0 90px rgba(255, 200, 0, 0.4),
                        0 8px 25px rgba(0, 0, 0, 0.3) !important;
        }

        .profile-picture-style-burning::before {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            border-radius: 50%;
            background: linear-gradient(45deg, 
                rgba(255, 69, 0, 0.6) 0%,
                rgba(255, 140, 0, 0.6) 25%,
                rgba(255, 200, 0, 0.6) 50%,
                rgba(255, 140, 0, 0.6) 75%,
                rgba(255, 69, 0, 0.6) 100%);
            background-size: 200% 200%;
            animation: fireGradient 3s linear infinite;
            z-index: -1;
            filter: blur(8px);
        }

        .profile-particle.fire-particle {
            font-size: 0.9em;
            animation: fireFloatAround 2s ease-in-out infinite;
            filter: drop-shadow(0 2px 4px rgba(255, 69, 0, 0.8));
        }

        @keyframes fireFloatAround {
            0%, 100% {
                transform: translate(-50%, -50%) translate(var(--particle-offset-x, 0), var(--particle-offset-y, 0)) scale(1) rotate(0deg);
                opacity: 0.8;
            }
            50% {
                transform: translate(-50%, -50%) translate(calc(var(--particle-offset-x, 0) + var(--particle-move-x, 0)), calc(var(--particle-offset-y, 0) + var(--particle-move-y, -30px))) scale(1.2) rotate(180deg);
                opacity: 1;
            }
        }

        @keyframes burningEffect {
            0%, 100% {
                filter: brightness(1) contrast(1) hue-rotate(0deg);
                transform: scale(1);
            }
            25% {
                filter: brightness(1.2) contrast(1.1) hue-rotate(5deg);
                transform: scale(1.02);
            }
            50% {
                filter: brightness(1.1) contrast(1.15) hue-rotate(-5deg);
                transform: scale(0.98);
            }
            75% {
                filter: brightness(1.15) contrast(1.05) hue-rotate(3deg);
                transform: scale(1.01);
            }
        }

        @keyframes fireGradient {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        .profile-picture-style-pulse {
            border-color: #667eea !important;
            animation: pulseGlow 2s ease-in-out infinite !important;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.6),
                        0 0 40px rgba(102, 126, 234, 0.4),
                        0 0 60px rgba(102, 126, 234, 0.2),
                        0 8px 25px rgba(0, 0, 0, 0.3) !important;
        }

        @keyframes pulseGlow {
            0%, 100% {
                box-shadow: 0 0 20px rgba(102, 126, 234, 0.6),
                            0 0 40px rgba(102, 126, 234, 0.4),
                            0 0 60px rgba(102, 126, 234, 0.2),
                            0 8px 25px rgba(0, 0, 0, 0.3);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 0 30px rgba(102, 126, 234, 0.8),
                            0 0 60px rgba(102, 126, 234, 0.6),
                            0 0 90px rgba(102, 126, 234, 0.4),
                            0 8px 25px rgba(0, 0, 0, 0.3);
                transform: scale(1.05);
            }
        }

        .profile-picture-style-rainbow-animated {
            border: 5px solid transparent !important;
            background: linear-gradient(white, white) padding-box,
                        linear-gradient(45deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3) border-box !important;
            background-size: 300% 300% !important;
            animation: rainbowRotate 3s linear infinite !important;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5) !important;
        }

        @keyframes rainbowRotate {
            0% {
                background-position: 0% 50%;
            }
            100% {
                background-position: 100% 50%;
            }
        }

        .profile-picture-style-shimmer {
            border-color: #c0c0c0 !important;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(192, 192, 192, 0.8),
                        0 8px 25px rgba(0, 0, 0, 0.3) !important;
        }

        .profile-picture-style-shimmer::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, 
                transparent 30%,
                rgba(255, 255, 255, 0.5) 50%,
                transparent 70%);
            animation: shimmerMove 3s linear infinite;
            pointer-events: none;
        }

        @keyframes shimmerMove {
            0% {
                transform: translateX(-100%) translateY(-100%) rotate(45deg);
            }
            100% {
                transform: translateX(100%) translateY(100%) rotate(45deg);
            }
        }

        .profile-picture-style-neon-pulse {
            border-color: #00ffff !important;
            animation: neonPulse 1.5s ease-in-out infinite !important;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.8), 
                        0 0 40px rgba(0, 255, 255, 0.6),
                        0 0 60px rgba(0, 255, 255, 0.4),
                        0 8px 25px rgba(0, 0, 0, 0.3) !important;
        }

        @keyframes neonPulse {
            0%, 100% {
                box-shadow: 0 0 20px rgba(0, 255, 255, 0.8), 
                            0 0 40px rgba(0, 255, 255, 0.6),
                            0 0 60px rgba(0, 255, 255, 0.4),
                            0 8px 25px rgba(0, 0, 0, 0.3);
                filter: brightness(1);
            }
            50% {
                box-shadow: 0 0 30px rgba(0, 255, 255, 1), 
                            0 0 60px rgba(0, 255, 255, 0.8),
                            0 0 90px rgba(0, 255, 255, 0.6),
                            0 8px 25px rgba(0, 0, 0, 0.3);
                filter: brightness(1.3);
            }
        }

        .profile-picture-style-waves {
            border-color: #00a8cc !important;
            position: relative;
            box-shadow: 0 0 25px rgba(0, 168, 204, 0.7),
                        0 8px 25px rgba(0, 0, 0, 0.3) !important;
        }

        .profile-picture-style-waves::before {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            border-radius: 50%;
            border: 3px solid rgba(0, 168, 204, 0.6);
            animation: waveExpand 2s ease-out infinite;
            z-index: -1;
        }

        .profile-picture-style-waves::after {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            border-radius: 50%;
            border: 3px solid rgba(0, 168, 204, 0.4);
            animation: waveExpand 2s ease-out infinite 0.5s;
            z-index: -1;
        }

        @keyframes waveExpand {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: scale(1.3);
                opacity: 0;
            }
        }

        .profile-picture-style-electric {
            border-color: #ffd700 !important;
            animation: electricFlicker 0.1s linear infinite !important;
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.8),
                        0 0 50px rgba(255, 215, 0, 0.6),
                        0 8px 25px rgba(0, 0, 0, 0.3) !important;
        }

        @keyframes electricFlicker {
            0%, 100% {
                filter: brightness(1) drop-shadow(0 0 5px rgba(255, 215, 0, 0.8));
            }
            25% {
                filter: brightness(1.2) drop-shadow(0 0 10px rgba(255, 215, 0, 1));
            }
            50% {
                filter: brightness(0.9) drop-shadow(0 0 3px rgba(255, 215, 0, 0.6));
            }
            75% {
                filter: brightness(1.1) drop-shadow(0 0 8px rgba(255, 215, 0, 0.9));
            }
        }

        .profile-picture-style-magma {
            border-color: #ff4500 !important;
            position: relative;
            animation: magmaFlow 4s ease-in-out infinite !important;
            box-shadow: 0 0 30px rgba(255, 69, 0, 0.8),
                        0 0 60px rgba(255, 140, 0, 0.6),
                        0 8px 25px rgba(0, 0, 0, 0.3) !important;
        }

        .profile-picture-style-magma::before {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            border-radius: 50%;
            background: linear-gradient(135deg, 
                rgba(255, 69, 0, 0.8) 0%,
                rgba(255, 140, 0, 0.8) 50%,
                rgba(255, 200, 0, 0.8) 100%);
            background-size: 200% 200%;
            animation: magmaGradient 3s ease infinite;
            z-index: -1;
            filter: blur(10px);
        }

        @keyframes magmaFlow {
            0%, 100% {
                filter: brightness(1) hue-rotate(0deg);
            }
            50% {
                filter: brightness(1.2) hue-rotate(10deg);
            }
        }

        @keyframes magmaGradient {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        /* Contenedor para partículas animadas */
        .profile-particles-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
            overflow: visible;
        }

        .profile-particle {
            position: absolute;
            pointer-events: none;
            user-select: none;
        }

        /* Estilos con efectos de gotas y salpicaduras */
        .profile-picture-style-rain {
            border-color: #87ceeb !important;
            position: relative;
            overflow: visible;
            box-shadow: 0 0 25px rgba(135, 206, 235, 0.7),
                        0 8px 25px rgba(0, 0, 0, 0.3) !important;
        }

        .profile-particle.rain-drop {
            width: 3px;
            height: 15px;
            background: linear-gradient(to bottom, 
                rgba(135, 206, 235, 0.8) 0%,
                rgba(135, 206, 235, 0.4) 100%);
            border-radius: 2px;
            animation: dropFallAround 2s linear infinite;
        }

        @keyframes dropFall {
            0% {
                transform: translateY(0) scaleY(1);
                opacity: 1;
            }
            100% {
                transform: translateY(200px) scaleY(0.5);
                opacity: 0;
            }
        }

        @keyframes dropFallAround {
            0% {
                transform: translate(-50%, -50%) translate(var(--particle-offset-x, 0), var(--particle-offset-y, 0)) scaleY(1);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) translate(calc(var(--particle-offset-x, 0) + var(--particle-move-x, 0)), calc(var(--particle-offset-y, 0) + var(--particle-move-y, 250px))) scaleY(0.5);
                opacity: 0;
            }
        }

        .profile-picture-style-splash {
            border-color: #00a8cc !important;
            position: relative;
            overflow: visible;
            box-shadow: 0 0 25px rgba(0, 168, 204, 0.7),
                        0 8px 25px rgba(0, 0, 0, 0.3) !important;
        }

        .profile-particle.splash {
            width: 25px;
            height: 12px;
            background: radial-gradient(ellipse at center,
                rgba(0, 168, 204, 0.6) 0%,
                rgba(0, 168, 204, 0.3) 50%,
                transparent 100%);
            border-radius: 50%;
            animation: splashEffectAround 2s ease-out infinite;
        }

        @keyframes splashEffect {
            0% {
                transform: translateX(-50%) scale(0);
                opacity: 1;
            }
            50% {
                transform: translateX(-50%) scale(1.5);
                opacity: 0.7;
            }
            100% {
                transform: translateX(-50%) scale(2);
                opacity: 0;
            }
        }

        @keyframes splashEffectAround {
            0% {
                transform: translate(-50%, -50%) translate(var(--particle-offset-x, 0), var(--particle-offset-y, 0)) scale(0);
                opacity: 1;
            }
            50% {
                transform: translate(-50%, -50%) translate(calc(var(--particle-offset-x, 0) + var(--particle-move-x, 0)), calc(var(--particle-offset-y, 0) + var(--particle-move-y, 0))) scale(1.5);
                opacity: 0.7;
            }
            100% {
                transform: translate(-50%, -50%) translate(calc(var(--particle-offset-x, 0) + var(--particle-move-x, 0)), calc(var(--particle-offset-y, 0) + var(--particle-move-y, 0))) scale(2);
                opacity: 0;
            }
        }

        .profile-picture-style-drops {
            border-color: #4a90e2 !important;
            position: relative;
            overflow: visible;
            box-shadow: 0 0 25px rgba(74, 144, 226, 0.7),
                        0 8px 25px rgba(0, 0, 0, 0.3) !important;
        }

        .profile-particle.drop-emoji {
            font-size: 1em;
            animation: dropFallEmojiAround 2s ease-in infinite;
            filter: drop-shadow(0 2px 4px rgba(74, 144, 226, 0.5));
        }

        @keyframes dropFallEmoji {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(180px) rotate(360deg);
                opacity: 0;
            }
        }

        @keyframes dropFallEmojiAround {
            0% {
                transform: translate(-50%, -50%) translate(var(--particle-offset-x, 0), var(--particle-offset-y, 0)) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) translate(calc(var(--particle-offset-x, 0) + var(--particle-move-x, 0)), calc(var(--particle-offset-y, 0) + var(--particle-move-y, 200px))) rotate(360deg);
                opacity: 0;
            }
        }

        .profile-picture-style-particles {
            border-color: #ffd700 !important;
            position: relative;
            overflow: visible;
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.7),
                        0 8px 25px rgba(0, 0, 0, 0.3) !important;
        }

        .profile-particle.particle-star {
            font-size: 0.7em;
            animation: particleFloatAround 3s ease-in-out infinite;
        }

        @keyframes particleFloat1 {
            0%, 100% {
                transform: translateY(0) translateX(0) rotate(0deg);
                opacity: 0.7;
            }
            25% {
                transform: translateY(-15px) translateX(10px) rotate(90deg);
                opacity: 1;
            }
            50% {
                transform: translateY(-30px) translateX(-10px) rotate(180deg);
                opacity: 0.8;
            }
            75% {
                transform: translateY(-15px) translateX(5px) rotate(270deg);
                opacity: 0.9;
            }
        }

        @keyframes particleFloat2 {
            0%, 100% {
                transform: translateY(0) translateX(0) rotate(0deg);
                opacity: 0.7;
            }
            25% {
                transform: translateY(-15px) translateX(-10px) rotate(-90deg);
                opacity: 1;
            }
            50% {
                transform: translateY(-30px) translateX(10px) rotate(-180deg);
                opacity: 0.8;
            }
            75% {
                transform: translateY(-15px) translateX(-5px) rotate(-270deg);
                opacity: 0.9;
            }
        }

        @keyframes particleFloatAround {
            0%, 100% {
                transform: translate(-50%, -50%) translate(var(--particle-offset-x, 0), var(--particle-offset-y, 0)) rotate(0deg);
                opacity: 0.7;
            }
            25% {
                transform: translate(-50%, -50%) translate(calc(var(--particle-offset-x, 0) + var(--particle-move-x, 15px)), calc(var(--particle-offset-y, 0) + var(--particle-move-y, -15px))) rotate(90deg);
                opacity: 1;
            }
            50% {
                transform: translate(-50%, -50%) translate(calc(var(--particle-offset-x, 0) - var(--particle-move-x, 15px)), calc(var(--particle-offset-y, 0) + var(--particle-move-y, -30px))) rotate(180deg);
                opacity: 0.8;
            }
            75% {
                transform: translate(-50%, -50%) translate(calc(var(--particle-offset-x, 0) + var(--particle-move-x, 10px)), calc(var(--particle-offset-y, 0) + var(--particle-move-y, -15px))) rotate(270deg);
                opacity: 0.9;
            }
        }

        .profile-picture-style-snow {
            border-color: #e0f2fe !important;
            position: relative;
            overflow: visible;
            box-shadow: 0 0 25px rgba(224, 242, 254, 0.7),
                        0 8px 25px rgba(0, 0, 0, 0.3) !important;
        }

        .profile-particle.snowflake {
            font-size: 0.8em;
            animation: snowFallAround 3s linear infinite;
            filter: drop-shadow(0 2px 4px rgba(255, 255, 255, 0.5));
        }

        @keyframes snowFall {
            0% {
                transform: translateY(0) translateX(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(200px) translateX(20px) rotate(360deg);
                opacity: 0;
            }
        }

        @keyframes snowFallAround {
            0% {
                transform: translate(-50%, -50%) translate(var(--particle-offset-x, 0), var(--particle-offset-y, 0)) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) translate(calc(var(--particle-offset-x, 0) + var(--particle-move-x, 20px)), calc(var(--particle-offset-y, 0) + var(--particle-move-y, 250px))) rotate(360deg);
                opacity: 0;
            }
        }

        .profile-picture-style-sparkles {
            border-color: #fbbf24 !important;
            position: relative;
            overflow: visible;
            box-shadow: 0 0 25px rgba(251, 191, 36, 0.7),
                        0 8px 25px rgba(0, 0, 0, 0.3) !important;
        }

        .profile-particle.sparkle {
            font-size: 0.6em;
            animation: sparkleFloatAround 2.5s ease-in-out infinite;
        }

        @keyframes sparkleFloat {
            0%, 100% {
                transform: translateY(0) scale(1) rotate(0deg);
                opacity: 0.6;
            }
            50% {
                transform: translateY(-25px) scale(1.3) rotate(180deg);
                opacity: 1;
            }
        }

        @keyframes sparkleFloatAround {
            0%, 100% {
                transform: translate(-50%, -50%) translate(var(--particle-offset-x, 0), var(--particle-offset-y, 0)) scale(1) rotate(0deg);
                opacity: 0.6;
            }
            50% {
                transform: translate(-50%, -50%) translate(calc(var(--particle-offset-x, 0) + var(--particle-move-x, 10px)), calc(var(--particle-offset-y, 0) + var(--particle-move-y, -25px))) scale(1.3) rotate(180deg);
                opacity: 1;
            }
        }

        .profile-picture-style-bubbles {
            border-color: #60a5fa !important;
            position: relative;
            overflow: visible;
            box-shadow: 0 0 25px rgba(96, 165, 250, 0.7),
                        0 8px 25px rgba(0, 0, 0, 0.3) !important;
        }

        .profile-particle.bubble {
            width: 12px;
            height: 12px;
            border: 2px solid rgba(96, 165, 250, 0.6);
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%,
                rgba(96, 165, 250, 0.4) 0%,
                transparent 70%);
            animation: bubbleRiseAround 3s ease-out infinite;
        }

        @keyframes bubbleRise {
            0% {
                transform: translateY(0) scale(1);
                opacity: 0.8;
            }
            50% {
                transform: translateY(-100px) scale(1.2);
                opacity: 0.6;
            }
            100% {
                transform: translateY(-200px) scale(0.8);
                opacity: 0;
            }
        }

        @keyframes bubbleRiseAround {
            0% {
                transform: translate(-50%, -50%) translate(var(--particle-offset-x, 0), var(--particle-offset-y, 0)) scale(1);
                opacity: 0.8;
            }
            50% {
                transform: translate(-50%, -50%) translate(calc(var(--particle-offset-x, 0) + var(--particle-move-x, 0)), calc(var(--particle-offset-y, 0) + var(--particle-move-y, -100px))) scale(1.2);
                opacity: 0.6;
            }
            100% {
                transform: translate(-50%, -50%) translate(calc(var(--particle-offset-x, 0) + var(--particle-move-x, 0)), calc(var(--particle-offset-y, 0) + var(--particle-move-y, -200px))) scale(0.8);
                opacity: 0;
            }
        }

        .profile-picture-style-confetti {
            border-color: #f472b6 !important;
            position: relative;
            overflow: visible;
            box-shadow: 0 0 25px rgba(244, 114, 182, 0.7),
                        0 8px 25px rgba(0, 0, 0, 0.3) !important;
        }

        .profile-particle.confetti {
            font-size: 0.7em;
            animation: confettiFallAround 2s ease-in infinite;
        }

        @keyframes confettiFall {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(180px) rotate(720deg);
                opacity: 0;
            }
        }

        @keyframes confettiFallAround {
            0% {
                transform: translate(-50%, -50%) translate(var(--particle-offset-x, 0), var(--particle-offset-y, 0)) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) translate(calc(var(--particle-offset-x, 0) + var(--particle-move-x, 0)), calc(var(--particle-offset-y, 0) + var(--particle-move-y, 200px))) rotate(720deg);
                opacity: 0;
            }
        }

        /* Ajustar grosor de borde para círculo pequeño */
        .profile-picture-circle.profile-picture-style-gold,
        .profile-picture-circle.profile-picture-style-neon,
        .profile-picture-circle.profile-picture-style-vintage,
        .profile-picture-circle.profile-picture-style-diamond,
        .profile-picture-circle.profile-picture-style-fire,
        .profile-picture-circle.profile-picture-style-ice,
        .profile-picture-circle.profile-picture-style-heart {
            border-width: 3px !important;
        }

        .profile-picture-circle.profile-picture-style-gradient,
        .profile-picture-circle.profile-picture-style-rainbow,
        .profile-picture-circle.profile-picture-style-sunset,
        .profile-picture-circle.profile-picture-style-ocean,
        .profile-picture-circle.profile-picture-style-forest,
        .profile-picture-circle.profile-picture-style-rainbow-animated {
            border-width: 3px !important;
        }

        /* Asegurar que los estilos animados funcionen en círculo pequeño */
        .profile-picture-circle.profile-picture-style-burning::before,
        .profile-picture-circle.profile-picture-style-magma::before {
            filter: blur(5px);
        }

        .profile-picture-circle.profile-picture-style-shimmer::after {
            animation: shimmerMove 3s linear infinite;
        }

        .profile-picture-circle.profile-picture-style-waves::before,
        .profile-picture-circle.profile-picture-style-waves::after {
            border-width: 2px;
        }

        .profile-picture-circle.profile-picture-style-silver,
        .profile-picture-circle.profile-picture-style-copper,
        .profile-picture-circle.profile-picture-style-emerald,
        .profile-picture-circle.profile-picture-style-sapphire,
        .profile-picture-circle.profile-picture-style-ruby,
        .profile-picture-circle.profile-picture-style-amethyst,
        .profile-picture-circle.profile-picture-style-cosmic,
        .profile-picture-circle.profile-picture-style-burning,
        .profile-picture-circle.profile-picture-style-pulse,
        .profile-picture-circle.profile-picture-style-rainbow-animated,
        .profile-picture-circle.profile-picture-style-shimmer,
        .profile-picture-circle.profile-picture-style-neon-pulse,
        .profile-picture-circle.profile-picture-style-waves,
        .profile-picture-circle.profile-picture-style-electric,
        .profile-picture-circle.profile-picture-style-magma,
        .profile-picture-circle.profile-picture-style-rain,
        .profile-picture-circle.profile-picture-style-splash,
        .profile-picture-circle.profile-picture-style-drops,
        .profile-picture-circle.profile-picture-style-particles,
        .profile-picture-circle.profile-picture-style-snow,
        .profile-picture-circle.profile-picture-style-sparkles,
        .profile-picture-circle.profile-picture-style-bubbles,
        .profile-picture-circle.profile-picture-style-confetti {
            border-width: 3px !important;
        }

        /* Ajustes para partículas en círculo pequeño */
        .profile-picture-circle .profile-particle {
            font-size: 0.5em;
        }

        .profile-picture-circle .profile-particle.rain-drop {
            width: 2px;
            height: 10px;
        }

        .profile-picture-circle .profile-particle.splash {
            width: 15px;
            height: 8px;
        }

        .profile-picture-circle .profile-particle.bubble {
            width: 8px;
            height: 8px;
        }

        @keyframes dropFallSmall {
            0% {
                transform: translateY(0) scaleY(1);
                opacity: 1;
            }
            100% {
                transform: translateY(100px) scaleY(0.5);
                opacity: 0;
            }
        }

        @keyframes dropFallEmojiSmall {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100px) rotate(360deg);
                opacity: 0;
            }
        }

        @keyframes snowFallSmall {
            0% {
                transform: translateY(0) translateX(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100px) translateX(10px) rotate(360deg);
                opacity: 0;
            }
        }

        @keyframes bubbleRiseSmall {
            0% {
                transform: translateY(0) scale(1);
                opacity: 0.8;
            }
            50% {
                transform: translateY(-50px) scale(1.2);
                opacity: 0.6;
            }
            100% {
                transform: translateY(-100px) scale(0.8);
                opacity: 0;
            }
        }

        @keyframes confettiFallSmall {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100px) rotate(720deg);
                opacity: 0;
            }
        }

        /* Animaciones de preview para los botones */
        @keyframes burningPreview {
            0%, 100% { filter: brightness(1) hue-rotate(0deg); transform: scale(1); }
            50% { filter: brightness(1.2) hue-rotate(5deg); transform: scale(1.05); }
        }

        @keyframes pulsePreview {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        @keyframes rainbowPreview {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }

        @keyframes shimmerPreview {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        @keyframes neonPreview {
            0%, 100% { filter: brightness(1); box-shadow: 0 0 10px rgba(0,255,255,0.8); }
            50% { filter: brightness(1.3); box-shadow: 0 0 20px rgba(0,255,255,1); }
        }

        @keyframes electricPreview {
            0%, 100% { filter: brightness(1); }
            25% { filter: brightness(1.2); }
            50% { filter: brightness(0.9); }
            75% { filter: brightness(1.1); }
        }

        @keyframes magmaPreview {
            0% { background-position: 0% 50%; filter: brightness(1); }
            50% { background-position: 100% 50%; filter: brightness(1.2); }
            100% { background-position: 0% 50%; filter: brightness(1); }
        }

        /* Animaciones de preview para efectos de gotas y partículas */
        @keyframes dropPreview {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(30px); opacity: 0; }
        }

        @keyframes splashPreview {
            0% { transform: translateX(-50%) scale(0); opacity: 1; }
            100% { transform: translateX(-50%) scale(1.5); opacity: 0; }
        }

        @keyframes dropEmojiPreview {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(30px) rotate(180deg); opacity: 0; }
        }

        @keyframes particlePreview {
            0%, 100% { transform: translateY(0) rotate(0deg); opacity: 0.7; }
            50% { transform: translateY(-10px) rotate(180deg); opacity: 1; }
        }

        @keyframes snowPreview {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(30px) rotate(180deg); opacity: 0; }
        }

        @keyframes sparklePreview {
            0%, 100% { transform: translateY(0) scale(1) rotate(0deg); opacity: 0.6; }
            50% { transform: translateY(-10px) scale(1.2) rotate(90deg); opacity: 1; }
        }

        @keyframes bubblePreview {
            0% { transform: translateY(0) scale(1); opacity: 0.8; }
            100% { transform: translateY(-30px) scale(1.2); opacity: 0; }
        }

        @keyframes confettiPreview {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(30px) rotate(360deg); opacity: 0; }
        }

        /* Decoraciones de foto de perfil */
        .profile-picture-large,
        .profile-picture-circle,
        .ranking-profile-picture {
            position: relative;
        }

        .profile-decoration {
            position: absolute;
            pointer-events: none;
            z-index: 10;
            user-select: none;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        /* Orejas de gato - Círculo grande (150px) */
        .profile-picture-large .decoration-cat-ears {
            top: -20%;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            height: auto;
        }

        .profile-picture-large .decoration-cat-ears::before,
        .profile-picture-large .decoration-cat-ears::after {
            content: '🐱';
            position: absolute;
            font-size: 1.2em;
            top: 0;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.4));
        }

        .profile-picture-large .decoration-cat-ears::before {
            left: -35px;
        }

        .profile-picture-large .decoration-cat-ears::after {
            right: -35px;
        }

        /* Orejas de perro - Círculo grande */
        .profile-picture-large .decoration-dog-ears {
            top: -20%;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            height: auto;
        }

        .profile-picture-large .decoration-dog-ears::before,
        .profile-picture-large .decoration-dog-ears::after {
            content: '🐶';
            position: absolute;
            font-size: 1.2em;
            top: 0;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.4));
        }

        .profile-picture-large .decoration-dog-ears::before {
            left: -35px;
        }

        .profile-picture-large .decoration-dog-ears::after {
            right: -35px;
        }

        /* Orejas de conejo - Círculo grande */
        .profile-picture-large .decoration-rabbit-ears {
            top: -25%;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            height: auto;
        }

        .profile-picture-large .decoration-rabbit-ears::before,
        .profile-picture-large .decoration-rabbit-ears::after {
            content: '🐰';
            position: absolute;
            font-size: 1em;
            top: 0;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.4));
        }

        .profile-picture-large .decoration-rabbit-ears::before {
            left: -40px;
        }

        .profile-picture-large .decoration-rabbit-ears::after {
            right: -40px;
        }

        /* Corona - Círculo grande */
        .profile-picture-large .decoration-crown {
            top: -12%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2.5em;
            line-height: 1;
            filter: drop-shadow(0 3px 6px rgba(255, 215, 0, 0.6));
        }

        /* Sombrero - Círculo grande */
        .profile-picture-large .decoration-hat {
            top: -18%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2.2em;
            line-height: 1;
            filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.4));
        }

        /* Gafas - Círculo grande */
        .profile-picture-large .decoration-glasses {
            top: 30%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2em;
            line-height: 1;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.4));
        }

        /* Bigote - Círculo grande */
        .profile-picture-large .decoration-mustache {
            bottom: 20%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.8em;
            line-height: 1;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.4));
        }

        /* Corazones flotantes - Círculo grande */
        .profile-picture-large .decoration-hearts {
            top: -8%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.5em;
            line-height: 1;
            animation: floatHearts 2s ease-in-out infinite;
            filter: drop-shadow(0 2px 4px rgba(255, 20, 147, 0.5));
        }

        @keyframes floatHearts {
            0%, 100% {
                transform: translateX(-50%) translateY(0);
            }
            50% {
                transform: translateX(-50%) translateY(-12px);
            }
        }

        /* Estrellas - Círculo grande */
        .profile-picture-large .decoration-stars {
            top: -8%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.5em;
            line-height: 1;
            animation: twinkleStars 1.5s ease-in-out infinite;
            filter: drop-shadow(0 2px 4px rgba(255, 215, 0, 0.5));
        }

        @keyframes twinkleStars {
            0%, 100% {
                opacity: 1;
                transform: translateX(-50%) scale(1);
            }
            50% {
                opacity: 0.6;
                transform: translateX(-50%) scale(1.3);
            }
        }

        /* Antenas de alien - Círculo grande */
        .profile-picture-large .decoration-alien {
            top: -25%;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            height: auto;
        }

        .profile-picture-large .decoration-alien::before,
        .profile-picture-large .decoration-alien::after {
            content: '👽';
            position: absolute;
            font-size: 0.9em;
            top: 0;
            filter: drop-shadow(0 2px 4px rgba(0, 255, 0, 0.5));
        }

        .profile-picture-large .decoration-alien::before {
            left: -30px;
        }

        .profile-picture-large .decoration-alien::after {
            right: -30px;
        }

        /* Ajustes para círculo pequeño (60px) */
        .profile-picture-circle .profile-decoration {
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.4));
        }

        /* Orejas de gato - Círculo pequeño */
        .profile-picture-circle .decoration-cat-ears {
            top: -25%;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            height: auto;
        }

        .profile-picture-circle .decoration-cat-ears::before,
        .profile-picture-circle .decoration-cat-ears::after {
            content: '🐱';
            position: absolute;
            font-size: 0.7em;
            top: 0;
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.5));
        }

        .profile-picture-circle .decoration-cat-ears::before {
            left: -18px;
        }

        .profile-picture-circle .decoration-cat-ears::after {
            right: -18px;
        }

        /* Orejas de perro - Círculo pequeño */
        .profile-picture-circle .decoration-dog-ears {
            top: -25%;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            height: auto;
        }

        .profile-picture-circle .decoration-dog-ears::before,
        .profile-picture-circle .decoration-dog-ears::after {
            content: '🐶';
            position: absolute;
            font-size: 0.7em;
            top: 0;
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.5));
        }

        .profile-picture-circle .decoration-dog-ears::before {
            left: -18px;
        }

        .profile-picture-circle .decoration-dog-ears::after {
            right: -18px;
        }

        /* Orejas de conejo - Círculo pequeño */
        .profile-picture-circle .decoration-rabbit-ears {
            top: -30%;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            height: auto;
        }

        .profile-picture-circle .decoration-rabbit-ears::before,
        .profile-picture-circle .decoration-rabbit-ears::after {
            content: '🐰';
            position: absolute;
            font-size: 0.6em;
            top: 0;
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.5));
        }

        .profile-picture-circle .decoration-rabbit-ears::before {
            left: -20px;
        }

        .profile-picture-circle .decoration-rabbit-ears::after {
            right: -20px;
        }

        /* Corona - Círculo pequeño */
        .profile-picture-circle .decoration-crown {
            top: -18%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.2em;
            line-height: 1;
            filter: drop-shadow(0 2px 3px rgba(255, 215, 0, 0.6));
        }

        /* Sombrero - Círculo pequeño */
        .profile-picture-circle .decoration-hat {
            top: -25%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.1em;
            line-height: 1;
            filter: drop-shadow(0 2px 3px rgba(0, 0, 0, 0.4));
        }

        /* Gafas - Círculo pequeño */
        .profile-picture-circle .decoration-glasses {
            top: 25%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1em;
            line-height: 1;
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.4));
        }

        /* Bigote - Círculo pequeño */
        .profile-picture-circle .decoration-mustache {
            bottom: 15%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.9em;
            line-height: 1;
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.4));
        }

        /* Corazones flotantes - Círculo pequeño */
        .profile-picture-circle .decoration-hearts {
            top: -12%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8em;
            line-height: 1;
            animation: floatHeartsSmall 2s ease-in-out infinite;
            filter: drop-shadow(0 1px 2px rgba(255, 20, 147, 0.5));
        }

        @keyframes floatHeartsSmall {
            0%, 100% {
                transform: translateX(-50%) translateY(0);
            }
            50% {
                transform: translateX(-50%) translateY(-8px);
            }
        }

        /* Estrellas - Círculo pequeño */
        .profile-picture-circle .decoration-stars {
            top: -12%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8em;
            line-height: 1;
            animation: twinkleStarsSmall 1.5s ease-in-out infinite;
            filter: drop-shadow(0 1px 2px rgba(255, 215, 0, 0.5));
        }

        @keyframes twinkleStarsSmall {
            0%, 100% {
                opacity: 1;
                transform: translateX(-50%) scale(1);
            }
            50% {
                opacity: 0.6;
                transform: translateX(-50%) scale(1.2);
            }
        }

        /* Antenas de alien - Círculo pequeño */
        .profile-picture-circle .decoration-alien {
            top: -30%;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            height: auto;
        }

        .profile-picture-circle .decoration-alien::before,
        .profile-picture-circle .decoration-alien::after {
            content: '👽';
            position: absolute;
            font-size: 0.5em;
            top: 0;
            filter: drop-shadow(0 1px 2px rgba(0, 255, 0, 0.5));
        }

        .profile-picture-circle .decoration-alien::before {
            left: -15px;
        }

        .profile-picture-circle .decoration-alien::after {
            right: -15px;
        }

        /* Nuevas decoraciones - Círculo grande */
        .profile-picture-large .decoration-unicorn,
        .profile-picture-large .decoration-panda,
        .profile-picture-large .decoration-bear,
        .profile-picture-large .decoration-fox,
        .profile-picture-large .decoration-lion,
        .profile-picture-large .decoration-tiger,
        .profile-picture-large .decoration-cowboy,
        .profile-picture-large .decoration-party,
        .profile-picture-large .decoration-rocket,
        .profile-picture-large .decoration-fire-emoji,
        .profile-picture-large .decoration-lightning,
        .profile-picture-large .decoration-rainbow-emoji,
        .profile-picture-large .decoration-sun,
        .profile-picture-large .decoration-moon,
        .profile-picture-large .decoration-flower,
        .profile-picture-large .decoration-butterfly {
            top: -8%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.5em;
            line-height: 1;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.4));
        }

        /* Decoraciones para ranking también */
        .ranking-profile-picture .profile-decoration {
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.4));
        }

        /* Nuevas decoraciones - Círculo pequeño */
        .profile-picture-circle .decoration-unicorn,
        .profile-picture-circle .decoration-panda,
        .profile-picture-circle .decoration-bear,
        .profile-picture-circle .decoration-fox,
        .profile-picture-circle .decoration-lion,
        .profile-picture-circle .decoration-tiger,
        .profile-picture-circle .decoration-cowboy,
        .profile-picture-circle .decoration-party,
        .profile-picture-circle .decoration-rocket,
        .profile-picture-circle .decoration-fire-emoji,
        .profile-picture-circle .decoration-lightning,
        .profile-picture-circle .decoration-rainbow-emoji,
        .profile-picture-circle .decoration-sun,
        .profile-picture-circle .decoration-moon,
        .profile-picture-circle .decoration-flower,
        .profile-picture-circle .decoration-butterfly {
            top: -12%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8em;
            line-height: 1;
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.4));
        }

        /* Selector de decoraciones */
        .profile-decoration-selector {
            margin-top: 15px;
            width: 100%;
        }

        .profile-decoration-selector-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        .profile-decoration-selector-toggle:hover {
            background: #edf2f7;
            border-color: #667eea;
        }

        .profile-decoration-selector-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #333;
            font-size: 0.95em;
            margin: 0;
        }

        .profile-decoration-selector-arrow {
            transition: transform 0.3s ease;
            font-size: 1.2em;
            color: #667eea;
        }

        .profile-decoration-selector-toggle.expanded .profile-decoration-selector-arrow {
            transform: rotate(180deg);
        }

        .profile-decoration-selector-content {
            display: none;
        }

        .profile-decoration-selector-toggle.expanded + .profile-decoration-selector-content {
            display: block;
        }

        .profile-decoration-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .profile-decoration-option {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            border: 3px solid transparent;
            overflow: visible;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
        }

        .profile-decoration-option:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .profile-decoration-option.selected {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3), 0 4px 15px rgba(102, 126, 234, 0.5);
        }

        .profile-decoration-option[data-decoration="none"] {
            font-size: 1em;
        }

        .profile-info {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 15px;
        }

        .profile-info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .profile-info-item:last-child {
            border-bottom: none;
        }

        .profile-info-label {
            font-weight: 600;
            color: #4a5568;
        }

        .profile-info-value {
            color: #667eea;
            font-weight: 500;
        }

        .profile-description-item {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }

        .profile-description-input {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1em;
            font-family: inherit;
            resize: vertical;
            outline: none;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }

        .profile-description-input:focus {
            border-color: #667eea;
        }

        .profile-save-description-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s ease;
            align-self: flex-end;
        }

        .profile-save-description-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(72, 187, 120, 0.4);
        }

        .friend-profile-description {
            color: #4a5568;
            font-style: italic;
            padding: 10px;
            background: #f7fafc;
            border-radius: 8px;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .friend-description-item {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }

        .friend-profile-actions {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e2e8f0;
        }

        .remove-friend-btn {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(245, 101, 101, 0.4);
        }

        .remove-friend-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 101, 101, 0.6);
        }

        /* Estilos para biblioteca */
        .profile-library-section {
            width: 100%;
            margin-top: 20px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 15px;
        }

        .profile-library-section h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 1.3em;
            text-align: center;
        }

        .library-upload-container {
            margin-bottom: 15px;
            display: flex;
            justify-content: center;
        }

        .library-upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .library-upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .library-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .library-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .library-item:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.25);
        }

        /* Estilos para imágenes de biblioteca con interacciones */
        .library-item.has-interactions {
            border: 3px solid #f56565;
            box-shadow: 0 0 20px rgba(245, 101, 101, 0.6), 0 4px 15px rgba(0, 0, 0, 0.25);
            animation: imageNotificationGlow 2s ease-in-out infinite;
        }

        @keyframes imageNotificationGlow {
            0%, 100% {
                border-color: #f56565;
                box-shadow: 0 0 20px rgba(245, 101, 101, 0.6), 0 4px 15px rgba(0, 0, 0, 0.25);
            }
            50% {
                border-color: #ff6b9d;
                box-shadow: 0 0 30px rgba(245, 101, 101, 0.8), 0 6px 20px rgba(0, 0, 0, 0.3);
            }
        }

        .library-item.has-interactions::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 10px;
            background: linear-gradient(135deg, rgba(245, 101, 101, 0.1) 0%, rgba(66, 153, 225, 0.1) 100%);
            pointer-events: none;
            z-index: 1;
        }

        .library-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .library-item-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(245, 101, 101, 0.95);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            opacity: 0.9;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .library-item:hover .library-item-remove {
            opacity: 1;
            transform: scale(1.1);
        }

        .library-item-remove:hover {
            background: rgba(229, 62, 62, 1);
            transform: scale(1.15);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        .friend-library-section {
            width: 100%;
            margin-top: 20px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 15px;
        }

        .friend-library-section h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 1.3em;
            text-align: center;
        }

        .friend-library-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        .friend-library-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .friend-library-item:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.25);
        }

        .friend-library-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Modal para ver imagen en grande */
        .library-image-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 4000;
            animation: fadeIn 0.3s ease;
        }

        .library-image-modal-content {
            max-width: 90%;
            max-height: 90vh;
            width: 90%;
            height: 90vh;
            position: relative;
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .library-image-container {
            flex: 0 0 auto;
            min-height: 300px;
            max-height: 60vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: #000;
            padding: 20px;
        }

        .library-image-container {
            cursor: pointer;
        }

        .library-image-container img {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
            transition: transform 0.3s ease;
        }

        .library-image-container:hover img {
            transform: scale(1.02);
        }

        /* Modal de vista ampliada */
        .library-image-zoom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 5000;
            animation: fadeIn 0.3s ease;
        }

        .library-image-zoom-modal.active {
            display: flex;
        }

        .library-image-zoom-container {
            position: relative;
            width: 95%;
            height: 95%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .library-image-zoom-container img {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
        }

        .library-image-zoom-close-back {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 5001;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .library-image-zoom-close-back:hover {
            background: rgba(102, 126, 234, 0.9);
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.5);
        }

        .library-image-zoom-close-all {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 5001;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .library-image-zoom-close-all:hover {
            background: rgba(245, 101, 101, 0.9);
            transform: rotate(90deg) scale(1.1);
            box-shadow: 0 4px 12px rgba(245, 101, 101, 0.5);
        }

        .library-image-interactions {
            flex: 1 1 auto;
            min-height: 0;
            padding: 20px;
            overflow-y: auto;
            border-top: 2px solid #e2e8f0;
            background: #fafafa;
            display: flex;
            flex-direction: column;
        }

        .library-image-interactions::-webkit-scrollbar {
            width: 8px;
        }

        .library-image-interactions::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .library-image-interactions::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 10px;
        }

        .library-image-interactions::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }

        .library-image-likes {
            margin-bottom: 20px;
        }

        .like-btn {
            background: none;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .like-btn:hover {
            border-color: #f56565;
            background: #fff5f5;
        }

        .like-btn.liked {
            border-color: #f56565;
            background: #fff5f5;
        }

        .like-icon {
            font-size: 1.2em;
        }

        .like-count {
            font-weight: 600;
            color: #333;
        }

        .library-image-comments h4 {
            margin-bottom: 15px;
            color: #333;
        }

        .comments-list {
            flex: 1 1 auto;
            min-height: 0;
            overflow-y: auto;
            margin-bottom: 15px;
            padding-right: 5px;
        }

        .comments-list::-webkit-scrollbar {
            width: 6px;
        }

        .comments-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .comments-list::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 10px;
        }

        .comments-list::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }

        .comment-item {
            padding: 15px;
            margin-bottom: 15px;
            background: #f7fafc;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            display: flex;
            gap: 12px;
            align-items: flex-start;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .comment-profile-picture {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            flex-shrink: 0;
            overflow: hidden;
            background: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #667eea;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .comment-profile-picture img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .comment-profile-picture .placeholder {
            font-size: 1.5em;
        }

        .comment-content {
            flex: 1;
            min-width: 0;
        }

        .comment-author {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 6px;
            font-size: 0.95em;
        }

        .comment-text {
            color: #2d3748;
            word-wrap: break-word;
            margin-bottom: 10px;
            line-height: 1.5;
            font-size: 0.9em;
        }

        .comment-actions {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .comment-like-btn {
            background: none;
            border: none;
            color: #718096;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9em;
            padding: 5px 10px;
            border-radius: 15px;
            transition: all 0.2s ease;
        }

        .comment-like-btn:hover {
            background: #f7fafc;
            color: #f56565;
        }

        .comment-like-btn.liked {
            color: #f56565;
        }

        .comment-like-btn.liked .like-icon {
            animation: likePulse 0.3s ease;
        }

        @keyframes likePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .comment-reply-btn {
            background: none;
            border: none;
            color: #718096;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9em;
            padding: 5px 10px;
            border-radius: 15px;
            transition: all 0.2s ease;
        }

        .comment-reply-btn:hover {
            background: #f7fafc;
            color: #667eea;
        }

        .comment-delete-btn {
            background: none;
            border: none;
            color: #718096;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9em;
            padding: 5px 10px;
            border-radius: 15px;
            transition: all 0.2s ease;
        }

        .comment-delete-btn:hover {
            background: #f7fafc;
            color: #f56565;
        }

        .comment-replies {
            margin-top: 15px;
            margin-left: 55px;
            padding-left: 20px;
            padding-top: 5px;
            border-left: 3px solid #cbd5e0;
            position: relative;
            display: none;
        }

        .comment-replies.show {
            display: block;
        }

        .comment-replies::before {
            content: '';
            position: absolute;
            left: -3px;
            top: 0;
            width: 3px;
            height: 20px;
            background: #667eea;
            border-radius: 0 0 0 3px;
        }

        .comment-replies-toggle {
            margin-top: 10px;
            margin-left: 55px;
            padding: 8px 12px;
            background: transparent;
            border: none;
            color: #667eea;
            cursor: pointer;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
            border-radius: 6px;
        }

        .comment-replies-toggle:hover {
            background: #f7fafc;
            color: #764ba2;
        }

        .comment-replies-toggle .toggle-arrow {
            transition: transform 0.3s ease;
            font-size: 1.1em;
        }

        .comment-replies-toggle.expanded .toggle-arrow {
            transform: rotate(90deg);
        }

        .comment-replies-toggle .reply-count {
            color: #718096;
            font-size: 0.85em;
        }

        .comment-reply-item {
            margin-bottom: 12px;
            padding: 12px 15px;
            background: #edf2f7;
            border-radius: 8px;
            border-left: 3px solid #a0aec0;
            display: flex;
            gap: 12px;
            align-items: flex-start;
            position: relative;
            margin-left: 0;
        }

        .comment-reply-item .comment-profile-picture {
            width: 35px;
            height: 35px;
            border: 2px solid #a0aec0;
        }

        .comment-reply-item .comment-author {
            font-size: 0.9em;
            color: #4a5568;
        }

        .comment-reply-item .comment-text {
            font-size: 0.85em;
        }

        .comment-reply-indicator {
            font-size: 0.75em;
            color: #718096;
            margin-bottom: 4px;
            font-style: italic;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .comment-reply-indicator::before {
            content: '↪';
            color: #a0aec0;
            font-size: 0.9em;
        }

        .comment-reply-input-container {
            margin-top: 12px;
            margin-left: 60px;
            display: none;
        }

        .comment-reply-input-container.active {
            display: flex;
            gap: 10px;
            margin-top: 12px;
            padding: 10px;
            background: #f7fafc;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }

        .comment-reply-input {
            flex: 1;
            padding: 8px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.9em;
        }

        .comment-reply-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .comment-reply-submit {
            padding: 8px 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: background 0.3s ease;
        }

        .comment-reply-submit:hover {
            background: #5568d3;
        }

        .comment-input-container {
            display: flex;
            gap: 10px;
        }

        .comment-input {
            flex: 1;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
        }

        .comment-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .comment-submit-btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s ease;
        }

        .comment-submit-btn:hover {
            background: #5568d3;
        }

        .library-image-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 4001;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .library-image-modal-close:hover {
            background: rgba(245, 101, 101, 0.9);
            transform: rotate(90deg) scale(1.1);
            box-shadow: 0 4px 12px rgba(245, 101, 101, 0.5);
        }

        .profile-actions {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .profile-save-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.4);
        }

        .profile-save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(72, 187, 120, 0.6);
        }

        .profile-save-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .profile-friends-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            width: 100%;
            margin-top: 10px;
        }

        .profile-friends-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .profile-inbox-btn {
            background: linear-gradient(135deg, #f6ad55 0%, #ed8936 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(246, 173, 85, 0.4);
            width: 100%;
            margin-top: 10px;
        }

        .profile-inbox-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(246, 173, 85, 0.6);
        }

        .profile-mailbox-btn {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(66, 153, 225, 0.4);
            width: 100%;
            margin-top: 10px;
        }

        .profile-mailbox-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(66, 153, 225, 0.6);
        }

        .profile-send-mail-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.4);
            width: 100%;
            margin-top: 10px;
        }

        .profile-send-mail-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(72, 187, 120, 0.6);
        }

        /* Indicador de notificación */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #f56565;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75em;
            font-weight: bold;
            border: 2px solid white;
        }

        .profile-mailbox-btn.has-notifications,
        .profile-inbox-btn.has-notifications,
        .profile-friends-btn.has-notifications,
        .profile-library-section.has-notifications,
        .profile-chats-section.has-notifications {
            position: relative;
            animation: notificationPulse 2s ease-in-out infinite;
            box-shadow: 0 0 20px rgba(245, 101, 101, 0.6), 0 4px 15px rgba(66, 153, 225, 0.4) !important;
        }

        .profile-chats-section.has-notifications h3 {
            animation: notificationPulse 2s ease-in-out infinite;
        }

        .profile-chats-section {
            width: 100%;
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .profile-chats-section h3 {
            margin: 0 0 20px 0;
            color: #1a202c;
            font-size: 1.4em;
            font-weight: 600;
            letter-spacing: -0.02em;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e2e8f0;
        }

        .profile-chats-section h3::before {
            content: '💬';
            font-size: 1.3em;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }

        /* Estilos para lista de chats */
        .chats-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        .chat-item {
            position: relative;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: white;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 2px solid transparent;
        }

        .chat-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }

        /* Estilos para chat items con mensajes no leídos */
        .chat-item.has-unread {
            border: 2px solid #f56565;
            background: linear-gradient(135deg, #fff5f5 0%, #ffffff 100%);
            animation: chatItemPulse 2s ease-in-out infinite;
            box-shadow: 0 0 20px rgba(245, 101, 101, 0.4), 0 4px 15px rgba(0, 0, 0, 0.15);
        }

        @keyframes chatItemPulse {
            0%, 100% {
                border-color: #f56565;
                box-shadow: 0 0 20px rgba(245, 101, 101, 0.4), 0 4px 15px rgba(0, 0, 0, 0.15);
            }
            50% {
                border-color: #ff6b9d;
                box-shadow: 0 0 30px rgba(245, 101, 101, 0.6), 0 6px 20px rgba(0, 0, 0, 0.2);
            }
        }

        .chat-item.has-unread::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, #f56565 0%, #ff6b9d 100%);
            border-radius: 12px 0 0 12px;
        }

        .chat-item-picture {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .chat-item.has-unread .chat-item-picture {
            border: 3px solid #f56565;
            box-shadow: 0 0 15px rgba(245, 101, 101, 0.5);
            animation: pictureGlow 2s ease-in-out infinite;
        }

        @keyframes pictureGlow {
            0%, 100% {
                box-shadow: 0 0 15px rgba(245, 101, 101, 0.5);
            }
            50% {
                box-shadow: 0 0 25px rgba(245, 101, 101, 0.8);
            }
        }

        .chat-item-picture img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .chat-item-info {
            flex: 1;
            min-width: 0;
        }

        .chat-item-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 4px;
            font-size: 1em;
        }

        .chat-item.has-unread .chat-item-name {
            color: #c53030;
            font-weight: 700;
        }

        .chat-item-last-message {
            font-size: 0.9em;
            color: #718096;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .chat-item.has-unread .chat-item-last-message {
            color: #e53e3e;
            font-weight: 500;
        }

        .chat-item-unread {
            background: #f56565;
            color: white;
            border-radius: 50%;
            min-width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75em;
            font-weight: bold;
            padding: 0 6px;
            box-shadow: 0 2px 8px rgba(245, 101, 101, 0.5);
            animation: badgeBounce 1s ease-in-out infinite;
        }

        @keyframes badgeBounce {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }

        @keyframes notificationPulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 20px rgba(245, 101, 101, 0.6), 0 4px 15px rgba(66, 153, 225, 0.4);
            }
            50% {
                transform: scale(1.02);
                box-shadow: 0 0 30px rgba(245, 101, 101, 0.8), 0 6px 20px rgba(66, 153, 225, 0.6);
            }
        }

        .profile-mailbox-btn.has-notifications {
            border: 2px solid #f56565;
            background: linear-gradient(135deg, #f56565 0%, #4299e1 100%) !important;
        }

        .profile-inbox-btn.has-notifications {
            border: 2px solid #f6ad55;
            background: linear-gradient(135deg, #f6ad55 0%, #ed8936 100%) !important;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #f56565;
            color: white;
            border-radius: 50%;
            min-width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75em;
            font-weight: bold;
            border: 2px solid white;
            padding: 0 6px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }

        .notification-badge.large {
            min-width: 24px;
            height: 24px;
            font-size: 0.85em;
        }

        .profile-friends-section {
            width: 100%;
            margin-top: 20px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 15px;
        }

        .profile-friends-section h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 1.2em;
        }

        .friends-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .friend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .friend-item-picture {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            overflow: hidden;
        }

        .friend-item-picture img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .friend-item-name {
            flex: 1;
            font-weight: 600;
            color: #333;
        }

        .friend-item {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .friend-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }

        .friend-item-message {
            position: relative;
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(66, 153, 225, 0.4);
            flex-shrink: 0;
        }

        .friend-item-message:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(66, 153, 225, 0.6);
        }

        .friend-item-message.has-unread {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            box-shadow: 0 2px 8px rgba(245, 101, 101, 0.5);
            animation: messageIconPulse 2s ease-in-out infinite;
        }

        .friend-item-message.has-unread:hover {
            box-shadow: 0 4px 12px rgba(245, 101, 101, 0.7);
        }

        @keyframes messageIconPulse {
            0%, 100% {
                box-shadow: 0 2px 8px rgba(245, 101, 101, 0.5);
            }
            50% {
                box-shadow: 0 0 20px rgba(245, 101, 101, 0.8), 0 4px 12px rgba(245, 101, 101, 0.6);
            }
        }

        .friend-item-message-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #f56565;
            color: white;
            border-radius: 50%;
            min-width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            font-weight: bold;
            border: 2px solid white;
            padding: 0 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            z-index: 10;
            animation: badgeBounce 1s ease-in-out infinite;
        }

        .friend-item-remove {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(245, 101, 101, 0.4);
            flex-shrink: 0;
        }

        .friend-item-remove:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 10px rgba(245, 101, 101, 0.6);
        }

        .profile-toggle-scores-btn {
            background: linear-gradient(135deg, #9f7aea 0%, #805ad5 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(159, 122, 234, 0.4);
            width: 100%;
            margin-top: 10px;
        }

        .profile-toggle-scores-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(159, 122, 234, 0.6);
        }

        .profile-toggle-scores-btn.hidden {
            background: linear-gradient(135deg, #a0aec0 0%, #718096 100%);
        }

        .profile-scores-section {
            width: 100%;
            margin-top: 20px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 15px;
        }

        .profile-scores-section h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 1.2em;
        }

        .scores-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .score-item-level {
            font-weight: 600;
            color: #333;
        }

        .score-item-points {
            font-weight: bold;
            color: #764ba2;
            font-size: 1.1em;
        }

        /* Estilos para modal de perfil de amigo */
        .friend-profile-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            animation: fadeIn 0.3s ease;
        }

        .friend-profile-modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        .friend-profile-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .friend-profile-modal-header h2 {
            margin: 0;
            color: #333;
            font-size: 1.8em;
        }

        .friend-profile-modal-close {
            background: #f56565;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .friend-profile-modal-close:hover {
            background: #e53e3e;
            transform: rotate(90deg);
        }

        .friend-profile-picture-large-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            overflow: visible;
            position: relative;
        }

        .friend-profile-picture-large {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            border: 5px solid white;
            overflow: visible;
            position: relative;
        }

        .friend-profile-picture-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .friend-profile-picture-large-placeholder {
            font-size: 5em;
            color: white;
        }

        .friend-profile-info {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .friend-profile-info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .friend-profile-info-item:last-child {
            border-bottom: none;
        }

        .friend-profile-info-label {
            font-weight: 600;
            color: #4a5568;
        }

        .friend-profile-info-value {
            color: #667eea;
            font-weight: 500;
        }

        .friend-profile-scores-section {
            width: 100%;
            padding: 15px;
            background: #f7fafc;
            border-radius: 15px;
        }

        .friend-profile-scores-section h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 1.2em;
        }

        .friend-scores-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Estilos para modal de búsqueda de amigos */
        /* Estilos para botón crear grupo */
        .create-group-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .create-group-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        /* Estilos para modales de crear grupo */
        .create-group-modal,
        .create-group-name-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }

        .create-group-modal-content,
        .create-group-name-modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        .create-group-modal-header,
        .create-group-name-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
        }

        .create-group-modal-header h2,
        .create-group-name-modal-header h2 {
            margin: 0;
            color: #333;
            font-size: 1.5em;
        }

        .create-group-modal-close,
        .create-group-name-modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .create-group-modal-close:hover,
        .create-group-name-modal-close:hover {
            background: #f7fafc;
            color: #333;
        }

        .create-group-modal-body,
        .create-group-name-modal-body {
            padding: 20px;
        }

        .create-group-search {
            margin-bottom: 20px;
        }

        .create-group-search-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .create-group-search-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .create-group-selected {
            margin-bottom: 20px;
        }

        .create-group-selected h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 1em;
        }

        .group-selected-users-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 40px;
            padding: 10px;
            background: #f7fafc;
            border-radius: 8px;
        }

        .group-selected-user {
            display: flex;
            align-items: center;
            gap: 6px;
            background: white;
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid #e2e8f0;
            font-size: 0.9em;
        }

        .group-selected-user-remove {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 1.2em;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .group-selected-user-remove:hover {
            background: #fee;
            color: #c33;
        }

        .group-search-results {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px;
        }

        .group-search-result-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
            margin-bottom: 8px;
        }

        .group-search-result-item:hover {
            background: #f7fafc;
        }

        .group-search-result-item.selected {
            background: #e6f0ff;
            border: 2px solid #667eea;
        }

        .group-search-result-picture {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            background: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
        }

        .group-search-result-picture img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .group-search-result-info {
            flex: 1;
        }

        .group-search-result-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }

        .group-search-result-email {
            font-size: 0.85em;
            color: #666;
        }

        .create-group-actions,
        .create-group-name-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .create-group-btn-primary {
            flex: 1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .create-group-btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .create-group-btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .create-group-btn-secondary {
            flex: 1;
            background: #f7fafc;
            color: #333;
            border: 2px solid #e2e8f0;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .create-group-btn-secondary:hover {
            background: #e2e8f0;
        }

        .create-group-name-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            margin-bottom: 20px;
            transition: border-color 0.3s ease;
        }

        .create-group-name-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .create-group-name-preview {
            margin-bottom: 20px;
        }

        .create-group-name-preview h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 1em;
        }

        .group-name-preview-members {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 10px;
            background: #f7fafc;
            border-radius: 8px;
        }

        .group-name-preview-member {
            display: flex;
            align-items: center;
            gap: 6px;
            background: white;
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid #e2e8f0;
            font-size: 0.9em;
        }

        .friends-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            animation: fadeIn 0.3s ease;
        }

        .friends-modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        .friends-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .friends-modal-header h2 {
            margin: 0;
            color: #333;
            font-size: 1.8em;
        }

        .friends-modal-close {
            background: #f56565;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .friends-modal-close:hover {
            background: #e53e3e;
            transform: rotate(90deg);
        }

        .friends-search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .friends-search-input {
            flex: 1;
            min-width: 0;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1em;
            outline: none;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }

        .friends-search-input:focus {
            border-color: #667eea;
        }

        .friends-search-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            white-space: nowrap;
            flex-shrink: 0;
        }

        .friends-search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .friends-results {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .friend-result-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            flex-wrap: wrap;
        }

        .friend-result-picture {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            overflow: hidden;
        }

        .friend-result-picture img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .friend-result-info {
            flex: 1;
        }

        .friend-result-name {
            font-weight: 600;
            color: #333;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .friend-result-email {
            color: #718096;
            font-size: 0.9em;
        }

        .friend-result-actions {
            display: flex;
            gap: 10px;
        }

        .send-request-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .send-request-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(72, 187, 120, 0.4);
        }

        .send-request-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        /* Estilos para modal de bandeja */
        .inbox-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            animation: fadeIn 0.3s ease;
        }

        .inbox-modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        .inbox-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .inbox-modal-header h2 {
            margin: 0;
            color: #333;
            font-size: 1.8em;
        }

        .inbox-modal-close {
            background: #f56565;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .inbox-modal-close:hover {
            background: #e53e3e;
            transform: rotate(90deg);
        }

        .inbox-requests {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Estilos para modal de recomendaciones */
        .recommendations-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20000;
            animation: fadeIn 0.3s ease;
        }

        .recommendations-modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        .recommendations-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .recommendations-modal-header h2 {
            margin: 0;
            color: #333;
            font-size: 1.8em;
        }

        .recommendations-modal-close {
            background: #f56565;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .recommendations-modal-close:hover {
            background: #e53e3e;
            transform: rotate(90deg);
        }

        .recommendations-modal-body {
            margin-bottom: 25px;
        }

        .recommendation-textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1em;
            font-family: inherit;
            resize: vertical;
            min-height: 150px;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .recommendation-textarea:focus {
            border-color: #667eea;
        }

        .recommendations-modal-footer {
            display: flex;
            justify-content: flex-end;
        }

        .recommendation-submit-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .recommendation-submit-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        /* Estilos para modal de correo (recomendaciones recibidas) */
        .recommendations-inbox-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            animation: fadeIn 0.3s ease;
        }

        .recommendations-inbox-modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 700px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        .recommendations-inbox-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .recommendations-inbox-modal-header h2 {
            margin: 0;
            color: #333;
            font-size: 1.8em;
        }

        .recommendations-inbox-modal-close {
            background: #f56565;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .recommendations-inbox-modal-close:hover {
            background: #e53e3e;
            transform: rotate(90deg);
        }

        .recommendations-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .recommendation-item {
            display: flex;
            gap: 15px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .recommendation-item-profile {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            overflow: visible;
            flex-shrink: 0;
            position: relative;
            border: 2px solid #e2e8f0;
        }

        .recommendation-item-profile img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            background: #e2e8f0;
        }

        .recommendation-item-profile .placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #e2e8f0;
            font-size: 1.5em;
        }

        .recommendation-item-content {
            flex: 1;
        }

        .recommendation-item-author {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .recommendation-item-text {
            color: #4a5568;
            line-height: 1.6;
            margin-bottom: 10px;
            white-space: pre-wrap;
        }

        .recommendation-item-date {
            font-size: 0.85em;
            color: #718096;
        }

        .recommendation-item-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .recommendation-delete-btn {
            background: #f56565;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .recommendation-delete-btn:hover {
            background: #e53e3e;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(245, 101, 101, 0.4);
        }

        .recommendation-reply-btn {
            background: #4299e1;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .recommendation-reply-btn:hover {
            background: #3182ce;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(66, 153, 225, 0.4);
        }

        .recommendation-reply-form {
            margin-top: 15px;
            padding: 15px;
            background: #edf2f7;
            border-radius: 8px;
            border-left: 3px solid #4299e1;
        }

        .recommendation-reply-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.95em;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
            outline: none;
            transition: border-color 0.3s ease;
            margin-bottom: 10px;
        }

        .recommendation-reply-textarea:focus {
            border-color: #4299e1;
        }

        .recommendation-reply-submit-btn {
            background: #48bb78;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .recommendation-reply-submit-btn:hover {
            background: #38a169;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(72, 187, 120, 0.4);
        }

        .recommendation-item {
            position: relative;
        }

        .profile-recommendations-inbox-btn {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-top: 10px;
            width: 100%;
        }

        .profile-recommendations-inbox-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.4);
        }

        .recommendations-inbox-modal-body {
            margin-top: 20px;
        }

        /* Estilos para modal de buzón de correo */
        .mailbox-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            animation: fadeIn 0.3s ease;
        }

        .mailbox-modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 700px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        .mailbox-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .mailbox-modal-header h2 {
            margin: 0;
            color: #333;
            font-size: 1.8em;
        }

        .mailbox-modal-close {
            background: #f56565;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .mailbox-modal-close:hover {
            background: #e53e3e;
            transform: rotate(90deg);
        }

        .mailbox-messages-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .mailbox-message-item {
            display: flex;
            gap: 15px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 10px;
            border-left: 4px solid #4299e1;
            position: relative;
        }

        .mailbox-message-item.unread {
            border-left-color: #f56565;
            background: #fff5f5;
        }

        .mailbox-message-profile {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            overflow: visible;
            flex-shrink: 0;
            border: 2px solid #e2e8f0;
            background: #e2e8f0;
            position: relative;
        }

        .mailbox-message-profile img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .mailbox-message-profile .placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #e2e8f0;
            font-size: 1.5em;
        }

        .mailbox-message-content {
            flex: 1;
        }

        .mailbox-message-sender {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .mailbox-message-text {
            color: #4a5568;
            line-height: 1.6;
            margin-bottom: 10px;
            white-space: pre-wrap;
        }

        .mailbox-message-date {
            font-size: 0.85em;
            color: #718096;
        }

        .mailbox-message-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .mailbox-message-delete-btn {
            background: #f56565;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .mailbox-message-delete-btn:hover {
            background: #e53e3e;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(245, 101, 101, 0.4);
        }

        /* Estilos para modal de enviar mensaje */
        .send-mail-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            animation: fadeIn 0.3s ease;
        }

        .send-mail-modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        .send-mail-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .send-mail-modal-header h2 {
            margin: 0;
            color: #333;
            font-size: 1.8em;
        }

        .send-mail-modal-close {
            background: #f56565;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .send-mail-modal-close:hover {
            background: #e53e3e;
            transform: rotate(90deg);
        }

        .send-mail-search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .send-mail-search-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1em;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .send-mail-search-input:focus {
            border-color: #4299e1;
        }

        .send-mail-search-btn {
            padding: 12px 20px;
            background: #4299e1;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .send-mail-search-btn:hover {
            background: #3182ce;
            transform: translateY(-2px);
        }

        .send-mail-results {
            margin-bottom: 20px;
        }

        .send-mail-result-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        .send-mail-result-item:hover {
            background: #edf2f7;
            transform: translateX(5px);
        }

        .send-mail-compose {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e2e8f0;
        }

        .send-mail-recipient {
            margin-bottom: 15px;
            padding: 10px;
            background: #f7fafc;
            border-radius: 8px;
            font-weight: 600;
            color: #333;
        }

        .send-mail-textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1em;
            font-family: inherit;
            resize: vertical;
            min-height: 150px;
            outline: none;
            transition: border-color 0.3s ease;
            margin-bottom: 15px;
        }

        .send-mail-textarea:focus {
            border-color: #4299e1;
        }

        .send-mail-submit-btn {
            width: 100%;
            padding: 12px 24px;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .send-mail-submit-btn:hover {
            background: #38a169;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.4);
        }

        .inbox-request-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .inbox-request-actions {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }

        .accept-request-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .accept-request-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(72, 187, 120, 0.4);
        }

        .reject-request-btn {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .reject-request-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(245, 101, 101, 0.4);
        }

        .profile-logout-btn {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(245, 101, 101, 0.4);
            width: 100%;
            margin-top: 10px;
        }

        .profile-logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 101, 101, 0.6);
        }

        /* Estilos para información de usuario */
        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #f7fafc;
            border-radius: 10px;
        }

        .user-name {
            font-weight: 600;
            color: #667eea;
            font-size: 1.1em;
        }

        .logout-btn {
            background: #f56565;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .logout-btn:hover {
            transform: scale(1.05);
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }

            .title-container {
                flex-wrap: wrap;
                gap: 10px;
            }

            h1 {
                font-size: 1.8em;
                flex: 1 1 100%;
                text-align: center;
            }

            /* En móvil, el círculo de perfil va a la esquina superior derecha */
            .profile-picture-container {
                position: fixed !important;
                top: 15px !important;
                right: 15px !important;
                left: auto !important;
                z-index: 1000 !important;
                margin: 0 !important;
            }

            .profile-picture-circle {
                width: 50px;
                height: 50px;
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.5);
            }

            .profile-picture-placeholder {
                font-size: 1.5em;
            }

            .flag {
                font-size: 6em;
            }

            .auth-box {
                padding: 30px 20px;
            }

            /* Estilos responsive para modal de búsqueda de amigos */
            .friends-modal-content {
                padding: 20px 15px;
                width: 95%;
                max-height: 95vh;
            }

            .friends-modal-header {
                margin-bottom: 15px;
                padding-bottom: 10px;
            }

            .friends-modal-header h2 {
                font-size: 1.4em;
            }

            .friends-search-container {
                flex-direction: column;
                gap: 10px;
            }

            .friends-search-input {
                width: 100%;
                padding: 10px 12px;
                font-size: 0.95em;
            }

            .friends-search-btn {
                width: 100%;
                padding: 10px 20px;
            }

            .friend-result-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
                padding: 12px;
            }

            .friend-result-picture {
                width: 45px;
                height: 45px;
            }

            .friend-result-info {
                width: 100%;
            }

            .friend-result-name {
                font-size: 1em;
            }

            .friend-result-email {
                font-size: 0.85em;
            }

            .friend-result-actions {
                width: 100%;
                justify-content: flex-end;
            }

            .send-request-btn {
                padding: 8px 16px;
                font-size: 0.85em;
            }

            /* Estilos responsive para modal de bandeja */
            .inbox-modal-content {
                padding: 20px 15px;
                width: 95%;
                max-height: 95vh;
            }

            .inbox-modal-header {
                margin-bottom: 15px;
                padding-bottom: 10px;
            }

            .inbox-modal-header h2 {
                font-size: 1.4em;
            }

            .inbox-request-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
                padding: 12px;
            }

            .inbox-request-actions {
                width: 100%;
                justify-content: flex-end;
                margin-left: 0;
            }

            .accept-request-btn,
            .reject-request-btn {
                padding: 8px 16px;
                font-size: 0.85em;
            }

            /* Estilos responsive para modal de perfil de amigo */
            .friend-profile-modal-content {
                padding: 20px 15px;
                width: 95%;
                max-height: 95vh;
            }

            .friend-profile-modal-header {
                margin-bottom: 15px;
                padding-bottom: 10px;
            }

            .friend-profile-modal-header h2 {
                font-size: 1.4em;
            }

            .friend-profile-picture-large {
                width: 120px;
                height: 120px;
            }

            .friend-profile-picture-large-placeholder {
                font-size: 4em;
            }
        }

        /* Estilos para chat integrado en el perfil */
        .profile-active-chat {
            width: 100%;
            margin-top: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            display: none;
            flex-direction: column;
            max-height: 500px;
            transition: all 0.3s ease;
            position: relative;
            z-index: 10;
        }

        .profile-active-chat.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            max-height: 100vh;
            margin: 0;
            border-radius: 0;
            z-index: 9999;
            display: flex;
        }

        .profile-active-chat.minimized {
            max-height: 60px;
            overflow: hidden;
        }

        .profile-active-chat.minimized .active-chat-messages,
        .profile-active-chat.minimized .active-chat-input-container {
            display: none;
        }

        .profile-active-chat.minimized .active-chat-header {
            border-radius: 15px;
        }

        .active-chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px 15px 0 0;
            cursor: pointer;
            transition: border-radius 0.3s ease;
            flex-shrink: 0;
        }

        .profile-active-chat.fullscreen .active-chat-header {
            border-radius: 0;
        }

        .active-chat-header-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .active-chat-header-picture {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            overflow: visible;
            position: relative;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .active-chat-header-picture img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .active-chat-header-name {
            color: white;
            font-weight: 600;
            font-size: 1.1em;
        }

        .active-chat-header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .active-chat-call {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
            position: relative;
            overflow: visible;
        }

        .active-chat-call:hover {
            background: linear-gradient(135deg, #5cb85c 0%, #4CAF50 100%);
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.6);
        }

        .active-chat-call:active {
            transform: scale(0.95);
        }

        /* Estado de llamando */
        .active-chat-call.calling {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            animation: callingPulse 1.5s ease-in-out infinite;
            box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7);
        }

        .active-chat-call.calling:hover {
            background: linear-gradient(135deg, #ff8787 0%, #ff6b6b 100%);
        }

        @keyframes callingPulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(255, 107, 107, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 107, 107, 0);
            }
        }

        /* Efecto de ondas cuando está llamando */
        .active-chat-call.calling::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(255, 107, 107, 0.3);
            animation: callingRipple 1.5s ease-out infinite;
        }

        @keyframes callingRipple {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: scale(2);
                opacity: 0;
            }
        }

        .active-chat-close {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .active-chat-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .active-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 350px;
            min-height: 200px;
        }

        .profile-active-chat.fullscreen .active-chat-messages {
            max-height: calc(100vh - 300px);
            min-height: calc(100vh - 300px);
            overflow-y: auto;
        }

        .active-chat-message {
            display: flex;
            gap: 10px;
            max-width: 85%;
            animation: messageSlideIn 0.3s ease;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .active-chat-message.sent {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .active-chat-message.received {
            align-self: flex-start;
        }

        .active-chat-message-picture {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 1.2em;
            overflow: visible;
            position: relative;
        }
        
        .active-chat-message-picture img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .active-chat-message.sent .active-chat-message-picture {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .active-chat-message-content {
            background: #f7fafc;
            padding: 10px 15px;
            border-radius: 15px;
            position: relative;
            word-wrap: break-word;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .active-chat-message.sent .active-chat-message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .active-chat-message.received .active-chat-message-content {
            background: #e2e8f0;
            color: #333;
        }

        .active-chat-message-time {
            font-size: 0.75em;
            margin-top: 5px;
            opacity: 0.7;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .active-chat-message.sent .active-chat-message-time {
            color: rgba(255, 255, 255, 0.8);
        }

        .active-chat-message.received .active-chat-message-time {
            color: #718096;
        }

        .message-read-indicator {
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.9);
            margin-left: 4px;
            font-weight: bold;
        }

        .active-chat-message.sent .message-read-indicator.read {
            color: #a0f0a0;
        }

        /* Animación de escribiendo */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 8px 12px;
            background: #f7fafc;
            border-radius: 18px;
            margin: 5px 0;
            font-size: 0.85em;
            color: #718096;
            max-width: fit-content;
        }

        #typingIndicator {
            padding: 8px 15px;
            margin: 0 15px 10px 15px;
            background: #e6f0ff;
            border-radius: 10px;
            font-size: 0.9em;
            color: #667eea;
            font-style: italic;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
            margin-left: 4px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: #718096;
            border-radius: 50%;
            animation: typingDot 1.4s ease-in-out infinite;
        }

        .typing-dot:nth-child(1) {
            animation-delay: 0s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingDot {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.7;
            }
            30% {
                transform: translateY(-8px);
                opacity: 1;
            }
        }

        .active-chat-input-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 15px;
            border-top: 1px solid #e2e8f0;
            background: #f7fafc;
            border-radius: 0 0 15px 15px;
            flex-shrink: 0;
            overflow: visible;
            position: relative;
            z-index: 10;
        }

        .profile-active-chat.fullscreen .active-chat-input-container {
            border-radius: 0;
            position: sticky;
            bottom: 0;
            background: #f7fafc;
        }

        /* Asegurar que el wrapper con el botón de enviar siempre sea visible */
        .active-chat-input-wrapper {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
            width: 100%;
            flex-shrink: 0;
            order: 2;
            position: relative;
            z-index: 11;
        }
        
        /* Asegurar que el botón de enviar siempre sea visible */
        #activeChatSendBtn {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: relative;
            z-index: 12;
        }

        .active-chat-input-wrapper {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-shrink: 0;
        }

        .active-chat-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .active-chat-input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            font-size: 1em;
            outline: none;
            transition: border-color 0.3s ease;
            resize: none;
            min-height: 40px;
            max-height: 120px;
            font-family: inherit;
        }

        .active-chat-input:focus {
            border-color: #667eea;
        }

        .chat-image-input {
            display: none;
        }

        .active-chat-action-btn {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            border: 2px solid rgba(102, 126, 234, 0.3);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .active-chat-action-btn:hover {
            background: rgba(102, 126, 234, 0.2);
            border-color: #667eea;
            transform: scale(1.1);
        }

        .active-chat-send-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            flex-shrink: 0;
            min-width: 80px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .active-chat-send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .active-chat-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Selector de emojis */
        .emoji-picker {
            position: absolute;
            bottom: 80px;
            right: 15px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            width: 300px;
            max-height: 250px;
            overflow-y: auto;
            display: none;
        }

        .profile-active-chat.fullscreen .emoji-picker {
            bottom: 100px;
        }

        .emoji-picker.show {
            display: block;
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
        }

        .emoji-item {
            font-size: 1.5em;
            padding: 8px;
            cursor: pointer;
            border-radius: 8px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .emoji-item:hover {
            background: #f0f0f0;
            transform: scale(1.2);
        }

        /* Menú de selección de imagen */
        .image-menu-container {
            position: relative;
        }

        .image-menu {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 10px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 10001;
            min-width: 160px;
            overflow: hidden;
        }

        .image-menu-item {
            width: 100%;
            padding: 14px 18px;
            background: white;
            border: none;
            text-align: center;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-weight: 500;
        }

        .image-menu-item:hover {
            background: #f7fafc;
        }

        .image-menu-item:active {
            background: #e2e8f0;
        }

        .image-menu-item:first-child {
            border-bottom: 1px solid #e2e8f0;
        }

        /* Vista previa de imagen */
        .image-preview {
            position: relative;
            margin-bottom: 5px;
            border-radius: 10px;
            overflow: hidden;
            display: inline-block;
            max-width: 250px;
        }

        .image-preview img {
            width: 100%;
            max-width: 250px;
            max-height: 150px;
            object-fit: contain;
            border-radius: 10px;
            display: block;
        }

        .image-preview-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(245, 101, 101, 0.9);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .image-preview-remove:hover {
            background: #f56565;
            transform: scale(1.1);
        }

        /* Mensaje con imagen */
        .active-chat-message-image {
            max-width: 300px;
            max-height: 300px;
            border-radius: 10px;
            margin-top: 5px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .active-chat-message-image:hover {
            transform: scale(1.05);
        }

        @media (max-width: 768px) {
            /* Estilos responsive para chat */
            .profile-active-chat.fullscreen {
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
            }
            
            .profile-active-chat:not(.fullscreen) {
                max-height: 400px;
            }
            
            .emoji-picker {
                width: 250px;
                max-height: 200px;
            }
            
            .emoji-grid {
                grid-template-columns: repeat(6, 1fr);
            }
            
            .image-menu {
                left: 50%;
                transform: translateX(-50%);
                min-width: 140px;
                margin-bottom: 8px;
            }
            
            .image-menu-item {
                padding: 16px 20px;
                font-size: 1.05em;
            }

            .active-chat-header {
                padding: 12px;
            }

            .active-chat-header-name {
                font-size: 1em;
            }

            .active-chat-header-picture {
                width: 35px;
                height: 35px;
            }

            .active-chat-messages {
                padding: 12px;
                max-height: 250px;
                min-height: 150px;
            }

            .active-chat-message {
                max-width: 85%;
            }

            .active-chat-input-container {
                padding: 10px;
            }

            .active-chat-input {
                font-size: 0.9em;
                padding: 8px 12px;
            }

            .active-chat-send-btn {
                padding: 8px 16px;
                font-size: 0.9em;
            }

            .chat-item {
                padding: 10px;
            }

            .chat-item-picture {
                width: 40px;
                height: 40px;
            }

            .friend-item-message {
                width: 32px;
                height: 32px;
                font-size: 1em;
            }

            .friend-item-message-badge {
                min-width: 18px;
                height: 18px;
                font-size: 0.65em;
                top: -4px;
                right: -4px;
            }

            .friend-item-remove {
                width: 28px;
                height: 28px;
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <!-- Overlay de fuego para modo imposible -->
    <div class="hell-overlay" id="hellOverlay">
        <div class="flame"></div>
        <div class="flame"></div>
        <div class="flame"></div>
        <div class="flame"></div>
        <div class="flame"></div>
    </div>
    <div class="hell-particles" id="hellParticles"></div>
    
    <!-- Overlay de batalla para modo difícil -->
    <div class="war-overlay" id="warOverlay"></div>
    
    <!-- Overlay de naturaleza para modo fácil -->
    <div class="nature-overlay" id="natureOverlay">
        <div class="wave"></div>
        <div class="wave" style="animation-delay: 1s;"></div>
    </div>
    
    <!-- Overlay galáctico para modo Dios -->
    <div class="galactic-overlay" id="galacticOverlay"></div>
    <!-- Pantalla de Login/Registro -->
    <div class="auth-container" id="authContainer">
        <div class="auth-box">
            <h2>🏳️ Juego de Banderas</h2>
            <div class="auth-tabs">
                <button class="auth-tab active" id="loginTab">Iniciar Sesión</button>
                <button class="auth-tab" id="registerTab">Registrarse</button>
            </div>
            
            <div class="auth-form" id="loginForm">
                <input type="email" id="loginEmail" placeholder="Correo electrónico" class="auth-input">
                <input type="password" id="loginPassword" placeholder="Contraseña" class="auth-input">
                <button class="auth-btn" id="loginBtn">Iniciar Sesión</button>
                <div class="auth-message" id="loginMessage"></div>
            </div>
            
            <div class="auth-form" id="registerForm" style="display: none;">
                <input type="text" id="registerName" placeholder="Nombre de usuario" class="auth-input" maxlength="20">
                <input type="email" id="registerEmail" placeholder="Correo electrónico" class="auth-input">
                <input type="password" id="registerPassword" placeholder="Contraseña (mín. 6 caracteres)" class="auth-input">
                <button class="auth-btn" id="registerBtn">Registrarse</button>
                <div class="auth-message" id="registerMessage"></div>
            </div>
        </div>
    </div>

    <!-- Modal de perfil -->
    <div class="profile-modal" id="profileModal" style="display: none;">
        <div class="profile-modal-content">
            <div class="profile-modal-header">
                <h2>👤 Mi Perfil</h2>
                <button class="profile-modal-close" id="profileModalClose">✕</button>
            </div>
            <div class="profile-modal-body">
                <div class="profile-picture-large-container">
                    <div class="profile-picture-large" id="profilePictureLarge">
                        <img id="profilePictureLargeImg" src="" alt="Foto de perfil" style="display: none;">
                        <div class="profile-picture-large-placeholder" id="profilePictureLargePlaceholder">👤</div>
                    </div>
                    <label for="profilePictureInput" class="profile-upload-btn">
                        📷 Cambiar Foto
                    </label>
                    <input type="file" id="profilePictureInput" accept="image/*" style="display: none;">
                    <div class="profile-style-selector">
                        <button class="profile-style-selector-toggle" id="profileStyleSelectorToggle">
                            <span class="profile-style-selector-label">🎨 Estilo de Foto:</span>
                            <span class="profile-style-selector-arrow">▼</span>
                        </button>
                        <div class="profile-style-selector-content">
                        <div class="profile-style-options" id="profileStyleOptions">
                            <div class="profile-style-option" data-style="classic" title="Clásico">
                                <div style="width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: 3px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.2);"></div>
                            </div>
                            <div class="profile-style-option" data-style="gold" title="Dorado">
                                <div style="width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); border: 3px solid #ffd700; box-shadow: 0 0 15px rgba(255,215,0,0.6);"></div>
                            </div>
                            <div class="profile-style-option" data-style="gradient" title="Gradiente">
                                <div style="width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2, #f093fb); border: 3px solid transparent; box-shadow: 0 4px 15px rgba(102,126,234,0.5);"></div>
                            </div>
                            <div class="profile-style-option" data-style="neon" title="Neón">
                                <div style="width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #00ffff 0%, #0080ff 100%); border: 3px solid #00ffff; box-shadow: 0 0 20px rgba(0,255,255,0.8);"></div>
                            </div>
                            <div class="profile-style-option" data-style="vintage" title="Vintage">
                                <div style="width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #8b4513 0%, #a0522d 100%); border: 3px solid #8b4513; box-shadow: 0 4px 15px rgba(139,69,19,0.5);"></div>
                            </div>
                            <div class="profile-style-option" data-style="rainbow" title="Arcoíris">
                                <div style="width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(45deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3); border: 3px solid transparent;"></div>
                            </div>
                            <div class="profile-style-option" data-style="diamond" title="Diamante">
                                <div style="width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%); border: 3px solid #c0c0c0; box-shadow: 0 0 30px rgba(192,192,192,0.8);"></div>
                            </div>
                            <div class="profile-style-option" data-style="fire" title="Fuego">
                                <div style="width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #ff4500 0%, #ff8c00 100%); border: 3px solid #ff4500; box-shadow: 0 0 25px rgba(255,69,0,0.8);"></div>
                            </div>
                            <div class="profile-style-option" data-style="ice" title="Hielo">
                                <div style="width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #87ceeb 0%, #b0e0e6 100%); border: 3px solid #87ceeb; box-shadow: 0 0 25px rgba(135,206,235,0.8);"></div>
                            </div>
                            <div class="profile-style-option" data-style="heart" title="Corazón">
                                <div style="width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #ff69b4 0%, #ff1493 100%); border: 3px solid #ff69b4; box-shadow: 0 0 20px rgba(255,105,180,0.6);"></div>
                            </div>
                            <div class="profile-style-expand-btn" id="profileStyleExpandBtn" title="Ver más estilos">+</div>
                        </div>
                        <div class="profile-style-options-extra" id="profileStyleOptionsExtra">
                            <div class="profile-style-option" data-style="silver" title="Plata">
                                <div style="width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%); border: 3px solid #a8a8a8; box-shadow: 0 0 20px rgba(168,168,168,0.6);"></div>
                            </div>
                            <div class="profile-style-option" data-style="copper" title="Cobre">
                                <div style="width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #b87333 0%, #cd7f32 100%); border: 3px solid #b87333; box-shadow: 0 0 20px rgba(184,115,51,0.6);"></div>
                            </div>
                            <div class="profile-style-option" data-style="emerald" title="Esmeralda">
                                <div style="width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #50c878 0%, #00ff7f 100%); border: 3px solid #50c878; box-shadow: 0 0 25px rgba(80,200,120,0.7);"></div>
                            </div>
                            <div class="profile-style-option" data-style="sapphire" title="Zafiro">
                                <div style="width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #0f52ba 0%, #4169e1 100%); border: 3px solid #0f52ba; box-shadow: 0 0 25px rgba(15,82,186,0.7);"></div>
                            </div>
                            <div class="profile-style-option" data-style="ruby" title="Rubí">
                                <div style="width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #e0115f 0%, #ff0040 100%); border: 3px solid #e0115f; box-shadow: 0 0 25px rgba(224,17,95,0.7);"></div>
                            </div>
                            <div class="profile-style-option" data-style="amethyst" title="Amatista">
                                <div style="width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #9966cc 0%, #b19cd9 100%); border: 3px solid #9966cc; box-shadow: 0 0 25px rgba(153,102,204,0.7);"></div>
                            </div>
                            <div class="profile-style-option" data-style="sunset" title="Atardecer">
                                <div style="width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #ff6b6b, #ffa500, #ffd700); border: 3px solid transparent; box-shadow: 0 4px 15px rgba(255,107,107,0.5);"></div>
                            </div>
                            <div class="profile-style-option" data-style="ocean" title="Océano">
                                <div style="width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #006994, #00a8cc, #87ceeb); border: 3px solid transparent; box-shadow: 0 4px 15px rgba(0,105,148,0.5);"></div>
                            </div>
                            <div class="profile-style-option" data-style="forest" title="Bosque">
                                <div style="width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #2d5016, #4a7c2a, #6ba84f); border: 3px solid transparent; box-shadow: 0 4px 15px rgba(45,80,22,0.5);"></div>
                            </div>
                            <div class="profile-style-option" data-style="cosmic" title="Cósmico">
                                <div style="width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #1a0033, #4b0082, #8b00ff); border: 3px solid #8b00ff; box-shadow: 0 0 30px rgba(139,0,255,0.8);"></div>
                            </div>
                            <div class="profile-style-option" data-style="burning" title="🔥 Quemándose">
                                <div style="width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #ff4500, #ff8c00, #ffd700); border: 3px solid #ff4500; box-shadow: 0 0 20px rgba(255,69,0,0.8); animation: burningPreview 2s ease-in-out infinite;"></div>
                            </div>
                            <div class="profile-style-option" data-style="pulse" title="💓 Pulso">
                                <div style="width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); border: 3px solid #667eea; box-shadow: 0 0 15px rgba(102,126,234,0.6); animation: pulsePreview 2s ease-in-out infinite;"></div>
                            </div>
                            <div class="profile-style-option" data-style="rainbow-animated" title="🌈 Arcoíris Animado">
                                <div style="width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(45deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3); background-size: 300% 300%; border: 3px solid transparent; animation: rainbowPreview 3s linear infinite;"></div>
                            </div>
                            <div class="profile-style-option" data-style="shimmer" title="✨ Brillo">
                                <div style="width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #c0c0c0, #e8e8e8); border: 3px solid #c0c0c0; box-shadow: 0 0 20px rgba(192,192,192,0.8); position: relative; overflow: hidden;">
                                    <div style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.5) 50%, transparent 70%); animation: shimmerPreview 3s linear infinite;"></div>
                                </div>
                            </div>
                            <div class="profile-style-option" data-style="neon-pulse" title="💡 Neón Parpadeante">
                                <div style="width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #00ffff, #0080ff); border: 3px solid #00ffff; box-shadow: 0 0 20px rgba(0,255,255,0.8); animation: neonPreview 1.5s ease-in-out infinite;"></div>
                            </div>
                            <div class="profile-style-option" data-style="waves" title="🌊 Ondas">
                                <div style="width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #00a8cc, #87ceeb); border: 3px solid #00a8cc; box-shadow: 0 0 20px rgba(0,168,204,0.7);"></div>
                            </div>
                            <div class="profile-style-option" data-style="electric" title="⚡ Eléctrico">
                                <div style="width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #ffd700, #ffed4e); border: 3px solid #ffd700; box-shadow: 0 0 20px rgba(255,215,0,0.8); animation: electricPreview 0.1s linear infinite;"></div>
                            </div>
                            <div class="profile-style-option" data-style="magma" title="🌋 Magma">
                                <div style="width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #ff4500, #ff8c00, #ffd700); background-size: 200% 200%; border: 3px solid #ff4500; box-shadow: 0 0 20px rgba(255,69,0,0.8); animation: magmaPreview 3s ease infinite;"></div>
                            </div>
                            <div class="profile-style-option" data-style="rain" title="🌧️ Lluvia">
                                <div style="width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #87ceeb, #b0e0e6); border: 3px solid #87ceeb; box-shadow: 0 0 20px rgba(135,206,235,0.7); position: relative; overflow: visible;">
                                    <div style="position: absolute; top: -20px; left: 20%; width: 3px; height: 15px; background: rgba(135,206,235,0.6); border-radius: 2px; animation: dropPreview 1.5s linear infinite;"></div>
                                </div>
                            </div>
                            <div class="profile-style-option" data-style="splash" title="💦 Salpicadura">
                                <div style="width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #00a8cc, #87ceeb); border: 3px solid #00a8cc; box-shadow: 0 0 20px rgba(0,168,204,0.7); position: relative; overflow: visible;">
                                    <div style="position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); width: 20px; height: 10px; background: radial-gradient(ellipse, rgba(0,168,204,0.5) 0%, transparent 70%); border-radius: 50%; animation: splashPreview 2s ease-out infinite;"></div>
                                </div>
                            </div>
                            <div class="profile-style-option" data-style="drops" title="💧 Gotas">
                                <div style="width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #4a90e2, #87ceeb); border: 3px solid #4a90e2; box-shadow: 0 0 20px rgba(74,144,226,0.7); position: relative; overflow: visible;">
                                    <div style="position: absolute; top: -25px; left: 30%; font-size: 0.9em; animation: dropEmojiPreview 2s ease-in infinite;">💧</div>
                                </div>
                            </div>
                            <div class="profile-style-option" data-style="particles" title="✨ Partículas">
                                <div style="width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #ffd700, #ffed4e); border: 3px solid #ffd700; box-shadow: 0 0 20px rgba(255,215,0,0.7); position: relative; overflow: visible;">
                                    <div style="position: absolute; top: -15px; left: 25%; font-size: 0.7em; animation: particlePreview 3s ease-in-out infinite;">✨</div>
                                </div>
                            </div>
                            <div class="profile-style-option" data-style="snow" title="❄️ Nieve">
                                <div style="width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #e0f2fe, #ffffff); border: 3px solid #e0f2fe; box-shadow: 0 0 20px rgba(224,242,254,0.7); position: relative; overflow: visible;">
                                    <div style="position: absolute; top: -20px; left: 20%; font-size: 0.8em; animation: snowPreview 3s linear infinite;">❄️</div>
                                </div>
                            </div>
                            <div class="profile-style-option" data-style="sparkles" title="⭐ Destellos">
                                <div style="width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #fbbf24, #fcd34d); border: 3px solid #fbbf24; box-shadow: 0 0 20px rgba(251,191,36,0.7); position: relative; overflow: visible;">
                                    <div style="position: absolute; top: -15px; left: 30%; font-size: 0.6em; animation: sparklePreview 2.5s ease-in-out infinite;">⭐</div>
                                </div>
                            </div>
                            <div class="profile-style-option" data-style="bubbles" title="🫧 Burbujas">
                                <div style="width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #60a5fa, #93c5fd); border: 3px solid #60a5fa; box-shadow: 0 0 20px rgba(96,165,250,0.7); position: relative; overflow: visible;">
                                    <div style="position: absolute; bottom: -12px; left: 25%; width: 12px; height: 12px; border: 2px solid rgba(96,165,250,0.6); border-radius: 50%; background: radial-gradient(circle at 30% 30%, rgba(96,165,250,0.4) 0%, transparent 70%); animation: bubblePreview 3s ease-out infinite;"></div>
                                </div>
                            </div>
                            <div class="profile-style-option" data-style="confetti" title="🎉 Confeti">
                                <div style="width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #f472b6, #f9a8d4); border: 3px solid #f472b6; box-shadow: 0 0 20px rgba(244,114,182,0.7); position: relative; overflow: visible;">
                                    <div style="position: absolute; top: -20px; left: 30%; font-size: 0.7em; animation: confettiPreview 2s ease-in infinite;">🎉</div>
                                </div>
                            </div>
                        </div>
                        </div>
                    </div>
                    <div class="profile-decoration-selector">
                        <button class="profile-decoration-selector-toggle" id="profileDecorationSelectorToggle">
                            <span class="profile-decoration-selector-label">✨ Decoraciones:</span>
                            <span class="profile-decoration-selector-arrow">▼</span>
                        </button>
                        <div class="profile-decoration-selector-content">
                        <div class="profile-decoration-options" id="profileDecorationOptions">
                            <div class="profile-decoration-option" data-decoration="none" title="Sin decoración">🚫</div>
                            <div class="profile-decoration-option" data-decoration="cat-ears" title="Orejas de gato">🐱</div>
                            <div class="profile-decoration-option" data-decoration="dog-ears" title="Orejas de perro">🐶</div>
                            <div class="profile-decoration-option" data-decoration="rabbit-ears" title="Orejas de conejo">🐰</div>
                            <div class="profile-decoration-option" data-decoration="crown" title="Corona">👑</div>
                            <div class="profile-decoration-option" data-decoration="hat" title="Sombrero">🎩</div>
                            <div class="profile-decoration-option" data-decoration="glasses" title="Gafas">🕶️</div>
                            <div class="profile-decoration-option" data-decoration="mustache" title="Bigote">👨</div>
                            <div class="profile-decoration-option" data-decoration="hearts" title="Corazones">❤️</div>
                            <div class="profile-decoration-option" data-decoration="stars" title="Estrellas">⭐</div>
                            <div class="profile-decoration-option" data-decoration="alien" title="Alien">👽</div>
                            <div class="profile-decoration-expand-btn" id="profileDecorationExpandBtn" title="Ver más decoraciones">+</div>
                        </div>
                        <div class="profile-decoration-options-extra" id="profileDecorationOptionsExtra">
                            <div class="profile-decoration-option" data-decoration="unicorn" title="Unicornio">🦄</div>
                            <div class="profile-decoration-option" data-decoration="panda" title="Panda">🐼</div>
                            <div class="profile-decoration-option" data-decoration="bear" title="Oso">🐻</div>
                            <div class="profile-decoration-option" data-decoration="fox" title="Zorro">🦊</div>
                            <div class="profile-decoration-option" data-decoration="lion" title="León">🦁</div>
                            <div class="profile-decoration-option" data-decoration="tiger" title="Tigre">🐯</div>
                            <div class="profile-decoration-option" data-decoration="cowboy" title="Cowboy">🤠</div>
                            <div class="profile-decoration-option" data-decoration="party" title="Fiesta">🎉</div>
                            <div class="profile-decoration-option" data-decoration="rocket" title="Cohete">🚀</div>
                            <div class="profile-decoration-option" data-decoration="fire-emoji" title="Fuego">🔥</div>
                            <div class="profile-decoration-option" data-decoration="lightning" title="Rayo">⚡</div>
                            <div class="profile-decoration-option" data-decoration="rainbow-emoji" title="Arcoíris">🌈</div>
                            <div class="profile-decoration-option" data-decoration="sun" title="Sol">☀️</div>
                            <div class="profile-decoration-option" data-decoration="moon" title="Luna">🌙</div>
                            <div class="profile-decoration-option" data-decoration="flower" title="Flor">🌸</div>
                            <div class="profile-decoration-option" data-decoration="butterfly" title="Mariposa">🦋</div>
                        </div>
                        </div>
                    </div>
                </div>
                <div class="profile-info">
                    <div class="profile-info-item">
                        <span class="profile-info-label">Nombre:</span>
                        <span class="profile-info-value" id="profileName">-</span>
                    </div>
                    <div class="profile-info-item">
                        <span class="profile-info-label">Email:</span>
                        <span class="profile-info-value" id="profileEmail">-</span>
                    </div>
                    <div class="profile-info-item profile-description-item">
                        <span class="profile-info-label">Descripción:</span>
                        <textarea id="profileDescription" class="profile-description-input" placeholder="Escribe una descripción sobre ti..." maxlength="500"></textarea>
                        <button class="profile-save-description-btn" id="profileSaveDescriptionBtn">💾 Guardar Descripción</button>
                    </div>
                </div>
                <div class="profile-actions">
                    <button class="profile-save-btn" id="profileSaveBtn" style="display: none;">💾 Guardar Cambios</button>
                    <button class="profile-toggle-scores-btn" id="profileToggleScoresBtn">📊 Mostrar Puntuaciones</button>
                    <button class="profile-friends-btn" id="profileFriendsBtn">👥 Añadir Amigos</button>
                    <button class="profile-inbox-btn" id="profileInboxBtn">📬 Bandeja de Solicitudes</button>
                    <button class="profile-mailbox-btn" id="profileMailboxBtn">📮 Buzón de Correo</button>
                    <button class="profile-send-mail-btn" id="profileSendMailBtn" style="display: none;">✉️ Enviar Mensaje</button>
                    <button class="profile-recommendations-inbox-btn" id="profileRecommendationsInboxBtn" style="display: none;">📧 Correo de Recomendaciones</button>
                    <div class="profile-scores-section" id="profileScoresSection" style="display: none;">
                        <h3>Mis Puntuaciones Máximas</h3>
                        <div class="scores-list" id="scoresList"></div>
                    </div>
                    <div class="profile-friends-section" id="profileFriendsSection" style="display: none;">
                        <h3>👥 Mis Amigos</h3>
                        <div class="friends-list" id="friendsList"></div>
                    </div>
                    <div class="profile-chats-section" id="profileChatsSection" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h3 style="margin: 0;">Conversaciones</h3>
                            <button id="createGroupBtn" class="create-group-btn" style="display: none;" title="Crear grupo">👥 Grupo</button>
                        </div>
                        <div class="chats-list" id="chatsList"></div>
                    </div>
                    <div class="profile-active-chat" id="profileActiveChat" style="display: none;">
                        <div class="active-chat-header">
                            <div class="active-chat-header-info">
                                <div class="active-chat-header-picture" id="activeChatHeaderPicture">
                                    <div style="font-size: 1.2em;">👤</div>
                                </div>
                                <div class="active-chat-header-name" id="activeChatHeaderName">Amigo</div>
                            </div>
                            <div class="active-chat-header-actions">
                                <button class="active-chat-call" id="activeChatCall" title="Llamar">📞</button>
                                <button class="active-chat-close" id="activeChatClose" title="Cerrar chat">✕</button>
                            </div>
                        </div>
                        <div class="active-chat-messages" id="activeChatMessages"></div>
                        <div id="typingIndicator" class="typing-indicator" style="display: none;"></div>
                        <div class="active-chat-input-container">
                            <div class="emoji-picker" id="emojiPicker">
                                <div class="emoji-grid" id="emojiGrid"></div>
                            </div>
                            <div class="active-chat-input-wrapper">
                                <div class="active-chat-actions">
                                    <button class="active-chat-action-btn" id="emojiBtn" title="Emojis">😀</button>
                                </div>
                                <textarea id="activeChatInput" class="active-chat-input" placeholder="Escribe un mensaje..." maxlength="500" rows="1"></textarea>
                                <button class="active-chat-send-btn" id="activeChatSendBtn">Enviar</button>
                            </div>
                        </div>
                    </div>
                    <div class="profile-library-section" id="profileLibrarySection">
                        <h3>📚 BIBLIOTECA</h3>
                        <div class="library-upload-container">
                            <label for="libraryImageInput" class="library-upload-btn">📷 Añadir Foto</label>
                            <input type="file" id="libraryImageInput" accept="image/*" multiple style="display: none;">
                        </div>
                        <div class="library-grid" id="libraryGrid"></div>
                    </div>
                    <button class="profile-logout-btn" id="profileLogoutBtn">🚪 Cerrar Sesión</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para ver imagen de biblioteca en grande -->
    <div class="library-image-modal" id="libraryImageModal">
        <div class="library-image-modal-content">
            <button class="library-image-modal-close" id="libraryImageModalClose">✕</button>
            <div class="library-image-container" id="libraryImageContainer">
                <img id="libraryImageModalImg" src="" alt="Imagen">
            </div>
            <div class="library-image-interactions">
                <div class="library-image-likes">
                    <button class="like-btn" id="libraryImageLikeBtn">
                        <span class="like-icon">❤️</span>
                        <span class="like-count" id="libraryImageLikeCount">0</span>
                    </button>
                </div>
                <div class="library-image-comments">
                    <h4>Comentarios</h4>
                    <div class="comments-list" id="libraryImageCommentsList"></div>
                    <div class="comment-input-container">
                        <input type="text" id="libraryImageCommentInput" placeholder="Escribe un comentario..." class="comment-input">
                        <button class="comment-submit-btn" id="libraryImageCommentSubmit">Enviar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para vista ampliada de la imagen -->
    <div class="library-image-zoom-modal" id="libraryImageZoomModal">
        <button class="library-image-zoom-close-back" id="libraryImageZoomCloseBack" title="Volver a comentarios">←</button>
        <button class="library-image-zoom-close-all" id="libraryImageZoomCloseAll" title="Cerrar">✕</button>
        <div class="library-image-zoom-container">
            <img id="libraryImageZoomImg" src="" alt="Imagen ampliada">
        </div>
    </div>

    <!-- Modal para crear grupo - Seleccionar usuarios -->
    <div class="create-group-modal" id="createGroupModal" style="display: none;">
        <div class="create-group-modal-content">
            <div class="create-group-modal-header">
                <h2>Crear Grupo</h2>
                <button class="create-group-modal-close" id="createGroupModalClose">✕</button>
            </div>
            <div class="create-group-modal-body">
                <div class="create-group-search">
                    <input type="text" id="groupUserSearch" placeholder="Buscar usuarios..." class="create-group-search-input">
                </div>
                <div class="create-group-selected">
                    <h4>Usuarios seleccionados:</h4>
                    <div id="groupSelectedUsers" class="group-selected-users-list"></div>
                </div>
                <div class="create-group-results">
                    <div id="groupSearchResults" class="group-search-results"></div>
                </div>
                <div class="create-group-actions">
                    <button id="groupNextBtn" class="create-group-btn-primary" disabled>Siguiente</button>
                    <button id="groupCancelBtn" class="create-group-btn-secondary">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para crear grupo - Nombrar grupo -->
    <div class="create-group-name-modal" id="createGroupNameModal" style="display: none;">
        <div class="create-group-name-modal-content">
            <div class="create-group-name-modal-header">
                <h2>Nombrar Grupo</h2>
                <button class="create-group-name-modal-close" id="createGroupNameModalClose">✕</button>
            </div>
            <div class="create-group-name-modal-body">
                <label for="groupNameInput">Nombre del grupo:</label>
                <input type="text" id="groupNameInput" placeholder="Ej: Equipo de trabajo" maxlength="50" class="create-group-name-input">
                <div class="create-group-name-preview">
                    <h4>Miembros del grupo:</h4>
                    <div id="groupNamePreviewMembers" class="group-name-preview-members"></div>
                </div>
                <div class="create-group-name-actions">
                    <button id="groupCreateBtn" class="create-group-btn-primary" disabled>Crear Grupo</button>
                    <button id="groupNameBackBtn" class="create-group-btn-secondary">Atrás</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de información del grupo -->
    <div class="group-info-modal" id="groupInfoModal" style="display: none;">
        <div class="group-info-modal-content">
            <div class="group-info-modal-header">
                <h2>Información del Grupo</h2>
                <button class="group-info-modal-close" id="groupInfoModalClose">✕</button>
            </div>
            <div class="group-info-modal-body">
                <div class="group-info-picture-container">
                    <div class="group-info-picture" id="groupInfoPicture">
                        <div style="font-size: 3em;">👥</div>
                    </div>
                    <input type="file" id="groupPictureInput" accept="image/*" style="display: none;">
                    <button id="groupChangePictureBtn" class="group-change-picture-btn" style="display: none;">📷 Cambiar Foto</button>
                </div>
                <div class="group-info-name" id="groupInfoName"></div>
                <div class="group-info-members">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0;">Miembros del grupo</h3>
                        <button id="groupAddMembersBtn" class="group-add-members-btn" style="display: none;">➕ Añadir Usuarios</button>
                    </div>
                    <div id="groupInfoMembersList" class="group-info-members-list"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de información del creador -->
    <div class="creator-info-modal" id="creatorInfoModal">
        <div class="creator-info-content">
            <button class="creator-info-close" id="creatorInfoClose">✕</button>
            <div class="creator-info-header">
                <div class="creator-info-profile-picture" id="creatorInfoProfilePicture">
                    <div class="placeholder">👤</div>
                </div>
                <h3 id="creatorInfoName">👨‍💻 Martin</h3>
                <p id="creatorInfoRole">Creador de Banderas</p>
            </div>
            <div class="creator-info-body">
                <p id="creatorInfoDescription">Cargando información...</p>
            </div>
            <div class="creator-info-footer">
                <button class="recommendations-btn" id="recommendationsBtn">💡 Recomendaciones</button>
                <p>Gracias por jugar 🎮✨</p>
            </div>
        </div>
    </div>

    <!-- Modal de recomendaciones -->
    <div class="recommendations-modal" id="recommendationsModal" style="display: none;">
        <div class="recommendations-modal-content">
            <div class="recommendations-modal-header">
                <h2>💡 Enviar Recomendación</h2>
                <button class="recommendations-modal-close" id="recommendationsModalClose">✕</button>
            </div>
            <div class="recommendations-modal-body">
                <p style="margin-bottom: 15px; color: #4a5568;">Comparte tus ideas para mejorar el juego:</p>
                <textarea id="recommendationText" class="recommendation-textarea" placeholder="Escribe tu recomendación o mejora aquí..." rows="6"></textarea>
            </div>
            <div class="recommendations-modal-footer">
                <button class="recommendation-submit-btn" id="recommendationSubmitBtn">📧 Enviar a Creador</button>
            </div>
        </div>
    </div>

    <!-- Modal de recomendaciones recibidas (correo) -->
    <div class="recommendations-inbox-modal" id="recommendationsInboxModal" style="display: none;">
        <div class="recommendations-inbox-modal-content">
            <div class="recommendations-inbox-modal-header">
                <h2>📧 Recomendaciones Recibidas</h2>
                <button class="recommendations-inbox-modal-close" id="recommendationsInboxModalClose">✕</button>
            </div>
            <div class="recommendations-inbox-modal-body">
                <div class="recommendations-list" id="recommendationsList">
                    <div style="text-align: center; color: #718096; padding: 20px;">Cargando recomendaciones...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de buzón de correo -->
    <div class="mailbox-modal" id="mailboxModal" style="display: none;">
        <div class="mailbox-modal-content">
            <div class="mailbox-modal-header">
                <h2>📮 Buzón de Correo</h2>
                <button class="mailbox-modal-close" id="mailboxModalClose">✕</button>
            </div>
            <div class="mailbox-modal-body">
                <div class="mailbox-messages-list" id="mailboxMessagesList">
                    <div style="text-align: center; color: #718096; padding: 20px;">Cargando mensajes...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para enviar mensaje (solo para mpenalvart1) -->
    <div class="send-mail-modal" id="sendMailModal" style="display: none;">
        <div class="send-mail-modal-content">
            <div class="send-mail-modal-header">
                <h2>✉️ Enviar Mensaje</h2>
                <button class="send-mail-modal-close" id="sendMailModalClose">✕</button>
            </div>
            <div class="send-mail-modal-body">
                <div class="send-mail-search-container">
                    <input type="text" id="sendMailSearchInput" class="send-mail-search-input" placeholder="Buscar usuario por nombre o email...">
                    <button class="send-mail-search-btn" id="sendMailSearchBtn">🔍 Buscar</button>
                </div>
                <div class="send-mail-results" id="sendMailResults"></div>
                <div class="send-mail-compose" id="sendMailCompose" style="display: none;">
                    <div class="send-mail-recipient" id="sendMailRecipient"></div>
                    <textarea id="sendMailMessageText" class="send-mail-textarea" placeholder="Escribe tu mensaje aquí..." rows="6"></textarea>
                    <button class="send-mail-submit-btn" id="sendMailSubmitBtn">📤 Enviar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de búsqueda de amigos -->
    <div class="friends-modal" id="friendsModal" style="display: none;">
        <div class="friends-modal-content">
            <div class="friends-modal-header">
                <h2>👥 Buscar Amigos</h2>
                <button class="friends-modal-close" id="friendsModalClose">✕</button>
            </div>
            <div class="friends-modal-body">
                <div class="friends-search-container">
                    <input type="text" id="friendsSearchInput" class="friends-search-input" placeholder="Buscar por nombre...">
                    <button class="friends-search-btn" id="friendsSearchBtn">🔍 Buscar</button>
                </div>
                <div class="friends-results" id="friendsResults"></div>
            </div>
        </div>
    </div>

    <!-- Modal de solicitudes recibidas -->
    <div class="inbox-modal" id="inboxModal" style="display: none;">
        <div class="inbox-modal-content">
            <div class="inbox-modal-header">
                <h2>📬 Solicitudes de Amistad</h2>
                <button class="inbox-modal-close" id="inboxModalClose">✕</button>
            </div>
            <div class="inbox-modal-body">
                <div class="inbox-requests" id="inboxRequests"></div>
            </div>
        </div>
    </div>

    <!-- Modal de perfil de amigo -->
    <div class="friend-profile-modal" id="friendProfileModal" style="display: none;">
        <div class="friend-profile-modal-content">
            <div class="friend-profile-modal-header">
                <h2>👤 Perfil de Amigo</h2>
                <button class="friend-profile-modal-close" id="friendProfileModalClose">✕</button>
            </div>
            <div class="friend-profile-modal-body">
                <div class="friend-profile-picture-large-container">
                    <div class="friend-profile-picture-large" id="friendProfilePictureLarge">
                        <img id="friendProfilePictureLargeImg" src="" alt="Foto de perfil" style="display: none;">
                        <div class="friend-profile-picture-large-placeholder" id="friendProfilePictureLargePlaceholder">👤</div>
                    </div>
                </div>
                <div class="friend-profile-info">
                    <div class="friend-profile-info-item">
                        <span class="friend-profile-info-label">Nombre:</span>
                        <span class="friend-profile-info-value" id="friendProfileName">-</span>
                    </div>
                    <div class="friend-profile-info-item">
                        <span class="friend-profile-info-label">Email:</span>
                        <span class="friend-profile-info-value" id="friendProfileEmail">-</span>
                    </div>
                    <div class="friend-profile-info-item friend-description-item" id="friendDescriptionItem" style="display: none;">
                        <span class="friend-profile-info-label">Descripción:</span>
                        <div class="friend-profile-description" id="friendProfileDescription">-</div>
                    </div>
                </div>
                <div class="friend-profile-actions" id="friendProfileActions">
                    <button class="remove-friend-btn" id="removeFriendBtn">🗑️ Eliminar Amigo</button>
                </div>
                <div class="friend-library-section" id="friendLibrarySection" style="display: none;">
                    <h3>📚 BIBLIOTECA</h3>
                    <div class="friend-library-grid" id="friendLibraryGrid"></div>
                </div>
                <div class="friend-profile-scores-section" id="friendProfileScoresSection" style="display: none;">
                    <h3>Puntuaciones Máximas</h3>
                    <div class="friend-scores-list" id="friendScoresList"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="container" id="gameContainer" style="display: none;">
        <div class="user-info" style="display: none;">
            <div class="user-name" id="userNameDisplay">Usuario</div>
            <button class="logout-btn" id="logoutBtn" style="display: none;">Cerrar Sesión</button>
        </div>
        <div class="title-container">
        <h1>🏳️ Adivina la Bandera</h1>
            <div class="profile-picture-container" id="profilePictureContainer" style="display: none;">
                <div class="profile-picture-circle" id="profilePictureCircle">
                    <img id="profilePictureImg" src="" alt="Foto de perfil" style="display: none;">
                    <div class="profile-picture-placeholder" id="profilePicturePlaceholder">👤</div>
                </div>
            </div>
        </div>
        <div class="lives-container">
            <div class="lives-text">Vidas:</div>
            <div class="hearts" id="hearts">❤️ ❤️ ❤️</div>
        </div>
        <div class="score">Puntuación: <span id="score">0</span></div>
        <div class="streak-container">
            <div class="streak-fire" id="streakFire">🔥</div>
            <div class="streak-text">Racha: <span id="streak">0</span></div>
            <button class="joker-btn-inline" id="jokerBtn" style="display: none;">🎯 Comodín</button>
        </div>
        
        <div class="flag-container">
            <div class="flag" id="flag">🏳️</div>
        </div>

        <!-- Contador de tiempo -->
        <div class="timer-container" id="timerContainer" style="display: none;">
            <div class="timer-circle">
                <svg class="timer-svg" viewBox="0 0 100 100">
                    <circle class="timer-circle-bg" cx="50" cy="50" r="45"></circle>
                    <circle class="timer-circle-progress" cx="50" cy="50" r="45" id="timerProgress"></circle>
                </svg>
                <div class="timer-text" id="timerText">20</div>
            </div>
        </div>

        <!-- Botón para ver ranking -->
        <button class="view-ranking-btn" id="viewRankingBtn" style="display: none;">📊 Ver Tabla de Ranking</button>

        <!-- Ranking principal -->
        <div class="main-ranking-container" id="mainRankingContainer" style="display: none;">
            <div class="ranking-header">
                <h2 id="rankingTitle">🏆 Top 10 Ranking</h2>
                <button class="close-ranking-btn" id="closeRankingBtn">✕</button>
            </div>
            <div class="main-ranking-list" id="mainRankingList">
                <div style="text-align: center; padding: 20px; color: #718096;">Cargando ranking...</div>
            </div>
        </div>

        <div class="difficulty-selector" id="difficultySelector">
            <h2>Selecciona el nivel de dificultad</h2>
            <div class="difficulty-buttons">
                <button class="difficulty-btn easy" id="easyBtn">🟢 Fácil<br><small>Países de Europa</small></button>
                <button class="difficulty-btn hard" id="hardBtn">🔴 Difícil<br><small>Todos los países</small></button>
                <button class="difficulty-btn impossible" id="impossibleBtn">⚫ Imposible<br><small>Islas y paraísos fiscales</small></button>
                <button class="difficulty-btn god" id="godBtn">✨ Dios<br><small>Todas las banderas del mundo </small></button>
            </div>
            <div class="ranking-buttons-container">
                <h3 style="margin: 30px 0 15px 0; color: #667eea; font-size: 1.3em;">📊 Ver Clasificaciones</h3>
                <div class="ranking-buttons">
                    <button class="ranking-btn ranking-btn-easy" id="viewRankingEasyBtn">🏆 Clasificación Fácil</button>
                    <button class="ranking-btn ranking-btn-hard" id="viewRankingHardBtn">🏆 Clasificación Difícil</button>
                    <button class="ranking-btn ranking-btn-impossible" id="viewRankingImpossibleBtn">🏆 Clasificación Imposible</button>
                    <button class="ranking-btn ranking-btn-god" id="viewRankingGodBtn">🏆 Clasificación Dios</button>
                </div>
            </div>
            <div class="ranking-buttons-container">
                <div class="difficulty-ranking-container" id="difficultyRankingContainer" style="display: none;">
                    <h3 id="difficultyRankingTitle" style="margin: 30px 0 15px 0; color: #667eea; font-size: 1.5em; text-align: center;"></h3>
                    <div class="difficulty-ranking-list" id="difficultyRankingList"></div>
                </div>
            </div>
            <button class="creator-info-btn" id="creatorInfoBtn" title="Información del creador">ℹ️ Información del Creador</button>
        </div>

        <div class="loading" id="loading" style="display: none;">Cargando...</div>

        <div class="options" id="options" style="display: none;">
            <button class="option" id="option1"></button>
            <button class="option" id="option2"></button>
            <button class="option" id="option3"></button>
            <button class="option" id="option4"></button>
        </div>

        <!-- Botón para terminar intento -->
        <button class="end-attempt-btn" id="endAttemptBtn" style="display: none;">⛔ Terminar Intento</button>


        <div class="message" id="message"></div>
        <button class="next-btn" id="nextBtn">Siguiente Bandera</button>

        <!-- Pantalla de Game Over -->
        <div class="game-over" id="gameOver" style="display: none;">
            <div class="game-over-content">
                <h2>💀 Has Perdido</h2>
                <div class="game-over-stats">
                    <div class="stat-item">
                        <div class="stat-label">Puntuación Total</div>
                        <div class="stat-value" id="finalScore">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Máxima Racha</div>
                        <div class="stat-value" id="maxStreak">0</div>
                    </div>
                </div>
                <div class="name-input-container" id="nameInputContainer" style="display: none;">
                    <button class="save-score-btn" id="saveScoreBtn">💾 Guardar Puntuación</button>
                </div>
                <div class="ranking-container" id="rankingContainer" style="display: none;">
                    <h3>🏆 Top 10</h3>
                    <div class="ranking-list" id="rankingList"></div>
                </div>
                <button class="restart-btn" id="restartBtn">🔄 Jugar de Nuevo</button>
                <button class="show-ranking-btn" id="showRankingBtn" style="display: none;">📊 Ver Ranking</button>
            </div>
        </div>
    </div>

    <script>
        let countries = [];
        let allCountries = [];
        let currentCountry = null;
        let score = 0;
        let streak = 0;
        let maxStreak = 0;
        let lives = 3;
        let answered = false;
        let jokerAvailable = false;
        let jokerUsed = false;
        let difficulty = null; // 'easy', 'hard', 'impossible' o 'god'
        let timerInterval = null;
        let timeLeft = 20;
        let usedCountries = []; // Para el modo Dios: países ya mostrados
        let availableCountries = []; // Para el modo Dios: países disponibles

        // Lista de países como respaldo (si la API falla)
        const fallbackCountries = [
            { name: { common: "España" }, cca2: "ES", capital: ["Madrid"] },
            { name: { common: "Francia" }, cca2: "FR", capital: ["Paris"] },
            { name: { common: "Alemania" }, cca2: "DE", capital: ["Berlin"] },
            { name: { common: "Italia" }, cca2: "IT", capital: ["Rome"] },
            { name: { common: "Reino Unido" }, cca2: "GB", capital: ["London"] },
            { name: { common: "Estados Unidos" }, cca2: "US", capital: ["Washington, D.C."] },
            { name: { common: "México" }, cca2: "MX", capital: ["Mexico City"] },
            { name: { common: "Argentina" }, cca2: "AR", capital: ["Buenos Aires"] },
            { name: { common: "Brasil" }, cca2: "BR", capital: ["Brasília"] },
            { name: { common: "Chile" }, cca2: "CL", capital: ["Santiago"] },
            { name: { common: "Colombia" }, cca2: "CO", capital: ["Bogotá"] },
            { name: { common: "Perú" }, cca2: "PE", capital: ["Lima"] },
            { name: { common: "Venezuela" }, cca2: "VE", capital: ["Caracas"] },
            { name: { common: "Ecuador" }, cca2: "EC", capital: ["Quito"] },
            { name: { common: "Uruguay" }, cca2: "UY", capital: ["Montevideo"] },
            { name: { common: "Paraguay" }, cca2: "PY", capital: ["Asunción"] },
            { name: { common: "Bolivia" }, cca2: "BO", capital: ["Sucre"] },
            { name: { common: "Cuba" }, cca2: "CU", capital: ["Havana"] },
            { name: { common: "República Dominicana" }, cca2: "DO", capital: ["Santo Domingo"] },
            { name: { common: "Panamá" }, cca2: "PA", capital: ["Panama City"] },
            { name: { common: "Costa Rica" }, cca2: "CR", capital: ["San José"] },
            { name: { common: "Guatemala" }, cca2: "GT", capital: ["Guatemala City"] },
            { name: { common: "Honduras" }, cca2: "HN", capital: ["Tegucigalpa"] },
            { name: { common: "El Salvador" }, cca2: "SV", capital: ["San Salvador"] },
            { name: { common: "Nicaragua" }, cca2: "NI", capital: ["Managua"] },
            { name: { common: "Japón" }, cca2: "JP", capital: ["Tokyo"] },
            { name: { common: "China" }, cca2: "CN", capital: ["Beijing"] },
            { name: { common: "India" }, cca2: "IN", capital: ["New Delhi"] },
            { name: { common: "Rusia" }, cca2: "RU", capital: ["Moscow"] },
            { name: { common: "Canadá" }, cca2: "CA", capital: ["Ottawa"] },
            { name: { common: "Australia" }, cca2: "AU", capital: ["Canberra"] },
            { name: { common: "Nueva Zelanda" }, cca2: "NZ", capital: ["Wellington"] },
            { name: { common: "Sudáfrica" }, cca2: "ZA", capital: ["Cape Town"] },
            { name: { common: "Egipto" }, cca2: "EG", capital: ["Cairo"] },
            { name: { common: "Marruecos" }, cca2: "MA", capital: ["Rabat"] },
            { name: { common: "Turquía" }, cca2: "TR", capital: ["Ankara"] },
            { name: { common: "Grecia" }, cca2: "GR", capital: ["Athens"] },
            { name: { common: "Portugal" }, cca2: "PT", capital: ["Lisbon"] },
            { name: { common: "Países Bajos" }, cca2: "NL", capital: ["Amsterdam"] },
            { name: { common: "Bélgica" }, cca2: "BE", capital: ["Brussels"] },
            { name: { common: "Suiza" }, cca2: "CH", capital: ["Bern"] },
            { name: { common: "Austria" }, cca2: "AT", capital: ["Vienna"] },
            { name: { common: "Suecia" }, cca2: "SE", capital: ["Stockholm"] },
            { name: { common: "Noruega" }, cca2: "NO", capital: ["Oslo"] },
            { name: { common: "Dinamarca" }, cca2: "DK", capital: ["Copenhagen"] },
            { name: { common: "Finlandia" }, cca2: "FI", capital: ["Helsinki"] },
            { name: { common: "Polonia" }, cca2: "PL", capital: ["Warsaw"] },
            { name: { common: "República Checa" }, cca2: "CZ", capital: ["Prague"] },
            { name: { common: "Hungría" }, cca2: "HU", capital: ["Budapest"] },
            { name: { common: "Rumania" }, cca2: "RO", capital: ["Bucharest"] },
            { name: { common: "Bulgaria" }, cca2: "BG", capital: ["Sofia"] },
            { name: { common: "Croacia" }, cca2: "HR", capital: ["Zagreb"] },
            { name: { common: "Serbia" }, cca2: "RS", capital: ["Belgrade"] },
            { name: { common: "Ucrania" }, cca2: "UA", capital: ["Kyiv"] },
            { name: { common: "Israel" }, cca2: "IL", capital: ["Jerusalem"] },
            { name: { common: "Arabia Saudí" }, cca2: "SA", capital: ["Riyadh"] },
            { name: { common: "Irán" }, cca2: "IR", capital: ["Tehran"] },
            { name: { common: "Irak" }, cca2: "IQ", capital: ["Baghdad"] },
            { name: { common: "Pakistán" }, cca2: "PK", capital: ["Islamabad"] },
            { name: { common: "Bangladesh" }, cca2: "BD", capital: ["Dhaka"] },
            { name: { common: "Tailandia" }, cca2: "TH", capital: ["Bangkok"] },
            { name: { common: "Vietnam" }, cca2: "VN", capital: ["Hanoi"] },
            { name: { common: "Corea del Sur" }, cca2: "KR", capital: ["Seoul"] },
            { name: { common: "Corea del Norte" }, cca2: "KP", capital: ["Pyongyang"] },
            { name: { common: "Filipinas" }, cca2: "PH", capital: ["Manila"] },
            { name: { common: "Indonesia" }, cca2: "ID", capital: ["Jakarta"] },
            { name: { common: "Malasia" }, cca2: "MY", capital: ["Kuala Lumpur"] },
            { name: { common: "Singapur" }, cca2: "SG", capital: ["Singapore"] }
        ];

        // Aplicar filtro según dificultad
        function applyDifficultyFilter() {
            if (difficulty === 'easy') {
                // Fácil: Solo países de Europa
                countries = allCountries.filter(country => {
                    const region = country.region || '';
                    const subregion = country.subregion || '';
                    // Filtrar por región Europa o subregión de Europa
                    return region === 'Europe' || 
                           subregion === 'Northern Europe' ||
                           subregion === 'Southern Europe' ||
                           subregion === 'Eastern Europe' ||
                           subregion === 'Western Europe' ||
                           // También incluir algunos países conocidos por código
                           ['ES', 'FR', 'DE', 'IT', 'GB', 'PT', 'NL', 'BE', 'CH', 'AT',
                            'SE', 'NO', 'DK', 'FI', 'PL', 'CZ', 'HU', 'RO', 'BG', 'HR',
                            'RS', 'UA', 'GR', 'IE', 'IS', 'LU', 'SK', 'SI', 'EE', 'LV',
                            'LT', 'MT', 'CY'].includes(country.cca2);
                });
                
                // Si no hay suficientes países europeos, usar los de la lista de respaldo que sean europeos
                if (countries.length < 10) {
                    const europeanFallback = fallbackCountries.filter(c => 
                        ['ES', 'FR', 'DE', 'IT', 'GB', 'PT', 'NL', 'BE', 'CH', 'AT',
                         'SE', 'NO', 'DK', 'FI', 'PL', 'CZ', 'HU', 'RO', 'BG', 'HR',
                         'RS', 'UA', 'GR'].includes(c.cca2)
                    );
                    countries = europeanFallback.length > 0 ? europeanFallback : countries;
                }
            } else if (difficulty === 'hard') {
                // Difícil: Todos los países (excluyendo los más conocidos de Europa para hacerlo más difícil)
                const wellKnownEuropean = ['ES', 'FR', 'DE', 'IT', 'GB', 'PT', 'NL', 'BE', 'CH', 'AT',
                                         'SE', 'NO', 'DK', 'FI', 'PL', 'GR', 'IE', 'IS', 'US', 'CA',
                                         'MX', 'BR', 'AR', 'CL', 'CO', 'PE', 'JP', 'CN', 'IN', 'RU',
                                         'AU', 'NZ', 'ZA'];
                countries = allCountries.filter(country => 
                    !wellKnownEuropean.includes(country.cca2)
                );
                
                // Si no hay suficientes, usar todos
                if (countries.length < 20) {
                    countries = allCountries;
                }
            } else if (difficulty === 'impossible') {
                // Imposible: Islas pequeñas y paraísos fiscales
                const smallIslandsAndTaxHavens = [
                    // Islas del Caribe
                    'AG', 'BS', 'BB', 'VG', 'KY', 'DM', 'GD', 'JM', 'KN', 'LC', 'VC', 'TT', 'TC',
                    // Islas del Pacífico
                    'CK', 'FJ', 'KI', 'MH', 'FM', 'NR', 'NU', 'PW', 'PG', 'WS', 'SB', 'TO', 'TV', 'VU',
                    // Islas del Océano Índico
                    'MV', 'MU', 'SC', 'KM',
                    // Otras islas pequeñas
                    'AD', 'AW', 'BH', 'BN', 'CV', 'CY', 'FO', 'GG', 'GI', 'GL', 'GP', 'GU', 'IM', 'JE',
                    'LI', 'MC', 'MQ', 'MT', 'MP', 'NC', 'PF', 'PM', 'PN', 'PR', 'RE', 'SH', 'SJ',
                    'SM', 'ST', 'SX', 'TF', 'TK', 'TL', 'VA', 'VI', 'WF', 'YT',
                    // Paraísos fiscales y microestados
                    'AI', 'AS', 'AX', 'BL', 'BM', 'BQ', 'BV', 'CC', 'CD', 'CW', 'CX', 'EH', 'FK',
                    'GF', 'GS', 'HK', 'HM', 'IO', 'MF', 'MO', 'MS', 'NF', 'PS', 'PW', 'QA', 'SG',
                    'SX', 'UM', 'VG', 'VI', 'XK'
                ];
                
                countries = allCountries.filter(country => {
                    const code = country.cca2 || '';
                    const region = country.region || '';
                    const subregion = country.subregion || '';
                    const population = country.population || 0;
                    
                    // Filtrar por código de islas pequeñas y paraísos fiscales
                    if (smallIslandsAndTaxHavens.includes(code)) {
                        return true;
                    }
                    
                    // INCLUIR TODOS LOS PAÍSES DE OCEANÍA
                    if (region === 'Oceania') {
                        return true;
                    }
                    
                    // INCLUIR PAÍSES PEQUEÑOS DE ÁFRICA (población menor a 10 millones)
                    if (region === 'Africa' && population > 0 && population < 10000000) {
                        return true;
                    }
                    
                    // Filtrar islas con población pequeña (menos de 1 millón)
                    if (population > 0 && population < 1000000) {
                        // Verificar si es una isla (no tiene fronteras terrestres o es pequeña)
                        const borders = country.borders || [];
                        if (borders.length === 0 || subregion.includes('Island') || subregion.includes('Caribbean')) {
                            return true;
                        }
                    }
                    
                    // Incluir microestados y territorios insulares
                    if (subregion === 'Caribbean' || subregion === 'Polynesia' || 
                        subregion === 'Micronesia' || subregion === 'Melanesia') {
                        return true;
                    }
                    
                    // INCLUIR PAÍSES PEQUEÑOS DE ASIA (población menor a 5 millones)
                    if (region === 'Asia' && population > 0 && population < 5000000) {
                        return true;
                    }
                    
                    // INCLUIR PAÍSES PEQUEÑOS DE AMÉRICA (población menor a 2 millones, excluyendo grandes países)
                    if ((region === 'Americas' || region === 'North America' || region === 'South America') && 
                        population > 0 && population < 2000000) {
                        // Excluir países grandes conocidos
                        const excludedCodes = ['US', 'CA', 'MX', 'BR', 'AR', 'CL', 'CO', 'PE', 'VE'];
                        if (!excludedCodes.includes(code)) {
                            return true;
                        }
                    }
                    
                    return false;
                });
                
                // Si no hay suficientes, agregar algunos de la lista de respaldo
                if (countries.length < 10) {
                    const impossibleFallback = [
                        // Microestados y países ultra-pequeños
                        { name: { common: "Nauru" }, cca2: "NR" },
                        { name: { common: "Tuvalu" }, cca2: "TV" },
                        { name: { common: "Kiribati" }, cca2: "KI" },
                        { name: { common: "Santo Tomé y Príncipe" }, cca2: "ST" },
                        { name: { common: "Comoras" }, cca2: "KM" },
                        { name: { common: "Yibuti" }, cca2: "DJ" },
                        { name: { common: "Timor Oriental" }, cca2: "TL" },
                        { name: { common: "Eritrea" }, cca2: "ER" },
                        // Islas y Oceanía
                        { name: { common: "Maldivas" }, cca2: "MV" },
                        { name: { common: "Mauricio" }, cca2: "MU" },
                        { name: { common: "Seychelles" }, cca2: "SC" },
                        { name: { common: "Bahamas" }, cca2: "BS" },
                        { name: { common: "Barbados" }, cca2: "BB" },
                        { name: { common: "Jamaica" }, cca2: "JM" },
                        { name: { common: "Trinidad y Tobago" }, cca2: "TT" },
                        { name: { common: "Fiyi" }, cca2: "FJ" },
                        { name: { common: "Papúa Nueva Guinea" }, cca2: "PG" },
                        { name: { common: "Samoa" }, cca2: "WS" },
                        { name: { common: "Tonga" }, cca2: "TO" },
                        { name: { common: "Vanuatu" }, cca2: "VU" },
                        { name: { common: "Cabo Verde" }, cca2: "CV" },
                        { name: { common: "Malta" }, cca2: "MT" },
                        { name: { common: "Chipre" }, cca2: "CY" },
                        { name: { common: "Islandia" }, cca2: "IS" },
                        { name: { common: "Antigua y Barbuda" }, cca2: "AG" },
                        { name: { common: "Granada" }, cca2: "GD" },
                        { name: { common: "San Vicente y las Granadinas" }, cca2: "VC" },
                        { name: { common: "Santa Lucía" }, cca2: "LC" },
                        { name: { common: "San Cristóbal y Nieves" }, cca2: "KN" },
                        { name: { common: "Dominica" }, cca2: "DM" },
                        // Islas remotas y territorios dependientes
                        { name: { common: "Tokelau" }, cca2: "TK" },
                        { name: { common: "Niue" }, cca2: "NU" },
                        { name: { common: "Islas Cocos" }, cca2: "CC" },
                        { name: { common: "Isla Norfolk" }, cca2: "NF" },
                        { name: { common: "Islas Pitcairn" }, cca2: "PN" },
                        { name: { common: "Islas Åland" }, cca2: "AX" },
                        { name: { common: "San Bartolomé" }, cca2: "BL" },
                        { name: { common: "Wallis y Futuna" }, cca2: "WF" },
                        { name: { common: "Mayotte" }, cca2: "YT" },
                        { name: { common: "Nueva Caledonia" }, cca2: "NC" },
                        // Territorios no reconocidos / parcialmente reconocidos
                        { name: { common: "Kosovo" }, cca2: "XK" },
                        // Regiones con bandera propia
                        { name: { common: "Isla de Man" }, cca2: "IM" },
                        { name: { common: "Guernsey" }, cca2: "GG" },
                        { name: { common: "Jersey" }, cca2: "JE" },
                        { name: { common: "Gibraltar" }, cca2: "GI" },
                        // Islas y territorios británicos
                        { name: { common: "Montserrat" }, cca2: "MS" },
                        { name: { common: "Anguila" }, cca2: "AI" },
                        { name: { common: "Islas Vírgenes Británicas" }, cca2: "VG" },
                        { name: { common: "Santa Helena" }, cca2: "SH" },
                        { name: { common: "Islas Turcas y Caicos" }, cca2: "TC" },
                        // Paraísos fiscales
                        { name: { common: "Islas Caimán" }, cca2: "KY" },
                        { name: { common: "Islas Cook" }, cca2: "CK" },
                        // Países pequeños de África
                        { name: { common: "Guinea-Bisáu" }, cca2: "GW" },
                        { name: { common: "Guinea Ecuatorial" }, cca2: "GQ" },
                        { name: { common: "Gambia" }, cca2: "GM" },
                        { name: { common: "Lesoto" }, cca2: "LS" },
                        { name: { common: "Suazilandia" }, cca2: "SZ" },
                        { name: { common: "Gabón" }, cca2: "GA" },
                        { name: { common: "Guinea" }, cca2: "GN" },
                        { name: { common: "Sierra Leona" }, cca2: "SL" },
                        { name: { common: "Togo" }, cca2: "TG" },
                        { name: { common: "Benín" }, cca2: "BJ" },
                        { name: { common: "Burkina Faso" }, cca2: "BF" },
                        { name: { common: "Malí" }, cca2: "ML" },
                        { name: { common: "Níger" }, cca2: "NE" },
                        { name: { common: "Chad" }, cca2: "TD" },
                        { name: { common: "República Centroafricana" }, cca2: "CF" },
                        { name: { common: "Burundi" }, cca2: "BI" },
                        { name: { common: "Ruanda" }, cca2: "RW" },
                        // Países de Oceanía adicionales
                        { name: { common: "Polinesia Francesa" }, cca2: "PF" },
                        { name: { common: "Guam" }, cca2: "GU" },
                        { name: { common: "Islas Marianas del Norte" }, cca2: "MP" },
                        { name: { common: "Palau" }, cca2: "PW" },
                        { name: { common: "Micronesia" }, cca2: "FM" },
                        { name: { common: "Islas Marshall" }, cca2: "MH" },
                        { name: { common: "Islas Salomón" }, cca2: "SB" },
                        { name: { common: "Nueva Zelanda" }, cca2: "NZ" }
                    ];
                    countries = impossibleFallback.length > 0 ? impossibleFallback : countries;
                }
            } else if (difficulty === 'god') {
                // Dios: TODOS los países sin filtros (examen completo de todas las banderas)
                countries = [...allCountries]; // Usar todos los países disponibles
                
                // Inicializar arrays para tracking de países usados
                availableCountries = [...allCountries];
                usedCountries = [];
                
                console.log(`Modo Dios: ${countries.length} países cargados (examen completo sin repeticiones)`);
                return; // Salir temprano, no aplicar más filtros
            } else if (difficulty === 'god_old') {
                // Código anterior (tribus) - desactivado
                const tribalCountries = [
                    // Países con poblaciones indígenas significativas
                    'BO', 'PE', 'EC', 'GT', 'MX', 'PY', 'BR', 'CL', 'AR', 'CO', 'VE', 'PA', 'CR', 'HN', 'NI', 'SV',
                    // Países de África con tribus
                    'KE', 'TZ', 'UG', 'RW', 'ET', 'SD', 'SS', 'CM', 'CF', 'TD', 'NE', 'ML', 'BF', 'SN', 'GN', 'SL',
                    'LR', 'CI', 'GH', 'TG', 'BJ', 'NG', 'GA', 'CG', 'CD', 'AO', 'ZM', 'ZW', 'BW', 'NA', 'MW', 'MZ',
                    'MG', 'SO', 'DJ', 'ER', 'LY', 'TN', 'DZ', 'MA', 'MR', 'ML',
                    // Países de Asia con tribus
                    'MM', 'TH', 'LA', 'KH', 'VN', 'PH', 'ID', 'MY', 'BN', 'TL', 'PG', 'FJ', 'SB', 'VU', 'NC', 'PF',
                    // Países de Oceanía con tribus
                    'AU', 'NZ', 'PG', 'FJ', 'SB', 'VU', 'NC', 'PF', 'WS', 'TO', 'TV', 'KI', 'NR', 'PW', 'FM', 'MH',
                    // Países de América del Norte con tribus
                    'US', 'CA', 'MX', 'GT', 'BZ', 'SV', 'HN', 'NI', 'CR', 'PA',
                    // Territorios y regiones con tribus
                    'GF', 'GP', 'MQ', 'RE', 'YT', 'PF', 'NC', 'AS', 'GU', 'MP', 'VI', 'PR'
                ];
                
                countries = allCountries.filter(country => {
                    const code = country.cca2 || '';
                    const region = country.region || '';
                    const subregion = country.subregion || '';
                    
                    // Filtrar por código de países con tribus
                    if (tribalCountries.includes(code)) {
                        return true;
                    }
                    
                    // Incluir países de América Latina (muchos tienen poblaciones indígenas)
                    if (region === 'Americas' && (subregion === 'South America' || subregion === 'Central America')) {
                        return true;
                    }
                    
                    // Incluir países de África subsahariana (muchos tienen tribus)
                    if (region === 'Africa' && subregion !== 'Northern Africa') {
                        return true;
                    }
                    
                    // Incluir países de Oceanía (muchos tienen pueblos indígenas)
                    if (region === 'Oceania') {
                        return true;
                    }
                    
                    // Incluir algunos países de Asia con poblaciones tribales
                    if (region === 'Asia' && (subregion === 'South-Eastern Asia' || subregion === 'Polynesia' || 
                        subregion === 'Micronesia' || subregion === 'Melanesia')) {
                        return true;
                    }
                    
                    return false;
                });
                
                // Si no hay suficientes, agregar algunos de la lista de respaldo
                if (countries.length < 10) {
                    const godFallback = [
                        { name: { common: "Bolivia" }, cca2: "BO" },
                        { name: { common: "Perú" }, cca2: "PE" },
                        { name: { common: "Ecuador" }, cca2: "EC" },
                        { name: { common: "Guatemala" }, cca2: "GT" },
                        { name: { common: "México" }, cca2: "MX" },
                        { name: { common: "Paraguay" }, cca2: "PY" },
                        { name: { common: "Papúa Nueva Guinea" }, cca2: "PG" },
                        { name: { common: "Fiyi" }, cca2: "FJ" },
                        { name: { common: "Kenya" }, cca2: "KE" },
                        { name: { common: "Tanzania" }, cca2: "TZ" },
                        { name: { common: "Uganda" }, cca2: "UG" },
                        { name: { common: "Filipinas" }, cca2: "PH" },
                        { name: { common: "Indonesia" }, cca2: "ID" },
                        { name: { common: "Malasia" }, cca2: "MY" },
                        { name: { common: "Myanmar" }, cca2: "MM" },
                        { name: { common: "Tailandia" }, cca2: "TH" },
                        { name: { common: "Laos" }, cca2: "LA" },
                        { name: { common: "Camboya" }, cca2: "KH" },
                        { name: { common: "Vietnam" }, cca2: "VN" },
                        { name: { common: "Timor Oriental" }, cca2: "TL" }
                    ];
                    countries = godFallback.length > 0 ? godFallback : countries;
                }
            }
            
            console.log(`Nivel ${difficulty}: ${countries.length} países cargados`);
        }

        // Seleccionar nivel de dificultad
        // Crear partículas de fuego (muy optimizado para mejor rendimiento)
        function createHellParticles() {
            const particlesContainer = document.getElementById('hellParticles');
            if (!particlesContainer) return;
            
            // Limpiar partículas anteriores
            particlesContainer.innerHTML = '';
            
            // Reducir a solo 5 partículas para mejor rendimiento
            for (let i = 0; i < 5; i++) {
                const particle = document.createElement('div');
                particle.className = 'hell-particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 3 + 's';
                particle.style.animationDuration = (2 + Math.random() * 2) + 's';
                particle.style.willChange = 'transform, opacity';
                particlesContainer.appendChild(particle);
            }
        }

        // Crear mini llamas que salpican (muy optimizado)
        function createSparks() {
            const overlay = document.getElementById('hellOverlay');
            if (!overlay) return;
            
            // Reducir a solo 2-3 mini llamas para mejor rendimiento
            const sparkCount = 2 + Math.floor(Math.random() * 2);
            
            for (let i = 0; i < sparkCount; i++) {
                const spark = document.createElement('div');
                spark.className = 'spark';
                spark.style.left = Math.random() * 100 + '%';
                spark.style.bottom = '0px';
                spark.style.setProperty('--spark-x', (Math.random() * 200 - 100) + 'px');
                spark.style.animationDelay = Math.random() * 0.5 + 's';
                spark.style.animationDuration = (1 + Math.random() * 0.5) + 's';
                spark.style.willChange = 'transform, opacity';
                overlay.appendChild(spark);
                
                // Remover después de la animación
                setTimeout(() => {
                    if (overlay.contains(spark)) {
                        overlay.removeChild(spark);
                    }
                }, 2000);
            }
        }

        // Crear efectos de batalla
        function createWarEffects() {
            const overlay = document.getElementById('warOverlay');
            if (!overlay) return;
            
            // Crear humo
            for (let i = 0; i < 3; i++) {
                const smoke = document.createElement('div');
                smoke.className = 'smoke';
                smoke.style.left = Math.random() * 100 + '%';
                smoke.style.bottom = '0px';
                smoke.style.animationDelay = Math.random() * 2 + 's';
                smoke.style.animationDuration = (6 + Math.random() * 4) + 's';
                overlay.appendChild(smoke);
                
                setTimeout(() => {
                    if (overlay.contains(smoke)) {
                        overlay.removeChild(smoke);
                    }
                }, 10000);
            }
            
            // Crear explosiones ocasionales
            if (Math.random() > 0.7) {
                const explosion = document.createElement('div');
                explosion.className = 'explosion';
                explosion.style.left = Math.random() * 80 + 10 + '%';
                explosion.style.top = Math.random() * 50 + 20 + '%';
                overlay.appendChild(explosion);
                
                setTimeout(() => {
                    if (overlay.contains(explosion)) {
                        overlay.removeChild(explosion);
                    }
                }, 1000);
            }
            
            // Crear proyectiles
            for (let i = 0; i < 2; i++) {
                const bullet = document.createElement('div');
                bullet.className = 'bullet';
                bullet.style.left = Math.random() * 100 + '%';
                bullet.style.bottom = '0px';
                bullet.style.animationDelay = Math.random() * 1 + 's';
                bullet.style.setProperty('--bullet-x', (Math.random() * 200 - 100) + 'px');
                overlay.appendChild(bullet);
                
                setTimeout(() => {
                    if (overlay.contains(bullet)) {
                        overlay.removeChild(bullet);
                    }
                }, 3000);
            }
        }

        // Crear efectos de naturaleza
        function createNatureEffects() {
            const overlay = document.getElementById('natureOverlay');
            if (!overlay) return;
            
            // Crear hojas cayendo
            for (let i = 0; i < 5; i++) {
                const leaf = document.createElement('div');
                leaf.className = 'leaf';
                leaf.style.left = Math.random() * 100 + '%';
                leaf.style.top = '-20px';
                leaf.style.animationDelay = Math.random() * 2 + 's';
                leaf.style.animationDuration = (6 + Math.random() * 4) + 's';
                overlay.appendChild(leaf);
                
                setTimeout(() => {
                    if (overlay.contains(leaf)) {
                        overlay.removeChild(leaf);
                    }
                }, 12000);
            }
            
            // Crear pájaros volando
            if (Math.random() > 0.5) {
                const bird = document.createElement('div');
                bird.className = 'bird';
                bird.textContent = '🐦';
                bird.style.top = Math.random() * 30 + 10 + '%';
                bird.style.left = '-50px';
                bird.style.animationDelay = Math.random() * 2 + 's';
                overlay.appendChild(bird);
                
                setTimeout(() => {
                    if (overlay.contains(bird)) {
                        overlay.removeChild(bird);
                    }
                }, 15000);
            }
            
            // Crear brisas de viento
            for (let i = 0; i < 3; i++) {
                const breeze = document.createElement('div');
                breeze.className = 'breeze';
                breeze.style.left = Math.random() * 100 + '%';
                breeze.style.top = Math.random() * 50 + 20 + '%';
                breeze.style.animationDelay = Math.random() * 2 + 's';
                breeze.style.animationDuration = (3 + Math.random() * 2) + 's';
                overlay.appendChild(breeze);
                
                setTimeout(() => {
                    if (overlay.contains(breeze)) {
                        overlay.removeChild(breeze);
                    }
                }, 6000);
            }
        }

        function selectDifficulty(level) {
            // Detener temporizador si existe
            stopTimer();
            document.getElementById('timerContainer').style.display = 'none';
            
            difficulty = level;
            // Reiniciar vidas al seleccionar dificultad
            lives = 3;
            updateHearts();
            document.getElementById('difficultySelector').style.display = 'none';
            document.body.classList.remove('difficulty-selector-active');
            document.getElementById('loading').style.display = 'block';
            // Mostrar botón de ranking cuando se selecciona dificultad
            document.getElementById('viewRankingBtn').style.display = 'block';
            
            // Reiniciar arrays para modo Dios
            if (level === 'god') {
                usedCountries = [];
                availableCountries = [];
            }
            
            // Activar efectos según el modo
            document.body.classList.remove('hell-mode', 'war-mode', 'easy-mode', 'god-mode');
            
            if (level === 'impossible') {
                document.body.classList.add('hell-mode');
                createHellParticles();
                createSparks();
                // Recrear partículas cada 10 segundos (mucho menos frecuente)
                setInterval(() => {
                    createHellParticles();
                }, 10000);
                // Crear mini llamas cada 3 segundos (mucho menos frecuente)
                setInterval(() => {
                    createSparks();
                }, 3000);
            } else if (level === 'hard') {
                document.body.classList.add('war-mode');
                createWarEffects();
                // Recrear efectos de batalla cada 2 segundos
                setInterval(() => {
                    createWarEffects();
                }, 2000);
            } else if (level === 'easy') {
                document.body.classList.add('easy-mode');
                createNatureEffects();
                // Recrear efectos de naturaleza cada 3 segundos
                setInterval(() => {
                    createNatureEffects();
                }, 3000);
            } else if (level === 'god') {
                document.body.classList.add('god-mode');
                createGalacticStars();
                // Recrear estrellas cada 5 segundos
                setInterval(() => {
                    createGalacticStars();
                }, 5000);
            }
            
            loadCountries();
        }

        // Crear partículas flotantes para el selector de dificultad
        function createDifficultySelectorParticles() {
            const selector = document.getElementById('difficultySelector');
            if (!selector) return;
            
            // Limpiar partículas anteriores
            const existingParticles = selector.querySelectorAll('.floating-particle');
            existingParticles.forEach(p => p.remove());
            
            // Crear 20 partículas flotantes
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'floating-particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 8 + 's';
                particle.style.animationDuration = (6 + Math.random() * 4) + 's';
                particle.style.width = (3 + Math.random() * 3) + 'px';
                particle.style.height = particle.style.width;
                selector.appendChild(particle);
            }
        }

        // Crear estrellas galácticas
        function createGalacticStars() {
            const overlay = document.getElementById('galacticOverlay');
            if (!overlay) return;
            
            // Crear estrellas pequeñas
            for (let i = 0; i < 15; i++) {
                const star = document.createElement('div');
                star.className = 'galactic-star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 3 + 's';
                star.style.animationDuration = (2 + Math.random() * 2) + 's';
                overlay.appendChild(star);
                
                setTimeout(() => {
                    if (overlay.contains(star)) {
                        overlay.removeChild(star);
                    }
                }, 10000);
            }
            
            // Crear estrellas grandes ocasionales
            if (Math.random() > 0.5) {
                const largeStar = document.createElement('div');
                largeStar.className = 'galactic-star large';
                largeStar.style.left = Math.random() * 100 + '%';
                largeStar.style.top = Math.random() * 100 + '%';
                largeStar.style.animationDelay = Math.random() * 2 + 's';
                largeStar.style.animationDuration = (3 + Math.random() * 2) + 's';
                overlay.appendChild(largeStar);
                
                setTimeout(() => {
                    if (overlay.contains(largeStar)) {
                        overlay.removeChild(largeStar);
                    }
                }, 10000);
            }
            
            // Crear nebulosas ocasionales
            if (Math.random() > 0.7) {
                const nebula = document.createElement('div');
                nebula.className = 'galactic-nebula';
                nebula.style.left = Math.random() * 80 + 10 + '%';
                nebula.style.top = Math.random() * 80 + 10 + '%';
                overlay.appendChild(nebula);
                
                setTimeout(() => {
                    if (overlay.contains(nebula)) {
                        overlay.removeChild(nebula);
                    }
                }, 20000);
            }
        }

        // Cargar países desde la API
        async function loadCountries() {
            const loadingEl = document.getElementById('loading');
            
            try {
                loadingEl.textContent = 'Cargando países...';
                
                // Intentar cargar desde la API (solo una vez, sin timeout para evitar errores)
                let data = null;
                
                try {
                    const response = await fetch('https://restcountries.com/v3.1/all', {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const jsonData = await response.json();
                        if (Array.isArray(jsonData) && jsonData.length > 0) {
                            data = jsonData;
                        }
                    }
                } catch (err) {
                    console.log('API no disponible, usando lista de respaldo');
                }
                
                // Si la API falla o no devuelve datos, usar lista de respaldo
                if (!data || data.length === 0) {
                    console.log('Usando lista de países de respaldo');
                    allCountries = fallbackCountries;
                } else {
                    // Filtrar países que tengan nombre y código ISO (para FlagsAPI)
                    allCountries = data.filter(country =>
                        country &&
                        country.name &&
                        country.name.common &&
                        country.cca2 // Código ISO de 2 letras para FlagsAPI
                    );
                    
                    // Si después del filtro no hay países, usar respaldo
                    if (allCountries.length === 0) {
                        console.log('No se encontraron países válidos, usando lista de respaldo');
                        allCountries = fallbackCountries;
                    }
                }
                
                if (allCountries.length === 0) {
                    throw new Error('No se pudo cargar ningún país');
                }
                
                // Aplicar filtro según dificultad
                applyDifficultyFilter();
                
                loadingEl.style.display = 'none';
                document.getElementById('options').style.display = 'flex';
                document.getElementById('endAttemptBtn').style.display = 'block';
                loadNewQuestion();
            } catch (error) {
                // Si todo falla, usar la lista de respaldo
                console.log('Error al cargar desde API, usando lista de respaldo:', error);
                allCountries = fallbackCountries;
                
                if (allCountries.length > 0) {
                    // Aplicar filtro según dificultad
                    applyDifficultyFilter();
                    
                    loadingEl.style.display = 'none';
                    document.getElementById('options').style.display = 'flex';
                    loadNewQuestion();
                } else {
                    loadingEl.textContent = `Error: ${error.message}. Recarga la página.`;
                    loadingEl.style.color = '#f56565';
                }
            }
        }

        // Funciones del temporizador
        function startTimer() {
            // Detener temporizador anterior si existe
            stopTimer();
            
            timeLeft = 20;
            updateTimerDisplay();
            document.getElementById('timerContainer').style.display = 'flex';
            
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft <= 0) {
                    stopTimer();
                    handleTimeUp();
                }
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function updateTimerDisplay() {
            const timerText = document.getElementById('timerText');
            const timerProgress = document.getElementById('timerProgress');
            
            if (!timerText || !timerProgress) return;
            
            timerText.textContent = timeLeft;
            
            // Calcular el progreso del círculo (circunferencia = 2 * π * r = 2 * π * 45 ≈ 283)
            const circumference = 2 * Math.PI * 45;
            const progress = (timeLeft / 20) * circumference;
            timerProgress.style.strokeDashoffset = circumference - progress;
            
            // Cambiar color según el tiempo restante
            timerProgress.classList.remove('warning', 'danger');
            if (timeLeft <= 5) {
                timerProgress.classList.add('danger');
            } else if (timeLeft <= 10) {
                timerProgress.classList.add('warning');
            }
        }

        function handleTimeUp() {
            if (answered) return;
            
            answered = true;
            
            // Deshabilitar todos los botones
            [1, 2, 3, 4].forEach(i => {
                const btn = document.getElementById(`option${i}`);
                if (btn.style.display !== 'none') {
                    btn.disabled = true;
                    
                    if (btn.textContent === currentCountry.name.common) {
                        btn.classList.add('correct');
                    }
                }
            });

            // Marcar como incorrecta (tiempo agotado)
            lives--;
            updateHearts();
            
            const messageEl = document.getElementById('message');
            messageEl.textContent = `⏰ Tiempo agotado. La respuesta correcta es: ${currentCountry.name.common}`;
            messageEl.className = 'message incorrect';
            
            // Actualizar puntuación
            document.getElementById('score').textContent = score;
            
            // Mostrar alerta de fallo
            showAlert('error', '', `La respuesta correcta era: ${currentCountry.name.common}`);
            
            // Actualizar racha (marcar como incorrecta)
            updateStreak(false);
            
            // Si se acabaron las vidas, mostrar game over
            if (lives <= 0) {
                setTimeout(() => {
                    showGameOver();
                }, 2000);
            } else {
                // Pasar automáticamente a la siguiente bandera después de 2 segundos
                setTimeout(() => {
                    loadNewQuestion();
                }, 2000);
            }
        }

        // Cargar nueva pregunta
        function loadNewQuestion() {
            if (difficulty === 'god') {
                // Modo Dios: usar todos los países sin repetir
                if (availableCountries.length === 0) {
                    // Si se acabaron todos los países, reiniciar
                    if (usedCountries.length > 0) {
                        availableCountries = [...usedCountries];
                        usedCountries = [];
                    } else {
                        // Si no hay países disponibles, usar todos los países cargados
                        availableCountries = [...allCountries];
                    }
                }
                
                if (availableCountries.length === 0) {
                    // Si aún no hay países, mostrar mensaje
                    const messageEl = document.getElementById('message');
                    messageEl.textContent = '✨ ¡Has completado el examen de todas las banderas del mundo! ¡Eres un verdadero Dios! ✨';
                    messageEl.className = 'message correct';
                    return;
                }
                
                // Seleccionar país aleatorio de los disponibles
                const randomIndex = Math.floor(Math.random() * availableCountries.length);
                currentCountry = availableCountries[randomIndex];
                
                // Mover a usados y quitar de disponibles
                usedCountries.push(currentCountry);
                availableCountries.splice(randomIndex, 1);
            } else {
                // Modos normales: selección aleatoria con repetición
                if (countries.length === 0) {
                    const messageEl = document.getElementById('message');
                    messageEl.textContent = '⚠️ No hay países disponibles para este modo. Por favor, recarga la página.';
                    messageEl.className = 'message incorrect';
                    console.error('Error: No hay países disponibles en el modo', difficulty);
                    return;
                }
                
                // Seleccionar país aleatorio
                const randomIndex = Math.floor(Math.random() * countries.length);
                currentCountry = countries[randomIndex];
                
                // Verificar que el país seleccionado sea válido
                if (!currentCountry || !currentCountry.name || !currentCountry.name.common) {
                    const messageEl = document.getElementById('message');
                    messageEl.textContent = '⚠️ Error al seleccionar país. Por favor, recarga la página.';
                    messageEl.className = 'message incorrect';
                    console.error('Error: País seleccionado no es válido', currentCountry);
                    return;
                }
            }

            // Detener temporizador anterior
            stopTimer();

            // Mostrar bandera usando emojis Unicode (siempre funcionan)
            const countryCode = currentCountry.cca2; // Código ISO de 2 letras
            
            // Función para convertir código ISO a emoji de bandera
            function getFlagEmoji(countryCode) {
                if (!countryCode || countryCode.length !== 2) return '🏳️';
                
                const codePoints = countryCode
                    .toUpperCase()
                    .split('')
                    .map(char => 127397 + char.charCodeAt());
                return String.fromCodePoint(...codePoints);
            }
            
            const flagEmoji = getFlagEmoji(countryCode);
            const flagEl = document.getElementById('flag');
            
            // Mostrar emoji de bandera (grande y centrado)
            flagEl.innerHTML = `<div style="font-size: 10em; line-height: 1; user-select: none;">${flagEmoji}</div>`;
            
            // También intentar cargar imagen como respaldo (opcional, en segundo plano)
            const flagUrls = [
                `https://flagcdn.com/${countryCode.toLowerCase()}.svg`,
                `https://flagcdn.com/w256/${countryCode.toLowerCase()}.png`,
                `https://flagsapi.com/${countryCode}/flat/64.png`
            ];
            
            // Intentar cargar imagen en segundo plano (sin bloquear)
            let imgIndex = 0;
            function tryLoadImage() {
                if (imgIndex >= flagUrls.length) return;
                
                const img = new Image();
                img.src = flagUrls[imgIndex];
                
                img.onload = function() {
                    // Si la imagen carga, reemplazar el emoji
                    flagEl.innerHTML = '';
                    img.alt = `Bandera de ${currentCountry.name.common}`;
                    img.style.width = 'auto';
                    img.style.height = 'auto';
                    img.style.maxWidth = '100%';
                    img.style.maxHeight = '180px';
                    img.style.minHeight = '100px';
                    img.style.objectFit = 'contain';
                    img.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.1)';
                    img.style.borderRadius = '8px';
                    img.style.background = 'white';
                    img.style.padding = '5px';
                    img.style.display = 'block';
                    img.style.margin = '0 auto';
                    flagEl.appendChild(img);
                };
                
                img.onerror = function() {
                    imgIndex++;
                    tryLoadImage();
                };
            }
            
            // Intentar cargar imagen (opcional, el emoji ya está mostrado)
            tryLoadImage();

            // Generar opciones (1 correcta + 3 incorrectas)
            const wrongCountries = countries
                .filter(c => c.name.common !== currentCountry.name.common)
                .sort(() => Math.random() - 0.5)
                .slice(0, 3);

            const options = [
                currentCountry.name.common,
                wrongCountries[0].name.common,
                wrongCountries[1].name.common,
                wrongCountries[2].name.common
            ].sort(() => Math.random() - 0.5);

            // Asignar opciones a los botones
            document.getElementById('option1').textContent = options[0];
            document.getElementById('option2').textContent = options[1];
            document.getElementById('option3').textContent = options[2];
            document.getElementById('option4').textContent = options[3];

            // Resetear estado
            answered = false;
            jokerUsed = false;
            document.getElementById('message').textContent = '';
            document.getElementById('message').className = 'message';
            document.getElementById('nextBtn').classList.remove('show');

            // Habilitar botones
            [1, 2, 3, 4].forEach(i => {
                const btn = document.getElementById(`option${i}`);
                btn.disabled = false;
                btn.className = 'option';
                btn.style.display = 'block';
            });

            // Actualizar visibilidad del comodín
            updateJokerButton();
            
            // Iniciar temporizador
            startTimer();
        }

        // Actualizar corazones/vidas
        function updateHearts() {
            const heartsEl = document.getElementById('hearts');
            heartsEl.innerHTML = '';
            
            for (let i = 0; i < 3; i++) {
                const heart = document.createElement('span');
                if (i < lives) {
                    heart.textContent = '❤️';
                    heart.className = 'heart-full';
                } else {
                    heart.textContent = '🤍';
                    heart.className = 'heart-empty';
                }
                heartsEl.appendChild(heart);
            }
        }

        // Mostrar pantalla de game over
        function showGameOver() {
            // Detener temporizador
            stopTimer();
            document.getElementById('timerContainer').style.display = 'none';
            
            // Ocultar botón de terminar intento
            document.getElementById('endAttemptBtn').style.display = 'none';
            
            document.getElementById('finalScore').textContent = score;
            document.getElementById('maxStreak').textContent = maxStreak;
            document.getElementById('gameOver').style.display = 'flex';
            
            // Mostrar botón de guardar puntuación (usará el nombre del usuario autenticado)
            document.getElementById('nameInputContainer').style.display = 'block';
            document.getElementById('saveScoreBtn').disabled = false;
            document.getElementById('saveScoreBtn').textContent = '💾 Guardar Puntuación';
            document.getElementById('rankingContainer').style.display = 'none';
            document.getElementById('showRankingBtn').style.display = 'none';
            
            // Mostrar botón de ranking cuando se pierde
            document.getElementById('viewRankingBtn').style.display = 'block';
        }

        // Guardar puntuación en Firebase
        async function saveScore() {
            const playerName = window.currentUserName || 'Anónimo';
            
            const saveBtn = document.getElementById('saveScoreBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = '💾 Guardando...';
            
            try {
                const success = await window.guardarPuntuacion(playerName, score, difficulty);
                if (success) {
                    saveBtn.textContent = '✅ Guardado';
                    document.getElementById('showRankingBtn').style.display = 'block';
                    // Cargar ranking automáticamente después de guardar
                    setTimeout(() => {
                        loadRanking();
                    }, 500);
                } else {
                    alert('Error al guardar la puntuación. Intenta de nuevo.');
                    saveBtn.disabled = false;
                    saveBtn.textContent = '💾 Guardar Puntuación';
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar la puntuación. Intenta de nuevo.');
                saveBtn.disabled = false;
                saveBtn.textContent = '💾 Guardar Puntuación';
            }
        }

        // Actualizar display del usuario
        function updateUserDisplay() {
            if (window.currentUserName) {
                document.getElementById('userNameDisplay').textContent = `👤 ${window.currentUserName}`;
            }
        }

        // Manejar login
        async function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const messageEl = document.getElementById('loginMessage');
            const loginBtn = document.getElementById('loginBtn');
            
            if (!email || !password) {
                messageEl.textContent = 'Por favor, completa todos los campos';
                messageEl.className = 'auth-message error';
                return;
            }
            
            if (!isValidEmail(email)) {
                messageEl.textContent = 'Por favor, ingresa un email válido (ejemplo: usuario@email.com)';
                messageEl.className = 'auth-message error';
                return;
            }
            
            loginBtn.disabled = true;
            loginBtn.textContent = 'Iniciando sesión...';
            messageEl.textContent = '';
            messageEl.className = 'auth-message';
            
            // Verificar que window.iniciarSesion esté disponible
            if (!window.iniciarSesion || !window.firebaseReady) {
                // Intentar esperar un poco si el módulo está cargando
                for (let i = 0; i < 30; i++) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    if (window.iniciarSesion && window.firebaseReady) break;
                }
            }
            
            if (!window.iniciarSesion || !window.firebaseReady) {
                messageEl.textContent = 'Error: El sistema de autenticación no está listo. Por favor, espera unos segundos y vuelve a intentar, o recarga la página.';
                messageEl.className = 'auth-message error';
                loginBtn.disabled = false;
                loginBtn.textContent = 'Iniciar Sesión';
                console.error('window.iniciarSesion o firebaseReady no está disponible después de esperar');
                return;
            }
            
            const result = await window.iniciarSesion(email, password);
            
            if (result.success) {
                messageEl.textContent = '¡Sesión iniciada correctamente!';
                messageEl.className = 'auth-message success';
                // El onAuthStateChanged se encargará de ocultar la pantalla de auth
            } else {
                let errorMsg = 'Error al iniciar sesión';
                if (result.error.includes('user-not-found')) {
                    errorMsg = 'Usuario no encontrado. Verifica el email o regístrate primero.';
                } else if (result.error.includes('wrong-password')) {
                    errorMsg = 'Contraseña incorrecta';
                } else if (result.error.includes('invalid-email')) {
                    errorMsg = 'Email inválido. Usa un formato válido (ejemplo: usuario@email.com)';
                } else if (result.error.includes('operation-not-allowed')) {
                    errorMsg = '⚠️ ERROR: Email/Password no está habilitado en Firebase. Ve a Firebase Console > Authentication > Sign-in method > Email/Password y habilítalo.';
                } else if (result.error.includes('configuration-not-found')) {
                    errorMsg = '⚠️ ERROR: Firebase Authentication no está configurado. Habilita Email/Password en Firebase Console.';
                } else if (result.error.includes('network') || result.error.includes('network-request-failed')) {
                    errorMsg = 'Error de conexión. Verifica tu internet.';
                } else {
                    errorMsg = `Error: ${result.error}`;
                }
                messageEl.textContent = errorMsg;
                messageEl.className = 'auth-message error';
                loginBtn.disabled = false;
                loginBtn.textContent = 'Iniciar Sesión';
            }
        }

        // Validar formato de email
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // Manejar registro
        async function handleRegister() {
            const name = document.getElementById('registerName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            const messageEl = document.getElementById('registerMessage');
            const registerBtn = document.getElementById('registerBtn');
            
            if (!name || !email || !password) {
                messageEl.textContent = 'Por favor, completa todos los campos';
                messageEl.className = 'auth-message error';
                return;
            }
            
            if (name.length < 2) {
                messageEl.textContent = 'El nombre debe tener al menos 2 caracteres';
                messageEl.className = 'auth-message error';
                return;
            }
            
            if (!isValidEmail(email)) {
                messageEl.textContent = 'Por favor, ingresa un email válido (ejemplo: usuario@email.com)';
                messageEl.className = 'auth-message error';
                return;
            }
            
            if (password.length < 6) {
                messageEl.textContent = 'La contraseña debe tener al menos 6 caracteres';
                messageEl.className = 'auth-message error';
                return;
            }
            
            registerBtn.disabled = true;
            registerBtn.textContent = 'Registrando...';
            messageEl.textContent = '';
            messageEl.className = 'auth-message';
            
            // Verificar que la función esté disponible
            if (!window.registrarUsuario) {
                messageEl.textContent = 'Error: La función de registro no está disponible. Por favor, recarga la página.';
                messageEl.className = 'auth-message error';
                registerBtn.disabled = false;
                registerBtn.textContent = 'Registrarse';
                return;
            }
            
            const result = await window.registrarUsuario(email, password, name);
            
            if (result.success) {
                messageEl.textContent = '¡Registro exitoso!';
                messageEl.className = 'auth-message success';
                // El onAuthStateChanged se encargará de ocultar la pantalla de auth
            } else {
                let errorMsg = 'Error al registrarse';
                if (result.error.includes('email-already-in-use')) {
                    errorMsg = 'Este email ya está registrado. Usa "Iniciar Sesión" en su lugar.';
                } else if (result.error.includes('invalid-email')) {
                    errorMsg = 'Email inválido. Usa un formato válido (ejemplo: usuario@email.com)';
                } else if (result.error.includes('weak-password')) {
                    errorMsg = 'La contraseña es muy débil (mínimo 6 caracteres)';
                } else if (result.error.includes('operation-not-allowed')) {
                    errorMsg = '⚠️ ERROR: Email/Password no está habilitado en Firebase. Ve a Firebase Console > Authentication > Sign-in method > Email/Password y habilítalo.';
                } else if (result.error.includes('configuration-not-found')) {
                    errorMsg = '⚠️ ERROR: Firebase Authentication no está configurado. Habilita Email/Password en Firebase Console.';
                } else if (result.error.includes('network') || result.error.includes('network-request-failed')) {
                    errorMsg = 'Error de conexión. Verifica tu internet.';
                } else {
                    errorMsg = `Error: ${result.error}`;
                }
                messageEl.textContent = errorMsg;
                messageEl.className = 'auth-message error';
                registerBtn.disabled = false;
                registerBtn.textContent = 'Registrarse';
            }
        }

        // Cambiar entre tabs de login/registro
        function switchAuthTab(tab) {
            const loginTab = document.getElementById('loginTab');
            const registerTab = document.getElementById('registerTab');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            
            if (tab === 'login') {
                loginTab.classList.add('active');
                registerTab.classList.remove('active');
                loginForm.style.display = 'flex';
                registerForm.style.display = 'none';
            } else {
                registerTab.classList.add('active');
                loginTab.classList.remove('active');
                registerForm.style.display = 'flex';
                loginForm.style.display = 'none';
            }
        }

        // Cerrar sesión
        async function handleLogout() {
            // Cerrar modal de perfil si está abierto
            if (window.hideProfileModal) {
                window.hideProfileModal();
            }
            await window.cerrarSesion();
            // El onAuthStateChanged se encargará de mostrar la pantalla de auth
        }

        // Cargar y mostrar ranking (para game over)
        async function loadRanking() {
            const rankingContainer = document.getElementById('rankingContainer');
            const rankingList = document.getElementById('rankingList');
            
            rankingContainer.style.display = 'block';
            rankingList.innerHTML = '<div style="text-align: center; padding: 20px;">Cargando ranking...</div>';
            
            try {
                // Obtener ranking del nivel actual
                const ranking = await window.obtenerRanking(difficulty);
                
                if (ranking.length === 0) {
                    const nivelTexto = difficulty === 'easy' ? 'Fácil' : (difficulty === 'hard' ? 'Difícil' : (difficulty === 'impossible' ? 'Imposible' : (difficulty === 'god' ? 'Dios' : '')));
                    rankingList.innerHTML = `<div style="text-align: center; padding: 20px; color: #718096;">No hay puntuaciones aún en nivel ${nivelTexto}</div>`;
                    return;
                }
                
                rankingList.innerHTML = '';
                ranking.forEach((item, index) => {
                    const rankingItem = document.createElement('div');
                    rankingItem.className = 'ranking-item' + (index === 0 ? ' top' : '');
                    
                    const position = document.createElement('div');
                    position.className = 'ranking-position';
                    position.textContent = `#${index + 1}`;
                    
                    const name = document.createElement('div');
                    name.className = 'ranking-name';
                    
                    // Crear contenedor para foto de perfil
                    const profilePicContainer = document.createElement('div');
                    profilePicContainer.className = 'ranking-profile-picture';
                    name.appendChild(profilePicContainer);
                    
                    // Crear span para el nombre
                    const nameText = document.createElement('span');
                    nameText.textContent = item.nombre || 'Anónimo';
                    name.appendChild(nameText);
                    
                    // Cargar foto de perfil si hay userId
                    if (item.userId) {
                        window.loadUserProfilePicture(item.userId, profilePicContainer);
                    } else {
                        // Mostrar placeholder si no hay userId
                        const placeholder = document.createElement('div');
                        placeholder.className = 'placeholder';
                        placeholder.textContent = '👤';
                        profilePicContainer.appendChild(placeholder);
                    }
                    
                    const score = document.createElement('div');
                    score.className = 'ranking-score';
                    score.textContent = item.puntos || 0;
                    
                    rankingItem.appendChild(position);
                    rankingItem.appendChild(name);
                    rankingItem.appendChild(score);
                    rankingList.appendChild(rankingItem);
                });
            } catch (error) {
                console.error('Error al cargar ranking:', error);
                rankingList.innerHTML = '<div style="text-align: center; padding: 20px; color: #f56565;">Error al cargar el ranking</div>';
            }
        }

        // Mostrar ranking principal
        async function showMainRanking() {
            const mainRankingContainer = document.getElementById('mainRankingContainer');
            const rankingTitle = document.getElementById('rankingTitle');
            
            // Actualizar título según el nivel
            if (difficulty === 'easy') {
                rankingTitle.textContent = '🏆 Top 10 Ranking - Fácil';
            } else if (difficulty === 'hard') {
                rankingTitle.textContent = '🏆 Top 10 Ranking - Difícil';
            } else if (difficulty === 'impossible') {
                rankingTitle.textContent = '🏆 Top 10 Ranking - Imposible';
            } else if (difficulty === 'god') {
                rankingTitle.textContent = '✨ Top 10 Ranking - Dios';
            } else {
                rankingTitle.textContent = '🏆 Top 10 Ranking';
            }
            
            mainRankingContainer.style.display = 'block';
            await loadMainRanking();
        }

        // Ocultar ranking principal
        function hideMainRanking() {
            const mainRankingContainer = document.getElementById('mainRankingContainer');
            mainRankingContainer.style.display = 'none';
        }

        // Mostrar ranking por nivel específico (desde la pantalla de selección)
        window.showRankingByLevel = async function(level) {
            const difficultyRankingContainer = document.getElementById('difficultyRankingContainer');
            const difficultyRankingTitle = document.getElementById('difficultyRankingTitle');
            const difficultyRankingList = document.getElementById('difficultyRankingList');
            
            if (!difficultyRankingContainer || !difficultyRankingTitle || !difficultyRankingList) {
                console.error('Elementos del ranking no encontrados');
                return;
            }
            
            // Actualizar título según el nivel
            if (level === 'easy') {
                difficultyRankingTitle.textContent = '🏆 Top 10 Ranking - Fácil';
            } else if (level === 'hard') {
                difficultyRankingTitle.textContent = '🏆 Top 10 Ranking - Difícil';
            } else if (level === 'impossible') {
                difficultyRankingTitle.textContent = '🏆 Top 10 Ranking - Imposible';
            } else if (level === 'god') {
                difficultyRankingTitle.textContent = '✨ Top 10 Ranking - Dios';
            } else {
                difficultyRankingTitle.textContent = '🏆 Top 10 Ranking';
            }
            
            // Mostrar contenedor y cargar ranking
            difficultyRankingContainer.style.display = 'block';
            await loadDifficultyRankingByLevel(level);
            
            // Scroll suave al ranking
            setTimeout(() => {
                if (difficultyRankingContainer) {
                    difficultyRankingContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }, 100);
        }

        // Cargar ranking por nivel específico (para la pantalla de selección)
        async function loadDifficultyRankingByLevel(level) {
            const difficultyRankingList = document.getElementById('difficultyRankingList');
            
            if (!difficultyRankingList) {
                console.error('difficultyRankingList no encontrado');
                return;
            }
            
            difficultyRankingList.innerHTML = '<div style="text-align: center; padding: 20px; color: #718096;">Cargando ranking...</div>';
            
            try {
                // Obtener ranking del nivel especificado
                const ranking = await window.obtenerRanking(level);
                
                if (ranking.length === 0) {
                    const nivelTexto = level === 'easy' ? 'Fácil' : (level === 'hard' ? 'Difícil' : (level === 'impossible' ? 'Imposible' : (level === 'god' ? 'Dios' : '')));
                    difficultyRankingList.innerHTML = `<div style="text-align: center; padding: 20px; color: #718096;">No hay puntuaciones aún en nivel ${nivelTexto}. ¡Sé el primero en jugar!</div>`;
                    return;
                }
                
                difficultyRankingList.innerHTML = '';
                ranking.forEach((item, index) => {
                    const rankingItem = document.createElement('div');
                    // Aplicar clases según la posición
                    let itemClass = 'difficulty-ranking-item';
                    if (index === 0) {
                        itemClass += ' top';
                    } else if (index === 1) {
                        itemClass += ' second';
                    } else if (index === 2) {
                        itemClass += ' third';
                    }
                    rankingItem.className = itemClass;
                    
                    const position = document.createElement('div');
                    position.className = 'difficulty-ranking-position';
                    position.textContent = `#${index + 1}`;
                    
                    const name = document.createElement('div');
                    name.className = 'difficulty-ranking-name';
                    
                    // Crear contenedor para foto de perfil
                    const profilePicContainer = document.createElement('div');
                    profilePicContainer.className = 'ranking-profile-picture';
                    name.appendChild(profilePicContainer);
                    
                    // Crear span para el nombre
                    const nameText = document.createElement('span');
                    nameText.textContent = item.nombre || 'Anónimo';
                    name.appendChild(nameText);
                    
                    // Cargar foto de perfil si hay userId
                    if (item.userId) {
                        if (window.loadUserProfilePicture) {
                            window.loadUserProfilePicture(item.userId, profilePicContainer);
                        } else {
                            const placeholder = document.createElement('div');
                            placeholder.className = 'placeholder';
                            placeholder.textContent = '👤';
                            profilePicContainer.appendChild(placeholder);
                        }
                    } else {
                        // Mostrar placeholder si no hay userId
                        const placeholder = document.createElement('div');
                        placeholder.className = 'placeholder';
                        placeholder.textContent = '👤';
                        profilePicContainer.appendChild(placeholder);
                    }
                    
                    const score = document.createElement('div');
                    score.className = 'difficulty-ranking-score';
                    score.textContent = item.puntos || 0;
                    
                    rankingItem.appendChild(position);
                    rankingItem.appendChild(name);
                    rankingItem.appendChild(score);
                    difficultyRankingList.appendChild(rankingItem);
                });
            } catch (error) {
                console.error('Error al cargar ranking:', error);
                difficultyRankingList.innerHTML = '<div style="text-align: center; padding: 20px; color: #f56565;">Error al cargar el ranking</div>';
            }
        }

        // Cargar ranking por nivel específico (para el modal durante el juego)
        async function loadMainRankingByLevel(level) {
            const mainRankingList = document.getElementById('mainRankingList');
            
            if (!mainRankingList) {
                console.error('mainRankingList no encontrado');
                return;
            }
            
            mainRankingList.innerHTML = '<div style="text-align: center; padding: 20px; color: #718096;">Cargando ranking...</div>';
            
            try {
                // Obtener ranking del nivel especificado
                const ranking = await window.obtenerRanking(level);
                
                if (ranking.length === 0) {
                    const nivelTexto = level === 'easy' ? 'Fácil' : (level === 'hard' ? 'Difícil' : (level === 'impossible' ? 'Imposible' : (level === 'god' ? 'Dios' : '')));
                    mainRankingList.innerHTML = `<div style="text-align: center; padding: 20px; color: #718096;">No hay puntuaciones aún en nivel ${nivelTexto}. ¡Sé el primero en jugar!</div>`;
                    return;
                }
                
                mainRankingList.innerHTML = '';
                ranking.forEach((item, index) => {
                    const rankingItem = document.createElement('div');
                    // Aplicar clases según la posición
                    let itemClass = 'main-ranking-item';
                    if (index === 0) {
                        itemClass += ' top';
                    } else if (index === 1) {
                        itemClass += ' second';
                    } else if (index === 2) {
                        itemClass += ' third';
                    }
                    rankingItem.className = itemClass;
                    
                    const position = document.createElement('div');
                    position.className = 'main-ranking-position';
                    position.textContent = `#${index + 1}`;
                    
                    const name = document.createElement('div');
                    name.className = 'main-ranking-name';
                    
                    // Crear contenedor para foto de perfil
                    const profilePicContainer = document.createElement('div');
                    profilePicContainer.className = 'ranking-profile-picture';
                    name.appendChild(profilePicContainer);
                    
                    // Crear span para el nombre
                    const nameText = document.createElement('span');
                    nameText.textContent = item.nombre || 'Anónimo';
                    name.appendChild(nameText);
                    
                    // Cargar foto de perfil si hay userId
                    if (item.userId) {
                        if (window.loadUserProfilePicture) {
                            window.loadUserProfilePicture(item.userId, profilePicContainer);
                        } else {
                            const placeholder = document.createElement('div');
                            placeholder.className = 'placeholder';
                            placeholder.textContent = '👤';
                            profilePicContainer.appendChild(placeholder);
                        }
                    } else {
                        // Mostrar placeholder si no hay userId
                        const placeholder = document.createElement('div');
                        placeholder.className = 'placeholder';
                        placeholder.textContent = '👤';
                        profilePicContainer.appendChild(placeholder);
                    }
                    
                    const score = document.createElement('div');
                    score.className = 'main-ranking-score';
                    score.textContent = item.puntos || 0;
                    
                    rankingItem.appendChild(position);
                    rankingItem.appendChild(name);
                    rankingItem.appendChild(score);
                    mainRankingList.appendChild(rankingItem);
                });
            } catch (error) {
                console.error('Error al cargar ranking:', error);
                mainRankingList.innerHTML = '<div style="text-align: center; padding: 20px; color: #f56565;">Error al cargar el ranking</div>';
            }
        }

        // Cargar y mostrar ranking principal (en la pantalla del juego)
        async function loadMainRanking() {
            const mainRankingList = document.getElementById('mainRankingList');
            
            if (!mainRankingList) {
                console.error('mainRankingList no encontrado');
                return;
            }
            
            mainRankingList.innerHTML = '<div style="text-align: center; padding: 20px; color: #718096;">Cargando ranking...</div>';
            
            try {
                // Obtener ranking del nivel actual
                const ranking = await window.obtenerRanking(difficulty);
                
                if (ranking.length === 0) {
                    const nivelTexto = difficulty === 'easy' ? 'Fácil' : (difficulty === 'hard' ? 'Difícil' : (difficulty === 'impossible' ? 'Imposible' : (difficulty === 'god' ? 'Dios' : '')));
                    mainRankingList.innerHTML = `<div style="text-align: center; padding: 20px; color: #718096;">No hay puntuaciones aún en nivel ${nivelTexto}. ¡Sé el primero en jugar!</div>`;
                    return;
                }
                
                mainRankingList.innerHTML = '';
                ranking.forEach((item, index) => {
                    const rankingItem = document.createElement('div');
                    // Aplicar clases según la posición
                    let itemClass = 'main-ranking-item';
                    if (index === 0) {
                        itemClass += ' top';
                    } else if (index === 1) {
                        itemClass += ' second';
                    } else if (index === 2) {
                        itemClass += ' third';
                    }
                    rankingItem.className = itemClass;
                    
                    const position = document.createElement('div');
                    position.className = 'main-ranking-position';
                    position.textContent = `#${index + 1}`;
                    
                    const name = document.createElement('div');
                    name.className = 'main-ranking-name';
                    
                    // Crear contenedor para foto de perfil
                    const profilePicContainer = document.createElement('div');
                    profilePicContainer.className = 'ranking-profile-picture';
                    name.appendChild(profilePicContainer);
                    
                    // Crear span para el nombre
                    const nameText = document.createElement('span');
                    nameText.textContent = item.nombre || 'Anónimo';
                    name.appendChild(nameText);
                    
                    // Cargar foto de perfil si hay userId
                    if (item.userId) {
                        window.loadUserProfilePicture(item.userId, profilePicContainer);
                    } else {
                        // Mostrar placeholder si no hay userId
                        const placeholder = document.createElement('div');
                        placeholder.className = 'placeholder';
                        placeholder.textContent = '👤';
                        profilePicContainer.appendChild(placeholder);
                    }
                    
                    const score = document.createElement('div');
                    score.className = 'main-ranking-score';
                    score.textContent = item.puntos || 0;
                    
                    rankingItem.appendChild(position);
                    rankingItem.appendChild(name);
                    rankingItem.appendChild(score);
                    mainRankingList.appendChild(rankingItem);
                });
            } catch (error) {
                console.error('Error al cargar ranking:', error);
                mainRankingList.innerHTML = '<div style="text-align: center; padding: 20px; color: #f56565;">Error al cargar el ranking</div>';
            }
        }

        // Terminar intento (eliminar vidas y volver a selección de modos)
        function endAttempt() {
            // Detener temporizador
            stopTimer();
            document.getElementById('timerContainer').style.display = 'none';
            
            // Eliminar todas las vidas para mostrar game over
            lives = 0;
            updateHearts();
            
            // Mostrar game over (como si hubiera perdido todas las vidas)
            showGameOver();
        }

        // Reiniciar juego
        function restartGame() {
            // Detener temporizador
            stopTimer();
            document.getElementById('timerContainer').style.display = 'none';
            
            score = 0;
            streak = 0;
            maxStreak = 0;
            lives = 3;
            answered = false;
            jokerAvailable = false;
            jokerUsed = false;
            // Resetear difficulty
            difficulty = null;
            timeLeft = 20;
            
            // Remover las clases de modo para que la pantalla de elegir nivel no tenga estilos del nivel anterior
            document.body.classList.remove('hell-mode', 'war-mode', 'easy-mode', 'god-mode');
            
            // Ocultar game over
            document.getElementById('gameOver').style.display = 'none';
            
            // Resetear UI
            document.getElementById('score').textContent = '0';
            document.getElementById('streak').textContent = '0';
            document.getElementById('message').textContent = '';
            document.getElementById('message').className = 'message';
            document.getElementById('nextBtn').classList.remove('show');
            document.getElementById('jokerBtn').style.display = 'none';
            document.getElementById('options').style.display = 'none';
            document.getElementById('loading').style.display = 'none';
            
            // Resetear botones de puntuación
            document.getElementById('saveScoreBtn').disabled = false;
            document.getElementById('saveScoreBtn').textContent = '💾 Guardar Puntuación';
            document.getElementById('nameInputContainer').style.display = 'none';
            document.getElementById('rankingContainer').style.display = 'none';
            document.getElementById('showRankingBtn').style.display = 'none';
            
            // Ocultar botón de ranking al reiniciar
            document.getElementById('viewRankingBtn').style.display = 'none';
            document.getElementById('mainRankingContainer').style.display = 'none';
            
            // Ocultar contenedor de ranking de dificultad si está visible
            const difficultyRankingContainer = document.getElementById('difficultyRankingContainer');
            if (difficultyRankingContainer) {
                difficultyRankingContainer.style.display = 'none';
            }
            
            // Mostrar selector de dificultad
            document.getElementById('difficultySelector').style.display = 'block';
            document.body.classList.add('difficulty-selector-active');
            
            // Crear partículas flotantes en el selector de dificultad
            createDifficultySelectorParticles();
            
            // Actualizar corazones
            updateHearts();
        }

        // Actualizar racha
        function updateStreak(isCorrect) {
            const fireEl = document.getElementById('streakFire');
            
            if (isCorrect) {
                streak++;
                // Actualizar máxima racha
                if (streak > maxStreak) {
                    maxStreak = streak;
                }
                // Hacer el fuego más intenso cuando la racha es alta
                // En modo imposible, se activa con 2 de racha
                const requiredStreak = difficulty === 'impossible' ? 2 : 5;
                if (streak >= requiredStreak) {
                    fireEl.classList.add('hot');
                }
            } else {
                streak = 0;
                jokerAvailable = false;
                jokerUsed = false;
                fireEl.classList.remove('hot');
            }
            
            document.getElementById('streak').textContent = streak;
            updateJokerButton();
        }

        // Frases motivadoras para aciertos
        const successMessages = [
            'Good boooy! 😊🎉',
            '¡Excelente! 😄🌟',
            '¡Perfecto! 😃⭐',
            '¡Increíble! 🤩🚀',
            '¡Genial! 😎💪',
            '¡Fantástico! 😁🎊',
            '¡Bien hecho! 😊👏',
            '¡Así se hace! 😄🔥',
            '¡Eres un crack! 🤩💎',
            '¡Sigue así! 😃🎯',
            '¡Increíble trabajo! 😊✨',
            '¡Lo hiciste genial! 😄🎉',
            '¡Perfecto! 😃👌',
            '¡Eres increíble! 🤩🌟',
            '¡Bien jugado! 😊💪'
        ];

        // Frases motivadoras para fallos
        const errorMessages = [
            '¡Casi! Sigue intentando 😊💪',
            'No te rindas, sigue adelante 😌🌟',
            'La próxima será mejor 😊🎯',
            '¡Sigue practicando! 😄💪',
            'Cada error es aprendizaje 😊📚',
            '¡Tú puedes! Sigue adelante 😃🚀',
            'No pasa nada, sigue jugando 😊',
            'La práctica hace al maestro 😌🎓',
            '¡Sigue intentando! 😊💪',
            'Cada intento te acerca más 😄🎯',
            '¡Ánimo! Lo conseguirás 😊✨',
            'Sigue adelante, tú puedes 😃💪',
            'No te desanimes 😌🌟',
            '¡La próxima vez será mejor! 😊🎯',
            'Sigue intentando, lo lograrás 😄💪'
        ];

        // Crear cohetes animados
        function createRockets() {
            const container = document.body;
            const rocketCount = 15;
            
            for (let i = 0; i < rocketCount; i++) {
                const rocket = document.createElement('div');
                rocket.className = 'rocket';
                rocket.textContent = '🚀';
                rocket.style.position = 'fixed';
                rocket.style.fontSize = '2em';
                rocket.style.pointerEvents = 'none';
                rocket.style.zIndex = '3000';
                
                // Posición inicial aleatoria
                const startX = Math.random() * window.innerWidth;
                const startY = window.innerHeight + 50;
                const endX = startX + (Math.random() - 0.5) * 200;
                const endY = -100;
                
                rocket.style.left = startX + 'px';
                rocket.style.top = startY + 'px';
                
                // Animación
                const angle = Math.atan2(endY - startY, endX - startX) * 180 / Math.PI;
                rocket.style.transform = `rotate(${angle + 90}deg)`;
                
                container.appendChild(rocket);
                
                // Animar cohete
                setTimeout(() => {
                    rocket.style.transition = 'all 2s ease-out';
                    rocket.style.left = endX + 'px';
                    rocket.style.top = endY + 'px';
                    rocket.style.opacity = '0';
                    rocket.style.transform = `rotate(${angle + 90}deg) scale(0.5)`;
                }, 10);
                
                // Remover cohete después de la animación
                setTimeout(() => {
                    if (container.contains(rocket)) {
                        container.removeChild(rocket);
                    }
                }, 2000);
            }
        }

        // Mostrar alerta estilizada
        function showAlert(type, message, details) {
            // Si es acierto, crear cohetes
            if (type === 'success') {
                createRockets();
            }
            
            const overlay = document.createElement('div');
            overlay.className = 'alert-overlay';
            
            const alertBox = document.createElement('div');
            alertBox.className = `alert-box ${type}`;
            
            const icon = document.createElement('div');
            icon.className = 'alert-icon';
            icon.textContent = type === 'success' ? '✅' : '❌';
            
            const messageEl = document.createElement('div');
            messageEl.className = 'alert-message';
            // Usar frase aleatoria
            if (type === 'success') {
                messageEl.textContent = successMessages[Math.floor(Math.random() * successMessages.length)];
            } else {
                messageEl.textContent = errorMessages[Math.floor(Math.random() * errorMessages.length)];
            }
            
            const detailsEl = document.createElement('div');
            detailsEl.className = 'alert-details';
            detailsEl.textContent = details;
            
            alertBox.appendChild(icon);
            alertBox.appendChild(messageEl);
            alertBox.appendChild(detailsEl);
            overlay.appendChild(alertBox);
            
            document.body.appendChild(overlay);
            
            // Remover después de 1.5 segundos
            setTimeout(() => {
                overlay.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => {
                    if (document.body.contains(overlay)) {
                        document.body.removeChild(overlay);
                    }
                }, 300);
            }, 1500);
        }

        // Actualizar botón comodín
        function updateJokerButton() {
            const jokerBtn = document.getElementById('jokerBtn');
            
            // En modo imposible, el comodín se activa con 2 de racha
            // En otros modos, se activa con 5 de racha
            const requiredStreak = difficulty === 'impossible' ? 2 : 5;
            
            if (streak >= requiredStreak && !jokerUsed) {
                jokerAvailable = true;
                if (jokerBtn) {
                    jokerBtn.style.display = 'block';
                }
            } else {
                jokerAvailable = false;
                if (jokerBtn) {
                    jokerBtn.style.display = 'none';
                }
            }
        }

        // Usar comodín
        function useJoker() {
            if (!jokerAvailable || jokerUsed || answered) return;

            jokerUsed = true;
            jokerAvailable = false;
            document.getElementById('jokerBtn').style.display = 'none';

            // Encontrar la respuesta correcta
            const correctAnswer = currentCountry.name.common;
            
            // Obtener todos los botones incorrectos
            const incorrectButtons = [];
            [1, 2, 3, 4].forEach(i => {
                const btn = document.getElementById(`option${i}`);
                if (btn.textContent !== correctAnswer) {
                    incorrectButtons.push(btn);
                }
            });

            // Eliminar 2 opciones incorrectas aleatoriamente
            const toRemove = incorrectButtons
                .sort(() => Math.random() - 0.5)
                .slice(0, 2);

            toRemove.forEach(btn => {
                btn.style.display = 'none';
                btn.disabled = true;
            });

            // Reducir la racha (se usó el comodín)
            // En modo imposible, se reduce en 2. En otros modos, en 5
            const streakReduction = difficulty === 'impossible' ? 2 : 5;
            streak = Math.max(0, streak - streakReduction);
            document.getElementById('streak').textContent = streak;
            
            // Actualizar el fuego
            const fireEl = document.getElementById('streakFire');
            const requiredStreak = difficulty === 'impossible' ? 2 : 5;
            if (streak < requiredStreak) {
                fireEl.classList.remove('hot');
            }
            
            updateJokerButton();
        }

        // Manejar selección de opción
        function selectOption(optionNumber) {
            if (answered) return;
            
            // Verificar que currentCountry esté definido
            if (!currentCountry || !currentCountry.name || !currentCountry.name.common) {
                console.error('Error: currentCountry no está definido');
                alert('Error: No hay país seleccionado. Por favor, recarga la página.');
                return;
            }

            // Detener temporizador
            stopTimer();

            const selectedBtn = document.getElementById(`option${optionNumber}`);
            const selectedText = selectedBtn.textContent;
            const isCorrect = selectedText === currentCountry.name.common;

            answered = true;

            // Deshabilitar todos los botones
            [1, 2, 3, 4].forEach(i => {
                const btn = document.getElementById(`option${i}`);
                if (btn.style.display !== 'none') {
                    btn.disabled = true;
                    
                    if (btn.textContent === currentCountry.name.common) {
                        btn.classList.add('correct');
                    } else if (btn === selectedBtn && !isCorrect) {
                        btn.classList.add('incorrect');
                    }
                }
            });

            // Actualizar racha
            updateStreak(isCorrect);

            // Mostrar mensaje
            const messageEl = document.getElementById('message');
            if (isCorrect) {
                score++;
                messageEl.textContent = '¡Correcto! 🎉';
                messageEl.className = 'message correct';
                
                // Actualizar puntuación
                document.getElementById('score').textContent = score;
                
                // Mostrar alerta de acierto (con cohetes y frase motivadora)
                showAlert('success', '', '');
                
                // Pasar automáticamente a la siguiente bandera después de 2 segundos
                setTimeout(() => {
                    loadNewQuestion();
                }, 2000);
            } else {
                // Restar una vida
                lives--;
                updateHearts();
                
                messageEl.textContent = `Incorrecto. La respuesta correcta es: ${currentCountry.name.common}`;
                messageEl.className = 'message incorrect';
                
                // Actualizar puntuación
                document.getElementById('score').textContent = score;
                
                // Mostrar alerta de fallo (con frase motivadora)
                showAlert('error', '', `La respuesta correcta era: ${currentCountry.name.common}`);
                
                // Si se acabaron las vidas, mostrar game over
                if (lives <= 0) {
                    setTimeout(() => {
                        showGameOver();
                    }, 2000);
                } else {
                    // Pasar automáticamente a la siguiente bandera después de 2 segundos
                    setTimeout(() => {
                        loadNewQuestion();
                    }, 2000);
                }
            }
        }

        // Event listeners
        document.getElementById('option1').addEventListener('click', () => selectOption(1));
        document.getElementById('option2').addEventListener('click', () => selectOption(2));
        document.getElementById('option3').addEventListener('click', () => selectOption(3));
        document.getElementById('option4').addEventListener('click', () => selectOption(4));
        document.getElementById('jokerBtn').addEventListener('click', useJoker);
        document.getElementById('nextBtn').addEventListener('click', loadNewQuestion);
        document.getElementById('endAttemptBtn').addEventListener('click', endAttempt);
        
        // Crear partículas en el selector de dificultad al cargar la página
        const difficultySelector = document.getElementById('difficultySelector');
        if (difficultySelector && (difficultySelector.style.display !== 'none' && difficultySelector.style.display !== '')) {
            document.body.classList.add('difficulty-selector-active');
            createDifficultySelectorParticles();
        } else if (difficultySelector && !difficultySelector.style.display) {
            // Si no tiene estilo display definido, está visible por defecto
            document.body.classList.add('difficulty-selector-active');
            createDifficultySelectorParticles();
        }

        // Event listeners para selección de dificultad
        document.getElementById('easyBtn').addEventListener('click', () => selectDifficulty('easy'));
        document.getElementById('hardBtn').addEventListener('click', () => selectDifficulty('hard'));
        document.getElementById('impossibleBtn').addEventListener('click', () => selectDifficulty('impossible'));
        document.getElementById('godBtn').addEventListener('click', () => selectDifficulty('god'));
        document.getElementById('restartBtn').addEventListener('click', restartGame);
        document.getElementById('saveScoreBtn').addEventListener('click', saveScore);
        document.getElementById('showRankingBtn').addEventListener('click', loadRanking);
        document.getElementById('logoutBtn').addEventListener('click', handleLogout);
        const profileLogoutBtn = document.getElementById('profileLogoutBtn');
        if (profileLogoutBtn) {
            profileLogoutBtn.addEventListener('click', async () => {
                // Cerrar modal primero
                if (window.hideProfileModal) {
                    window.hideProfileModal();
                }
                // Luego cerrar sesión
                await handleLogout();
            });
        }

        // Event listeners para sistema de amigos
        const profileFriendsBtn = document.getElementById('profileFriendsBtn');
        if (profileFriendsBtn) {
            profileFriendsBtn.addEventListener('click', () => {
                if (window.showFriendsModal) {
                    window.showFriendsModal();
                }
            });
        }

        const profileInboxBtn = document.getElementById('profileInboxBtn');
        if (profileInboxBtn) {
            profileInboxBtn.addEventListener('click', async () => {
                if (window.showInboxModal) {
                    await window.showInboxModal();
                }
                // Ya no se abren las recomendaciones aquí, van en el buzón
            });
        }

        const profileRecommendationsInboxBtn = document.getElementById('profileRecommendationsInboxBtn');
        if (profileRecommendationsInboxBtn) {
            profileRecommendationsInboxBtn.addEventListener('click', async () => {
                const recommendationsInboxModal = document.getElementById('recommendationsInboxModal');
                if (recommendationsInboxModal && window.loadRecommendations) {
                    recommendationsInboxModal.style.display = 'flex';
                    await window.loadRecommendations();
                }
            });
        }

        // Event listeners para buzón de correo
        const profileMailboxBtn = document.getElementById('profileMailboxBtn');
        if (profileMailboxBtn) {
            profileMailboxBtn.addEventListener('click', async () => {
                // Para mpenalvart1, el buzón muestra las recomendaciones
                if (window.currentUser && window.currentUser.email === 'mpenalvart1@educacion.navarra.es') {
                    const recommendationsInboxModal = document.getElementById('recommendationsInboxModal');
                    if (recommendationsInboxModal && window.loadRecommendations) {
                        recommendationsInboxModal.style.display = 'flex';
                        await window.loadRecommendations();
                    }
                } else {
                    // Para otros usuarios, muestra los mensajes del buzón normal
                    const mailboxModal = document.getElementById('mailboxModal');
                    if (mailboxModal && window.loadMailboxMessages) {
                        mailboxModal.style.display = 'flex';
                        await window.loadMailboxMessages();
                    }
                }
            });
        }

        const mailboxModal = document.getElementById('mailboxModal');
        const mailboxModalClose = document.getElementById('mailboxModalClose');
        if (mailboxModalClose) {
            mailboxModalClose.addEventListener('click', () => {
                if (mailboxModal) {
                    mailboxModal.style.display = 'none';
                }
            });
        }

        if (mailboxModal) {
            mailboxModal.addEventListener('click', (e) => {
                if (e.target === mailboxModal) {
                    mailboxModal.style.display = 'none';
                }
            });
        }

        // Event listeners para enviar mensaje (solo mpenalvart1)
        const profileSendMailBtn = document.getElementById('profileSendMailBtn');
        if (profileSendMailBtn) {
            profileSendMailBtn.addEventListener('click', () => {
                const sendMailModal = document.getElementById('sendMailModal');
                if (sendMailModal) {
                    sendMailModal.style.display = 'flex';
                    const searchInput = document.getElementById('sendMailSearchInput');
                    if (searchInput) {
                        searchInput.value = '';
                        searchInput.focus();
                    }
                }
            });
        }

        const sendMailModal = document.getElementById('sendMailModal');
        const sendMailModalClose = document.getElementById('sendMailModalClose');
        if (sendMailModalClose) {
            sendMailModalClose.addEventListener('click', () => {
                if (sendMailModal) {
                    sendMailModal.style.display = 'none';
                    // Limpiar formulario
                    const compose = document.getElementById('sendMailCompose');
                    const results = document.getElementById('sendMailResults');
                    if (compose) compose.style.display = 'none';
                    if (results) results.innerHTML = '';
                }
            });
        }

        if (sendMailModal) {
            sendMailModal.addEventListener('click', (e) => {
                if (e.target === sendMailModal) {
                    sendMailModal.style.display = 'none';
                }
            });
        }

        const sendMailSearchBtn = document.getElementById('sendMailSearchBtn');
        if (sendMailSearchBtn) {
            sendMailSearchBtn.addEventListener('click', async () => {
                if (window.searchUsersForMail) {
                    await window.searchUsersForMail();
                }
            });
        }

        const sendMailSearchInput = document.getElementById('sendMailSearchInput');
        if (sendMailSearchInput) {
            sendMailSearchInput.addEventListener('keypress', async (e) => {
                if (e.key === 'Enter' && window.searchUsersForMail) {
                    await window.searchUsersForMail();
                }
            });
        }

        const sendMailSubmitBtn = document.getElementById('sendMailSubmitBtn');
        if (sendMailSubmitBtn) {
            sendMailSubmitBtn.addEventListener('click', async () => {
                if (window.sendMailToUser) {
                    await window.sendMailToUser();
                }
            });
        }

        const recommendationsInboxModal = document.getElementById('recommendationsInboxModal');
        const recommendationsInboxModalClose = document.getElementById('recommendationsInboxModalClose');
        if (recommendationsInboxModalClose) {
            recommendationsInboxModalClose.addEventListener('click', () => {
                if (recommendationsInboxModal) {
                    recommendationsInboxModal.style.display = 'none';
                }
            });
        }

        if (recommendationsInboxModal) {
            recommendationsInboxModal.addEventListener('click', (e) => {
                if (e.target === recommendationsInboxModal) {
                    recommendationsInboxModal.style.display = 'none';
                }
            });
        }

        const profileToggleScoresBtn = document.getElementById('profileToggleScoresBtn');
        if (profileToggleScoresBtn) {
            profileToggleScoresBtn.addEventListener('click', () => {
                if (window.toggleScoresVisibility) {
                    window.toggleScoresVisibility();
                }
            });
        }

        // Toggle para estilos de perfil
        const profileStyleSelectorToggle = document.getElementById('profileStyleSelectorToggle');
        if (profileStyleSelectorToggle) {
            profileStyleSelectorToggle.addEventListener('click', () => {
                profileStyleSelectorToggle.classList.toggle('expanded');
            });
        }

        // Toggle para decoraciones de perfil
        const profileDecorationSelectorToggle = document.getElementById('profileDecorationSelectorToggle');
        if (profileDecorationSelectorToggle) {
            profileDecorationSelectorToggle.addEventListener('click', () => {
                profileDecorationSelectorToggle.classList.toggle('expanded');
            });
        }

        const friendProfileModalClose = document.getElementById('friendProfileModalClose');
        if (friendProfileModalClose) {
            friendProfileModalClose.addEventListener('click', () => {
                if (window.hideFriendProfileModal) {
                    window.hideFriendProfileModal();
                }
            });
        }

        // Cerrar modal de perfil de amigo al hacer clic fuera
        const friendProfileModal = document.getElementById('friendProfileModal');
        if (friendProfileModal) {
            friendProfileModal.addEventListener('click', (e) => {
                if (e.target === friendProfileModal) {
                    if (window.hideFriendProfileModal) {
                        window.hideFriendProfileModal();
                    }
                }
            });
        }

        // Event listener para guardar descripción
        const profileSaveDescriptionBtn = document.getElementById('profileSaveDescriptionBtn');
        if (profileSaveDescriptionBtn) {
            profileSaveDescriptionBtn.addEventListener('click', async () => {
                if (window.saveProfileDescription) {
                    await window.saveProfileDescription();
                }
            });
        }

        // Event listeners para crear grupo
        const createGroupBtn = document.getElementById('createGroupBtn');
        if (createGroupBtn) {
            createGroupBtn.addEventListener('click', () => {
                const createGroupModal = document.getElementById('createGroupModal');
                if (createGroupModal) {
                    createGroupModal.style.display = 'flex';
                    const searchInput = document.getElementById('groupUserSearch');
                    if (searchInput) {
                        searchInput.value = '';
                        searchInput.focus();
                    }
                    // Limpiar selección anterior
                    window.selectedGroupUsers = [];
                    if (window.updateGroupSelectedUsers) window.updateGroupSelectedUsers();
                    if (window.updateGroupSearchResults) window.updateGroupSearchResults([]);
                }
            });
        }

        const createGroupModal = document.getElementById('createGroupModal');
        const createGroupModalClose = document.getElementById('createGroupModalClose');
        if (createGroupModalClose) {
            createGroupModalClose.addEventListener('click', () => {
                if (createGroupModal) {
                    createGroupModal.style.display = 'none';
                    // Limpiar variables cuando se cierra el modal
                    window.currentAddMembersGroupId = null;
                    window.currentAddMembersExistingMembers = null;
                    window.selectedGroupUsers = [];
                    // Restaurar título y botón
                    const modalTitle = createGroupModal.querySelector('h2');
                    if (modalTitle) {
                        modalTitle.textContent = 'Crear Grupo';
                    }
                    const groupNextBtn = document.getElementById('groupNextBtn');
                    if (groupNextBtn) {
                        groupNextBtn.textContent = 'Siguiente';
                    }
                }
            });
        }

        if (createGroupModal) {
            createGroupModal.addEventListener('click', (e) => {
                if (e.target === createGroupModal) {
                    createGroupModal.style.display = 'none';
                    // Limpiar variables cuando se cierra el modal
                    window.currentAddMembersGroupId = null;
                    window.currentAddMembersExistingMembers = null;
                    window.selectedGroupUsers = [];
                    // Restaurar título y botón
                    const modalTitle = createGroupModal.querySelector('h2');
                    if (modalTitle) {
                        modalTitle.textContent = 'Crear Grupo';
                    }
                    const groupNextBtn = document.getElementById('groupNextBtn');
                    if (groupNextBtn) {
                        groupNextBtn.textContent = 'Siguiente';
                    }
                }
            });
        }

        const groupUserSearch = document.getElementById('groupUserSearch');
        if (groupUserSearch) {
            let searchTimeout;
            groupUserSearch.addEventListener('input', async (e) => {
                clearTimeout(searchTimeout);
                const searchTerm = e.target.value.trim();
                if (searchTerm.length < 2) {
                    if (window.updateGroupSearchResults) window.updateGroupSearchResults([]);
                    return;
                }
                searchTimeout = setTimeout(async () => {
                    if (window.searchUsers) {
                        const users = await window.searchUsers(searchTerm);
                        if (window.updateGroupSearchResults) window.updateGroupSearchResults(users);
                    }
                }, 300);
            });
        }

        const groupNextBtn = document.getElementById('groupNextBtn');
        if (groupNextBtn) {
            groupNextBtn.addEventListener('click', async () => {
                if (window.selectedGroupUsers && window.selectedGroupUsers.length > 0) {
                    // Si estamos añadiendo miembros a un grupo existente
                    if (window.currentAddMembersGroupId) {
                        const userIds = window.selectedGroupUsers.map(u => u.id);
                        if (window.addMembersToGroup) {
                            await window.addMembersToGroup(window.currentAddMembersGroupId, userIds);
                        }
                    } else {
                        // Si estamos creando un nuevo grupo
                        const createGroupModal = document.getElementById('createGroupModal');
                        const createGroupNameModal = document.getElementById('createGroupNameModal');
                        if (createGroupModal) createGroupModal.style.display = 'none';
                        if (createGroupNameModal) {
                            createGroupNameModal.style.display = 'flex';
                            if (window.updateGroupNamePreview) window.updateGroupNamePreview();
                            const nameInput = document.getElementById('groupNameInput');
                            if (nameInput) {
                                nameInput.value = '';
                                nameInput.focus();
                            }
                        }
                    }
                }
            });
        }

        const groupCancelBtn = document.getElementById('groupCancelBtn');
        if (groupCancelBtn) {
            groupCancelBtn.addEventListener('click', () => {
                const createGroupModal = document.getElementById('createGroupModal');
                if (createGroupModal) {
                    createGroupModal.style.display = 'none';
                    // Limpiar variables cuando se cierra el modal
                    window.currentAddMembersGroupId = null;
                    window.currentAddMembersExistingMembers = null;
                    window.selectedGroupUsers = [];
                    // Restaurar título y botón
                    const modalTitle = createGroupModal.querySelector('h2');
                    if (modalTitle) {
                        modalTitle.textContent = 'Crear Grupo';
                    }
                    const groupNextBtn = document.getElementById('groupNextBtn');
                    if (groupNextBtn) {
                        groupNextBtn.textContent = 'Siguiente';
                    }
                }
            });
        }

        const createGroupNameModal = document.getElementById('createGroupNameModal');
        const createGroupNameModalClose = document.getElementById('createGroupNameModalClose');
        if (createGroupNameModalClose) {
            createGroupNameModalClose.addEventListener('click', () => {
                if (createGroupNameModal) {
                    createGroupNameModal.style.display = 'none';
                }
            });
        }

        if (createGroupNameModal) {
            createGroupNameModal.addEventListener('click', (e) => {
                if (e.target === createGroupNameModal) {
                    createGroupNameModal.style.display = 'none';
                }
            });
        }

        const groupNameInput = document.getElementById('groupNameInput');
        if (groupNameInput) {
            groupNameInput.addEventListener('input', (e) => {
                const createBtn = document.getElementById('groupCreateBtn');
                if (createBtn) {
                    createBtn.disabled = !e.target.value.trim();
                }
            });
        }

        const groupCreateBtn = document.getElementById('groupCreateBtn');
        if (groupCreateBtn) {
            groupCreateBtn.addEventListener('click', async () => {
                if (window.createGroup) {
                    await window.createGroup();
                }
            });
        }

        const groupNameBackBtn = document.getElementById('groupNameBackBtn');
        if (groupNameBackBtn) {
            groupNameBackBtn.addEventListener('click', () => {
                const createGroupModal = document.getElementById('createGroupModal');
                const createGroupNameModal = document.getElementById('createGroupNameModal');
                if (createGroupNameModal) createGroupNameModal.style.display = 'none';
                if (createGroupModal) createGroupModal.style.display = 'flex';
            });
        }

        // Event listeners para modal de llamada
        const callModalAccept = document.getElementById('callModalAccept');
        const callModalReject = document.getElementById('callModalReject');
        
        if (callModalAccept) {
            callModalAccept.addEventListener('click', () => {
                if (window.acceptCall) {
                    window.acceptCall();
                }
            });
        }
        
        if (callModalReject) {
            callModalReject.addEventListener('click', () => {
                if (window.rejectCall) {
                    window.rejectCall();
                }
            });
        }

        // Event listener para cancelar llamada saliente
        const outgoingCallCancel = document.getElementById('outgoingCallCancel');
        if (outgoingCallCancel) {
            outgoingCallCancel.addEventListener('click', () => {
                if (window.cancelOutgoingCall) {
                    window.cancelOutgoingCall();
                }
            });
        }

        // Event listeners para modal de información del grupo
        const groupInfoModal = document.getElementById('groupInfoModal');
        const groupInfoModalClose = document.getElementById('groupInfoModalClose');
        if (groupInfoModalClose) {
            groupInfoModalClose.addEventListener('click', () => {
                if (groupInfoModal) {
                    groupInfoModal.style.display = 'none';
                }
            });
        }

        if (groupInfoModal) {
            groupInfoModal.addEventListener('click', (e) => {
                if (e.target === groupInfoModal) {
                    groupInfoModal.style.display = 'none';
                }
            });
        }

        const groupChangePictureBtn = document.getElementById('groupChangePictureBtn');
        if (groupChangePictureBtn) {
            groupChangePictureBtn.addEventListener('click', async () => {
                const groupInfoModal = document.getElementById('groupInfoModal');
                if (groupInfoModal && groupInfoModal.dataset.grupoId) {
                    if (window.changeGroupPicture) {
                        await window.changeGroupPicture(groupInfoModal.dataset.grupoId);
                    }
                }
            });
        }

        const groupAddMembersBtn = document.getElementById('groupAddMembersBtn');
        if (groupAddMembersBtn) {
            groupAddMembersBtn.addEventListener('click', async () => {
                const groupInfoModal = document.getElementById('groupInfoModal');
                if (groupInfoModal && groupInfoModal.dataset.grupoId) {
                    if (window.showAddMembersModal) {
                        await window.showAddMembersModal(groupInfoModal.dataset.grupoId);
                    }
                }
            });
        }

        // Event listeners para chat
        const activeChatSendBtn = document.getElementById('activeChatSendBtn');
        const activeChatInput = document.getElementById('activeChatInput');
        const activeChatClose = document.getElementById('activeChatClose');
        const activeChatCall = document.getElementById('activeChatCall');
        const emojiBtn = document.getElementById('emojiBtn');
        const emojiPicker = document.getElementById('emojiPicker');
        const emojiGrid = document.getElementById('emojiGrid');
        
        // Emojis populares
        const commonEmojis = ['😀', '😂', '😍', '🥰', '😎', '😊', '🙂', '🤗', '😴', '😋', 
                             '🤔', '😮', '😱', '👍', '👎', '❤️', '💯', '🔥', '⭐', '🎉',
                             '😢', '😡', '🤯', '💪', '👏', '🙌', '🤝', '🙏', '💖', '💕',
                             '🎂', '🎁', '🎈', '🎊', '⚽', '🏀', '🏆', '🎮', '🎵', '🎬',
                             '🌍', '🌎', '🌏', '🌞', '🌙', '⭐', '🌟', '🌈', '☀️', '⛈️',
                             '🚀', '✈️', '🚗', '🚕', '🚙', '🚌', '🚎', '🏎️', '🚓', '🚑',
                             '🐶', '🐱', '🐭', '🐹', '🐰', '🦊', '🐻', '🐼', '🐨', '🐯'];
        
        // Cargar emojis en el grid
        if (emojiGrid) {
            commonEmojis.forEach(emoji => {
                const emojiItem = document.createElement('div');
                emojiItem.className = 'emoji-item';
                emojiItem.textContent = emoji;
                emojiItem.addEventListener('click', () => {
                    if (activeChatInput) {
                        activeChatInput.value += emoji;
                        activeChatInput.focus();
                        // Autoajustar altura del textarea
                        activeChatInput.style.height = 'auto';
                        activeChatInput.style.height = activeChatInput.scrollHeight + 'px';
                    }
                });
                emojiGrid.appendChild(emojiItem);
            });
        }
        
        // Toggle emoji picker
        if (emojiBtn && emojiPicker) {
            emojiBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                emojiPicker.classList.toggle('show');
            });
        }
        
        // Cerrar emoji picker al hacer clic fuera
        document.addEventListener('click', (e) => {
            if (emojiPicker && emojiBtn && !emojiPicker.contains(e.target) && !emojiBtn.contains(e.target)) {
                emojiPicker.classList.remove('show');
            }
        });
        
        // Autoajustar altura del textarea
        if (activeChatInput) {
            activeChatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
            
            activeChatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (window.sendChatMessage) {
                        window.sendChatMessage();
                    }
                }
            });
        }
        
        if (activeChatSendBtn) {
            activeChatSendBtn.addEventListener('click', () => {
                if (window.sendChatMessage) {
                    window.sendChatMessage();
                }
            });
        }
        
        if (activeChatClose) {
            activeChatClose.addEventListener('click', (e) => {
                e.stopPropagation();
                if (window.closeChat) {
                    window.closeChat();
                }
            });
        }

        if (activeChatCall) {
            activeChatCall.addEventListener('click', (e) => {
                e.stopPropagation();
                if (window.startCall) {
                    window.startCall();
                }
            });
        }

        // Event listeners para biblioteca
        const libraryImageInput = document.getElementById('libraryImageInput');
        if (libraryImageInput) {
            libraryImageInput.addEventListener('change', async (e) => {
                const files = Array.from(e.target.files);
                if (files.length > 0) {
                    for (const file of files) {
                        await window.uploadLibraryImage(file);
                    }
                    e.target.value = ''; // Limpiar input
                }
            });
        }

        const libraryImageModalClose = document.getElementById('libraryImageModalClose');
        if (libraryImageModalClose) {
            libraryImageModalClose.addEventListener('click', () => {
                if (window.hideLibraryImage) {
                    window.hideLibraryImage();
                }
            });
        }

        const libraryImageModal = document.getElementById('libraryImageModal');
        if (libraryImageModal) {
            libraryImageModal.addEventListener('click', (e) => {
                if (e.target === libraryImageModal) {
                    if (window.hideLibraryImage) {
                        window.hideLibraryImage();
                    }
                }
            });
        }

        // Event listeners para el modal de zoom
        const libraryImageZoomCloseBack = document.getElementById('libraryImageZoomCloseBack');
        if (libraryImageZoomCloseBack) {
            libraryImageZoomCloseBack.addEventListener('click', () => {
                if (window.hideLibraryImageZoom) {
                    window.hideLibraryImageZoom();
                }
            });
        }

        const libraryImageZoomCloseAll = document.getElementById('libraryImageZoomCloseAll');
        if (libraryImageZoomCloseAll) {
            libraryImageZoomCloseAll.addEventListener('click', () => {
                if (window.hideLibraryImage) {
                    window.hideLibraryImage();
                }
            });
        }

        // Cerrar zoom al hacer click fuera de la imagen
        const libraryImageZoomModal = document.getElementById('libraryImageZoomModal');
        if (libraryImageZoomModal) {
            libraryImageZoomModal.addEventListener('click', (e) => {
                if (e.target === libraryImageZoomModal) {
                    if (window.hideLibraryImageZoom) {
                        window.hideLibraryImageZoom();
                    }
                }
            });
        }

        // Event listeners para información del creador
        const creatorInfoBtn = document.getElementById('creatorInfoBtn');
        const creatorInfoModal = document.getElementById('creatorInfoModal');
        const creatorInfoClose = document.getElementById('creatorInfoClose');

        // La función loadCreatorInfo se define en el módulo de Firebase

        if (creatorInfoBtn) {
            creatorInfoBtn.addEventListener('click', async () => {
                if (creatorInfoModal && window.loadCreatorInfo) {
                    await window.loadCreatorInfo();
                    creatorInfoModal.classList.add('active');
                }
            });
        }

        if (creatorInfoClose) {
            creatorInfoClose.addEventListener('click', () => {
                if (creatorInfoModal) {
                    creatorInfoModal.classList.remove('active');
                }
            });
        }

        if (creatorInfoModal) {
            creatorInfoModal.addEventListener('click', (e) => {
                if (e.target === creatorInfoModal) {
                    creatorInfoModal.classList.remove('active');
                }
            });
        }

        // Event listeners para recomendaciones
        const recommendationsBtn = document.getElementById('recommendationsBtn');
        const recommendationsModal = document.getElementById('recommendationsModal');
        const recommendationsModalClose = document.getElementById('recommendationsModalClose');
        const recommendationSubmitBtn = document.getElementById('recommendationSubmitBtn');
        const recommendationText = document.getElementById('recommendationText');

        if (recommendationsBtn) {
            recommendationsBtn.addEventListener('click', () => {
                if (recommendationsModal) {
                    recommendationsModal.style.display = 'flex';
                    if (recommendationText) {
                        recommendationText.value = '';
                        recommendationText.focus();
                    }
                }
            });
        }

        if (recommendationsModalClose) {
            recommendationsModalClose.addEventListener('click', () => {
                if (recommendationsModal) {
                    recommendationsModal.style.display = 'none';
                }
            });
        }

        if (recommendationsModal) {
            recommendationsModal.addEventListener('click', (e) => {
                if (e.target === recommendationsModal) {
                    recommendationsModal.style.display = 'none';
                }
            });
        }

        if (recommendationSubmitBtn) {
            recommendationSubmitBtn.addEventListener('click', async () => {
                if (window.sendRecommendation) {
                    await window.sendRecommendation();
                }
            });
        }

        if (recommendationText) {
            recommendationText.addEventListener('keypress', async (e) => {
                if (e.key === 'Enter' && e.ctrlKey) {
                    if (window.sendRecommendation) {
                        await window.sendRecommendation();
                    }
                }
            });
        }

        // Event listeners para likes y comentarios
        // Variables globales para la foto actual en el modal (declaradas antes de los event listeners)
        window.currentFotoId = null;
        window.currentFotoOwnerId = null;

        // Event listeners para likes y comentarios (usando delegación de eventos)
        document.addEventListener('click', async (e) => {
            // Botón de like
            if (e.target.closest('#libraryImageLikeBtn')) {
                e.preventDefault();
                e.stopPropagation();
                console.log('Botón de like clickeado, currentFotoId:', window.currentFotoId);
                if (window.currentFotoId && window.toggleFotoLike) {
                    try {
                        await window.toggleFotoLike(window.currentFotoId);
                    } catch (error) {
                        console.error('Error al dar like:', error);
                        alert('Error al dar like. Por favor, intenta de nuevo.');
                    }
                } else {
                    console.error('No hay fotoId o toggleFotoLike no está disponible');
                    if (!window.currentFotoId) {
                        alert('Error: No se pudo identificar la foto. Por favor, cierra y vuelve a abrir la imagen.');
                    }
                }
            }
            
            // Botón de comentario
            if (e.target.closest('#libraryImageCommentSubmit')) {
                e.preventDefault();
                e.stopPropagation();
                const commentInput = document.getElementById('libraryImageCommentInput');
                if (commentInput && window.currentFotoId && window.addFotoComment) {
                    const comentario = commentInput.value.trim();
                    console.log('Botón de comentario clickeado, fotoId:', window.currentFotoId, 'comentario:', comentario);
                    if (comentario) {
                        try {
                            await window.addFotoComment(window.currentFotoId, comentario);
                        } catch (error) {
                            console.error('Error al agregar comentario:', error);
                            alert('Error al agregar el comentario. Por favor, intenta de nuevo.');
                        }
                    } else {
                        alert('Por favor, escribe un comentario antes de enviar.');
                    }
                } else {
                    console.error('No hay fotoId, input o addFotoComment no está disponible');
                    if (!window.currentFotoId) {
                        alert('Error: No se pudo identificar la foto. Por favor, cierra y vuelve a abrir la imagen.');
                    }
                }
            }
        });

        // Event listener para Enter en el campo de comentario
        document.addEventListener('keypress', async (e) => {
            if (e.target.id === 'libraryImageCommentInput' && e.key === 'Enter') {
                e.preventDefault();
                const commentInput = document.getElementById('libraryImageCommentInput');
                if (commentInput && window.currentFotoId && window.addFotoComment) {
                    const comentario = commentInput.value.trim();
                    if (comentario) {
                        try {
                            await window.addFotoComment(window.currentFotoId, comentario);
                        } catch (error) {
                            console.error('Error al agregar comentario:', error);
                            alert('Error al agregar el comentario. Por favor, intenta de nuevo.');
                        }
                    }
                }
            }
        });

        const friendsModalClose = document.getElementById('friendsModalClose');
        if (friendsModalClose) {
            friendsModalClose.addEventListener('click', () => {
                if (window.hideFriendsModal) {
                    window.hideFriendsModal();
                }
            });
        }

        const inboxModalClose = document.getElementById('inboxModalClose');
        if (inboxModalClose) {
            inboxModalClose.addEventListener('click', () => {
                if (window.hideInboxModal) {
                    window.hideInboxModal();
                }
            });
        }

        // Cerrar modales al hacer clic fuera
        const friendsModal = document.getElementById('friendsModal');
        if (friendsModal) {
            friendsModal.addEventListener('click', (e) => {
                if (e.target === friendsModal) {
                    if (window.hideFriendsModal) {
                        window.hideFriendsModal();
                    }
                }
            });
        }

        const inboxModal = document.getElementById('inboxModal');
        if (inboxModal) {
            inboxModal.addEventListener('click', (e) => {
                if (e.target === inboxModal) {
                    if (window.hideInboxModal) {
                        window.hideInboxModal();
                    }
                }
            });
        }

        // Búsqueda de usuarios
        const friendsSearchBtn = document.getElementById('friendsSearchBtn');
        const friendsSearchInput = document.getElementById('friendsSearchInput');
        
        async function performSearch() {
            const searchTerm = friendsSearchInput.value.trim();
            const resultsEl = document.getElementById('friendsResults');
            
            if (!resultsEl) return;
            
            if (searchTerm.length < 2) {
                resultsEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #718096;">Escribe al menos 2 caracteres para buscar</div>';
                return;
            }
            
            resultsEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #718096;">Buscando...</div>';
            
            const users = await window.searchUsers(searchTerm);
            
            if (users.length === 0) {
                resultsEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #718096;">No se encontraron usuarios</div>';
                return;
            }
            
            resultsEl.innerHTML = '';
            users.forEach(user => {
                const userItem = document.createElement('div');
                userItem.className = 'friend-result-item';
                
                const picture = document.createElement('div');
                picture.className = 'friend-result-picture';
                if (user.fotoPerfil) {
                    const img = document.createElement('img');
                    img.src = user.fotoPerfil;
                    picture.appendChild(img);
                } else {
                    picture.textContent = '👤';
                }
                
                const info = document.createElement('div');
                info.className = 'friend-result-info';
                const name = document.createElement('div');
                name.className = 'friend-result-name';
                name.textContent = user.nombre;
                const email = document.createElement('div');
                email.className = 'friend-result-email';
                email.textContent = user.email;
                info.appendChild(name);
                info.appendChild(email);
                
                const actions = document.createElement('div');
                actions.className = 'friend-result-actions';
                
                const sendBtn = document.createElement('button');
                sendBtn.className = 'send-request-btn';
                sendBtn.textContent = '➕ Enviar Solicitud';
                sendBtn.onclick = async () => {
                    sendBtn.disabled = true;
                    sendBtn.textContent = 'Enviando...';
                    const success = await window.sendFriendRequest(user.id);
                    if (success) {
                        sendBtn.textContent = '✓ Enviada';
                        sendBtn.disabled = true;
                    } else {
                        sendBtn.textContent = '➕ Enviar Solicitud';
                        sendBtn.disabled = false;
                    }
                };
                
                actions.appendChild(sendBtn);
                
                userItem.appendChild(picture);
                userItem.appendChild(info);
                userItem.appendChild(actions);
                resultsEl.appendChild(userItem);
            });
        }
        
        if (friendsSearchBtn) {
            friendsSearchBtn.addEventListener('click', performSearch);
        }
        
        if (friendsSearchInput) {
            friendsSearchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
        }
        const viewRankingBtn = document.getElementById('viewRankingBtn');
        if (viewRankingBtn) {
            viewRankingBtn.addEventListener('click', showMainRanking);
        }
        
        const closeRankingBtn = document.getElementById('closeRankingBtn');
        if (closeRankingBtn) {
            closeRankingBtn.addEventListener('click', hideMainRanking);
        }
        
        // Función para inicializar los event listeners de los botones de clasificación
        function initRankingButtons() {
            // Event listeners para botones de clasificación por nivel usando delegación de eventos
            const rankingButtonsContainer = document.querySelector('.ranking-buttons');
            if (rankingButtonsContainer) {
                // Remover listener anterior si existe para evitar duplicados
                rankingButtonsContainer.removeEventListener('click', handleRankingButtonClick);
                rankingButtonsContainer.addEventListener('click', handleRankingButtonClick);
            }
            
            // También agregar listeners directos como respaldo
            const viewRankingEasyBtn = document.getElementById('viewRankingEasyBtn');
            if (viewRankingEasyBtn) {
                viewRankingEasyBtn.removeEventListener('click', handleEasyRankingClick);
                viewRankingEasyBtn.addEventListener('click', handleEasyRankingClick);
            }
            
            const viewRankingHardBtn = document.getElementById('viewRankingHardBtn');
            if (viewRankingHardBtn) {
                viewRankingHardBtn.removeEventListener('click', handleHardRankingClick);
                viewRankingHardBtn.addEventListener('click', handleHardRankingClick);
            }
            
            const viewRankingImpossibleBtn = document.getElementById('viewRankingImpossibleBtn');
            if (viewRankingImpossibleBtn) {
                viewRankingImpossibleBtn.removeEventListener('click', handleImpossibleRankingClick);
                viewRankingImpossibleBtn.addEventListener('click', handleImpossibleRankingClick);
            }
            
            const viewRankingGodBtn = document.getElementById('viewRankingGodBtn');
            if (viewRankingGodBtn) {
                viewRankingGodBtn.removeEventListener('click', handleGodRankingClick);
                viewRankingGodBtn.addEventListener('click', handleGodRankingClick);
            }
        }
        
        // Handler para delegación de eventos
        function handleRankingButtonClick(e) {
            // Buscar el botón clickeado (puede ser el botón mismo o un elemento hijo)
            const button = e.target.closest('.ranking-btn') || e.target;
            if (!button || !button.id) return;
            
            let level = null;
            
            if (button.id === 'viewRankingEasyBtn') {
                level = 'easy';
                console.log('Botón Clasificación Fácil clickeado');
            } else if (button.id === 'viewRankingHardBtn') {
                level = 'hard';
                console.log('Botón Clasificación Difícil clickeado');
            } else if (button.id === 'viewRankingImpossibleBtn') {
                level = 'impossible';
                console.log('Botón Clasificación Imposible clickeado');
            } else if (button.id === 'viewRankingGodBtn') {
                level = 'god';
                console.log('Botón Clasificación Dios clickeado');
            }
            
            if (level) {
                e.preventDefault();
                e.stopPropagation();
                if (window.showRankingByLevel) {
                    window.showRankingByLevel(level);
                } else {
                    console.error('showRankingByLevel no está disponible');
                }
            }
        }
        
        // Handlers individuales para cada botón
        function handleEasyRankingClick(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Botón Clasificación Fácil clickeado (directo)');
            if (window.showRankingByLevel) {
                window.showRankingByLevel('easy');
            } else {
                console.error('showRankingByLevel no está disponible');
            }
        }
        
        function handleHardRankingClick(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Botón Clasificación Difícil clickeado (directo)');
            if (window.showRankingByLevel) {
                window.showRankingByLevel('hard');
            } else {
                console.error('showRankingByLevel no está disponible');
            }
        }
        
        function handleImpossibleRankingClick(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Botón Clasificación Imposible clickeado (directo)');
            if (window.showRankingByLevel) {
                window.showRankingByLevel('impossible');
            } else {
                console.error('showRankingByLevel no está disponible');
            }
        }
        
        function handleGodRankingClick(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Botón Clasificación Dios clickeado (directo)');
            if (window.showRankingByLevel) {
                window.showRankingByLevel('god');
            } else {
                console.error('showRankingByLevel no está disponible');
            }
        }
        
        // Inicializar los botones cuando el DOM esté listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initRankingButtons);
        } else {
            // DOM ya está listo
            initRankingButtons();
        }
        
        // También inicializar después de un pequeño delay para asegurar que todo esté cargado
        setTimeout(initRankingButtons, 100);
        
        // Event listeners para autenticación
        document.getElementById('loginTab').addEventListener('click', () => switchAuthTab('login'));
        document.getElementById('registerTab').addEventListener('click', () => switchAuthTab('register'));
        document.getElementById('loginBtn').addEventListener('click', handleLogin);
        document.getElementById('registerBtn').addEventListener('click', handleRegister);
        
        // Permitir login/registro con Enter
        document.getElementById('loginEmail').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleLogin();
        });
        document.getElementById('loginPassword').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleLogin();
        });
        document.getElementById('registerName').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleRegister();
        });
        document.getElementById('registerEmail').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleRegister();
        });
        document.getElementById('registerPassword').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleRegister();
        });
        
        // Event listeners para foto de perfil
        const profilePictureCircle = document.getElementById('profilePictureCircle');
        const profileModalClose = document.getElementById('profileModalClose');
        const profilePictureInput = document.getElementById('profilePictureInput');
        const profileModal = document.getElementById('profileModal');
        
        if (profilePictureCircle) {
            profilePictureCircle.addEventListener('click', () => {
                if (window.showProfileModal) {
                    window.showProfileModal();
                }
            });
        }
        
        if (profileModalClose) {
            profileModalClose.addEventListener('click', () => {
                if (window.hideProfileModal) {
                    window.hideProfileModal();
                }
            });
        }
        
        // Cerrar modal al hacer clic fuera
        if (profileModal) {
            profileModal.addEventListener('click', (e) => {
                if (e.target === profileModal) {
                    if (window.hideProfileModal) {
                        window.hideProfileModal();
                    }
                }
            });
        }
        
        // Manejar subida de foto
        if (profilePictureInput) {
            profilePictureInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const saveBtn = document.getElementById('profileSaveBtn');
                    if (saveBtn) {
                        saveBtn.style.display = 'block';
                        saveBtn.textContent = '💾 Guardando...';
                        saveBtn.disabled = true;
                    }
                    
                    // Mostrar preview antes de subir
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const largeImg = document.getElementById('profilePictureLargeImg');
                        const largePlaceholder = document.getElementById('profilePictureLargePlaceholder');
                        if (largeImg) {
                            largeImg.src = event.target.result;
                            largeImg.style.display = 'block';
                            if (largePlaceholder) largePlaceholder.style.display = 'none';
                        }
                    };
                    reader.readAsDataURL(file);
                    
                    // Subir foto
                    const success = await window.uploadProfilePicture(file);
                    
                    if (saveBtn) {
                        if (success) {
                            saveBtn.textContent = '✅ Guardado';
                            setTimeout(() => {
                                saveBtn.style.display = 'none';
                            }, 2000);
                        } else {
                            saveBtn.textContent = '❌ Error';
                            saveBtn.disabled = false;
                        }
                    }
                    
                    // Limpiar input
                    e.target.value = '';
                }
            });
        }
        
        // Event listeners para selector de estilos de foto de perfil
        const profileStyleOptions = document.getElementById('profileStyleOptions');
        if (profileStyleOptions) {
            profileStyleOptions.addEventListener('click', async (e) => {
                const styleOption = e.target.closest('.profile-style-option');
                if (styleOption) {
                    const selectedStyle = styleOption.dataset.style;
                    
                    // Actualizar selección visual
                    const allOptions = profileStyleOptions.querySelectorAll('.profile-style-option');
                    allOptions.forEach(option => option.classList.remove('selected'));
                    styleOption.classList.add('selected');
                    
                    // Guardar estilo
                    if (window.saveProfilePictureStyle) {
                        const success = await window.saveProfilePictureStyle(selectedStyle);
                        if (success) {
                            // Actualizar también la foto de perfil pequeña
                            if (window.loadProfilePicture) {
                                await window.loadProfilePicture();
                            }
                        }
                    }
                }
            });
        }

        // Event listeners para selector de decoraciones de foto de perfil
        const profileDecorationOptions = document.getElementById('profileDecorationOptions');
        const profileDecorationOptionsExtra = document.getElementById('profileDecorationOptionsExtra');
        if (profileDecorationOptions) {
            profileDecorationOptions.addEventListener('click', async (e) => {
                const decorationOption = e.target.closest('.profile-decoration-option');
                if (decorationOption) {
                    const selectedDecoration = decorationOption.dataset.decoration;
                    
                    // Actualizar selección visual (incluyendo opciones extra)
                    const allOptions = document.querySelectorAll('.profile-decoration-option');
                    allOptions.forEach(option => option.classList.remove('selected'));
                    decorationOption.classList.add('selected');
                    
                    // Guardar decoración
                    if (window.saveProfilePictureDecoration) {
                        const success = await window.saveProfilePictureDecoration(selectedDecoration);
                        if (success) {
                            // Actualizar también la foto de perfil pequeña
                            if (window.loadProfilePicture) {
                                await window.loadProfilePicture();
                            }
                        }
                    }
                }
            });
        }

        // Event listener para opciones extra de decoraciones
        if (profileDecorationOptionsExtra) {
            profileDecorationOptionsExtra.addEventListener('click', async (e) => {
                const decorationOption = e.target.closest('.profile-decoration-option');
                if (decorationOption) {
                    const selectedDecoration = decorationOption.dataset.decoration;
                    
                    // Actualizar selección visual (incluyendo opciones principales)
                    const allOptions = document.querySelectorAll('.profile-decoration-option');
                    allOptions.forEach(option => option.classList.remove('selected'));
                    decorationOption.classList.add('selected');
                    
                    // Guardar decoración
                    if (window.saveProfilePictureDecoration) {
                        const success = await window.saveProfilePictureDecoration(selectedDecoration);
                        if (success) {
                            // Actualizar también la foto de perfil pequeña
                            if (window.loadProfilePicture) {
                                await window.loadProfilePicture();
                            }
                        }
                    }
                }
            });
        }

        // Event listeners para botones de expansión
        const profileStyleExpandBtn = document.getElementById('profileStyleExpandBtn');
        const profileStyleOptionsExtra = document.getElementById('profileStyleOptionsExtra');
        if (profileStyleExpandBtn && profileStyleOptionsExtra) {
            profileStyleExpandBtn.addEventListener('click', () => {
                profileStyleOptionsExtra.classList.toggle('show');
                profileStyleExpandBtn.textContent = profileStyleOptionsExtra.classList.contains('show') ? '−' : '+';
            });
        }

        const profileDecorationExpandBtn = document.getElementById('profileDecorationExpandBtn');
        if (profileDecorationExpandBtn && profileDecorationOptionsExtra) {
            profileDecorationExpandBtn.addEventListener('click', () => {
                profileDecorationOptionsExtra.classList.toggle('show');
                profileDecorationExpandBtn.textContent = profileDecorationOptionsExtra.classList.contains('show') ? '−' : '+';
            });
        }

        // Event listener para opciones extra de estilos
        if (profileStyleOptionsExtra) {
            profileStyleOptionsExtra.addEventListener('click', async (e) => {
                const styleOption = e.target.closest('.profile-style-option');
                if (styleOption) {
                    const selectedStyle = styleOption.dataset.style;
                    
                    // Actualizar selección visual (incluyendo opciones principales)
                    const allOptions = document.querySelectorAll('.profile-style-option');
                    allOptions.forEach(option => option.classList.remove('selected'));
                    styleOption.classList.add('selected');
                    
                    // Guardar estilo
                    if (window.saveProfilePictureStyle) {
                        const success = await window.saveProfilePictureStyle(selectedStyle);
                        if (success) {
                            // Actualizar también la foto de perfil pequeña
                            if (window.loadProfilePicture) {
                                await window.loadProfilePicture();
                            }
                        }
                    }
                }
            });
        }
        
        // Hacer funciones disponibles globalmente
        window.updateUserDisplay = updateUserDisplay;
        window.loadMainRanking = loadMainRanking;

        // Verificar y redirigir si es necesario (para PWA)
        if (window.location.pathname === '/' && !window.location.href.includes('Juego_Banderas')) {
            window.location.href = 'https://martinpenalva.github.io/Juego_Banderas/index.html';
        }

        // Inicializar corazones
        updateHearts();

        // No iniciar automáticamente - esperar a que el usuario seleccione dificultad
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs, doc, setDoc, getDoc, where, updateDoc, onSnapshot, writeBatch, deleteDoc } 
            from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } 
            from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } 
            from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
        import { getMessaging, getToken, onMessage } 
            from "https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js";

        // Configuración de tu proyecto
        const firebaseConfig = {
            apiKey: "AIzaSyDyf2mRx0S1CBOH7u4N8kINoH6Bxe_ItZo",
            authDomain: "banderas-f31cf.firebaseapp.com",
            projectId: "banderas-f31cf",
            storageBucket: "banderas-f31cf.firebasestorage.app",
            messagingSenderId: "413939026360",
            appId: "1:413939026360:web:b6e8b65c1f86cc9cf2274d",
            measurementId: "G-H2LGX84Z2Z"
        };

        // VAPID Key - Clave de Firebase Cloud Messaging
        // Esta clave permite recibir notificaciones push cuando la app está cerrada
        const VAPID_KEY = "BJqfweSlfzw2aDz4y9dJMUTxTYb-o6BX_UisrmzGd5sP_SMuMCOIomTqaq5hUbNOrwa8VqNbtfAp8d1ADqBv_Bk";

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);
        
        // Inicializar Firebase Messaging (solo en el cliente, no en Service Worker)
        let messaging = null;
        if (typeof window !== 'undefined' && 'serviceWorker' in navigator) {
            try {
                messaging = getMessaging(app);
            } catch (error) {
                console.log('Firebase Messaging no está disponible:', error);
            }
        }

        // Marcar que Firebase está listo
        window.firebaseReady = true;
        
        // Función para cargar información del creador por email
        window.loadCreatorInfo = async function() {
            const creatorEmail = 'mpenalvart1@educacion.navarra.es';
            
            try {
                const usuariosRef = collection(db, "usuarios");
                const q = query(usuariosRef, where("email", "==", creatorEmail));
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    const creatorDoc = querySnapshot.docs[0];
                    const creatorData = creatorDoc.data();
                    const creatorId = creatorDoc.id;
                    
                    // Cargar foto de perfil
                    const profilePicContainer = document.getElementById('creatorInfoProfilePicture');
                    if (profilePicContainer && window.loadUserProfilePicture) {
                        await window.loadUserProfilePicture(creatorId, profilePicContainer);
                    }
                    
                    // Actualizar información
                    const nameEl = document.getElementById('creatorInfoName');
                    const roleEl = document.getElementById('creatorInfoRole');
                    const descEl = document.getElementById('creatorInfoDescription');
                    
                    if (nameEl) {
                        nameEl.textContent = creatorData.nombre || '👨‍💻 Martin';
                    }
                    if (roleEl) {
                        roleEl.textContent = 'Creador de Banderas';
                    }
                    if (descEl) {
                        descEl.innerHTML = 'Hola! Soy Martin, el creador de este juego de adivinar banderas 😎<br><br>Hice este juego para que te diviertas aprendiendo banderas del mundo, y de paso puedas: publicar fotos, comentar imágenes, agregar amigos, molestar un poquito a tus colegas en sus fotos y, claro, presumir tus puntuaciones como todo un campeón 🏆.<br><br>¡Jajaja, que lo disfrutes y que el juego te divierta tanto como a mí crearlo! 🎮✨';
                    }
                } else {
                    console.log('Usuario creador no encontrado');
                }
            } catch (error) {
                console.error('Error al cargar información del creador:', error);
            }
        };

        // Definir funciones de autenticación inmediatamente para que estén disponibles
        window.iniciarSesion = async function(email, password) {
            try {
                // Verificar que auth esté inicializado
                if (!auth) {
                    console.error("Auth no está inicializado");
                    return { success: false, error: "Auth no está inicializado. Por favor, recarga la página." };
                }
                
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // Obtener nombre de usuario desde Firestore
                if (db) {
                    try {
                        const userDoc = await getDoc(doc(db, "usuarios", user.uid));
                        if (userDoc.exists()) {
                            window.currentUserName = userDoc.data().nombre;
                        } else {
                            window.currentUserName = user.email.split('@')[0];
                        }
                    } catch (dbError) {
                        console.error("Error al obtener datos del usuario desde Firestore:", dbError);
                        window.currentUserName = user.email.split('@')[0];
                    }
                } else {
                    window.currentUserName = user.email.split('@')[0];
                }
                
                window.currentUser = user;
                return { success: true, user: user };
            } catch (error) {
                console.error("Error al iniciar sesión: ", error);
                return { success: false, error: error.message || error.toString() };
            }
        };

        window.registrarUsuario = async function(email, password, nombre) {
            try {
                // Verificar que auth esté inicializado
                if (!auth) {
                    console.error("Auth no está inicializado");
                    return { success: false, error: "Auth no está inicializado. Por favor, recarga la página." };
                }
                
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // Guardar nombre de usuario en Firestore
                if (db) {
                    await setDoc(doc(db, "usuarios", user.uid), {
                        nombre: nombre,
                        email: email,
                        fechaRegistro: Date.now(),
                        amigos: [],
                        mostrarPuntuaciones: true
                    });
                } else {
                    console.error("Firestore no está inicializado");
                    return { success: false, error: "Firestore no está inicializado. Por favor, recarga la página." };
                }
                
                window.currentUser = user;
                window.currentUserName = nombre;
                return { success: true, user: user };
            } catch (error) {
                console.error("Error al registrar: ", error);
                return { success: false, error: error.message || error.toString() };
            }
        };

        // Limpiar bibliotecas (función auxiliar)
        function clearLibraries() {
            // Limpiar biblioteca propia
            const libraryGrid = document.getElementById('libraryGrid');
            if (libraryGrid) {
                libraryGrid.innerHTML = '';
            }
            
            // Limpiar biblioteca del amigo
            const friendLibraryGrid = document.getElementById('friendLibraryGrid');
            const friendLibrarySection = document.getElementById('friendLibrarySection');
            if (friendLibraryGrid) {
                friendLibraryGrid.innerHTML = '';
            }
            if (friendLibrarySection) {
                friendLibrarySection.style.display = 'none';
            }
            
            // Cerrar modal de imagen si está abierto
            if (window.hideLibraryImage) {
                window.hideLibraryImage();
            }
        }

        // Variable global para el usuario actual
        window.currentUser = null;
        window.currentUserName = null;


        window.cerrarSesion = async function() {
            try {
                await signOut(auth);
                window.currentUser = null;
                window.currentUserName = null;
                return true;
            } catch (error) {
                console.error("Error al cerrar sesión: ", error);
                return false;
            }
        };

        // Observar cambios en el estado de autenticación
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                window.currentUser = user;
                // Obtener nombre de usuario
                try {
                    const userDoc = await getDoc(doc(db, "usuarios", user.uid));
                    if (userDoc.exists()) {
                        window.currentUserName = userDoc.data().nombre;
                    } else {
                        window.currentUserName = user.email.split('@')[0];
                    }
                } catch (e) {
                    window.currentUserName = user.email.split('@')[0];
                }
                
                // Ocultar pantalla de autenticación y mostrar juego
                document.getElementById('authContainer').style.display = 'none';
                document.getElementById('gameContainer').style.display = 'block';
                document.getElementById('profilePictureContainer').style.display = 'block';
                if (window.updateUserDisplay) {
                    window.updateUserDisplay();
                }
                
                // Cargar foto de perfil
                loadProfilePicture();
                
                // Limpiar bibliotecas al cambiar de usuario
                clearLibraries();
                
                // Solicitar permisos de notificaciones y configurar sistema de notificaciones
                if (window.requestNotificationPermission) {
                    await window.requestNotificationPermission();
                }
                // Solicitar y guardar token FCM para notificaciones push
                if (window.requestFCMToken) {
                    await window.requestFCMToken();
                }
                if (window.setupNotificationListeners) {
                    await window.setupNotificationListeners();
                }
                
                // No cargar ranking automáticamente - el usuario debe hacer clic en el botón "Ver Tabla"
            } else {
                window.currentUser = null;
                window.currentUserName = null;
                // Mostrar pantalla de autenticación y ocultar juego
                document.getElementById('authContainer').style.display = 'flex';
                document.getElementById('gameContainer').style.display = 'none';
                document.getElementById('profilePictureContainer').style.display = 'none';
                // Limpiar foto de perfil
                clearProfilePicture();
                // Limpiar bibliotecas
                clearLibraries();
            }
        });

        // ----------- FOTO DE PERFIL -------------
        // Cargar foto de perfil desde Firestore
        window.loadProfilePicture = async function() {
            if (!window.currentUser) return;
            
            try {
                // Obtener documento del usuario desde Firestore
                const userDocRef = doc(db, "usuarios", window.currentUser.uid);
                const userDoc = await getDoc(userDocRef);
                
                // Obtener estilo de foto de perfil (por defecto 'classic')
                const profileStyle = userDoc.exists() && userDoc.data().profilePictureStyle 
                    ? userDoc.data().profilePictureStyle 
                    : 'classic';
                
                // Obtener decoración de foto de perfil (por defecto 'none')
                const profileDecoration = userDoc.exists() && userDoc.data().profilePictureDecoration 
                    ? userDoc.data().profilePictureDecoration 
                    : 'none';
                
                // Aplicar estilo al círculo pequeño
                const smallCircle = document.getElementById('profilePictureCircle');
                if (smallCircle) {
                    smallCircle.className = 'profile-picture-circle';
                    if (profileStyle !== 'classic') {
                        smallCircle.classList.add(`profile-picture-style-${profileStyle}`);
                        // Crear partículas si el estilo las necesita
                        if (window.createParticlesAround) window.createParticlesAround(smallCircle, profileStyle);
                    }
                    // Aplicar decoración
                    if (window.applyDecoration) window.applyDecoration(smallCircle, profileDecoration);
                }
                
                // Aplicar estilo al círculo grande
                const largeCircle = document.getElementById('profilePictureLarge');
                if (largeCircle) {
                    largeCircle.className = 'profile-picture-large';
                    if (profileStyle !== 'classic') {
                        largeCircle.classList.add(`profile-picture-style-${profileStyle}`);
                        // Crear partículas si el estilo las necesita
                        if (window.createParticlesAround) window.createParticlesAround(largeCircle, profileStyle);
                    }
                    // Aplicar decoración
                    if (window.applyDecoration) window.applyDecoration(largeCircle, profileDecoration);
                }
                
                if (userDoc.exists() && userDoc.data().fotoPerfil) {
                    const fotoBase64 = userDoc.data().fotoPerfil;
                    
                    // Actualizar círculo pequeño
                    const smallImg = document.getElementById('profilePictureImg');
                    const smallPlaceholder = document.getElementById('profilePicturePlaceholder');
                    if (smallImg) {
                        smallImg.src = fotoBase64;
                        smallImg.style.display = 'block';
                        if (smallPlaceholder) smallPlaceholder.style.display = 'none';
                    }
                    
                    // Actualizar círculo grande en el modal
                    const largeImg = document.getElementById('profilePictureLargeImg');
                    const largePlaceholder = document.getElementById('profilePictureLargePlaceholder');
                    if (largeImg) {
                        largeImg.src = fotoBase64;
                        largeImg.style.display = 'block';
                        if (largePlaceholder) largePlaceholder.style.display = 'none';
                    }
                } else {
                    // No hay foto, mostrar placeholder
                    clearProfilePicture();
                }
            } catch (error) {
                console.log('No se pudo cargar la foto de perfil:', error.message);
                clearProfilePicture();
            }
        };

        // Función para crear partículas distribuidas alrededor de la imagen
        window.createParticlesAround = function(containerElement, style) {
            if (!containerElement) return;
            
            // Eliminar partículas existentes
            const existingParticles = containerElement.querySelector('.profile-particles-container');
            if (existingParticles) {
                existingParticles.remove();
            }
            
            // Estilos que necesitan partículas
            const particleStyles = {
                'rain': { class: 'rain-drop', count: 12, emoji: null },
                'splash': { class: 'splash', count: 10, emoji: null },
                'drops': { class: 'drop-emoji', count: 10, emoji: '💧' },
                'particles': { class: 'particle-star', count: 12, emoji: '✨' },
                'snow': { class: 'snowflake', count: 12, emoji: '❄️' },
                'sparkles': { class: 'sparkle', count: 12, emoji: '⭐' },
                'bubbles': { class: 'bubble', count: 10, emoji: null },
                'confetti': { class: 'confetti', count: 12, emoji: ['🎉', '🎊', '🎈', '🎁'] },
                'burning': { class: 'fire-particle', count: 10, emoji: '🔥' }
            };
            
            const config = particleStyles[style];
            if (!config) return;
            
            // Crear contenedor de partículas
            const particlesContainer = document.createElement('div');
            particlesContainer.className = 'profile-particles-container';
            containerElement.appendChild(particlesContainer);
            
            // Calcular el radio del círculo (aproximado)
            const isLarge = containerElement.classList.contains('profile-picture-large');
            const radius = isLarge ? 75 : 30; // Radio aproximado del círculo
            const moveDistance = isLarge ? 250 : 120; // Distancia de movimiento
            
            // Crear partículas distribuidas alrededor del círculo
            for (let i = 0; i < config.count; i++) {
                const particle = document.createElement('div');
                particle.className = `profile-particle ${config.class}`;
                
                // Calcular posición alrededor del círculo (360 grados distribuidos)
                const angle = (i * 360) / config.count;
                const angleRad = (angle * Math.PI) / 180;
                
                // Calcular posición inicial (en el borde del círculo)
                const startX = Math.cos(angleRad) * radius;
                const startY = Math.sin(angleRad) * radius;
                
                // Calcular movimiento según el tipo de efecto
                let moveX = 0;
                let moveY = 0;
                
                if (style === 'rain' || style === 'drops' || style === 'snow' || style === 'confetti') {
                    // Efectos que caen: movimiento hacia abajo con variación lateral
                    moveX = (Math.random() - 0.5) * (isLarge ? 40 : 20);
                    moveY = moveDistance + Math.random() * (isLarge ? 60 : 30);
                } else if (style === 'bubbles') {
                    // Burbujas suben: movimiento hacia arriba con variación
                    moveX = (Math.random() - 0.5) * (isLarge ? 30 : 15);
                    moveY = -moveDistance - Math.random() * (isLarge ? 60 : 30);
                } else if (style === 'splash') {
                    // Salpicaduras: se expanden desde el borde hacia afuera
                    moveX = Math.cos(angleRad) * (isLarge ? 50 : 25);
                    moveY = Math.sin(angleRad) * (isLarge ? 50 : 25);
                } else if (style === 'particles' || style === 'sparkles') {
                    // Partículas flotantes: movimiento aleatorio en todas direcciones
                    moveX = (Math.random() - 0.5) * (isLarge ? 50 : 25);
                    moveY = (Math.random() - 0.5) * (isLarge ? 50 : 25);
                } else if (style === 'burning') {
                    // Fuego: movimiento hacia arriba con variación
                    moveX = (Math.random() - 0.5) * (isLarge ? 25 : 12);
                    moveY = -(isLarge ? 40 : 20) - Math.random() * (isLarge ? 30 : 15);
                }
                
                // Establecer posición inicial (centrada en el borde del círculo)
                particle.style.left = `calc(50% + ${startX}px)`;
                particle.style.top = `calc(50% + ${startY}px)`;
                particle.style.transform = 'translate(-50%, -50%)';
                particle.style.setProperty('--particle-offset-x', '0px');
                particle.style.setProperty('--particle-offset-y', '0px');
                particle.style.setProperty('--particle-move-x', `${moveX}px`);
                particle.style.setProperty('--particle-move-y', `${moveY}px`);
                
                // Agregar contenido (emoji o nada)
                if (config.emoji) {
                    if (Array.isArray(config.emoji)) {
                        particle.textContent = config.emoji[Math.floor(Math.random() * config.emoji.length)];
                    } else {
                        particle.textContent = config.emoji;
                    }
                }
                
                // Delay aleatorio para cada partícula
                const delay = (i * 0.15) + (Math.random() * 0.3);
                particle.style.animationDelay = `${delay}s`;
                
                particlesContainer.appendChild(particle);
            }
        }

        // Función auxiliar para aplicar decoración a un contenedor
        window.applyDecoration = function(containerElement, decoration) {
            if (!containerElement || !decoration || decoration === 'none') {
                // Eliminar decoraciones existentes
                const existingDecoration = containerElement.querySelector('.profile-decoration');
                if (existingDecoration) {
                    existingDecoration.remove();
                }
                return;
            }

            // Eliminar decoración anterior
            const existingDecoration = containerElement.querySelector('.profile-decoration');
            if (existingDecoration) {
                existingDecoration.remove();
            }

            // Crear nueva decoración
            const decorationEl = document.createElement('div');
            decorationEl.className = `profile-decoration decoration-${decoration}`;
            
            // Configurar contenido según el tipo de decoración
            // Las decoraciones de orejas y alien usan ::before y ::after en CSS
            switch(decoration) {
                case 'cat-ears':
                case 'dog-ears':
                case 'rabbit-ears':
                case 'alien':
                    // Estas decoraciones usan ::before y ::after definidos en CSS
                    decorationEl.textContent = '';
                    break;
                case 'crown':
                    decorationEl.textContent = '👑';
                    break;
                case 'hat':
                    decorationEl.textContent = '🎩';
                    break;
                case 'glasses':
                    decorationEl.textContent = '🕶️';
                    break;
                case 'mustache':
                    decorationEl.textContent = '👨';
                    break;
                case 'hearts':
                    decorationEl.textContent = '❤️';
                    break;
                case 'stars':
                    decorationEl.textContent = '⭐';
                    break;
                case 'unicorn':
                    decorationEl.textContent = '🦄';
                    break;
                case 'panda':
                    decorationEl.textContent = '🐼';
                    break;
                case 'bear':
                    decorationEl.textContent = '🐻';
                    break;
                case 'fox':
                    decorationEl.textContent = '🦊';
                    break;
                case 'lion':
                    decorationEl.textContent = '🦁';
                    break;
                case 'tiger':
                    decorationEl.textContent = '🐯';
                    break;
                case 'cowboy':
                    decorationEl.textContent = '🤠';
                    break;
                case 'party':
                    decorationEl.textContent = '🎉';
                    break;
                case 'rocket':
                    decorationEl.textContent = '🚀';
                    break;
                case 'fire-emoji':
                    decorationEl.textContent = '🔥';
                    break;
                case 'lightning':
                    decorationEl.textContent = '⚡';
                    break;
                case 'rainbow-emoji':
                    decorationEl.textContent = '🌈';
                    break;
                case 'sun':
                    decorationEl.textContent = '☀️';
                    break;
                case 'moon':
                    decorationEl.textContent = '🌙';
                    break;
                case 'flower':
                    decorationEl.textContent = '🌸';
                    break;
                case 'butterfly':
                    decorationEl.textContent = '🦋';
                    break;
                default:
                    return;
            }

            containerElement.appendChild(decorationEl);
        }

        // Cargar foto de perfil de un usuario específico (para ranking) desde Firestore
        window.loadUserProfilePicture = async function(userId, containerElement) {
            if (!userId || !containerElement) return;
            
            try {
                // Limpiar el contenedor primero
                containerElement.innerHTML = '';
                
                // Obtener documento del usuario desde Firestore
                const userDocRef = doc(db, "usuarios", userId);
                const userDoc = await getDoc(userDocRef);
                
                // Obtener estilo de foto de perfil (por defecto 'classic')
                const profileStyle = userDoc.exists() && userDoc.data().profilePictureStyle 
                    ? userDoc.data().profilePictureStyle 
                    : 'classic';
                
                // Obtener decoración de foto de perfil (por defecto 'none')
                const profileDecoration = userDoc.exists() && userDoc.data().profilePictureDecoration 
                    ? userDoc.data().profilePictureDecoration 
                    : 'none';
                
                // Aplicar clase de estilo al contenedor
                containerElement.className = containerElement.className.replace(/profile-picture-style-\w+/g, '').trim();
                if (profileStyle !== 'classic') {
                    containerElement.classList.add(`profile-picture-style-${profileStyle}`);
                }
                
                if (userDoc.exists() && userDoc.data().fotoPerfil) {
                    const fotoBase64 = userDoc.data().fotoPerfil;
                    
                    // Verificar que la foto no esté vacía
                    if (fotoBase64 && fotoBase64.trim() !== '') {
                        const img = document.createElement('img');
                        img.src = fotoBase64;
                        img.alt = 'Foto de perfil';
                        img.style.width = '100%';
                        img.style.height = '100%';
                        img.style.objectFit = 'cover';
                        img.style.display = 'block';
                        img.style.borderRadius = '50%';
                        
                        // Manejar errores de carga de imagen
                        img.onerror = () => {
                            console.log(`Error al cargar imagen para usuario ${userId}`);
                            const placeholder = document.createElement('div');
                            placeholder.className = 'placeholder';
                            placeholder.textContent = '👤';
                            containerElement.innerHTML = '';
                            containerElement.appendChild(placeholder);
                        };
                        
                        containerElement.appendChild(img);
                        
                        // Crear partículas si el estilo las necesita (después de agregar la imagen)
                        if (profileStyle !== 'classic' && window.createParticlesAround) {
                            window.createParticlesAround(containerElement, profileStyle);
                        }
                        
                        // Aplicar decoración
                        if (window.applyDecoration) window.applyDecoration(containerElement, profileDecoration);
                    } else {
                        // Foto vacía, mostrar placeholder
                        const placeholder = document.createElement('div');
                        placeholder.className = 'placeholder';
                        placeholder.textContent = '👤';
                        containerElement.appendChild(placeholder);
                    }
                } else {
                    // No hay foto, mostrar placeholder
                    const placeholder = document.createElement('div');
                    placeholder.className = 'placeholder';
                    placeholder.textContent = '👤';
                    containerElement.appendChild(placeholder);
                }
            } catch (error) {
                console.log(`No se pudo cargar foto de perfil para usuario ${userId}:`, error.message);
                
                // Mostrar placeholder en caso de error
                const placeholder = document.createElement('div');
                placeholder.className = 'placeholder';
                placeholder.textContent = '👤';
                containerElement.innerHTML = '';
                containerElement.appendChild(placeholder);
            }
        };

        // Limpiar foto de perfil (mostrar placeholder)
        function clearProfilePicture() {
            const smallImg = document.getElementById('profilePictureImg');
            const smallPlaceholder = document.getElementById('profilePicturePlaceholder');
            if (smallImg) {
                smallImg.src = '';
                smallImg.style.display = 'none';
            }
            if (smallPlaceholder) smallPlaceholder.style.display = 'block';
            
            const largeImg = document.getElementById('profilePictureLargeImg');
            const largePlaceholder = document.getElementById('profilePictureLargePlaceholder');
            if (largeImg) {
                largeImg.src = '';
                largeImg.style.display = 'none';
            }
            if (largePlaceholder) largePlaceholder.style.display = 'block';
        }

        // Función para comprimir imagen
        function compressImage(file, maxWidth = 300, maxHeight = 300, quality = 0.8) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        // Calcular nuevas dimensiones manteniendo la proporción
                        if (width > height) {
                            if (width > maxWidth) {
                                height = (height * maxWidth) / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width = (width * maxHeight) / height;
                                height = maxHeight;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Convertir a base64 con compresión
                        const base64 = canvas.toDataURL('image/jpeg', quality);
                        resolve(base64);
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }

        // Subir foto de perfil (guardar como base64 en Firestore)
        window.uploadProfilePicture = async function(file) {
            if (!window.currentUser || !file) return false;
            
            try {
                // Validar que sea una imagen
                if (!file.type.startsWith('image/')) {
                    alert('Por favor, selecciona un archivo de imagen');
                    return false;
                }
                
                // Validar tamaño original (máximo 10MB antes de comprimir)
                if (file.size > 10 * 1024 * 1024) {
                    alert('La imagen es demasiado grande. Máximo 10MB');
                    return false;
                }
                
                // Comprimir imagen antes de guardar
                const compressedBase64 = await compressImage(file, 300, 300, 0.8);
                
                // Guardar en Firestore en el documento del usuario
                const userDocRef = doc(db, "usuarios", window.currentUser.uid);
                await updateDoc(userDocRef, {
                    fotoPerfil: compressedBase64,
                    fotoPerfilFecha: Date.now()
                });
                
                console.log('✅ Foto de perfil guardada en Firestore');
                
                // Actualizar círculo pequeño
                const smallImg = document.getElementById('profilePictureImg');
                const smallPlaceholder = document.getElementById('profilePicturePlaceholder');
                if (smallImg) {
                    smallImg.src = compressedBase64;
                    smallImg.style.display = 'block';
                    if (smallPlaceholder) smallPlaceholder.style.display = 'none';
                }
                
                // Actualizar círculo grande en el modal
                const largeImg = document.getElementById('profilePictureLargeImg');
                const largePlaceholder = document.getElementById('profilePictureLargePlaceholder');
                if (largeImg) {
                    largeImg.src = compressedBase64;
                    largeImg.style.display = 'block';
                    if (largePlaceholder) largePlaceholder.style.display = 'none';
                }
                
                return true;
            } catch (error) {
                console.error('Error al subir foto de perfil:', error);
                alert('Error al subir la foto. Intenta de nuevo.');
                return false;
            }
        };

        // Guardar estilo de foto de perfil
        window.saveProfilePictureStyle = async function(style) {
            if (!window.currentUser || !style) return false;
            
            try {
                const userDocRef = doc(db, "usuarios", window.currentUser.uid);
                await updateDoc(userDocRef, {
                    profilePictureStyle: style
                });
                
                console.log(`✅ Estilo de foto de perfil guardado: ${style}`);
                
                // Actualizar estilos en los círculos
                const smallCircle = document.getElementById('profilePictureCircle');
                if (smallCircle) {
                    smallCircle.className = 'profile-picture-circle';
                    if (style !== 'classic') {
                        smallCircle.classList.add(`profile-picture-style-${style}`);
                        // Crear partículas si el estilo las necesita
                        if (window.createParticlesAround) window.createParticlesAround(smallCircle, style);
                    }
                }
                
                const largeCircle = document.getElementById('profilePictureLarge');
                if (largeCircle) {
                    largeCircle.className = 'profile-picture-large';
                    if (style !== 'classic') {
                        largeCircle.classList.add(`profile-picture-style-${style}`);
                        // Crear partículas si el estilo las necesita
                        if (window.createParticlesAround) window.createParticlesAround(largeCircle, style);
                    }
                }
                
                return true;
            } catch (error) {
                console.error('Error al guardar estilo de foto de perfil:', error);
                return false;
            }
        };

        // Cargar estilo de foto de perfil
        window.loadProfilePictureStyle = async function() {
            if (!window.currentUser) return;
            
            try {
                const userDocRef = doc(db, "usuarios", window.currentUser.uid);
                const userDoc = await getDoc(userDocRef);
                
                const profileStyle = userDoc.exists() && userDoc.data().profilePictureStyle 
                    ? userDoc.data().profilePictureStyle 
                    : 'classic';
                
                // Estilos que están en las opciones extra
                const extraStyles = ['silver', 'copper', 'emerald', 'sapphire', 'ruby', 'amethyst', 'sunset', 'ocean', 'forest', 'cosmic', 'burning', 'pulse', 'rainbow-animated', 'shimmer', 'neon-pulse', 'waves', 'electric', 'magma', 'rain', 'splash', 'drops', 'particles', 'snow', 'sparkles', 'bubbles', 'confetti'];
                
                // Si el estilo está en las opciones extra, expandir la sección
                if (extraStyles.includes(profileStyle)) {
                    const profileStyleOptionsExtra = document.getElementById('profileStyleOptionsExtra');
                    const profileStyleExpandBtn = document.getElementById('profileStyleExpandBtn');
                    if (profileStyleOptionsExtra && profileStyleExpandBtn) {
                        profileStyleOptionsExtra.classList.add('show');
                        profileStyleExpandBtn.textContent = '−';
                    }
                }
                
                // Actualizar selector de estilos
                const styleOptions = document.querySelectorAll('.profile-style-option');
                styleOptions.forEach(option => {
                    option.classList.remove('selected');
                    if (option.dataset.style === profileStyle) {
                        option.classList.add('selected');
                    }
                });
                
                return profileStyle;
            } catch (error) {
                console.error('Error al cargar estilo de foto de perfil:', error);
                return 'classic';
            }
        };

        // Guardar decoración de foto de perfil
        window.saveProfilePictureDecoration = async function(decoration) {
            if (!window.currentUser || !decoration) return false;
            
            try {
                const userDocRef = doc(db, "usuarios", window.currentUser.uid);
                await updateDoc(userDocRef, {
                    profilePictureDecoration: decoration
                });
                
                console.log(`✅ Decoración de foto de perfil guardada: ${decoration}`);
                
                // Aplicar decoración a los círculos
                const smallCircle = document.getElementById('profilePictureCircle');
                if (smallCircle) {
                    if (window.applyDecoration) window.applyDecoration(smallCircle, decoration);
                }
                
                const largeCircle = document.getElementById('profilePictureLarge');
                if (largeCircle) {
                    applyDecoration(largeCircle, decoration);
                }
                
                return true;
            } catch (error) {
                console.error('Error al guardar decoración de foto de perfil:', error);
                return false;
            }
        };

        // Cargar decoración de foto de perfil
        window.loadProfilePictureDecoration = async function() {
            if (!window.currentUser) return;
            
            try {
                const userDocRef = doc(db, "usuarios", window.currentUser.uid);
                const userDoc = await getDoc(userDocRef);
                
                const profileDecoration = userDoc.exists() && userDoc.data().profilePictureDecoration 
                    ? userDoc.data().profilePictureDecoration 
                    : 'none';
                
                // Decoraciones que están en las opciones extra
                const extraDecorations = ['unicorn', 'panda', 'bear', 'fox', 'lion', 'tiger', 'cowboy', 'party', 'rocket', 'fire-emoji', 'lightning', 'rainbow-emoji', 'sun', 'moon', 'flower', 'butterfly'];
                
                // Si la decoración está en las opciones extra, expandir la sección
                if (extraDecorations.includes(profileDecoration)) {
                    const profileDecorationOptionsExtra = document.getElementById('profileDecorationOptionsExtra');
                    const profileDecorationExpandBtn = document.getElementById('profileDecorationExpandBtn');
                    if (profileDecorationOptionsExtra && profileDecorationExpandBtn) {
                        profileDecorationOptionsExtra.classList.add('show');
                        profileDecorationExpandBtn.textContent = '−';
                    }
                }
                
                // Actualizar selector de decoraciones
                const decorationOptions = document.querySelectorAll('.profile-decoration-option');
                decorationOptions.forEach(option => {
                    option.classList.remove('selected');
                    if (option.dataset.decoration === profileDecoration) {
                        option.classList.add('selected');
                    }
                });
                
                return profileDecoration;
            } catch (error) {
                console.error('Error al cargar decoración de foto de perfil:', error);
                return 'none';
            }
        };

        // Mostrar modal de perfil
        window.showProfileModal = async function() {
            if (!window.currentUser) return;
            
            const modal = document.getElementById('profileModal');
            const profileName = document.getElementById('profileName');
            const profileEmail = document.getElementById('profileEmail');
            
            if (modal && profileName && profileEmail) {
                profileName.textContent = window.currentUserName || '-';
                profileEmail.textContent = window.currentUser.email || '-';
                modal.style.display = 'flex';
                
                // Cargar estilo de foto de perfil
                if (window.loadProfilePictureStyle) {
                    await window.loadProfilePictureStyle();
                }
                
                // Cargar decoración de foto de perfil
                if (window.loadProfilePictureDecoration) {
                    await window.loadProfilePictureDecoration();
                }
                
                // Cargar lista de amigos
                if (window.loadFriendsList) {
                    window.loadFriendsList();
                }
                
                // Cargar lista de chats automáticamente
                if (window.loadChatsList) {
                    window.loadChatsList();
                }
                
                // Cargar preferencia de mostrar puntuaciones
                if (window.loadScoresPreference) {
                    window.loadScoresPreference();
                }
                
                // Cargar puntuaciones si están visibles
                const scoresSection = document.getElementById('profileScoresSection');
                if (scoresSection && scoresSection.style.display !== 'none') {
                    if (window.loadUserScores) {
                        window.loadUserScores();
                    }
                }
                
                // Cargar descripción
                if (window.loadProfileDescription) {
                    window.loadProfileDescription();
                }
                
                // Cargar biblioteca (limpiar primero para evitar mostrar fotos de otro usuario)
                if (typeof clearLibraries === 'function') {
                    clearLibraries();
                }
                if (window.loadLibrary) {
                    window.loadLibrary();
                }
                
                // Mostrar la sección de chats si hay amigos (aunque esté colapsada)
                const chatsSection = document.getElementById('profileChatsSection');
                if (chatsSection) {
                    // Verificar si hay amigos para mostrar la sección
                    try {
                        const userDoc = await getDoc(doc(db, "usuarios", window.currentUser.uid));
                        if (userDoc.exists()) {
                            const amigos = userDoc.data().amigos || [];
                            if (amigos.length > 0) {
                                chatsSection.style.display = 'block';
                                chatsSection.classList.add('collapsed'); // Empezar colapsado
                            } else {
                                chatsSection.style.display = 'none';
                            }
                        } else {
                            // Si no existe el documento, ocultar la sección
                            chatsSection.style.display = 'none';
                        }
                    } catch (error) {
                        console.error('Error al verificar amigos para mostrar sección de chats:', error);
                        // Si hay error, mostrar la sección de todos modos (el usuario puede tener amigos)
                        chatsSection.style.display = 'block';
                        chatsSection.classList.add('collapsed');
                    }
                }
                
                // Los dropdowns empiezan cerrados por defecto
                const friendsSection = document.getElementById('profileFriendsSection');
                if (friendsSection) {
                    friendsSection.classList.add('collapsed'); // Empezar colapsado
                }
                
                // El chat activo no se abre automáticamente - solo cuando se hace clic en el botón de mensaje
                const activeChat = document.getElementById('profileActiveChat');
                if (activeChat) {
                    activeChat.style.display = 'none';
                }

                // Ocultar botón de correo de recomendaciones para mpenalvart1 (se combina con buzón)
                const recommendationsInboxBtn = document.getElementById('profileRecommendationsInboxBtn');
                if (recommendationsInboxBtn && window.currentUser) {
                    // Siempre ocultar para mpenalvart1, ya que se combina con el buzón
                    recommendationsInboxBtn.style.display = 'none';
                }
                
                // El botón de bandeja solo muestra solicitudes de amistad para todos los usuarios
                // (las recomendaciones van en el buzón para mpenalvart1)
                
                // Cambiar el texto del botón de buzón para mpenalvart1
                const profileMailboxBtn = document.getElementById('profileMailboxBtn');
                if (profileMailboxBtn && window.currentUser && window.currentUser.email === 'mpenalvart1@educacion.navarra.es') {
                    profileMailboxBtn.textContent = '📮 Buzón y Recomendaciones';
                } else if (profileMailboxBtn && window.currentUser) {
                    profileMailboxBtn.textContent = '📮 Buzón de Correo';
                }

                // Mostrar botón de enviar mensaje solo para mpenalvart1
                const sendMailBtn = document.getElementById('profileSendMailBtn');
                if (sendMailBtn && window.currentUser) {
                    if (window.currentUser.email === 'mpenalvart1@educacion.navarra.es') {
                        sendMailBtn.style.display = 'block';
                    } else {
                        sendMailBtn.style.display = 'none';
                    }
                }

                // Mostrar botón de crear grupo solo para mpenalvart1
                const createGroupBtn = document.getElementById('createGroupBtn');
                if (createGroupBtn && window.currentUser) {
                    if (window.currentUser.email === 'mpenalvart1@educacion.navarra.es') {
                        createGroupBtn.style.display = 'block';
                    } else {
                        createGroupBtn.style.display = 'none';
                    }
                }

                // Cargar notificaciones y marcadores
                if (window.loadProfileNotifications) {
                    await window.loadProfileNotifications();
                }
            }
        };

        // Ocultar modal de perfil
        window.hideProfileModal = function() {
            const modal = document.getElementById('profileModal');
            const saveBtn = document.getElementById('profileSaveBtn');
            const friendsModal = document.getElementById('friendsModal');
            const inboxModal = document.getElementById('inboxModal');
            const friendProfileModal = document.getElementById('friendProfileModal');
            if (modal) {
                modal.style.display = 'none';
            }
            if (saveBtn) {
                saveBtn.style.display = 'none';
            }
            if (friendsModal) {
                friendsModal.style.display = 'none';
            }
            if (inboxModal) {
                inboxModal.style.display = 'none';
            }
            if (friendProfileModal) {
                friendProfileModal.style.display = 'none';
            }
        };

        // Función para enviar recomendación
        window.sendRecommendation = async function() {
            if (!window.currentUser) {
                alert('Debes iniciar sesión para enviar una recomendación');
                return;
            }

            const recommendationText = document.getElementById('recommendationText');
            if (!recommendationText) return;

            const texto = recommendationText.value.trim();
            if (!texto) {
                alert('Por favor, escribe una recomendación antes de enviar');
                return;
            }

            try {
                // Obtener información del usuario actual
                const userDoc = await getDoc(doc(db, "usuarios", window.currentUser.uid));
                const userData = userDoc.exists() ? userDoc.data() : {};
                const nombreUsuario = userData.nombre || window.currentUserName || 'Anónimo';

                // Guardar recomendación en Firestore
                // Todas las recomendaciones se envían a la cuenta de mpenalvart1@educacion.navarra.es
                const recommendationsRef = collection(db, "recomendaciones");
                await addDoc(recommendationsRef, {
                    texto: texto,
                    userId: window.currentUser.uid,
                    nombreUsuario: nombreUsuario,
                    emailUsuario: window.currentUser.email,
                    timestamp: Date.now(),
                    destinatarioEmail: 'mpenalvart1@educacion.navarra.es' // Todas las recomendaciones van a esta cuenta
                });

                alert('✅ Recomendación enviada exitosamente. ¡Gracias por tu feedback!');
                recommendationText.value = '';
                const recommendationsModal = document.getElementById('recommendationsModal');
                if (recommendationsModal) {
                    recommendationsModal.style.display = 'none';
                }
            } catch (error) {
                console.error('Error al enviar recomendación:', error);
                alert('Error al enviar la recomendación. Por favor, intenta de nuevo.');
            }
        };

        // Función para cargar recomendaciones recibidas
        window.loadRecommendations = async function() {
            if (!window.currentUser || window.currentUser.email !== 'mpenalvart1@educacion.navarra.es') {
                return;
            }

            try {
                const recommendationsRef = collection(db, "recomendaciones");
                // Solo usar where, sin orderBy para evitar necesidad de índice compuesto
                const q = query(
                    recommendationsRef,
                    where("destinatarioEmail", "==", 'mpenalvart1@educacion.navarra.es')
                );
                const snapshot = await getDocs(q);

                const recommendationsList = document.getElementById('recommendationsList');
                if (!recommendationsList) return;

                recommendationsList.innerHTML = '';

                if (snapshot.empty) {
                    recommendationsList.innerHTML = '<div style="text-align: center; color: #718096; padding: 20px;">No hay recomendaciones aún.</div>';
                    return;
                }

                // Convertir a array y ordenar por timestamp descendente en JavaScript
                const recommendations = snapshot.docs.map(docSnapshot => ({
                    id: docSnapshot.id,
                    ...docSnapshot.data()
                })).sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                // Cargar cada recomendación
                for (const data of recommendations) {
                    const recommendationItem = document.createElement('div');
                    recommendationItem.className = 'recommendation-item';

                    // Contenedor de foto de perfil
                    const profileContainer = document.createElement('div');
                    profileContainer.className = 'recommendation-item-profile';
                    // Limpiar el contenedor primero
                    profileContainer.innerHTML = '';
                    
                    if (data.userId && window.loadUserProfilePicture) {
                        await window.loadUserProfilePicture(data.userId, profileContainer);
                    } else {
                        const placeholder = document.createElement('div');
                        placeholder.className = 'placeholder';
                        placeholder.textContent = '👤';
                        profileContainer.appendChild(placeholder);
                    }

                    // Contenido de la recomendación
                    const content = document.createElement('div');
                    content.className = 'recommendation-item-content';

                    const author = document.createElement('div');
                    author.className = 'recommendation-item-author';
                    author.textContent = data.nombreUsuario || 'Anónimo';

                    const text = document.createElement('div');
                    text.className = 'recommendation-item-text';
                    text.textContent = data.texto;

                    const date = document.createElement('div');
                    date.className = 'recommendation-item-date';
                    const fecha = new Date(data.timestamp);
                    date.textContent = fecha.toLocaleDateString('es-ES', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    // Botones de acción
                    const actions = document.createElement('div');
                    actions.className = 'recommendation-item-actions';
                    
                    // Botón de responder
                    const replyBtn = document.createElement('button');
                    replyBtn.className = 'recommendation-reply-btn';
                    replyBtn.textContent = '💬 Responder';
                    replyBtn.onclick = () => {
                        // Mostrar formulario de respuesta
                        const replyForm = recommendationItem.querySelector('.recommendation-reply-form');
                        if (replyForm) {
                            replyForm.style.display = replyForm.style.display === 'none' ? 'block' : 'none';
                            const textarea = replyForm.querySelector('.recommendation-reply-textarea');
                            if (textarea && replyForm.style.display === 'block') {
                                textarea.focus();
                            }
                        }
                    };
                    
                    // Botón de eliminar
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'recommendation-delete-btn';
                    deleteBtn.textContent = '🗑️ Eliminar';
                    deleteBtn.onclick = async () => {
                        if (confirm('¿Estás seguro de que quieres eliminar esta recomendación?')) {
                            try {
                                await deleteDoc(doc(db, "recomendaciones", data.id));
                                // Recargar recomendaciones después de eliminar
                                await window.loadRecommendations();
                            } catch (error) {
                                console.error('Error al eliminar recomendación:', error);
                                alert('Error al eliminar la recomendación. Por favor, intenta de nuevo.');
                            }
                        }
                    };
                    
                    actions.appendChild(replyBtn);
                    actions.appendChild(deleteBtn);

                    // Formulario de respuesta (oculto por defecto)
                    const replyForm = document.createElement('div');
                    replyForm.className = 'recommendation-reply-form';
                    replyForm.style.display = 'none';
                    
                    const replyTextarea = document.createElement('textarea');
                    replyTextarea.className = 'recommendation-reply-textarea';
                    replyTextarea.placeholder = 'Escribe tu respuesta...';
                    replyTextarea.rows = 4;
                    
                    const replySubmitBtn = document.createElement('button');
                    replySubmitBtn.className = 'recommendation-reply-submit-btn';
                    replySubmitBtn.textContent = '📤 Enviar Respuesta';
                    replySubmitBtn.onclick = async () => {
                        const respuestaTexto = replyTextarea.value.trim();
                        if (!respuestaTexto) {
                            alert('Por favor, escribe una respuesta');
                            return;
                        }

                        try {
                            // Obtener información del remitente (mpenalvart1)
                            const remitenteDoc = await getDoc(doc(db, "usuarios", window.currentUser.uid));
                            const remitenteData = remitenteDoc.exists() ? remitenteDoc.data() : {};
                            const nombreRemitente = remitenteData.nombre || window.currentUserName || 'Martin';

                            // Guardar respuesta como mensaje en el buzón del usuario que envió la recomendación
                            const messagesRef = collection(db, "mensajesCorreo");
                            await addDoc(messagesRef, {
                                remitenteId: window.currentUser.uid,
                                nombreRemitente: nombreRemitente,
                                emailRemitente: window.currentUser.email,
                                destinatarioId: data.userId,
                                texto: `Respuesta a tu recomendación: "${data.texto.substring(0, 50)}${data.texto.length > 50 ? '...' : ''}"\n\n${respuestaTexto}`,
                                timestamp: Date.now(),
                                leido: false,
                                esRespuestaRecomendacion: true,
                                recomendacionId: data.id
                            });

                            alert('✅ Respuesta enviada exitosamente');
                            replyTextarea.value = '';
                            replyForm.style.display = 'none';
                        } catch (error) {
                            console.error('Error al enviar respuesta:', error);
                            alert('Error al enviar la respuesta. Por favor, intenta de nuevo.');
                        }
                    };
                    
                    replyForm.appendChild(replyTextarea);
                    replyForm.appendChild(replySubmitBtn);

                    content.appendChild(author);
                    content.appendChild(text);
                    content.appendChild(date);
                    content.appendChild(actions);
                    content.appendChild(replyForm);

                    recommendationItem.appendChild(profileContainer);
                    recommendationItem.appendChild(content);
                    recommendationsList.appendChild(recommendationItem);
                }
            } catch (error) {
                console.error('Error al cargar recomendaciones:', error);
                const recommendationsList = document.getElementById('recommendationsList');
                if (recommendationsList) {
                    recommendationsList.innerHTML = '<div style="text-align: center; color: #f56565; padding: 20px;">Error al cargar recomendaciones.</div>';
                }
            }
        };

        // Función para cargar mensajes del buzón de correo
        window.loadMailboxMessages = async function() {
            if (!window.currentUser) return;

            try {
                const messagesRef = collection(db, "mensajesCorreo");
                const q = query(
                    messagesRef,
                    where("destinatarioId", "==", window.currentUser.uid)
                );
                const snapshot = await getDocs(q);

                const messagesList = document.getElementById('mailboxMessagesList');
                if (!messagesList) return;

                messagesList.innerHTML = '';

                if (snapshot.empty) {
                    messagesList.innerHTML = '<div style="text-align: center; color: #718096; padding: 20px;">No hay mensajes en tu buzón.</div>';
                    return;
                }

                // Convertir a array y ordenar por timestamp descendente
                const messages = snapshot.docs.map(docSnapshot => ({
                    id: docSnapshot.id,
                    ...docSnapshot.data()
                })).sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                // Cargar cada mensaje
                for (const data of messages) {
                    const messageItem = document.createElement('div');
                    messageItem.className = 'mailbox-message-item' + (data.leido ? '' : ' unread');

                    // Contenedor de foto de perfil
                    const profileContainer = document.createElement('div');
                    profileContainer.className = 'mailbox-message-profile';
                    
                    if (data.remitenteId && window.loadUserProfilePicture) {
                        await window.loadUserProfilePicture(data.remitenteId, profileContainer);
                    } else {
                        const placeholder = document.createElement('div');
                        placeholder.className = 'placeholder';
                        placeholder.textContent = '👤';
                        profileContainer.appendChild(placeholder);
                    }

                    // Contenido del mensaje
                    const content = document.createElement('div');
                    content.className = 'mailbox-message-content';

                    const sender = document.createElement('div');
                    sender.className = 'mailbox-message-sender';
                    sender.textContent = data.nombreRemitente || 'Anónimo';

                    const text = document.createElement('div');
                    text.className = 'mailbox-message-text';
                    text.textContent = data.texto;

                    const date = document.createElement('div');
                    date.className = 'mailbox-message-date';
                    const fecha = new Date(data.timestamp);
                    date.textContent = fecha.toLocaleDateString('es-ES', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    // Botón de eliminar
                    const actions = document.createElement('div');
                    actions.className = 'mailbox-message-actions';
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'mailbox-message-delete-btn';
                    deleteBtn.textContent = '🗑️ Eliminar';
                    deleteBtn.onclick = async () => {
                        if (confirm('¿Estás seguro de que quieres eliminar este mensaje?')) {
                            try {
                                await deleteDoc(doc(db, "mensajesCorreo", data.id));
                                await window.loadMailboxMessages();
                            } catch (error) {
                                console.error('Error al eliminar mensaje:', error);
                                alert('Error al eliminar el mensaje. Por favor, intenta de nuevo.');
                            }
                        }
                    };
                    
                    actions.appendChild(deleteBtn);

                    content.appendChild(sender);
                    content.appendChild(text);
                    content.appendChild(date);
                    content.appendChild(actions);

                    messageItem.appendChild(profileContainer);
                    messageItem.appendChild(content);
                    messagesList.appendChild(messageItem);

                    // Marcar como leído si no estaba leído
                    if (!data.leido) {
                        try {
                            await updateDoc(doc(db, "mensajesCorreo", data.id), {
                                leido: true
                            });
                        } catch (error) {
                            console.error('Error al marcar mensaje como leído:', error);
                        }
                    }
                }

                // Actualizar notificaciones después de cargar mensajes
                if (window.loadProfileNotifications) {
                    await window.loadProfileNotifications();
                }
            } catch (error) {
                console.error('Error al cargar mensajes del buzón:', error);
                const messagesList = document.getElementById('mailboxMessagesList');
                if (messagesList) {
                    messagesList.innerHTML = '<div style="text-align: center; color: #f56565; padding: 20px;">Error al cargar mensajes.</div>';
                }
            }
        };

        // Función para buscar usuarios y enviar mensaje (solo para mpenalvart1)
        window.searchUsersForMail = async function() {
            if (!window.currentUser || window.currentUser.email !== 'mpenalvart1@educacion.navarra.es') {
                return;
            }

            const searchInput = document.getElementById('sendMailSearchInput');
            const resultsDiv = document.getElementById('sendMailResults');
            if (!searchInput || !resultsDiv) return;

            const searchTerm = searchInput.value.trim().toLowerCase();
            if (!searchTerm) {
                alert('Por favor, escribe un nombre o email para buscar');
                return;
            }

            try {
                const usuariosRef = collection(db, "usuarios");
                const snapshot = await getDocs(usuariosRef);
                
                resultsDiv.innerHTML = '';

                const matches = [];
                snapshot.forEach(docSnapshot => {
                    const userData = docSnapshot.data();
                    const nombre = (userData.nombre || '').toLowerCase();
                    const email = (userData.email || '').toLowerCase();
                    
                    if (nombre.includes(searchTerm) || email.includes(searchTerm)) {
                        matches.push({
                            id: docSnapshot.id,
                            ...userData
                        });
                    }
                });

                if (matches.length === 0) {
                    resultsDiv.innerHTML = '<div style="text-align: center; color: #718096; padding: 20px;">No se encontraron usuarios.</div>';
                    return;
                }

                // Botón "Para todos"
                const sendToAllBtn = document.createElement('button');
                sendToAllBtn.className = 'send-mail-to-all-btn';
                sendToAllBtn.textContent = '📢 Enviar a Todos los Usuarios';
                sendToAllBtn.style.cssText = 'width: 100%; padding: 12px; margin-bottom: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 1em; font-weight: 600; transition: all 0.3s ease;';
                sendToAllBtn.onmouseover = function() {
                    this.style.transform = 'translateY(-2px)';
                    this.style.boxShadow = '0 4px 15px rgba(102, 126, 234, 0.4)';
                };
                sendToAllBtn.onmouseout = function() {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = 'none';
                };
                sendToAllBtn.onclick = () => {
                    const compose = document.getElementById('sendMailCompose');
                    const recipient = document.getElementById('sendMailRecipient');
                    const messageText = document.getElementById('sendMailMessageText');
                    
                    if (compose && recipient && messageText) {
                        compose.style.display = 'block';
                        recipient.innerHTML = 'Para: Todos los usuarios';
                        messageText.value = '';
                        messageText.focus();
                        
                        // Guardar indicador de "todos"
                        compose.dataset.recipientId = 'ALL_USERS';
                        compose.dataset.recipientName = 'Todos los usuarios';
                        compose.dataset.recipientEmail = '';
                    }
                };
                resultsDiv.appendChild(sendToAllBtn);

                // Mostrar resultados
                for (const user of matches) {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'send-mail-result-item';
                    
                    const profilePic = document.createElement('div');
                    profilePic.className = 'mailbox-message-profile';
                    profilePic.style.width = '40px';
                    profilePic.style.height = '40px';
                    
                    // Limpiar el contenedor primero
                    profilePic.innerHTML = '';
                    
                    // Cargar foto de perfil con await
                    if (window.loadUserProfilePicture) {
                        await window.loadUserProfilePicture(user.id, profilePic);
                    } else {
                        const placeholder = document.createElement('div');
                        placeholder.className = 'placeholder';
                        placeholder.textContent = '👤';
                        profilePic.appendChild(placeholder);
                    }

                    const userInfo = document.createElement('div');
                    userInfo.style.flex = '1';
                    userInfo.innerHTML = `
                        <div style="font-weight: 600; color: #333;">${user.nombre || 'Sin nombre'}</div>
                        <div style="font-size: 0.9em; color: #718096;">${user.email || ''}</div>
                    `;

                    resultItem.appendChild(profilePic);
                    resultItem.appendChild(userInfo);
                    
                    resultItem.onclick = () => {
                        // Mostrar formulario de composición
                        const compose = document.getElementById('sendMailCompose');
                        const recipient = document.getElementById('sendMailRecipient');
                        const messageText = document.getElementById('sendMailMessageText');
                        
                        if (compose && recipient && messageText) {
                            compose.style.display = 'block';
                            recipient.innerHTML = `Para: ${user.nombre || 'Sin nombre'} (${user.email || ''})`;
                            messageText.value = '';
                            messageText.focus();
                            
                            // Guardar ID del destinatario
                            compose.dataset.recipientId = user.id;
                            compose.dataset.recipientName = user.nombre || 'Sin nombre';
                            compose.dataset.recipientEmail = user.email || '';
                        }
                    };

                    resultsDiv.appendChild(resultItem);
                }
            } catch (error) {
                console.error('Error al buscar usuarios:', error);
                resultsDiv.innerHTML = '<div style="text-align: center; color: #f56565; padding: 20px;">Error al buscar usuarios.</div>';
            }
        };

        // Función para enviar mensaje a un usuario
        window.sendMailToUser = async function() {
            if (!window.currentUser || window.currentUser.email !== 'mpenalvart1@educacion.navarra.es') {
                return;
            }

            const compose = document.getElementById('sendMailCompose');
            const messageText = document.getElementById('sendMailMessageText');
            
            if (!compose || !messageText) return;

            const recipientId = compose.dataset.recipientId;
            const recipientName = compose.dataset.recipientName;
            const texto = messageText.value.trim();

            if (!recipientId) {
                alert('Por favor, selecciona un destinatario primero');
                return;
            }

            if (!texto) {
                alert('Por favor, escribe un mensaje');
                return;
            }

            try {
                // Obtener información del remitente
                const remitenteDoc = await getDoc(doc(db, "usuarios", window.currentUser.uid));
                const remitenteData = remitenteDoc.exists() ? remitenteDoc.data() : {};
                const nombreRemitente = remitenteData.nombre || window.currentUserName || 'Martin';

                const messagesRef = collection(db, "mensajesCorreo");

                // Si es "Para todos", enviar a todos los usuarios
                if (recipientId === 'ALL_USERS') {
                    const usuariosRef = collection(db, "usuarios");
                    const usuariosSnapshot = await getDocs(usuariosRef);
                    
                    let sentCount = 0;
                    const batch = writeBatch(db);
                    let batchCount = 0;
                    const BATCH_LIMIT = 500; // Límite de Firestore

                    for (const userDoc of usuariosSnapshot.docs) {
                        const userId = userDoc.id;
                        // No enviar a uno mismo
                        if (userId === window.currentUser.uid) continue;

                        const messageRef = doc(messagesRef);
                        batch.set(messageRef, {
                            remitenteId: window.currentUser.uid,
                            nombreRemitente: nombreRemitente,
                            emailRemitente: window.currentUser.email,
                            destinatarioId: userId,
                            texto: texto,
                            timestamp: Date.now(),
                            leido: false
                        });

                        batchCount++;
                        sentCount++;

                        // Ejecutar batch cuando llegue al límite
                        if (batchCount >= BATCH_LIMIT) {
                            await batch.commit();
                            batchCount = 0;
                        }
                    }

                    // Ejecutar batch restante
                    if (batchCount > 0) {
                        await batch.commit();
                    }

                    alert(`✅ Mensaje enviado exitosamente a ${sentCount} usuarios`);
                } else {
                    // Enviar a un usuario específico
                    await addDoc(messagesRef, {
                        remitenteId: window.currentUser.uid,
                        nombreRemitente: nombreRemitente,
                        emailRemitente: window.currentUser.email,
                        destinatarioId: recipientId,
                        texto: texto,
                        timestamp: Date.now(),
                        leido: false
                    });

                    alert('✅ Mensaje enviado exitosamente');
                }

                messageText.value = '';
                compose.style.display = 'none';
                const results = document.getElementById('sendMailResults');
                if (results) results.innerHTML = '';
                const searchInput = document.getElementById('sendMailSearchInput');
                if (searchInput) searchInput.value = '';

                // Enviar notificación (si está implementado)
                if (window.sendNotification && recipientId !== 'ALL_USERS') {
                    await window.sendNotification(recipientId, 'Nuevo mensaje', `${nombreRemitente} te ha enviado un mensaje`);
                }
            } catch (error) {
                console.error('Error al enviar mensaje:', error);
                alert('Error al enviar el mensaje. Por favor, intenta de nuevo.');
            }
        };

        // Función para cargar notificaciones del perfil
        window.loadProfileNotifications = async function() {
            if (!window.currentUser) return;

            try {
                const userId = window.currentUser.uid;
                let totalNotifications = 0;

                // 1. Verificar mensajes nuevos en el buzón de correo
                const messagesRef = collection(db, "mensajesCorreo");
                const messagesQuery = query(
                    messagesRef,
                    where("destinatarioId", "==", userId),
                    where("leido", "==", false)
                );
                const messagesSnapshot = await getDocs(messagesQuery);
                const unreadMessages = messagesSnapshot.size;
                
                if (unreadMessages > 0) {
                    totalNotifications += unreadMessages;
                    const mailboxBtn = document.getElementById('profileMailboxBtn');
                    if (mailboxBtn) {
                        mailboxBtn.classList.add('has-notifications');
                        // Remover badge anterior si existe
                        const existingBadge = mailboxBtn.querySelector('.notification-badge');
                        if (existingBadge) existingBadge.remove();
                        
                        const badge = document.createElement('span');
                        badge.className = 'notification-badge';
                        badge.textContent = unreadMessages > 99 ? '99+' : unreadMessages.toString();
                        mailboxBtn.appendChild(badge);
                    }
                } else {
                    const mailboxBtn = document.getElementById('profileMailboxBtn');
                    if (mailboxBtn) {
                        mailboxBtn.classList.remove('has-notifications');
                        const existingBadge = mailboxBtn.querySelector('.notification-badge');
                        if (existingBadge) existingBadge.remove();
                    }
                }

                // 2. Verificar likes y comentarios en fotos del usuario
                // Primero obtener todas las fotos del usuario
                const fotosRef = collection(db, "fotos");
                const fotosQuery = query(fotosRef, where("userId", "==", userId));
                const fotosSnapshot = await getDocs(fotosQuery);
                
                let unreadLikes = 0;
                let unreadComments = 0;
                const fotosIds = [];
                
                fotosSnapshot.forEach(docSnapshot => {
                    fotosIds.push(docSnapshot.id);
                });

                if (fotosIds.length > 0) {
                    // Verificar likes nuevos (likes que el usuario no ha visto)
                    // Por simplicidad, contamos todos los likes en las fotos del usuario
                    // En una implementación más avanzada, se podría rastrear qué likes ya se vieron
                    const likesRef = collection(db, "fotoLikes");
                    for (const fotoId of fotosIds) {
                        const likesQuery = query(likesRef, where("fotoId", "==", fotoId));
                        const likesSnapshot = await getDocs(likesQuery);
                        unreadLikes += likesSnapshot.size;
                    }

                    // Verificar comentarios nuevos
                    const commentsRef = collection(db, "fotoComentarios");
                    for (const fotoId of fotosIds) {
                        const commentsQuery = query(commentsRef, where("fotoId", "==", fotoId));
                        const commentsSnapshot = await getDocs(commentsQuery);
                        unreadComments += commentsSnapshot.size;
                    }
                }

                // Mostrar badge en la sección de biblioteca si hay likes o comentarios
                if (unreadLikes > 0 || unreadComments > 0) {
                    const librarySection = document.getElementById('profileLibrarySection');
                    if (librarySection) {
                        librarySection.classList.add('has-notifications');
                        // Remover badge anterior si existe
                        const existingBadge = librarySection.querySelector('.notification-badge');
                        if (existingBadge) existingBadge.remove();
                        
                        const badge = document.createElement('span');
                        badge.className = 'notification-badge large';
                        const totalInteractions = unreadLikes + unreadComments;
                        badge.textContent = totalInteractions > 99 ? '99+' : totalInteractions.toString();
                        badge.title = `${unreadLikes} likes, ${unreadComments} comentarios`;
                        librarySection.appendChild(badge);
                    }
                } else {
                    const librarySection = document.getElementById('profileLibrarySection');
                    if (librarySection) {
                        librarySection.classList.remove('has-notifications');
                        const existingBadge = librarySection.querySelector('.notification-badge');
                        if (existingBadge) existingBadge.remove();
                    }
                }

                // 3. Verificar mensajes nuevos en chats
                const chatMessagesRef = collection(db, "mensajes");
                const chatMessagesQuery = query(
                    chatMessagesRef,
                    where("toUserId", "==", userId),
                    where("read", "==", false)
                );
                const chatMessagesSnapshot = await getDocs(chatMessagesQuery);
                const unreadChatMessages = chatMessagesSnapshot.size;

                if (unreadChatMessages > 0) {
                    const chatsSection = document.getElementById('profileChatsSection');
                    if (chatsSection) {
                        chatsSection.classList.add('has-notifications');
                        // Remover badge anterior si existe
                        const existingBadge = chatsSection.querySelector('.notification-badge');
                        if (existingBadge) existingBadge.remove();
                        
                        const badge = document.createElement('span');
                        badge.className = 'notification-badge large';
                        badge.textContent = unreadChatMessages > 99 ? '99+' : unreadChatMessages.toString();
                        badge.title = `${unreadChatMessages} mensajes no leídos`;
                        // Agregar el badge al título
                        const chatsTitle = chatsSection.querySelector('h3');
                        if (chatsTitle) {
                            chatsTitle.style.position = 'relative';
                            chatsTitle.appendChild(badge);
                        } else {
                            chatsSection.appendChild(badge);
                        }
                    }
                } else {
                    const chatsSection = document.getElementById('profileChatsSection');
                    if (chatsSection) {
                        chatsSection.classList.remove('has-notifications');
                        const existingBadge = chatsSection.querySelector('.notification-badge');
                        if (existingBadge) existingBadge.remove();
                    }
                }

                // 4. Verificar solicitudes de amistad pendientes
                const userDoc = await getDoc(doc(db, "usuarios", userId));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    const solicitudesRecibidas = userData.solicitudesRecibidas || [];
                    
                    if (solicitudesRecibidas.length > 0) {
                        const inboxBtn = document.getElementById('profileInboxBtn');
                        if (inboxBtn) {
                            inboxBtn.classList.add('has-notifications');
                            // Remover badge anterior si existe
                            const existingBadge = inboxBtn.querySelector('.notification-badge');
                            if (existingBadge) existingBadge.remove();
                            
                            const badge = document.createElement('span');
                            badge.className = 'notification-badge';
                            badge.textContent = solicitudesRecibidas.length > 99 ? '99+' : solicitudesRecibidas.length.toString();
                            inboxBtn.appendChild(badge);
                        }
                    } else {
                        const inboxBtn = document.getElementById('profileInboxBtn');
                        if (inboxBtn) {
                            inboxBtn.classList.remove('has-notifications');
                            const existingBadge = inboxBtn.querySelector('.notification-badge');
                            if (existingBadge) existingBadge.remove();
                        }
                    }
                }

            } catch (error) {
                console.error('Error al cargar notificaciones del perfil:', error);
            }
        };

        // Cargar preferencia de mostrar puntuaciones
        window.loadScoresPreference = async function() {
            if (!window.currentUser) return;
            
            try {
                const userDoc = await getDoc(doc(db, "usuarios", window.currentUser.uid));
                if (userDoc.exists()) {
                    const mostrarPuntuaciones = userDoc.data().mostrarPuntuaciones !== false; // Por defecto true
                    const toggleBtn = document.getElementById('profileToggleScoresBtn');
                    const scoresSection = document.getElementById('profileScoresSection');
                    
                    if (toggleBtn) {
                        if (mostrarPuntuaciones) {
                            toggleBtn.textContent = '🔒 Ocultar Puntuaciones';
                            toggleBtn.classList.remove('hidden');
                        } else {
                            toggleBtn.textContent = '📊 Mostrar Puntuaciones';
                            toggleBtn.classList.add('hidden');
                        }
                    }
                    
                    if (scoresSection) {
                        scoresSection.style.display = mostrarPuntuaciones ? 'block' : 'none';
                    }
                }
            } catch (error) {
                console.error('Error al cargar preferencia de puntuaciones:', error);
            }
        };

        // Toggle mostrar/ocultar puntuaciones
        window.toggleScoresVisibility = async function() {
            if (!window.currentUser) return;
            
            try {
                const userDoc = await getDoc(doc(db, "usuarios", window.currentUser.uid));
                const currentValue = userDoc.exists() ? (userDoc.data().mostrarPuntuaciones !== false) : true;
                const newValue = !currentValue;
                
                await updateDoc(doc(db, "usuarios", window.currentUser.uid), {
                    mostrarPuntuaciones: newValue
                });
                
                const toggleBtn = document.getElementById('profileToggleScoresBtn');
                const scoresSection = document.getElementById('profileScoresSection');
                
                if (toggleBtn) {
                    if (newValue) {
                        toggleBtn.textContent = '🔒 Ocultar Puntuaciones';
                        toggleBtn.classList.remove('hidden');
                    } else {
                        toggleBtn.textContent = '📊 Mostrar Puntuaciones';
                        toggleBtn.classList.add('hidden');
                    }
                }
                
                if (scoresSection) {
                    scoresSection.style.display = newValue ? 'block' : 'none';
                }
                
                // Recargar puntuaciones si se muestran
                if (newValue && window.loadUserScores) {
                    await window.loadUserScores();
                }
            } catch (error) {
                console.error('Error al actualizar preferencia de puntuaciones:', error);
                alert('Error al actualizar la preferencia');
            }
        };

        // Cargar puntuaciones del usuario actual
        window.loadUserScores = async function() {
            if (!window.currentUser) return;
            
            try {
                const scoresRef = collection(db, "puntuaciones");
                const q = query(
                    scoresRef,
                    where("userId", "==", window.currentUser.uid)
                );
                const snapshot = await getDocs(q);
                
                const scoresByLevel = {};
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const nivel = data.nivel || 'unknown';
                    const puntos = data.puntos || 0;
                    
                    // Guardar la puntuación máxima por nivel
                    if (!scoresByLevel[nivel] || puntos > scoresByLevel[nivel]) {
                        scoresByLevel[nivel] = puntos;
                    }
                });
                
                const scoresListEl = document.getElementById('scoresList');
                if (!scoresListEl) return;
                
                scoresListEl.innerHTML = '';
                
                const niveles = [
                    { key: 'easy', name: '🟢 Fácil' },
                    { key: 'hard', name: '🔴 Difícil' },
                    { key: 'impossible', name: '⚫ Imposible' },
                    { key: 'god', name: '✨ Dios' }
                ];
                
                niveles.forEach(nivel => {
                    const scoreItem = document.createElement('div');
                    scoreItem.className = 'score-item';
                    
                    const level = document.createElement('div');
                    level.className = 'score-item-level';
                    level.textContent = nivel.name;
                    
                    const points = document.createElement('div');
                    points.className = 'score-item-points';
                    points.textContent = scoresByLevel[nivel.key] || '0';
                    
                    scoreItem.appendChild(level);
                    scoreItem.appendChild(points);
                    scoresListEl.appendChild(scoreItem);
                });
            } catch (error) {
                console.error('Error al cargar puntuaciones:', error);
            }
        };

        // Mostrar perfil de un amigo
        window.showFriendProfile = async function(friendId, friendData = null) {
            if (!friendId) return;
            
            try {
                // Cargar datos del amigo si no se proporcionaron
                if (!friendData) {
                    const friendDoc = await getDoc(doc(db, "usuarios", friendId));
                    if (!friendDoc.exists()) {
                        alert('Usuario no encontrado');
                        return;
                    }
                    friendData = friendDoc.data();
                }
                
                const modal = document.getElementById('friendProfileModal');
                const nameEl = document.getElementById('friendProfileName');
                const emailEl = document.getElementById('friendProfileEmail');
                const pictureLarge = document.getElementById('friendProfilePictureLarge');
                const pictureLargeImg = document.getElementById('friendProfilePictureLargeImg');
                const pictureLargePlaceholder = document.getElementById('friendProfilePictureLargePlaceholder');
                const scoresSection = document.getElementById('friendProfileScoresSection');
                
                if (!modal || !nameEl || !emailEl) return;
                
                // Mostrar información básica
                nameEl.textContent = friendData.nombre || 'Sin nombre';
                emailEl.textContent = friendData.email || '-';
                
                // Cargar foto de perfil con estilos y decoraciones usando loadUserProfilePicture
                if (pictureLarge && window.loadUserProfilePicture) {
                    await window.loadUserProfilePicture(friendId, pictureLarge);
                } else {
                    // Fallback: cargar imagen directamente si loadUserProfilePicture no está disponible
                    if (friendData.fotoPerfil) {
                        if (pictureLargeImg) {
                            pictureLargeImg.src = friendData.fotoPerfil;
                            pictureLargeImg.style.display = 'block';
                        }
                        if (pictureLargePlaceholder) {
                            pictureLargePlaceholder.style.display = 'none';
                        }
                    } else {
                        if (pictureLargeImg) {
                            pictureLargeImg.style.display = 'none';
                        }
                        if (pictureLargePlaceholder) {
                            pictureLargePlaceholder.style.display = 'block';
                        }
                    }
                }
                
                // Mostrar descripción si existe (solo visible para amigos)
                const descriptionItem = document.getElementById('friendDescriptionItem');
                const descriptionEl = document.getElementById('friendProfileDescription');
                if (friendData.descripcion && friendData.descripcion.trim()) {
                    if (descriptionEl) {
                        descriptionEl.textContent = friendData.descripcion;
                    }
                    if (descriptionItem) {
                        descriptionItem.style.display = 'flex';
                    }
                } else {
                    if (descriptionItem) {
                        descriptionItem.style.display = 'none';
                    }
                }
                
                // Configurar botón de eliminar amigo
                const removeFriendBtn = document.getElementById('removeFriendBtn');
                if (removeFriendBtn) {
                    removeFriendBtn.onclick = async () => {
                        if (confirm(`¿Estás seguro de que quieres eliminar a ${friendData.nombre || 'este amigo'}?`)) {
                            const success = await window.removeFriend(friendId);
                            if (success) {
                                window.hideFriendProfileModal();
                                await window.loadFriendsList();
                            }
                        }
                    };
                }
                
                // Verificar si el amigo tiene la opción de mostrar puntuaciones activada
                const mostrarPuntuaciones = friendData.mostrarPuntuaciones !== false; // Por defecto true
                
                if (mostrarPuntuaciones) {
                    // Cargar puntuaciones del amigo
                    await loadFriendScores(friendId);
                    if (scoresSection) {
                        scoresSection.style.display = 'block';
                    }
                } else {
                    if (scoresSection) {
                        scoresSection.style.display = 'none';
                    }
                }
                
                // Limpiar biblioteca del amigo primero
                const friendLibraryGrid = document.getElementById('friendLibraryGrid');
                const friendLibrarySection = document.getElementById('friendLibrarySection');
                if (friendLibraryGrid) {
                    friendLibraryGrid.innerHTML = '';
                }
                if (friendLibrarySection) {
                    friendLibrarySection.style.display = 'none';
                }
                
                // Cargar biblioteca del amigo (solo visible para amigos)
                if (window.loadFriendLibrary) {
                    await window.loadFriendLibrary(friendId);
                }
                
                modal.style.display = 'flex';
            } catch (error) {
                console.error('Error al cargar perfil de amigo:', error);
                alert('Error al cargar el perfil del amigo');
            }
        };

        // Cargar puntuaciones de un amigo
        async function loadFriendScores(friendId) {
            try {
                const scoresRef = collection(db, "puntuaciones");
                const q = query(
                    scoresRef,
                    where("userId", "==", friendId)
                );
                const snapshot = await getDocs(q);
                
                const scoresByLevel = {};
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const nivel = data.nivel || 'unknown';
                    const puntos = data.puntos || 0;
                    
                    // Guardar la puntuación máxima por nivel
                    if (!scoresByLevel[nivel] || puntos > scoresByLevel[nivel]) {
                        scoresByLevel[nivel] = puntos;
                    }
                });
                
                const scoresListEl = document.getElementById('friendScoresList');
                if (!scoresListEl) return;
                
                scoresListEl.innerHTML = '';
                
                const niveles = [
                    { key: 'easy', name: '🟢 Fácil' },
                    { key: 'hard', name: '🔴 Difícil' },
                    { key: 'impossible', name: '⚫ Imposible' },
                    { key: 'god', name: '✨ Dios' }
                ];
                
                niveles.forEach(nivel => {
                    const scoreItem = document.createElement('div');
                    scoreItem.className = 'score-item';
                    
                    const level = document.createElement('div');
                    level.className = 'score-item-level';
                    level.textContent = nivel.name;
                    
                    const points = document.createElement('div');
                    points.className = 'score-item-points';
                    points.textContent = scoresByLevel[nivel.key] || '0';
                    
                    scoreItem.appendChild(level);
                    scoreItem.appendChild(points);
                    scoresListEl.appendChild(scoreItem);
                });
            } catch (error) {
                console.error('Error al cargar puntuaciones del amigo:', error);
            }
        };

        // Ocultar modal de perfil de amigo
        window.hideFriendProfileModal = function() {
            const modal = document.getElementById('friendProfileModal');
            if (modal) {
                modal.style.display = 'none';
            }
        };

        // Guardar descripción del perfil
        window.saveProfileDescription = async function() {
            if (!window.currentUser) return false;
            
            try {
                const descriptionInput = document.getElementById('profileDescription');
                if (!descriptionInput) return false;
                
                const descripcion = descriptionInput.value.trim();
                
                await updateDoc(doc(db, "usuarios", window.currentUser.uid), {
                    descripcion: descripcion
                });
                
                const saveBtn = document.getElementById('profileSaveDescriptionBtn');
                if (saveBtn) {
                    const originalText = saveBtn.textContent;
                    saveBtn.textContent = '✅ Guardado';
                    saveBtn.disabled = true;
                    setTimeout(() => {
                        saveBtn.textContent = originalText;
                        saveBtn.disabled = false;
                    }, 2000);
                }
                
                return true;
            } catch (error) {
                console.error('Error al guardar descripción:', error);
                alert('Error al guardar la descripción');
                return false;
            }
        };

        // Cargar descripción del perfil
        window.loadProfileDescription = async function() {
            if (!window.currentUser) return;
            
            try {
                const userDoc = await getDoc(doc(db, "usuarios", window.currentUser.uid));
                if (userDoc.exists()) {
                    const descripcion = userDoc.data().descripcion || '';
                    const descriptionInput = document.getElementById('profileDescription');
                    if (descriptionInput) {
                        descriptionInput.value = descripcion;
                    }
                }
            } catch (error) {
                console.error('Error al cargar descripción:', error);
            }
        };

        // Comprimir imagen para biblioteca (similar a foto de perfil)
        async function compressLibraryImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const maxWidth = 800;
                        const maxHeight = 800;
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > height) {
                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width *= maxHeight / height;
                                height = maxHeight;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        const compressedBase64 = canvas.toDataURL('image/jpeg', 0.8);
                        resolve(compressedBase64);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // Subir foto a la biblioteca
        window.uploadLibraryImage = async function(file) {
            if (!window.currentUser) return false;
            
            try {
                const compressedBase64 = await compressLibraryImage(file);
                
                const userDoc = await getDoc(doc(db, "usuarios", window.currentUser.uid));
                const biblioteca = userDoc.exists() ? (userDoc.data().biblioteca || []) : [];
                
                biblioteca.push(compressedBase64);
                
                await updateDoc(doc(db, "usuarios", window.currentUser.uid), {
                    biblioteca: biblioteca
                });
                
                // Recargar biblioteca
                await window.loadLibrary();
                
                return true;
            } catch (error) {
                console.error('Error al subir foto a biblioteca:', error);
                alert('Error al subir la foto');
                return false;
            }
        };

        // Cargar biblioteca propia
        window.loadLibrary = async function() {
            if (!window.currentUser) return;
            
            try {
                const userDoc = await getDoc(doc(db, "usuarios", window.currentUser.uid));
                const biblioteca = userDoc.exists() ? (userDoc.data().biblioteca || []) : [];
                
                const libraryGrid = document.getElementById('libraryGrid');
                if (!libraryGrid) return;
                
                libraryGrid.innerHTML = '';
                
                // Usar Promise.all para esperar a que se generen todos los fotoIds
                const items = await Promise.all(biblioteca.map(async (imageBase64, index) => {
                    const libraryItem = document.createElement('div');
                    libraryItem.className = 'library-item';
                    
                    const img = document.createElement('img');
                    img.src = imageBase64;
                    img.alt = `Foto ${index + 1}`;
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'library-item-remove';
                    removeBtn.textContent = '✕';
                    removeBtn.onclick = async (e) => {
                        e.stopPropagation();
                        if (confirm('¿Estás seguro de que quieres eliminar esta foto?')) {
                            await window.removeLibraryImage(index);
                        }
                    };
                    
                    // Generar fotoId único
                    const fotoId = await generateFotoId(imageBase64, window.currentUser.uid, index);
                    console.log(`Foto ${index} - fotoId generado:`, fotoId);
                    
                    // Guardar fotoId en el elemento para poder encontrarlo después
                    libraryItem.setAttribute('data-foto-id', fotoId);
                    
                    // Verificar si esta foto tiene interacciones (likes o comentarios)
                    try {
                        const likesRef = collection(db, "fotoLikes");
                        const likesQuery = query(likesRef, where("fotoId", "==", fotoId));
                        const likesSnapshot = await getDocs(likesQuery);
                        const hasLikes = likesSnapshot.size > 0;
                        
                        const commentsRef = collection(db, "fotoComentarios");
                        const commentsQuery = query(commentsRef, where("fotoId", "==", fotoId));
                        const commentsSnapshot = await getDocs(commentsQuery);
                        const hasComments = commentsSnapshot.size > 0;
                        
                        if (hasLikes || hasComments) {
                            libraryItem.classList.add('has-interactions');
                        }
                    } catch (error) {
                        console.error('Error al verificar interacciones:', error);
                    }
                    
                    libraryItem.onclick = async () => {
                        console.log('Click en foto, abriendo con fotoId:', fotoId);
                        // Quitar el estilo de "has-interactions" al abrir la foto
                        libraryItem.classList.remove('has-interactions');
                        await window.showLibraryImage(imageBase64, fotoId, window.currentUser.uid);
                    };
                    
                    libraryItem.appendChild(img);
                    libraryItem.appendChild(removeBtn);
                    return libraryItem;
                }));
                
                items.forEach(item => libraryGrid.appendChild(item));
            } catch (error) {
                console.error('Error al cargar biblioteca:', error);
            }
        };

        // Cargar biblioteca del amigo
        window.loadFriendLibrary = async function(friendId) {
            if (!friendId) return;
            
            try {
                const friendDoc = await getDoc(doc(db, "usuarios", friendId));
                if (!friendDoc.exists()) return;
                
                const biblioteca = friendDoc.data().biblioteca || [];
                const friendLibraryGrid = document.getElementById('friendLibraryGrid');
                const friendLibrarySection = document.getElementById('friendLibrarySection');
                
                if (!friendLibraryGrid || !friendLibrarySection) return;
                
                if (biblioteca.length === 0) {
                    friendLibrarySection.style.display = 'none';
                    return;
                }
                
                friendLibrarySection.style.display = 'block';
                friendLibraryGrid.innerHTML = '';
                
                // Usar Promise.all para esperar a que se generen todos los fotoIds
                const items = await Promise.all(biblioteca.map(async (imageBase64, index) => {
                    const libraryItem = document.createElement('div');
                    libraryItem.className = 'friend-library-item';
                    
                    const img = document.createElement('img');
                    img.src = imageBase64;
                    img.alt = 'Foto de biblioteca';
                    
                    // Generar fotoId único
                    const fotoId = await generateFotoId(imageBase64, friendId, index);
                    console.log(`Foto amigo ${index} - fotoId generado:`, fotoId);
                    
                    libraryItem.onclick = async () => {
                        console.log('Click en foto de amigo, abriendo con fotoId:', fotoId);
                        await window.showLibraryImage(imageBase64, fotoId, friendId);
                    };
                    
                    libraryItem.appendChild(img);
                    return libraryItem;
                }));
                
                items.forEach(item => friendLibraryGrid.appendChild(item));
            } catch (error) {
                console.error('Error al cargar biblioteca del amigo:', error);
            }
        };

        // Eliminar foto de la biblioteca
        window.removeLibraryImage = async function(index) {
            if (!window.currentUser) return false;
            
            try {
                const userDoc = await getDoc(doc(db, "usuarios", window.currentUser.uid));
                const biblioteca = userDoc.exists() ? (userDoc.data().biblioteca || []) : [];
                
                biblioteca.splice(index, 1);
                
                await updateDoc(doc(db, "usuarios", window.currentUser.uid), {
                    biblioteca: biblioteca
                });
                
                // Recargar biblioteca
                await window.loadLibrary();
                
                return true;
            } catch (error) {
                console.error('Error al eliminar foto:', error);
                alert('Error al eliminar la foto');
                return false;
            }
        };

        // Generar ID único para una foto basado en su contenido
        async function generateFotoId(imageBase64, userId, index) {
            // Crear un hash del contenido de la imagen + userId + index para que sea único para cada foto
            // Incluir el índice para asegurar que cada foto tenga un ID único incluso si tienen contenido similar
            // Usar una parte del base64 (primeros 1000 caracteres) + userId + index
            const contentToHash = imageBase64.substring(0, 1000) + userId + '_' + index + '_' + imageBase64.length;
            const hash = await hashString(contentToHash);
            return `foto_${userId}_${index}_${hash}`;
        }

        // Función auxiliar para crear hash simple
        async function hashString(str) {
            const encoder = new TextEncoder();
            const data = encoder.encode(str);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('').substring(0, 16);
        }

        // Mostrar imagen en grande
        window.showLibraryImage = async function(imageBase64, fotoId = null, ownerId = null) {
            const modal = document.getElementById('libraryImageModal');
            const modalImg = document.getElementById('libraryImageModalImg');
            
            if (modal && modalImg) {
                modalImg.src = imageBase64;
                window.currentFotoId = fotoId;
                window.currentFotoOwnerId = ownerId;
                window.currentImageBase64 = imageBase64; // Guardar para la vista ampliada
                console.log('Mostrando imagen, fotoId:', fotoId, 'ownerId:', ownerId);
                modal.style.display = 'flex';
                
                // Agregar evento click en la imagen para vista ampliada
                const imageContainer = document.getElementById('libraryImageContainer');
                if (imageContainer) {
                    imageContainer.onclick = () => {
                        window.showLibraryImageZoom(imageBase64);
                    };
                }
                
                // Cargar likes y comentarios si hay fotoId
                if (fotoId) {
                    try {
                        await loadFotoLikes(fotoId);
                        await loadFotoComments(fotoId);
                    } catch (error) {
                        console.error('Error al cargar likes/comentarios:', error);
                    }
                } else {
                    console.warn('No hay fotoId, limpiando likes y comentarios');
                    // Si no hay fotoId, limpiar likes y comentarios
                    const likeCountEl = document.getElementById('libraryImageLikeCount');
                    const commentsListEl = document.getElementById('libraryImageCommentsList');
                    const likeBtn = document.getElementById('libraryImageLikeBtn');
                    if (likeCountEl) likeCountEl.textContent = '0';
                    if (commentsListEl) commentsListEl.innerHTML = '';
                    if (likeBtn) likeBtn.classList.remove('liked');
                }
            } else {
                console.error('Modal o imagen no encontrados');
            }
        };

        // Mostrar imagen en vista ampliada
        window.showLibraryImageZoom = function(imageBase64) {
            const zoomModal = document.getElementById('libraryImageZoomModal');
            const zoomImg = document.getElementById('libraryImageZoomImg');
            
            if (zoomModal && zoomImg) {
                zoomImg.src = imageBase64;
                zoomModal.classList.add('active');
            }
        };

        // Ocultar vista ampliada y volver a comentarios
        window.hideLibraryImageZoom = function() {
            const zoomModal = document.getElementById('libraryImageZoomModal');
            if (zoomModal) {
                zoomModal.classList.remove('active');
            }
        };

        // Ocultar imagen en grande
        window.hideLibraryImage = function() {
            const modal = document.getElementById('libraryImageModal');
            const zoomModal = document.getElementById('libraryImageZoomModal');
            if (modal) {
                modal.style.display = 'none';
                window.currentFotoId = null;
                window.currentFotoOwnerId = null;
                window.currentImageBase64 = null;
            }
            // También cerrar el zoom si está abierto
            if (zoomModal) {
                zoomModal.classList.remove('active');
            }
        };

        // ----------- LIKES Y COMENTARIOS DE FOTOS -------------
        
        // Dar like o quitar like a una foto
        window.toggleFotoLike = async function(fotoId) {
            if (!window.currentUser || !fotoId) {
                console.error('toggleFotoLike: No hay usuario o fotoId', { user: !!window.currentUser, fotoId });
                return false;
            }
            
            try {
                const userId = window.currentUser.uid;
                console.log('toggleFotoLike: Buscando like para fotoId:', fotoId, 'userId:', userId);
                const likesRef = collection(db, "fotoLikes");
                const q = query(likesRef, where("fotoId", "==", fotoId), where("userId", "==", userId));
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    // No hay like, agregar uno
                    console.log('toggleFotoLike: Agregando like');
                    await addDoc(likesRef, {
                        fotoId: fotoId,
                        userId: userId,
                        timestamp: Date.now()
                    });
                } else {
                    // Ya hay like, eliminarlo
                    console.log('toggleFotoLike: Eliminando like');
                    const deletePromises = snapshot.docs.map(docSnapshot => 
                        deleteDoc(doc(db, "fotoLikes", docSnapshot.id))
                    );
                    await Promise.all(deletePromises);
                }
                
                // Recargar likes
                await loadFotoLikes(fotoId);
                return true;
            } catch (error) {
                console.error('Error al dar like:', error);
                alert('Error al dar like: ' + error.message);
                return false;
            }
        };

        // Cargar likes de una foto
        async function loadFotoLikes(fotoId) {
            if (!fotoId) return;
            
            try {
                const likesRef = collection(db, "fotoLikes");
                const q = query(likesRef, where("fotoId", "==", fotoId));
                const snapshot = await getDocs(q);
                
                const likeCount = snapshot.size;
                const likeCountEl = document.getElementById('libraryImageLikeCount');
                if (likeCountEl) {
                    likeCountEl.textContent = likeCount;
                }
                
                // Verificar si el usuario actual dio like
                if (window.currentUser) {
                    const userLiked = snapshot.docs.some(doc => doc.data().userId === window.currentUser.uid);
                    const likeBtn = document.getElementById('libraryImageLikeBtn');
                    if (likeBtn) {
                        if (userLiked) {
                            likeBtn.classList.add('liked');
                        } else {
                            likeBtn.classList.remove('liked');
                        }
                    }
                }
            } catch (error) {
                console.error('Error al cargar likes:', error);
            }
        }

        // Agregar comentario a una foto (o respuesta a un comentario)
        window.addFotoComment = async function(fotoId, comentario, parentCommentId = null) {
            // Usar el fotoId del modal actual si no se proporciona uno
            if (!fotoId && window.currentFotoId) {
                fotoId = window.currentFotoId;
                console.log('addFotoComment: Usando fotoId del modal actual:', fotoId);
            }
            
            if (!window.currentUser || !fotoId || !comentario || comentario.trim() === '') {
                console.error('addFotoComment: Parámetros inválidos', { 
                    user: !!window.currentUser, 
                    fotoId, 
                    comentario: comentario ? comentario.trim() : '',
                    currentFotoId: window.currentFotoId
                });
                alert('Error: No se pudo identificar la foto. Por favor, cierra y vuelve a abrir la imagen.');
                return false;
            }
            
            try {
                const userId = window.currentUser.uid;
                console.log('addFotoComment: Agregando comentario para fotoId:', fotoId, 'parentCommentId:', parentCommentId);
                const userDoc = await getDoc(doc(db, "usuarios", userId));
                const nombreUsuario = userDoc.exists() ? (userDoc.data().nombre || 'Anónimo') : 'Anónimo';
                
                const comentariosRef = collection(db, "fotoComentarios");
                const commentData = {
                    fotoId: fotoId,  // Asegurar que el fotoId esté correctamente vinculado
                    userId: userId,
                    nombreUsuario: nombreUsuario,
                    comentario: comentario.trim(),
                    timestamp: Date.now()
                };
                
                // Si es una respuesta, agregar el parentCommentId
                if (parentCommentId) {
                    commentData.parentCommentId = parentCommentId;
                }
                
                await addDoc(comentariosRef, commentData);
                
                console.log('addFotoComment: Comentario agregado exitosamente para fotoId:', fotoId);
                
                // Recargar comentarios usando el mismo fotoId
                await loadFotoComments(fotoId);
                
                // Limpiar inputs
                const commentInput = document.getElementById('libraryImageCommentInput');
                if (commentInput) {
                    commentInput.value = '';
                }
                
                // Ocultar inputs de respuesta
                document.querySelectorAll('.comment-reply-input-container').forEach(container => {
                    container.classList.remove('active');
                    const input = container.querySelector('.comment-reply-input');
                    if (input) input.value = '';
                });
                
                return true;
            } catch (error) {
                console.error('Error al agregar comentario:', error);
                alert('Error al agregar el comentario: ' + error.message);
                return false;
            }
        };

        // Dar like o quitar like a un comentario
        window.toggleCommentLike = async function(commentId) {
            if (!window.currentUser || !commentId) {
                console.error('toggleCommentLike: No hay usuario o commentId');
                return false;
            }
            
            try {
                const userId = window.currentUser.uid;
                const likesRef = collection(db, "comentarioLikes");
                const q = query(likesRef, where("commentId", "==", commentId), where("userId", "==", userId));
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    // No hay like, agregar uno
                    await addDoc(likesRef, {
                        commentId: commentId,
                        userId: userId,
                        timestamp: Date.now()
                    });
                } else {
                    // Ya hay like, eliminarlo
                    const deletePromises = snapshot.docs.map(docSnapshot => 
                        deleteDoc(doc(db, "comentarioLikes", docSnapshot.id))
                    );
                    await Promise.all(deletePromises);
                }
                
                // Recargar comentarios para actualizar likes
                if (window.currentFotoId) {
                    await loadFotoComments(window.currentFotoId);
                }
                
                return true;
            } catch (error) {
                console.error('Error al dar like al comentario:', error);
                return false;
            }
        };

        // Cargar likes de un comentario
        async function loadCommentLikes(commentId) {
            if (!commentId) return { count: 0, userLiked: false };
            
            try {
                const likesRef = collection(db, "comentarioLikes");
                const q = query(likesRef, where("commentId", "==", commentId));
                const snapshot = await getDocs(q);
                
                const count = snapshot.size;
                const userLiked = window.currentUser ? 
                    snapshot.docs.some(doc => doc.data().userId === window.currentUser.uid) : false;
                
                return { count, userLiked };
            } catch (error) {
                console.error('Error al cargar likes del comentario:', error);
                return { count: 0, userLiked: false };
            }
        }

        // Función auxiliar para crear un elemento de comentario
        async function createCommentElement(data, isReply = false, parentAuthor = null) {
            const commentItem = document.createElement('div');
            commentItem.className = isReply ? 'comment-reply-item' : 'comment-item';
            commentItem.dataset.commentId = data.id;
            
            // Contenedor para foto de perfil
            const profilePicContainer = document.createElement('div');
            profilePicContainer.className = 'comment-profile-picture';
            
            // Cargar foto de perfil si hay userId
            if (data.userId && window.loadUserProfilePicture) {
                await window.loadUserProfilePicture(data.userId, profilePicContainer);
            } else {
                const placeholder = document.createElement('div');
                placeholder.className = 'placeholder';
                placeholder.textContent = '👤';
                profilePicContainer.appendChild(placeholder);
            }
            
            // Contenedor para el contenido del comentario
            const commentContent = document.createElement('div');
            commentContent.className = 'comment-content';
            
            // Si es una respuesta y tenemos el autor del comentario padre, mostrar indicador
            if (isReply && parentAuthor) {
                const replyIndicator = document.createElement('div');
                replyIndicator.className = 'comment-reply-indicator';
                replyIndicator.textContent = `Respondiendo a ${parentAuthor}`;
                commentContent.appendChild(replyIndicator);
            }
            
            const author = document.createElement('div');
            author.className = 'comment-author';
            author.textContent = data.nombreUsuario || 'Anónimo';
            
            const text = document.createElement('div');
            text.className = 'comment-text';
            text.textContent = data.comentario;
            
            // Cargar likes del comentario
            const likesData = await loadCommentLikes(data.id);
            
            // Acciones del comentario (tanto para comentarios principales como respuestas)
            const actions = document.createElement('div');
            actions.className = 'comment-actions';
            
            // Botón de like
            const likeBtn = document.createElement('button');
            likeBtn.className = 'comment-like-btn' + (likesData.userLiked ? ' liked' : '');
            likeBtn.dataset.commentId = data.id;
            likeBtn.innerHTML = `<span class="like-icon">${likesData.userLiked ? '❤️' : '🤍'}</span> <span class="like-count">${likesData.count}</span>`;
            likeBtn.onclick = async (e) => {
                e.stopPropagation();
                if (window.toggleCommentLike) {
                    await window.toggleCommentLike(data.id);
                }
            };
            
            // Botón de responder
            const replyBtn = document.createElement('button');
            replyBtn.className = 'comment-reply-btn';
            replyBtn.textContent = '💬 Responder';
            replyBtn.onclick = (e) => {
                e.stopPropagation();
                const replyContainer = commentItem.querySelector('.comment-reply-input-container');
                if (replyContainer) {
                    replyContainer.classList.toggle('active');
                    if (replyContainer.classList.contains('active')) {
                        const input = replyContainer.querySelector('.comment-reply-input');
                        if (input) input.focus();
                    }
                }
            };
            
            actions.appendChild(likeBtn);
            actions.appendChild(replyBtn);
            
            // Botón de eliminar (solo si el comentario pertenece al usuario actual)
            if (window.currentUser && data.userId === window.currentUser.uid) {
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'comment-delete-btn';
                deleteBtn.textContent = '🗑️ Eliminar';
                deleteBtn.onclick = async (e) => {
                    e.stopPropagation();
                    if (confirm('¿Estás seguro de que quieres eliminar este comentario?')) {
                        try {
                            const fotoId = data.fotoId || window.currentFotoId;
                            if (!fotoId) {
                                alert('Error: No se pudo identificar la foto. Por favor, cierra y vuelve a abrir la imagen.');
                                return;
                            }
                            await deleteComment(data.id, fotoId);
                        } catch (error) {
                            console.error('Error al eliminar comentario:', error);
                            alert('Error al eliminar el comentario. Por favor, intenta de nuevo.');
                        }
                    }
                };
                actions.appendChild(deleteBtn);
            }
            
            // Contenedor para input de respuesta
            const replyInputContainer = document.createElement('div');
            replyInputContainer.className = 'comment-reply-input-container';
            const replyInput = document.createElement('input');
            replyInput.type = 'text';
            replyInput.className = 'comment-reply-input';
            replyInput.placeholder = 'Escribe una respuesta...';
            const replySubmit = document.createElement('button');
            replySubmit.className = 'comment-reply-submit';
            replySubmit.textContent = 'Enviar';
            replySubmit.onclick = async (e) => {
                e.stopPropagation();
                const replyText = replyInput.value.trim();
                if (replyText && window.currentFotoId && window.addFotoComment) {
                    await window.addFotoComment(window.currentFotoId, replyText, data.id);
                }
            };
            replyInput.addEventListener('keypress', async (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const replyText = replyInput.value.trim();
                    if (replyText && window.currentFotoId && window.addFotoComment) {
                        await window.addFotoComment(window.currentFotoId, replyText, data.id);
                    }
                }
            });
            replyInputContainer.appendChild(replyInput);
            replyInputContainer.appendChild(replySubmit);
            
            commentContent.appendChild(author);
            commentContent.appendChild(text);
            commentContent.appendChild(actions);
            commentContent.appendChild(replyInputContainer);
            
            commentItem.appendChild(profilePicContainer);
            commentItem.appendChild(commentContent);
            
            return commentItem;
        }

        // Función para eliminar un comentario y sus respuestas asociadas
        async function deleteComment(commentId, fotoId) {
            if (!commentId || !fotoId) {
                console.error('deleteComment: Parámetros inválidos');
                return;
            }

            try {
                // Función recursiva para eliminar un comentario y todas sus respuestas
                async function deleteCommentAndReplies(commentIdToDelete) {
                    // Buscar todas las respuestas a este comentario
                    const comentariosRef = collection(db, "fotoComentarios");
                    const repliesQuery = query(comentariosRef, where("parentCommentId", "==", commentIdToDelete));
                    const repliesSnapshot = await getDocs(repliesQuery);
                    
                    // Eliminar todas las respuestas recursivamente
                    for (const replyDoc of repliesSnapshot.docs) {
                        await deleteCommentAndReplies(replyDoc.id);
                    }
                    
                    // Eliminar todos los likes asociados a este comentario
                    const likesRef = collection(db, "comentarioLikes");
                    const likesQuery = query(likesRef, where("commentId", "==", commentIdToDelete));
                    const likesSnapshot = await getDocs(likesQuery);
                    
                    for (const likeDoc of likesSnapshot.docs) {
                        await deleteDoc(doc(db, "comentarioLikes", likeDoc.id));
                    }
                    
                    // Eliminar el comentario
                    await deleteDoc(doc(db, "fotoComentarios", commentIdToDelete));
                }
                
                // Eliminar el comentario y todas sus respuestas
                await deleteCommentAndReplies(commentId);
                
                // Recargar los comentarios de la foto
                await loadFotoComments(fotoId);
            } catch (error) {
                console.error('Error al eliminar comentario:', error);
                throw error;
            }
        }

        // Cargar comentarios de una foto
        async function loadFotoComments(fotoId) {
            if (!fotoId) {
                console.warn('loadFotoComments: No hay fotoId');
                return;
            }
            
            try {
                console.log('loadFotoComments: Cargando comentarios para fotoId:', fotoId);
                const comentariosRef = collection(db, "fotoComentarios");
                const q = query(comentariosRef, where("fotoId", "==", fotoId));
                const snapshot = await getDocs(q);
                console.log('loadFotoComments: Encontrados', snapshot.size, 'comentarios para fotoId:', fotoId);
                
                const commentsList = document.getElementById('libraryImageCommentsList');
                if (!commentsList) return;
                
                commentsList.innerHTML = '';
                
                if (snapshot.empty) {
                    commentsList.innerHTML = '<div style="text-align: center; color: #718096; padding: 20px;">No hay comentarios aún. ¡Sé el primero en comentar!</div>';
                    return;
                }
                
                // Separar comentarios principales de respuestas
                const allComments = snapshot.docs.map(docSnapshot => ({
                    id: docSnapshot.id,
                    ...docSnapshot.data()
                }));
                
                const mainComments = allComments.filter(c => !c.parentCommentId).sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
                const replies = allComments.filter(c => c.parentCommentId);
                
                // Función recursiva para construir el árbol de comentarios y respuestas
                async function buildCommentTree(comment, allReplies, depth = 0, parentAuthor = null) {
                    const element = await createCommentElement(comment, depth > 0, parentAuthor);
                    
                    // Buscar respuestas directas a este comentario (puede ser comentario principal o respuesta)
                    const directReplies = allReplies
                        .filter(r => r.parentCommentId === comment.id)
                        .sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
                    
                    if (directReplies.length > 0) {
                        // Crear botón de flecha para mostrar/ocultar respuestas
                        const toggleButton = document.createElement('button');
                        toggleButton.className = 'comment-replies-toggle';
                        toggleButton.innerHTML = `
                            <span class="toggle-arrow">▶</span>
                            <span class="reply-count">${directReplies.length} ${directReplies.length === 1 ? 'respuesta' : 'respuestas'}</span>
                        `;
                        
                        const repliesContainer = document.createElement('div');
                        repliesContainer.className = 'comment-replies';
                        
                        // Construir recursivamente las respuestas (que pueden tener sus propias respuestas)
                        // Pasar el nombre del autor del comentario padre
                        const replyElements = await Promise.all(directReplies.map(reply => 
                            buildCommentTree(reply, allReplies, depth + 1, comment.nombreUsuario || 'Anónimo')
                        ));
                        
                        replyElements.forEach(replyEl => repliesContainer.appendChild(replyEl));
                        
                        // Funcionalidad para mostrar/ocultar respuestas
                        toggleButton.onclick = (e) => {
                            e.stopPropagation();
                            const isExpanded = repliesContainer.classList.contains('show');
                            if (isExpanded) {
                                repliesContainer.classList.remove('show');
                                toggleButton.classList.remove('expanded');
                            } else {
                                repliesContainer.classList.add('show');
                                toggleButton.classList.add('expanded');
                            }
                        };
                        
                        element.appendChild(toggleButton);
                        element.appendChild(repliesContainer);
                    }
                    
                    return element;
                }
                
                // Crear comentarios principales con sus respuestas (y respuestas a respuestas)
                const commentItems = await Promise.all(mainComments.map(mainComment => 
                    buildCommentTree(mainComment, replies, 0)
                ));
                
                // Agregar todos los comentarios al contenedor
                commentItems.forEach(item => commentsList.appendChild(item));
            } catch (error) {
                console.error('Error al cargar comentarios:', error);
                const commentsList = document.getElementById('libraryImageCommentsList');
                if (commentsList) {
                    commentsList.innerHTML = '<div style="text-align: center; color: #f56565; padding: 20px;">Error al cargar comentarios. Por favor, intenta de nuevo.</div>';
                }
            }
        }

        // Eliminar amigo
        window.removeFriend = async function(friendId) {
            if (!window.currentUser || !friendId) return false;
            
            try {
                const currentUserId = window.currentUser.uid;
                
                // Obtener datos de ambos usuarios
                const currentUserRef = doc(db, "usuarios", currentUserId);
                const friendUserRef = doc(db, "usuarios", friendId);
                
                const currentUserDoc = await getDoc(currentUserRef);
                const friendUserDoc = await getDoc(friendUserRef);
                
                if (!currentUserDoc.exists() || !friendUserDoc.exists()) {
                    alert('Error: Usuario no encontrado');
                    return false;
                }
                
                const currentUserAmigos = currentUserDoc.data().amigos || [];
                const friendUserAmigos = friendUserDoc.data().amigos || [];
                
                // Eliminar de ambas listas
                const updatedCurrentAmigos = currentUserAmigos.filter(id => id !== friendId);
                const updatedFriendAmigos = friendUserAmigos.filter(id => id !== currentUserId);
                
                // Actualizar ambas listas
                await updateDoc(currentUserRef, {
                    amigos: updatedCurrentAmigos
                });
                
                await updateDoc(friendUserRef, {
                    amigos: updatedFriendAmigos
                });
                
                return true;
            } catch (error) {
                console.error('Error al eliminar amigo:', error);
                alert('Error al eliminar el amigo');
                return false;
            }
        };

        // ----------- SISTEMA DE CHAT -------------
        let currentChatFriendId = null;
        let currentChatGroupId = null;
        let chatUnsubscribe = null;

        // Abrir chat con un amigo
        window.openChat = async function(friendId, friendData = null) {
            if (!window.currentUser || !friendId) return;
            
            try {
                // Cerrar chat anterior si existe
                if (chatUnsubscribe) {
                    chatUnsubscribe();
                    chatUnsubscribe = null;
                }
                
                currentChatFriendId = friendId;
                currentChatGroupId = null; // No es un grupo
                
                // Cargar datos del amigo si no se proporcionaron
                if (!friendData) {
                    const friendDoc = await getDoc(doc(db, "usuarios", friendId));
                    if (!friendDoc.exists()) {
                        alert('Usuario no encontrado');
                        return;
                    }
                    friendData = friendDoc.data();
                }
                
                const activeChat = document.getElementById('profileActiveChat');
                const headerName = document.getElementById('activeChatHeaderName');
                const headerPicture = document.getElementById('activeChatHeaderPicture');
                const messagesEl = document.getElementById('activeChatMessages');
                const chatInput = document.getElementById('activeChatInput');
                
                if (!activeChat || !headerName || !messagesEl) return;
                
                // Configurar header
                headerName.textContent = friendData.nombre || 'Amigo';
                
                if (friendData.fotoPerfil) {
                    headerPicture.innerHTML = `<img src="${friendData.fotoPerfil}" alt="Foto">`;
                } else {
                    headerPicture.innerHTML = '<div style="font-size: 1.2em;">👤</div>';
                }
                
                // Limpiar mensajes anteriores
                messagesEl.innerHTML = '';
                
                // Mostrar el chat activo en pantalla completa
                activeChat.style.display = 'flex';
                activeChat.classList.add('fullscreen');
                
                // Ocultar otros elementos del perfil
                const profileContent = document.querySelector('.profile-content');
                if (profileContent) {
                    profileContent.style.display = 'none';
                }
                
                // NO cargar la lista completa de chats - solo cargar esta conversación
                // Escuchar nuevos mensajes en tiempo real (esto también carga los mensajes iniciales)
                const messagesRef = collection(db, "mensajes");
                // Usar el chatId más pequeño alfabéticamente para mantener consistencia
                const chatId1 = `${window.currentUser.uid}_${friendId}`;
                const chatId2 = `${friendId}_${window.currentUser.uid}`;
                const finalChatId = chatId1 < chatId2 ? chatId1 : chatId2;
                
                // Usar query sin orderBy para evitar errores de índice
                const q = query(
                    messagesRef,
                    where("chatId", "==", finalChatId)
                );
                
                chatUnsubscribe = onSnapshot(q, async (snapshot) => {
                    const activeChat = document.getElementById('profileActiveChat');
                    const activeMessagesEl = document.getElementById('activeChatMessages');
                    
                    // Verificar que el chat activo esté visible y que este listener es para el chat actual
                    if (!activeChat || !activeMessagesEl || activeChat.style.display === 'none') {
                        return; // El chat no está visible, no mostrar mensajes
                    }
                    
                    if (currentChatFriendId !== friendId) {
                        return; // Este listener es para un chat diferente, ignorar
                    }
                    
                    // Limpiar mensajes anteriores
                    activeMessagesEl.innerHTML = '';
                    
                    // Obtener todos los mensajes y ordenarlos por timestamp
                    const messages = [];
                    const messageIds = new Set(); // Para evitar duplicados
                    
                    snapshot.forEach((doc) => {
                        const messageData = doc.data();
                        const messageId = doc.id;
                        
                        // Evitar duplicados
                        if (!messageIds.has(messageId)) {
                            messageIds.add(messageId);
                            messages.push({
                                ...messageData,
                                id: messageId
                            });
                        }
                    });
                    
                    // Ordenar por timestamp
                    messages.sort((a, b) => {
                        const timeA = a.timestamp || 0;
                        const timeB = b.timestamp || 0;
                        return timeA - timeB;
                    });
                    
                    // Marcar todos los mensajes no leídos como leídos (el receptor tiene el chat abierto)
                    const unreadMessages = messages.filter(msg => 
                        msg.toUserId === window.currentUser.uid && !msg.read
                    );
                    
                    if (unreadMessages.length > 0) {
                        const batch = writeBatch(db);
                        unreadMessages.forEach(msg => {
                            const msgRef = doc(db, "mensajes", msg.id);
                            batch.update(msgRef, { read: true });
                            // Actualizar inmediatamente en la UI local
                            msg.read = true;
                        });
                        try {
                            await batch.commit();
                            // Actualizar la lista de chats para quitar badges después de marcar como leídos
                            setTimeout(async () => {
                                if (window.loadChatsList) {
                                    await window.loadChatsList();
                                }
                            }, 500);
                        } catch (error) {
                            console.error('Error al marcar mensajes como leídos:', error);
                        }
                    }
                    
                    // Mostrar mensajes ordenados (cargar fotos de forma asíncrona)
                    for (const messageData of messages) {
                        await displayMessage(messageData);
                    }
                    
                    // Configurar listeners para actualizar indicadores de leído en tiempo real
                    if (window.setupReadStatusListeners) {
                        setupReadStatusListeners(messages);
                    }
                    
                    // Scroll al final
                    setTimeout(() => {
                        activeMessagesEl.scrollTop = activeMessagesEl.scrollHeight;
                    }, 100);
                }, (error) => {
                    console.error('Error en onSnapshot:', error);
                });
                
                // NO ocultar la sección de chats - debe permanecer visible siempre
                // La sección de chats permanece visible para acceso rápido
                
                // El chat ya está en pantalla completa
                
                // Hacer scroll hacia el chat activo
                setTimeout(() => {
                    activeChat.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
                
                // Focus en el input
                if (chatInput) {
                    setTimeout(() => chatInput.focus(), 200);
                    
                    // Detectar cuando el usuario está escribiendo
                    let typingTimeout;
                    const typingChatId1 = `${window.currentUser.uid}_${friendId}`;
                    const typingChatId2 = `${friendId}_${window.currentUser.uid}`;
                    const typingFinalChatId = typingChatId1 < typingChatId2 ? typingChatId1 : typingChatId2;
                    
                    chatInput.addEventListener('input', async () => {
                        // Actualizar estado de "escribiendo" en Firestore
                        const typingRef = doc(db, "typingStatus", `${typingFinalChatId}_${window.currentUser.uid}`);
                        await setDoc(typingRef, {
                            isTyping: true,
                            timestamp: Date.now()
                        }, { merge: true });
                        
                        // Limpiar timeout anterior
                        clearTimeout(typingTimeout);
                        
                        // Después de 3 segundos sin escribir, marcar como no escribiendo
                        typingTimeout = setTimeout(async () => {
                            await setDoc(typingRef, {
                                isTyping: false,
                                timestamp: Date.now()
                            }, { merge: true });
                        }, 3000);
                    });
                }
                
                // Escuchar cuando el amigo está escribiendo
                const typingChatId1 = `${window.currentUser.uid}_${friendId}`;
                const typingChatId2 = `${friendId}_${window.currentUser.uid}`;
                const typingFinalChatId = typingChatId1 < typingChatId2 ? typingChatId1 : typingChatId2;
                
                const typingStatusRef = doc(db, "typingStatus", `${typingFinalChatId}_${friendId}`);
                const typingUnsubscribe = onSnapshot(typingStatusRef, (docSnapshot) => {
                    const messagesEl = document.getElementById('activeChatMessages');
                    if (!messagesEl) return;
                    
                    // Remover indicador anterior si existe
                    const existingTyping = messagesEl.querySelector('.typing-indicator');
                    if (existingTyping) {
                        existingTyping.remove();
                    }
                    
                    if (docSnapshot.exists()) {
                        const data = docSnapshot.data();
                        // Verificar que el estado de "escribiendo" sea reciente (últimos 5 segundos)
                        const isRecent = data.timestamp && (Date.now() - data.timestamp) < 5000;
                        
                        if (data.isTyping && isRecent) {
                            // Mostrar indicador de escribiendo
                            const typingIndicator = document.createElement('div');
                            typingIndicator.className = 'typing-indicator';
                            typingIndicator.innerHTML = `
                                <span>${friendData.nombre || 'Amigo'} está escribiendo</span>
                                <div class="typing-dots">
                                    <div class="typing-dot"></div>
                                    <div class="typing-dot"></div>
                                    <div class="typing-dot"></div>
                                </div>
                            `;
                            messagesEl.appendChild(typingIndicator);
                            
                            // Scroll al final
                            setTimeout(() => {
                                messagesEl.scrollTop = messagesEl.scrollHeight;
                            }, 100);
                        }
                    }
                });
                
                // Guardar unsubscribe para limpiarlo después
                if (chatUnsubscribe) {
                    const oldUnsubscribe = chatUnsubscribe;
                    chatUnsubscribe = () => {
                        oldUnsubscribe();
                        typingUnsubscribe();
                    };
                } else {
                    chatUnsubscribe = typingUnsubscribe;
                }
                
                // Marcar mensajes como leídos
                await markMessagesAsRead(friendId);
                
                // NO recargar lista de chats para evitar mostrar la foto y mensaje del amigo abajo
            } catch (error) {
                console.error('Error al abrir chat:', error);
                alert('Error al abrir el chat');
            }
        };

        // Abrir chat de grupo
        window.openGroupChat = async function(grupoId, grupoData = null) {
            if (!window.currentUser || !grupoId) return;
            
            try {
                // Cerrar chat anterior si existe
                if (chatUnsubscribe) {
                    chatUnsubscribe();
                    chatUnsubscribe = null;
                }
                
                currentChatGroupId = grupoId;
                currentChatFriendId = null; // No es un chat individual
                
                // Cargar datos del grupo si no se proporcionaron
                if (!grupoData) {
                    const grupoDoc = await getDoc(doc(db, "gruposChat", grupoId));
                    if (!grupoDoc.exists()) {
                        alert('Grupo no encontrado');
                        return;
                    }
                    grupoData = grupoDoc.data();
                }
                
                const activeChat = document.getElementById('profileActiveChat');
                const headerName = document.getElementById('activeChatHeaderName');
                const headerPicture = document.getElementById('activeChatHeaderPicture');
                const messagesEl = document.getElementById('activeChatMessages');
                const chatInput = document.getElementById('activeChatInput');
                
                if (!activeChat || !headerName || !messagesEl) return;
                
                // Configurar header
                headerName.textContent = grupoData.nombre || 'Grupo';
                headerName.style.cursor = 'pointer';
                headerName.title = 'Click para ver información del grupo';
                
                // Remover listeners anteriores
                const newHeaderName = headerName.cloneNode(true);
                headerName.parentNode.replaceChild(newHeaderName, headerName);
                
                // Agregar listener para abrir información del grupo
                const updatedHeaderName = document.getElementById('activeChatHeaderName');
                if (updatedHeaderName) {
                    updatedHeaderName.onclick = () => {
                        if (window.showGroupInfo) {
                            window.showGroupInfo(grupoId, grupoData);
                        }
                    };
                }
                
                // Cargar foto del grupo si existe
                if (grupoData.fotoPerfil) {
                    headerPicture.innerHTML = `<img src="${grupoData.fotoPerfil}" alt="Foto del grupo" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                } else {
                    headerPicture.innerHTML = '<div style="font-size: 1.2em;">👥</div>';
                }
                
                // Limpiar mensajes anteriores
                messagesEl.innerHTML = '';
                
                // Mostrar el chat activo en pantalla completa
                activeChat.style.display = 'flex';
                activeChat.classList.add('fullscreen');
                
                // Ocultar otros elementos del perfil
                const profileContent = document.querySelector('.profile-content');
                if (profileContent) {
                    profileContent.style.display = 'none';
                }
                
                // Escuchar nuevos mensajes del grupo en tiempo real
                const messagesRef = collection(db, "mensajesGrupo");
                const q = query(
                    messagesRef,
                    where("grupoId", "==", grupoId)
                );
                
                // Flag para prevenir ejecuciones simultáneas
                if (!window.groupChatLoading) {
                    window.groupChatLoading = {};
                }
                
                chatUnsubscribe = onSnapshot(q, async (snapshot) => {
                    const activeChat = document.getElementById('profileActiveChat');
                    const activeMessagesEl = document.getElementById('activeChatMessages');
                    
                    if (!activeChat || !activeMessagesEl || activeChat.style.display === 'none') {
                        return;
                    }
                    
                    if (currentChatGroupId !== grupoId) {
                        return;
                    }
                    
                    // Prevenir ejecuciones simultáneas para este grupo
                    if (window.groupChatLoading[grupoId]) {
                        return;
                    }
                    window.groupChatLoading[grupoId] = true;
                    
                    try {
                        // Recopilar todos los mensajes del snapshot
                        const messages = [];
                        const messageIds = new Set();
                        
                        snapshot.forEach((doc) => {
                            const messageData = doc.data();
                            const messageId = doc.id;
                            
                            if (!messageIds.has(messageId)) {
                                messageIds.add(messageId);
                                messages.push({
                                    ...messageData,
                                    id: messageId
                                });
                            }
                        });
                        
                        // Ordenar mensajes por timestamp
                        messages.sort((a, b) => {
                            const timeA = a.timestamp || 0;
                            const timeB = b.timestamp || 0;
                            return timeA - timeB;
                        });
                        
                        // Limpiar y volver a renderizar todos los mensajes
                        activeMessagesEl.innerHTML = '';
                        
                        // Cargar nombres de usuarios para cada mensaje
                        for (const message of messages) {
                        const remitenteDoc = await getDoc(doc(db, "usuarios", message.remitenteId));
                        const remitenteNombre = remitenteDoc.exists() ? remitenteDoc.data().nombre : 'Usuario';
                        const isSent = message.remitenteId === window.currentUser.uid;
                        
                        const messageEl = document.createElement('div');
                        messageEl.className = `active-chat-message ${isSent ? 'sent' : 'received'}`;
                        
                        if (!isSent) {
                            const picture = document.createElement('div');
                            picture.className = 'active-chat-message-picture';
                            if (remitenteDoc.exists() && remitenteDoc.data().fotoPerfil) {
                                picture.innerHTML = `<img src="${remitenteDoc.data().fotoPerfil}" alt="${remitenteNombre}">`;
                            } else {
                                picture.innerHTML = '<div style="font-size: 1.2em;">👤</div>';
                            }
                            messageEl.appendChild(picture);
                        }
                        
                        const content = document.createElement('div');
                        content.className = 'active-chat-message-content';
                        
                        if (!isSent) {
                            const senderName = document.createElement('div');
                            senderName.style.fontSize = '0.8em';
                            senderName.style.color = '#666';
                            senderName.style.marginBottom = '4px';
                            senderName.textContent = remitenteNombre;
                            content.appendChild(senderName);
                        }
                        
                        const text = document.createElement('div');
                        text.textContent = message.texto || '';
                        content.appendChild(text);
                        
                        const time = document.createElement('div');
                        time.className = 'active-chat-message-time';
                        if (message.timestamp) {
                            const fecha = new Date(message.timestamp);
                            time.textContent = fecha.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                        }
                        
                        // Agregar indicador de leído para mensajes enviados
                        if (isSent) {
                            const leidoPor = message.leidoPor || [];
                            const readIndicator = document.createElement('span');
                            readIndicator.className = 'message-read-indicator';
                            readIndicator.setAttribute('data-message-id', message.id || '');
                            if (leidoPor.length > 1) {
                                readIndicator.textContent = '✓✓';
                                readIndicator.classList.add('read');
                                readIndicator.title = `Leído por ${leidoPor.length} personas`;
                            } else {
                                readIndicator.textContent = '✓';
                                readIndicator.title = 'Enviado';
                            }
                            time.appendChild(readIndicator);
                        }
                        
                        content.appendChild(time);
                        
                            // Agregar doble click para marcar como leído (solo para mensajes recibidos)
                            if (!isSent) {
                                messageEl.addEventListener('dblclick', async () => {
                                    const leidoPor = message.leidoPor || [];
                                    if (!leidoPor.includes(window.currentUser.uid)) {
                                        const messageRef = doc(db, "mensajesGrupo", message.id);
                                        leidoPor.push(window.currentUser.uid);
                                        await updateDoc(messageRef, { leidoPor: leidoPor });
                                    }
                                });
                                messageEl.style.cursor = 'pointer';
                                messageEl.title = 'Doble click para marcar como leído';
                            }
                            
                            messageEl.setAttribute('data-message-id', message.id || '');
                            messageEl.appendChild(content);
                            activeMessagesEl.appendChild(messageEl);
                        }
                        
                        // Scroll al final
                        activeMessagesEl.scrollTop = activeMessagesEl.scrollHeight;
                    } finally {
                        // Liberar el flag después de un pequeño delay para evitar ejecuciones muy rápidas
                        setTimeout(() => {
                            window.groupChatLoading[grupoId] = false;
                        }, 100);
                    }
                });
                
                // Marcar mensajes como leídos (solo los que no fueron enviados por el usuario actual)
                try {
                    const allMessages = await getDocs(query(
                        messagesRef,
                        where("grupoId", "==", grupoId)
                    ));
                    
                    const batch = writeBatch(db);
                    let hasUpdates = false;
                    
                    allMessages.forEach((docSnapshot) => {
                        const data = docSnapshot.data();
                        // Solo marcar como leído si no fue enviado por el usuario actual
                        if (data.remitenteId !== window.currentUser.uid) {
                            const leidoPor = data.leidoPor || [];
                            if (!leidoPor.includes(window.currentUser.uid)) {
                                leidoPor.push(window.currentUser.uid);
                                batch.update(docSnapshot.ref, { leidoPor: leidoPor });
                                hasUpdates = true;
                            }
                        }
                    });
                    
                    if (hasUpdates) {
                        await batch.commit();
                    }
                } catch (error) {
                    console.error('Error al marcar mensajes como leídos:', error);
                    // No bloquear la apertura del chat si falla esto
                }
                
                // Configurar indicador de "escribiendo" para grupos
                if (chatInput) {
                    let typingTimeout;
                    const typingRef = doc(db, "typingStatus", `group_${grupoId}_${window.currentUser.uid}`);
                    
                    chatInput.addEventListener('input', async () => {
                        // Actualizar estado de "escribiendo" en Firestore
                        await setDoc(typingRef, {
                            isTyping: true,
                            timestamp: Date.now(),
                            grupoId: grupoId,
                            userId: window.currentUser.uid
                        }, { merge: true });
                        
                        // Limpiar timeout anterior
                        clearTimeout(typingTimeout);
                        
                        // Después de 3 segundos sin escribir, marcar como no escribiendo
                        typingTimeout = setTimeout(async () => {
                            await setDoc(typingRef, {
                                isTyping: false,
                                timestamp: Date.now()
                            }, { merge: true });
                        }, 3000);
                    });
                    
                    // Escuchar cuando otros miembros están escribiendo
                    const typingStatusRef = collection(db, "typingStatus");
                    const typingQuery = query(
                        typingStatusRef,
                        where("grupoId", "==", grupoId),
                        where("isTyping", "==", true)
                    );
                    
                    const typingUnsubscribe = onSnapshot(typingQuery, async (typingSnapshot) => {
                        const typingUsers = [];
                        typingSnapshot.forEach((doc) => {
                            const data = doc.data();
                            if (data.userId !== window.currentUser.uid && data.isTyping) {
                                // Verificar que sea reciente (últimos 5 segundos)
                                const isRecent = data.timestamp && (Date.now() - data.timestamp) < 5000;
                                if (isRecent) {
                                    typingUsers.push(data.userId);
                                }
                            }
                        });
                        
                        // Mostrar indicador de "escribiendo"
                        const typingIndicator = document.getElementById('typingIndicator');
                        if (typingUsers.length > 0) {
                            // Cargar nombres de usuarios
                            const nombres = await Promise.all(typingUsers.map(async (userId) => {
                                const userDoc = await getDoc(doc(db, "usuarios", userId));
                                return userDoc.exists() ? userDoc.data().nombre : 'Alguien';
                            }));
                            
                            if (typingIndicator) {
                                typingIndicator.textContent = nombres.length === 1 
                                    ? `${nombres[0]} está escribiendo...`
                                    : `${nombres.length} personas están escribiendo...`;
                                typingIndicator.style.display = 'block';
                            }
                        } else {
                            if (typingIndicator) {
                                typingIndicator.style.display = 'none';
                            }
                        }
                    });
                    
                    // Agregar al unsubscribe
                    if (chatUnsubscribe) {
                        const oldUnsubscribe = chatUnsubscribe;
                        chatUnsubscribe = () => {
                            oldUnsubscribe();
                            typingUnsubscribe();
                        };
                    } else {
                        chatUnsubscribe = typingUnsubscribe;
                    }
                }
                
            } catch (error) {
                console.error('Error al abrir chat de grupo:', error);
                alert('Error al abrir el chat del grupo');
            }
        };

        // Cargar mensajes del chat
        async function loadChatMessages(friendId) {
            if (!window.currentUser) return;
            
            try {
                const messagesRef = collection(db, "mensajes");
                // Usar el chatId más pequeño alfabéticamente para mantener consistencia
                const chatId1 = `${window.currentUser.uid}_${friendId}`;
                const chatId2 = `${friendId}_${window.currentUser.uid}`;
                const finalChatId = chatId1 < chatId2 ? chatId1 : chatId2;
                
                const q = query(
                    messagesRef,
                    where("chatId", "==", finalChatId),
                    limit(50)
                );
                
                const snapshot = await getDocs(q);
                const messagesEl = document.getElementById('activeChatMessages');
                if (!messagesEl) {
                    console.error('No se encontró el elemento activeChatMessages');
                    return;
                }
                
                messagesEl.innerHTML = '';
                
                if (!snapshot.empty) {
                    // Obtener todos los mensajes y ordenarlos por timestamp
                    const messages = [];
                    snapshot.forEach((docSnapshot) => {
                        const messageData = docSnapshot.data();
                        messages.push({
                            ...messageData,
                            id: docSnapshot.id
                        });
                    });
                    
                    // Ordenar por timestamp
                    messages.sort((a, b) => {
                        const timeA = a.timestamp || 0;
                        const timeB = b.timestamp || 0;
                        return timeA - timeB;
                    });
                    
                    // Marcar todos los mensajes no leídos como leídos antes de mostrarlos
                    const unreadMessages = messages.filter(msg => 
                        msg.toUserId === window.currentUser.uid && !msg.read
                    );
                    
                    if (unreadMessages.length > 0) {
                        const batch = writeBatch(db);
                        unreadMessages.forEach(msg => {
                            const msgRef = doc(db, "mensajes", msg.id);
                            batch.update(msgRef, { read: true });
                            // Actualizar inmediatamente en la UI
                            msg.read = true;
                        });
                        try {
                            await batch.commit();
                        } catch (error) {
                            console.error('Error al marcar mensajes como leídos:', error);
                        }
                    }
                    
                    // Mostrar mensajes ordenados
                    for (const messageData of messages) {
                        await displayMessage(messageData);
                    }
                    
                    // Configurar listeners para actualizar indicadores de leído en tiempo real
                    setupReadStatusListeners(messages);
                }
                
                // Scroll al final
                setTimeout(() => {
                    messagesEl.scrollTop = messagesEl.scrollHeight;
                }, 100);

                // Actualizar notificaciones después de cargar mensajes
                if (window.loadProfileNotifications) {
                    await window.loadProfileNotifications();
                }
            } catch (error) {
                console.error('Error al cargar mensajes:', error);
                // Si hay error de índice, intentar sin orderBy
                try {
                    const messagesRef = collection(db, "mensajes");
                    const chatId1 = `${window.currentUser.uid}_${friendId}`;
                    const chatId2 = `${friendId}_${window.currentUser.uid}`;
                    const finalChatId = chatId1 < chatId2 ? chatId1 : chatId2;
                    
                    const q = query(
                        messagesRef,
                        where("chatId", "==", finalChatId),
                        limit(50)
                    );
                    
                    const snapshot = await getDocs(q);
                    const messagesEl = document.getElementById('activeChatMessages');
                    if (messagesEl) {
                        messagesEl.innerHTML = '';
                        const messagesToDisplay = [];
                        snapshot.forEach((doc) => {
                            messagesToDisplay.push(doc.data());
                        });
                        for (const messageData of messagesToDisplay) {
                            await displayMessage(messageData);
                        }
                        setTimeout(() => {
                            messagesEl.scrollTop = messagesEl.scrollHeight;
                        }, 100);
                    }
                } catch (retryError) {
                    console.error('Error al cargar mensajes (reintento):', retryError);
                }
            }
        }

        // Cache de fotos de perfil para evitar cargar múltiples veces
        const profilePicturesCache = {};
        
        // Cargar foto de perfil de un usuario
        async function loadUserProfilePicture(userId) {
            if (profilePicturesCache[userId]) {
                return profilePicturesCache[userId];
            }
            
            try {
                const userDoc = await getDoc(doc(db, "usuarios", userId));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    const fotoPerfil = userData.fotoPerfil || null;
                    profilePicturesCache[userId] = fotoPerfil;
                    return fotoPerfil;
                }
            } catch (error) {
                console.error('Error al cargar foto de perfil:', error);
            }
            
            return null;
        }
        
        // Set para rastrear mensajes que ya tienen listeners configurados
        if (!window.messageListenersSet) {
            window.messageListenersSet = new Set();
        }
        
        // Configurar listeners para indicadores de leído
        function setupReadStatusListeners(messages) {
            if (!messages || !Array.isArray(messages)) return;
            
            messages.forEach(msg => {
                if (msg.id && msg.fromUserId === window.currentUser.uid) {
                    // Si ya tiene un listener, no crear otro
                    if (window.messageListenersSet && window.messageListenersSet.has(msg.id)) {
                        return;
                    }
                    
                    // Agregar al set de listeners
                    if (!window.messageListenersSet) {
                        window.messageListenersSet = new Set();
                    }
                    window.messageListenersSet.add(msg.id);
                    
                    const msgRef = doc(db, "mensajes", msg.id);
                    // Usar onSnapshot para escuchar cambios en tiempo real
                    onSnapshot(msgRef, (docSnapshot) => {
                        if (docSnapshot.exists()) {
                            const updatedData = docSnapshot.data();
                            // Buscar el indicador de leído específico de este mensaje
                            const readIndicator = document.querySelector(`.message-read-indicator[data-message-id="${msg.id}"]`);
                            if (readIndicator) {
                                if (updatedData.read) {
                                    readIndicator.textContent = '✓✓';
                                    readIndicator.classList.add('read');
                                    readIndicator.title = 'Leído';
                                } else {
                                    readIndicator.textContent = '✓';
                                    readIndicator.classList.remove('read');
                                    readIndicator.title = 'Enviado';
                                }
                            }
                        }
                    });
                }
            });
        }

        // Mostrar un mensaje en el chat
        async function displayMessage(messageData) {
            const activeChat = document.getElementById('profileActiveChat');
            const messagesEl = document.getElementById('activeChatMessages');
            
            // Verificar que el chat activo esté visible antes de mostrar mensajes
            if (!activeChat || !messagesEl || activeChat.style.display === 'none') {
                return; // El chat no está visible, no mostrar mensajes fuera del chat
            }
            
            // Verificar que hay un chat activo
            if (!currentChatFriendId) {
                return; // No hay chat activo, no mostrar mensajes
            }
            
            // Verificar si el mensaje ya existe para evitar duplicados
            const messageId = messageData.id;
            if (messageId) {
                const existingMessage = messagesEl.querySelector(`[data-message-id="${messageId}"]`);
                if (existingMessage) {
                    return; // El mensaje ya está mostrado, no duplicar
                }
            }
            
            const isSent = messageData.fromUserId === window.currentUser.uid;
            const messageDiv = document.createElement('div');
            messageDiv.className = `active-chat-message ${isSent ? 'sent' : 'received'}`;
            
            const picture = document.createElement('div');
            picture.className = 'active-chat-message-picture';
            
            // Cargar foto de perfil del usuario que envió el mensaje
            const userId = messageData.fromUserId;
            const fotoPerfil = await loadUserProfilePicture(userId);
            
            if (fotoPerfil) {
                const img = document.createElement('img');
                img.src = fotoPerfil;
                img.alt = 'Foto de perfil';
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'cover';
                img.style.borderRadius = '50%';
                picture.appendChild(img);
            } else {
                picture.textContent = '👤';
            }
            
            const content = document.createElement('div');
            content.className = 'active-chat-message-content';
            
            // Mostrar texto
            if (messageData.text) {
                const text = document.createElement('div');
                text.textContent = messageData.text;
                content.appendChild(text);
            }
            
            const time = document.createElement('div');
            time.className = 'active-chat-message-time';
            const date = messageData.timestamp ? new Date(messageData.timestamp) : new Date();
            time.textContent = date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            
            // Agregar indicador de leído solo para mensajes enviados
            if (isSent) {
                const readIndicator = document.createElement('span');
                readIndicator.className = 'message-read-indicator';
                readIndicator.setAttribute('data-message-id', messageData.id || '');
                if (messageData.read) {
                    readIndicator.textContent = '✓✓';
                    readIndicator.classList.add('read');
                    readIndicator.title = 'Leído';
                } else {
                    readIndicator.textContent = '✓';
                    readIndicator.title = 'Enviado';
                }
                time.appendChild(readIndicator);
            }
            
            content.appendChild(time);
            messageDiv.setAttribute('data-message-id', messageData.id || '');
            messageDiv.appendChild(picture);
            messageDiv.appendChild(content);
            messagesEl.appendChild(messageDiv);
        }

        // Enviar mensaje
        window.sendChatMessage = async function() {
            if (!window.currentUser) return;
            if (!currentChatFriendId && !currentChatGroupId) return;
            
            const chatInput = document.getElementById('activeChatInput');
            if (!chatInput) return;
            
            const text = chatInput.value.trim();
            
            // Si no hay texto, no enviar
            if (!text) return;
            
            // Deshabilitar botón de enviar mientras se procesa
            const sendBtn = document.getElementById('activeChatSendBtn');
            if (sendBtn) {
                sendBtn.disabled = true;
                sendBtn.textContent = 'Enviando...';
            }
            
            try {
                if (currentChatGroupId) {
                    // Enviar mensaje a grupo
                    await addDoc(collection(db, "mensajesGrupo"), {
                        grupoId: currentChatGroupId,
                        remitenteId: window.currentUser.uid,
                        texto: text,
                        timestamp: Date.now(),
                        leidoPor: [window.currentUser.uid]
                    });
                    
                    // Enviar notificaciones push a todos los miembros excepto al remitente
                    try {
                        const grupoDoc = await getDoc(doc(db, "gruposChat", currentChatGroupId));
                        if (grupoDoc.exists()) {
                            const miembros = grupoDoc.data().miembros || [];
                            const senderName = window.currentUserName || 'Alguien';
                            const grupoNombre = grupoDoc.data().nombre || 'Grupo';
                            let messagePreview = text;
                            if (messagePreview.length > 50) {
                                messagePreview = messagePreview.substring(0, 50) + '...';
                            }
                            
                            for (const miembroId of miembros) {
                                if (miembroId !== window.currentUser.uid && window.sendPushNotification) {
                                    await window.sendPushNotification(
                                        miembroId,
                                        `👥 ${grupoNombre}: ${senderName}`,
                                        messagePreview,
                                        {
                                            type: 'group',
                                            grupoId: currentChatGroupId,
                                            remitenteId: window.currentUser.uid,
                                            tag: `group-${currentChatGroupId}`
                                        }
                                    );
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Error al enviar notificación push:', error);
                    }
                } else if (currentChatFriendId) {
                    // Enviar mensaje individual
                    const chatId1 = `${window.currentUser.uid}_${currentChatFriendId}`;
                    const chatId2 = `${currentChatFriendId}_${window.currentUser.uid}`;
                    const finalChatId = chatId1 < chatId2 ? chatId1 : chatId2;
                    
                    await addDoc(collection(db, "mensajes"), {
                        chatId: finalChatId,
                        fromUserId: window.currentUser.uid,
                        toUserId: currentChatFriendId,
                        text: text,
                        timestamp: Date.now(),
                        read: false
                    });
                    
                    // Enviar notificación push al destinatario (si tiene token FCM)
                    try {
                        const senderName = window.currentUserName || 'Alguien';
                        let messagePreview = text;
                        if (messagePreview.length > 50) {
                            messagePreview = messagePreview.substring(0, 50) + '...';
                        }
                        
                        if (window.sendPushNotification) {
                            await window.sendPushNotification(
                                currentChatFriendId,
                                `💬 Nuevo mensaje de ${senderName}`,
                                messagePreview,
                                {
                                    type: 'chat',
                                    chatId: finalChatId,
                                    fromUserId: window.currentUser.uid,
                                    tag: `chat-${currentChatFriendId}`
                                }
                            );
                        }
                    } catch (error) {
                        console.error('Error al enviar notificación push:', error);
                        // No bloquear el envío del mensaje si falla la notificación
                    }
                }
                
                // Marcar como no escribiendo (solo para chats individuales)
                if (currentChatFriendId) {
                    const chatId1 = `${window.currentUser.uid}_${currentChatFriendId}`;
                    const chatId2 = `${currentChatFriendId}_${window.currentUser.uid}`;
                    const finalChatId = chatId1 < chatId2 ? chatId1 : chatId2;
                    const typingRef = doc(db, "typingStatus", `${finalChatId}_${window.currentUser.uid}`);
                    await setDoc(typingRef, {
                        isTyping: false,
                        timestamp: Date.now()
                    }, { merge: true });
                }
                
                // Limpiar input y resetear altura
                chatInput.value = '';
                chatInput.style.height = 'auto';
                
                // Restaurar botón de enviar
                if (sendBtn) {
                    sendBtn.disabled = false;
                    sendBtn.textContent = 'Enviar';
                }
                
                // El onSnapshot se encargará de actualizar automáticamente en tiempo real
                // Scroll al final después de enviar (el onSnapshot también lo hará)
                setTimeout(() => {
                    const messagesEl = document.getElementById('activeChatMessages');
                    if (messagesEl) {
                        messagesEl.scrollTop = messagesEl.scrollHeight;
                    }
                }, 200);
            } catch (error) {
                console.error('Error al enviar mensaje:', error);
                // Restaurar botón en caso de error
                if (sendBtn) {
                    sendBtn.disabled = false;
                    sendBtn.textContent = 'Enviar';
                }
                alert('Error al enviar el mensaje');
            }
        };

        // Minimizar/maximizar chat
        window.toggleChatMinimize = function() {
            const activeChat = document.getElementById('profileActiveChat');
            // Botón de cerrar ya no existe, usar activeChatClose
            if (!activeChat) {
                console.error('No se encontró profileActiveChat');
                return;
            }
            
            const isMinimized = activeChat.classList.contains('minimized');
            if (isMinimized) {
                // Maximizar
                activeChat.classList.remove('minimized');
                if (minimizeBtn) {
                    minimizeBtn.textContent = '➖';
                }
                // Scroll al final cuando se maximiza
                setTimeout(() => {
                    const messagesEl = document.getElementById('activeChatMessages');
                    if (messagesEl) {
                        messagesEl.scrollTop = messagesEl.scrollHeight;
                    }
                }, 100);
            } else {
                // Minimizar - solo queda visible el header con la info del amigo
                activeChat.classList.add('minimized');
                if (minimizeBtn) {
                    minimizeBtn.textContent = '➕';
                }
            }
        };

        // Marcar mensajes como leídos
        async function markMessagesAsRead(friendId) {
            if (!window.currentUser) return;
            
            try {
                const messagesRef = collection(db, "mensajes");
                const chatId1 = `${window.currentUser.uid}_${friendId}`;
                const chatId2 = `${friendId}_${window.currentUser.uid}`;
                const finalChatId = chatId1 < chatId2 ? chatId1 : chatId2;
                
                const q = query(
                    messagesRef,
                    where("chatId", "==", finalChatId),
                    where("toUserId", "==", window.currentUser.uid),
                    where("read", "==", false)
                );
                
                const snapshot = await getDocs(q);
                if (snapshot.empty) return; // No hay mensajes no leídos
                
                const batch = writeBatch(db);
                
                snapshot.forEach((doc) => {
                    batch.update(doc.ref, { read: true });
                });
                
                await batch.commit();
                
                // Actualizar la lista de chats para quitar badges
                setTimeout(async () => {
                    if (window.loadChatsList) {
                        await window.loadChatsList();
                    }
                }, 300);
            } catch (error) {
                console.error('Error al marcar mensajes como leídos:', error);
            }
        }

        // Cerrar chat
        window.closeChat = async function() {
            // Cerrar listener de chat si existe
            if (chatUnsubscribe) {
                chatUnsubscribe();
                chatUnsubscribe = null;
            }
            
            // Limpiar flags de carga de chat de grupo
            if (window.groupChatLoading && currentChatGroupId) {
                delete window.groupChatLoading[currentChatGroupId];
            }
            
            // Limpiar variables de chat
            currentChatFriendId = null;
            currentChatGroupId = null;
            
            const activeChat = document.getElementById('profileActiveChat');
            if (activeChat) {
                activeChat.style.display = 'none';
                activeChat.classList.remove('fullscreen');
            }
            
            // Mostrar contenido del perfil nuevamente
            const profileContent = document.querySelector('.profile-content');
            if (profileContent) {
                profileContent.style.display = 'block';
            }
            
            // Limpiar mensajes al cerrar para evitar que aparezcan fuera del chat
            const messagesEl = document.getElementById('activeChatMessages');
            if (messagesEl) {
                messagesEl.innerHTML = '';
            }
            
            
            // Ocultar emoji picker
            const emojiPicker = document.getElementById('emojiPicker');
            if (emojiPicker) {
                emojiPicker.classList.remove('show');
            }
            
            // Desactivar listener de mensajes en tiempo real
            if (chatUnsubscribe) {
                chatUnsubscribe();
                chatUnsubscribe = null;
            }
            
            // Limpiar el set de listeners al cerrar el chat
            if (window.messageListenersSet) {
                window.messageListenersSet.clear();
            }
            
            // Remover estado "calling" del botón de llamada
            const activeChatCall = document.getElementById('activeChatCall');
            if (activeChatCall) {
                activeChatCall.classList.remove('calling');
                activeChatCall.title = 'Llamar';
            }
            
            // Ocultar modal de llamada saliente si está abierto
            if (window.hideOutgoingCallModal) {
                window.hideOutgoingCallModal();
            }
            
            // Limpiar el chat activo actual
            currentChatFriendId = null;
        };

        // Función para iniciar llamada
        window.startCall = async function() {
            if (!window.currentUser) {
                alert('Debes iniciar sesión para hacer llamadas');
                return;
            }
            
            if (!currentChatFriendId) {
                alert('No hay un chat activo');
                return;
            }
            
            try {
                // Obtener información del amigo
                const friendDoc = await getDoc(doc(db, "usuarios", currentChatFriendId));
                if (!friendDoc.exists()) {
                    alert('Usuario no encontrado');
                    return;
                }
                
                const friendData = friendDoc.data();
                const friendName = friendData.nombre || 'Amigo';
                
                // Mostrar mensaje de confirmación
                if (confirm(`¿Llamar a ${friendName}?`)) {
                    // Crear documento de llamada en Firestore para señalización
                    const callsRef = collection(db, "llamadas");
                    const callId = `${window.currentUser.uid}_${currentChatFriendId}_${Date.now()}`;
                    
                    const callDocRef = await addDoc(callsRef, {
                        callId: callId,
                        fromUserId: window.currentUser.uid,
                        toUserId: currentChatFriendId,
                        fromUserName: window.currentUserName || window.currentUser.email,
                        status: 'calling',
                        timestamp: Date.now()
                    });
                    
                    const callDocId = callDocRef.id;
                    
                    // Agregar clase "calling" al botón
                    const activeChatCall = document.getElementById('activeChatCall');
                    if (activeChatCall) {
                        activeChatCall.classList.add('calling');
                        activeChatCall.title = `Llamando a ${friendName}...`;
                    }
                    
                    // Mostrar modal de llamada saliente
                    window.showOutgoingCallModal(friendName, callDocId);
                    
                    // Listener para detectar cuando la llamada cambia de estado
                    const outgoingCallQuery = query(
                        collection(db, "llamadas"),
                        where("fromUserId", "==", window.currentUser.uid),
                        where("toUserId", "==", currentChatFriendId)
                    );
                    
                    let unsubscribeOutgoingCall = null;
                    unsubscribeOutgoingCall = onSnapshot(outgoingCallQuery, (snapshot) => {
                        snapshot.forEach((docSnapshot) => {
                            const callData = docSnapshot.data();
                            // Si la llamada fue aceptada, rechazada, terminada o cancelada, ocultar modal y remover estado "calling"
                            if (callData.status === 'accepted' || callData.status === 'rejected' || callData.status === 'ended' || callData.status === 'cancelled') {
                                const activeChatCallBtn = document.getElementById('activeChatCall');
                                if (activeChatCallBtn) {
                                    activeChatCallBtn.classList.remove('calling');
                                    activeChatCallBtn.title = 'Llamar';
                                }
                                // Ocultar modal de llamada saliente
                                window.hideOutgoingCallModal();
                                // Desuscribirse después de procesar
                                if (unsubscribeOutgoingCall) {
                                    unsubscribeOutgoingCall();
                                    unsubscribeOutgoingCall = null;
                                }
                            }
                        });
                    });
                }
            } catch (error) {
                console.error('Error al iniciar llamada:', error);
                alert('Error al iniciar la llamada');
                // Remover clase "calling" y ocultar modal en caso de error
                const activeChatCall = document.getElementById('activeChatCall');
                if (activeChatCall) {
                    activeChatCall.classList.remove('calling');
                    activeChatCall.title = 'Llamar';
                }
                if (window.hideOutgoingCallModal) {
                    window.hideOutgoingCallModal();
                }
            }
            
            // NO actualizar automáticamente la lista de chats al cerrar
            // Solo se actualiza cuando el usuario abre el desplegable manualmente
            if (window.loadFriendsList) {
                await window.loadFriendsList();
            }
        };

        // Variables globales para el modal de llamada
        let currentCallDocId = null;
        let currentCallFromUserId = null;
        let currentOutgoingCallDocId = null;

        // Mostrar modal de llamada saliente
        window.showOutgoingCallModal = function(recipientName, callDocId) {
            const outgoingCallModal = document.getElementById('outgoingCallModal');
            const outgoingCallRecipient = document.getElementById('outgoingCallRecipient');
            
            if (outgoingCallModal && outgoingCallRecipient) {
                currentOutgoingCallDocId = callDocId;
                outgoingCallRecipient.textContent = recipientName;
                outgoingCallModal.classList.add('active');
            }
        };

        // Ocultar modal de llamada saliente
        window.hideOutgoingCallModal = function() {
            const outgoingCallModal = document.getElementById('outgoingCallModal');
            if (outgoingCallModal) {
                outgoingCallModal.classList.remove('active');
                currentOutgoingCallDocId = null;
            }
        };

        // Cancelar llamada saliente
        window.cancelOutgoingCall = async function() {
            if (!currentOutgoingCallDocId || !window.currentUser) {
                window.hideOutgoingCallModal();
                return;
            }

            try {
                // Actualizar estado de la llamada a "cancelled"
                const callDocRef = doc(db, "llamadas", currentOutgoingCallDocId);
                await updateDoc(callDocRef, {
                    status: 'cancelled',
                    cancelledAt: Date.now()
                });

                // Remover estado "calling" del botón
                const activeChatCall = document.getElementById('activeChatCall');
                if (activeChatCall) {
                    activeChatCall.classList.remove('calling');
                    activeChatCall.title = 'Llamar';
                }

                window.hideOutgoingCallModal();
            } catch (error) {
                console.error('Error al cancelar llamada:', error);
                window.hideOutgoingCallModal();
                // Remover estado "calling" del botón incluso si hay error
                const activeChatCall = document.getElementById('activeChatCall');
                if (activeChatCall) {
                    activeChatCall.classList.remove('calling');
                    activeChatCall.title = 'Llamar';
                }
            }
        };

        // Mostrar modal de llamada entrante
        window.showCallModal = function(callerName, callDocId, fromUserId) {
            const callModal = document.getElementById('callModal');
            const callModalCaller = document.getElementById('callModalCaller');
            
            if (callModal && callModalCaller) {
                currentCallDocId = callDocId;
                currentCallFromUserId = fromUserId;
                callModalCaller.textContent = callerName;
                callModal.classList.add('active');
            }
        };

        // Ocultar modal de llamada
        window.hideCallModal = function() {
            const callModal = document.getElementById('callModal');
            if (callModal) {
                callModal.classList.remove('active');
                currentCallDocId = null;
                currentCallFromUserId = null;
            }
        };

        // Aceptar llamada
        window.acceptCall = async function() {
            if (!currentCallDocId || !window.currentUser) {
                window.hideCallModal();
                return;
            }

            try {
                // Actualizar estado de la llamada a "accepted"
                const callDocRef = doc(db, "llamadas", currentCallDocId);
                await updateDoc(callDocRef, {
                    status: 'accepted',
                    acceptedAt: Date.now()
                });

                window.hideCallModal();
                alert('Llamada aceptada. La llamada comenzará pronto.');
            } catch (error) {
                console.error('Error al aceptar llamada:', error);
                alert('Error al aceptar la llamada');
                window.hideCallModal();
            }
        };

        // Rechazar llamada
        window.rejectCall = async function() {
            if (!currentCallDocId || !window.currentUser) {
                window.hideCallModal();
                return;
            }

            try {
                // Actualizar estado de la llamada a "rejected"
                const callDocRef = doc(db, "llamadas", currentCallDocId);
                await updateDoc(callDocRef, {
                    status: 'rejected',
                    rejectedAt: Date.now()
                });

                window.hideCallModal();
            } catch (error) {
                console.error('Error al rechazar llamada:', error);
                // Ocultar modal incluso si hay error
                window.hideCallModal();
            }
        };

        // Cargar lista de chats
        // Variables globales para grupos
        window.selectedGroupUsers = [];

        // Funciones auxiliares para crear grupo
        window.updateGroupSelectedUsers = function() {
            const selectedContainer = document.getElementById('groupSelectedUsers');
            const nextBtn = document.getElementById('groupNextBtn');
            if (!selectedContainer) return;
            
            selectedContainer.innerHTML = '';
            
            if (window.selectedGroupUsers.length === 0) {
                selectedContainer.innerHTML = '<div style="color: #999; font-style: italic;">Ningún usuario seleccionado</div>';
                if (nextBtn) nextBtn.disabled = true;
                return;
            }
            
            if (nextBtn) nextBtn.disabled = false;
            
            window.selectedGroupUsers.forEach((user) => {
                const userEl = document.createElement('div');
                userEl.className = 'group-selected-user';
                userEl.innerHTML = `
                    <span>${user.nombre}</span>
                    <button class="group-selected-user-remove" data-user-id="${user.id}">×</button>
                `;
                const removeBtn = userEl.querySelector('.group-selected-user-remove');
                removeBtn.addEventListener('click', () => {
                    window.selectedGroupUsers = window.selectedGroupUsers.filter(u => u.id !== user.id);
                    if (window.updateGroupSelectedUsers) window.updateGroupSelectedUsers();
                    if (window.updateGroupSearchResults) window.updateGroupSearchResults();
                });
                selectedContainer.appendChild(userEl);
            });
        }

        window.updateGroupSearchResults = function(users = null) {
            const resultsContainer = document.getElementById('groupSearchResults');
            if (!resultsContainer) return;
            
            if (users === null) {
                // Recargar resultados actuales
                const searchInput = document.getElementById('groupUserSearch');
                if (searchInput && searchInput.value.trim().length >= 2) {
                    // Se recargará con el evento de input
                    return;
                }
                resultsContainer.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">Busca usuarios para agregar al grupo</div>';
                return;
            }
            
            // Filtrar usuarios que ya están en el grupo (si estamos añadiendo miembros)
            let usuariosFiltrados = users;
            if (window.currentAddMembersExistingMembers) {
                usuariosFiltrados = users.filter(user => 
                    !window.currentAddMembersExistingMembers.includes(user.id) &&
                    user.id !== window.currentUser.uid
                );
            } else {
                // Filtrar el usuario actual cuando se crea un grupo
                usuariosFiltrados = users.filter(user => user.id !== window.currentUser.uid);
            }
            
            if (usuariosFiltrados.length === 0) {
                if (window.currentAddMembersExistingMembers) {
                    resultsContainer.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">No se encontraron usuarios nuevos para agregar</div>';
                } else {
                    resultsContainer.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">No se encontraron usuarios</div>';
                }
                return;
            }
            
            resultsContainer.innerHTML = '';
            usuariosFiltrados.forEach((user) => {
                const isSelected = window.selectedGroupUsers.some(u => u.id === user.id);
                const item = document.createElement('div');
                item.className = `group-search-result-item ${isSelected ? 'selected' : ''}`;
                item.innerHTML = `
                    <div class="group-search-result-picture">
                        ${user.fotoPerfil ? `<img src="${user.fotoPerfil}" alt="${user.nombre}">` : '👤'}
                    </div>
                    <div class="group-search-result-info">
                        <div class="group-search-result-name">${user.nombre}</div>
                        <div class="group-search-result-email">${user.email || ''}</div>
                    </div>
                `;
                item.addEventListener('click', () => {
                    if (isSelected) {
                        window.selectedGroupUsers = window.selectedGroupUsers.filter(u => u.id !== user.id);
                    } else {
                        window.selectedGroupUsers.push(user);
                    }
                    if (window.updateGroupSelectedUsers) window.updateGroupSelectedUsers();
                    if (window.updateGroupSearchResults) window.updateGroupSearchResults(users);
                });
                resultsContainer.appendChild(item);
            });
        }

        window.updateGroupNamePreview = function() {
            const previewContainer = document.getElementById('groupNamePreviewMembers');
            if (!previewContainer) return;
            
            previewContainer.innerHTML = '';
            window.selectedGroupUsers.forEach((user) => {
                const memberEl = document.createElement('div');
                memberEl.className = 'group-name-preview-member';
                memberEl.textContent = user.nombre;
                previewContainer.appendChild(memberEl);
            });
        }

        // Función para crear grupo
        window.createGroup = async function() {
            if (!window.currentUser) return;
            
            const nameInput = document.getElementById('groupNameInput');
            const groupName = nameInput ? nameInput.value.trim() : '';
            
            if (!groupName) {
                alert('Por favor, ingresa un nombre para el grupo');
                return;
            }
            
            if (!window.selectedGroupUsers || window.selectedGroupUsers.length === 0) {
                alert('Por favor, selecciona al menos un usuario para el grupo');
                return;
            }
            
            try {
                // Crear el grupo en Firestore
                const gruposRef = collection(db, "gruposChat");
                const miembros = [window.currentUser.uid, ...window.selectedGroupUsers.map(u => u.id)];
                
                const grupoData = {
                    nombre: groupName,
                    creadorId: window.currentUser.uid,
                    miembros: miembros,
                    administradores: [], // Array vacío inicialmente
                    timestamp: Date.now()
                };
                
                const grupoDocRef = await addDoc(gruposRef, grupoData);
                
                // Agregar el grupo a la lista de grupos de cada miembro
                for (const miembroId of miembros) {
                    const miembroRef = doc(db, "usuarios", miembroId);
                    const miembroDoc = await getDoc(miembroRef);
                    
                    if (miembroDoc.exists()) {
                        const grupos = miembroDoc.data().grupos || [];
                        if (!grupos.includes(grupoDocRef.id)) {
                            grupos.push(grupoDocRef.id);
                            await updateDoc(miembroRef, { grupos: grupos });
                        }
                    }
                }
                
                // Cerrar modales
                const createGroupModal = document.getElementById('createGroupModal');
                const createGroupNameModal = document.getElementById('createGroupNameModal');
                if (createGroupModal) createGroupModal.style.display = 'none';
                if (createGroupNameModal) createGroupNameModal.style.display = 'none';
                
                // Limpiar selección
                window.selectedGroupUsers = [];
                if (nameInput) nameInput.value = '';
                
                // Recargar lista de chats
                if (window.loadChatsList) {
                    await window.loadChatsList();
                }
                
                alert('Grupo creado exitosamente');
            } catch (error) {
                console.error('Error al crear grupo:', error);
                alert('Error al crear el grupo. Por favor, intenta de nuevo.');
            }
        };

        // Función para mostrar información del grupo
        window.showGroupInfo = async function(grupoId, grupoData = null) {
            if (!window.currentUser || !grupoId) return;
            
            try {
                // Cargar datos del grupo si no se proporcionaron
                if (!grupoData) {
                    const grupoDoc = await getDoc(doc(db, "gruposChat", grupoId));
                    if (!grupoDoc.exists()) {
                        alert('Grupo no encontrado');
                        return;
                    }
                    grupoData = grupoDoc.data();
                }
                
                const groupInfoModal = document.getElementById('groupInfoModal');
                const groupInfoName = document.getElementById('groupInfoName');
                const groupInfoPicture = document.getElementById('groupInfoPicture');
                const groupInfoMembersList = document.getElementById('groupInfoMembersList');
                const groupChangePictureBtn = document.getElementById('groupChangePictureBtn');
                
                if (!groupInfoModal || !groupInfoName || !groupInfoPicture || !groupInfoMembersList) return;
                
                // Verificar si el usuario es el creador o administrador
                const isCreator = grupoData.creadorId === window.currentUser.uid;
                const isAdmin = grupoData.administradores && grupoData.administradores.includes(window.currentUser.uid);
                const isSpecialUser = window.currentUser.email === 'mpenalvart1@educacion.navarra.es';
                const canManage = isCreator || isAdmin || isSpecialUser;
                
                // Configurar nombre
                groupInfoName.textContent = grupoData.nombre || 'Grupo';
                
                // Configurar foto
                if (grupoData.fotoPerfil) {
                    groupInfoPicture.innerHTML = `<img src="${grupoData.fotoPerfil}" alt="Foto del grupo" style="width: 100%; height: 100%; object-fit: cover;">`;
                } else {
                    groupInfoPicture.innerHTML = '<div style="font-size: 3em;">👥</div>';
                }
                
                // Mostrar/ocultar botón de cambiar foto
                if (groupChangePictureBtn) {
                    if (canManage) {
                        groupChangePictureBtn.style.display = 'block';
                    } else {
                        groupChangePictureBtn.style.display = 'none';
                    }
                }
                
                // Mostrar/ocultar botón de añadir usuarios (solo para creador)
                const groupAddMembersBtn = document.getElementById('groupAddMembersBtn');
                if (groupAddMembersBtn) {
                    if (isCreator || isSpecialUser) {
                        groupAddMembersBtn.style.display = 'block';
                    } else {
                        groupAddMembersBtn.style.display = 'none';
                    }
                }
                
                // Cargar lista de miembros
                groupInfoMembersList.innerHTML = '';
                const miembros = grupoData.miembros || [];
                const administradores = grupoData.administradores || [];
                
                for (const miembroId of miembros) {
                    try {
                        const miembroDoc = await getDoc(doc(db, "usuarios", miembroId));
                        if (miembroDoc.exists()) {
                            const miembroData = miembroDoc.data();
                            const isMemberAdmin = administradores.includes(miembroId);
                            const isMemberCreator = miembroId === grupoData.creadorId;
                            
                            const memberItem = document.createElement('div');
                            memberItem.className = 'group-member-item';
                            
                            const picture = document.createElement('div');
                            picture.className = 'group-member-picture';
                            if (miembroData.fotoPerfil) {
                                picture.innerHTML = `<img src="${miembroData.fotoPerfil}" alt="${miembroData.nombre}">`;
                            } else {
                                picture.textContent = '👤';
                            }
                            
                            const info = document.createElement('div');
                            info.className = 'group-member-info';
                            
                            const name = document.createElement('div');
                            name.className = 'group-member-name';
                            name.textContent = miembroData.nombre || 'Sin nombre';
                            
                            const role = document.createElement('div');
                            role.className = `group-member-role ${isMemberAdmin ? 'admin' : ''}`;
                            if (isMemberCreator) {
                                role.textContent = '👑 Creador';
                            } else if (isMemberAdmin) {
                                role.textContent = '⭐ Administrador';
                            } else {
                                role.textContent = 'Miembro';
                            }
                            
                            info.appendChild(name);
                            info.appendChild(role);
                            
                            const actions = document.createElement('div');
                            actions.className = 'group-member-actions';
                            
                            // Solo mostrar acciones si el usuario puede gestionar y no es el mismo miembro
                            if (canManage && miembroId !== window.currentUser.uid) {
                                // Botón para dar/quitar rol de administrador (solo si no es el creador)
                                if (!isMemberCreator) {
                                    const adminBtn = document.createElement('button');
                                    adminBtn.className = `group-member-action-btn admin-btn`;
                                    adminBtn.textContent = isMemberAdmin ? 'Quitar Admin' : 'Hacer Admin';
                                    adminBtn.onclick = async () => {
                                        await window.toggleGroupAdmin(grupoId, miembroId, !isMemberAdmin);
                                        // Recargar información del grupo
                                        await window.showGroupInfo(grupoId);
                                    };
                                    actions.appendChild(adminBtn);
                                }
                                
                                // Botón para expulsar (solo si no es el creador)
                                if (!isMemberCreator) {
                                    const removeBtn = document.createElement('button');
                                    removeBtn.className = 'group-member-action-btn remove-btn';
                                    removeBtn.textContent = 'Expulsar';
                                    removeBtn.onclick = async () => {
                                        if (confirm(`¿Estás seguro de que quieres expulsar a ${miembroData.nombre} del grupo?`)) {
                                            await window.removeGroupMember(grupoId, miembroId);
                                            // Recargar información del grupo
                                            await window.showGroupInfo(grupoId);
                                        }
                                    };
                                    actions.appendChild(removeBtn);
                                }
                            }
                            
                            memberItem.appendChild(picture);
                            memberItem.appendChild(info);
                            memberItem.appendChild(actions);
                            
                            groupInfoMembersList.appendChild(memberItem);
                        }
                    } catch (error) {
                        console.error(`Error al cargar miembro ${miembroId}:`, error);
                    }
                }
                
                // Guardar grupoId en el modal para usar en otras funciones
                groupInfoModal.dataset.grupoId = grupoId;
                
                // Mostrar modal
                groupInfoModal.style.display = 'flex';
                
            } catch (error) {
                console.error('Error al mostrar información del grupo:', error);
            }
        };

        // Función para mostrar modal de añadir usuarios al grupo
        window.showAddMembersModal = async function(grupoId) {
            if (!window.currentUser || !grupoId) return;
            
            try {
                // Obtener datos del grupo para filtrar miembros existentes
                const grupoDoc = await getDoc(doc(db, "gruposChat", grupoId));
                if (!grupoDoc.exists()) {
                    alert('Grupo no encontrado');
                    return;
                }
                
                const grupoData = grupoDoc.data();
                const miembrosExistentes = grupoData.miembros || [];
                
                // Guardar grupoId y miembros existentes para usar en la búsqueda
                window.currentAddMembersGroupId = grupoId;
                window.currentAddMembersExistingMembers = miembrosExistentes;
                
                // Limpiar selección anterior
                window.selectedGroupUsers = [];
                if (window.updateGroupSelectedUsers) window.updateGroupSelectedUsers();
                if (window.updateGroupSearchResults) window.updateGroupSearchResults([]);
                
                // Cerrar modal de información del grupo
                const groupInfoModal = document.getElementById('groupInfoModal');
                if (groupInfoModal) {
                    groupInfoModal.style.display = 'none';
                }
                
                // Abrir modal de crear grupo (reutilizamos el mismo modal)
                const createGroupModal = document.getElementById('createGroupModal');
                if (createGroupModal) {
                    createGroupModal.style.display = 'flex';
                    const searchInput = document.getElementById('groupUserSearch');
                    if (searchInput) {
                        searchInput.value = '';
                        searchInput.focus();
                    }
                    // Cambiar título del modal y texto del botón
                    const modalTitle = createGroupModal.querySelector('h2');
                    if (modalTitle) {
                        modalTitle.textContent = 'Añadir Usuarios al Grupo';
                    }
                    const groupNextBtn = document.getElementById('groupNextBtn');
                    if (groupNextBtn) {
                        groupNextBtn.textContent = 'Añadir';
                    }
                }
            } catch (error) {
                console.error('Error al abrir modal de añadir usuarios:', error);
                alert('Error al abrir el modal de añadir usuarios');
            }
        };

        // Función para añadir usuarios al grupo
        window.addMembersToGroup = async function(grupoId, userIds) {
            if (!window.currentUser || !grupoId || !userIds || userIds.length === 0) return;
            
            try {
                const grupoRef = doc(db, "gruposChat", grupoId);
                const grupoDoc = await getDoc(grupoRef);
                
                if (!grupoDoc.exists()) {
                    alert('Grupo no encontrado');
                    return;
                }
                
                const grupoData = grupoDoc.data();
                const isCreator = grupoData.creadorId === window.currentUser.uid;
                const isSpecialUser = window.currentUser.email === 'mpenalvart1@educacion.navarra.es';
                
                if (!isCreator && !isSpecialUser) {
                    alert('Solo el creador del grupo puede añadir usuarios');
                    return;
                }
                
                // Obtener miembros actuales
                const miembrosActuales = grupoData.miembros || [];
                
                // Filtrar usuarios que ya están en el grupo
                const nuevosMiembros = userIds.filter(id => !miembrosActuales.includes(id));
                
                if (nuevosMiembros.length === 0) {
                    alert('Todos los usuarios seleccionados ya están en el grupo');
                    return;
                }
                
                // Agregar nuevos miembros
                const todosLosMiembros = [...miembrosActuales, ...nuevosMiembros];
                
                // Actualizar grupo en Firestore
                await updateDoc(grupoRef, { miembros: todosLosMiembros });
                
                // Agregar el grupo a la lista de grupos de cada nuevo miembro
                for (const miembroId of nuevosMiembros) {
                    const miembroRef = doc(db, "usuarios", miembroId);
                    const miembroDoc = await getDoc(miembroRef);
                    
                    if (miembroDoc.exists()) {
                        const grupos = miembroDoc.data().grupos || [];
                        if (!grupos.includes(grupoId)) {
                            grupos.push(grupoId);
                            await updateDoc(miembroRef, { grupos: grupos });
                        }
                    }
                }
                
                alert(`${nuevosMiembros.length} usuario${nuevosMiembros.length > 1 ? 's' : ''} añadido${nuevosMiembros.length > 1 ? 's' : ''} al grupo`);
                
                // Cerrar modal de crear grupo
                const createGroupModal = document.getElementById('createGroupModal');
                if (createGroupModal) {
                    createGroupModal.style.display = 'none';
                }
                
                // Limpiar selección
                window.selectedGroupUsers = [];
                window.currentAddMembersGroupId = null;
                window.currentAddMembersExistingMembers = null;
                
                // Recargar información del grupo si está abierto
                if (window.showGroupInfo) {
                    await window.showGroupInfo(grupoId);
                }
                
                // Recargar lista de chats
                if (window.loadChatsList) {
                    await window.loadChatsList();
                }
            } catch (error) {
                console.error('Error al añadir usuarios al grupo:', error);
                alert('Error al añadir usuarios al grupo');
            }
        };

        // Función para cambiar foto del grupo
        window.changeGroupPicture = async function(grupoId) {
            if (!window.currentUser || !grupoId) return;
            
            try {
                const grupoDoc = await getDoc(doc(db, "gruposChat", grupoId));
                if (!grupoDoc.exists()) {
                    alert('Grupo no encontrado');
                    return;
                }
                
                const grupoData = grupoDoc.data();
                const isCreator = grupoData.creadorId === window.currentUser.uid;
                const isAdmin = grupoData.administradores && grupoData.administradores.includes(window.currentUser.uid);
                const isSpecialUser = window.currentUser.email === 'mpenalvart1@educacion.navarra.es';
                
                if (!isCreator && !isAdmin && !isSpecialUser) {
                    alert('No tienes permisos para cambiar la foto del grupo');
                    return;
                }
                
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    try {
                        // Comprimir imagen
                        const compressedImage = await compressImage(file, 300, 300, 0.8);
                        
                        // Actualizar foto del grupo en Firestore
                        const grupoRef = doc(db, "gruposChat", grupoId);
                        await updateDoc(grupoRef, { fotoPerfil: compressedImage });
                        
                        // Actualizar foto en el header del chat
                        const headerPicture = document.getElementById('activeChatHeaderPicture');
                        if (headerPicture) {
                            headerPicture.innerHTML = `<img src="${compressedImage}" alt="Foto del grupo" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                        }
                        
                        // Actualizar foto en el modal
                        const groupInfoPicture = document.getElementById('groupInfoPicture');
                        if (groupInfoPicture) {
                            groupInfoPicture.innerHTML = `<img src="${compressedImage}" alt="Foto del grupo" style="width: 100%; height: 100%; object-fit: cover;">`;
                        }
                        
                        alert('Foto del grupo actualizada');
                    } catch (error) {
                        console.error('Error al cambiar foto del grupo:', error);
                        alert('Error al cambiar la foto del grupo');
                    }
                };
                input.click();
            } catch (error) {
                console.error('Error al cambiar foto del grupo:', error);
                alert('Error al cambiar la foto del grupo');
            }
        };

        // Función para dar/quitar rol de administrador
        window.toggleGroupAdmin = async function(grupoId, userId, makeAdmin) {
            if (!window.currentUser || !grupoId || !userId) return;
            
            try {
                const grupoDoc = await getDoc(doc(db, "gruposChat", grupoId));
                if (!grupoDoc.exists()) {
                    alert('Grupo no encontrado');
                    return;
                }
                
                const grupoData = grupoDoc.data();
                const isCreator = grupoData.creadorId === window.currentUser.uid;
                const isAdmin = grupoData.administradores && grupoData.administradores.includes(window.currentUser.uid);
                const isSpecialUser = window.currentUser.email === 'mpenalvart1@educacion.navarra.es';
                
                if (!isCreator && !isAdmin && !isSpecialUser) {
                    alert('No tienes permisos para gestionar administradores');
                    return;
                }
                
                const administradores = grupoData.administradores || [];
                
                if (makeAdmin) {
                    if (!administradores.includes(userId)) {
                        administradores.push(userId);
                    }
                } else {
                    const index = administradores.indexOf(userId);
                    if (index > -1) {
                        administradores.splice(index, 1);
                    }
                }
                
                const grupoRef = doc(db, "gruposChat", grupoId);
                await updateDoc(grupoRef, { administradores: administradores });
                
                alert(makeAdmin ? 'Usuario promovido a administrador' : 'Rol de administrador removido');
            } catch (error) {
                console.error('Error al cambiar rol de administrador:', error);
                alert('Error al cambiar el rol de administrador');
            }
        };

        // Función para expulsar miembro del grupo
        window.removeGroupMember = async function(grupoId, userId) {
            if (!window.currentUser || !grupoId || !userId) return;
            
            try {
                const grupoDoc = await getDoc(doc(db, "gruposChat", grupoId));
                if (!grupoDoc.exists()) {
                    alert('Grupo no encontrado');
                    return;
                }
                
                const grupoData = grupoDoc.data();
                const isCreator = grupoData.creadorId === window.currentUser.uid;
                const isAdmin = grupoData.administradores && grupoData.administradores.includes(window.currentUser.uid);
                const isSpecialUser = window.currentUser.email === 'mpenalvart1@educacion.navarra.es';
                
                if (!isCreator && !isAdmin && !isSpecialUser) {
                    alert('No tienes permisos para expulsar miembros');
                    return;
                }
                
                // Remover el usuario de la lista de miembros
                const miembros = grupoData.miembros || [];
                const nuevosMiembros = miembros.filter(id => id !== userId);
                
                // Remover también de administradores si es admin
                const administradores = grupoData.administradores || [];
                const nuevosAdministradores = administradores.filter(id => id !== userId);
                
                const grupoRef = doc(db, "gruposChat", grupoId);
                await updateDoc(grupoRef, { 
                    miembros: nuevosMiembros,
                    administradores: nuevosAdministradores
                });
                
                // Remover el grupo de la lista de grupos del usuario expulsado
                const userRef = doc(db, "usuarios", userId);
                const userDoc = await getDoc(userRef);
                
                if (userDoc.exists()) {
                    const grupos = userDoc.data().grupos || [];
                    const nuevosGrupos = grupos.filter(id => id !== grupoId);
                    await updateDoc(userRef, { grupos: nuevosGrupos });
                }
                
                alert('Usuario expulsado del grupo');
            } catch (error) {
                console.error('Error al expulsar miembro:', error);
                alert('Error al expulsar al miembro del grupo');
            }
        };

        // Función para salir del grupo
        window.leaveGroup = async function(grupoId) {
            if (!window.currentUser || !grupoId) return;
            
            if (!confirm('¿Estás seguro de que quieres salir de este grupo?')) {
                return;
            }
            
            try {
                // Remover el usuario de la lista de miembros del grupo
                const grupoRef = doc(db, "gruposChat", grupoId);
                const grupoDoc = await getDoc(grupoRef);
                
                if (grupoDoc.exists()) {
                    const miembros = grupoDoc.data().miembros || [];
                    const nuevosMiembros = miembros.filter(id => id !== window.currentUser.uid);
                    await updateDoc(grupoRef, { miembros: nuevosMiembros });
                }
                
                // Remover el grupo de la lista de grupos del usuario
                const userRef = doc(db, "usuarios", window.currentUser.uid);
                const userDoc = await getDoc(userRef);
                
                if (userDoc.exists()) {
                    const grupos = userDoc.data().grupos || [];
                    const nuevosGrupos = grupos.filter(id => id !== grupoId);
                    await updateDoc(userRef, { grupos: nuevosGrupos });
                }
                
                // Recargar lista de chats
                if (window.loadChatsList) {
                    await window.loadChatsList();
                }
                
                // Cerrar chat si está abierto
                const activeChat = document.getElementById('profileActiveChat');
                if (activeChat && window.currentChatGroupId === grupoId) {
                    activeChat.style.display = 'none';
                }
            } catch (error) {
                console.error('Error al salir del grupo:', error);
                alert('Error al salir del grupo. Por favor, intenta de nuevo.');
            }
        };

        window.loadChatsList = async function() {
            if (!window.currentUser) return;
            
            // Prevenir ejecuciones simultáneas
            if (window.loadingChatsList) {
                return;
            }
            window.loadingChatsList = true;
            
            try {
                const userDoc = await getDoc(doc(db, "usuarios", window.currentUser.uid));
                if (!userDoc.exists()) {
                    window.loadingChatsList = false;
                    return;
                }
                
                const amigos = userDoc.data().amigos || [];
                const grupos = userDoc.data().grupos || [];
                const chatsListEl = document.getElementById('chatsList');
                const chatsSection = document.getElementById('profileChatsSection');
                
                if (!chatsListEl || !chatsSection) {
                    window.loadingChatsList = false;
                    return;
                }
                
                if (amigos.length === 0 && grupos.length === 0) {
                    chatsSection.style.display = 'none';
                    window.loadingChatsList = false;
                    return;
                }
                
                // La sección de chats siempre debe estar visible si hay amigos o grupos
                chatsSection.style.display = 'block';
                
                // Limpiar completamente la lista antes de agregar nuevos elementos
                chatsListEl.innerHTML = '';
                
                // Usar un Set para rastrear chats ya agregados y evitar duplicados
                const addedChats = new Set();
                
                // Obtener últimos mensajes de cada amigo
                for (const friendId of amigos) {
                    try {
                        const friendDoc = await getDoc(doc(db, "usuarios", friendId));
                        if (friendDoc.exists()) {
                            const friendData = friendDoc.data();
                            
                            // Obtener último mensaje
                            const messagesRef = collection(db, "mensajes");
                            const chatId1 = `${window.currentUser.uid}_${friendId}`;
                            const chatId2 = `${friendId}_${window.currentUser.uid}`;
                            const finalChatId = chatId1 < chatId2 ? chatId1 : chatId2;
                            
                            const q = query(
                                messagesRef,
                                where("chatId", "==", finalChatId),
                                limit(50)
                            );
                            
                            const snapshot = await getDocs(q);
                            let lastMessage = null;
                            let unreadCount = 0;
                            
                            if (!snapshot.empty) {
                                // Obtener todos los mensajes y ordenarlos
                                const messages = [];
                                snapshot.forEach((doc) => {
                                    const messageData = doc.data();
                                    messages.push({
                                        ...messageData,
                                        id: doc.id
                                    });
                                });
                                
                                // Ordenar por timestamp descendente
                                messages.sort((a, b) => {
                                    const timeA = a.timestamp || 0;
                                    const timeB = b.timestamp || 0;
                                    return timeB - timeA;
                                });
                                
                                if (messages.length > 0) {
                                    lastMessage = messages[0];
                                }
                                
                                // Contar mensajes no leídos
                                const unreadQuery = query(
                                    messagesRef,
                                    where("chatId", "==", finalChatId),
                                    where("toUserId", "==", window.currentUser.uid),
                                    where("read", "==", false)
                                );
                                const unreadSnapshot = await getDocs(unreadQuery);
                                unreadCount = unreadSnapshot.size;
                            }
                            
                            const chatItem = document.createElement('div');
                            chatItem.className = 'chat-item';
                            // Agregar clase si tiene mensajes no leídos
                            if (unreadCount > 0) {
                                chatItem.classList.add('has-unread');
                            }
                            // NO agregar onclick al item completo - solo se abre con el botón de mensaje
                            
                            const picture = document.createElement('div');
                            picture.className = 'chat-item-picture';
                            if (friendData.fotoPerfil) {
                                const img = document.createElement('img');
                                img.src = friendData.fotoPerfil;
                                picture.appendChild(img);
                            } else {
                                picture.textContent = '👤';
                            }
                            
                            const info = document.createElement('div');
                            info.className = 'chat-item-info';
                            
                            const name = document.createElement('div');
                            name.className = 'chat-item-name';
                            name.textContent = friendData.nombre || 'Sin nombre';
                            
                            const lastMsg = document.createElement('div');
                            lastMsg.className = 'chat-item-last-message';
                            if (lastMessage) {
                                lastMsg.textContent = lastMessage.text || 'Sin mensajes';
                            } else {
                                lastMsg.textContent = 'Sin mensajes';
                            }
                            
                            info.appendChild(name);
                            info.appendChild(lastMsg);
                            
                            // Botón para abrir el chat (solo se abre al hacer clic aquí)
                            const messageBtn = document.createElement('button');
                            messageBtn.className = 'friend-item-message';
                            if (unreadCount > 0) {
                                messageBtn.classList.add('has-unread');
                            }
                            messageBtn.textContent = '💬';
                            messageBtn.title = unreadCount > 0 ? `${unreadCount} mensaje${unreadCount > 1 ? 's' : ''} no leído${unreadCount > 1 ? 's' : ''}` : 'Abrir chat';
                            messageBtn.style.marginLeft = 'auto';
                            messageBtn.style.flexShrink = '0';
                            messageBtn.onclick = async (e) => {
                                e.stopPropagation(); // Evitar que se propague el evento
                                await window.openChat(friendId, friendData);
                            };
                            
                            // Agregar badge de notificación si hay mensajes no leídos
                            if (unreadCount > 0) {
                                const badge = document.createElement('span');
                                badge.className = 'friend-item-message-badge';
                                badge.textContent = unreadCount > 9 ? '9+' : unreadCount.toString();
                                messageBtn.appendChild(badge);
                            }
                            
                            chatItem.appendChild(picture);
                            chatItem.appendChild(info);
                            chatItem.appendChild(messageBtn);
                            
                            if (unreadCount > 0) {
                                const unread = document.createElement('div');
                                unread.className = 'chat-item-unread';
                                unread.textContent = unreadCount > 9 ? '9+' : unreadCount;
                                chatItem.appendChild(unread);
                            }
                            
                            // Verificar que no esté duplicado antes de agregar
                            const chatKey = `friend_${friendId}`;
                            if (!addedChats.has(chatKey)) {
                                addedChats.add(chatKey);
                                chatsListEl.appendChild(chatItem);
                            }
                        }
                    } catch (error) {
                        console.error(`Error al cargar chat con ${friendId}:`, error);
                    }
                }

                // Cargar grupos
                for (const grupoId of grupos) {
                    try {
                        const grupoDoc = await getDoc(doc(db, "gruposChat", grupoId));
                        if (grupoDoc.exists()) {
                            const grupoData = grupoDoc.data();
                            const miembros = grupoData.miembros || [];
                            
                            // Verificar que el usuario aún es miembro
                            if (!miembros.includes(window.currentUser.uid)) {
                                // El usuario ya no es miembro, remover del array de grupos
                                const userRef = doc(db, "usuarios", window.currentUser.uid);
                                const nuevosGrupos = grupos.filter(id => id !== grupoId);
                                await updateDoc(userRef, { grupos: nuevosGrupos });
                                continue;
                            }
                            
                            // Obtener último mensaje del grupo
                            const messagesRef = collection(db, "mensajesGrupo");
                            const q = query(
                                messagesRef,
                                where("grupoId", "==", grupoId),
                                limit(50)
                            );
                            
                            const snapshot = await getDocs(q);
                            let lastMessage = null;
                            let unreadCount = 0;
                            
                            if (!snapshot.empty) {
                                const messages = [];
                                snapshot.forEach((doc) => {
                                    messages.push({
                                        ...doc.data(),
                                        id: doc.id
                                    });
                                });
                                
                                messages.sort((a, b) => {
                                    const timeA = a.timestamp || 0;
                                    const timeB = b.timestamp || 0;
                                    return timeB - timeA;
                                });
                                
                                if (messages.length > 0) {
                                    lastMessage = messages[0];
                                }
                                
                                // Contar mensajes no leídos (mensajes que no fueron enviados por el usuario actual)
                                unreadCount = messages.filter(m => 
                                    m.remitenteId !== window.currentUser.uid && 
                                    (!m.leidoPor || !m.leidoPor.includes(window.currentUser.uid))
                                ).length;
                            }
                            
                            const chatItem = document.createElement('div');
                            chatItem.className = 'chat-item group-chat-item';
                            if (unreadCount > 0) {
                                chatItem.classList.add('has-unread');
                            }
                            
                            const picture = document.createElement('div');
                            picture.className = 'chat-item-picture';
                            // Cargar foto del grupo si existe
                            if (grupoData.fotoPerfil) {
                                const img = document.createElement('img');
                                img.src = grupoData.fotoPerfil;
                                img.alt = grupoData.nombre || 'Grupo';
                                img.style.width = '100%';
                                img.style.height = '100%';
                                img.style.objectFit = 'cover';
                                img.style.borderRadius = '50%';
                                picture.appendChild(img);
                            } else {
                                picture.innerHTML = '👥'; // Icono de grupo por defecto
                            }
                            
                            const info = document.createElement('div');
                            info.className = 'chat-item-info';
                            
                            const name = document.createElement('div');
                            name.className = 'chat-item-name';
                            name.textContent = grupoData.nombre || 'Grupo sin nombre';
                            
                            const lastMsg = document.createElement('div');
                            lastMsg.className = 'chat-item-last-message';
                            if (lastMessage) {
                                const remitenteDoc = await getDoc(doc(db, "usuarios", lastMessage.remitenteId));
                                const remitenteNombre = remitenteDoc.exists() ? remitenteDoc.data().nombre : 'Usuario';
                                lastMsg.textContent = `${remitenteNombre}: ${lastMessage.texto || 'Sin mensajes'}`;
                            } else {
                                lastMsg.textContent = 'Sin mensajes';
                            }
                            
                            info.appendChild(name);
                            info.appendChild(lastMsg);
                            
                            // Botón para abrir el chat del grupo
                            const messageBtn = document.createElement('button');
                            messageBtn.className = 'friend-item-message';
                            if (unreadCount > 0) {
                                messageBtn.classList.add('has-unread');
                            }
                            messageBtn.textContent = '💬';
                            messageBtn.title = unreadCount > 0 ? `${unreadCount} mensaje${unreadCount > 1 ? 's' : ''} no leído${unreadCount > 1 ? 's' : ''}` : 'Abrir chat';
                            messageBtn.style.marginLeft = 'auto';
                            messageBtn.style.flexShrink = '0';
                            messageBtn.onclick = async (e) => {
                                e.stopPropagation();
                                await window.openGroupChat(grupoId, grupoData);
                            };
                            
                            if (unreadCount > 0) {
                                const badge = document.createElement('span');
                                badge.className = 'friend-item-message-badge';
                                badge.textContent = unreadCount > 9 ? '9+' : unreadCount.toString();
                                messageBtn.appendChild(badge);
                            }
                            
                            // Botón para salir del grupo
                            const leaveBtn = document.createElement('button');
                            leaveBtn.className = 'group-leave-btn';
                            leaveBtn.textContent = 'Salir';
                            leaveBtn.title = 'Salir del grupo';
                            leaveBtn.style.marginLeft = '5px';
                            leaveBtn.style.flexShrink = '0';
                            leaveBtn.style.background = '#fee';
                            leaveBtn.style.color = '#c33';
                            leaveBtn.style.border = '1px solid #fcc';
                            leaveBtn.style.padding = '4px 8px';
                            leaveBtn.style.borderRadius = '4px';
                            leaveBtn.style.fontSize = '0.8em';
                            leaveBtn.style.cursor = 'pointer';
                            leaveBtn.onclick = async (e) => {
                                e.stopPropagation();
                                if (window.leaveGroup) {
                                    await window.leaveGroup(grupoId);
                                }
                            };
                            
                            chatItem.appendChild(picture);
                            chatItem.appendChild(info);
                            chatItem.appendChild(messageBtn);
                            chatItem.appendChild(leaveBtn);
                            
                            if (unreadCount > 0) {
                                const unread = document.createElement('div');
                                unread.className = 'chat-item-unread';
                                unread.textContent = unreadCount > 9 ? '9+' : unreadCount;
                                chatItem.appendChild(unread);
                            }
                            
                            // Verificar que no esté duplicado antes de agregar
                            const groupChatKey = `group_${grupoId}`;
                            if (!addedChats.has(groupChatKey)) {
                                addedChats.add(groupChatKey);
                                chatsListEl.appendChild(chatItem);
                            }
                        }
                    } catch (error) {
                        console.error(`Error al cargar grupo ${grupoId}:`, error);
                    }
                }

                // Actualizar notificaciones después de cargar chats
                if (window.loadProfileNotifications) {
                    await window.loadProfileNotifications();
                }
            } catch (error) {
                console.error('Error al cargar lista de chats:', error);
            } finally {
                // Liberar el flag siempre, incluso si hay error
                window.loadingChatsList = false;
            }
        };

        // ----------- SISTEMA DE AMIGOS -------------
        // Buscar usuarios por nombre
        window.searchUsers = async function(searchTerm) {
            if (!searchTerm || searchTerm.trim().length < 2) {
                return [];
            }
            
            try {
                const usersRef = collection(db, "usuarios");
                const q = query(usersRef, where("nombre", ">=", searchTerm.trim()), where("nombre", "<=", searchTerm.trim() + "\uf8ff"));
                const snapshot = await getDocs(q);
                
                const users = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    // Excluir al usuario actual
                    if (doc.id !== window.currentUser.uid) {
                        users.push({
                            id: doc.id,
                            nombre: data.nombre || 'Sin nombre',
                            email: data.email || '',
                            fotoPerfil: data.fotoPerfil || null
                        });
                    }
                });
                
                return users;
            } catch (error) {
                console.error('Error al buscar usuarios:', error);
                return [];
            }
        };

        // Enviar solicitud de amistad
        window.sendFriendRequest = async function(toUserId) {
            if (!window.currentUser || !toUserId) return false;
            
            try {
                const fromUserId = window.currentUser.uid;
                
                // Verificar si ya existe una solicitud
                const requestsRef = collection(db, "solicitudesAmistad");
                const q = query(
                    requestsRef,
                    where("de", "==", fromUserId),
                    where("para", "==", toUserId),
                    where("estado", "==", "pendiente")
                );
                const existingRequest = await getDocs(q);
                
                if (!existingRequest.empty) {
                    alert('Ya has enviado una solicitud a este usuario');
                    return false;
                }
                
                // Verificar si ya son amigos
                const userDoc = await getDoc(doc(db, "usuarios", fromUserId));
                if (userDoc.exists()) {
                    const amigos = userDoc.data().amigos || [];
                    if (amigos.includes(toUserId)) {
                        alert('Ya son amigos');
                        return false;
                    }
                }
                
                // Crear solicitud
                await addDoc(collection(db, "solicitudesAmistad"), {
                    de: fromUserId,
                    para: toUserId,
                    estado: "pendiente",
                    fecha: Date.now()
                });
                
                return true;
            } catch (error) {
                console.error('Error al enviar solicitud:', error);
                return false;
            }
        };

        // Cargar solicitudes recibidas
        window.loadFriendRequests = async function() {
            if (!window.currentUser) return [];
            
            try {
                const requestsRef = collection(db, "solicitudesAmistad");
                const q = query(
                    requestsRef,
                    where("para", "==", window.currentUser.uid),
                    where("estado", "==", "pendiente")
                );
                const snapshot = await getDocs(q);
                
                const requests = [];
                for (const docSnap of snapshot.docs) {
                    const data = docSnap.data();
                    const fromUserDoc = await getDoc(doc(db, "usuarios", data.de));
                    if (fromUserDoc.exists()) {
                        const userData = fromUserDoc.data();
                        requests.push({
                            id: docSnap.id,
                            fromUserId: data.de,
                            nombre: userData.nombre || 'Sin nombre',
                            email: userData.email || '',
                            fotoPerfil: userData.fotoPerfil || null,
                            fecha: data.fecha
                        });
                    }
                }
                
                return requests;
            } catch (error) {
                console.error('Error al cargar solicitudes:', error);
                return [];
            }
        };

        // Aceptar solicitud de amistad
        window.acceptFriendRequest = async function(requestId, fromUserId) {
            if (!window.currentUser) return false;
            
            try {
                const currentUserId = window.currentUser.uid;
                
                // Actualizar estado de la solicitud
                const requestRef = doc(db, "solicitudesAmistad", requestId);
                await updateDoc(requestRef, {
                    estado: "aceptada"
                });
                
                // Agregar a la lista de amigos de ambos usuarios
                const currentUserRef = doc(db, "usuarios", currentUserId);
                const fromUserRef = doc(db, "usuarios", fromUserId);
                
                const currentUserDoc = await getDoc(currentUserRef);
                const fromUserDoc = await getDoc(fromUserRef);
                
                const currentUserAmigos = currentUserDoc.exists() ? (currentUserDoc.data().amigos || []) : [];
                const fromUserAmigos = fromUserDoc.exists() ? (fromUserDoc.data().amigos || []) : [];
                
                if (!currentUserAmigos.includes(fromUserId)) {
                    currentUserAmigos.push(fromUserId);
                }
                if (!fromUserAmigos.includes(currentUserId)) {
                    fromUserAmigos.push(currentUserId);
                }
                
                await updateDoc(currentUserRef, {
                    amigos: currentUserAmigos
                });
                
                await updateDoc(fromUserRef, {
                    amigos: fromUserAmigos
                });
                
                return true;
            } catch (error) {
                console.error('Error al aceptar solicitud:', error);
                return false;
            }
        };

        // Funciones para expandir/colapsar secciones desplegables

        // Rechazar solicitud de amistad
        window.rejectFriendRequest = async function(requestId) {
            try {
                const requestRef = doc(db, "solicitudesAmistad", requestId);
                await updateDoc(requestRef, {
                    estado: "rechazada"
                });
                return true;
            } catch (error) {
                console.error('Error al rechazar solicitud:', error);
                return false;
            }
        };

        // Cargar lista de amigos
        window.loadFriendsList = async function() {
            if (!window.currentUser) return;
            
            try {
                const userDoc = await getDoc(doc(db, "usuarios", window.currentUser.uid));
                if (!userDoc.exists()) return;
                
                const amigos = userDoc.data().amigos || [];
                const friendsListEl = document.getElementById('friendsList');
                const friendsSection = document.getElementById('profileFriendsSection');
                
                if (!friendsListEl || !friendsSection) return;
                
                if (amigos.length === 0) {
                    friendsSection.style.display = 'none';
                    return;
                }
                
                friendsSection.style.display = 'block';
                friendsListEl.innerHTML = '';
                
                // Cargar información de cada amigo
                for (const friendId of amigos) {
                    try {
                        const friendDoc = await getDoc(doc(db, "usuarios", friendId));
                        if (friendDoc.exists()) {
                            const friendData = friendDoc.data();
                            const friendItem = document.createElement('div');
                            friendItem.className = 'friend-item';
                            
                            const picture = document.createElement('div');
                            picture.className = 'friend-item-picture';
                            if (friendData.fotoPerfil) {
                                const img = document.createElement('img');
                                img.src = friendData.fotoPerfil;
                                picture.appendChild(img);
                            } else {
                                picture.textContent = '👤';
                            }
                            
                            const name = document.createElement('div');
                            name.className = 'friend-item-name';
                            name.textContent = friendData.nombre || 'Sin nombre';
                            
                            // Botón para eliminar amigo
                            const removeBtn = document.createElement('button');
                            removeBtn.className = 'friend-item-remove';
                            removeBtn.textContent = '✕';
                            removeBtn.title = 'Eliminar amigo';
                            removeBtn.onclick = async (e) => {
                                e.stopPropagation(); // Evitar que se abra el perfil
                                if (confirm(`¿Estás seguro de que quieres eliminar a ${friendData.nombre || 'este amigo'}?`)) {
                                    const success = await window.removeFriend(friendId);
                                    if (success) {
                                        await window.loadFriendsList();
                                    }
                                }
                            };
                            
                            // Hacer el item clicable para ver el perfil del amigo
                            friendItem.style.cursor = 'pointer';
                            friendItem.onclick = () => {
                                window.showFriendProfile(friendId, friendData);
                            };
                            
                            friendItem.appendChild(picture);
                            friendItem.appendChild(name);
                            friendItem.appendChild(removeBtn);
                            friendsListEl.appendChild(friendItem);
                        }
                    } catch (error) {
                        console.error(`Error al cargar amigo ${friendId}:`, error);
                    }
                }
            } catch (error) {
                console.error('Error al cargar lista de amigos:', error);
            }
        };

        // Mostrar modal de búsqueda de amigos
        window.showFriendsModal = function() {
            const modal = document.getElementById('friendsModal');
            if (modal) {
                modal.style.display = 'flex';
                document.getElementById('friendsResults').innerHTML = '';
                document.getElementById('friendsSearchInput').value = '';
            }
        };

        // Ocultar modal de búsqueda de amigos
        window.hideFriendsModal = function() {
            const modal = document.getElementById('friendsModal');
            if (modal) {
                modal.style.display = 'none';
            }
        };

        // Mostrar modal de bandeja
        window.showInboxModal = async function() {
            const modal = document.getElementById('inboxModal');
            if (modal) {
                modal.style.display = 'flex';
                await window.loadInboxRequests();
            }
        };

        // Ocultar modal de bandeja
        window.hideInboxModal = function() {
            const modal = document.getElementById('inboxModal');
            if (modal) {
                modal.style.display = 'none';
            }
        };

        // Cargar solicitudes en la bandeja
        window.loadInboxRequests = async function() {
            const requestsEl = document.getElementById('inboxRequests');
            if (!requestsEl) return;
            
            requestsEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #718096;">Cargando...</div>';
            
            const requests = await window.loadFriendRequests();
            
            if (requests.length === 0) {
                requestsEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #718096;">No tienes solicitudes pendientes</div>';
                return;
            }
            
            requestsEl.innerHTML = '';
            requests.forEach(request => {
                const requestItem = document.createElement('div');
                requestItem.className = 'inbox-request-item';
                
                const picture = document.createElement('div');
                picture.className = 'friend-result-picture';
                if (request.fotoPerfil) {
                    const img = document.createElement('img');
                    img.src = request.fotoPerfil;
                    picture.appendChild(img);
                } else {
                    picture.textContent = '👤';
                }
                
                const info = document.createElement('div');
                info.className = 'friend-result-info';
                const name = document.createElement('div');
                name.className = 'friend-result-name';
                name.textContent = request.nombre;
                const email = document.createElement('div');
                email.className = 'friend-result-email';
                email.textContent = request.email;
                info.appendChild(name);
                info.appendChild(email);
                
                const actions = document.createElement('div');
                actions.className = 'inbox-request-actions';
                
                const acceptBtn = document.createElement('button');
                acceptBtn.className = 'accept-request-btn';
                acceptBtn.textContent = '✓ Aceptar';
                acceptBtn.onclick = async () => {
                    acceptBtn.disabled = true;
                    const success = await window.acceptFriendRequest(request.id, request.fromUserId);
                    if (success) {
                        await window.loadInboxRequests();
                        await window.loadFriendsList();
                    } else {
                        alert('Error al aceptar la solicitud');
                        acceptBtn.disabled = false;
                    }
                };
                
                const rejectBtn = document.createElement('button');
                rejectBtn.className = 'reject-request-btn';
                rejectBtn.textContent = '✕ Rechazar';
                rejectBtn.onclick = async () => {
                    rejectBtn.disabled = true;
                    const success = await window.rejectFriendRequest(request.id);
                    if (success) {
                        await window.loadInboxRequests();
                    } else {
                        alert('Error al rechazar la solicitud');
                        rejectBtn.disabled = false;
                    }
                };
                
                actions.appendChild(acceptBtn);
                actions.appendChild(rejectBtn);
                
                requestItem.appendChild(picture);
                requestItem.appendChild(info);
                requestItem.appendChild(actions);
                requestsEl.appendChild(requestItem);
            });
        }

        // ----------- GUARDAR PUNTUACIÓN -------------
        window.guardarPuntuacion = async function(nombre, puntos, nivel) {
            try {
                const userId = window.currentUser ? window.currentUser.uid : null;
                const nivelActual = nivel || 'unknown';
                
                // Si hay un usuario autenticado, buscar si ya tiene una puntuación en este nivel
                if (userId) {
                    // Obtener todas las puntuaciones del usuario para este nivel
                    const q = query(
                        collection(db, "puntuaciones"),
                        where("userId", "==", userId)
                    );
                    
                    const snapshot = await getDocs(q);
                    
                    // Buscar si ya existe una puntuación para este nivel
                    let existingDoc = null;
                    let existingData = null;
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.nivel === nivelActual) {
                            existingDoc = doc;
                            existingData = data;
                        }
                    });
                    
                    if (existingDoc && existingData) {
                        // El usuario ya tiene una puntuación en este nivel
                        // Solo actualizar si la nueva puntuación es mejor
                        if (puntos > existingData.puntos) {
                            await updateDoc(existingDoc.ref, {
                                nombre: nombre,
                                puntos: puntos,
                                fecha: Date.now()
                            });
                            console.log("✔ Puntuación actualizada (mejor puntuación)");
                            return true;
                        } else {
                            console.log("ℹ Puntuación no actualizada (la anterior era mejor)");
                            return true; // No es un error, simplemente no se actualiza
                        }
                    }
                }
                
                // Si no hay puntuación existente o no hay usuario, crear una nueva
                await addDoc(collection(db, "puntuaciones"), {
                    nombre: nombre,
                    puntos: puntos,
                    nivel: nivelActual,
                    fecha: Date.now(),
                    userId: userId
                });
                console.log("✔ Puntuación guardada");
                return true;
            } catch (e) {
                console.error("Error al guardar puntuación: ", e);
                return false;
            }
        };

        // ----------- OBTENER RANKING ----------------
        window.obtenerRanking = async function(nivel) {
            try {
                let q;
                
                if (nivel) {
                    // Obtener todas las puntuaciones y filtrar por nivel en JavaScript
                    // Esto evita el problema del índice compuesto
                    q = query(
                        collection(db, "puntuaciones"),
                        orderBy("puntos", "desc")
                    );
                } else {
                    // Sin filtro (todos los niveles)
                    q = query(
                        collection(db, "puntuaciones"),
                        orderBy("puntos", "desc"),
                        limit(10)
                    );
                }

                const snapshot = await getDocs(q);
                const resultados = [];

                // Verificar cada puntuación para ver si el usuario aún existe
                for (const docSnapshot of snapshot.docs) {
                    const data = docSnapshot.data();
                    
                    // Si se especificó un nivel, filtrar por ese nivel
                    if (nivel && data.nivel !== nivel) {
                        continue;
                    }
                    
                    // Si tiene userId, verificar si el usuario aún existe
                    if (data.userId) {
                        try {
                            // Verificar si el usuario existe en la colección de usuarios
                            const userDoc = await getDoc(doc(db, "usuarios", data.userId));
                            if (!userDoc.exists()) {
                                // El usuario no existe en la colección, omitir esta puntuación
                                console.log(`Usuario ${data.userId} no existe en usuarios, omitiendo puntuación`);
                                continue;
                            }
                            
                            // Verificar también que el documento tenga un nombre válido
                            const userData = userDoc.data();
                            if (!userData || !userData.nombre) {
                                // El documento existe pero no tiene datos válidos, omitir
                                console.log(`Usuario ${data.userId} no tiene datos válidos, omitiendo puntuación`);
                                continue;
                            }
                            
                            // Verificar que el nombre en la puntuación coincida EXACTAMENTE con el nombre del usuario
                            // Si no coincide, puede ser que el usuario fue eliminado y recreado, o que hay una inconsistencia
                            if (data.nombre && userData.nombre) {
                                if (data.nombre.trim() !== userData.nombre.trim()) {
                                    // Los nombres no coinciden exactamente, omitir esta puntuación
                                    console.log(`Nombre no coincide para usuario ${data.userId}: "${data.nombre}" vs "${userData.nombre}", omitiendo puntuación`);
                                    continue;
                                }
                            } else if (data.nombre && !userData.nombre) {
                                // La puntuación tiene nombre pero el usuario no, omitir
                                console.log(`Usuario ${data.userId} no tiene nombre en su documento, omitiendo puntuación`);
                                continue;
                            }
                            
                            // Verificar que el documento no esté marcado como eliminado (si agregamos ese campo en el futuro)
                            if (userData.eliminado === true) {
                                console.log(`Usuario ${data.userId} está marcado como eliminado, omitiendo puntuación`);
                                continue;
                            }
                            
                            // Si el usuario existe y tiene datos válidos, agregar al ranking
                            resultados.push(data);
                        } catch (error) {
                            // Si hay error al verificar, omitir esta puntuación por seguridad
                            console.log(`Error al verificar usuario ${data.userId}:`, error);
                            continue;
                        }
                    } else {
                        // Si no tiene userId (puntuación anónima), incluirla
                        resultados.push(data);
                    }
                }
                
                // Ordenar por puntos (por si acaso) y limitar a 10
                resultados.sort((a, b) => (b.puntos || 0) - (a.puntos || 0));
                return resultados.slice(0, 10);
            } catch (e) {
                console.error("Error al obtener ranking: ", e);
                return [];
            }
        };

        // ========== SISTEMA DE NOTIFICACIONES PUSH ==========
        
        // Registrar Service Worker para notificaciones
        if ('serviceWorker' in navigator && window.location.protocol !== 'file:') {
            window.addEventListener('load', async () => {
                try {
                    // Crear service worker inline mejorado para FCM y notificaciones push
                    const swCode = `
                        // Importar Firebase Messaging en el Service Worker
                        importScripts('https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js');
                        importScripts('https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js');
                        
                        // Configuración de Firebase (debe coincidir con la del cliente)
                        const firebaseConfig = {
                            apiKey: "AIzaSyDyf2mRx0S1CBOH7u4N8kINoH6Bxe_ItZo",
                            authDomain: "banderas-f31cf.firebaseapp.com",
                            projectId: "banderas-f31cf",
                            storageBucket: "banderas-f31cf.firebasestorage.app",
                            messagingSenderId: "413939026360",
                            appId: "1:413939026360:web:b6e8b65c1f86cc9cf2274d",
                            measurementId: "G-H2LGX84Z2Z"
                        };
                        
                        // Inicializar Firebase en el Service Worker
                        firebase.initializeApp(firebaseConfig);
                        
                        // Obtener instancia de Firebase Messaging
                        const messaging = firebase.messaging();
                        
                        // Escuchar mensajes push en segundo plano
                        messaging.onBackgroundMessage((payload) => {
                            console.log('Mensaje push recibido en segundo plano:', payload);
                            
                            const notificationTitle = payload.notification?.title || '💬 Nuevo mensaje';
                            const notificationOptions = {
                                body: payload.notification?.body || 'Tienes un nuevo mensaje',
                                icon: payload.notification?.icon || 'https://martinpenalva.github.io/Juego_Banderas/OIG1.jpg',
                                badge: 'https://martinpenalva.github.io/Juego_Banderas/OIG1.jpg',
                                tag: payload.data?.tag || 'default',
                                requireInteraction: false,
                                vibrate: [200, 100, 200],
                                data: payload.data || {}
                            };
                            
                            return self.registration.showNotification(notificationTitle, notificationOptions);
                        });
                        
                        self.addEventListener('install', (event) => {
                            self.skipWaiting();
                        });
                        
                        self.addEventListener('activate', (event) => {
                            event.waitUntil(self.clients.claim());
                        });
                        
                        self.addEventListener('notificationclick', (event) => {
                            event.notification.close();
                            
                            // Si hay una URL en los datos, abrirla
                            if (event.notification.data?.url) {
                                event.waitUntil(clients.openWindow(event.notification.data.url));
                                return;
                            }
                            
                            event.waitUntil(
                                clients.matchAll({ type: 'window', includeUncontrolled: true }).then((clientList) => {
                                    // Si ya hay una ventana abierta, enfocarla
                                    for (const client of clientList) {
                                        if (client.url.includes(self.location.origin) && 'focus' in client) {
                                            return client.focus();
                                        }
                                    }
                                    // Si no hay ventana, abrir una nueva
                                    if (clients.openWindow) {
                                        return clients.openWindow('/');
                                    }
                                })
                            );
                        });
                        
                        // Escuchar mensajes del cliente para mostrar notificaciones
                        self.addEventListener('message', (event) => {
                            if (event.data && event.data.type === 'SHOW_NOTIFICATION') {
                                const { title, options } = event.data;
                                self.registration.showNotification(title, {
                                    ...options,
                                    badge: options.badge || 'https://martinpenalva.github.io/Juego_Banderas/OIG1.jpg',
                                    icon: options.icon || 'https://martinpenalva.github.io/Juego_Banderas/OIG1.jpg',
                                    requireInteraction: false,
                                    vibrate: options.vibrate || [200, 100, 200],
                                    tag: options.tag || 'default'
                                });
                            }
                        });
                    `;
                    
                    // Verificar si el protocolo soporta Service Workers
                    if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
                        // No registrar Service Worker si no es HTTPS o localhost
                        return;
                    }
                    
                    try {
                        const blob = new Blob([swCode], { type: 'application/javascript' });
                        const swUrl = URL.createObjectURL(blob);
                        
                        const registration = await navigator.serviceWorker.register(swUrl, {
                            scope: './',
                            type: 'classic'
                        });
                        
                        // Esperar a que el Service Worker esté listo
                        await navigator.serviceWorker.ready;
                    } catch (swError) {
                        // Intentar limpiar el blob URL si hay error
                        if (typeof URL.revokeObjectURL === 'function') {
                            try {
                                URL.revokeObjectURL(swUrl);
                            } catch (e) {
                                // Ignorar errores al revocar
                            }
                        }
                        
                        // Solo mostrar error si no es por protocolo o blob URL (común en algunos navegadores)
                        if (!swError.message.includes('file://') && 
                            !swError.message.includes('null') && 
                            !swError.message.includes('blob:') &&
                            !swError.message.includes('unsupported')) {
                            console.error('Error al registrar Service Worker:', swError);
                        }
                    }
                } catch (error) {
                    // Solo mostrar error si no es por protocolo file:// (normal al abrir archivo local)
                    if (!error.message?.includes('file://') && !error.message?.includes('null')) {
                        console.error('Error al registrar Service Worker:', error);
                    }
                }
            });
        }

        // Función para mostrar notificación - mejorada para móvil
        window.showNotification = async function(title, options = {}) {
            if (!('Notification' in window)) {
                // Navegador no soporta notificaciones (silencioso)
                return;
            }

            // Solicitar permisos si no están concedidos
            if (Notification.permission === 'default') {
                const permission = await Notification.requestPermission();
                if (permission !== 'granted') {
                    // Permisos denegados (silencioso)
                    return;
                }
            } else if (Notification.permission !== 'granted') {
                // Permisos no concedidos (silencioso)
                return;
            }

            // Configurar opciones de notificación optimizadas para móviles
            const notificationOptions = {
                body: options.body || '',
                icon: options.icon || 'https://martinpenalva.github.io/Juego_Banderas/OIG1.jpg',
                badge: options.badge || 'https://martinpenalva.github.io/Juego_Banderas/OIG1.jpg',
                tag: options.tag || `notification-${Date.now()}`,
                requireInteraction: options.requireInteraction || false,
                vibrate: options.vibrate || [200, 100, 200],
                data: options.data || {},
                ...options
            };

            try {
                if ('serviceWorker' in navigator && window.location.protocol !== 'file:') {
                    try {
                        const registration = await navigator.serviceWorker.ready;
                        // Usar el Service Worker para mostrar notificaciones (funciona en segundo plano)
                        await registration.showNotification(title, notificationOptions);
                    } catch (swError) {
                        // Si falla el Service Worker, usar notificación estándar
                        const notification = new Notification(title, notificationOptions);
                        if (!notificationOptions.requireInteraction) {
                            setTimeout(() => notification.close(), 5000);
                        }
                    }
                } else {
                    // Fallback si no hay Service Worker
                    const notification = new Notification(title, notificationOptions);
                    // Cerrar la notificación después de 5 segundos si no requiere interacción
                    if (!notificationOptions.requireInteraction) {
                        setTimeout(() => notification.close(), 5000);
                    }
                }
            } catch (error) {
                console.error('Error al mostrar notificación:', error);
                // Fallback a notificación básica sin Service Worker
                try {
                    const fallbackOptions = {
                        body: options.body || '',
                        icon: options.icon || 'https://martinpenalva.github.io/Juego_Banderas/OIG1.jpg',
                        badge: 'https://martinpenalva.github.io/Juego_Banderas/OIG1.jpg',
                        tag: options.tag || `notification-${Date.now()}`
                    };
                    const notification = new Notification(title, fallbackOptions);
                    if (!options.requireInteraction) {
                        setTimeout(() => notification.close(), 5000);
                    }
                } catch (fallbackError) {
                    console.error('Error en fallback de notificación:', fallbackError);
                }
            }
        };

        // ========== FIREBASE CLOUD MESSAGING (FCM) ==========
        
        // Función para obtener y guardar el token FCM
        window.requestFCMToken = async function() {
            if (!messaging || !window.currentUser) {
                // FCM no disponible (silencioso)
                return null;
            }
            
            // Verificar que no estemos en file:// (FCM no funciona en archivos locales)
            if (window.location.protocol === 'file:') {
                return null;
            }
            
            try {
                // Solicitar permisos de notificación
                const permission = await Notification.requestPermission();
                if (permission !== 'granted') {
                    // Permisos no concedidos (silencioso)
                    return null;
                }
                
                // Obtener el token FCM
                const currentToken = await getToken(messaging, { 
                    vapidKey: VAPID_KEY 
                });
                
                if (currentToken) {
                    // Token FCM obtenido exitosamente (solo log en desarrollo)
                    // console.log('Token FCM obtenido:', currentToken);
                    
                    // Guardar el token en Firestore
                    const userRef = doc(db, "usuarios", window.currentUser.uid);
                    await updateDoc(userRef, {
                        fcmToken: currentToken,
                        fcmTokenUpdated: Date.now()
                    });
                    
                    // Escuchar mensajes cuando la app está activa
                    onMessage(messaging, (payload) => {
                        // Mostrar notificación local cuando la app está activa
                        if (payload.notification) {
                            window.showNotification(payload.notification.title, {
                                body: payload.notification.body,
                                icon: payload.notification.icon,
                                tag: payload.data?.tag || 'default'
                            });
                        }
                    });
                    
                    return currentToken;
                } else {
                    // No se pudo obtener el token FCM (silencioso)
                    return null;
                }
            } catch (error) {
                // Solo mostrar errores importantes (no errores de permisos o protocolo)
                if (!error.message.includes('messaging/unsupported-browser') && 
                    !error.message.includes('messaging/permission-blocked')) {
                    console.error('Error al obtener token FCM:', error);
                }
                return null;
            }
        };
        
        // Función para enviar notificación push a un usuario
        // NOTA: Esta función guarda los datos en Firestore para que Cloud Functions los procese
        // Si tienes Cloud Functions configurado, deberías usarlas en su lugar
        window.sendPushNotification = async function(userId, title, body, data = {}) {
            try {
                // Obtener el token FCM del usuario destinatario
                const userDoc = await getDoc(doc(db, "usuarios", userId));
                if (!userDoc.exists()) {
                    console.log('Usuario no encontrado');
                    return false;
                }
                
                const userData = userDoc.data();
                const fcmToken = userData.fcmToken;
                
                if (!fcmToken) {
                    // Usuario no tiene token FCM (silencioso, es normal)
                    return false;
                }
                
                // Guardar la notificación pendiente en Firestore
                // Esto activará un trigger de Cloud Functions si está configurado
                // O puedes crear un Cloud Function que escuche esta colección
                await addDoc(collection(db, "notificacionesPendientes"), {
                    userId: userId,
                    fcmToken: fcmToken,
                    title: title,
                    body: body,
                    data: data,
                    timestamp: Date.now(),
                    enviado: false
                });
                
                console.log('Notificación push programada');
                
                // INTENTO ALTERNATIVO: Si tienes acceso al Server Key de Firebase
                // (NO recomendado en producción desde el cliente, mejor usar Cloud Functions)
                // Descomenta esto solo si necesitas una solución rápida y entiendes los riesgos:
                /*
                const SERVER_KEY = 'TU_SERVER_KEY_AQUI'; // Obténla de Firebase Console > Project Settings > Cloud Messaging
                const response = await fetch('https://fcm.googleapis.com/fcm/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `key=${SERVER_KEY}`
                    },
                    body: JSON.stringify({
                        to: fcmToken,
                        notification: {
                            title: title,
                            body: body,
                            icon: 'https://martinpenalva.github.io/Juego_Banderas/OIG1.jpg',
                            badge: 'https://martinpenalva.github.io/Juego_Banderas/OIG1.jpg',
                            click_action: window.location.origin
                        },
                        data: {
                            ...data,
                            click_action: window.location.origin
                        },
                        priority: 'high'
                    })
                });
                
                if (response.ok) {
                    console.log('Notificación push enviada exitosamente');
                    return true;
                } else {
                    console.error('Error al enviar notificación push:', await response.text());
                }
                */
                
                return true;
            } catch (error) {
                console.error('Error al enviar notificación push:', error);
                return false;
            }
        };
        
        // Solicitar permisos de notificaciones al inicio (mejorado para móviles)
        window.requestNotificationPermission = async function() {
            if (!('Notification' in window)) {
                console.log('Este navegador no soporta notificaciones');
                return false;
            }

            // Si ya está concedido, retornar
            if (Notification.permission === 'granted') {
                return true;
            }

            // Si está denegado, no intentar de nuevo
            if (Notification.permission === 'denied') {
                return false;
            }

            // Solicitar permisos
            try {
                const permission = await Notification.requestPermission();
                return permission === 'granted';
            } catch (error) {
                // Solo mostrar errores importantes
                if (error.message && !error.message.includes('User denied')) {
                    console.error('Error al solicitar permisos:', error);
                }
                return false;
            }
        };

        // Configurar listeners para notificaciones en tiempo real
        window.setupNotificationListeners = async function() {
            if (!window.currentUser) return;

            // Asegurarse de que los permisos estén concedidos
            if (Notification.permission !== 'granted') {
                await window.requestNotificationPermission();
            }
            
            // Si los permisos no están concedidos, no configurar listeners (silencioso)
            if (Notification.permission !== 'granted') {
                return;
            }

            const userId = window.currentUser.uid;
            let lastNotificationCheck = {
                messages: 0,
                likes: 0,
                comments: 0,
                requests: 0,
                chatMessages: 0
            };

            // Verificar mensajes del buzón de correo
            const messagesRef = collection(db, "mensajesCorreo");
            const messagesQuery = query(
                messagesRef,
                where("destinatarioId", "==", userId),
                where("leido", "==", false)
            );
            
            onSnapshot(messagesQuery, (snapshot) => {
                const unreadCount = snapshot.size;
                if (unreadCount > lastNotificationCheck.messages) {
                    const newMessages = unreadCount - lastNotificationCheck.messages;
                    window.showNotification('📮 Nuevo mensaje', {
                        body: `Tienes ${newMessages} nuevo${newMessages > 1 ? 's' : ''} mensaje${newMessages > 1 ? 's' : ''} en tu buzón`,
                        tag: 'mailbox-message',
                        requireInteraction: false
                    });
                }
                lastNotificationCheck.messages = unreadCount;
            });

            // Verificar mensajes de chat - mejorado para móvil
            const chatMessagesRef = collection(db, "mensajes");
            const chatMessagesQuery = query(
                chatMessagesRef,
                where("toUserId", "==", userId),
                where("read", "==", false)
            );
            
            let lastChatMessageIds = new Set();
            
            onSnapshot(chatMessagesQuery, async (snapshot) => {
                const currentMessageIds = new Set();
                const newMessages = [];
                
                snapshot.forEach((docSnapshot) => {
                    const messageData = docSnapshot.data();
                    const messageId = docSnapshot.id;
                    currentMessageIds.add(messageId);
                    
                    // Si es un mensaje nuevo que no estaba antes
                    if (!lastChatMessageIds.has(messageId)) {
                        newMessages.push({ ...messageData, id: messageId });
                    }
                });
                
                // Solo mostrar notificación si hay mensajes nuevos
                if (newMessages.length > 0) {
                    // Obtener información del remitente del último mensaje
                    const lastMessage = newMessages[newMessages.length - 1];
                    const senderId = lastMessage.fromUserId;
                    
                    // Obtener nombre del remitente
                    try {
                        const senderDoc = await getDoc(doc(db, "usuarios", senderId));
                        const senderName = senderDoc.exists() ? (senderDoc.data().nombre || 'Alguien') : 'Alguien';
                        
                        const notificationBody = newMessages.length === 1 
                            ? `${senderName}: ${(lastMessage.text || 'Nuevo mensaje').substring(0, 50)}${(lastMessage.text || '').length > 50 ? '...' : ''}`
                            : `${senderName} y otros: ${newMessages.length} nuevos mensajes`;
                        
                        // Mostrar notificación siempre, incluso si la página no está visible
                        await window.showNotification('💬 Nuevo mensaje de chat', {
                            body: notificationBody,
                            tag: `chat-${senderId}`, // Tag establecido para agrupar notificaciones del mismo remitente
                            requireInteraction: false,
                            vibrate: [200, 100, 200],
                            silent: false,
                            renotify: true // Renovar la notificación si ya existe una
                        });
                    } catch (error) {
                        console.error('Error al obtener nombre del remitente:', error);
                        await window.showNotification('💬 Nuevo mensaje de chat', {
                            body: `Tienes ${newMessages.length} nuevo${newMessages.length > 1 ? 's' : ''} mensaje${newMessages.length > 1 ? 's' : ''}`,
                            tag: `chat-${Date.now()}`,
                            requireInteraction: false,
                            vibrate: [200, 100, 200]
                        });
                    }
                    
                    // Actualizar la lista de amigos para mostrar los badges de notificación
                    if (window.loadFriendsList) {
                        await window.loadFriendsList();
                    }
                }
                
                lastChatMessageIds = currentMessageIds;
                lastNotificationCheck.chatMessages = snapshot.size;
            });

            // Verificar llamadas entrantes
            const callsRef = collection(db, "llamadas");
            const callsQuery = query(
                callsRef,
                where("toUserId", "==", userId),
                where("status", "==", "calling")
            );
            
            let processedCallIds = new Set();
            
            onSnapshot(callsQuery, async (snapshot) => {
                snapshot.forEach(async (docSnapshot) => {
                    const callData = docSnapshot.data();
                    const callId = docSnapshot.id;
                    
                    // Solo procesar llamadas nuevas
                    if (!processedCallIds.has(callId)) {
                        processedCallIds.add(callId);
                        
                        const callerName = callData.fromUserName || 'Alguien';
                        
                        // Mostrar modal de llamada entrante
                        window.showCallModal(callerName, callId, callData.fromUserId);
                        
                        // También mostrar notificación
                        await window.showNotification('📞 Llamada entrante', {
                            body: `${callerName} te está llamando`,
                            tag: `call-${callId}`,
                            requireInteraction: true,
                            vibrate: [200, 100, 200, 100, 200],
                            silent: false
                        });
                    }
                });
                
                // Si no hay llamadas activas, ocultar el modal
                if (snapshot.empty) {
                    window.hideCallModal();
                }
            });

            // Verificar likes y comentarios en fotos
            const fotosRef = collection(db, "fotos");
            const fotosQuery = query(fotosRef, where("userId", "==", userId));
            
            onSnapshot(fotosQuery, async (fotosSnapshot) => {
                const fotosIds = [];
                fotosSnapshot.forEach(docSnapshot => {
                    fotosIds.push(docSnapshot.id);
                });

                if (fotosIds.length > 0) {
                    // Verificar likes
                    const likesRef = collection(db, "fotoLikes");
                    let totalLikes = 0;
                    for (const fotoId of fotosIds) {
                        const likesQuery = query(likesRef, where("fotoId", "==", fotoId));
                        const likesSnapshot = await getDocs(likesQuery);
                        totalLikes += likesSnapshot.size;
                    }

                    if (totalLikes > lastNotificationCheck.likes) {
                        const newLikes = totalLikes - lastNotificationCheck.likes;
                        window.showNotification('❤️ Nuevo like', {
                            body: `Tu foto recibió ${newLikes} nuevo${newLikes > 1 ? 's' : ''} like${newLikes > 1 ? 's' : ''}`,
                            tag: 'photo-like',
                            requireInteraction: false
                        });
                    }
                    lastNotificationCheck.likes = totalLikes;

                    // Verificar comentarios
                    const commentsRef = collection(db, "fotoComentarios");
                    let totalComments = 0;
                    for (const fotoId of fotosIds) {
                        const commentsQuery = query(commentsRef, where("fotoId", "==", fotoId));
                        const commentsSnapshot = await getDocs(commentsQuery);
                        totalComments += commentsSnapshot.size;
                    }

                    if (totalComments > lastNotificationCheck.comments) {
                        const newComments = totalComments - lastNotificationCheck.comments;
                        window.showNotification('💬 Nuevo comentario', {
                            body: `Tu foto recibió ${newComments} nuevo${newComments > 1 ? 's' : ''} comentario${newComments > 1 ? 's' : ''}`,
                            tag: 'photo-comment',
                            requireInteraction: false
                        });
                    }
                    lastNotificationCheck.comments = totalComments;
                }
            });

            // Verificar solicitudes de amistad
            const userDocRef = doc(db, "usuarios", userId);
            onSnapshot(userDocRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const userData = docSnapshot.data();
                    const solicitudesRecibidas = userData.solicitudesRecibidas || [];
                    const requestsCount = solicitudesRecibidas.length;

                    if (requestsCount > lastNotificationCheck.requests) {
                        const newRequests = requestsCount - lastNotificationCheck.requests;
                        window.showNotification('👥 Nueva solicitud de amistad', {
                            body: `Tienes ${newRequests} nueva${newRequests > 1 ? 's' : ''} solicitud${newRequests > 1 ? 'es' : ''} de amistad`,
                            tag: 'friend-request',
                            requireInteraction: false
                        });
                    }
                    lastNotificationCheck.requests = requestsCount;
                }
            });
        };

        // ========== DETECCIÓN DE CONEXIÓN A INTERNET ==========
        
        // Modal para mostrar cuando no hay conexión
        const noConnectionModal = document.createElement('div');
        noConnectionModal.id = 'noConnectionModal';
        noConnectionModal.className = 'no-connection-modal';
        noConnectionModal.style.display = 'none';
        noConnectionModal.innerHTML = `
            <div class="no-connection-modal-content">
                <div class="no-connection-icon">📡</div>
                <h2>¡Ups! Se perdió la conexión</h2>
                <p class="no-connection-message">Parece que tu internet se fue de vacaciones... 😅<br>
                Sin conexión no podemos guardar tus progresos ni chatear con tus amigos.</p>
                <button class="no-connection-ok-btn" id="noConnectionOkBtn">OK</button>
            </div>
        `;
        document.body.appendChild(noConnectionModal);

        // Estilos para el modal de sin conexión
        const noConnectionStyles = document.createElement('style');
        noConnectionStyles.textContent = `
            .no-connection-modal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                animation: fadeIn 0.3s ease;
            }

            .no-connection-modal-content {
                background: white;
                border-radius: 20px;
                padding: 40px;
                max-width: 400px;
                width: 90%;
                text-align: center;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
                animation: slideUp 0.3s ease;
            }

            @keyframes slideUp {
                from {
                    transform: translateY(50px);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }

            .no-connection-icon {
                font-size: 4em;
                margin-bottom: 20px;
                animation: bounce 1s ease-in-out infinite;
            }

            @keyframes bounce {
                0%, 100% {
                    transform: translateY(0);
                }
                50% {
                    transform: translateY(-10px);
                }
            }

            .no-connection-modal-content h2 {
                color: #2d3748;
                margin-bottom: 15px;
                font-size: 1.8em;
            }

            .no-connection-message {
                color: #718096;
                font-size: 1.1em;
                line-height: 1.6;
                margin-bottom: 30px;
            }

            .no-connection-ok-btn {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                padding: 15px 40px;
                border-radius: 50px;
                font-size: 1.1em;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            }

            .no-connection-ok-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
            }

            .no-connection-ok-btn:active {
                transform: translateY(0);
            }
        `;
        document.head.appendChild(noConnectionStyles);

        // Función para mostrar el modal de sin conexión
        window.showNoConnectionModal = function() {
            const modal = document.getElementById('noConnectionModal');
            if (modal) {
                modal.style.display = 'flex';
            }
        };

        // Función para cerrar el modal y cerrar sesión
        const noConnectionOkBtn = document.getElementById('noConnectionOkBtn');
        if (noConnectionOkBtn) {
            noConnectionOkBtn.addEventListener('click', async () => {
                const modal = document.getElementById('noConnectionModal');
                if (modal) {
                    modal.style.display = 'none';
                }
                
                // Cerrar sesión
                if (window.cerrarSesion) {
                    await window.cerrarSesion();
                } else if (window.handleLogout) {
                    await window.handleLogout();
                } else if (auth && window.currentUser) {
                    try {
                        await signOut(auth);
                        window.currentUser = null;
                        window.currentUserName = null;
                        document.getElementById('authContainer').style.display = 'flex';
                        document.getElementById('gameContainer').style.display = 'none';
                        document.getElementById('profilePictureContainer').style.display = 'none';
                    } catch (error) {
                        console.error('Error al cerrar sesión:', error);
                        // Forzar cierre de sesión localmente si falla
                        window.currentUser = null;
                        window.currentUserName = null;
                        document.getElementById('authContainer').style.display = 'flex';
                        document.getElementById('gameContainer').style.display = 'none';
                        document.getElementById('profilePictureContainer').style.display = 'none';
                    }
                }
            });
        }

        // Detectar pérdida de conexión
        let connectionLostShown = false;
        
        window.addEventListener('offline', () => {
            if (window.currentUser && !connectionLostShown) {
                connectionLostShown = true;
                setTimeout(() => {
                    window.showNoConnectionModal();
                }, 1000); // Esperar 1 segundo para confirmar que realmente no hay conexión
            }
        });

        window.addEventListener('online', () => {
            connectionLostShown = false;
            const modal = document.getElementById('noConnectionModal');
            if (modal && modal.style.display !== 'none') {
                modal.style.display = 'none';
            }
        });

        // También verificar periódicamente la conexión usando navigator.onLine
        setInterval(() => {
            if (window.currentUser && !navigator.onLine && !connectionLostShown) {
                connectionLostShown = true;
                setTimeout(() => {
                    window.showNoConnectionModal();
                }, 1000);
            } else if (navigator.onLine) {
                connectionLostShown = false;
            }
        }, 5000); // Verificar cada 5 segundos
    </script>

    <!-- Modal de llamada entrante -->
    <div class="call-modal" id="callModal">
        <div class="call-modal-content">
            <div class="call-modal-icon">📞</div>
            <div class="call-modal-title">Llamada entrante</div>
            <div class="call-modal-caller" id="callModalCaller">Alguien</div>
            <div class="call-modal-actions">
                <button class="call-modal-btn call-modal-btn-accept" id="callModalAccept" title="Aceptar">✓</button>
                <button class="call-modal-btn call-modal-btn-reject" id="callModalReject" title="Rechazar">✕</button>
            </div>
        </div>
    </div>

    <!-- Modal para llamadas salientes -->
    <div class="outgoing-call-modal" id="outgoingCallModal">
        <div class="outgoing-call-modal-content">
            <div class="outgoing-call-modal-icon">📞</div>
            <div class="outgoing-call-modal-title">Llamando...</div>
            <div class="outgoing-call-modal-recipient" id="outgoingCallRecipient">Alguien</div>
            <div class="outgoing-call-modal-actions">
                <button class="outgoing-call-modal-btn-cancel" id="outgoingCallCancel" title="Cancelar">✕</button>
            </div>
        </div>
    </div>
</body>
</html>

