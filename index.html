<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juego de Adivinar Banderas</title>
    
    <!-- Favicon y iconos móviles -->
    <link rel="icon" type="image/jpeg" href="https://martinpenalva.github.io/Juego_Banderas/OIG1.jpg">
    <link rel="apple-touch-icon" href="https://martinpenalva.github.io/Juego_Banderas/OIG1.jpg">
    <link rel="manifest" href="https://martinpenalva.github.io/Juego_Banderas/manifest.json">
    
    <!-- Meta tags para PWA -->
    <meta name="theme-color" content="#764ba2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Banderas">
    <meta name="description" content="Juego interactivo de adivinar banderas de países con sistema de racha y comodines">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        body.hell-mode {
            background: linear-gradient(180deg, #1a0000 0%, #4a0000 30%, #8b0000 60%, #ff4500 100%);
            /* Desactivar animación de parpadeo para mejor rendimiento */
            /* animation: hellFlicker 0.5s ease-in-out infinite alternate; */
        }

        body.war-mode {
            background: linear-gradient(180deg, #1a1a1a 0%, #2d1b1b 25%, #3d2525 50%, #4a2a2a 75%, #5a3535 100%);
            position: relative;
            overflow-x: hidden;
            animation: warFlicker 0.5s ease-in-out infinite alternate;
        }

        @keyframes warFlicker {
            0% {
                filter: brightness(0.9) contrast(1.1);
            }
            100% {
                filter: brightness(1) contrast(1.2);
            }
        }

        body.easy-mode {
            background: linear-gradient(135deg, #2d5016 0%, #4a7c2a 30%, #6ba84f 60%, #8bc34a 100%);
            position: relative;
            overflow-x: hidden;
        }

        /* Overlay para modo guerra */
        .war-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        body.war-mode .war-overlay {
            opacity: 1;
        }

        /* Overlay para modo fácil */
        .nature-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        body.easy-mode .nature-overlay {
            opacity: 1;
        }

        /* Elementos de batalla */
        .smoke {
            position: absolute;
            width: 120px;
            height: 120px;
            background: radial-gradient(circle, rgba(50, 50, 50, 0.8) 0%, rgba(30, 30, 30, 0.5) 50%, transparent 70%);
            border-radius: 50%;
            animation: smokeRise 8s ease-out infinite;
            filter: blur(5px);
        }

        .explosion {
            position: absolute;
            width: 80px;
            height: 80px;
            background: radial-gradient(circle, rgba(255, 50, 50, 1) 0%, rgba(255, 100, 0, 0.8) 30%, rgba(200, 0, 0, 0.4) 60%, transparent 100%);
            border-radius: 50%;
            animation: explosionFlash 1.5s ease-out infinite;
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.8);
        }

        .bullet {
            position: absolute;
            width: 5px;
            height: 5px;
            background: #ff3333;
            border-radius: 50%;
            box-shadow: 0 0 15px #ff0000, 0 0 25px #ff3333;
            animation: bulletFly 3s linear infinite;
        }

        /* Elementos de naturaleza */
        .leaf {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #4a7c2a;
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            animation: leafFall 8s ease-in-out infinite;
        }

        .bird {
            position: absolute;
            font-size: 1.5em;
            animation: birdFly 15s linear infinite;
        }

        .wave {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 80px;
            background: linear-gradient(to top, 
                rgba(64, 150, 200, 0.4) 0%,
                rgba(64, 150, 200, 0.2) 50%,
                transparent 100%
            );
            animation: waveMove 3s ease-in-out infinite;
            clip-path: polygon(
                0% 100%,
                10% 80%,
                20% 90%,
                30% 70%,
                40% 85%,
                50% 75%,
                60% 90%,
                70% 70%,
                80% 85%,
                90% 75%,
                100% 100%
            );
        }

        .breeze {
            position: absolute;
            width: 2px;
            height: 30px;
            background: rgba(255, 255, 255, 0.3);
            animation: breezeMove 4s ease-in-out infinite;
        }

        @keyframes smokeRise {
            0% {
                transform: translateY(100vh) translateX(0) scale(0.5);
                opacity: 0.8;
            }
            50% {
                opacity: 0.6;
            }
            100% {
                transform: translateY(-100px) translateX(100px) scale(2);
                opacity: 0;
            }
        }

        @keyframes explosionFlash {
            0%, 100% {
                transform: scale(1);
                opacity: 0.8;
            }
            50% {
                transform: scale(1.5);
                opacity: 1;
            }
        }

        @keyframes bulletFly {
            0% {
                transform: translate(0, 100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translate(200px, -100px) rotate(360deg);
                opacity: 0;
            }
        }

        @keyframes leafFall {
            0% {
                transform: translateY(-100px) translateX(0) rotate(0deg);
                opacity: 1;
            }
            50% {
                transform: translateY(50vh) translateX(100px) rotate(180deg);
            }
            100% {
                transform: translateY(100vh) translateX(200px) rotate(360deg);
                opacity: 0;
            }
        }

        @keyframes birdFly {
            0% {
                transform: translateX(-100px) translateY(0);
            }
            50% {
                transform: translateX(50vw) translateY(-50px);
            }
            100% {
                transform: translateX(calc(100vw + 100px)) translateY(0);
            }
        }

        @keyframes waveMove {
            0%, 100% {
                transform: translateX(0);
            }
            50% {
                transform: translateX(-20px);
            }
        }

        @keyframes breezeMove {
            0% {
                transform: translateX(0) translateY(0) rotate(0deg);
                opacity: 0.3;
            }
            25% {
                transform: translateX(20px) translateY(-10px) rotate(5deg);
                opacity: 0.5;
            }
            50% {
                transform: translateX(40px) translateY(-20px) rotate(0deg);
                opacity: 0.3;
            }
            75% {
                transform: translateX(60px) translateY(-10px) rotate(-5deg);
                opacity: 0.5;
            }
            100% {
                transform: translateX(80px) translateY(0) rotate(0deg);
                opacity: 0.3;
            }
        }

        /* Overlay de fuego para modo imposible */
        .hell-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        body.hell-mode .hell-overlay {
            opacity: 1;
        }

        .flame {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 200px;
            background: linear-gradient(to top, 
                rgba(255, 69, 0, 0.8) 0%,
                rgba(255, 140, 0, 0.6) 30%,
                rgba(255, 200, 0, 0.4) 60%,
                transparent 100%
            );
            /* Animación más lenta para mejor rendimiento */
            animation: flameFlicker 1.5s ease-in-out infinite alternate;
            clip-path: polygon(
                0% 100%,
                5% 80%,
                10% 90%,
                15% 70%,
                20% 85%,
                25% 75%,
                30% 90%,
                35% 65%,
                40% 80%,
                45% 70%,
                50% 85%,
                55% 75%,
                60% 90%,
                65% 70%,
                70% 85%,
                75% 75%,
                80% 90%,
                85% 70%,
                90% 85%,
                95% 75%,
                100% 100%
            );
            will-change: transform, filter;
            transform: translateZ(0); /* Aceleración por hardware */
        }

        .flame:nth-child(1) {
            left: 0;
            animation-delay: 0s;
        }

        .flame:nth-child(2) {
            left: 25%;
            animation-delay: 0.2s;
            height: 180px;
        }

        .flame:nth-child(3) {
            left: 50%;
            animation-delay: 0.4s;
            height: 220px;
        }

        .flame:nth-child(4) {
            left: 75%;
            animation-delay: 0.1s;
            height: 190px;
        }

        .flame:nth-child(5) {
            right: 0;
            animation-delay: 0.3s;
            height: 200px;
        }

        .hell-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
        }

        .hell-particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #ff4500;
            border-radius: 50%;
            box-shadow: 0 0 10px #ff4500, 0 0 20px #ff4500;
            animation: particleFloat 3s ease-in-out infinite;
            will-change: transform, opacity;
            transform: translateZ(0); /* Aceleración por hardware */
        }

        /* Mini llamas que salpican */
        .spark {
            position: absolute;
            bottom: 0;
            width: 8px;
            height: 8px;
            background: radial-gradient(circle, #ff6b00 0%, #ff4500 50%, transparent 100%);
            border-radius: 50% 50% 50% 0;
            box-shadow: 0 0 15px #ff4500, 0 0 25px #ff6b00;
            animation: sparkFly 1.5s ease-out forwards;
            pointer-events: none;
            will-change: transform, opacity;
            transform: translateZ(0); /* Aceleración por hardware */
        }

        @keyframes sparkFly {
            0% {
                transform: translateY(0) translateX(0) scale(1) rotate(0deg);
                opacity: 1;
            }
            50% {
                opacity: 0.8;
            }
            100% {
                transform: translateY(-200px) translateX(var(--spark-x, 50px)) scale(0.3) rotate(360deg);
                opacity: 0;
            }
        }

        @keyframes hellFlicker {
            0% {
                filter: brightness(1) contrast(1);
            }
            50% {
                filter: brightness(1.1) contrast(1.1);
            }
            100% {
                filter: brightness(0.95) contrast(1.05);
            }
        }

        @keyframes flameFlicker {
            0% {
                transform: scaleY(1) scaleX(1);
                opacity: 0.8;
            }
            50% {
                transform: scaleY(1.1) scaleX(1.05);
                opacity: 1;
            }
            100% {
                transform: scaleY(0.9) scaleX(0.95);
                opacity: 0.7;
            }
        }

        @keyframes particleFloat {
            0% {
                transform: translateY(100vh) translateX(0) scale(0);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) translateX(50px) scale(1);
                opacity: 0;
            }
        }

        /* Efectos en el contenedor cuando está en modo infierno */
        body.hell-mode .container {
            background: linear-gradient(135deg, #2a1a1a 0%, #3d2525 50%, #2a1a1a 100%);
            box-shadow: 0 20px 60px rgba(255, 69, 0, 0.5), 
                        0 0 50px rgba(255, 140, 0, 0.3),
                        inset 0 0 30px rgba(255, 69, 0, 0.2);
            border: 2px solid rgba(255, 69, 0, 0.5);
            /* Desactivar animación de parpadeo para mejor rendimiento */
            /* animation: containerFlicker 0.4s ease-in-out infinite alternate; */
            color: #f0f0f0;
        }

        body.hell-mode .container h1,
        body.hell-mode .container .score,
        body.hell-mode .container .streak-text,
        body.hell-mode .container .lives-text {
            color: #ffcc99;
            text-shadow: 0 0 10px rgba(255, 140, 0, 0.5);
        }

        /* Efectos en el contenedor cuando está en modo guerra */
        body.war-mode .container {
            background: linear-gradient(135deg, #2a1a1a 0%, #3d2525 30%, #2a1a1a 60%, #1f1414 100%);
            box-shadow: 0 20px 60px rgba(139, 0, 0, 0.6), 
                        0 0 40px rgba(200, 0, 0, 0.4),
                        inset 0 0 30px rgba(100, 0, 0, 0.3);
            border: 3px solid rgba(139, 0, 0, 0.7);
            color: #ffcccc;
            position: relative;
        }

        body.war-mode .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 2px,
                    rgba(139, 0, 0, 0.03) 2px,
                    rgba(139, 0, 0, 0.03) 4px
                );
            pointer-events: none;
            border-radius: 20px;
        }

        body.war-mode .container h1 {
            color: #ff6666;
            text-shadow: 0 0 10px rgba(255, 0, 0, 0.8), 
                         0 0 20px rgba(255, 100, 100, 0.6),
                         0 2px 4px rgba(0, 0, 0, 0.5);
            animation: textGlow 2s ease-in-out infinite alternate;
        }

        body.war-mode .container .score {
            background: linear-gradient(135deg, #8b0000 0%, #a00000 50%, #8b0000 100%);
            color: #ffcccc;
            text-shadow: 0 0 8px rgba(255, 0, 0, 0.6), 
                         0 2px 4px rgba(0, 0, 0, 0.5);
            box-shadow: 0 4px 15px rgba(139, 0, 0, 0.5),
                        inset 0 0 10px rgba(255, 0, 0, 0.2);
        }

        body.war-mode .container .streak-text {
            background: linear-gradient(135deg, #8b0000 0%, #a00000 50%, #8b0000 100%);
            color: #ffcccc;
            text-shadow: 0 0 8px rgba(255, 0, 0, 0.6), 
                         0 2px 4px rgba(0, 0, 0, 0.5);
            box-shadow: 0 4px 15px rgba(139, 0, 0, 0.5),
                        inset 0 0 10px rgba(255, 0, 0, 0.2);
        }

        body.war-mode .container .lives-text {
            color: #ff9999;
            text-shadow: 0 0 8px rgba(255, 0, 0, 0.5), 
                         0 2px 4px rgba(0, 0, 0, 0.5);
        }

        @keyframes textGlow {
            0% {
                text-shadow: 0 0 10px rgba(255, 0, 0, 0.8), 
                             0 0 20px rgba(255, 100, 100, 0.6),
                             0 2px 4px rgba(0, 0, 0, 0.5);
            }
            100% {
                text-shadow: 0 0 15px rgba(255, 0, 0, 1), 
                             0 0 30px rgba(255, 100, 100, 0.8),
                             0 2px 4px rgba(0, 0, 0, 0.5);
            }
        }

        /* Efectos en el contenedor cuando está en modo fácil */
        body.easy-mode .container {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 50%, #e8f5e9 100%);
            box-shadow: 0 20px 60px rgba(76, 175, 80, 0.3), 
                        0 0 30px rgba(129, 199, 132, 0.2);
            border: 2px solid rgba(76, 175, 80, 0.4);
        }

        body.easy-mode .container h1,
        body.easy-mode .container .score,
        body.easy-mode .container .streak-text,
        body.easy-mode .container .lives-text {
            color: #2e7d32;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
        }

        @keyframes containerFlicker {
            0% {
                box-shadow: 0 20px 60px rgba(255, 69, 0, 0.5), 
                            0 0 50px rgba(255, 140, 0, 0.3),
                            inset 0 0 30px rgba(255, 69, 0, 0.2);
            }
            100% {
                box-shadow: 0 20px 60px rgba(255, 140, 0, 0.6), 
                            0 0 60px rgba(255, 200, 0, 0.4),
                            inset 0 0 40px rgba(255, 140, 0, 0.3);
            }
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
            text-align: center;
        }

        .title-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            gap: 15px;
        }

        h1 {
            color: #333;
            margin: 0;
            font-size: 2.5em;
            flex: 1;
        }

        .score {
            font-size: 1.5em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 700;
            margin-bottom: 15px;
            padding: 12px 25px;
            border-radius: 50px;
            display: inline-block;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            letter-spacing: 1px;
        }

        .streak-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .streak-fire {
            font-size: 2.5em;
            animation: fireFlicker 0.5s ease-in-out infinite alternate;
            filter: drop-shadow(0 0 10px rgba(255, 69, 0, 0.8));
            transition: all 0.3s ease;
        }

        .streak-fire.hot {
            font-size: 3em;
            filter: drop-shadow(0 0 20px rgba(255, 140, 0, 1));
            animation: fireFlicker 0.3s ease-in-out infinite alternate;
        }

        @keyframes fireFlicker {
            0% {
                transform: scale(1) rotate(-2deg);
                filter: drop-shadow(0 0 10px rgba(255, 69, 0, 0.8));
            }
            100% {
                transform: scale(1.1) rotate(2deg);
                filter: drop-shadow(0 0 15px rgba(255, 140, 0, 1));
            }
        }

        .streak-text {
            font-size: 1.3em;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            font-weight: 700;
            padding: 10px 20px;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            letter-spacing: 1px;
        }

        .lives-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-size: 200% 200%;
            animation: gradientFlow 3s ease infinite;
            padding: 15px 25px;
            border-radius: 50px;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4), 0 0 30px rgba(118, 75, 162, 0.3);
            position: relative;
            overflow: hidden;
        }

        .lives-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
            animation: rotate 4s linear infinite;
        }

        .lives-text {
            font-size: 1.2em;
            color: white;
            font-weight: 700;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            letter-spacing: 1px;
            position: relative;
            z-index: 1;
        }

        .hearts {
            font-size: 2.2em;
            letter-spacing: 10px;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .hearts .heart-full {
            animation: heartFloat 2s ease-in-out infinite;
            display: inline-block;
            filter: drop-shadow(0 0 10px rgba(255, 20, 147, 0.8));
            transform-origin: center;
        }

        .hearts .heart-full:nth-child(1) {
            animation-delay: 0s;
        }

        .hearts .heart-full:nth-child(2) {
            animation-delay: 0.3s;
        }

        .hearts .heart-full:nth-child(3) {
            animation-delay: 0.6s;
        }

        .hearts .heart-empty {
            opacity: 0.4;
            filter: grayscale(100%) drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
            transform: scale(0.9);
            transition: all 0.3s ease;
        }

        @keyframes gradientFlow {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes heartFloat {
            0%, 100% {
                transform: translateY(0) scale(1) rotate(0deg);
                filter: drop-shadow(0 0 10px rgba(255, 20, 147, 0.8));
            }
            25% {
                transform: translateY(-8px) scale(1.1) rotate(-5deg);
                filter: drop-shadow(0 0 15px rgba(255, 20, 147, 1));
            }
            50% {
                transform: translateY(-12px) scale(1.15) rotate(0deg);
                filter: drop-shadow(0 0 20px rgba(255, 20, 147, 1));
            }
            75% {
                transform: translateY(-8px) scale(1.1) rotate(5deg);
                filter: drop-shadow(0 0 15px rgba(255, 20, 147, 1));
            }
        }

        .joker-message {
            font-size: 1em;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            font-weight: 600;
            padding: 8px 15px;
            border-radius: 50px;
            box-shadow: 0 4px 10px rgba(245, 87, 108, 0.4);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            animation: jokerPulse 2s ease-in-out infinite;
        }

        @keyframes jokerPulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 4px 10px rgba(245, 87, 108, 0.4);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 6px 15px rgba(245, 87, 108, 0.6);
            }
        }

        /* Alertas estilizadas */
        .alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            animation: fadeIn 0.3s ease;
        }

        .alert-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
            max-width: 400px;
            width: 90%;
        }

        .alert-box.success {
            border-top: 5px solid #48bb78;
        }

        .alert-box.error {
            border-top: 5px solid #f56565;
        }

        .alert-icon {
            font-size: 4em;
            margin-bottom: 20px;
            animation: bounce 0.5s ease;
        }

        .alert-message {
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .alert-box.success .alert-message {
            color: #22543d;
        }

        .alert-box.error .alert-message {
            color: #742a2a;
        }

        .alert-details {
            font-size: 1em;
            color: #718096;
            margin-top: 10px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-20px);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        /* Estilos para cohetes */
        .rocket {
            position: fixed;
            font-size: 2.5em;
            pointer-events: none;
            z-index: 3000;
            filter: drop-shadow(0 0 10px rgba(255, 140, 0, 0.8));
            animation: rocketTrail 2s ease-out forwards;
        }

        @keyframes rocketTrail {
            0% {
                opacity: 1;
                filter: drop-shadow(0 0 10px rgba(255, 140, 0, 0.8));
            }
            50% {
                opacity: 0.8;
                filter: drop-shadow(0 0 20px rgba(255, 200, 0, 1));
            }
            100% {
                opacity: 0;
                filter: drop-shadow(0 0 30px rgba(255, 255, 255, 0.5));
            }
        }

        .joker-btn-inline {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 1em;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
            transition: all 0.3s ease;
            animation: jokerPulse 2s ease-in-out infinite;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            letter-spacing: 0.5px;
        }

        .joker-btn-inline:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px rgba(245, 87, 108, 0.6);
        }

        .joker-btn-inline:active {
            transform: translateY(0) scale(1);
        }

        @keyframes jokerPulse {
            0%, 100% {
                box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 6px 20px rgba(245, 87, 108, 0.8);
                transform: scale(1.05);
            }
        }

        .flag-container {
            margin: 30px 0;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f5f5f5;
            border-radius: 15px;
            padding: 20px;
        }

        .flag {
            font-size: 8em;
            line-height: 1;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
        }

        .flag div {
            font-size: 10em;
            line-height: 1;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.2));
        }

        .flag img {
            width: auto;
            height: auto;
            max-width: 100%;
            max-height: 180px;
            min-height: 100px;
            object-fit: contain;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            background: white;
            padding: 5px;
        }

        .timer-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
        }

        .timer-circle {
            position: relative;
            width: 80px;
            height: 80px;
        }

        .timer-svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .timer-circle-bg {
            fill: none;
            stroke: #e0e0e0;
            stroke-width: 8;
        }

        .timer-circle-progress {
            fill: none;
            stroke: #667eea;
            stroke-width: 8;
            stroke-linecap: round;
            stroke-dasharray: 283;
            stroke-dashoffset: 0;
            transition: stroke-dashoffset 1s linear, stroke 0.3s ease;
        }

        .timer-circle-progress.warning {
            stroke: #ff9800;
        }

        .timer-circle-progress.danger {
            stroke: #f44336;
        }

        .timer-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.8em;
            font-weight: 700;
            color: #333;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        body.hell-mode .timer-circle-progress {
            stroke: #ff4500;
        }

        body.hell-mode .timer-circle-progress.warning {
            stroke: #ff6b00;
        }

        body.hell-mode .timer-circle-progress.danger {
            stroke: #ff0000;
        }

        body.hell-mode .timer-text {
            color: #ffcccc;
            text-shadow: 0 0 10px rgba(255, 0, 0, 0.8);
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 30px 0;
        }

        .option {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .option:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .option:active {
            transform: translateY(0);
        }

        .option.correct {
            background: #48bb78;
        }

        .option.incorrect {
            background: #f56565;
        }

        .option:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        .next-btn {
            background: #764ba2;
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
            font-weight: 600;
            display: none;
        }

        .next-btn:hover {
            background: #653a8a;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(118, 75, 162, 0.4);
        }

        .next-btn.show {
            display: inline-block;
        }

        .message {
            margin-top: 20px;
            font-size: 1.2em;
            font-weight: bold;
            min-height: 30px;
        }

        .message.correct {
            color: #48bb78;
        }

        .message.incorrect {
            color: #f56565;
        }

        .loading {
            font-size: 1.2em;
            color: #667eea;
            margin: 20px 0;
        }

        .difficulty-selector {
            text-align: center;
            padding: 30px 0;
        }

        .difficulty-selector h2 {
            color: #333;
            margin-bottom: 30px;
            font-size: 1.8em;
        }

        .difficulty-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .difficulty-btn {
            background: white;
            border: 3px solid #667eea;
            padding: 25px 40px;
            border-radius: 15px;
            font-size: 1.3em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            color: #333;
            min-width: 200px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .difficulty-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .difficulty-btn.easy {
            border-color: #48bb78;
        }

        .difficulty-btn.easy:hover {
            background: #48bb78;
            color: white;
        }

        .difficulty-btn.hard {
            border-color: #f56565;
        }

        .difficulty-btn.hard:hover {
            background: #f56565;
            color: white;
        }

        .difficulty-btn.impossible {
            border-color: #2d3748;
        }

        .difficulty-btn.impossible:hover {
            background: #2d3748;
            color: white;
        }

        .difficulty-btn small {
            display: block;
            font-size: 0.7em;
            margin-top: 5px;
            font-weight: 400;
            opacity: 0.8;
        }

        .game-over {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .game-over-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .game-over-content h2 {
            color: #f56565;
            font-size: 2.5em;
            margin-bottom: 30px;
        }

        .game-over-stats {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-item {
            background: #f7fafc;
            padding: 20px;
            border-radius: 10px;
        }

        .stat-label {
            font-size: 0.9em;
            color: #718096;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .name-input-container {
            margin: 20px 0;
        }

        .name-input {
            width: 100%;
            padding: 12px;
            font-size: 1em;
            border: 2px solid #667eea;
            border-radius: 8px;
            margin-bottom: 10px;
            text-align: center;
            box-sizing: border-box;
        }

        .name-input:focus {
            outline: none;
            border-color: #764ba2;
        }

        .save-score-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1em;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
            font-weight: 600;
            width: 100%;
        }

        .save-score-btn:hover {
            transform: scale(1.05);
        }

        .save-score-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        /* Botón para ver ranking */
        .view-ranking-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 25%, #4facfe 50%, #00f2fe 75%, #43e97b 100%);
            background-size: 300% 300%;
            animation: gradientShift 3s ease infinite;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2), 0 0 20px rgba(255, 255, 255, 0.3) inset;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .view-ranking-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .view-ranking-btn:hover::before {
            left: 100%;
        }

        .view-ranking-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.3), 0 0 30px rgba(255, 255, 255, 0.4) inset;
        }

        .view-ranking-btn:active {
            transform: translateY(-1px) scale(1.02);
        }

        @keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        .ranking-container {
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
        }

        .ranking-container h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        /* Ranking principal en la pantalla del juego */
        .main-ranking-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        /* Estilos para modo imposible */
        body.hell-mode .main-ranking-container {
            background: linear-gradient(135deg, #2a1a1a 0%, #3d2525 50%, #2a1a1a 100%);
            box-shadow: 0 4px 15px rgba(255, 69, 0, 0.3), 
                        0 0 30px rgba(255, 140, 0, 0.2);
            border: 2px solid rgba(255, 69, 0, 0.5);
        }

        body.hell-mode .main-ranking-container h2 {
            color: #ffcc99;
            text-shadow: 0 0 10px rgba(255, 140, 0, 0.5);
        }

        .ranking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .main-ranking-container h2 {
            color: #667eea;
            margin: 0;
            font-size: 1.8em;
        }

        .close-ranking-btn {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(245, 101, 101, 0.4);
            position: relative;
            overflow: hidden;
        }

        .close-ranking-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }

        .close-ranking-btn:hover::before {
            width: 100%;
            height: 100%;
        }

        .close-ranking-btn:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 6px 20px rgba(245, 101, 101, 0.6);
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
        }

        .close-ranking-btn:active {
            transform: scale(0.95) rotate(90deg);
        }

        .main-ranking-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 400px;
            overflow-y: auto;
        }

        .main-ranking-item {
            background: #f7fafc;
            padding: 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #667eea;
            transition: transform 0.2s;
        }

        /* Estilos para items en modo imposible */
        body.hell-mode .main-ranking-item {
            background: rgba(61, 37, 37, 0.7) !important;
            border-left-color: rgba(255, 69, 0, 0.6) !important;
        }

        body.hell-mode .main-ranking-item:hover {
            background: rgba(61, 37, 37, 0.9) !important;
            border-left-color: rgba(255, 140, 0, 0.8) !important;
        }

        body.hell-mode .main-ranking-item.top {
            background: rgba(139, 69, 19, 0.8) !important;
            border-left-color: rgba(255, 140, 0, 0.9) !important;
        }

        .main-ranking-item:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .main-ranking-item.top {
            border-left-color: #fbbf24;
            background: #fffbeb;
        }

        .main-ranking-position {
            font-weight: bold;
            color: #667eea;
            min-width: 40px;
            font-size: 1.1em;
        }

        /* Estilos para posición en modo imposible */
        body.hell-mode .main-ranking-position {
            color: #ff9999 !important;
            text-shadow: 0 0 5px rgba(255, 140, 0, 0.5);
        }

        .main-ranking-name {
            flex: 1;
            text-align: left;
            margin-left: 15px;
            font-weight: 600;
            font-size: 1.05em;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ranking-profile-picture {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            border: 2px solid white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .ranking-profile-picture img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .ranking-profile-picture .placeholder {
            font-size: 1.2em;
            color: white;
        }

        /* Estilos para nombres en modo imposible */
        body.hell-mode .main-ranking-name {
            color: #ffcc99 !important;
            text-shadow: 0 0 5px rgba(255, 140, 0, 0.5), 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .main-ranking-score {
            font-weight: bold;
            color: #764ba2;
            font-size: 1.2em;
        }

        /* Estilos para puntuación en modo imposible */
        body.hell-mode .main-ranking-score {
            color: #ffcc99 !important;
            text-shadow: 0 0 5px rgba(255, 140, 0, 0.5);
        }

        /* Estilos para puntuación en modo imposible */
        body.hell-mode .main-ranking-score {
            color: #ffcc99;
            text-shadow: 0 0 5px rgba(255, 140, 0, 0.3);
        }

        .ranking-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .ranking-item {
            background: #f7fafc;
            padding: 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #667eea;
        }

        .ranking-item.top {
            border-left-color: #fbbf24;
            background: #fffbeb;
        }

        .ranking-position {
            font-weight: bold;
            color: #667eea;
            min-width: 30px;
        }

        .ranking-name {
            flex: 1;
            text-align: left;
            margin-left: 10px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ranking-score {
            font-weight: bold;
            color: #764ba2;
            font-size: 1.1em;
        }

        .restart-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s;
            font-weight: 600;
            width: 100%;
            margin-top: 10px;
        }

        .restart-btn:hover {
            transform: scale(1.05);
        }

        .show-ranking-btn {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1em;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
            font-weight: 600;
            width: 100%;
            margin-top: 10px;
        }

        .show-ranking-btn:hover {
            transform: scale(1.05);
        }

        /* Estilos para autenticación */
        .auth-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .auth-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
        }

        .auth-box h2 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2em;
        }

        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .auth-tab.active {
            background: #667eea;
            color: white;
        }

        .auth-tab:hover {
            transform: translateY(-2px);
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .auth-input {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .auth-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .auth-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .auth-btn:hover {
            transform: scale(1.02);
        }

        .auth-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .auth-message {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9em;
            min-height: 20px;
        }

        .auth-message.error {
            background: #fed7d7;
            color: #c53030;
        }

        .auth-message.success {
            background: #c6f6d5;
            color: #22543d;
        }

        /* Estilos para círculo de foto de perfil */
        .profile-picture-container {
            position: relative;
            flex-shrink: 0;
        }

        .profile-picture-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            border: 3px solid white;
            overflow: hidden;
        }

        .profile-picture-circle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .profile-picture-circle img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .profile-picture-placeholder {
            font-size: 2em;
            color: white;
        }

        /* Estilos para modal de perfil */
        .profile-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .profile-modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .profile-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .profile-modal-header h2 {
            margin: 0;
            color: #333;
            font-size: 1.8em;
        }

        .profile-modal-close {
            background: #f56565;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .profile-modal-close:hover {
            background: #e53e3e;
            transform: rotate(90deg);
        }

        .profile-modal-body {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .profile-picture-large-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .profile-picture-large {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            border: 5px solid white;
            overflow: hidden;
        }

        .profile-picture-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .profile-picture-large-placeholder {
            font-size: 5em;
            color: white;
        }

        .profile-upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .profile-upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .profile-info {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 15px;
        }

        .profile-info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .profile-info-item:last-child {
            border-bottom: none;
        }

        .profile-info-label {
            font-weight: 600;
            color: #4a5568;
        }

        .profile-info-value {
            color: #667eea;
            font-weight: 500;
        }

        .profile-actions {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .profile-save-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.4);
        }

        .profile-save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(72, 187, 120, 0.6);
        }

        .profile-save-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .profile-logout-btn {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(245, 101, 101, 0.4);
            width: 100%;
            margin-top: 10px;
        }

        .profile-logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 101, 101, 0.6);
        }

        /* Estilos para información de usuario */
        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #f7fafc;
            border-radius: 10px;
        }

        .user-name {
            font-weight: 600;
            color: #667eea;
            font-size: 1.1em;
        }

        .logout-btn {
            background: #f56565;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .logout-btn:hover {
            transform: scale(1.05);
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }

            .title-container {
                flex-wrap: wrap;
                gap: 10px;
            }

            h1 {
                font-size: 1.8em;
                flex: 1 1 100%;
                text-align: center;
            }

            .profile-picture-container {
                margin: 0 auto;
            }

            .profile-picture-circle {
                width: 50px;
                height: 50px;
            }

            .profile-picture-placeholder {
                font-size: 1.5em;
            }

            .flag {
                font-size: 6em;
            }

            .auth-box {
                padding: 30px 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Overlay de fuego para modo imposible -->
    <div class="hell-overlay" id="hellOverlay">
        <div class="flame"></div>
        <div class="flame"></div>
        <div class="flame"></div>
        <div class="flame"></div>
        <div class="flame"></div>
    </div>
    <div class="hell-particles" id="hellParticles"></div>
    
    <!-- Overlay de batalla para modo difícil -->
    <div class="war-overlay" id="warOverlay"></div>
    
    <!-- Overlay de naturaleza para modo fácil -->
    <div class="nature-overlay" id="natureOverlay">
        <div class="wave"></div>
        <div class="wave" style="animation-delay: 1s;"></div>
    </div>
    <!-- Pantalla de Login/Registro -->
    <div class="auth-container" id="authContainer">
        <div class="auth-box">
            <h2>🏳️ Juego de Banderas</h2>
            <div class="auth-tabs">
                <button class="auth-tab active" id="loginTab">Iniciar Sesión</button>
                <button class="auth-tab" id="registerTab">Registrarse</button>
            </div>
            
            <div class="auth-form" id="loginForm">
                <input type="email" id="loginEmail" placeholder="Correo electrónico" class="auth-input">
                <input type="password" id="loginPassword" placeholder="Contraseña" class="auth-input">
                <button class="auth-btn" id="loginBtn">Iniciar Sesión</button>
                <div class="auth-message" id="loginMessage"></div>
            </div>
            
            <div class="auth-form" id="registerForm" style="display: none;">
                <input type="text" id="registerName" placeholder="Nombre de usuario" class="auth-input" maxlength="20">
                <input type="email" id="registerEmail" placeholder="Correo electrónico" class="auth-input">
                <input type="password" id="registerPassword" placeholder="Contraseña (mín. 6 caracteres)" class="auth-input">
                <button class="auth-btn" id="registerBtn">Registrarse</button>
                <div class="auth-message" id="registerMessage"></div>
            </div>
        </div>
    </div>

    <!-- Modal de perfil -->
    <div class="profile-modal" id="profileModal" style="display: none;">
        <div class="profile-modal-content">
            <div class="profile-modal-header">
                <h2>👤 Mi Perfil</h2>
                <button class="profile-modal-close" id="profileModalClose">✕</button>
            </div>
            <div class="profile-modal-body">
                <div class="profile-picture-large-container">
                    <div class="profile-picture-large" id="profilePictureLarge">
                        <img id="profilePictureLargeImg" src="" alt="Foto de perfil" style="display: none;">
                        <div class="profile-picture-large-placeholder" id="profilePictureLargePlaceholder">👤</div>
                    </div>
                    <label for="profilePictureInput" class="profile-upload-btn">
                        📷 Cambiar Foto
                    </label>
                    <input type="file" id="profilePictureInput" accept="image/*" style="display: none;">
                </div>
                <div class="profile-info">
                    <div class="profile-info-item">
                        <span class="profile-info-label">Nombre:</span>
                        <span class="profile-info-value" id="profileName">-</span>
                    </div>
                    <div class="profile-info-item">
                        <span class="profile-info-label">Email:</span>
                        <span class="profile-info-value" id="profileEmail">-</span>
                    </div>
                </div>
                <div class="profile-actions">
                    <button class="profile-save-btn" id="profileSaveBtn" style="display: none;">💾 Guardar Cambios</button>
                    <button class="profile-logout-btn" id="profileLogoutBtn">🚪 Cerrar Sesión</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container" id="gameContainer" style="display: none;">
        <div class="user-info" style="display: none;">
            <div class="user-name" id="userNameDisplay">Usuario</div>
            <button class="logout-btn" id="logoutBtn" style="display: none;">Cerrar Sesión</button>
        </div>
        <div class="title-container">
            <h1>🏳️ Adivina la Bandera</h1>
            <div class="profile-picture-container" id="profilePictureContainer" style="display: none;">
                <div class="profile-picture-circle" id="profilePictureCircle">
                    <img id="profilePictureImg" src="" alt="Foto de perfil" style="display: none;">
                    <div class="profile-picture-placeholder" id="profilePicturePlaceholder">👤</div>
                </div>
            </div>
        </div>
        <div class="lives-container">
            <div class="lives-text">Vidas:</div>
            <div class="hearts" id="hearts">❤️ ❤️ ❤️</div>
        </div>
        <div class="score">Puntuación: <span id="score">0</span></div>
        <div class="streak-container">
            <div class="streak-fire" id="streakFire">🔥</div>
            <div class="streak-text">Racha: <span id="streak">0</span></div>
            <button class="joker-btn-inline" id="jokerBtn" style="display: none;">🎯 Comodín</button>
        </div>
        
        <div class="flag-container">
            <div class="flag" id="flag">🏳️</div>
        </div>

        <!-- Contador de tiempo -->
        <div class="timer-container" id="timerContainer" style="display: none;">
            <div class="timer-circle">
                <svg class="timer-svg" viewBox="0 0 100 100">
                    <circle class="timer-circle-bg" cx="50" cy="50" r="45"></circle>
                    <circle class="timer-circle-progress" cx="50" cy="50" r="45" id="timerProgress"></circle>
                </svg>
                <div class="timer-text" id="timerText">20</div>
            </div>
        </div>

        <!-- Botón para ver ranking -->
        <button class="view-ranking-btn" id="viewRankingBtn" style="display: none;">📊 Ver Tabla de Ranking</button>

        <!-- Ranking principal -->
        <div class="main-ranking-container" id="mainRankingContainer" style="display: none;">
            <div class="ranking-header">
                <h2 id="rankingTitle">🏆 Top 10 Ranking</h2>
                <button class="close-ranking-btn" id="closeRankingBtn">✕</button>
            </div>
            <div class="main-ranking-list" id="mainRankingList">
                <div style="text-align: center; padding: 20px; color: #718096;">Cargando ranking...</div>
            </div>
        </div>

        <div class="difficulty-selector" id="difficultySelector">
            <h2>Selecciona el nivel de dificultad</h2>
            <div class="difficulty-buttons">
                <button class="difficulty-btn easy" id="easyBtn">🟢 Fácil<br><small>Países de Europa</small></button>
                <button class="difficulty-btn hard" id="hardBtn">🔴 Difícil<br><small>Todos los países</small></button>
                <button class="difficulty-btn impossible" id="impossibleBtn">⚫ Imposible<br><small>Islas y paraísos fiscales</small></button>
            </div>
        </div>

        <div class="loading" id="loading" style="display: none;">Cargando...</div>

        <div class="options" id="options" style="display: none;">
            <button class="option" id="option1"></button>
            <button class="option" id="option2"></button>
            <button class="option" id="option3"></button>
            <button class="option" id="option4"></button>
        </div>


        <div class="message" id="message"></div>
        <button class="next-btn" id="nextBtn">Siguiente Bandera</button>

        <!-- Pantalla de Game Over -->
        <div class="game-over" id="gameOver" style="display: none;">
            <div class="game-over-content">
                <h2>💀 Has Perdido</h2>
                <div class="game-over-stats">
                    <div class="stat-item">
                        <div class="stat-label">Puntuación Total</div>
                        <div class="stat-value" id="finalScore">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Máxima Racha</div>
                        <div class="stat-value" id="maxStreak">0</div>
                    </div>
                </div>
                <div class="name-input-container" id="nameInputContainer" style="display: none;">
                    <button class="save-score-btn" id="saveScoreBtn">💾 Guardar Puntuación</button>
                </div>
                <div class="ranking-container" id="rankingContainer" style="display: none;">
                    <h3>🏆 Top 10</h3>
                    <div class="ranking-list" id="rankingList"></div>
                </div>
                <button class="restart-btn" id="restartBtn">🔄 Jugar de Nuevo</button>
                <button class="show-ranking-btn" id="showRankingBtn" style="display: none;">📊 Ver Ranking</button>
            </div>
        </div>
    </div>

    <script>
        let countries = [];
        let allCountries = [];
        let currentCountry = null;
        let score = 0;
        let streak = 0;
        let maxStreak = 0;
        let lives = 3;
        let answered = false;
        let jokerAvailable = false;
        let jokerUsed = false;
        let difficulty = null; // 'easy', 'hard' o 'impossible'
        let timerInterval = null;
        let timeLeft = 20;

        // Lista de países como respaldo (si la API falla)
        const fallbackCountries = [
            { name: { common: "España" }, cca2: "ES" },
            { name: { common: "Francia" }, cca2: "FR" },
            { name: { common: "Alemania" }, cca2: "DE" },
            { name: { common: "Italia" }, cca2: "IT" },
            { name: { common: "Reino Unido" }, cca2: "GB" },
            { name: { common: "Estados Unidos" }, cca2: "US" },
            { name: { common: "México" }, cca2: "MX" },
            { name: { common: "Argentina" }, cca2: "AR" },
            { name: { common: "Brasil" }, cca2: "BR" },
            { name: { common: "Chile" }, cca2: "CL" },
            { name: { common: "Colombia" }, cca2: "CO" },
            { name: { common: "Perú" }, cca2: "PE" },
            { name: { common: "Venezuela" }, cca2: "VE" },
            { name: { common: "Ecuador" }, cca2: "EC" },
            { name: { common: "Uruguay" }, cca2: "UY" },
            { name: { common: "Paraguay" }, cca2: "PY" },
            { name: { common: "Bolivia" }, cca2: "BO" },
            { name: { common: "Cuba" }, cca2: "CU" },
            { name: { common: "República Dominicana" }, cca2: "DO" },
            { name: { common: "Panamá" }, cca2: "PA" },
            { name: { common: "Costa Rica" }, cca2: "CR" },
            { name: { common: "Guatemala" }, cca2: "GT" },
            { name: { common: "Honduras" }, cca2: "HN" },
            { name: { common: "El Salvador" }, cca2: "SV" },
            { name: { common: "Nicaragua" }, cca2: "NI" },
            { name: { common: "Japón" }, cca2: "JP" },
            { name: { common: "China" }, cca2: "CN" },
            { name: { common: "India" }, cca2: "IN" },
            { name: { common: "Rusia" }, cca2: "RU" },
            { name: { common: "Canadá" }, cca2: "CA" },
            { name: { common: "Australia" }, cca2: "AU" },
            { name: { common: "Nueva Zelanda" }, cca2: "NZ" },
            { name: { common: "Sudáfrica" }, cca2: "ZA" },
            { name: { common: "Egipto" }, cca2: "EG" },
            { name: { common: "Marruecos" }, cca2: "MA" },
            { name: { common: "Turquía" }, cca2: "TR" },
            { name: { common: "Grecia" }, cca2: "GR" },
            { name: { common: "Portugal" }, cca2: "PT" },
            { name: { common: "Países Bajos" }, cca2: "NL" },
            { name: { common: "Bélgica" }, cca2: "BE" },
            { name: { common: "Suiza" }, cca2: "CH" },
            { name: { common: "Austria" }, cca2: "AT" },
            { name: { common: "Suecia" }, cca2: "SE" },
            { name: { common: "Noruega" }, cca2: "NO" },
            { name: { common: "Dinamarca" }, cca2: "DK" },
            { name: { common: "Finlandia" }, cca2: "FI" },
            { name: { common: "Polonia" }, cca2: "PL" },
            { name: { common: "República Checa" }, cca2: "CZ" },
            { name: { common: "Hungría" }, cca2: "HU" },
            { name: { common: "Rumania" }, cca2: "RO" },
            { name: { common: "Bulgaria" }, cca2: "BG" },
            { name: { common: "Croacia" }, cca2: "HR" },
            { name: { common: "Serbia" }, cca2: "RS" },
            { name: { common: "Ucrania" }, cca2: "UA" },
            { name: { common: "Israel" }, cca2: "IL" },
            { name: { common: "Arabia Saudí" }, cca2: "SA" },
            { name: { common: "Irán" }, cca2: "IR" },
            { name: { common: "Irak" }, cca2: "IQ" },
            { name: { common: "Pakistán" }, cca2: "PK" },
            { name: { common: "Bangladesh" }, cca2: "BD" },
            { name: { common: "Tailandia" }, cca2: "TH" },
            { name: { common: "Vietnam" }, cca2: "VN" },
            { name: { common: "Corea del Sur" }, cca2: "KR" },
            { name: { common: "Corea del Norte" }, cca2: "KP" },
            { name: { common: "Filipinas" }, cca2: "PH" },
            { name: { common: "Indonesia" }, cca2: "ID" },
            { name: { common: "Malasia" }, cca2: "MY" },
            { name: { common: "Singapur" }, cca2: "SG" }
        ];

        // Aplicar filtro según dificultad
        function applyDifficultyFilter() {
            if (difficulty === 'easy') {
                // Fácil: Solo países de Europa
                countries = allCountries.filter(country => {
                    const region = country.region || '';
                    const subregion = country.subregion || '';
                    // Filtrar por región Europa o subregión de Europa
                    return region === 'Europe' || 
                           subregion === 'Northern Europe' ||
                           subregion === 'Southern Europe' ||
                           subregion === 'Eastern Europe' ||
                           subregion === 'Western Europe' ||
                           // También incluir algunos países conocidos por código
                           ['ES', 'FR', 'DE', 'IT', 'GB', 'PT', 'NL', 'BE', 'CH', 'AT',
                            'SE', 'NO', 'DK', 'FI', 'PL', 'CZ', 'HU', 'RO', 'BG', 'HR',
                            'RS', 'UA', 'GR', 'IE', 'IS', 'LU', 'SK', 'SI', 'EE', 'LV',
                            'LT', 'MT', 'CY'].includes(country.cca2);
                });
                
                // Si no hay suficientes países europeos, usar los de la lista de respaldo que sean europeos
                if (countries.length < 10) {
                    const europeanFallback = fallbackCountries.filter(c => 
                        ['ES', 'FR', 'DE', 'IT', 'GB', 'PT', 'NL', 'BE', 'CH', 'AT',
                         'SE', 'NO', 'DK', 'FI', 'PL', 'CZ', 'HU', 'RO', 'BG', 'HR',
                         'RS', 'UA', 'GR'].includes(c.cca2)
                    );
                    countries = europeanFallback.length > 0 ? europeanFallback : countries;
                }
            } else if (difficulty === 'hard') {
                // Difícil: Todos los países (excluyendo los más conocidos de Europa para hacerlo más difícil)
                const wellKnownEuropean = ['ES', 'FR', 'DE', 'IT', 'GB', 'PT', 'NL', 'BE', 'CH', 'AT',
                                         'SE', 'NO', 'DK', 'FI', 'PL', 'GR', 'IE', 'IS', 'US', 'CA',
                                         'MX', 'BR', 'AR', 'CL', 'CO', 'PE', 'JP', 'CN', 'IN', 'RU',
                                         'AU', 'NZ', 'ZA'];
                countries = allCountries.filter(country => 
                    !wellKnownEuropean.includes(country.cca2)
                );
                
                // Si no hay suficientes, usar todos
                if (countries.length < 20) {
                    countries = allCountries;
                }
            } else if (difficulty === 'impossible') {
                // Imposible: Islas pequeñas y paraísos fiscales
                const smallIslandsAndTaxHavens = [
                    // Islas del Caribe
                    'AG', 'BS', 'BB', 'VG', 'KY', 'DM', 'GD', 'JM', 'KN', 'LC', 'VC', 'TT', 'TC',
                    // Islas del Pacífico
                    'CK', 'FJ', 'KI', 'MH', 'FM', 'NR', 'NU', 'PW', 'PG', 'WS', 'SB', 'TO', 'TV', 'VU',
                    // Islas del Océano Índico
                    'MV', 'MU', 'SC', 'KM',
                    // Otras islas pequeñas
                    'AD', 'AW', 'BH', 'BN', 'CV', 'CY', 'FO', 'GG', 'GI', 'GL', 'GP', 'GU', 'IM', 'JE',
                    'LI', 'MC', 'MQ', 'MT', 'MP', 'NC', 'PF', 'PM', 'PN', 'PR', 'RE', 'SH', 'SJ',
                    'SM', 'ST', 'SX', 'TF', 'TK', 'TL', 'VA', 'VI', 'WF', 'YT',
                    // Paraísos fiscales y microestados
                    'AI', 'AS', 'AX', 'BL', 'BM', 'BQ', 'BV', 'CC', 'CD', 'CW', 'CX', 'EH', 'FK',
                    'GF', 'GS', 'HK', 'HM', 'IO', 'MF', 'MO', 'MS', 'NF', 'PS', 'PW', 'QA', 'SG',
                    'SX', 'UM', 'VG', 'VI', 'XK'
                ];
                
                countries = allCountries.filter(country => {
                    const code = country.cca2 || '';
                    const region = country.region || '';
                    const subregion = country.subregion || '';
                    const population = country.population || 0;
                    
                    // Filtrar por código de islas pequeñas y paraísos fiscales
                    if (smallIslandsAndTaxHavens.includes(code)) {
                        return true;
                    }
                    
                    // INCLUIR TODOS LOS PAÍSES DE OCEANÍA
                    if (region === 'Oceania') {
                        return true;
                    }
                    
                    // INCLUIR PAÍSES PEQUEÑOS DE ÁFRICA (población menor a 10 millones)
                    if (region === 'Africa' && population > 0 && population < 10000000) {
                        return true;
                    }
                    
                    // Filtrar islas con población pequeña (menos de 1 millón)
                    if (population > 0 && population < 1000000) {
                        // Verificar si es una isla (no tiene fronteras terrestres o es pequeña)
                        const borders = country.borders || [];
                        if (borders.length === 0 || subregion.includes('Island') || subregion.includes('Caribbean')) {
                            return true;
                        }
                    }
                    
                    // Incluir microestados y territorios insulares
                    if (subregion === 'Caribbean' || subregion === 'Polynesia' || 
                        subregion === 'Micronesia' || subregion === 'Melanesia') {
                        return true;
                    }
                    
                    // INCLUIR PAÍSES PEQUEÑOS DE ASIA (población menor a 5 millones)
                    if (region === 'Asia' && population > 0 && population < 5000000) {
                        return true;
                    }
                    
                    // INCLUIR PAÍSES PEQUEÑOS DE AMÉRICA (población menor a 2 millones, excluyendo grandes países)
                    if ((region === 'Americas' || region === 'North America' || region === 'South America') && 
                        population > 0 && population < 2000000) {
                        // Excluir países grandes conocidos
                        const excludedCodes = ['US', 'CA', 'MX', 'BR', 'AR', 'CL', 'CO', 'PE', 'VE'];
                        if (!excludedCodes.includes(code)) {
                            return true;
                        }
                    }
                    
                    return false;
                });
                
                // Si no hay suficientes, agregar algunos de la lista de respaldo
                if (countries.length < 10) {
                    const impossibleFallback = [
                        // Microestados y países ultra-pequeños
                        { name: { common: "Nauru" }, cca2: "NR" },
                        { name: { common: "Tuvalu" }, cca2: "TV" },
                        { name: { common: "Kiribati" }, cca2: "KI" },
                        { name: { common: "Santo Tomé y Príncipe" }, cca2: "ST" },
                        { name: { common: "Comoras" }, cca2: "KM" },
                        { name: { common: "Yibuti" }, cca2: "DJ" },
                        { name: { common: "Timor Oriental" }, cca2: "TL" },
                        { name: { common: "Eritrea" }, cca2: "ER" },
                        // Islas y Oceanía
                        { name: { common: "Maldivas" }, cca2: "MV" },
                        { name: { common: "Mauricio" }, cca2: "MU" },
                        { name: { common: "Seychelles" }, cca2: "SC" },
                        { name: { common: "Bahamas" }, cca2: "BS" },
                        { name: { common: "Barbados" }, cca2: "BB" },
                        { name: { common: "Jamaica" }, cca2: "JM" },
                        { name: { common: "Trinidad y Tobago" }, cca2: "TT" },
                        { name: { common: "Fiyi" }, cca2: "FJ" },
                        { name: { common: "Papúa Nueva Guinea" }, cca2: "PG" },
                        { name: { common: "Samoa" }, cca2: "WS" },
                        { name: { common: "Tonga" }, cca2: "TO" },
                        { name: { common: "Vanuatu" }, cca2: "VU" },
                        { name: { common: "Cabo Verde" }, cca2: "CV" },
                        { name: { common: "Malta" }, cca2: "MT" },
                        { name: { common: "Chipre" }, cca2: "CY" },
                        { name: { common: "Islandia" }, cca2: "IS" },
                        { name: { common: "Antigua y Barbuda" }, cca2: "AG" },
                        { name: { common: "Granada" }, cca2: "GD" },
                        { name: { common: "San Vicente y las Granadinas" }, cca2: "VC" },
                        { name: { common: "Santa Lucía" }, cca2: "LC" },
                        { name: { common: "San Cristóbal y Nieves" }, cca2: "KN" },
                        { name: { common: "Dominica" }, cca2: "DM" },
                        // Islas remotas y territorios dependientes
                        { name: { common: "Tokelau" }, cca2: "TK" },
                        { name: { common: "Niue" }, cca2: "NU" },
                        { name: { common: "Islas Cocos" }, cca2: "CC" },
                        { name: { common: "Isla Norfolk" }, cca2: "NF" },
                        { name: { common: "Islas Pitcairn" }, cca2: "PN" },
                        { name: { common: "Islas Åland" }, cca2: "AX" },
                        { name: { common: "San Bartolomé" }, cca2: "BL" },
                        { name: { common: "Wallis y Futuna" }, cca2: "WF" },
                        { name: { common: "Mayotte" }, cca2: "YT" },
                        { name: { common: "Nueva Caledonia" }, cca2: "NC" },
                        // Territorios no reconocidos / parcialmente reconocidos
                        { name: { common: "Kosovo" }, cca2: "XK" },
                        // Regiones con bandera propia
                        { name: { common: "Isla de Man" }, cca2: "IM" },
                        { name: { common: "Guernsey" }, cca2: "GG" },
                        { name: { common: "Jersey" }, cca2: "JE" },
                        { name: { common: "Gibraltar" }, cca2: "GI" },
                        // Islas y territorios británicos
                        { name: { common: "Montserrat" }, cca2: "MS" },
                        { name: { common: "Anguila" }, cca2: "AI" },
                        { name: { common: "Islas Vírgenes Británicas" }, cca2: "VG" },
                        { name: { common: "Santa Helena" }, cca2: "SH" },
                        { name: { common: "Islas Turcas y Caicos" }, cca2: "TC" },
                        // Paraísos fiscales
                        { name: { common: "Islas Caimán" }, cca2: "KY" },
                        { name: { common: "Islas Cook" }, cca2: "CK" },
                        // Países pequeños de África
                        { name: { common: "Guinea-Bisáu" }, cca2: "GW" },
                        { name: { common: "Guinea Ecuatorial" }, cca2: "GQ" },
                        { name: { common: "Gambia" }, cca2: "GM" },
                        { name: { common: "Lesoto" }, cca2: "LS" },
                        { name: { common: "Suazilandia" }, cca2: "SZ" },
                        { name: { common: "Gabón" }, cca2: "GA" },
                        { name: { common: "Guinea" }, cca2: "GN" },
                        { name: { common: "Sierra Leona" }, cca2: "SL" },
                        { name: { common: "Togo" }, cca2: "TG" },
                        { name: { common: "Benín" }, cca2: "BJ" },
                        { name: { common: "Burkina Faso" }, cca2: "BF" },
                        { name: { common: "Malí" }, cca2: "ML" },
                        { name: { common: "Níger" }, cca2: "NE" },
                        { name: { common: "Chad" }, cca2: "TD" },
                        { name: { common: "República Centroafricana" }, cca2: "CF" },
                        { name: { common: "Burundi" }, cca2: "BI" },
                        { name: { common: "Ruanda" }, cca2: "RW" },
                        // Países de Oceanía adicionales
                        { name: { common: "Polinesia Francesa" }, cca2: "PF" },
                        { name: { common: "Guam" }, cca2: "GU" },
                        { name: { common: "Islas Marianas del Norte" }, cca2: "MP" },
                        { name: { common: "Palau" }, cca2: "PW" },
                        { name: { common: "Micronesia" }, cca2: "FM" },
                        { name: { common: "Islas Marshall" }, cca2: "MH" },
                        { name: { common: "Islas Salomón" }, cca2: "SB" },
                        { name: { common: "Nueva Zelanda" }, cca2: "NZ" }
                    ];
                    countries = impossibleFallback.length > 0 ? impossibleFallback : countries;
                }
            }
            
            console.log(`Nivel ${difficulty}: ${countries.length} países cargados`);
        }

        // Seleccionar nivel de dificultad
        // Crear partículas de fuego (muy optimizado para mejor rendimiento)
        function createHellParticles() {
            const particlesContainer = document.getElementById('hellParticles');
            if (!particlesContainer) return;
            
            // Limpiar partículas anteriores
            particlesContainer.innerHTML = '';
            
            // Reducir a solo 5 partículas para mejor rendimiento
            for (let i = 0; i < 5; i++) {
                const particle = document.createElement('div');
                particle.className = 'hell-particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 3 + 's';
                particle.style.animationDuration = (2 + Math.random() * 2) + 's';
                particle.style.willChange = 'transform, opacity';
                particlesContainer.appendChild(particle);
            }
        }

        // Crear mini llamas que salpican (muy optimizado)
        function createSparks() {
            const overlay = document.getElementById('hellOverlay');
            if (!overlay) return;
            
            // Reducir a solo 2-3 mini llamas para mejor rendimiento
            const sparkCount = 2 + Math.floor(Math.random() * 2);
            
            for (let i = 0; i < sparkCount; i++) {
                const spark = document.createElement('div');
                spark.className = 'spark';
                spark.style.left = Math.random() * 100 + '%';
                spark.style.bottom = '0px';
                spark.style.setProperty('--spark-x', (Math.random() * 200 - 100) + 'px');
                spark.style.animationDelay = Math.random() * 0.5 + 's';
                spark.style.animationDuration = (1 + Math.random() * 0.5) + 's';
                spark.style.willChange = 'transform, opacity';
                overlay.appendChild(spark);
                
                // Remover después de la animación
                setTimeout(() => {
                    if (overlay.contains(spark)) {
                        overlay.removeChild(spark);
                    }
                }, 2000);
            }
        }

        // Crear efectos de batalla
        function createWarEffects() {
            const overlay = document.getElementById('warOverlay');
            if (!overlay) return;
            
            // Crear humo
            for (let i = 0; i < 3; i++) {
                const smoke = document.createElement('div');
                smoke.className = 'smoke';
                smoke.style.left = Math.random() * 100 + '%';
                smoke.style.bottom = '0px';
                smoke.style.animationDelay = Math.random() * 2 + 's';
                smoke.style.animationDuration = (6 + Math.random() * 4) + 's';
                overlay.appendChild(smoke);
                
                setTimeout(() => {
                    if (overlay.contains(smoke)) {
                        overlay.removeChild(smoke);
                    }
                }, 10000);
            }
            
            // Crear explosiones ocasionales
            if (Math.random() > 0.7) {
                const explosion = document.createElement('div');
                explosion.className = 'explosion';
                explosion.style.left = Math.random() * 80 + 10 + '%';
                explosion.style.top = Math.random() * 50 + 20 + '%';
                overlay.appendChild(explosion);
                
                setTimeout(() => {
                    if (overlay.contains(explosion)) {
                        overlay.removeChild(explosion);
                    }
                }, 1000);
            }
            
            // Crear proyectiles
            for (let i = 0; i < 2; i++) {
                const bullet = document.createElement('div');
                bullet.className = 'bullet';
                bullet.style.left = Math.random() * 100 + '%';
                bullet.style.bottom = '0px';
                bullet.style.animationDelay = Math.random() * 1 + 's';
                bullet.style.setProperty('--bullet-x', (Math.random() * 200 - 100) + 'px');
                overlay.appendChild(bullet);
                
                setTimeout(() => {
                    if (overlay.contains(bullet)) {
                        overlay.removeChild(bullet);
                    }
                }, 3000);
            }
        }

        // Crear efectos de naturaleza
        function createNatureEffects() {
            const overlay = document.getElementById('natureOverlay');
            if (!overlay) return;
            
            // Crear hojas cayendo
            for (let i = 0; i < 5; i++) {
                const leaf = document.createElement('div');
                leaf.className = 'leaf';
                leaf.style.left = Math.random() * 100 + '%';
                leaf.style.top = '-20px';
                leaf.style.animationDelay = Math.random() * 2 + 's';
                leaf.style.animationDuration = (6 + Math.random() * 4) + 's';
                overlay.appendChild(leaf);
                
                setTimeout(() => {
                    if (overlay.contains(leaf)) {
                        overlay.removeChild(leaf);
                    }
                }, 12000);
            }
            
            // Crear pájaros volando
            if (Math.random() > 0.5) {
                const bird = document.createElement('div');
                bird.className = 'bird';
                bird.textContent = '🐦';
                bird.style.top = Math.random() * 30 + 10 + '%';
                bird.style.left = '-50px';
                bird.style.animationDelay = Math.random() * 2 + 's';
                overlay.appendChild(bird);
                
                setTimeout(() => {
                    if (overlay.contains(bird)) {
                        overlay.removeChild(bird);
                    }
                }, 15000);
            }
            
            // Crear brisas de viento
            for (let i = 0; i < 3; i++) {
                const breeze = document.createElement('div');
                breeze.className = 'breeze';
                breeze.style.left = Math.random() * 100 + '%';
                breeze.style.top = Math.random() * 50 + 20 + '%';
                breeze.style.animationDelay = Math.random() * 2 + 's';
                breeze.style.animationDuration = (3 + Math.random() * 2) + 's';
                overlay.appendChild(breeze);
                
                setTimeout(() => {
                    if (overlay.contains(breeze)) {
                        overlay.removeChild(breeze);
                    }
                }, 6000);
            }
        }

        function selectDifficulty(level) {
            // Detener temporizador si existe
            stopTimer();
            document.getElementById('timerContainer').style.display = 'none';
            
            difficulty = level;
            // Reiniciar vidas al seleccionar dificultad
            lives = 3;
            updateHearts();
            document.getElementById('difficultySelector').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            // Mostrar botón de ranking cuando se selecciona dificultad
            document.getElementById('viewRankingBtn').style.display = 'block';
            
            // Activar efectos según el modo
            document.body.classList.remove('hell-mode', 'war-mode', 'easy-mode');
            
            if (level === 'impossible') {
                document.body.classList.add('hell-mode');
                createHellParticles();
                createSparks();
                // Recrear partículas cada 10 segundos (mucho menos frecuente)
                setInterval(() => {
                    createHellParticles();
                }, 10000);
                // Crear mini llamas cada 3 segundos (mucho menos frecuente)
                setInterval(() => {
                    createSparks();
                }, 3000);
            } else if (level === 'hard') {
                document.body.classList.add('war-mode');
                createWarEffects();
                // Recrear efectos de batalla cada 2 segundos
                setInterval(() => {
                    createWarEffects();
                }, 2000);
            } else if (level === 'easy') {
                document.body.classList.add('easy-mode');
                createNatureEffects();
                // Recrear efectos de naturaleza cada 3 segundos
                setInterval(() => {
                    createNatureEffects();
                }, 3000);
            }
            
            loadCountries();
        }

        // Cargar países desde la API
        async function loadCountries() {
            const loadingEl = document.getElementById('loading');
            
            try {
                loadingEl.textContent = 'Cargando países...';
                
                // Intentar cargar desde la API (solo una vez, sin timeout para evitar errores)
                let data = null;
                
                try {
                    const response = await fetch('https://restcountries.com/v3.1/all', {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const jsonData = await response.json();
                        if (Array.isArray(jsonData) && jsonData.length > 0) {
                            data = jsonData;
                        }
                    }
                } catch (err) {
                    console.log('API no disponible, usando lista de respaldo');
                }
                
                // Si la API falla o no devuelve datos, usar lista de respaldo
                if (!data || data.length === 0) {
                    console.log('Usando lista de países de respaldo');
                    allCountries = fallbackCountries;
                } else {
                    // Filtrar países que tengan nombre y código ISO (para FlagsAPI)
                    allCountries = data.filter(country =>
                        country &&
                        country.name &&
                        country.name.common &&
                        country.cca2 // Código ISO de 2 letras para FlagsAPI
                    );
                    
                    // Si después del filtro no hay países, usar respaldo
                    if (allCountries.length === 0) {
                        console.log('No se encontraron países válidos, usando lista de respaldo');
                        allCountries = fallbackCountries;
                    }
                }
                
                if (allCountries.length === 0) {
                    throw new Error('No se pudo cargar ningún país');
                }
                
                // Aplicar filtro según dificultad
                applyDifficultyFilter();
                
                loadingEl.style.display = 'none';
                document.getElementById('options').style.display = 'flex';
                loadNewQuestion();
            } catch (error) {
                // Si todo falla, usar la lista de respaldo
                console.log('Error al cargar desde API, usando lista de respaldo:', error);
                allCountries = fallbackCountries;
                
                if (allCountries.length > 0) {
                    // Aplicar filtro según dificultad
                    applyDifficultyFilter();
                    
                    loadingEl.style.display = 'none';
                    document.getElementById('options').style.display = 'flex';
                    loadNewQuestion();
                } else {
                    loadingEl.textContent = `Error: ${error.message}. Recarga la página.`;
                    loadingEl.style.color = '#f56565';
                }
            }
        }

        // Funciones del temporizador
        function startTimer() {
            // Detener temporizador anterior si existe
            stopTimer();
            
            timeLeft = 20;
            updateTimerDisplay();
            document.getElementById('timerContainer').style.display = 'flex';
            
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft <= 0) {
                    stopTimer();
                    handleTimeUp();
                }
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function updateTimerDisplay() {
            const timerText = document.getElementById('timerText');
            const timerProgress = document.getElementById('timerProgress');
            
            if (!timerText || !timerProgress) return;
            
            timerText.textContent = timeLeft;
            
            // Calcular el progreso del círculo (circunferencia = 2 * π * r = 2 * π * 45 ≈ 283)
            const circumference = 2 * Math.PI * 45;
            const progress = (timeLeft / 20) * circumference;
            timerProgress.style.strokeDashoffset = circumference - progress;
            
            // Cambiar color según el tiempo restante
            timerProgress.classList.remove('warning', 'danger');
            if (timeLeft <= 5) {
                timerProgress.classList.add('danger');
            } else if (timeLeft <= 10) {
                timerProgress.classList.add('warning');
            }
        }

        function handleTimeUp() {
            if (answered) return;
            
            answered = true;
            
            // Deshabilitar todos los botones
            [1, 2, 3, 4].forEach(i => {
                const btn = document.getElementById(`option${i}`);
                if (btn.style.display !== 'none') {
                    btn.disabled = true;
                    
                    if (btn.textContent === currentCountry.name.common) {
                        btn.classList.add('correct');
                    }
                }
            });

            // Marcar como incorrecta (tiempo agotado)
            lives--;
            updateHearts();
            
            const messageEl = document.getElementById('message');
            messageEl.textContent = `⏰ Tiempo agotado. La respuesta correcta es: ${currentCountry.name.common}`;
            messageEl.className = 'message incorrect';
            
            // Actualizar puntuación
            document.getElementById('score').textContent = score;
            
            // Mostrar alerta de fallo
            showAlert('error', '', `La respuesta correcta era: ${currentCountry.name.common}`);
            
            // Actualizar racha (marcar como incorrecta)
            updateStreak(false);
            
            // Si se acabaron las vidas, mostrar game over
            if (lives <= 0) {
                setTimeout(() => {
                    showGameOver();
                }, 2000);
            } else {
                // Pasar automáticamente a la siguiente bandera después de 2 segundos
                setTimeout(() => {
                    loadNewQuestion();
                }, 2000);
            }
        }

        // Cargar nueva pregunta
        function loadNewQuestion() {
            if (countries.length === 0) return;

            // Detener temporizador anterior
            stopTimer();

            // Seleccionar país aleatorio
            const randomIndex = Math.floor(Math.random() * countries.length);
            currentCountry = countries[randomIndex];

            // Mostrar bandera usando emojis Unicode (siempre funcionan)
            const countryCode = currentCountry.cca2; // Código ISO de 2 letras
            
            // Función para convertir código ISO a emoji de bandera
            function getFlagEmoji(countryCode) {
                if (!countryCode || countryCode.length !== 2) return '🏳️';
                
                const codePoints = countryCode
                    .toUpperCase()
                    .split('')
                    .map(char => 127397 + char.charCodeAt());
                return String.fromCodePoint(...codePoints);
            }
            
            const flagEmoji = getFlagEmoji(countryCode);
            const flagEl = document.getElementById('flag');
            
            // Mostrar emoji de bandera (grande y centrado)
            flagEl.innerHTML = `<div style="font-size: 10em; line-height: 1; user-select: none;">${flagEmoji}</div>`;
            
            // También intentar cargar imagen como respaldo (opcional, en segundo plano)
            const flagUrls = [
                `https://flagcdn.com/${countryCode.toLowerCase()}.svg`,
                `https://flagcdn.com/w256/${countryCode.toLowerCase()}.png`,
                `https://flagsapi.com/${countryCode}/flat/64.png`
            ];
            
            // Intentar cargar imagen en segundo plano (sin bloquear)
            let imgIndex = 0;
            function tryLoadImage() {
                if (imgIndex >= flagUrls.length) return;
                
                const img = new Image();
                img.src = flagUrls[imgIndex];
                
                img.onload = function() {
                    // Si la imagen carga, reemplazar el emoji
                    flagEl.innerHTML = '';
                    img.alt = `Bandera de ${currentCountry.name.common}`;
                    img.style.width = 'auto';
                    img.style.height = 'auto';
                    img.style.maxWidth = '100%';
                    img.style.maxHeight = '180px';
                    img.style.minHeight = '100px';
                    img.style.objectFit = 'contain';
                    img.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.1)';
                    img.style.borderRadius = '8px';
                    img.style.background = 'white';
                    img.style.padding = '5px';
                    img.style.display = 'block';
                    img.style.margin = '0 auto';
                    flagEl.appendChild(img);
                };
                
                img.onerror = function() {
                    imgIndex++;
                    tryLoadImage();
                };
            }
            
            // Intentar cargar imagen (opcional, el emoji ya está mostrado)
            tryLoadImage();

            // Generar opciones (1 correcta + 3 incorrectas)
            const wrongCountries = countries
                .filter(c => c.name.common !== currentCountry.name.common)
                .sort(() => Math.random() - 0.5)
                .slice(0, 3);

            const options = [
                currentCountry.name.common,
                wrongCountries[0].name.common,
                wrongCountries[1].name.common,
                wrongCountries[2].name.common
            ].sort(() => Math.random() - 0.5);

            // Asignar opciones a los botones
            document.getElementById('option1').textContent = options[0];
            document.getElementById('option2').textContent = options[1];
            document.getElementById('option3').textContent = options[2];
            document.getElementById('option4').textContent = options[3];

            // Resetear estado
            answered = false;
            jokerUsed = false;
            document.getElementById('message').textContent = '';
            document.getElementById('message').className = 'message';
            document.getElementById('nextBtn').classList.remove('show');

            // Habilitar botones
            [1, 2, 3, 4].forEach(i => {
                const btn = document.getElementById(`option${i}`);
                btn.disabled = false;
                btn.className = 'option';
                btn.style.display = 'block';
            });

            // Actualizar visibilidad del comodín
            updateJokerButton();
            
            // Iniciar temporizador
            startTimer();
        }

        // Actualizar corazones/vidas
        function updateHearts() {
            const heartsEl = document.getElementById('hearts');
            heartsEl.innerHTML = '';
            
            for (let i = 0; i < 3; i++) {
                const heart = document.createElement('span');
                if (i < lives) {
                    heart.textContent = '❤️';
                    heart.className = 'heart-full';
                } else {
                    heart.textContent = '🤍';
                    heart.className = 'heart-empty';
                }
                heartsEl.appendChild(heart);
            }
        }

        // Mostrar pantalla de game over
        function showGameOver() {
            // Detener temporizador
            stopTimer();
            document.getElementById('timerContainer').style.display = 'none';
            
            document.getElementById('finalScore').textContent = score;
            document.getElementById('maxStreak').textContent = maxStreak;
            document.getElementById('gameOver').style.display = 'flex';
            
            // Mostrar botón de guardar puntuación (usará el nombre del usuario autenticado)
            document.getElementById('nameInputContainer').style.display = 'block';
            document.getElementById('saveScoreBtn').disabled = false;
            document.getElementById('saveScoreBtn').textContent = '💾 Guardar Puntuación';
            document.getElementById('rankingContainer').style.display = 'none';
            document.getElementById('showRankingBtn').style.display = 'none';
            
            // Mostrar botón de ranking cuando se pierde
            document.getElementById('viewRankingBtn').style.display = 'block';
        }

        // Guardar puntuación en Firebase
        async function saveScore() {
            const playerName = window.currentUserName || 'Anónimo';
            
            const saveBtn = document.getElementById('saveScoreBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = '💾 Guardando...';
            
            try {
                const success = await window.guardarPuntuacion(playerName, score, difficulty);
                if (success) {
                    saveBtn.textContent = '✅ Guardado';
                    document.getElementById('showRankingBtn').style.display = 'block';
                    // Cargar ranking automáticamente después de guardar
                    setTimeout(() => {
                        loadRanking();
                    }, 500);
                } else {
                    alert('Error al guardar la puntuación. Intenta de nuevo.');
                    saveBtn.disabled = false;
                    saveBtn.textContent = '💾 Guardar Puntuación';
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar la puntuación. Intenta de nuevo.');
                saveBtn.disabled = false;
                saveBtn.textContent = '💾 Guardar Puntuación';
            }
        }

        // Actualizar display del usuario
        function updateUserDisplay() {
            if (window.currentUserName) {
                document.getElementById('userNameDisplay').textContent = `👤 ${window.currentUserName}`;
            }
        }

        // Manejar login
        async function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const messageEl = document.getElementById('loginMessage');
            const loginBtn = document.getElementById('loginBtn');
            
            if (!email || !password) {
                messageEl.textContent = 'Por favor, completa todos los campos';
                messageEl.className = 'auth-message error';
                return;
            }
            
            if (!isValidEmail(email)) {
                messageEl.textContent = 'Por favor, ingresa un email válido (ejemplo: usuario@email.com)';
                messageEl.className = 'auth-message error';
                return;
            }
            
            loginBtn.disabled = true;
            loginBtn.textContent = 'Iniciando sesión...';
            messageEl.textContent = '';
            messageEl.className = 'auth-message';
            
            const result = await window.iniciarSesion(email, password);
            
            if (result.success) {
                messageEl.textContent = '¡Sesión iniciada correctamente!';
                messageEl.className = 'auth-message success';
                // El onAuthStateChanged se encargará de ocultar la pantalla de auth
            } else {
                let errorMsg = 'Error al iniciar sesión';
                if (result.error.includes('user-not-found')) {
                    errorMsg = 'Usuario no encontrado. Verifica el email o regístrate primero.';
                } else if (result.error.includes('wrong-password')) {
                    errorMsg = 'Contraseña incorrecta';
                } else if (result.error.includes('invalid-email')) {
                    errorMsg = 'Email inválido. Usa un formato válido (ejemplo: usuario@email.com)';
                } else if (result.error.includes('operation-not-allowed')) {
                    errorMsg = '⚠️ ERROR: Email/Password no está habilitado en Firebase. Ve a Firebase Console > Authentication > Sign-in method > Email/Password y habilítalo.';
                } else if (result.error.includes('configuration-not-found')) {
                    errorMsg = '⚠️ ERROR: Firebase Authentication no está configurado. Habilita Email/Password en Firebase Console.';
                } else if (result.error.includes('network') || result.error.includes('network-request-failed')) {
                    errorMsg = 'Error de conexión. Verifica tu internet.';
                } else {
                    errorMsg = `Error: ${result.error}`;
                }
                messageEl.textContent = errorMsg;
                messageEl.className = 'auth-message error';
                loginBtn.disabled = false;
                loginBtn.textContent = 'Iniciar Sesión';
            }
        }

        // Validar formato de email
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // Manejar registro
        async function handleRegister() {
            const name = document.getElementById('registerName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            const messageEl = document.getElementById('registerMessage');
            const registerBtn = document.getElementById('registerBtn');
            
            if (!name || !email || !password) {
                messageEl.textContent = 'Por favor, completa todos los campos';
                messageEl.className = 'auth-message error';
                return;
            }
            
            if (name.length < 2) {
                messageEl.textContent = 'El nombre debe tener al menos 2 caracteres';
                messageEl.className = 'auth-message error';
                return;
            }
            
            if (!isValidEmail(email)) {
                messageEl.textContent = 'Por favor, ingresa un email válido (ejemplo: usuario@email.com)';
                messageEl.className = 'auth-message error';
                return;
            }
            
            if (password.length < 6) {
                messageEl.textContent = 'La contraseña debe tener al menos 6 caracteres';
                messageEl.className = 'auth-message error';
                return;
            }
            
            registerBtn.disabled = true;
            registerBtn.textContent = 'Registrando...';
            messageEl.textContent = '';
            messageEl.className = 'auth-message';
            
            const result = await window.registrarUsuario(email, password, name);
            
            if (result.success) {
                messageEl.textContent = '¡Registro exitoso!';
                messageEl.className = 'auth-message success';
                // El onAuthStateChanged se encargará de ocultar la pantalla de auth
            } else {
                let errorMsg = 'Error al registrarse';
                if (result.error.includes('email-already-in-use')) {
                    errorMsg = 'Este email ya está registrado. Usa "Iniciar Sesión" en su lugar.';
                } else if (result.error.includes('invalid-email')) {
                    errorMsg = 'Email inválido. Usa un formato válido (ejemplo: usuario@email.com)';
                } else if (result.error.includes('weak-password')) {
                    errorMsg = 'La contraseña es muy débil (mínimo 6 caracteres)';
                } else if (result.error.includes('operation-not-allowed')) {
                    errorMsg = '⚠️ ERROR: Email/Password no está habilitado en Firebase. Ve a Firebase Console > Authentication > Sign-in method > Email/Password y habilítalo.';
                } else if (result.error.includes('configuration-not-found')) {
                    errorMsg = '⚠️ ERROR: Firebase Authentication no está configurado. Habilita Email/Password en Firebase Console.';
                } else if (result.error.includes('network') || result.error.includes('network-request-failed')) {
                    errorMsg = 'Error de conexión. Verifica tu internet.';
                } else {
                    errorMsg = `Error: ${result.error}`;
                }
                messageEl.textContent = errorMsg;
                messageEl.className = 'auth-message error';
                registerBtn.disabled = false;
                registerBtn.textContent = 'Registrarse';
            }
        }

        // Cambiar entre tabs de login/registro
        function switchAuthTab(tab) {
            const loginTab = document.getElementById('loginTab');
            const registerTab = document.getElementById('registerTab');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            
            if (tab === 'login') {
                loginTab.classList.add('active');
                registerTab.classList.remove('active');
                loginForm.style.display = 'flex';
                registerForm.style.display = 'none';
            } else {
                registerTab.classList.add('active');
                loginTab.classList.remove('active');
                registerForm.style.display = 'flex';
                loginForm.style.display = 'none';
            }
        }

        // Cerrar sesión
        async function handleLogout() {
            // Cerrar modal de perfil si está abierto
            if (window.hideProfileModal) {
                window.hideProfileModal();
            }
            await window.cerrarSesion();
            // El onAuthStateChanged se encargará de mostrar la pantalla de auth
        }

        // Cargar y mostrar ranking (para game over)
        async function loadRanking() {
            const rankingContainer = document.getElementById('rankingContainer');
            const rankingList = document.getElementById('rankingList');
            
            rankingContainer.style.display = 'block';
            rankingList.innerHTML = '<div style="text-align: center; padding: 20px;">Cargando ranking...</div>';
            
            try {
                // Obtener ranking del nivel actual
                const ranking = await window.obtenerRanking(difficulty);
                
                if (ranking.length === 0) {
                    const nivelTexto = difficulty === 'easy' ? 'Fácil' : (difficulty === 'hard' ? 'Difícil' : (difficulty === 'impossible' ? 'Imposible' : ''));
                    rankingList.innerHTML = `<div style="text-align: center; padding: 20px; color: #718096;">No hay puntuaciones aún en nivel ${nivelTexto}</div>`;
                    return;
                }
                
                rankingList.innerHTML = '';
                ranking.forEach((item, index) => {
                    const rankingItem = document.createElement('div');
                    rankingItem.className = 'ranking-item' + (index === 0 ? ' top' : '');
                    
                    const position = document.createElement('div');
                    position.className = 'ranking-position';
                    position.textContent = `#${index + 1}`;
                    
                    const name = document.createElement('div');
                    name.className = 'ranking-name';
                    
                    // Crear contenedor para foto de perfil
                    const profilePicContainer = document.createElement('div');
                    profilePicContainer.className = 'ranking-profile-picture';
                    name.appendChild(profilePicContainer);
                    
                    // Crear span para el nombre
                    const nameText = document.createElement('span');
                    nameText.textContent = item.nombre || 'Anónimo';
                    name.appendChild(nameText);
                    
                    // Cargar foto de perfil si hay userId
                    if (item.userId) {
                        window.loadUserProfilePicture(item.userId, profilePicContainer);
                    } else {
                        // Mostrar placeholder si no hay userId
                        const placeholder = document.createElement('div');
                        placeholder.className = 'placeholder';
                        placeholder.textContent = '👤';
                        profilePicContainer.appendChild(placeholder);
                    }
                    
                    const score = document.createElement('div');
                    score.className = 'ranking-score';
                    score.textContent = item.puntos || 0;
                    
                    rankingItem.appendChild(position);
                    rankingItem.appendChild(name);
                    rankingItem.appendChild(score);
                    rankingList.appendChild(rankingItem);
                });
            } catch (error) {
                console.error('Error al cargar ranking:', error);
                rankingList.innerHTML = '<div style="text-align: center; padding: 20px; color: #f56565;">Error al cargar el ranking</div>';
            }
        }

        // Mostrar ranking principal
        async function showMainRanking() {
            const mainRankingContainer = document.getElementById('mainRankingContainer');
            const rankingTitle = document.getElementById('rankingTitle');
            
            // Actualizar título según el nivel
            if (difficulty === 'easy') {
                rankingTitle.textContent = '🏆 Top 10 Ranking - Fácil';
            } else if (difficulty === 'hard') {
                rankingTitle.textContent = '🏆 Top 10 Ranking - Difícil';
            } else if (difficulty === 'impossible') {
                rankingTitle.textContent = '🏆 Top 10 Ranking - Imposible';
            } else {
                rankingTitle.textContent = '🏆 Top 10 Ranking';
            }
            
            mainRankingContainer.style.display = 'block';
            await loadMainRanking();
        }

        // Ocultar ranking principal
        function hideMainRanking() {
            const mainRankingContainer = document.getElementById('mainRankingContainer');
            mainRankingContainer.style.display = 'none';
        }

        // Cargar y mostrar ranking principal (en la pantalla del juego)
        async function loadMainRanking() {
            const mainRankingList = document.getElementById('mainRankingList');
            
            if (!mainRankingList) {
                console.error('mainRankingList no encontrado');
                return;
            }
            
            mainRankingList.innerHTML = '<div style="text-align: center; padding: 20px; color: #718096;">Cargando ranking...</div>';
            
            try {
                // Obtener ranking del nivel actual
                const ranking = await window.obtenerRanking(difficulty);
                
                if (ranking.length === 0) {
                    const nivelTexto = difficulty === 'easy' ? 'Fácil' : (difficulty === 'hard' ? 'Difícil' : (difficulty === 'impossible' ? 'Imposible' : ''));
                    mainRankingList.innerHTML = `<div style="text-align: center; padding: 20px; color: #718096;">No hay puntuaciones aún en nivel ${nivelTexto}. ¡Sé el primero en jugar!</div>`;
                    return;
                }
                
                mainRankingList.innerHTML = '';
                ranking.forEach((item, index) => {
                    const rankingItem = document.createElement('div');
                    rankingItem.className = 'main-ranking-item' + (index === 0 ? ' top' : '');
                    
                    const position = document.createElement('div');
                    position.className = 'main-ranking-position';
                    position.textContent = `#${index + 1}`;
                    
                    const name = document.createElement('div');
                    name.className = 'main-ranking-name';
                    
                    // Crear contenedor para foto de perfil
                    const profilePicContainer = document.createElement('div');
                    profilePicContainer.className = 'ranking-profile-picture';
                    name.appendChild(profilePicContainer);
                    
                    // Crear span para el nombre
                    const nameText = document.createElement('span');
                    nameText.textContent = item.nombre || 'Anónimo';
                    name.appendChild(nameText);
                    
                    // Cargar foto de perfil si hay userId
                    if (item.userId) {
                        window.loadUserProfilePicture(item.userId, profilePicContainer);
                    } else {
                        // Mostrar placeholder si no hay userId
                        const placeholder = document.createElement('div');
                        placeholder.className = 'placeholder';
                        placeholder.textContent = '👤';
                        profilePicContainer.appendChild(placeholder);
                    }
                    
                    const score = document.createElement('div');
                    score.className = 'main-ranking-score';
                    score.textContent = item.puntos || 0;
                    
                    rankingItem.appendChild(position);
                    rankingItem.appendChild(name);
                    rankingItem.appendChild(score);
                    mainRankingList.appendChild(rankingItem);
                });
            } catch (error) {
                console.error('Error al cargar ranking:', error);
                mainRankingList.innerHTML = '<div style="text-align: center; padding: 20px; color: #f56565;">Error al cargar el ranking</div>';
            }
        }

        // Reiniciar juego
        function restartGame() {
            // Detener temporizador
            stopTimer();
            document.getElementById('timerContainer').style.display = 'none';
            
            score = 0;
            streak = 0;
            maxStreak = 0;
            lives = 3;
            answered = false;
            jokerAvailable = false;
            jokerUsed = false;
            difficulty = null;
            timeLeft = 20;
            
            // Desactivar todos los modos
            document.body.classList.remove('hell-mode', 'war-mode', 'easy-mode');
            
            // Ocultar game over
            document.getElementById('gameOver').style.display = 'none';
            
            // Resetear UI
            document.getElementById('score').textContent = '0';
            document.getElementById('streak').textContent = '0';
            document.getElementById('message').textContent = '';
            document.getElementById('message').className = 'message';
            document.getElementById('nextBtn').classList.remove('show');
            document.getElementById('jokerBtn').style.display = 'none';
            document.getElementById('options').style.display = 'none';
            document.getElementById('loading').style.display = 'none';
            
            // Resetear botones de puntuación
            document.getElementById('saveScoreBtn').disabled = false;
            document.getElementById('saveScoreBtn').textContent = '💾 Guardar Puntuación';
            document.getElementById('nameInputContainer').style.display = 'none';
            document.getElementById('rankingContainer').style.display = 'none';
            document.getElementById('showRankingBtn').style.display = 'none';
            
            // Ocultar botón de ranking al reiniciar
            document.getElementById('viewRankingBtn').style.display = 'none';
            document.getElementById('mainRankingContainer').style.display = 'none';
            
            // Mostrar selector de dificultad
            document.getElementById('difficultySelector').style.display = 'block';
            
            // Actualizar corazones
            updateHearts();
        }

        // Actualizar racha
        function updateStreak(isCorrect) {
            const fireEl = document.getElementById('streakFire');
            
            if (isCorrect) {
                streak++;
                // Actualizar máxima racha
                if (streak > maxStreak) {
                    maxStreak = streak;
                }
                // Hacer el fuego más intenso cuando la racha es alta
                // En modo imposible, se activa con 2 de racha
                const requiredStreak = difficulty === 'impossible' ? 2 : 5;
                if (streak >= requiredStreak) {
                    fireEl.classList.add('hot');
                }
            } else {
                streak = 0;
                jokerAvailable = false;
                jokerUsed = false;
                fireEl.classList.remove('hot');
            }
            
            document.getElementById('streak').textContent = streak;
            updateJokerButton();
        }

        // Frases motivadoras para aciertos
        const successMessages = [
            'Good boooy! 😊🎉',
            '¡Excelente! 😄🌟',
            '¡Perfecto! 😃⭐',
            '¡Increíble! 🤩🚀',
            '¡Genial! 😎💪',
            '¡Fantástico! 😁🎊',
            '¡Bien hecho! 😊👏',
            '¡Así se hace! 😄🔥',
            '¡Eres un crack! 🤩💎',
            '¡Sigue así! 😃🎯',
            '¡Increíble trabajo! 😊✨',
            '¡Lo hiciste genial! 😄🎉',
            '¡Perfecto! 😃👌',
            '¡Eres increíble! 🤩🌟',
            '¡Bien jugado! 😊💪'
        ];

        // Frases motivadoras para fallos
        const errorMessages = [
            '¡Casi! Sigue intentando 😊💪',
            'No te rindas, sigue adelante 😌🌟',
            'La próxima será mejor 😊🎯',
            '¡Sigue practicando! 😄💪',
            'Cada error es aprendizaje 😊📚',
            '¡Tú puedes! Sigue adelante 😃🚀',
            'No pasa nada, sigue jugando 😊',
            'La práctica hace al maestro 😌🎓',
            '¡Sigue intentando! 😊💪',
            'Cada intento te acerca más 😄🎯',
            '¡Ánimo! Lo conseguirás 😊✨',
            'Sigue adelante, tú puedes 😃💪',
            'No te desanimes 😌🌟',
            '¡La próxima vez será mejor! 😊🎯',
            'Sigue intentando, lo lograrás 😄💪'
        ];

        // Crear cohetes animados
        function createRockets() {
            const container = document.body;
            const rocketCount = 15;
            
            for (let i = 0; i < rocketCount; i++) {
                const rocket = document.createElement('div');
                rocket.className = 'rocket';
                rocket.textContent = '🚀';
                rocket.style.position = 'fixed';
                rocket.style.fontSize = '2em';
                rocket.style.pointerEvents = 'none';
                rocket.style.zIndex = '3000';
                
                // Posición inicial aleatoria
                const startX = Math.random() * window.innerWidth;
                const startY = window.innerHeight + 50;
                const endX = startX + (Math.random() - 0.5) * 200;
                const endY = -100;
                
                rocket.style.left = startX + 'px';
                rocket.style.top = startY + 'px';
                
                // Animación
                const angle = Math.atan2(endY - startY, endX - startX) * 180 / Math.PI;
                rocket.style.transform = `rotate(${angle + 90}deg)`;
                
                container.appendChild(rocket);
                
                // Animar cohete
                setTimeout(() => {
                    rocket.style.transition = 'all 2s ease-out';
                    rocket.style.left = endX + 'px';
                    rocket.style.top = endY + 'px';
                    rocket.style.opacity = '0';
                    rocket.style.transform = `rotate(${angle + 90}deg) scale(0.5)`;
                }, 10);
                
                // Remover cohete después de la animación
                setTimeout(() => {
                    if (container.contains(rocket)) {
                        container.removeChild(rocket);
                    }
                }, 2000);
            }
        }

        // Mostrar alerta estilizada
        function showAlert(type, message, details) {
            // Si es acierto, crear cohetes
            if (type === 'success') {
                createRockets();
            }
            
            const overlay = document.createElement('div');
            overlay.className = 'alert-overlay';
            
            const alertBox = document.createElement('div');
            alertBox.className = `alert-box ${type}`;
            
            const icon = document.createElement('div');
            icon.className = 'alert-icon';
            icon.textContent = type === 'success' ? '✅' : '❌';
            
            const messageEl = document.createElement('div');
            messageEl.className = 'alert-message';
            // Usar frase aleatoria
            if (type === 'success') {
                messageEl.textContent = successMessages[Math.floor(Math.random() * successMessages.length)];
            } else {
                messageEl.textContent = errorMessages[Math.floor(Math.random() * errorMessages.length)];
            }
            
            const detailsEl = document.createElement('div');
            detailsEl.className = 'alert-details';
            detailsEl.textContent = details;
            
            alertBox.appendChild(icon);
            alertBox.appendChild(messageEl);
            alertBox.appendChild(detailsEl);
            overlay.appendChild(alertBox);
            
            document.body.appendChild(overlay);
            
            // Remover después de 1.5 segundos
            setTimeout(() => {
                overlay.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => {
                    if (document.body.contains(overlay)) {
                        document.body.removeChild(overlay);
                    }
                }, 300);
            }, 1500);
        }

        // Actualizar botón comodín
        function updateJokerButton() {
            const jokerBtn = document.getElementById('jokerBtn');
            
            // En modo imposible, el comodín se activa con 2 de racha
            // En otros modos, se activa con 5 de racha
            const requiredStreak = difficulty === 'impossible' ? 2 : 5;
            
            if (streak >= requiredStreak && !jokerUsed) {
                jokerAvailable = true;
                if (jokerBtn) {
                    jokerBtn.style.display = 'block';
                }
            } else {
                jokerAvailable = false;
                if (jokerBtn) {
                    jokerBtn.style.display = 'none';
                }
            }
        }

        // Usar comodín
        function useJoker() {
            if (!jokerAvailable || jokerUsed || answered) return;

            jokerUsed = true;
            jokerAvailable = false;
            document.getElementById('jokerBtn').style.display = 'none';

            // Encontrar la respuesta correcta
            const correctAnswer = currentCountry.name.common;
            
            // Obtener todos los botones incorrectos
            const incorrectButtons = [];
            [1, 2, 3, 4].forEach(i => {
                const btn = document.getElementById(`option${i}`);
                if (btn.textContent !== correctAnswer) {
                    incorrectButtons.push(btn);
                }
            });

            // Eliminar 2 opciones incorrectas aleatoriamente
            const toRemove = incorrectButtons
                .sort(() => Math.random() - 0.5)
                .slice(0, 2);

            toRemove.forEach(btn => {
                btn.style.display = 'none';
                btn.disabled = true;
            });

            // Reducir la racha (se usó el comodín)
            // En modo imposible, se reduce en 2. En otros modos, en 5
            const streakReduction = difficulty === 'impossible' ? 2 : 5;
            streak = Math.max(0, streak - streakReduction);
            document.getElementById('streak').textContent = streak;
            
            // Actualizar el fuego
            const fireEl = document.getElementById('streakFire');
            const requiredStreak = difficulty === 'impossible' ? 2 : 5;
            if (streak < requiredStreak) {
                fireEl.classList.remove('hot');
            }
            
            updateJokerButton();
        }

        // Manejar selección de opción
        function selectOption(optionNumber) {
            if (answered) return;

            // Detener temporizador
            stopTimer();

            const selectedBtn = document.getElementById(`option${optionNumber}`);
            const selectedText = selectedBtn.textContent;
            const isCorrect = selectedText === currentCountry.name.common;

            answered = true;

            // Deshabilitar todos los botones
            [1, 2, 3, 4].forEach(i => {
                const btn = document.getElementById(`option${i}`);
                if (btn.style.display !== 'none') {
                    btn.disabled = true;
                    
                    if (btn.textContent === currentCountry.name.common) {
                        btn.classList.add('correct');
                    } else if (btn === selectedBtn && !isCorrect) {
                        btn.classList.add('incorrect');
                    }
                }
            });

            // Actualizar racha
            updateStreak(isCorrect);

            // Mostrar mensaje
            const messageEl = document.getElementById('message');
            if (isCorrect) {
                score++;
                messageEl.textContent = '¡Correcto! 🎉';
                messageEl.className = 'message correct';
                
                // Actualizar puntuación
                document.getElementById('score').textContent = score;
                
                // Mostrar alerta de acierto (con cohetes y frase motivadora)
                showAlert('success', '', '');
                
                // Pasar automáticamente a la siguiente bandera después de 2 segundos
                setTimeout(() => {
                    loadNewQuestion();
                }, 2000);
            } else {
                // Restar una vida
                lives--;
                updateHearts();
                
                messageEl.textContent = `Incorrecto. La respuesta correcta es: ${currentCountry.name.common}`;
                messageEl.className = 'message incorrect';
                
                // Actualizar puntuación
                document.getElementById('score').textContent = score;
                
                // Mostrar alerta de fallo (con frase motivadora)
                showAlert('error', '', `La respuesta correcta era: ${currentCountry.name.common}`);
                
                // Si se acabaron las vidas, mostrar game over
                if (lives <= 0) {
                    setTimeout(() => {
                        showGameOver();
                    }, 2000);
                } else {
                    // Pasar automáticamente a la siguiente bandera después de 2 segundos
                    setTimeout(() => {
                        loadNewQuestion();
                    }, 2000);
                }
            }
        }

        // Event listeners
        document.getElementById('option1').addEventListener('click', () => selectOption(1));
        document.getElementById('option2').addEventListener('click', () => selectOption(2));
        document.getElementById('option3').addEventListener('click', () => selectOption(3));
        document.getElementById('option4').addEventListener('click', () => selectOption(4));
        document.getElementById('jokerBtn').addEventListener('click', useJoker);
        document.getElementById('nextBtn').addEventListener('click', loadNewQuestion);
        
        // Event listeners para selección de dificultad
        document.getElementById('easyBtn').addEventListener('click', () => selectDifficulty('easy'));
        document.getElementById('hardBtn').addEventListener('click', () => selectDifficulty('hard'));
        document.getElementById('impossibleBtn').addEventListener('click', () => selectDifficulty('impossible'));
        document.getElementById('restartBtn').addEventListener('click', restartGame);
        document.getElementById('saveScoreBtn').addEventListener('click', saveScore);
        document.getElementById('showRankingBtn').addEventListener('click', loadRanking);
        document.getElementById('logoutBtn').addEventListener('click', handleLogout);
        const profileLogoutBtn = document.getElementById('profileLogoutBtn');
        if (profileLogoutBtn) {
            profileLogoutBtn.addEventListener('click', async () => {
                // Cerrar modal primero
                if (window.hideProfileModal) {
                    window.hideProfileModal();
                }
                // Luego cerrar sesión
                await handleLogout();
            });
        }
        document.getElementById('viewRankingBtn').addEventListener('click', showMainRanking);
        document.getElementById('closeRankingBtn').addEventListener('click', hideMainRanking);
        
        // Event listeners para autenticación
        document.getElementById('loginTab').addEventListener('click', () => switchAuthTab('login'));
        document.getElementById('registerTab').addEventListener('click', () => switchAuthTab('register'));
        document.getElementById('loginBtn').addEventListener('click', handleLogin);
        document.getElementById('registerBtn').addEventListener('click', handleRegister);
        
        // Permitir login/registro con Enter
        document.getElementById('loginEmail').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleLogin();
        });
        document.getElementById('loginPassword').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleLogin();
        });
        document.getElementById('registerName').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleRegister();
        });
        document.getElementById('registerEmail').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleRegister();
        });
        document.getElementById('registerPassword').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleRegister();
        });
        
        // Event listeners para foto de perfil
        const profilePictureCircle = document.getElementById('profilePictureCircle');
        const profileModalClose = document.getElementById('profileModalClose');
        const profilePictureInput = document.getElementById('profilePictureInput');
        const profileModal = document.getElementById('profileModal');
        
        if (profilePictureCircle) {
            profilePictureCircle.addEventListener('click', () => {
                if (window.showProfileModal) {
                    window.showProfileModal();
                }
            });
        }
        
        if (profileModalClose) {
            profileModalClose.addEventListener('click', () => {
                if (window.hideProfileModal) {
                    window.hideProfileModal();
                }
            });
        }
        
        // Cerrar modal al hacer clic fuera
        if (profileModal) {
            profileModal.addEventListener('click', (e) => {
                if (e.target === profileModal) {
                    if (window.hideProfileModal) {
                        window.hideProfileModal();
                    }
                }
            });
        }
        
        // Manejar subida de foto
        if (profilePictureInput) {
            profilePictureInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const saveBtn = document.getElementById('profileSaveBtn');
                    if (saveBtn) {
                        saveBtn.style.display = 'block';
                        saveBtn.textContent = '💾 Guardando...';
                        saveBtn.disabled = true;
                    }
                    
                    // Mostrar preview antes de subir
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const largeImg = document.getElementById('profilePictureLargeImg');
                        const largePlaceholder = document.getElementById('profilePictureLargePlaceholder');
                        if (largeImg) {
                            largeImg.src = event.target.result;
                            largeImg.style.display = 'block';
                            if (largePlaceholder) largePlaceholder.style.display = 'none';
                        }
                    };
                    reader.readAsDataURL(file);
                    
                    // Subir foto
                    const success = await window.uploadProfilePicture(file);
                    
                    if (saveBtn) {
                        if (success) {
                            saveBtn.textContent = '✅ Guardado';
                            setTimeout(() => {
                                saveBtn.style.display = 'none';
                            }, 2000);
                        } else {
                            saveBtn.textContent = '❌ Error';
                            saveBtn.disabled = false;
                        }
                    }
                    
                    // Limpiar input
                    e.target.value = '';
                }
            });
        }
        
        // Hacer funciones disponibles globalmente
        window.updateUserDisplay = updateUserDisplay;
        window.loadMainRanking = loadMainRanking;

        // Verificar y redirigir si es necesario (para PWA)
        if (window.location.pathname === '/' && !window.location.href.includes('Juego_Banderas')) {
            window.location.href = 'https://martinpenalva.github.io/Juego_Banderas/index.html';
        }

        // Inicializar corazones
        updateHearts();

        // No iniciar automáticamente - esperar a que el usuario seleccione dificultad
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs, doc, setDoc, getDoc, where, updateDoc } 
            from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } 
            from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } 
            from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // Configuración de tu proyecto
        const firebaseConfig = {
            apiKey: "AIzaSyDyf2mRx0S1CBOH7u4N8kINoH6Bxe_ItZo",
            authDomain: "banderas-f31cf.firebaseapp.com",
            projectId: "banderas-f31cf",
            storageBucket: "banderas-f31cf.firebasestorage.app",
            messagingSenderId: "413939026360",
            appId: "1:413939026360:web:b6e8b65c1f86cc9cf2274d",
            measurementId: "G-H2LGX84Z2Z"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);

        // Variable global para el usuario actual
        window.currentUser = null;
        window.currentUserName = null;

        // ----------- AUTENTICACIÓN -------------
        window.registrarUsuario = async function(email, password, nombre) {
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // Guardar nombre de usuario en Firestore
                await setDoc(doc(db, "usuarios", user.uid), {
                    nombre: nombre,
                    email: email,
                    fechaRegistro: Date.now()
                });
                
                window.currentUser = user;
                window.currentUserName = nombre;
                return { success: true, user: user };
            } catch (error) {
                console.error("Error al registrar: ", error);
                return { success: false, error: error.message };
            }
        };

        window.iniciarSesion = async function(email, password) {
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // Obtener nombre de usuario desde Firestore
                const userDoc = await getDoc(doc(db, "usuarios", user.uid));
                if (userDoc.exists()) {
                    window.currentUserName = userDoc.data().nombre;
                } else {
                    window.currentUserName = user.email.split('@')[0];
                }
                
                window.currentUser = user;
                return { success: true, user: user };
            } catch (error) {
                console.error("Error al iniciar sesión: ", error);
                return { success: false, error: error.message };
            }
        };

        window.cerrarSesion = async function() {
            try {
                await signOut(auth);
                window.currentUser = null;
                window.currentUserName = null;
                return true;
            } catch (error) {
                console.error("Error al cerrar sesión: ", error);
                return false;
            }
        };

        // Observar cambios en el estado de autenticación
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                window.currentUser = user;
                // Obtener nombre de usuario
                try {
                    const userDoc = await getDoc(doc(db, "usuarios", user.uid));
                    if (userDoc.exists()) {
                        window.currentUserName = userDoc.data().nombre;
                    } else {
                        window.currentUserName = user.email.split('@')[0];
                    }
                } catch (e) {
                    window.currentUserName = user.email.split('@')[0];
                }
                
                // Ocultar pantalla de autenticación y mostrar juego
                document.getElementById('authContainer').style.display = 'none';
                document.getElementById('gameContainer').style.display = 'block';
                document.getElementById('profilePictureContainer').style.display = 'block';
                if (window.updateUserDisplay) {
                    window.updateUserDisplay();
                }
                
                // Cargar foto de perfil
                loadProfilePicture();
                
                // No cargar ranking automáticamente - el usuario debe hacer clic en el botón "Ver Tabla"
            } else {
                window.currentUser = null;
                window.currentUserName = null;
                // Mostrar pantalla de autenticación y ocultar juego
                document.getElementById('authContainer').style.display = 'flex';
                document.getElementById('gameContainer').style.display = 'none';
                document.getElementById('profilePictureContainer').style.display = 'none';
                // Limpiar foto de perfil
                clearProfilePicture();
            }
        });

        // ----------- FOTO DE PERFIL -------------
        // Cargar foto de perfil desde Storage
        window.loadProfilePicture = async function() {
            if (!window.currentUser) return;
            
            try {
                // Verificar si estamos en un entorno válido (no file://)
                if (window.location.protocol === 'file:') {
                    console.warn('⚠️ Firebase Storage no funciona con file://. Usa un servidor web (GitHub Pages, servidor local, etc.)');
                    clearProfilePicture();
                    return;
                }
                
                const profilePicRef = ref(storage, `profilePictures/${window.currentUser.uid}`);
                const url = await getDownloadURL(profilePicRef);
                
                // Actualizar círculo pequeño
                const smallImg = document.getElementById('profilePictureImg');
                const smallPlaceholder = document.getElementById('profilePicturePlaceholder');
                if (smallImg) {
                    smallImg.src = url;
                    smallImg.style.display = 'block';
                    if (smallPlaceholder) smallPlaceholder.style.display = 'none';
                }
                
                // Actualizar círculo grande en el modal
                const largeImg = document.getElementById('profilePictureLargeImg');
                const largePlaceholder = document.getElementById('profilePictureLargePlaceholder');
                if (largeImg) {
                    largeImg.src = url;
                    largeImg.style.display = 'block';
                    if (largePlaceholder) largePlaceholder.style.display = 'none';
                }
            } catch (error) {
                // Verificar si es un error de archivo no encontrado (404) o CORS
                const errorCode = error.code || error.message || '';
                
                if (errorCode.includes('storage/object-not-found') || 
                    errorCode.includes('404') || 
                    error.message.includes('object-not-found')) {
                    // Archivo no existe, mostrar placeholder (no es un error)
                    clearProfilePicture();
                } else if (errorCode.includes('CORS') || 
                          error.message.includes('CORS') ||
                          window.location.protocol === 'file:') {
                    // Error de CORS - probablemente abriendo desde file://
                    console.warn('⚠️ Error de CORS. Asegúrate de servir el archivo desde un servidor web (no file://)');
                    clearProfilePicture();
                } else {
                    // Otro error
                    console.log('No se pudo cargar la foto de perfil:', error.message);
                    clearProfilePicture();
                }
            }
        };

        // Cargar foto de perfil de un usuario específico (para ranking)
        window.loadUserProfilePicture = async function(userId, containerElement) {
            if (!userId || !containerElement) return;
            
            try {
                // Verificar si estamos en un entorno válido (no file://)
                if (window.location.protocol === 'file:') {
                    // Mostrar placeholder si es file://
                    const placeholder = document.createElement('div');
                    placeholder.className = 'placeholder';
                    placeholder.textContent = '👤';
                    containerElement.innerHTML = '';
                    containerElement.appendChild(placeholder);
                    return;
                }
                
                const profilePicRef = ref(storage, `profilePictures/${userId}`);
                const url = await getDownloadURL(profilePicRef);
                
                const img = document.createElement('img');
                img.src = url;
                img.alt = 'Foto de perfil';
                containerElement.innerHTML = '';
                containerElement.appendChild(img);
            } catch (error) {
                // Si no hay foto o hay error, mostrar placeholder
                const errorCode = error.code || error.message || '';
                if (!errorCode.includes('object-not-found') && 
                    !errorCode.includes('404') && 
                    !error.message.includes('object-not-found')) {
                    // Solo loguear si no es un error de "no encontrado"
                    console.log(`No se pudo cargar foto de perfil para usuario ${userId}:`, error.message);
                }
                
                const placeholder = document.createElement('div');
                placeholder.className = 'placeholder';
                placeholder.textContent = '👤';
                containerElement.innerHTML = '';
                containerElement.appendChild(placeholder);
            }
        };

        // Limpiar foto de perfil (mostrar placeholder)
        function clearProfilePicture() {
            const smallImg = document.getElementById('profilePictureImg');
            const smallPlaceholder = document.getElementById('profilePicturePlaceholder');
            if (smallImg) {
                smallImg.src = '';
                smallImg.style.display = 'none';
            }
            if (smallPlaceholder) smallPlaceholder.style.display = 'block';
            
            const largeImg = document.getElementById('profilePictureLargeImg');
            const largePlaceholder = document.getElementById('profilePictureLargePlaceholder');
            if (largeImg) {
                largeImg.src = '';
                largeImg.style.display = 'none';
            }
            if (largePlaceholder) largePlaceholder.style.display = 'block';
        }

        // Subir foto de perfil
        window.uploadProfilePicture = async function(file) {
            if (!window.currentUser || !file) return false;
            
            try {
                // Verificar si estamos en un entorno válido (no file://)
                if (window.location.protocol === 'file:') {
                    alert('⚠️ Firebase Storage no funciona con file://. Por favor, usa un servidor web (GitHub Pages, servidor local, etc.) para subir fotos.');
                    return false;
                }
                
                // Validar que sea una imagen
                if (!file.type.startsWith('image/')) {
                    alert('Por favor, selecciona un archivo de imagen');
                    return false;
                }
                
                // Validar tamaño (máximo 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('La imagen es demasiado grande. Máximo 5MB');
                    return false;
                }
                
                const profilePicRef = ref(storage, `profilePictures/${window.currentUser.uid}`);
                await uploadBytes(profilePicRef, file);
                
                // Obtener URL de descarga
                const url = await getDownloadURL(profilePicRef);
                
                // Actualizar círculo pequeño
                const smallImg = document.getElementById('profilePictureImg');
                const smallPlaceholder = document.getElementById('profilePicturePlaceholder');
                if (smallImg) {
                    smallImg.src = url;
                    smallImg.style.display = 'block';
                    if (smallPlaceholder) smallPlaceholder.style.display = 'none';
                }
                
                // Actualizar círculo grande en el modal
                const largeImg = document.getElementById('profilePictureLargeImg');
                const largePlaceholder = document.getElementById('profilePictureLargePlaceholder');
                if (largeImg) {
                    largeImg.src = url;
                    largeImg.style.display = 'block';
                    if (largePlaceholder) largePlaceholder.style.display = 'none';
                }
                
                return true;
            } catch (error) {
                console.error('Error al subir foto de perfil:', error);
                
                // Verificar tipo de error
                const errorCode = error.code || error.message || '';
                let errorMessage = 'Error al subir la foto. Intenta de nuevo.';
                
                if (errorCode.includes('CORS') || error.message.includes('CORS')) {
                    errorMessage = '⚠️ Error de CORS. Asegúrate de servir el archivo desde un servidor web (no file://).';
                } else if (errorCode.includes('unauthorized') || errorCode.includes('permission')) {
                    errorMessage = '⚠️ Error de permisos. Verifica las reglas de Firebase Storage.';
                } else if (errorCode.includes('quota') || errorCode.includes('storage/quota-exceeded')) {
                    errorMessage = '⚠️ Se ha excedido la cuota de almacenamiento.';
                }
                
                alert(errorMessage);
                return false;
            }
        };

        // Mostrar modal de perfil
        window.showProfileModal = function() {
            if (!window.currentUser) return;
            
            const modal = document.getElementById('profileModal');
            const profileName = document.getElementById('profileName');
            const profileEmail = document.getElementById('profileEmail');
            
            if (modal && profileName && profileEmail) {
                profileName.textContent = window.currentUserName || '-';
                profileEmail.textContent = window.currentUser.email || '-';
                modal.style.display = 'flex';
            }
        };

        // Ocultar modal de perfil
        window.hideProfileModal = function() {
            const modal = document.getElementById('profileModal');
            const saveBtn = document.getElementById('profileSaveBtn');
            if (modal) {
                modal.style.display = 'none';
            }
            if (saveBtn) {
                saveBtn.style.display = 'none';
            }
        };

        // ----------- GUARDAR PUNTUACIÓN -------------
        window.guardarPuntuacion = async function(nombre, puntos, nivel) {
            try {
                const userId = window.currentUser ? window.currentUser.uid : null;
                const nivelActual = nivel || 'unknown';
                
                // Si hay un usuario autenticado, buscar si ya tiene una puntuación en este nivel
                if (userId) {
                    // Obtener todas las puntuaciones del usuario para este nivel
                    const q = query(
                        collection(db, "puntuaciones"),
                        where("userId", "==", userId)
                    );
                    
                    const snapshot = await getDocs(q);
                    
                    // Buscar si ya existe una puntuación para este nivel
                    let existingDoc = null;
                    let existingData = null;
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.nivel === nivelActual) {
                            existingDoc = doc;
                            existingData = data;
                        }
                    });
                    
                    if (existingDoc && existingData) {
                        // El usuario ya tiene una puntuación en este nivel
                        // Solo actualizar si la nueva puntuación es mejor
                        if (puntos > existingData.puntos) {
                            await updateDoc(existingDoc.ref, {
                                nombre: nombre,
                                puntos: puntos,
                                fecha: Date.now()
                            });
                            console.log("✔ Puntuación actualizada (mejor puntuación)");
                            return true;
                        } else {
                            console.log("ℹ Puntuación no actualizada (la anterior era mejor)");
                            return true; // No es un error, simplemente no se actualiza
                        }
                    }
                }
                
                // Si no hay puntuación existente o no hay usuario, crear una nueva
                await addDoc(collection(db, "puntuaciones"), {
                    nombre: nombre,
                    puntos: puntos,
                    nivel: nivelActual,
                    fecha: Date.now(),
                    userId: userId
                });
                console.log("✔ Puntuación guardada");
                return true;
            } catch (e) {
                console.error("Error al guardar puntuación: ", e);
                return false;
            }
        };

        // ----------- OBTENER RANKING ----------------
        window.obtenerRanking = async function(nivel) {
            try {
                let q;
                
                if (nivel) {
                    // Obtener todas las puntuaciones y filtrar por nivel en JavaScript
                    // Esto evita el problema del índice compuesto
                    q = query(
                        collection(db, "puntuaciones"),
                        orderBy("puntos", "desc")
                    );
                } else {
                    // Sin filtro (todos los niveles)
                    q = query(
                        collection(db, "puntuaciones"),
                        orderBy("puntos", "desc"),
                        limit(10)
                    );
                }

                const snapshot = await getDocs(q);
                const resultados = [];

                // Verificar cada puntuación para ver si el usuario aún existe
                for (const docSnapshot of snapshot.docs) {
                    const data = docSnapshot.data();
                    
                    // Si se especificó un nivel, filtrar por ese nivel
                    if (nivel && data.nivel !== nivel) {
                        continue;
                    }
                    
                    // Si tiene userId, verificar si el usuario aún existe
                    if (data.userId) {
                        try {
                            // Verificar si el usuario existe en la colección de usuarios
                            const userDoc = await getDoc(doc(db, "usuarios", data.userId));
                            if (!userDoc.exists()) {
                                // El usuario no existe en la colección, omitir esta puntuación
                                console.log(`Usuario ${data.userId} no existe en usuarios, omitiendo puntuación`);
                                continue;
                            }
                            
                            // Verificar también que el documento tenga un nombre válido
                            const userData = userDoc.data();
                            if (!userData || !userData.nombre) {
                                // El documento existe pero no tiene datos válidos, omitir
                                console.log(`Usuario ${data.userId} no tiene datos válidos, omitiendo puntuación`);
                                continue;
                            }
                            
                            // Verificar que el nombre en la puntuación coincida EXACTAMENTE con el nombre del usuario
                            // Si no coincide, puede ser que el usuario fue eliminado y recreado, o que hay una inconsistencia
                            if (data.nombre && userData.nombre) {
                                if (data.nombre.trim() !== userData.nombre.trim()) {
                                    // Los nombres no coinciden exactamente, omitir esta puntuación
                                    console.log(`Nombre no coincide para usuario ${data.userId}: "${data.nombre}" vs "${userData.nombre}", omitiendo puntuación`);
                                    continue;
                                }
                            } else if (data.nombre && !userData.nombre) {
                                // La puntuación tiene nombre pero el usuario no, omitir
                                console.log(`Usuario ${data.userId} no tiene nombre en su documento, omitiendo puntuación`);
                                continue;
                            }
                            
                            // Verificar que el documento no esté marcado como eliminado (si agregamos ese campo en el futuro)
                            if (userData.eliminado === true) {
                                console.log(`Usuario ${data.userId} está marcado como eliminado, omitiendo puntuación`);
                                continue;
                            }
                            
                            // Si el usuario existe y tiene datos válidos, agregar al ranking
                            resultados.push(data);
                        } catch (error) {
                            // Si hay error al verificar, omitir esta puntuación por seguridad
                            console.log(`Error al verificar usuario ${data.userId}:`, error);
                            continue;
                        }
                    } else {
                        // Si no tiene userId (puntuación anónima), incluirla
                        resultados.push(data);
                    }
                }
                
                // Ordenar por puntos (por si acaso) y limitar a 10
                resultados.sort((a, b) => (b.puntos || 0) - (a.puntos || 0));
                return resultados.slice(0, 10);
            } catch (e) {
                console.error("Error al obtener ranking: ", e);
                return [];
            }
        };
    </script>
</body>
</html>

