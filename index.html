<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juego de Adivinar Banderas</title>
    
    <!-- Favicon y iconos móviles -->
    <link rel="icon" type="image/jpeg" href="https://martinpenalva.github.io/Juego_Banderas/OIG1.jpg">
    <link rel="apple-touch-icon" href="https://martinpenalva.github.io/Juego_Banderas/OIG1.jpg">
    <link rel="manifest" href="https://martinpenalva.github.io/Juego_Banderas/manifest.json">
    
    <!-- Meta tags para PWA -->
    <meta name="theme-color" content="#764ba2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Banderas">
    <meta name="description" content="Juego interactivo de adivinar banderas de países con sistema de racha y comodines">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-size: 400% 400%;
            animation: fullWindowBackgroundMove 20s ease infinite;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        /* Fondo animado siempre activo en la ventana de selección */
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: 
                radial-gradient(circle at 30% 40%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 70% 60%, rgba(255, 255, 255, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 50% 80%, rgba(255, 255, 255, 0.06) 0%, transparent 50%);
            animation: fullWindowRadialMove 25s ease-in-out infinite;
            z-index: 0;
            pointer-events: none;
        }

        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.05) 50%, transparent 70%);
            animation: fullWindowShine 10s linear infinite;
            z-index: 0;
            pointer-events: none;
        }

        /* Sobrescribir cuando hay modos de juego activos */
        body.hell-mode,
        body.war-mode,
        body.easy-mode,
        body.god-mode {
            background-size: 100% 100%;
            animation: none;
        }

        body.hell-mode::before,
        body.war-mode::before,
        body.easy-mode::before,
        body.god-mode::before,
        body.hell-mode::after,
        body.war-mode::after,
        body.easy-mode::after,
        body.god-mode::after {
            display: none;
        }

        @keyframes fullWindowBackgroundMove {
            0%, 100% {
                background-position: 0% 50%;
            }
            25% {
                background-position: 100% 50%;
            }
            50% {
                background-position: 100% 100%;
            }
            75% {
                background-position: 0% 100%;
            }
        }

        @keyframes fullWindowRadialMove {
            0%, 100% {
                transform: translate(0, 0) rotate(0deg) scale(1);
            }
            33% {
                transform: translate(50px, -50px) rotate(120deg) scale(1.2);
            }
            66% {
                transform: translate(-50px, 50px) rotate(240deg) scale(0.8);
            }
        }

        @keyframes fullWindowShine {
            0% {
                transform: translateX(-100%) translateY(-100%) rotate(45deg);
            }
            100% {
                transform: translateX(200%) translateY(200%) rotate(45deg);
            }
        }

        body.hell-mode {
            background: linear-gradient(180deg, #1a0000 0%, #4a0000 30%, #8b0000 60%, #ff4500 100%);
            background-size: 100% 100%;
            animation: none;
            /* Desactivar animación de parpadeo para mejor rendimiento */
            /* animation: hellFlicker 0.5s ease-in-out infinite alternate; */
        }

        body.hell-mode::before,
        body.hell-mode::after {
            display: none;
        }

        body.war-mode {
            background: linear-gradient(180deg, #1a1a1a 0%, #2d1b1b 25%, #3d2525 50%, #4a2a2a 75%, #5a3535 100%);
            background-size: 100% 100%;
            animation: warFlicker 0.5s ease-in-out infinite alternate;
            position: relative;
            overflow-x: hidden;
        }

        body.war-mode::before,
        body.war-mode::after {
            display: none;
        }

        @keyframes warFlicker {
            0% {
                filter: brightness(0.9) contrast(1.1);
            }
            100% {
                filter: brightness(1) contrast(1.2);
            }
        }

        body.easy-mode {
            background: linear-gradient(135deg, #2d5016 0%, #4a7c2a 30%, #6ba84f 60%, #8bc34a 100%);
            position: relative;
            overflow-x: hidden;
        }

        body.god-mode {
            background: linear-gradient(135deg, #0f0c29 0%, #1a0d3a 20%, #2d1b69 40%, #4c1d95 60%, #6366f1 80%, #8b5cf6 100%);
            background-size: 400% 400%;
            animation: galacticBackground 15s ease infinite;
            position: relative;
            overflow-x: hidden;
        }

        body.god-mode::before,
        body.god-mode::after {
            display: none;
        }

        @keyframes galacticBackground {
            0%, 100% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
        }

        /* Overlay para modo galáctico */
        .galactic-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        body.god-mode .galactic-overlay {
            opacity: 1;
        }

        /* Estrellas galácticas */
        .galactic-star {
            position: absolute;
            width: 3px;
            height: 3px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 6px rgba(255, 255, 255, 0.8),
                        0 0 12px rgba(167, 139, 250, 0.6),
                        0 0 18px rgba(139, 92, 246, 0.4);
            animation: starTwinkleGalactic 3s ease-in-out infinite;
        }

        .galactic-star.large {
            width: 5px;
            height: 5px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 1),
                        0 0 20px rgba(167, 139, 250, 0.8),
                        0 0 30px rgba(139, 92, 246, 0.6);
        }

        @keyframes starTwinkleGalactic {
            0%, 100% {
                opacity: 0.3;
                transform: scale(1);
            }
            50% {
                opacity: 1;
                transform: scale(1.5);
            }
        }

        /* Nebulosa galáctica */
        .galactic-nebula {
            position: absolute;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, 
                rgba(139, 92, 246, 0.3) 0%, 
                rgba(167, 139, 250, 0.2) 30%,
                rgba(99, 102, 241, 0.1) 60%,
                transparent 100%);
            border-radius: 50%;
            filter: blur(40px);
            animation: nebulaFloat 20s ease-in-out infinite;
        }

        @keyframes nebulaFloat {
            0%, 100% {
                transform: translate(0, 0) scale(1);
                opacity: 0.5;
            }
            33% {
                transform: translate(100px, -50px) scale(1.2);
                opacity: 0.7;
            }
            66% {
                transform: translate(-50px, 100px) scale(0.8);
                opacity: 0.6;
            }
        }

        /* Efectos en el contenedor cuando está en modo galáctico */
        body.god-mode .container {
            background: linear-gradient(135deg, rgba(30, 27, 75, 0.95) 0%, rgba(49, 46, 129, 0.95) 50%, rgba(76, 29, 149, 0.95) 100%);
            box-shadow: 0 20px 60px rgba(99, 102, 241, 0.5), 
                        0 0 50px rgba(139, 92, 246, 0.4),
                        inset 0 0 30px rgba(167, 139, 250, 0.2);
            border: 2px solid rgba(167, 139, 250, 0.5);
        }

        body.god-mode .container h1,
        body.god-mode .container .score,
        body.god-mode .container .streak-text,
        body.god-mode .container .lives-text {
            color: #e9d5ff;
            text-shadow: 0 0 10px rgba(167, 139, 250, 0.8), 
                         0 0 20px rgba(139, 92, 246, 0.6),
                         0 2px 4px rgba(0, 0, 0, 0.5);
        }

        body.god-mode .container .score {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a78bfa 100%);
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.6),
                        inset 0 0 15px rgba(167, 139, 250, 0.3);
        }

        body.god-mode .container .streak-text {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a78bfa 100%);
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.6),
                        inset 0 0 15px rgba(167, 139, 250, 0.3);
        }

        /* Overlay para modo guerra */
        .war-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        body.war-mode .war-overlay {
            opacity: 1;
        }

        /* Overlay para modo fácil */
        .nature-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        body.easy-mode .nature-overlay {
            opacity: 1;
        }

        /* Elementos de batalla */
        .smoke {
            position: absolute;
            width: 120px;
            height: 120px;
            background: radial-gradient(circle, rgba(50, 50, 50, 0.8) 0%, rgba(30, 30, 30, 0.5) 50%, transparent 70%);
            border-radius: 50%;
            animation: smokeRise 8s ease-out infinite;
            filter: blur(5px);
        }

        .explosion {
            position: absolute;
            width: 80px;
            height: 80px;
            background: radial-gradient(circle, rgba(255, 50, 50, 1) 0%, rgba(255, 100, 0, 0.8) 30%, rgba(200, 0, 0, 0.4) 60%, transparent 100%);
            border-radius: 50%;
            animation: explosionFlash 1.5s ease-out infinite;
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.8);
        }

        .bullet {
            position: absolute;
            width: 5px;
            height: 5px;
            background: #ff3333;
            border-radius: 50%;
            box-shadow: 0 0 15px #ff0000, 0 0 25px #ff3333;
            animation: bulletFly 3s linear infinite;
        }

        /* Elementos de naturaleza */
        .leaf {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #4a7c2a;
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            animation: leafFall 8s ease-in-out infinite;
        }

        .bird {
            position: absolute;
            font-size: 1.5em;
            animation: birdFly 15s linear infinite;
        }

        .wave {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 80px;
            background: linear-gradient(to top, 
                rgba(64, 150, 200, 0.4) 0%,
                rgba(64, 150, 200, 0.2) 50%,
                transparent 100%
            );
            animation: waveMove 3s ease-in-out infinite;
            clip-path: polygon(
                0% 100%,
                10% 80%,
                20% 90%,
                30% 70%,
                40% 85%,
                50% 75%,
                60% 90%,
                70% 70%,
                80% 85%,
                90% 75%,
                100% 100%
            );
        }

        .breeze {
            position: absolute;
            width: 2px;
            height: 30px;
            background: rgba(255, 255, 255, 0.3);
            animation: breezeMove 4s ease-in-out infinite;
        }

        @keyframes smokeRise {
            0% {
                transform: translateY(100vh) translateX(0) scale(0.5);
                opacity: 0.8;
            }
            50% {
                opacity: 0.6;
            }
            100% {
                transform: translateY(-100px) translateX(100px) scale(2);
                opacity: 0;
            }
        }

        @keyframes explosionFlash {
            0%, 100% {
                transform: scale(1);
                opacity: 0.8;
            }
            50% {
                transform: scale(1.5);
                opacity: 1;
            }
        }

        @keyframes bulletFly {
            0% {
                transform: translate(0, 100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translate(200px, -100px) rotate(360deg);
                opacity: 0;
            }
        }

        @keyframes leafFall {
            0% {
                transform: translateY(-100px) translateX(0) rotate(0deg);
                opacity: 1;
            }
            50% {
                transform: translateY(50vh) translateX(100px) rotate(180deg);
            }
            100% {
                transform: translateY(100vh) translateX(200px) rotate(360deg);
                opacity: 0;
            }
        }

        @keyframes birdFly {
            0% {
                transform: translateX(-100px) translateY(0);
            }
            50% {
                transform: translateX(50vw) translateY(-50px);
            }
            100% {
                transform: translateX(calc(100vw + 100px)) translateY(0);
            }
        }

        @keyframes waveMove {
            0%, 100% {
                transform: translateX(0);
            }
            50% {
                transform: translateX(-20px);
            }
        }

        @keyframes breezeMove {
            0% {
                transform: translateX(0) translateY(0) rotate(0deg);
                opacity: 0.3;
            }
            25% {
                transform: translateX(20px) translateY(-10px) rotate(5deg);
                opacity: 0.5;
            }
            50% {
                transform: translateX(40px) translateY(-20px) rotate(0deg);
                opacity: 0.3;
            }
            75% {
                transform: translateX(60px) translateY(-10px) rotate(-5deg);
                opacity: 0.5;
            }
            100% {
                transform: translateX(80px) translateY(0) rotate(0deg);
                opacity: 0.3;
            }
        }

        /* Overlay de fuego para modo imposible */
        .hell-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        body.hell-mode .hell-overlay {
            opacity: 1;
        }

        .flame {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 200px;
            background: linear-gradient(to top, 
                rgba(255, 69, 0, 0.8) 0%,
                rgba(255, 140, 0, 0.6) 30%,
                rgba(255, 200, 0, 0.4) 60%,
                transparent 100%
            );
            /* Animación más lenta para mejor rendimiento */
            animation: flameFlicker 1.5s ease-in-out infinite alternate;
            clip-path: polygon(
                0% 100%,
                5% 80%,
                10% 90%,
                15% 70%,
                20% 85%,
                25% 75%,
                30% 90%,
                35% 65%,
                40% 80%,
                45% 70%,
                50% 85%,
                55% 75%,
                60% 90%,
                65% 70%,
                70% 85%,
                75% 75%,
                80% 90%,
                85% 70%,
                90% 85%,
                95% 75%,
                100% 100%
            );
            will-change: transform, filter;
            transform: translateZ(0); /* Aceleración por hardware */
        }

        .flame:nth-child(1) {
            left: 0;
            animation-delay: 0s;
        }

        .flame:nth-child(2) {
            left: 25%;
            animation-delay: 0.2s;
            height: 180px;
        }

        .flame:nth-child(3) {
            left: 50%;
            animation-delay: 0.4s;
            height: 220px;
        }

        .flame:nth-child(4) {
            left: 75%;
            animation-delay: 0.1s;
            height: 190px;
        }

        .flame:nth-child(5) {
            right: 0;
            animation-delay: 0.3s;
            height: 200px;
        }

        .hell-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
        }

        .hell-particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #ff4500;
            border-radius: 50%;
            box-shadow: 0 0 10px #ff4500, 0 0 20px #ff4500;
            animation: particleFloat 3s ease-in-out infinite;
            will-change: transform, opacity;
            transform: translateZ(0); /* Aceleración por hardware */
        }

        /* Mini llamas que salpican */
        .spark {
            position: absolute;
            bottom: 0;
            width: 8px;
            height: 8px;
            background: radial-gradient(circle, #ff6b00 0%, #ff4500 50%, transparent 100%);
            border-radius: 50% 50% 50% 0;
            box-shadow: 0 0 15px #ff4500, 0 0 25px #ff6b00;
            animation: sparkFly 1.5s ease-out forwards;
            pointer-events: none;
            will-change: transform, opacity;
            transform: translateZ(0); /* Aceleración por hardware */
        }

        @keyframes sparkFly {
            0% {
                transform: translateY(0) translateX(0) scale(1) rotate(0deg);
                opacity: 1;
            }
            50% {
                opacity: 0.8;
            }
            100% {
                transform: translateY(-200px) translateX(var(--spark-x, 50px)) scale(0.3) rotate(360deg);
                opacity: 0;
            }
        }

        @keyframes hellFlicker {
            0% {
                filter: brightness(1) contrast(1);
            }
            50% {
                filter: brightness(1.1) contrast(1.1);
            }
            100% {
                filter: brightness(0.95) contrast(1.05);
            }
        }

        @keyframes flameFlicker {
            0% {
                transform: scaleY(1) scaleX(1);
                opacity: 0.8;
            }
            50% {
                transform: scaleY(1.1) scaleX(1.05);
                opacity: 1;
            }
            100% {
                transform: scaleY(0.9) scaleX(0.95);
                opacity: 0.7;
            }
        }

        @keyframes particleFloat {
            0% {
                transform: translateY(100vh) translateX(0) scale(0);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) translateX(50px) scale(1);
                opacity: 0;
            }
        }

        /* Efectos en el contenedor cuando está en modo infierno */
        body.hell-mode .container {
            background: linear-gradient(135deg, #2a1a1a 0%, #3d2525 50%, #2a1a1a 100%);
            box-shadow: 0 20px 60px rgba(255, 69, 0, 0.5), 
                        0 0 50px rgba(255, 140, 0, 0.3),
                        inset 0 0 30px rgba(255, 69, 0, 0.2);
            border: 2px solid rgba(255, 69, 0, 0.5);
            /* Desactivar animación de parpadeo para mejor rendimiento */
            /* animation: containerFlicker 0.4s ease-in-out infinite alternate; */
            color: #f0f0f0;
        }

        body.hell-mode .container h1,
        body.hell-mode .container .score,
        body.hell-mode .container .streak-text,
        body.hell-mode .container .lives-text {
            color: #ffcc99;
            text-shadow: 0 0 10px rgba(255, 140, 0, 0.5);
        }

        /* Efectos en el contenedor cuando está en modo guerra */
        body.war-mode .container {
            background: linear-gradient(135deg, #2a1a1a 0%, #3d2525 30%, #2a1a1a 60%, #1f1414 100%);
            box-shadow: 0 20px 60px rgba(139, 0, 0, 0.6), 
                        0 0 40px rgba(200, 0, 0, 0.4),
                        inset 0 0 30px rgba(100, 0, 0, 0.3);
            border: 3px solid rgba(139, 0, 0, 0.7);
            color: #ffcccc;
            position: relative;
        }

        body.war-mode .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 2px,
                    rgba(139, 0, 0, 0.03) 2px,
                    rgba(139, 0, 0, 0.03) 4px
                );
            pointer-events: none;
            border-radius: 20px;
        }

        body.war-mode .container h1 {
            color: #ff6666;
            text-shadow: 0 0 10px rgba(255, 0, 0, 0.8), 
                         0 0 20px rgba(255, 100, 100, 0.6),
                         0 2px 4px rgba(0, 0, 0, 0.5);
            animation: textGlow 2s ease-in-out infinite alternate;
        }

        body.war-mode .container .score {
            background: linear-gradient(135deg, #8b0000 0%, #a00000 50%, #8b0000 100%);
            color: #ffcccc;
            text-shadow: 0 0 8px rgba(255, 0, 0, 0.6), 
                         0 2px 4px rgba(0, 0, 0, 0.5);
            box-shadow: 0 4px 15px rgba(139, 0, 0, 0.5),
                        inset 0 0 10px rgba(255, 0, 0, 0.2);
        }

        body.war-mode .container .streak-text {
            background: linear-gradient(135deg, #8b0000 0%, #a00000 50%, #8b0000 100%);
            color: #ffcccc;
            text-shadow: 0 0 8px rgba(255, 0, 0, 0.6), 
                         0 2px 4px rgba(0, 0, 0, 0.5);
            box-shadow: 0 4px 15px rgba(139, 0, 0, 0.5),
                        inset 0 0 10px rgba(255, 0, 0, 0.2);
        }

        body.war-mode .container .lives-text {
            color: #ff9999;
            text-shadow: 0 0 8px rgba(255, 0, 0, 0.5), 
                         0 2px 4px rgba(0, 0, 0, 0.5);
        }

        @keyframes textGlow {
            0% {
                text-shadow: 0 0 10px rgba(255, 0, 0, 0.8), 
                             0 0 20px rgba(255, 100, 100, 0.6),
                             0 2px 4px rgba(0, 0, 0, 0.5);
            }
            100% {
                text-shadow: 0 0 15px rgba(255, 0, 0, 1), 
                             0 0 30px rgba(255, 100, 100, 0.8),
                             0 2px 4px rgba(0, 0, 0, 0.5);
            }
        }

        /* Efectos en el contenedor cuando está en modo fácil */
        body.easy-mode .container {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 50%, #e8f5e9 100%);
            box-shadow: 0 20px 60px rgba(76, 175, 80, 0.3), 
                        0 0 30px rgba(129, 199, 132, 0.2);
            border: 2px solid rgba(76, 175, 80, 0.4);
        }

        body.easy-mode .container h1,
        body.easy-mode .container .score,
        body.easy-mode .container .streak-text,
        body.easy-mode .container .lives-text {
            color: #2e7d32;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
        }

        @keyframes containerFlicker {
            0% {
                box-shadow: 0 20px 60px rgba(255, 69, 0, 0.5), 
                            0 0 50px rgba(255, 140, 0, 0.3),
                            inset 0 0 30px rgba(255, 69, 0, 0.2);
            }
            100% {
                box-shadow: 0 20px 60px rgba(255, 140, 0, 0.6), 
                            0 0 60px rgba(255, 200, 0, 0.4),
                            inset 0 0 40px rgba(255, 140, 0, 0.3);
            }
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
            text-align: center;
        }

        .title-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            gap: 15px;
        }

        h1 {
            color: #333;
            margin: 0;
            font-size: 2.5em;
            flex: 1;
        }

        .score {
            font-size: 1.5em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 700;
            margin-bottom: 15px;
            padding: 12px 25px;
            border-radius: 50px;
            display: inline-block;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            letter-spacing: 1px;
        }

        .streak-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .streak-fire {
            font-size: 2.5em;
            animation: fireFlicker 0.5s ease-in-out infinite alternate;
            filter: drop-shadow(0 0 10px rgba(255, 69, 0, 0.8));
            transition: all 0.3s ease;
        }

        .streak-fire.hot {
            font-size: 3em;
            filter: drop-shadow(0 0 20px rgba(255, 140, 0, 1));
            animation: fireFlicker 0.3s ease-in-out infinite alternate;
        }

        @keyframes fireFlicker {
            0% {
                transform: scale(1) rotate(-2deg);
                filter: drop-shadow(0 0 10px rgba(255, 69, 0, 0.8));
            }
            100% {
                transform: scale(1.1) rotate(2deg);
                filter: drop-shadow(0 0 15px rgba(255, 140, 0, 1));
            }
        }

        .streak-text {
            font-size: 1.3em;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            font-weight: 700;
            padding: 10px 20px;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            letter-spacing: 1px;
        }

        .lives-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-size: 200% 200%;
            animation: gradientFlow 3s ease infinite;
            padding: 15px 25px;
            border-radius: 50px;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4), 0 0 30px rgba(118, 75, 162, 0.3);
            position: relative;
            overflow: hidden;
        }

        .lives-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
            animation: rotate 4s linear infinite;
        }

        .lives-text {
            font-size: 1.2em;
            color: white;
            font-weight: 700;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            letter-spacing: 1px;
            position: relative;
            z-index: 1;
        }

        .hearts {
            font-size: 2.2em;
            letter-spacing: 10px;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .hearts .heart-full {
            animation: heartFloat 2s ease-in-out infinite;
            display: inline-block;
            filter: drop-shadow(0 0 10px rgba(255, 20, 147, 0.8));
            transform-origin: center;
        }

        .hearts .heart-full:nth-child(1) {
            animation-delay: 0s;
        }

        .hearts .heart-full:nth-child(2) {
            animation-delay: 0.3s;
        }

        .hearts .heart-full:nth-child(3) {
            animation-delay: 0.6s;
        }

        .hearts .heart-empty {
            opacity: 0.4;
            filter: grayscale(100%) drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
            transform: scale(0.9);
            transition: all 0.3s ease;
        }

        @keyframes gradientFlow {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes heartFloat {
            0%, 100% {
                transform: translateY(0) scale(1) rotate(0deg);
                filter: drop-shadow(0 0 10px rgba(255, 20, 147, 0.8));
            }
            25% {
                transform: translateY(-8px) scale(1.1) rotate(-5deg);
                filter: drop-shadow(0 0 15px rgba(255, 20, 147, 1));
            }
            50% {
                transform: translateY(-12px) scale(1.15) rotate(0deg);
                filter: drop-shadow(0 0 20px rgba(255, 20, 147, 1));
            }
            75% {
                transform: translateY(-8px) scale(1.1) rotate(5deg);
                filter: drop-shadow(0 0 15px rgba(255, 20, 147, 1));
            }
        }

        .joker-message {
            font-size: 1em;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            font-weight: 600;
            padding: 8px 15px;
            border-radius: 50px;
            box-shadow: 0 4px 10px rgba(245, 87, 108, 0.4);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            animation: jokerPulse 2s ease-in-out infinite;
        }

        @keyframes jokerPulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 4px 10px rgba(245, 87, 108, 0.4);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 6px 15px rgba(245, 87, 108, 0.6);
            }
        }

        /* Alertas estilizadas */
        .alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            animation: fadeIn 0.3s ease;
        }

        .alert-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
            max-width: 400px;
            width: 90%;
        }

        .alert-box.success {
            border-top: 5px solid #48bb78;
        }

        .alert-box.error {
            border-top: 5px solid #f56565;
        }

        .alert-icon {
            font-size: 4em;
            margin-bottom: 20px;
            animation: bounce 0.5s ease;
        }

        .alert-message {
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .alert-box.success .alert-message {
            color: #22543d;
        }

        .alert-box.error .alert-message {
            color: #742a2a;
        }

        .alert-details {
            font-size: 1em;
            color: #718096;
            margin-top: 10px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-20px);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        /* Estilos para cohetes */
        .rocket {
            position: fixed;
            font-size: 2.5em;
            pointer-events: none;
            z-index: 3000;
            filter: drop-shadow(0 0 10px rgba(255, 140, 0, 0.8));
            animation: rocketTrail 2s ease-out forwards;
        }

        @keyframes rocketTrail {
            0% {
                opacity: 1;
                filter: drop-shadow(0 0 10px rgba(255, 140, 0, 0.8));
            }
            50% {
                opacity: 0.8;
                filter: drop-shadow(0 0 20px rgba(255, 200, 0, 1));
            }
            100% {
                opacity: 0;
                filter: drop-shadow(0 0 30px rgba(255, 255, 255, 0.5));
            }
        }

        .joker-btn-inline {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 1em;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
            transition: all 0.3s ease;
            animation: jokerPulse 2s ease-in-out infinite;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            letter-spacing: 0.5px;
        }

        .joker-btn-inline:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px rgba(245, 87, 108, 0.6);
        }

        .joker-btn-inline:active {
            transform: translateY(0) scale(1);
        }

        @keyframes jokerPulse {
            0%, 100% {
                box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 6px 20px rgba(245, 87, 108, 0.8);
                transform: scale(1.05);
            }
        }

        .flag-container {
            margin: 30px 0;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f5f5f5;
            border-radius: 15px;
            padding: 20px;
        }

        .flag {
            font-size: 8em;
            line-height: 1;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
        }

        .flag div {
            font-size: 10em;
            line-height: 1;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.2));
        }

        .flag img {
            width: auto;
            height: auto;
            max-width: 100%;
            max-height: 180px;
            min-height: 100px;
            object-fit: contain;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            background: white;
            padding: 5px;
        }

        .timer-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
        }

        .timer-circle {
            position: relative;
            width: 80px;
            height: 80px;
        }

        .timer-svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .timer-circle-bg {
            fill: none;
            stroke: #e0e0e0;
            stroke-width: 8;
        }

        .timer-circle-progress {
            fill: none;
            stroke: #667eea;
            stroke-width: 8;
            stroke-linecap: round;
            stroke-dasharray: 283;
            stroke-dashoffset: 0;
            transition: stroke-dashoffset 1s linear, stroke 0.3s ease;
        }

        .timer-circle-progress.warning {
            stroke: #ff9800;
        }

        .timer-circle-progress.danger {
            stroke: #f44336;
        }

        .timer-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.8em;
            font-weight: 700;
            color: #333;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        body.hell-mode .timer-circle-progress {
            stroke: #ff4500;
        }

        body.hell-mode .timer-circle-progress.warning {
            stroke: #ff6b00;
        }

        body.hell-mode .timer-circle-progress.danger {
            stroke: #ff0000;
        }

        body.hell-mode .timer-text {
            color: #ffcccc;
            text-shadow: 0 0 10px rgba(255, 0, 0, 0.8);
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 30px 0;
        }

        .option {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .option:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .option:active {
            transform: translateY(0);
        }

        .end-attempt-btn {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 20px auto;
            display: block;
            box-shadow: 0 4px 15px rgba(245, 101, 101, 0.4);
            width: fit-content;
        }

        .end-attempt-btn:hover {
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 101, 101, 0.6);
        }

        .end-attempt-btn:active {
            transform: translateY(0);
        }

        .option.correct {
            background: #48bb78;
        }

        .option.incorrect {
            background: #f56565;
        }

        .option:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        .next-btn {
            background: #764ba2;
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
            font-weight: 600;
            display: none;
        }

        .next-btn:hover {
            background: #653a8a;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(118, 75, 162, 0.4);
        }

        .next-btn.show {
            display: inline-block;
        }

        .message {
            margin-top: 20px;
            font-size: 1.2em;
            font-weight: bold;
            min-height: 30px;
        }

        .message.correct {
            color: #48bb78;
        }

        .message.incorrect {
            color: #f56565;
        }

        .loading {
            font-size: 1.2em;
            color: #667eea;
            margin: 20px 0;
        }

        .difficulty-selector {
            text-align: center;
            padding: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .difficulty-selector h2 {
            color: #333;
            margin-bottom: 30px;
            font-size: 1.8em;
        }

        .difficulty-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .difficulty-btn {
            background: white;
            border: 2px solid #667eea;
            padding: 20px 30px;
            border-radius: 10px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
            color: #333;
            min-width: 180px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .difficulty-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .difficulty-btn.easy {
            border-color: #48bb78;
            background: #f0fff4;
            color: #22543d;
        }

        .difficulty-btn.easy:hover {
            background: #48bb78;
            color: white;
        }

        .difficulty-btn.hard {
            border-color: #f56565;
            background: #fff5f5;
            color: #742a2a;
        }

        .difficulty-btn.hard:hover {
            background: #f56565;
            color: white;
        }

        .difficulty-btn.impossible {
            border-color: #2d3748;
            background: #2d3748;
            color: white;
        }

        .difficulty-btn.impossible:hover {
            background: #4a5568;
        }

        .difficulty-btn.god {
            border-color: #6366f1;
            background: #6366f1;
            color: white;
        }

        .difficulty-btn.god:hover {
            background: #8b5cf6;
        }

        .difficulty-btn small {
            display: block;
            font-size: 0.7em;
            margin-top: 5px;
            font-weight: 400;
            opacity: 0.8;
        }

        /* Botones de clasificación */
        .ranking-buttons-container {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #e2e8f0;
            position: relative;
            z-index: 10;
        }

        .ranking-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            position: relative;
            z-index: 10;
        }

        .ranking-btn {
            background: white;
            border: 2px solid #667eea;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            color: #333;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 10;
            pointer-events: auto;
        }

        .ranking-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .ranking-btn-easy {
            border-color: #48bb78;
        }

        .ranking-btn-easy:hover {
            background: #48bb78;
            color: white;
        }

        .ranking-btn-hard {
            border-color: #f56565;
        }

        .ranking-btn-hard:hover {
            background: #f56565;
            color: white;
        }

        .ranking-btn-impossible {
            border-color: #2d3748;
        }

        .ranking-btn-impossible:hover {
            background: #2d3748;
            color: white;
        }

        .ranking-btn-god {
            border-color: #6366f1;
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #4c1d95 100%);
            color: white;
        }

        .ranking-btn-god:hover {
            background: linear-gradient(135deg, #312e81 0%, #4c1d95 50%, #6366f1 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.5);
        }

        .game-over {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .game-over-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .game-over-content h2 {
            color: #f56565;
            font-size: 2.5em;
            margin-bottom: 30px;
        }

        .game-over-stats {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-item {
            background: #f7fafc;
            padding: 20px;
            border-radius: 10px;
        }

        .stat-label {
            font-size: 0.9em;
            color: #718096;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .name-input-container {
            margin: 20px 0;
        }

        .name-input {
            width: 100%;
            padding: 12px;
            font-size: 1em;
            border: 2px solid #667eea;
            border-radius: 8px;
            margin-bottom: 10px;
            text-align: center;
            box-sizing: border-box;
        }

        .name-input:focus {
            outline: none;
            border-color: #764ba2;
        }

        .save-score-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1em;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
            font-weight: 600;
            width: 100%;
        }

        .save-score-btn:hover {
            transform: scale(1.05);
        }

        .save-score-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        /* Botón para ver ranking */
        .view-ranking-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 25%, #4facfe 50%, #00f2fe 75%, #43e97b 100%);
            background-size: 300% 300%;
            animation: gradientShift 3s ease infinite;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2), 0 0 20px rgba(255, 255, 255, 0.3) inset;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .view-ranking-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .view-ranking-btn:hover::before {
            left: 100%;
        }

        .view-ranking-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.3), 0 0 30px rgba(255, 255, 255, 0.4) inset;
        }

        .view-ranking-btn:active {
            transform: translateY(-1px) scale(1.02);
        }

        @keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        .ranking-container {
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
        }

        .ranking-container h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        /* Ranking principal en la pantalla del juego */
        .main-ranking-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        /* Estilos para modo imposible */
        body.hell-mode .main-ranking-container {
            background: linear-gradient(135deg, #2a1a1a 0%, #3d2525 50%, #2a1a1a 100%);
            box-shadow: 0 4px 15px rgba(255, 69, 0, 0.3), 
                        0 0 30px rgba(255, 140, 0, 0.2);
            border: 2px solid rgba(255, 69, 0, 0.5);
        }

        body.hell-mode .main-ranking-container h2 {
            color: #ffcc99;
            text-shadow: 0 0 10px rgba(255, 140, 0, 0.5);
        }

        .ranking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .main-ranking-container h2 {
            color: #667eea;
            margin: 0;
            font-size: 1.8em;
        }

        .close-ranking-btn {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(245, 101, 101, 0.4);
            position: relative;
            overflow: hidden;
        }

        .close-ranking-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }

        .close-ranking-btn:hover::before {
            width: 100%;
            height: 100%;
        }

        .close-ranking-btn:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 6px 20px rgba(245, 101, 101, 0.6);
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
        }

        .close-ranking-btn:active {
            transform: scale(0.95) rotate(90deg);
        }

        .main-ranking-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 400px;
            overflow-y: auto;
        }

        .main-ranking-item {
            background: #f7fafc;
            padding: 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #667eea;
            transition: transform 0.2s;
            overflow: visible;
        }

        /* Estilos para items en modo imposible */
        body.hell-mode .main-ranking-item {
            background: rgba(61, 37, 37, 0.7) !important;
            border-left-color: rgba(255, 69, 0, 0.6) !important;
        }

        body.hell-mode .main-ranking-item:hover {
            background: rgba(61, 37, 37, 0.9) !important;
            border-left-color: rgba(255, 140, 0, 0.8) !important;
        }

        body.hell-mode .main-ranking-item.top {
            background: rgba(139, 69, 19, 0.8) !important;
            border-left-color: rgba(255, 140, 0, 0.9) !important;
        }

        .main-ranking-item:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .main-ranking-item.top {
            border-left-color: #fbbf24;
            background: linear-gradient(135deg, #fffbeb 0%, #fff4d6 50%, #fffbeb 100%);
            background-size: 200% 200%;
            animation: topGradient 3s ease infinite;
            position: relative;
            overflow: visible !important;
            box-shadow: 0 4px 20px rgba(251, 191, 36, 0.4), 0 0 30px rgba(251, 191, 36, 0.2);
        }
        
        /* Estilos para foto de perfil Top 1 */
        .main-ranking-item.top .ranking-profile-picture {
            position: relative;
            border: 4px solid #fbbf24;
            box-shadow: 0 0 25px rgba(251, 191, 36, 0.8), 
                        0 0 50px rgba(251, 191, 36, 0.6),
                        0 0 75px rgba(251, 191, 36, 0.4),
                        inset 0 0 15px rgba(251, 191, 36, 0.4);
            animation: topPhotoGlow 2s ease-in-out infinite;
            z-index: 5;
        }
        
        .main-ranking-item.top .ranking-profile-picture::after {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            border-radius: 50%;
            background: radial-gradient(circle, 
                rgba(251, 191, 36, 0.4) 0%, 
                rgba(251, 191, 36, 0.2) 40%,
                transparent 70%);
            animation: topAura 3s ease-in-out infinite;
            pointer-events: none;
            z-index: -1;
        }
        
        @keyframes topAura {
            0%, 100% {
                transform: scale(1);
                opacity: 0.6;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.9;
            }
        }
        
        @keyframes topPhotoGlow {
            0%, 100% {
                box-shadow: 0 0 20px rgba(251, 191, 36, 0.6), 
                            0 0 40px rgba(251, 191, 36, 0.4),
                            inset 0 0 10px rgba(251, 191, 36, 0.3);
            }
            50% {
                box-shadow: 0 0 30px rgba(251, 191, 36, 0.8), 
                            0 0 50px rgba(251, 191, 36, 0.6),
                            inset 0 0 15px rgba(251, 191, 36, 0.5);
            }
        }
        
        @keyframes topPhotoShine {
            0%, 100% {
                opacity: 0.4;
                transform: rotate(0deg);
            }
            50% {
                opacity: 0.7;
                transform: rotate(180deg);
            }
        }
        
        @keyframes topGradient {
            0%, 100% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
        }
        
        @keyframes crownFloat {
            0%, 100% {
                transform: translateY(-50%) rotate(-5deg);
            }
            50% {
                transform: translateY(-60%) rotate(5deg);
            }
        }
        
        @keyframes topShine {
            0%, 100% {
                opacity: 0.3;
            }
            50% {
                opacity: 0.6;
            }
        }
        
        .main-ranking-item.top .main-ranking-position {
            color: #f59e0b;
            font-size: 1.3em;
            font-weight: 900;
            text-shadow: 0 2px 4px rgba(251, 191, 36, 0.5);
        }
        
        .main-ranking-item.top .main-ranking-position::before {
            content: '👑';
            font-size: 1.5em;
            animation: crownFloat 2s ease-in-out infinite;
            filter: drop-shadow(0 2px 4px rgba(251, 191, 36, 0.6));
        }
        
        .main-ranking-item.top .main-ranking-name {
            font-weight: 700;
            color: #92400e;
        }
        
        .main-ranking-item.top .main-ranking-score {
            color: #f59e0b;
            font-size: 1.3em;
            font-weight: 900;
            text-shadow: 0 2px 4px rgba(251, 191, 36, 0.5);
        }

        /* Estilos para Top 2 (Plata) */
        .main-ranking-item.second {
            border-left-color: #94a3b8;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 50%, #f1f5f9 100%);
            background-size: 200% 200%;
            animation: secondGradient 3s ease infinite;
            position: relative;
            overflow: visible !important;
            box-shadow: 0 4px 15px rgba(148, 163, 184, 0.3), 0 0 20px rgba(148, 163, 184, 0.15);
        }
        
        /* Estilos para foto de perfil Top 2 */
        .main-ranking-item.second .ranking-profile-picture {
            position: relative;
            border: 4px solid #94a3b8;
            box-shadow: 0 0 20px rgba(148, 163, 184, 0.7), 
                        0 0 40px rgba(148, 163, 184, 0.5),
                        0 0 60px rgba(148, 163, 184, 0.3),
                        inset 0 0 12px rgba(148, 163, 184, 0.3);
            animation: secondPhotoGlow 2.5s ease-in-out infinite;
            z-index: 5;
        }
        
        .main-ranking-item.second .ranking-profile-picture::after {
            content: '';
            position: absolute;
            top: -8px;
            left: -8px;
            right: -8px;
            bottom: -8px;
            border-radius: 50%;
            background: radial-gradient(circle, 
                rgba(148, 163, 184, 0.3) 0%, 
                rgba(148, 163, 184, 0.15) 40%,
                transparent 70%);
            animation: secondAura 3s ease-in-out infinite;
            pointer-events: none;
            z-index: -1;
        }
        
        @keyframes secondAura {
            0%, 100% {
                transform: scale(1);
                opacity: 0.5;
            }
            50% {
                transform: scale(1.15);
                opacity: 0.8;
            }
        }
        
        @keyframes secondPhotoGlow {
            0%, 100% {
                box-shadow: 0 0 15px rgba(148, 163, 184, 0.5), 
                            0 0 30px rgba(148, 163, 184, 0.3),
                            inset 0 0 8px rgba(148, 163, 184, 0.2);
            }
            50% {
                box-shadow: 0 0 25px rgba(148, 163, 184, 0.7), 
                            0 0 40px rgba(148, 163, 184, 0.5),
                            inset 0 0 12px rgba(148, 163, 184, 0.4);
            }
        }
        
        @keyframes secondPhotoShine {
            0%, 100% {
                opacity: 0.3;
                transform: rotate(0deg);
            }
            50% {
                opacity: 0.6;
                transform: rotate(180deg);
            }
        }
        
        @keyframes secondGradient {
            0%, 100% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
        }
        
        @keyframes medalFloat {
            0%, 100% {
                transform: translateY(-50%) rotate(-3deg);
            }
            50% {
                transform: translateY(-55%) rotate(3deg);
            }
        }
        
        @keyframes secondShine {
            0%, 100% {
                opacity: 0.25;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        .main-ranking-item.second .main-ranking-position {
            color: #64748b;
            font-size: 1.2em;
            font-weight: 800;
            text-shadow: 0 1px 3px rgba(148, 163, 184, 0.4);
        }
        
        .main-ranking-item.second .main-ranking-position::before {
            content: '🥈';
            font-size: 1.3em;
            animation: medalFloat 2s ease-in-out infinite;
            filter: drop-shadow(0 2px 4px rgba(148, 163, 184, 0.5));
        }
        
        .main-ranking-item.second .main-ranking-name {
            font-weight: 700;
            color: #475569;
        }
        
        .main-ranking-item.second .main-ranking-score {
            color: #64748b;
            font-size: 1.2em;
            font-weight: 800;
            text-shadow: 0 1px 3px rgba(148, 163, 184, 0.4);
        }

        /* Estilos para Top 3 (Bronce) */
        .main-ranking-item.third {
            border-left-color: #d97706;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 50%, #fef3c7 100%);
            background-size: 200% 200%;
            animation: thirdGradient 3s ease infinite;
            position: relative;
            overflow: visible !important;
            box-shadow: 0 4px 15px rgba(217, 119, 6, 0.3), 0 0 20px rgba(217, 119, 6, 0.15);
        }
        
        /* Estilos para foto de perfil Top 3 */
        .main-ranking-item.third .ranking-profile-picture {
            position: relative;
            border: 4px solid #d97706;
            box-shadow: 0 0 20px rgba(217, 119, 6, 0.7), 
                        0 0 40px rgba(217, 119, 6, 0.5),
                        0 0 60px rgba(217, 119, 6, 0.3),
                        inset 0 0 12px rgba(217, 119, 6, 0.3);
            animation: thirdPhotoGlow 2.5s ease-in-out infinite;
            z-index: 5;
        }
        
        .main-ranking-item.third .ranking-profile-picture::after {
            content: '';
            position: absolute;
            top: -8px;
            left: -8px;
            right: -8px;
            bottom: -8px;
            border-radius: 50%;
            background: radial-gradient(circle, 
                rgba(217, 119, 6, 0.3) 0%, 
                rgba(217, 119, 6, 0.15) 40%,
                transparent 70%);
            animation: thirdAura 3s ease-in-out infinite;
            pointer-events: none;
            z-index: -1;
        }
        
        @keyframes thirdAura {
            0%, 100% {
                transform: scale(1);
                opacity: 0.5;
            }
            50% {
                transform: scale(1.15);
                opacity: 0.8;
            }
        }
        
        @keyframes thirdPhotoGlow {
            0%, 100% {
                box-shadow: 0 0 15px rgba(217, 119, 6, 0.5), 
                            0 0 30px rgba(217, 119, 6, 0.3),
                            inset 0 0 8px rgba(217, 119, 6, 0.2);
            }
            50% {
                box-shadow: 0 0 25px rgba(217, 119, 6, 0.7), 
                            0 0 40px rgba(217, 119, 6, 0.5),
                            inset 0 0 12px rgba(217, 119, 6, 0.4);
            }
        }
        
        @keyframes thirdPhotoShine {
            0%, 100% {
                opacity: 0.3;
                transform: rotate(0deg);
            }
            50% {
                opacity: 0.6;
                transform: rotate(180deg);
            }
        }
        
        @keyframes thirdGradient {
            0%, 100% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
        }
        
        @keyframes thirdShine {
            0%, 100% {
                opacity: 0.25;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        .main-ranking-item.third .main-ranking-position {
            color: #b45309;
            font-size: 1.15em;
            font-weight: 800;
            text-shadow: 0 1px 3px rgba(217, 119, 6, 0.4);
        }
        
        .main-ranking-item.third .main-ranking-position::before {
            content: '🥉';
            font-size: 1.3em;
            animation: medalFloat 2s ease-in-out infinite;
            filter: drop-shadow(0 2px 4px rgba(217, 119, 6, 0.5));
        }
        
        .main-ranking-item.third .main-ranking-name {
            font-weight: 700;
            color: #92400e;
        }
        
        .main-ranking-item.third .main-ranking-score {
            color: #b45309;
            font-size: 1.15em;
            font-weight: 800;
            text-shadow: 0 1px 3px rgba(217, 119, 6, 0.4);
        }

        /* Contenedor de ranking en la pantalla de selección de dificultad */
        .difficulty-ranking-container {
            margin-top: 30px;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 10;
        }

        .difficulty-ranking-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 500px;
            overflow-y: auto;
            overflow-x: visible;
        }

        .difficulty-ranking-item {
            background: #f7fafc;
            padding: 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #667eea;
            transition: transform 0.2s;
            overflow: visible;
        }

        .difficulty-ranking-item:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .difficulty-ranking-item.top {
            border-left-color: #fbbf24;
            background: linear-gradient(135deg, #fffbeb 0%, #fff4d6 50%, #fffbeb 100%);
            background-size: 200% 200%;
            animation: topGradient 3s ease infinite;
            position: relative;
            overflow: visible !important;
            box-shadow: 0 4px 20px rgba(251, 191, 36, 0.4), 0 0 30px rgba(251, 191, 36, 0.2);
        }

        /* Estilos para foto de perfil Top 1 en difficulty ranking */
        .difficulty-ranking-item.top .ranking-profile-picture {
            position: relative;
            border: 4px solid #fbbf24;
            box-shadow: 0 0 25px rgba(251, 191, 36, 0.8), 
                        0 0 50px rgba(251, 191, 36, 0.6),
                        0 0 75px rgba(251, 191, 36, 0.4),
                        inset 0 0 15px rgba(251, 191, 36, 0.4);
            animation: topPhotoGlow 2s ease-in-out infinite;
            z-index: 5;
        }
        
        .difficulty-ranking-item.top .ranking-profile-picture::after {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            border-radius: 50%;
            background: radial-gradient(circle, 
                rgba(251, 191, 36, 0.4) 0%, 
                rgba(251, 191, 36, 0.2) 40%,
                transparent 70%);
            animation: topAura 3s ease-in-out infinite;
            pointer-events: none;
            z-index: -1;
        }

        .difficulty-ranking-item.second {
            border-left-color: #94a3b8;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 50%, #f1f5f9 100%);
            background-size: 200% 200%;
            animation: secondGradient 3s ease infinite;
            position: relative;
            overflow: visible !important;
            box-shadow: 0 4px 15px rgba(148, 163, 184, 0.3), 0 0 20px rgba(148, 163, 184, 0.15);
        }

        /* Estilos para foto de perfil Top 2 en difficulty ranking */
        .difficulty-ranking-item.second .ranking-profile-picture {
            position: relative;
            border: 4px solid #94a3b8;
            box-shadow: 0 0 20px rgba(148, 163, 184, 0.7), 
                        0 0 40px rgba(148, 163, 184, 0.5),
                        0 0 60px rgba(148, 163, 184, 0.3),
                        inset 0 0 12px rgba(148, 163, 184, 0.3);
            animation: secondPhotoGlow 2.5s ease-in-out infinite;
            z-index: 5;
        }
        
        .difficulty-ranking-item.second .ranking-profile-picture::after {
            content: '';
            position: absolute;
            top: -8px;
            left: -8px;
            right: -8px;
            bottom: -8px;
            border-radius: 50%;
            background: radial-gradient(circle, 
                rgba(148, 163, 184, 0.3) 0%, 
                rgba(148, 163, 184, 0.15) 40%,
                transparent 70%);
            animation: secondAura 3s ease-in-out infinite;
            pointer-events: none;
            z-index: -1;
        }

        .difficulty-ranking-item.third {
            border-left-color: #d97706;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 50%, #fef3c7 100%);
            background-size: 200% 200%;
            animation: thirdGradient 3s ease infinite;
            position: relative;
            overflow: visible !important;
            box-shadow: 0 4px 15px rgba(217, 119, 6, 0.3), 0 0 20px rgba(217, 119, 6, 0.15);
        }

        /* Estilos para foto de perfil Top 3 en difficulty ranking */
        .difficulty-ranking-item.third .ranking-profile-picture {
            position: relative;
            border: 3px solid #d97706;
            box-shadow: 0 0 15px rgba(217, 119, 6, 0.5), 
                        0 0 30px rgba(217, 119, 6, 0.3),
                        inset 0 0 8px rgba(217, 119, 6, 0.2);
            animation: thirdPhotoGlow 2.5s ease-in-out infinite;
        }
        
        
        .difficulty-ranking-item.third .ranking-profile-picture::after {
            content: '';
            position: absolute;
            top: -6px;
            left: -6px;
            right: -6px;
            bottom: -6px;
            border-radius: 50%;
            background: linear-gradient(45deg, 
                rgba(217, 119, 6, 0.3) 0%, 
                transparent 30%, 
                transparent 70%);
            animation: thirdAura 3s ease-in-out infinite;
            pointer-events: none;
            z-index: -1;
        }

        .difficulty-ranking-item.top .difficulty-ranking-position,
        .difficulty-ranking-item.top .difficulty-ranking-score {
            color: #f59e0b;
            font-size: 1.3em;
            font-weight: 900;
            text-shadow: 0 2px 4px rgba(251, 191, 36, 0.5);
        }
        
        .difficulty-ranking-item.top .difficulty-ranking-position::before {
            content: '👑';
            font-size: 1.5em;
            animation: crownFloat 2s ease-in-out infinite;
            filter: drop-shadow(0 2px 4px rgba(251, 191, 36, 0.6));
        }

        .difficulty-ranking-item.top .difficulty-ranking-name {
            font-weight: 700;
            color: #92400e;
        }

        .difficulty-ranking-item.second .difficulty-ranking-position,
        .difficulty-ranking-item.second .difficulty-ranking-score {
            color: #64748b;
            font-size: 1.2em;
            font-weight: 800;
            text-shadow: 0 1px 3px rgba(148, 163, 184, 0.4);
        }
        
        .difficulty-ranking-item.second .difficulty-ranking-position::before {
            content: '🥈';
            font-size: 1.3em;
            animation: medalFloat 2s ease-in-out infinite;
            filter: drop-shadow(0 2px 4px rgba(148, 163, 184, 0.5));
        }

        .difficulty-ranking-item.second .difficulty-ranking-name {
            font-weight: 700;
            color: #475569;
        }

        .difficulty-ranking-item.third .difficulty-ranking-position,
        .difficulty-ranking-item.third .difficulty-ranking-score {
            color: #b45309;
            font-size: 1.15em;
            font-weight: 800;
            text-shadow: 0 1px 3px rgba(217, 119, 6, 0.4);
        }
        
        .difficulty-ranking-item.third .difficulty-ranking-position::before {
            content: '🥉';
            font-size: 1.3em;
            animation: medalFloat 2s ease-in-out infinite;
            filter: drop-shadow(0 2px 4px rgba(217, 119, 6, 0.5));
        }

        .difficulty-ranking-item.third .difficulty-ranking-name {
            font-weight: 700;
            color: #92400e;
        }

        .difficulty-ranking-position {
            font-weight: bold;
            color: #667eea;
            min-width: 40px;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .difficulty-ranking-name {
            flex: 1;
            text-align: left;
            margin-left: 15px;
            font-weight: 600;
            font-size: 1.05em;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
            overflow: visible;
            position: relative;
        }

        .difficulty-ranking-score {
            font-weight: bold;
            color: #667eea;
            font-size: 1.1em;
        }

        .main-ranking-position {
            font-weight: bold;
            color: #667eea;
            min-width: 40px;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Estilos para posición en modo imposible */
        body.hell-mode .main-ranking-position {
            color: #ff9999 !important;
            text-shadow: 0 0 5px rgba(255, 140, 0, 0.5);
        }

        .main-ranking-name {
            flex: 1;
            text-align: left;
            margin-left: 15px;
            font-weight: 600;
            font-size: 1.05em;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
            overflow: visible;
            position: relative;
        }

        .ranking-profile-picture {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            border: 2px solid white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            overflow: visible;
            position: relative;
        }

        .ranking-profile-picture img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .ranking-profile-picture .placeholder {
            font-size: 1.2em;
            color: white;
        }

        /* Estilos para nombres en modo imposible */
        body.hell-mode .main-ranking-name {
            color: #ffcc99 !important;
            text-shadow: 0 0 5px rgba(255, 140, 0, 0.5), 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .main-ranking-score {
            font-weight: bold;
            color: #764ba2;
            font-size: 1.2em;
        }

        /* Estilos para puntuación en modo imposible */
        body.hell-mode .main-ranking-score {
            color: #ffcc99 !important;
            text-shadow: 0 0 5px rgba(255, 140, 0, 0.5);
        }

        /* Estilos para puntuación en modo imposible */
        body.hell-mode .main-ranking-score {
            color: #ffcc99;
            text-shadow: 0 0 5px rgba(255, 140, 0, 0.3);
        }

        .ranking-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .ranking-item {
            background: #f7fafc;
            padding: 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #667eea;
        }

        .ranking-item.top {
            border-left-color: #fbbf24;
            background: #fffbeb;
        }

        .ranking-position {
            font-weight: bold;
            color: #667eea;
            min-width: 30px;
        }

        .ranking-name {
            flex: 1;
            text-align: left;
            margin-left: 10px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ranking-score {
            font-weight: bold;
            color: #764ba2;
            font-size: 1.1em;
        }

        .restart-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s;
            font-weight: 600;
            width: 100%;
            margin-top: 10px;
        }

        .restart-btn:hover {
            transform: scale(1.05);
        }

        .show-ranking-btn {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1em;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
            font-weight: 600;
            width: 100%;
            margin-top: 10px;
        }

        .show-ranking-btn:hover {
            transform: scale(1.05);
        }

        /* Estilos para autenticación */
        .auth-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .auth-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
        }

        .auth-box h2 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2em;
        }

        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .auth-tab.active {
            background: #667eea;
            color: white;
        }

        .auth-tab:hover {
            transform: translateY(-2px);
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .auth-input {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .auth-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .auth-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .auth-btn:hover {
            transform: scale(1.02);
        }

        .auth-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .auth-message {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9em;
            min-height: 20px;
        }

        .auth-message.error {
            background: #fed7d7;
            color: #c53030;
        }

        .auth-message.success {
            background: #c6f6d5;
            color: #22543d;
        }

        /* Estilos para círculo de foto de perfil */
        .profile-picture-container {
            position: relative;
            flex-shrink: 0;
        }

        .profile-picture-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            border: 3px solid white;
            overflow: hidden;
        }

        .profile-picture-circle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .profile-picture-circle img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .profile-picture-placeholder {
            font-size: 2em;
            color: white;
        }

        /* Estilos para modal de perfil */
        .profile-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .profile-modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .profile-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .profile-modal-header h2 {
            margin: 0;
            color: #333;
            font-size: 1.8em;
        }

        .profile-modal-close {
            background: #f56565;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .profile-modal-close:hover {
            background: #e53e3e;
            transform: rotate(90deg);
        }

        .profile-modal-body {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .profile-picture-large-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .profile-picture-large {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            border: 5px solid white;
            overflow: hidden;
        }

        .profile-picture-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .profile-picture-large-placeholder {
            font-size: 5em;
            color: white;
        }

        .profile-upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .profile-upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .profile-info {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 15px;
        }

        .profile-info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .profile-info-item:last-child {
            border-bottom: none;
        }

        .profile-info-label {
            font-weight: 600;
            color: #4a5568;
        }

        .profile-info-value {
            color: #667eea;
            font-weight: 500;
        }

        .profile-description-item {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }

        .profile-description-input {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1em;
            font-family: inherit;
            resize: vertical;
            outline: none;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }

        .profile-description-input:focus {
            border-color: #667eea;
        }

        .profile-save-description-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s ease;
            align-self: flex-end;
        }

        .profile-save-description-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(72, 187, 120, 0.4);
        }

        .friend-profile-description {
            color: #4a5568;
            font-style: italic;
            padding: 10px;
            background: #f7fafc;
            border-radius: 8px;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .friend-description-item {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }

        .friend-profile-actions {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e2e8f0;
        }

        .remove-friend-btn {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(245, 101, 101, 0.4);
        }

        .remove-friend-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 101, 101, 0.6);
        }

        /* Estilos para biblioteca */
        .profile-library-section {
            width: 100%;
            margin-top: 20px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 15px;
        }

        .profile-library-section h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 1.3em;
            text-align: center;
        }

        .library-upload-container {
            margin-bottom: 15px;
            display: flex;
            justify-content: center;
        }

        .library-upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .library-upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .library-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .library-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .library-item:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.25);
        }

        .library-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .library-item-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(245, 101, 101, 0.95);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            opacity: 0.9;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .library-item:hover .library-item-remove {
            opacity: 1;
            transform: scale(1.1);
        }

        .library-item-remove:hover {
            background: rgba(229, 62, 62, 1);
            transform: scale(1.15);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        .friend-library-section {
            width: 100%;
            margin-top: 20px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 15px;
        }

        .friend-library-section h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 1.3em;
            text-align: center;
        }

        .friend-library-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        .friend-library-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .friend-library-item:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.25);
        }

        .friend-library-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Modal para ver imagen en grande */
        .library-image-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 4000;
            animation: fadeIn 0.3s ease;
        }

        .library-image-modal-content {
            max-width: 90%;
            max-height: 90vh;
            width: 90%;
            height: 90vh;
            position: relative;
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .library-image-container {
            flex: 0 0 auto;
            min-height: 300px;
            max-height: 60vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: #000;
            padding: 20px;
        }

        .library-image-container {
            cursor: pointer;
        }

        .library-image-container img {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
            transition: transform 0.3s ease;
        }

        .library-image-container:hover img {
            transform: scale(1.02);
        }

        /* Modal de vista ampliada */
        .library-image-zoom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 5000;
            animation: fadeIn 0.3s ease;
        }

        .library-image-zoom-modal.active {
            display: flex;
        }

        .library-image-zoom-container {
            position: relative;
            width: 95%;
            height: 95%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .library-image-zoom-container img {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
        }

        .library-image-zoom-close-back {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 5001;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .library-image-zoom-close-back:hover {
            background: rgba(102, 126, 234, 0.9);
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.5);
        }

        .library-image-zoom-close-all {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 5001;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .library-image-zoom-close-all:hover {
            background: rgba(245, 101, 101, 0.9);
            transform: rotate(90deg) scale(1.1);
            box-shadow: 0 4px 12px rgba(245, 101, 101, 0.5);
        }

        .library-image-interactions {
            flex: 1 1 auto;
            min-height: 0;
            padding: 20px;
            overflow-y: auto;
            border-top: 2px solid #e2e8f0;
            background: #fafafa;
            display: flex;
            flex-direction: column;
        }

        .library-image-interactions::-webkit-scrollbar {
            width: 8px;
        }

        .library-image-interactions::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .library-image-interactions::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 10px;
        }

        .library-image-interactions::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }

        .library-image-likes {
            margin-bottom: 20px;
        }

        .like-btn {
            background: none;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .like-btn:hover {
            border-color: #f56565;
            background: #fff5f5;
        }

        .like-btn.liked {
            border-color: #f56565;
            background: #fff5f5;
        }

        .like-icon {
            font-size: 1.2em;
        }

        .like-count {
            font-weight: 600;
            color: #333;
        }

        .library-image-comments h4 {
            margin-bottom: 15px;
            color: #333;
        }

        .comments-list {
            flex: 1 1 auto;
            min-height: 0;
            overflow-y: auto;
            margin-bottom: 15px;
            padding-right: 5px;
        }

        .comments-list::-webkit-scrollbar {
            width: 6px;
        }

        .comments-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .comments-list::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 10px;
        }

        .comments-list::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }

        .comment-item {
            padding: 15px;
            margin-bottom: 15px;
            background: #f7fafc;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            display: flex;
            gap: 12px;
            align-items: flex-start;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .comment-profile-picture {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            flex-shrink: 0;
            overflow: hidden;
            background: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #667eea;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .comment-profile-picture img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .comment-profile-picture .placeholder {
            font-size: 1.5em;
        }

        .comment-content {
            flex: 1;
            min-width: 0;
        }

        .comment-author {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 6px;
            font-size: 0.95em;
        }

        .comment-text {
            color: #2d3748;
            word-wrap: break-word;
            margin-bottom: 10px;
            line-height: 1.5;
            font-size: 0.9em;
        }

        .comment-actions {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .comment-like-btn {
            background: none;
            border: none;
            color: #718096;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9em;
            padding: 5px 10px;
            border-radius: 15px;
            transition: all 0.2s ease;
        }

        .comment-like-btn:hover {
            background: #f7fafc;
            color: #f56565;
        }

        .comment-like-btn.liked {
            color: #f56565;
        }

        .comment-like-btn.liked .like-icon {
            animation: likePulse 0.3s ease;
        }

        @keyframes likePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .comment-reply-btn {
            background: none;
            border: none;
            color: #718096;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9em;
            padding: 5px 10px;
            border-radius: 15px;
            transition: all 0.2s ease;
        }

        .comment-reply-btn:hover {
            background: #f7fafc;
            color: #667eea;
        }

        .comment-replies {
            margin-top: 15px;
            margin-left: 55px;
            padding-left: 20px;
            padding-top: 5px;
            border-left: 3px solid #cbd5e0;
            position: relative;
        }

        .comment-replies::before {
            content: '';
            position: absolute;
            left: -3px;
            top: 0;
            width: 3px;
            height: 20px;
            background: #667eea;
            border-radius: 0 0 0 3px;
        }

        .comment-reply-item {
            margin-bottom: 12px;
            padding: 12px 15px;
            background: #edf2f7;
            border-radius: 8px;
            border-left: 3px solid #a0aec0;
            display: flex;
            gap: 12px;
            align-items: flex-start;
            position: relative;
            margin-left: 0;
        }

        .comment-reply-item .comment-profile-picture {
            width: 35px;
            height: 35px;
            border: 2px solid #a0aec0;
        }

        .comment-reply-item .comment-author {
            font-size: 0.9em;
            color: #4a5568;
        }

        .comment-reply-item .comment-text {
            font-size: 0.85em;
        }

        .comment-reply-indicator {
            font-size: 0.75em;
            color: #718096;
            margin-bottom: 4px;
            font-style: italic;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .comment-reply-indicator::before {
            content: '↪';
            color: #a0aec0;
            font-size: 0.9em;
        }

        .comment-reply-input-container {
            margin-top: 12px;
            margin-left: 60px;
            display: none;
        }

        .comment-reply-input-container.active {
            display: flex;
            gap: 10px;
            margin-top: 12px;
            padding: 10px;
            background: #f7fafc;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }

        .comment-reply-input {
            flex: 1;
            padding: 8px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.9em;
        }

        .comment-reply-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .comment-reply-submit {
            padding: 8px 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: background 0.3s ease;
        }

        .comment-reply-submit:hover {
            background: #5568d3;
        }

        .comment-input-container {
            display: flex;
            gap: 10px;
        }

        .comment-input {
            flex: 1;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
        }

        .comment-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .comment-submit-btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s ease;
        }

        .comment-submit-btn:hover {
            background: #5568d3;
        }

        .library-image-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 4001;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .library-image-modal-close:hover {
            background: rgba(245, 101, 101, 0.9);
            transform: rotate(90deg) scale(1.1);
            box-shadow: 0 4px 12px rgba(245, 101, 101, 0.5);
        }

        .profile-actions {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .profile-save-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.4);
        }

        .profile-save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(72, 187, 120, 0.6);
        }

        .profile-save-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .profile-friends-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            width: 100%;
            margin-top: 10px;
        }

        .profile-friends-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .profile-inbox-btn {
            background: linear-gradient(135deg, #f6ad55 0%, #ed8936 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(246, 173, 85, 0.4);
            width: 100%;
            margin-top: 10px;
        }

        .profile-inbox-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(246, 173, 85, 0.6);
        }

        .profile-friends-section {
            width: 100%;
            margin-top: 20px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 15px;
        }

        .profile-friends-section h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 1.2em;
        }

        .friends-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .friend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .friend-item-picture {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            overflow: hidden;
        }

        .friend-item-picture img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .friend-item-name {
            flex: 1;
            font-weight: 600;
            color: #333;
        }

        .friend-item {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .friend-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }

        .profile-toggle-scores-btn {
            background: linear-gradient(135deg, #9f7aea 0%, #805ad5 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(159, 122, 234, 0.4);
            width: 100%;
            margin-top: 10px;
        }

        .profile-toggle-scores-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(159, 122, 234, 0.6);
        }

        .profile-toggle-scores-btn.hidden {
            background: linear-gradient(135deg, #a0aec0 0%, #718096 100%);
        }

        .profile-scores-section {
            width: 100%;
            margin-top: 20px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 15px;
        }

        .profile-scores-section h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 1.2em;
        }

        .scores-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .score-item-level {
            font-weight: 600;
            color: #333;
        }

        .score-item-points {
            font-weight: bold;
            color: #764ba2;
            font-size: 1.1em;
        }

        /* Estilos para modal de perfil de amigo */
        .friend-profile-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            animation: fadeIn 0.3s ease;
        }

        .friend-profile-modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        .friend-profile-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .friend-profile-modal-header h2 {
            margin: 0;
            color: #333;
            font-size: 1.8em;
        }

        .friend-profile-modal-close {
            background: #f56565;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .friend-profile-modal-close:hover {
            background: #e53e3e;
            transform: rotate(90deg);
        }

        .friend-profile-picture-large-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .friend-profile-picture-large {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            border: 5px solid white;
            overflow: hidden;
        }

        .friend-profile-picture-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .friend-profile-picture-large-placeholder {
            font-size: 5em;
            color: white;
        }

        .friend-profile-info {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .friend-profile-info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .friend-profile-info-item:last-child {
            border-bottom: none;
        }

        .friend-profile-info-label {
            font-weight: 600;
            color: #4a5568;
        }

        .friend-profile-info-value {
            color: #667eea;
            font-weight: 500;
        }

        .friend-profile-scores-section {
            width: 100%;
            padding: 15px;
            background: #f7fafc;
            border-radius: 15px;
        }

        .friend-profile-scores-section h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 1.2em;
        }

        .friend-scores-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Estilos para modal de búsqueda de amigos */
        .friends-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            animation: fadeIn 0.3s ease;
        }

        .friends-modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        .friends-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .friends-modal-header h2 {
            margin: 0;
            color: #333;
            font-size: 1.8em;
        }

        .friends-modal-close {
            background: #f56565;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .friends-modal-close:hover {
            background: #e53e3e;
            transform: rotate(90deg);
        }

        .friends-search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .friends-search-input {
            flex: 1;
            min-width: 0;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1em;
            outline: none;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }

        .friends-search-input:focus {
            border-color: #667eea;
        }

        .friends-search-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            white-space: nowrap;
            flex-shrink: 0;
        }

        .friends-search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .friends-results {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .friend-result-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            flex-wrap: wrap;
        }

        .friend-result-picture {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            overflow: hidden;
        }

        .friend-result-picture img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .friend-result-info {
            flex: 1;
        }

        .friend-result-name {
            font-weight: 600;
            color: #333;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .friend-result-email {
            color: #718096;
            font-size: 0.9em;
        }

        .friend-result-actions {
            display: flex;
            gap: 10px;
        }

        .send-request-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .send-request-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(72, 187, 120, 0.4);
        }

        .send-request-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        /* Estilos para modal de bandeja */
        .inbox-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            animation: fadeIn 0.3s ease;
        }

        .inbox-modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        .inbox-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .inbox-modal-header h2 {
            margin: 0;
            color: #333;
            font-size: 1.8em;
        }

        .inbox-modal-close {
            background: #f56565;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .inbox-modal-close:hover {
            background: #e53e3e;
            transform: rotate(90deg);
        }

        .inbox-requests {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .inbox-request-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .inbox-request-actions {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }

        .accept-request-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .accept-request-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(72, 187, 120, 0.4);
        }

        .reject-request-btn {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .reject-request-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(245, 101, 101, 0.4);
        }

        .profile-logout-btn {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(245, 101, 101, 0.4);
            width: 100%;
            margin-top: 10px;
        }

        .profile-logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 101, 101, 0.6);
        }

        /* Estilos para información de usuario */
        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #f7fafc;
            border-radius: 10px;
        }

        .user-name {
            font-weight: 600;
            color: #667eea;
            font-size: 1.1em;
        }

        .logout-btn {
            background: #f56565;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .logout-btn:hover {
            transform: scale(1.05);
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }

            .title-container {
                flex-wrap: wrap;
                gap: 10px;
            }

            h1 {
                font-size: 1.8em;
                flex: 1 1 100%;
                text-align: center;
            }

            /* En móvil, el círculo de perfil va a la esquina superior derecha */
            .profile-picture-container {
                position: fixed !important;
                top: 15px !important;
                right: 15px !important;
                left: auto !important;
                z-index: 1000 !important;
                margin: 0 !important;
            }

            .profile-picture-circle {
                width: 50px;
                height: 50px;
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.5);
            }

            .profile-picture-placeholder {
                font-size: 1.5em;
            }

            .flag {
                font-size: 6em;
            }

            .auth-box {
                padding: 30px 20px;
            }

            /* Estilos responsive para modal de búsqueda de amigos */
            .friends-modal-content {
                padding: 20px 15px;
                width: 95%;
                max-height: 95vh;
            }

            .friends-modal-header {
                margin-bottom: 15px;
                padding-bottom: 10px;
            }

            .friends-modal-header h2 {
                font-size: 1.4em;
            }

            .friends-search-container {
                flex-direction: column;
                gap: 10px;
            }

            .friends-search-input {
                width: 100%;
                padding: 10px 12px;
                font-size: 0.95em;
            }

            .friends-search-btn {
                width: 100%;
                padding: 10px 20px;
            }

            .friend-result-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
                padding: 12px;
            }

            .friend-result-picture {
                width: 45px;
                height: 45px;
            }

            .friend-result-info {
                width: 100%;
            }

            .friend-result-name {
                font-size: 1em;
            }

            .friend-result-email {
                font-size: 0.85em;
            }

            .friend-result-actions {
                width: 100%;
                justify-content: flex-end;
            }

            .send-request-btn {
                padding: 8px 16px;
                font-size: 0.85em;
            }

            /* Estilos responsive para modal de bandeja */
            .inbox-modal-content {
                padding: 20px 15px;
                width: 95%;
                max-height: 95vh;
            }

            .inbox-modal-header {
                margin-bottom: 15px;
                padding-bottom: 10px;
            }

            .inbox-modal-header h2 {
                font-size: 1.4em;
            }

            .inbox-request-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
                padding: 12px;
            }

            .inbox-request-actions {
                width: 100%;
                justify-content: flex-end;
                margin-left: 0;
            }

            .accept-request-btn,
            .reject-request-btn {
                padding: 8px 16px;
                font-size: 0.85em;
            }

            /* Estilos responsive para modal de perfil de amigo */
            .friend-profile-modal-content {
                padding: 20px 15px;
                width: 95%;
                max-height: 95vh;
            }

            .friend-profile-modal-header {
                margin-bottom: 15px;
                padding-bottom: 10px;
            }

            .friend-profile-modal-header h2 {
                font-size: 1.4em;
            }

            .friend-profile-picture-large {
                width: 120px;
                height: 120px;
            }

            .friend-profile-picture-large-placeholder {
                font-size: 4em;
            }
        }

        /* Estilos para chat integrado en el perfil */
        .profile-active-chat {
            width: 100%;
            margin-top: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            max-height: 500px;
            transition: all 0.3s ease;
            position: relative;
            z-index: 10;
        }

        .profile-active-chat.minimized {
            max-height: 60px;
            overflow: hidden;
        }

        .profile-active-chat.minimized .active-chat-messages,
        .profile-active-chat.minimized .active-chat-input-container {
            display: none;
        }

        .profile-active-chat.minimized .active-chat-header {
            border-radius: 15px;
        }

        .active-chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px 15px 0 0;
            cursor: pointer;
            transition: border-radius 0.3s ease;
        }

        .active-chat-header-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .active-chat-header-picture {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .active-chat-header-picture img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .active-chat-header-name {
            color: white;
            font-weight: 600;
            font-size: 1.1em;
        }

        .active-chat-minimize {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .active-chat-minimize:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .active-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 350px;
            min-height: 200px;
        }

        .active-chat-message {
            display: flex;
            gap: 10px;
            max-width: 85%;
            animation: messageSlideIn 0.3s ease;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .active-chat-message.sent {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .active-chat-message.received {
            align-self: flex-start;
        }

        .active-chat-message-picture {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 1.2em;
            overflow: hidden;
        }
        
        .active-chat-message-picture img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .active-chat-message.sent .active-chat-message-picture {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .active-chat-message-content {
            background: #f7fafc;
            padding: 10px 15px;
            border-radius: 15px;
            position: relative;
            word-wrap: break-word;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .active-chat-message.sent .active-chat-message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .active-chat-message.received .active-chat-message-content {
            background: #e2e8f0;
            color: #333;
        }

        .active-chat-message-time {
            font-size: 0.75em;
            margin-top: 5px;
            opacity: 0.7;
        }

        .active-chat-message.sent .active-chat-message-time {
            color: rgba(255, 255, 255, 0.8);
        }

        .active-chat-message.received .active-chat-message-time {
            color: #718096;
        }

        .active-chat-input-container {
            display: flex;
            gap: 10px;
            padding: 15px;
            border-top: 1px solid #e2e8f0;
            background: #f7fafc;
            border-radius: 0 0 15px 15px;
        }

        .active-chat-input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            font-size: 1em;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .active-chat-input:focus {
            border-color: #667eea;
        }

        .active-chat-send-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .active-chat-send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        @media (max-width: 768px) {
            /* Estilos responsive para chat */
            .profile-active-chat {
                max-height: 400px;
            }

            .active-chat-header {
                padding: 12px;
            }

            .active-chat-header-name {
                font-size: 1em;
            }

            .active-chat-header-picture {
                width: 35px;
                height: 35px;
            }

            .active-chat-messages {
                padding: 12px;
                max-height: 250px;
                min-height: 150px;
            }

            .active-chat-message {
                max-width: 85%;
            }

            .active-chat-input-container {
                padding: 10px;
            }

            .active-chat-input {
                font-size: 0.9em;
                padding: 8px 12px;
            }

            .active-chat-send-btn {
                padding: 8px 16px;
                font-size: 0.9em;
            }

            .chat-item {
                padding: 10px;
            }

            .chat-item-picture {
                width: 40px;
                height: 40px;
            }

            .friend-item-message {
                width: 28px;
                height: 28px;
                font-size: 0.75em;
                right: 40px;
            }
        }
    </style>
</head>
<body>
    <!-- Overlay de fuego para modo imposible -->
    <div class="hell-overlay" id="hellOverlay">
        <div class="flame"></div>
        <div class="flame"></div>
        <div class="flame"></div>
        <div class="flame"></div>
        <div class="flame"></div>
    </div>
    <div class="hell-particles" id="hellParticles"></div>
    
    <!-- Overlay de batalla para modo difícil -->
    <div class="war-overlay" id="warOverlay"></div>
    
    <!-- Overlay de naturaleza para modo fácil -->
    <div class="nature-overlay" id="natureOverlay">
        <div class="wave"></div>
        <div class="wave" style="animation-delay: 1s;"></div>
    </div>
    
    <!-- Overlay galáctico para modo Dios -->
    <div class="galactic-overlay" id="galacticOverlay"></div>
    <!-- Pantalla de Login/Registro -->
    <div class="auth-container" id="authContainer">
        <div class="auth-box">
            <h2>🏳️ Juego de Banderas</h2>
            <div class="auth-tabs">
                <button class="auth-tab active" id="loginTab">Iniciar Sesión</button>
                <button class="auth-tab" id="registerTab">Registrarse</button>
            </div>
            
            <div class="auth-form" id="loginForm">
                <input type="email" id="loginEmail" placeholder="Correo electrónico" class="auth-input">
                <input type="password" id="loginPassword" placeholder="Contraseña" class="auth-input">
                <button class="auth-btn" id="loginBtn">Iniciar Sesión</button>
                <div class="auth-message" id="loginMessage"></div>
            </div>
            
            <div class="auth-form" id="registerForm" style="display: none;">
                <input type="text" id="registerName" placeholder="Nombre de usuario" class="auth-input" maxlength="20">
                <input type="email" id="registerEmail" placeholder="Correo electrónico" class="auth-input">
                <input type="password" id="registerPassword" placeholder="Contraseña (mín. 6 caracteres)" class="auth-input">
                <button class="auth-btn" id="registerBtn">Registrarse</button>
                <div class="auth-message" id="registerMessage"></div>
            </div>
        </div>
    </div>

    <!-- Modal de perfil -->
    <div class="profile-modal" id="profileModal" style="display: none;">
        <div class="profile-modal-content">
            <div class="profile-modal-header">
                <h2>👤 Mi Perfil</h2>
                <button class="profile-modal-close" id="profileModalClose">✕</button>
            </div>
            <div class="profile-modal-body">
                <div class="profile-picture-large-container">
                    <div class="profile-picture-large" id="profilePictureLarge">
                        <img id="profilePictureLargeImg" src="" alt="Foto de perfil" style="display: none;">
                        <div class="profile-picture-large-placeholder" id="profilePictureLargePlaceholder">👤</div>
                    </div>
                    <label for="profilePictureInput" class="profile-upload-btn">
                        📷 Cambiar Foto
                    </label>
                    <input type="file" id="profilePictureInput" accept="image/*" style="display: none;">
                </div>
                <div class="profile-info">
                    <div class="profile-info-item">
                        <span class="profile-info-label">Nombre:</span>
                        <span class="profile-info-value" id="profileName">-</span>
                    </div>
                    <div class="profile-info-item">
                        <span class="profile-info-label">Email:</span>
                        <span class="profile-info-value" id="profileEmail">-</span>
                    </div>
                    <div class="profile-info-item profile-description-item">
                        <span class="profile-info-label">Descripción:</span>
                        <textarea id="profileDescription" class="profile-description-input" placeholder="Escribe una descripción sobre ti..." maxlength="500"></textarea>
                        <button class="profile-save-description-btn" id="profileSaveDescriptionBtn">💾 Guardar Descripción</button>
                    </div>
                </div>
                <div class="profile-actions">
                    <button class="profile-save-btn" id="profileSaveBtn" style="display: none;">💾 Guardar Cambios</button>
                    <button class="profile-toggle-scores-btn" id="profileToggleScoresBtn">📊 Mostrar Puntuaciones</button>
                    <button class="profile-friends-btn" id="profileFriendsBtn">👥 Añadir Amigos</button>
                    <button class="profile-inbox-btn" id="profileInboxBtn">📬 Bandeja de Solicitudes</button>
                    <div class="profile-scores-section" id="profileScoresSection" style="display: none;">
                        <h3>Mis Puntuaciones Máximas</h3>
                        <div class="scores-list" id="scoresList"></div>
                    </div>
                    <div class="profile-friends-section" id="profileFriendsSection" style="display: none;">
                        <h3>Mis Amigos</h3>
                        <div class="friends-list" id="friendsList"></div>
                    </div>
                    <div class="profile-active-chat" id="profileActiveChat" style="display: none;">
                        <div class="active-chat-header">
                            <div class="active-chat-header-info">
                                <div class="active-chat-header-picture" id="activeChatHeaderPicture">
                                    <div style="font-size: 1.2em;">👤</div>
                                </div>
                                <div class="active-chat-header-name" id="activeChatHeaderName">Amigo</div>
                            </div>
                            <button class="active-chat-minimize" id="activeChatMinimize">➖</button>
                        </div>
                        <div class="active-chat-messages" id="activeChatMessages"></div>
                        <div class="active-chat-input-container">
                            <input type="text" id="activeChatInput" class="active-chat-input" placeholder="Escribe un mensaje..." maxlength="500">
                            <button class="active-chat-send-btn" id="activeChatSendBtn">Enviar</button>
                        </div>
                    </div>
                    <div class="profile-chats-section" id="profileChatsSection" style="display: none;">
                        <h3>💬 Chats</h3>
                        <div class="chats-list" id="chatsList"></div>
                    </div>
                    <div class="profile-library-section" id="profileLibrarySection">
                        <h3>📚 BIBLIOTECA</h3>
                        <div class="library-upload-container">
                            <label for="libraryImageInput" class="library-upload-btn">📷 Añadir Foto</label>
                            <input type="file" id="libraryImageInput" accept="image/*" multiple style="display: none;">
                        </div>
                        <div class="library-grid" id="libraryGrid"></div>
                    </div>
                    <button class="profile-logout-btn" id="profileLogoutBtn">🚪 Cerrar Sesión</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para ver imagen de biblioteca en grande -->
    <div class="library-image-modal" id="libraryImageModal">
        <div class="library-image-modal-content">
            <button class="library-image-modal-close" id="libraryImageModalClose">✕</button>
            <div class="library-image-container" id="libraryImageContainer">
                <img id="libraryImageModalImg" src="" alt="Imagen">
            </div>
            <div class="library-image-interactions">
                <div class="library-image-likes">
                    <button class="like-btn" id="libraryImageLikeBtn">
                        <span class="like-icon">❤️</span>
                        <span class="like-count" id="libraryImageLikeCount">0</span>
                    </button>
                </div>
                <div class="library-image-comments">
                    <h4>Comentarios</h4>
                    <div class="comments-list" id="libraryImageCommentsList"></div>
                    <div class="comment-input-container">
                        <input type="text" id="libraryImageCommentInput" placeholder="Escribe un comentario..." class="comment-input">
                        <button class="comment-submit-btn" id="libraryImageCommentSubmit">Enviar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para vista ampliada de la imagen -->
    <div class="library-image-zoom-modal" id="libraryImageZoomModal">
        <button class="library-image-zoom-close-back" id="libraryImageZoomCloseBack" title="Volver a comentarios">←</button>
        <button class="library-image-zoom-close-all" id="libraryImageZoomCloseAll" title="Cerrar">✕</button>
        <div class="library-image-zoom-container">
            <img id="libraryImageZoomImg" src="" alt="Imagen ampliada">
        </div>
    </div>

    <!-- Modal de búsqueda de amigos -->
    <div class="friends-modal" id="friendsModal" style="display: none;">
        <div class="friends-modal-content">
            <div class="friends-modal-header">
                <h2>👥 Buscar Amigos</h2>
                <button class="friends-modal-close" id="friendsModalClose">✕</button>
            </div>
            <div class="friends-modal-body">
                <div class="friends-search-container">
                    <input type="text" id="friendsSearchInput" class="friends-search-input" placeholder="Buscar por nombre...">
                    <button class="friends-search-btn" id="friendsSearchBtn">🔍 Buscar</button>
                </div>
                <div class="friends-results" id="friendsResults"></div>
            </div>
        </div>
    </div>

    <!-- Modal de solicitudes recibidas -->
    <div class="inbox-modal" id="inboxModal" style="display: none;">
        <div class="inbox-modal-content">
            <div class="inbox-modal-header">
                <h2>📬 Solicitudes de Amistad</h2>
                <button class="inbox-modal-close" id="inboxModalClose">✕</button>
            </div>
            <div class="inbox-modal-body">
                <div class="inbox-requests" id="inboxRequests"></div>
            </div>
        </div>
    </div>

    <!-- Modal de perfil de amigo -->
    <div class="friend-profile-modal" id="friendProfileModal" style="display: none;">
        <div class="friend-profile-modal-content">
            <div class="friend-profile-modal-header">
                <h2>👤 Perfil de Amigo</h2>
                <button class="friend-profile-modal-close" id="friendProfileModalClose">✕</button>
            </div>
            <div class="friend-profile-modal-body">
                <div class="friend-profile-picture-large-container">
                    <div class="friend-profile-picture-large" id="friendProfilePictureLarge">
                        <img id="friendProfilePictureLargeImg" src="" alt="Foto de perfil" style="display: none;">
                        <div class="friend-profile-picture-large-placeholder" id="friendProfilePictureLargePlaceholder">👤</div>
                    </div>
                </div>
                <div class="friend-profile-info">
                    <div class="friend-profile-info-item">
                        <span class="friend-profile-info-label">Nombre:</span>
                        <span class="friend-profile-info-value" id="friendProfileName">-</span>
                    </div>
                    <div class="friend-profile-info-item">
                        <span class="friend-profile-info-label">Email:</span>
                        <span class="friend-profile-info-value" id="friendProfileEmail">-</span>
                    </div>
                    <div class="friend-profile-info-item friend-description-item" id="friendDescriptionItem" style="display: none;">
                        <span class="friend-profile-info-label">Descripción:</span>
                        <div class="friend-profile-description" id="friendProfileDescription">-</div>
                    </div>
                </div>
                <div class="friend-profile-actions" id="friendProfileActions">
                    <button class="remove-friend-btn" id="removeFriendBtn">🗑️ Eliminar Amigo</button>
                </div>
                <div class="friend-library-section" id="friendLibrarySection" style="display: none;">
                    <h3>📚 BIBLIOTECA</h3>
                    <div class="friend-library-grid" id="friendLibraryGrid"></div>
                </div>
                <div class="friend-profile-scores-section" id="friendProfileScoresSection" style="display: none;">
                    <h3>Puntuaciones Máximas</h3>
                    <div class="friend-scores-list" id="friendScoresList"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="container" id="gameContainer" style="display: none;">
        <div class="user-info" style="display: none;">
            <div class="user-name" id="userNameDisplay">Usuario</div>
            <button class="logout-btn" id="logoutBtn" style="display: none;">Cerrar Sesión</button>
        </div>
        <div class="title-container">
        <h1>🏳️ Adivina la Bandera</h1>
            <div class="profile-picture-container" id="profilePictureContainer" style="display: none;">
                <div class="profile-picture-circle" id="profilePictureCircle">
                    <img id="profilePictureImg" src="" alt="Foto de perfil" style="display: none;">
                    <div class="profile-picture-placeholder" id="profilePicturePlaceholder">👤</div>
                </div>
            </div>
        </div>
        <div class="lives-container">
            <div class="lives-text">Vidas:</div>
            <div class="hearts" id="hearts">❤️ ❤️ ❤️</div>
        </div>
        <div class="score">Puntuación: <span id="score">0</span></div>
        <div class="streak-container">
            <div class="streak-fire" id="streakFire">🔥</div>
            <div class="streak-text">Racha: <span id="streak">0</span></div>
            <button class="joker-btn-inline" id="jokerBtn" style="display: none;">🎯 Comodín</button>
        </div>
        
        <div class="flag-container">
            <div class="flag" id="flag">🏳️</div>
        </div>

        <!-- Contador de tiempo -->
        <div class="timer-container" id="timerContainer" style="display: none;">
            <div class="timer-circle">
                <svg class="timer-svg" viewBox="0 0 100 100">
                    <circle class="timer-circle-bg" cx="50" cy="50" r="45"></circle>
                    <circle class="timer-circle-progress" cx="50" cy="50" r="45" id="timerProgress"></circle>
                </svg>
                <div class="timer-text" id="timerText">20</div>
            </div>
        </div>

        <!-- Botón para ver ranking -->
        <button class="view-ranking-btn" id="viewRankingBtn" style="display: none;">📊 Ver Tabla de Ranking</button>

        <!-- Ranking principal -->
        <div class="main-ranking-container" id="mainRankingContainer" style="display: none;">
            <div class="ranking-header">
                <h2 id="rankingTitle">🏆 Top 10 Ranking</h2>
                <button class="close-ranking-btn" id="closeRankingBtn">✕</button>
            </div>
            <div class="main-ranking-list" id="mainRankingList">
                <div style="text-align: center; padding: 20px; color: #718096;">Cargando ranking...</div>
            </div>
        </div>

        <div class="difficulty-selector" id="difficultySelector">
            <h2>Selecciona el nivel de dificultad</h2>
            <div class="difficulty-buttons">
                <button class="difficulty-btn easy" id="easyBtn">🟢 Fácil<br><small>Países de Europa</small></button>
                <button class="difficulty-btn hard" id="hardBtn">🔴 Difícil<br><small>Todos los países</small></button>
                <button class="difficulty-btn impossible" id="impossibleBtn">⚫ Imposible<br><small>Islas y paraísos fiscales</small></button>
                <button class="difficulty-btn god" id="godBtn">✨ Dios<br><small>Tribus y pueblos indígenas</small></button>
            </div>
            <div class="ranking-buttons-container">
                <h3 style="margin: 30px 0 15px 0; color: #667eea; font-size: 1.3em;">📊 Ver Clasificaciones</h3>
                <div class="ranking-buttons">
                    <button class="ranking-btn ranking-btn-easy" id="viewRankingEasyBtn">🏆 Clasificación Fácil</button>
                    <button class="ranking-btn ranking-btn-hard" id="viewRankingHardBtn">🏆 Clasificación Difícil</button>
                    <button class="ranking-btn ranking-btn-impossible" id="viewRankingImpossibleBtn">🏆 Clasificación Imposible</button>
                    <button class="ranking-btn ranking-btn-god" id="viewRankingGodBtn">🏆 Clasificación Dios</button>
                </div>
                <div class="difficulty-ranking-container" id="difficultyRankingContainer" style="display: none;">
                    <h3 id="difficultyRankingTitle" style="margin: 30px 0 15px 0; color: #667eea; font-size: 1.5em; text-align: center;"></h3>
                    <div class="difficulty-ranking-list" id="difficultyRankingList"></div>
                </div>
            </div>
        </div>

        <div class="loading" id="loading" style="display: none;">Cargando...</div>

        <div class="options" id="options" style="display: none;">
            <button class="option" id="option1"></button>
            <button class="option" id="option2"></button>
            <button class="option" id="option3"></button>
            <button class="option" id="option4"></button>
        </div>

        <!-- Botón para terminar intento -->
        <button class="end-attempt-btn" id="endAttemptBtn" style="display: none;">⛔ Terminar Intento</button>


        <div class="message" id="message"></div>
        <button class="next-btn" id="nextBtn">Siguiente Bandera</button>

        <!-- Pantalla de Game Over -->
        <div class="game-over" id="gameOver" style="display: none;">
            <div class="game-over-content">
                <h2>💀 Has Perdido</h2>
                <div class="game-over-stats">
                    <div class="stat-item">
                        <div class="stat-label">Puntuación Total</div>
                        <div class="stat-value" id="finalScore">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Máxima Racha</div>
                        <div class="stat-value" id="maxStreak">0</div>
                    </div>
                </div>
                <div class="name-input-container" id="nameInputContainer" style="display: none;">
                    <button class="save-score-btn" id="saveScoreBtn">💾 Guardar Puntuación</button>
                </div>
                <div class="ranking-container" id="rankingContainer" style="display: none;">
                    <h3>🏆 Top 10</h3>
                    <div class="ranking-list" id="rankingList"></div>
                </div>
                <button class="restart-btn" id="restartBtn">🔄 Jugar de Nuevo</button>
                <button class="show-ranking-btn" id="showRankingBtn" style="display: none;">📊 Ver Ranking</button>
            </div>
        </div>
    </div>

    <script>
        let countries = [];
        let allCountries = [];
        let currentCountry = null;
        let score = 0;
        let streak = 0;
        let maxStreak = 0;
        let lives = 3;
        let answered = false;
        let jokerAvailable = false;
        let jokerUsed = false;
        let difficulty = null; // 'easy', 'hard', 'impossible' o 'god'
        let timerInterval = null;
        let timeLeft = 20;
        let usedCountries = []; // Para el modo Dios: países ya mostrados
        let availableCountries = []; // Para el modo Dios: países disponibles

        // Lista de países como respaldo (si la API falla)
        const fallbackCountries = [
            { name: { common: "España" }, cca2: "ES" },
            { name: { common: "Francia" }, cca2: "FR" },
            { name: { common: "Alemania" }, cca2: "DE" },
            { name: { common: "Italia" }, cca2: "IT" },
            { name: { common: "Reino Unido" }, cca2: "GB" },
            { name: { common: "Estados Unidos" }, cca2: "US" },
            { name: { common: "México" }, cca2: "MX" },
            { name: { common: "Argentina" }, cca2: "AR" },
            { name: { common: "Brasil" }, cca2: "BR" },
            { name: { common: "Chile" }, cca2: "CL" },
            { name: { common: "Colombia" }, cca2: "CO" },
            { name: { common: "Perú" }, cca2: "PE" },
            { name: { common: "Venezuela" }, cca2: "VE" },
            { name: { common: "Ecuador" }, cca2: "EC" },
            { name: { common: "Uruguay" }, cca2: "UY" },
            { name: { common: "Paraguay" }, cca2: "PY" },
            { name: { common: "Bolivia" }, cca2: "BO" },
            { name: { common: "Cuba" }, cca2: "CU" },
            { name: { common: "República Dominicana" }, cca2: "DO" },
            { name: { common: "Panamá" }, cca2: "PA" },
            { name: { common: "Costa Rica" }, cca2: "CR" },
            { name: { common: "Guatemala" }, cca2: "GT" },
            { name: { common: "Honduras" }, cca2: "HN" },
            { name: { common: "El Salvador" }, cca2: "SV" },
            { name: { common: "Nicaragua" }, cca2: "NI" },
            { name: { common: "Japón" }, cca2: "JP" },
            { name: { common: "China" }, cca2: "CN" },
            { name: { common: "India" }, cca2: "IN" },
            { name: { common: "Rusia" }, cca2: "RU" },
            { name: { common: "Canadá" }, cca2: "CA" },
            { name: { common: "Australia" }, cca2: "AU" },
            { name: { common: "Nueva Zelanda" }, cca2: "NZ" },
            { name: { common: "Sudáfrica" }, cca2: "ZA" },
            { name: { common: "Egipto" }, cca2: "EG" },
            { name: { common: "Marruecos" }, cca2: "MA" },
            { name: { common: "Turquía" }, cca2: "TR" },
            { name: { common: "Grecia" }, cca2: "GR" },
            { name: { common: "Portugal" }, cca2: "PT" },
            { name: { common: "Países Bajos" }, cca2: "NL" },
            { name: { common: "Bélgica" }, cca2: "BE" },
            { name: { common: "Suiza" }, cca2: "CH" },
            { name: { common: "Austria" }, cca2: "AT" },
            { name: { common: "Suecia" }, cca2: "SE" },
            { name: { common: "Noruega" }, cca2: "NO" },
            { name: { common: "Dinamarca" }, cca2: "DK" },
            { name: { common: "Finlandia" }, cca2: "FI" },
            { name: { common: "Polonia" }, cca2: "PL" },
            { name: { common: "República Checa" }, cca2: "CZ" },
            { name: { common: "Hungría" }, cca2: "HU" },
            { name: { common: "Rumania" }, cca2: "RO" },
            { name: { common: "Bulgaria" }, cca2: "BG" },
            { name: { common: "Croacia" }, cca2: "HR" },
            { name: { common: "Serbia" }, cca2: "RS" },
            { name: { common: "Ucrania" }, cca2: "UA" },
            { name: { common: "Israel" }, cca2: "IL" },
            { name: { common: "Arabia Saudí" }, cca2: "SA" },
            { name: { common: "Irán" }, cca2: "IR" },
            { name: { common: "Irak" }, cca2: "IQ" },
            { name: { common: "Pakistán" }, cca2: "PK" },
            { name: { common: "Bangladesh" }, cca2: "BD" },
            { name: { common: "Tailandia" }, cca2: "TH" },
            { name: { common: "Vietnam" }, cca2: "VN" },
            { name: { common: "Corea del Sur" }, cca2: "KR" },
            { name: { common: "Corea del Norte" }, cca2: "KP" },
            { name: { common: "Filipinas" }, cca2: "PH" },
            { name: { common: "Indonesia" }, cca2: "ID" },
            { name: { common: "Malasia" }, cca2: "MY" },
            { name: { common: "Singapur" }, cca2: "SG" }
        ];

        // Aplicar filtro según dificultad
        function applyDifficultyFilter() {
            if (difficulty === 'easy') {
                // Fácil: Solo países de Europa
                countries = allCountries.filter(country => {
                    const region = country.region || '';
                    const subregion = country.subregion || '';
                    // Filtrar por región Europa o subregión de Europa
                    return region === 'Europe' || 
                           subregion === 'Northern Europe' ||
                           subregion === 'Southern Europe' ||
                           subregion === 'Eastern Europe' ||
                           subregion === 'Western Europe' ||
                           // También incluir algunos países conocidos por código
                           ['ES', 'FR', 'DE', 'IT', 'GB', 'PT', 'NL', 'BE', 'CH', 'AT',
                            'SE', 'NO', 'DK', 'FI', 'PL', 'CZ', 'HU', 'RO', 'BG', 'HR',
                            'RS', 'UA', 'GR', 'IE', 'IS', 'LU', 'SK', 'SI', 'EE', 'LV',
                            'LT', 'MT', 'CY'].includes(country.cca2);
                });
                
                // Si no hay suficientes países europeos, usar los de la lista de respaldo que sean europeos
                if (countries.length < 10) {
                    const europeanFallback = fallbackCountries.filter(c => 
                        ['ES', 'FR', 'DE', 'IT', 'GB', 'PT', 'NL', 'BE', 'CH', 'AT',
                         'SE', 'NO', 'DK', 'FI', 'PL', 'CZ', 'HU', 'RO', 'BG', 'HR',
                         'RS', 'UA', 'GR'].includes(c.cca2)
                    );
                    countries = europeanFallback.length > 0 ? europeanFallback : countries;
                }
            } else if (difficulty === 'hard') {
                // Difícil: Todos los países (excluyendo los más conocidos de Europa para hacerlo más difícil)
                const wellKnownEuropean = ['ES', 'FR', 'DE', 'IT', 'GB', 'PT', 'NL', 'BE', 'CH', 'AT',
                                         'SE', 'NO', 'DK', 'FI', 'PL', 'GR', 'IE', 'IS', 'US', 'CA',
                                         'MX', 'BR', 'AR', 'CL', 'CO', 'PE', 'JP', 'CN', 'IN', 'RU',
                                         'AU', 'NZ', 'ZA'];
                countries = allCountries.filter(country => 
                    !wellKnownEuropean.includes(country.cca2)
                );
                
                // Si no hay suficientes, usar todos
                if (countries.length < 20) {
                    countries = allCountries;
                }
            } else if (difficulty === 'impossible') {
                // Imposible: Islas pequeñas y paraísos fiscales
                const smallIslandsAndTaxHavens = [
                    // Islas del Caribe
                    'AG', 'BS', 'BB', 'VG', 'KY', 'DM', 'GD', 'JM', 'KN', 'LC', 'VC', 'TT', 'TC',
                    // Islas del Pacífico
                    'CK', 'FJ', 'KI', 'MH', 'FM', 'NR', 'NU', 'PW', 'PG', 'WS', 'SB', 'TO', 'TV', 'VU',
                    // Islas del Océano Índico
                    'MV', 'MU', 'SC', 'KM',
                    // Otras islas pequeñas
                    'AD', 'AW', 'BH', 'BN', 'CV', 'CY', 'FO', 'GG', 'GI', 'GL', 'GP', 'GU', 'IM', 'JE',
                    'LI', 'MC', 'MQ', 'MT', 'MP', 'NC', 'PF', 'PM', 'PN', 'PR', 'RE', 'SH', 'SJ',
                    'SM', 'ST', 'SX', 'TF', 'TK', 'TL', 'VA', 'VI', 'WF', 'YT',
                    // Paraísos fiscales y microestados
                    'AI', 'AS', 'AX', 'BL', 'BM', 'BQ', 'BV', 'CC', 'CD', 'CW', 'CX', 'EH', 'FK',
                    'GF', 'GS', 'HK', 'HM', 'IO', 'MF', 'MO', 'MS', 'NF', 'PS', 'PW', 'QA', 'SG',
                    'SX', 'UM', 'VG', 'VI', 'XK'
                ];
                
                countries = allCountries.filter(country => {
                    const code = country.cca2 || '';
                    const region = country.region || '';
                    const subregion = country.subregion || '';
                    const population = country.population || 0;
                    
                    // Filtrar por código de islas pequeñas y paraísos fiscales
                    if (smallIslandsAndTaxHavens.includes(code)) {
                        return true;
                    }
                    
                    // INCLUIR TODOS LOS PAÍSES DE OCEANÍA
                    if (region === 'Oceania') {
                        return true;
                    }
                    
                    // INCLUIR PAÍSES PEQUEÑOS DE ÁFRICA (población menor a 10 millones)
                    if (region === 'Africa' && population > 0 && population < 10000000) {
                        return true;
                    }
                    
                    // Filtrar islas con población pequeña (menos de 1 millón)
                    if (population > 0 && population < 1000000) {
                        // Verificar si es una isla (no tiene fronteras terrestres o es pequeña)
                        const borders = country.borders || [];
                        if (borders.length === 0 || subregion.includes('Island') || subregion.includes('Caribbean')) {
                            return true;
                        }
                    }
                    
                    // Incluir microestados y territorios insulares
                    if (subregion === 'Caribbean' || subregion === 'Polynesia' || 
                        subregion === 'Micronesia' || subregion === 'Melanesia') {
                        return true;
                    }
                    
                    // INCLUIR PAÍSES PEQUEÑOS DE ASIA (población menor a 5 millones)
                    if (region === 'Asia' && population > 0 && population < 5000000) {
                        return true;
                    }
                    
                    // INCLUIR PAÍSES PEQUEÑOS DE AMÉRICA (población menor a 2 millones, excluyendo grandes países)
                    if ((region === 'Americas' || region === 'North America' || region === 'South America') && 
                        population > 0 && population < 2000000) {
                        // Excluir países grandes conocidos
                        const excludedCodes = ['US', 'CA', 'MX', 'BR', 'AR', 'CL', 'CO', 'PE', 'VE'];
                        if (!excludedCodes.includes(code)) {
                            return true;
                        }
                    }
                    
                    return false;
                });
                
                // Si no hay suficientes, agregar algunos de la lista de respaldo
                if (countries.length < 10) {
                    const impossibleFallback = [
                        // Microestados y países ultra-pequeños
                        { name: { common: "Nauru" }, cca2: "NR" },
                        { name: { common: "Tuvalu" }, cca2: "TV" },
                        { name: { common: "Kiribati" }, cca2: "KI" },
                        { name: { common: "Santo Tomé y Príncipe" }, cca2: "ST" },
                        { name: { common: "Comoras" }, cca2: "KM" },
                        { name: { common: "Yibuti" }, cca2: "DJ" },
                        { name: { common: "Timor Oriental" }, cca2: "TL" },
                        { name: { common: "Eritrea" }, cca2: "ER" },
                        // Islas y Oceanía
                        { name: { common: "Maldivas" }, cca2: "MV" },
                        { name: { common: "Mauricio" }, cca2: "MU" },
                        { name: { common: "Seychelles" }, cca2: "SC" },
                        { name: { common: "Bahamas" }, cca2: "BS" },
                        { name: { common: "Barbados" }, cca2: "BB" },
                        { name: { common: "Jamaica" }, cca2: "JM" },
                        { name: { common: "Trinidad y Tobago" }, cca2: "TT" },
                        { name: { common: "Fiyi" }, cca2: "FJ" },
                        { name: { common: "Papúa Nueva Guinea" }, cca2: "PG" },
                        { name: { common: "Samoa" }, cca2: "WS" },
                        { name: { common: "Tonga" }, cca2: "TO" },
                        { name: { common: "Vanuatu" }, cca2: "VU" },
                        { name: { common: "Cabo Verde" }, cca2: "CV" },
                        { name: { common: "Malta" }, cca2: "MT" },
                        { name: { common: "Chipre" }, cca2: "CY" },
                        { name: { common: "Islandia" }, cca2: "IS" },
                        { name: { common: "Antigua y Barbuda" }, cca2: "AG" },
                        { name: { common: "Granada" }, cca2: "GD" },
                        { name: { common: "San Vicente y las Granadinas" }, cca2: "VC" },
                        { name: { common: "Santa Lucía" }, cca2: "LC" },
                        { name: { common: "San Cristóbal y Nieves" }, cca2: "KN" },
                        { name: { common: "Dominica" }, cca2: "DM" },
                        // Islas remotas y territorios dependientes
                        { name: { common: "Tokelau" }, cca2: "TK" },
                        { name: { common: "Niue" }, cca2: "NU" },
                        { name: { common: "Islas Cocos" }, cca2: "CC" },
                        { name: { common: "Isla Norfolk" }, cca2: "NF" },
                        { name: { common: "Islas Pitcairn" }, cca2: "PN" },
                        { name: { common: "Islas Åland" }, cca2: "AX" },
                        { name: { common: "San Bartolomé" }, cca2: "BL" },
                        { name: { common: "Wallis y Futuna" }, cca2: "WF" },
                        { name: { common: "Mayotte" }, cca2: "YT" },
                        { name: { common: "Nueva Caledonia" }, cca2: "NC" },
                        // Territorios no reconocidos / parcialmente reconocidos
                        { name: { common: "Kosovo" }, cca2: "XK" },
                        // Regiones con bandera propia
                        { name: { common: "Isla de Man" }, cca2: "IM" },
                        { name: { common: "Guernsey" }, cca2: "GG" },
                        { name: { common: "Jersey" }, cca2: "JE" },
                        { name: { common: "Gibraltar" }, cca2: "GI" },
                        // Islas y territorios británicos
                        { name: { common: "Montserrat" }, cca2: "MS" },
                        { name: { common: "Anguila" }, cca2: "AI" },
                        { name: { common: "Islas Vírgenes Británicas" }, cca2: "VG" },
                        { name: { common: "Santa Helena" }, cca2: "SH" },
                        { name: { common: "Islas Turcas y Caicos" }, cca2: "TC" },
                        // Paraísos fiscales
                        { name: { common: "Islas Caimán" }, cca2: "KY" },
                        { name: { common: "Islas Cook" }, cca2: "CK" },
                        // Países pequeños de África
                        { name: { common: "Guinea-Bisáu" }, cca2: "GW" },
                        { name: { common: "Guinea Ecuatorial" }, cca2: "GQ" },
                        { name: { common: "Gambia" }, cca2: "GM" },
                        { name: { common: "Lesoto" }, cca2: "LS" },
                        { name: { common: "Suazilandia" }, cca2: "SZ" },
                        { name: { common: "Gabón" }, cca2: "GA" },
                        { name: { common: "Guinea" }, cca2: "GN" },
                        { name: { common: "Sierra Leona" }, cca2: "SL" },
                        { name: { common: "Togo" }, cca2: "TG" },
                        { name: { common: "Benín" }, cca2: "BJ" },
                        { name: { common: "Burkina Faso" }, cca2: "BF" },
                        { name: { common: "Malí" }, cca2: "ML" },
                        { name: { common: "Níger" }, cca2: "NE" },
                        { name: { common: "Chad" }, cca2: "TD" },
                        { name: { common: "República Centroafricana" }, cca2: "CF" },
                        { name: { common: "Burundi" }, cca2: "BI" },
                        { name: { common: "Ruanda" }, cca2: "RW" },
                        // Países de Oceanía adicionales
                        { name: { common: "Polinesia Francesa" }, cca2: "PF" },
                        { name: { common: "Guam" }, cca2: "GU" },
                        { name: { common: "Islas Marianas del Norte" }, cca2: "MP" },
                        { name: { common: "Palau" }, cca2: "PW" },
                        { name: { common: "Micronesia" }, cca2: "FM" },
                        { name: { common: "Islas Marshall" }, cca2: "MH" },
                        { name: { common: "Islas Salomón" }, cca2: "SB" },
                        { name: { common: "Nueva Zelanda" }, cca2: "NZ" }
                    ];
                    countries = impossibleFallback.length > 0 ? impossibleFallback : countries;
                }
            } else if (difficulty === 'god') {
                // Dios: TODOS los países sin filtros (examen completo de todas las banderas)
                countries = [...allCountries]; // Usar todos los países disponibles
                
                // Inicializar arrays para tracking de países usados
                availableCountries = [...allCountries];
                usedCountries = [];
                
                console.log(`Modo Dios: ${countries.length} países cargados (examen completo sin repeticiones)`);
                return; // Salir temprano, no aplicar más filtros
            } else if (difficulty === 'god_old') {
                // Código anterior (tribus) - desactivado
                const tribalCountries = [
                    // Países con poblaciones indígenas significativas
                    'BO', 'PE', 'EC', 'GT', 'MX', 'PY', 'BR', 'CL', 'AR', 'CO', 'VE', 'PA', 'CR', 'HN', 'NI', 'SV',
                    // Países de África con tribus
                    'KE', 'TZ', 'UG', 'RW', 'ET', 'SD', 'SS', 'CM', 'CF', 'TD', 'NE', 'ML', 'BF', 'SN', 'GN', 'SL',
                    'LR', 'CI', 'GH', 'TG', 'BJ', 'NG', 'GA', 'CG', 'CD', 'AO', 'ZM', 'ZW', 'BW', 'NA', 'MW', 'MZ',
                    'MG', 'SO', 'DJ', 'ER', 'LY', 'TN', 'DZ', 'MA', 'MR', 'ML',
                    // Países de Asia con tribus
                    'MM', 'TH', 'LA', 'KH', 'VN', 'PH', 'ID', 'MY', 'BN', 'TL', 'PG', 'FJ', 'SB', 'VU', 'NC', 'PF',
                    // Países de Oceanía con tribus
                    'AU', 'NZ', 'PG', 'FJ', 'SB', 'VU', 'NC', 'PF', 'WS', 'TO', 'TV', 'KI', 'NR', 'PW', 'FM', 'MH',
                    // Países de América del Norte con tribus
                    'US', 'CA', 'MX', 'GT', 'BZ', 'SV', 'HN', 'NI', 'CR', 'PA',
                    // Territorios y regiones con tribus
                    'GF', 'GP', 'MQ', 'RE', 'YT', 'PF', 'NC', 'AS', 'GU', 'MP', 'VI', 'PR'
                ];
                
                countries = allCountries.filter(country => {
                    const code = country.cca2 || '';
                    const region = country.region || '';
                    const subregion = country.subregion || '';
                    
                    // Filtrar por código de países con tribus
                    if (tribalCountries.includes(code)) {
                        return true;
                    }
                    
                    // Incluir países de América Latina (muchos tienen poblaciones indígenas)
                    if (region === 'Americas' && (subregion === 'South America' || subregion === 'Central America')) {
                        return true;
                    }
                    
                    // Incluir países de África subsahariana (muchos tienen tribus)
                    if (region === 'Africa' && subregion !== 'Northern Africa') {
                        return true;
                    }
                    
                    // Incluir países de Oceanía (muchos tienen pueblos indígenas)
                    if (region === 'Oceania') {
                        return true;
                    }
                    
                    // Incluir algunos países de Asia con poblaciones tribales
                    if (region === 'Asia' && (subregion === 'South-Eastern Asia' || subregion === 'Polynesia' || 
                        subregion === 'Micronesia' || subregion === 'Melanesia')) {
                        return true;
                    }
                    
                    return false;
                });
                
                // Si no hay suficientes, agregar algunos de la lista de respaldo
                if (countries.length < 10) {
                    const godFallback = [
                        { name: { common: "Bolivia" }, cca2: "BO" },
                        { name: { common: "Perú" }, cca2: "PE" },
                        { name: { common: "Ecuador" }, cca2: "EC" },
                        { name: { common: "Guatemala" }, cca2: "GT" },
                        { name: { common: "México" }, cca2: "MX" },
                        { name: { common: "Paraguay" }, cca2: "PY" },
                        { name: { common: "Papúa Nueva Guinea" }, cca2: "PG" },
                        { name: { common: "Fiyi" }, cca2: "FJ" },
                        { name: { common: "Kenya" }, cca2: "KE" },
                        { name: { common: "Tanzania" }, cca2: "TZ" },
                        { name: { common: "Uganda" }, cca2: "UG" },
                        { name: { common: "Filipinas" }, cca2: "PH" },
                        { name: { common: "Indonesia" }, cca2: "ID" },
                        { name: { common: "Malasia" }, cca2: "MY" },
                        { name: { common: "Myanmar" }, cca2: "MM" },
                        { name: { common: "Tailandia" }, cca2: "TH" },
                        { name: { common: "Laos" }, cca2: "LA" },
                        { name: { common: "Camboya" }, cca2: "KH" },
                        { name: { common: "Vietnam" }, cca2: "VN" },
                        { name: { common: "Timor Oriental" }, cca2: "TL" }
                    ];
                    countries = godFallback.length > 0 ? godFallback : countries;
                }
            }
            
            console.log(`Nivel ${difficulty}: ${countries.length} países cargados`);
        }

        // Seleccionar nivel de dificultad
        // Crear partículas de fuego (muy optimizado para mejor rendimiento)
        function createHellParticles() {
            const particlesContainer = document.getElementById('hellParticles');
            if (!particlesContainer) return;
            
            // Limpiar partículas anteriores
            particlesContainer.innerHTML = '';
            
            // Reducir a solo 5 partículas para mejor rendimiento
            for (let i = 0; i < 5; i++) {
                const particle = document.createElement('div');
                particle.className = 'hell-particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 3 + 's';
                particle.style.animationDuration = (2 + Math.random() * 2) + 's';
                particle.style.willChange = 'transform, opacity';
                particlesContainer.appendChild(particle);
            }
        }

        // Crear mini llamas que salpican (muy optimizado)
        function createSparks() {
            const overlay = document.getElementById('hellOverlay');
            if (!overlay) return;
            
            // Reducir a solo 2-3 mini llamas para mejor rendimiento
            const sparkCount = 2 + Math.floor(Math.random() * 2);
            
            for (let i = 0; i < sparkCount; i++) {
                const spark = document.createElement('div');
                spark.className = 'spark';
                spark.style.left = Math.random() * 100 + '%';
                spark.style.bottom = '0px';
                spark.style.setProperty('--spark-x', (Math.random() * 200 - 100) + 'px');
                spark.style.animationDelay = Math.random() * 0.5 + 's';
                spark.style.animationDuration = (1 + Math.random() * 0.5) + 's';
                spark.style.willChange = 'transform, opacity';
                overlay.appendChild(spark);
                
                // Remover después de la animación
                setTimeout(() => {
                    if (overlay.contains(spark)) {
                        overlay.removeChild(spark);
                    }
                }, 2000);
            }
        }

        // Crear efectos de batalla
        function createWarEffects() {
            const overlay = document.getElementById('warOverlay');
            if (!overlay) return;
            
            // Crear humo
            for (let i = 0; i < 3; i++) {
                const smoke = document.createElement('div');
                smoke.className = 'smoke';
                smoke.style.left = Math.random() * 100 + '%';
                smoke.style.bottom = '0px';
                smoke.style.animationDelay = Math.random() * 2 + 's';
                smoke.style.animationDuration = (6 + Math.random() * 4) + 's';
                overlay.appendChild(smoke);
                
                setTimeout(() => {
                    if (overlay.contains(smoke)) {
                        overlay.removeChild(smoke);
                    }
                }, 10000);
            }
            
            // Crear explosiones ocasionales
            if (Math.random() > 0.7) {
                const explosion = document.createElement('div');
                explosion.className = 'explosion';
                explosion.style.left = Math.random() * 80 + 10 + '%';
                explosion.style.top = Math.random() * 50 + 20 + '%';
                overlay.appendChild(explosion);
                
                setTimeout(() => {
                    if (overlay.contains(explosion)) {
                        overlay.removeChild(explosion);
                    }
                }, 1000);
            }
            
            // Crear proyectiles
            for (let i = 0; i < 2; i++) {
                const bullet = document.createElement('div');
                bullet.className = 'bullet';
                bullet.style.left = Math.random() * 100 + '%';
                bullet.style.bottom = '0px';
                bullet.style.animationDelay = Math.random() * 1 + 's';
                bullet.style.setProperty('--bullet-x', (Math.random() * 200 - 100) + 'px');
                overlay.appendChild(bullet);
                
                setTimeout(() => {
                    if (overlay.contains(bullet)) {
                        overlay.removeChild(bullet);
                    }
                }, 3000);
            }
        }

        // Crear efectos de naturaleza
        function createNatureEffects() {
            const overlay = document.getElementById('natureOverlay');
            if (!overlay) return;
            
            // Crear hojas cayendo
            for (let i = 0; i < 5; i++) {
                const leaf = document.createElement('div');
                leaf.className = 'leaf';
                leaf.style.left = Math.random() * 100 + '%';
                leaf.style.top = '-20px';
                leaf.style.animationDelay = Math.random() * 2 + 's';
                leaf.style.animationDuration = (6 + Math.random() * 4) + 's';
                overlay.appendChild(leaf);
                
                setTimeout(() => {
                    if (overlay.contains(leaf)) {
                        overlay.removeChild(leaf);
                    }
                }, 12000);
            }
            
            // Crear pájaros volando
            if (Math.random() > 0.5) {
                const bird = document.createElement('div');
                bird.className = 'bird';
                bird.textContent = '🐦';
                bird.style.top = Math.random() * 30 + 10 + '%';
                bird.style.left = '-50px';
                bird.style.animationDelay = Math.random() * 2 + 's';
                overlay.appendChild(bird);
                
                setTimeout(() => {
                    if (overlay.contains(bird)) {
                        overlay.removeChild(bird);
                    }
                }, 15000);
            }
            
            // Crear brisas de viento
            for (let i = 0; i < 3; i++) {
                const breeze = document.createElement('div');
                breeze.className = 'breeze';
                breeze.style.left = Math.random() * 100 + '%';
                breeze.style.top = Math.random() * 50 + 20 + '%';
                breeze.style.animationDelay = Math.random() * 2 + 's';
                breeze.style.animationDuration = (3 + Math.random() * 2) + 's';
                overlay.appendChild(breeze);
                
                setTimeout(() => {
                    if (overlay.contains(breeze)) {
                        overlay.removeChild(breeze);
                    }
                }, 6000);
            }
        }

        function selectDifficulty(level) {
            // Detener temporizador si existe
            stopTimer();
            document.getElementById('timerContainer').style.display = 'none';
            
            difficulty = level;
            // Reiniciar vidas al seleccionar dificultad
            lives = 3;
            updateHearts();
            document.getElementById('difficultySelector').style.display = 'none';
            document.body.classList.remove('difficulty-selector-active');
            document.getElementById('loading').style.display = 'block';
            // Mostrar botón de ranking cuando se selecciona dificultad
            document.getElementById('viewRankingBtn').style.display = 'block';
            
            // Reiniciar arrays para modo Dios
            if (level === 'god') {
                usedCountries = [];
                availableCountries = [];
            }
            
            // Activar efectos según el modo
            document.body.classList.remove('hell-mode', 'war-mode', 'easy-mode', 'god-mode');
            
            if (level === 'impossible') {
                document.body.classList.add('hell-mode');
                createHellParticles();
                createSparks();
                // Recrear partículas cada 10 segundos (mucho menos frecuente)
                setInterval(() => {
                    createHellParticles();
                }, 10000);
                // Crear mini llamas cada 3 segundos (mucho menos frecuente)
                setInterval(() => {
                    createSparks();
                }, 3000);
            } else if (level === 'hard') {
                document.body.classList.add('war-mode');
                createWarEffects();
                // Recrear efectos de batalla cada 2 segundos
                setInterval(() => {
                    createWarEffects();
                }, 2000);
            } else if (level === 'easy') {
                document.body.classList.add('easy-mode');
                createNatureEffects();
                // Recrear efectos de naturaleza cada 3 segundos
                setInterval(() => {
                    createNatureEffects();
                }, 3000);
            } else if (level === 'god') {
                document.body.classList.add('god-mode');
                createGalacticStars();
                // Recrear estrellas cada 5 segundos
                setInterval(() => {
                    createGalacticStars();
                }, 5000);
            }
            
            loadCountries();
        }

        // Crear partículas flotantes para el selector de dificultad
        function createDifficultySelectorParticles() {
            const selector = document.getElementById('difficultySelector');
            if (!selector) return;
            
            // Limpiar partículas anteriores
            const existingParticles = selector.querySelectorAll('.floating-particle');
            existingParticles.forEach(p => p.remove());
            
            // Crear 20 partículas flotantes
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'floating-particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 8 + 's';
                particle.style.animationDuration = (6 + Math.random() * 4) + 's';
                particle.style.width = (3 + Math.random() * 3) + 'px';
                particle.style.height = particle.style.width;
                selector.appendChild(particle);
            }
        }

        // Crear estrellas galácticas
        function createGalacticStars() {
            const overlay = document.getElementById('galacticOverlay');
            if (!overlay) return;
            
            // Crear estrellas pequeñas
            for (let i = 0; i < 15; i++) {
                const star = document.createElement('div');
                star.className = 'galactic-star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 3 + 's';
                star.style.animationDuration = (2 + Math.random() * 2) + 's';
                overlay.appendChild(star);
                
                setTimeout(() => {
                    if (overlay.contains(star)) {
                        overlay.removeChild(star);
                    }
                }, 10000);
            }
            
            // Crear estrellas grandes ocasionales
            if (Math.random() > 0.5) {
                const largeStar = document.createElement('div');
                largeStar.className = 'galactic-star large';
                largeStar.style.left = Math.random() * 100 + '%';
                largeStar.style.top = Math.random() * 100 + '%';
                largeStar.style.animationDelay = Math.random() * 2 + 's';
                largeStar.style.animationDuration = (3 + Math.random() * 2) + 's';
                overlay.appendChild(largeStar);
                
                setTimeout(() => {
                    if (overlay.contains(largeStar)) {
                        overlay.removeChild(largeStar);
                    }
                }, 10000);
            }
            
            // Crear nebulosas ocasionales
            if (Math.random() > 0.7) {
                const nebula = document.createElement('div');
                nebula.className = 'galactic-nebula';
                nebula.style.left = Math.random() * 80 + 10 + '%';
                nebula.style.top = Math.random() * 80 + 10 + '%';
                overlay.appendChild(nebula);
                
                setTimeout(() => {
                    if (overlay.contains(nebula)) {
                        overlay.removeChild(nebula);
                    }
                }, 20000);
            }
        }

        // Cargar países desde la API
        async function loadCountries() {
            const loadingEl = document.getElementById('loading');
            
            try {
                loadingEl.textContent = 'Cargando países...';
                
                // Intentar cargar desde la API (solo una vez, sin timeout para evitar errores)
                let data = null;
                
                try {
                    const response = await fetch('https://restcountries.com/v3.1/all', {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const jsonData = await response.json();
                        if (Array.isArray(jsonData) && jsonData.length > 0) {
                            data = jsonData;
                        }
                    }
                } catch (err) {
                    console.log('API no disponible, usando lista de respaldo');
                }
                
                // Si la API falla o no devuelve datos, usar lista de respaldo
                if (!data || data.length === 0) {
                    console.log('Usando lista de países de respaldo');
                    allCountries = fallbackCountries;
                } else {
                    // Filtrar países que tengan nombre y código ISO (para FlagsAPI)
                    allCountries = data.filter(country =>
                        country &&
                        country.name &&
                        country.name.common &&
                        country.cca2 // Código ISO de 2 letras para FlagsAPI
                    );
                    
                    // Si después del filtro no hay países, usar respaldo
                    if (allCountries.length === 0) {
                        console.log('No se encontraron países válidos, usando lista de respaldo');
                        allCountries = fallbackCountries;
                    }
                }
                
                if (allCountries.length === 0) {
                    throw new Error('No se pudo cargar ningún país');
                }
                
                // Aplicar filtro según dificultad
                applyDifficultyFilter();
                
                loadingEl.style.display = 'none';
                document.getElementById('options').style.display = 'flex';
                document.getElementById('endAttemptBtn').style.display = 'block';
                loadNewQuestion();
            } catch (error) {
                // Si todo falla, usar la lista de respaldo
                console.log('Error al cargar desde API, usando lista de respaldo:', error);
                allCountries = fallbackCountries;
                
                if (allCountries.length > 0) {
                    // Aplicar filtro según dificultad
                    applyDifficultyFilter();
                    
                    loadingEl.style.display = 'none';
                    document.getElementById('options').style.display = 'flex';
                    loadNewQuestion();
                } else {
                    loadingEl.textContent = `Error: ${error.message}. Recarga la página.`;
                    loadingEl.style.color = '#f56565';
                }
            }
        }

        // Funciones del temporizador
        function startTimer() {
            // Detener temporizador anterior si existe
            stopTimer();
            
            timeLeft = 20;
            updateTimerDisplay();
            document.getElementById('timerContainer').style.display = 'flex';
            
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft <= 0) {
                    stopTimer();
                    handleTimeUp();
                }
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function updateTimerDisplay() {
            const timerText = document.getElementById('timerText');
            const timerProgress = document.getElementById('timerProgress');
            
            if (!timerText || !timerProgress) return;
            
            timerText.textContent = timeLeft;
            
            // Calcular el progreso del círculo (circunferencia = 2 * π * r = 2 * π * 45 ≈ 283)
            const circumference = 2 * Math.PI * 45;
            const progress = (timeLeft / 20) * circumference;
            timerProgress.style.strokeDashoffset = circumference - progress;
            
            // Cambiar color según el tiempo restante
            timerProgress.classList.remove('warning', 'danger');
            if (timeLeft <= 5) {
                timerProgress.classList.add('danger');
            } else if (timeLeft <= 10) {
                timerProgress.classList.add('warning');
            }
        }

        function handleTimeUp() {
            if (answered) return;
            
            answered = true;
            
            // Deshabilitar todos los botones
            [1, 2, 3, 4].forEach(i => {
                const btn = document.getElementById(`option${i}`);
                if (btn.style.display !== 'none') {
                    btn.disabled = true;
                    
                    if (btn.textContent === currentCountry.name.common) {
                        btn.classList.add('correct');
                    }
                }
            });

            // Marcar como incorrecta (tiempo agotado)
            lives--;
            updateHearts();
            
            const messageEl = document.getElementById('message');
            messageEl.textContent = `⏰ Tiempo agotado. La respuesta correcta es: ${currentCountry.name.common}`;
            messageEl.className = 'message incorrect';
            
            // Actualizar puntuación
            document.getElementById('score').textContent = score;
            
            // Mostrar alerta de fallo
            showAlert('error', '', `La respuesta correcta era: ${currentCountry.name.common}`);
            
            // Actualizar racha (marcar como incorrecta)
            updateStreak(false);
            
            // Si se acabaron las vidas, mostrar game over
            if (lives <= 0) {
                setTimeout(() => {
                    showGameOver();
                }, 2000);
            } else {
                // Pasar automáticamente a la siguiente bandera después de 2 segundos
                setTimeout(() => {
                    loadNewQuestion();
                }, 2000);
            }
        }

        // Cargar nueva pregunta
        function loadNewQuestion() {
            if (difficulty === 'god') {
                // Modo Dios: usar todos los países sin repetir
                if (availableCountries.length === 0) {
                    // Si se acabaron todos los países, reiniciar
                    if (usedCountries.length > 0) {
                        availableCountries = [...usedCountries];
                        usedCountries = [];
                    } else {
                        // Si no hay países disponibles, usar todos los países cargados
                        availableCountries = [...allCountries];
                    }
                }
                
                if (availableCountries.length === 0) {
                    // Si aún no hay países, mostrar mensaje
                    const messageEl = document.getElementById('message');
                    messageEl.textContent = '✨ ¡Has completado el examen de todas las banderas del mundo! ¡Eres un verdadero Dios! ✨';
                    messageEl.className = 'message correct';
                    return;
                }
                
                // Seleccionar país aleatorio de los disponibles
                const randomIndex = Math.floor(Math.random() * availableCountries.length);
                currentCountry = availableCountries[randomIndex];
                
                // Mover a usados y quitar de disponibles
                usedCountries.push(currentCountry);
                availableCountries.splice(randomIndex, 1);
            } else {
                // Modos normales: selección aleatoria con repetición
                if (countries.length === 0) return;
                
                // Seleccionar país aleatorio
                const randomIndex = Math.floor(Math.random() * countries.length);
                currentCountry = countries[randomIndex];
            }

            // Detener temporizador anterior
            stopTimer();

            // Mostrar bandera usando emojis Unicode (siempre funcionan)
            const countryCode = currentCountry.cca2; // Código ISO de 2 letras
            
            // Función para convertir código ISO a emoji de bandera
            function getFlagEmoji(countryCode) {
                if (!countryCode || countryCode.length !== 2) return '🏳️';
                
                const codePoints = countryCode
                    .toUpperCase()
                    .split('')
                    .map(char => 127397 + char.charCodeAt());
                return String.fromCodePoint(...codePoints);
            }
            
            const flagEmoji = getFlagEmoji(countryCode);
            const flagEl = document.getElementById('flag');
            
            // Mostrar emoji de bandera (grande y centrado)
            flagEl.innerHTML = `<div style="font-size: 10em; line-height: 1; user-select: none;">${flagEmoji}</div>`;
            
            // También intentar cargar imagen como respaldo (opcional, en segundo plano)
            const flagUrls = [
                `https://flagcdn.com/${countryCode.toLowerCase()}.svg`,
                `https://flagcdn.com/w256/${countryCode.toLowerCase()}.png`,
                `https://flagsapi.com/${countryCode}/flat/64.png`
            ];
            
            // Intentar cargar imagen en segundo plano (sin bloquear)
            let imgIndex = 0;
            function tryLoadImage() {
                if (imgIndex >= flagUrls.length) return;
                
                const img = new Image();
                img.src = flagUrls[imgIndex];
                
                img.onload = function() {
                    // Si la imagen carga, reemplazar el emoji
                    flagEl.innerHTML = '';
                    img.alt = `Bandera de ${currentCountry.name.common}`;
                    img.style.width = 'auto';
                    img.style.height = 'auto';
                    img.style.maxWidth = '100%';
                    img.style.maxHeight = '180px';
                    img.style.minHeight = '100px';
                    img.style.objectFit = 'contain';
                    img.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.1)';
                    img.style.borderRadius = '8px';
                    img.style.background = 'white';
                    img.style.padding = '5px';
                    img.style.display = 'block';
                    img.style.margin = '0 auto';
                    flagEl.appendChild(img);
                };
                
                img.onerror = function() {
                    imgIndex++;
                    tryLoadImage();
                };
            }
            
            // Intentar cargar imagen (opcional, el emoji ya está mostrado)
            tryLoadImage();

            // Generar opciones (1 correcta + 3 incorrectas)
            const wrongCountries = countries
                .filter(c => c.name.common !== currentCountry.name.common)
                .sort(() => Math.random() - 0.5)
                .slice(0, 3);

            const options = [
                currentCountry.name.common,
                wrongCountries[0].name.common,
                wrongCountries[1].name.common,
                wrongCountries[2].name.common
            ].sort(() => Math.random() - 0.5);

            // Asignar opciones a los botones
            document.getElementById('option1').textContent = options[0];
            document.getElementById('option2').textContent = options[1];
            document.getElementById('option3').textContent = options[2];
            document.getElementById('option4').textContent = options[3];

            // Resetear estado
            answered = false;
            jokerUsed = false;
            document.getElementById('message').textContent = '';
            document.getElementById('message').className = 'message';
            document.getElementById('nextBtn').classList.remove('show');

            // Habilitar botones
            [1, 2, 3, 4].forEach(i => {
                const btn = document.getElementById(`option${i}`);
                btn.disabled = false;
                btn.className = 'option';
                btn.style.display = 'block';
            });

            // Actualizar visibilidad del comodín
            updateJokerButton();
            
            // Iniciar temporizador
            startTimer();
        }

        // Actualizar corazones/vidas
        function updateHearts() {
            const heartsEl = document.getElementById('hearts');
            heartsEl.innerHTML = '';
            
            for (let i = 0; i < 3; i++) {
                const heart = document.createElement('span');
                if (i < lives) {
                    heart.textContent = '❤️';
                    heart.className = 'heart-full';
                } else {
                    heart.textContent = '🤍';
                    heart.className = 'heart-empty';
                }
                heartsEl.appendChild(heart);
            }
        }

        // Mostrar pantalla de game over
        function showGameOver() {
            // Detener temporizador
            stopTimer();
            document.getElementById('timerContainer').style.display = 'none';
            
            // Ocultar botón de terminar intento
            document.getElementById('endAttemptBtn').style.display = 'none';
            
            document.getElementById('finalScore').textContent = score;
            document.getElementById('maxStreak').textContent = maxStreak;
            document.getElementById('gameOver').style.display = 'flex';
            
            // Mostrar botón de guardar puntuación (usará el nombre del usuario autenticado)
            document.getElementById('nameInputContainer').style.display = 'block';
            document.getElementById('saveScoreBtn').disabled = false;
            document.getElementById('saveScoreBtn').textContent = '💾 Guardar Puntuación';
            document.getElementById('rankingContainer').style.display = 'none';
            document.getElementById('showRankingBtn').style.display = 'none';
            
            // Mostrar botón de ranking cuando se pierde
            document.getElementById('viewRankingBtn').style.display = 'block';
        }

        // Guardar puntuación en Firebase
        async function saveScore() {
            const playerName = window.currentUserName || 'Anónimo';
            
            const saveBtn = document.getElementById('saveScoreBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = '💾 Guardando...';
            
            try {
                const success = await window.guardarPuntuacion(playerName, score, difficulty);
                if (success) {
                    saveBtn.textContent = '✅ Guardado';
                    document.getElementById('showRankingBtn').style.display = 'block';
                    // Cargar ranking automáticamente después de guardar
                    setTimeout(() => {
                        loadRanking();
                    }, 500);
                } else {
                    alert('Error al guardar la puntuación. Intenta de nuevo.');
                    saveBtn.disabled = false;
                    saveBtn.textContent = '💾 Guardar Puntuación';
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar la puntuación. Intenta de nuevo.');
                saveBtn.disabled = false;
                saveBtn.textContent = '💾 Guardar Puntuación';
            }
        }

        // Actualizar display del usuario
        function updateUserDisplay() {
            if (window.currentUserName) {
                document.getElementById('userNameDisplay').textContent = `👤 ${window.currentUserName}`;
            }
        }

        // Manejar login
        async function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const messageEl = document.getElementById('loginMessage');
            const loginBtn = document.getElementById('loginBtn');
            
            if (!email || !password) {
                messageEl.textContent = 'Por favor, completa todos los campos';
                messageEl.className = 'auth-message error';
                return;
            }
            
            if (!isValidEmail(email)) {
                messageEl.textContent = 'Por favor, ingresa un email válido (ejemplo: usuario@email.com)';
                messageEl.className = 'auth-message error';
                return;
            }
            
            loginBtn.disabled = true;
            loginBtn.textContent = 'Iniciando sesión...';
            messageEl.textContent = '';
            messageEl.className = 'auth-message';
            
            // Verificar que window.iniciarSesion esté disponible
            if (!window.iniciarSesion || !window.firebaseReady) {
                // Intentar esperar un poco si el módulo está cargando
                for (let i = 0; i < 30; i++) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    if (window.iniciarSesion && window.firebaseReady) break;
                }
            }
            
            if (!window.iniciarSesion || !window.firebaseReady) {
                messageEl.textContent = 'Error: El sistema de autenticación no está listo. Por favor, espera unos segundos y vuelve a intentar, o recarga la página.';
                messageEl.className = 'auth-message error';
                loginBtn.disabled = false;
                loginBtn.textContent = 'Iniciar Sesión';
                console.error('window.iniciarSesion o firebaseReady no está disponible después de esperar');
                return;
            }
            
            const result = await window.iniciarSesion(email, password);
            
            if (result.success) {
                messageEl.textContent = '¡Sesión iniciada correctamente!';
                messageEl.className = 'auth-message success';
                // El onAuthStateChanged se encargará de ocultar la pantalla de auth
            } else {
                let errorMsg = 'Error al iniciar sesión';
                if (result.error.includes('user-not-found')) {
                    errorMsg = 'Usuario no encontrado. Verifica el email o regístrate primero.';
                } else if (result.error.includes('wrong-password')) {
                    errorMsg = 'Contraseña incorrecta';
                } else if (result.error.includes('invalid-email')) {
                    errorMsg = 'Email inválido. Usa un formato válido (ejemplo: usuario@email.com)';
                } else if (result.error.includes('operation-not-allowed')) {
                    errorMsg = '⚠️ ERROR: Email/Password no está habilitado en Firebase. Ve a Firebase Console > Authentication > Sign-in method > Email/Password y habilítalo.';
                } else if (result.error.includes('configuration-not-found')) {
                    errorMsg = '⚠️ ERROR: Firebase Authentication no está configurado. Habilita Email/Password en Firebase Console.';
                } else if (result.error.includes('network') || result.error.includes('network-request-failed')) {
                    errorMsg = 'Error de conexión. Verifica tu internet.';
                } else {
                    errorMsg = `Error: ${result.error}`;
                }
                messageEl.textContent = errorMsg;
                messageEl.className = 'auth-message error';
                loginBtn.disabled = false;
                loginBtn.textContent = 'Iniciar Sesión';
            }
        }

        // Validar formato de email
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // Manejar registro
        async function handleRegister() {
            const name = document.getElementById('registerName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            const messageEl = document.getElementById('registerMessage');
            const registerBtn = document.getElementById('registerBtn');
            
            if (!name || !email || !password) {
                messageEl.textContent = 'Por favor, completa todos los campos';
                messageEl.className = 'auth-message error';
                return;
            }
            
            if (name.length < 2) {
                messageEl.textContent = 'El nombre debe tener al menos 2 caracteres';
                messageEl.className = 'auth-message error';
                return;
            }
            
            if (!isValidEmail(email)) {
                messageEl.textContent = 'Por favor, ingresa un email válido (ejemplo: usuario@email.com)';
                messageEl.className = 'auth-message error';
                return;
            }
            
            if (password.length < 6) {
                messageEl.textContent = 'La contraseña debe tener al menos 6 caracteres';
                messageEl.className = 'auth-message error';
                return;
            }
            
            registerBtn.disabled = true;
            registerBtn.textContent = 'Registrando...';
            messageEl.textContent = '';
            messageEl.className = 'auth-message';
            
            // Verificar que la función esté disponible
            if (!window.registrarUsuario) {
                messageEl.textContent = 'Error: La función de registro no está disponible. Por favor, recarga la página.';
                messageEl.className = 'auth-message error';
                registerBtn.disabled = false;
                registerBtn.textContent = 'Registrarse';
                return;
            }
            
            const result = await window.registrarUsuario(email, password, name);
            
            if (result.success) {
                messageEl.textContent = '¡Registro exitoso!';
                messageEl.className = 'auth-message success';
                // El onAuthStateChanged se encargará de ocultar la pantalla de auth
            } else {
                let errorMsg = 'Error al registrarse';
                if (result.error.includes('email-already-in-use')) {
                    errorMsg = 'Este email ya está registrado. Usa "Iniciar Sesión" en su lugar.';
                } else if (result.error.includes('invalid-email')) {
                    errorMsg = 'Email inválido. Usa un formato válido (ejemplo: usuario@email.com)';
                } else if (result.error.includes('weak-password')) {
                    errorMsg = 'La contraseña es muy débil (mínimo 6 caracteres)';
                } else if (result.error.includes('operation-not-allowed')) {
                    errorMsg = '⚠️ ERROR: Email/Password no está habilitado en Firebase. Ve a Firebase Console > Authentication > Sign-in method > Email/Password y habilítalo.';
                } else if (result.error.includes('configuration-not-found')) {
                    errorMsg = '⚠️ ERROR: Firebase Authentication no está configurado. Habilita Email/Password en Firebase Console.';
                } else if (result.error.includes('network') || result.error.includes('network-request-failed')) {
                    errorMsg = 'Error de conexión. Verifica tu internet.';
                } else {
                    errorMsg = `Error: ${result.error}`;
                }
                messageEl.textContent = errorMsg;
                messageEl.className = 'auth-message error';
                registerBtn.disabled = false;
                registerBtn.textContent = 'Registrarse';
            }
        }

        // Cambiar entre tabs de login/registro
        function switchAuthTab(tab) {
            const loginTab = document.getElementById('loginTab');
            const registerTab = document.getElementById('registerTab');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            
            if (tab === 'login') {
                loginTab.classList.add('active');
                registerTab.classList.remove('active');
                loginForm.style.display = 'flex';
                registerForm.style.display = 'none';
            } else {
                registerTab.classList.add('active');
                loginTab.classList.remove('active');
                registerForm.style.display = 'flex';
                loginForm.style.display = 'none';
            }
        }

        // Cerrar sesión
        async function handleLogout() {
            // Cerrar modal de perfil si está abierto
            if (window.hideProfileModal) {
                window.hideProfileModal();
            }
            await window.cerrarSesion();
            // El onAuthStateChanged se encargará de mostrar la pantalla de auth
        }

        // Cargar y mostrar ranking (para game over)
        async function loadRanking() {
            const rankingContainer = document.getElementById('rankingContainer');
            const rankingList = document.getElementById('rankingList');
            
            rankingContainer.style.display = 'block';
            rankingList.innerHTML = '<div style="text-align: center; padding: 20px;">Cargando ranking...</div>';
            
            try {
                // Obtener ranking del nivel actual
                const ranking = await window.obtenerRanking(difficulty);
                
                if (ranking.length === 0) {
                    const nivelTexto = difficulty === 'easy' ? 'Fácil' : (difficulty === 'hard' ? 'Difícil' : (difficulty === 'impossible' ? 'Imposible' : (difficulty === 'god' ? 'Dios' : '')));
                    rankingList.innerHTML = `<div style="text-align: center; padding: 20px; color: #718096;">No hay puntuaciones aún en nivel ${nivelTexto}</div>`;
                    return;
                }
                
                rankingList.innerHTML = '';
                ranking.forEach((item, index) => {
                    const rankingItem = document.createElement('div');
                    rankingItem.className = 'ranking-item' + (index === 0 ? ' top' : '');
                    
                    const position = document.createElement('div');
                    position.className = 'ranking-position';
                    position.textContent = `#${index + 1}`;
                    
                    const name = document.createElement('div');
                    name.className = 'ranking-name';
                    
                    // Crear contenedor para foto de perfil
                    const profilePicContainer = document.createElement('div');
                    profilePicContainer.className = 'ranking-profile-picture';
                    name.appendChild(profilePicContainer);
                    
                    // Crear span para el nombre
                    const nameText = document.createElement('span');
                    nameText.textContent = item.nombre || 'Anónimo';
                    name.appendChild(nameText);
                    
                    // Cargar foto de perfil si hay userId
                    if (item.userId) {
                        window.loadUserProfilePicture(item.userId, profilePicContainer);
                    } else {
                        // Mostrar placeholder si no hay userId
                        const placeholder = document.createElement('div');
                        placeholder.className = 'placeholder';
                        placeholder.textContent = '👤';
                        profilePicContainer.appendChild(placeholder);
                    }
                    
                    const score = document.createElement('div');
                    score.className = 'ranking-score';
                    score.textContent = item.puntos || 0;
                    
                    rankingItem.appendChild(position);
                    rankingItem.appendChild(name);
                    rankingItem.appendChild(score);
                    rankingList.appendChild(rankingItem);
                });
            } catch (error) {
                console.error('Error al cargar ranking:', error);
                rankingList.innerHTML = '<div style="text-align: center; padding: 20px; color: #f56565;">Error al cargar el ranking</div>';
            }
        }

        // Mostrar ranking principal
        async function showMainRanking() {
            const mainRankingContainer = document.getElementById('mainRankingContainer');
            const rankingTitle = document.getElementById('rankingTitle');
            
            // Actualizar título según el nivel
            if (difficulty === 'easy') {
                rankingTitle.textContent = '🏆 Top 10 Ranking - Fácil';
            } else if (difficulty === 'hard') {
                rankingTitle.textContent = '🏆 Top 10 Ranking - Difícil';
            } else if (difficulty === 'impossible') {
                rankingTitle.textContent = '🏆 Top 10 Ranking - Imposible';
            } else if (difficulty === 'god') {
                rankingTitle.textContent = '✨ Top 10 Ranking - Dios';
            } else {
                rankingTitle.textContent = '🏆 Top 10 Ranking';
            }
            
            mainRankingContainer.style.display = 'block';
            await loadMainRanking();
        }

        // Ocultar ranking principal
        function hideMainRanking() {
            const mainRankingContainer = document.getElementById('mainRankingContainer');
            mainRankingContainer.style.display = 'none';
        }

        // Mostrar ranking por nivel específico (desde la pantalla de selección)
        window.showRankingByLevel = async function(level) {
            const difficultyRankingContainer = document.getElementById('difficultyRankingContainer');
            const difficultyRankingTitle = document.getElementById('difficultyRankingTitle');
            const difficultyRankingList = document.getElementById('difficultyRankingList');
            
            if (!difficultyRankingContainer || !difficultyRankingTitle || !difficultyRankingList) {
                console.error('Elementos del ranking no encontrados');
                return;
            }
            
            // Actualizar título según el nivel
            if (level === 'easy') {
                difficultyRankingTitle.textContent = '🏆 Top 10 Ranking - Fácil';
            } else if (level === 'hard') {
                difficultyRankingTitle.textContent = '🏆 Top 10 Ranking - Difícil';
            } else if (level === 'impossible') {
                difficultyRankingTitle.textContent = '🏆 Top 10 Ranking - Imposible';
            } else if (level === 'god') {
                difficultyRankingTitle.textContent = '✨ Top 10 Ranking - Dios';
            } else {
                difficultyRankingTitle.textContent = '🏆 Top 10 Ranking';
            }
            
            // Mostrar contenedor y cargar ranking
            difficultyRankingContainer.style.display = 'block';
            await loadDifficultyRankingByLevel(level);
            
            // Scroll suave al ranking
            setTimeout(() => {
                if (difficultyRankingContainer) {
                    difficultyRankingContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }, 100);
        }

        // Cargar ranking por nivel específico (para la pantalla de selección)
        async function loadDifficultyRankingByLevel(level) {
            const difficultyRankingList = document.getElementById('difficultyRankingList');
            
            if (!difficultyRankingList) {
                console.error('difficultyRankingList no encontrado');
                return;
            }
            
            difficultyRankingList.innerHTML = '<div style="text-align: center; padding: 20px; color: #718096;">Cargando ranking...</div>';
            
            try {
                // Obtener ranking del nivel especificado
                const ranking = await window.obtenerRanking(level);
                
                if (ranking.length === 0) {
                    const nivelTexto = level === 'easy' ? 'Fácil' : (level === 'hard' ? 'Difícil' : (level === 'impossible' ? 'Imposible' : (level === 'god' ? 'Dios' : '')));
                    difficultyRankingList.innerHTML = `<div style="text-align: center; padding: 20px; color: #718096;">No hay puntuaciones aún en nivel ${nivelTexto}. ¡Sé el primero en jugar!</div>`;
                    return;
                }
                
                difficultyRankingList.innerHTML = '';
                ranking.forEach((item, index) => {
                    const rankingItem = document.createElement('div');
                    // Aplicar clases según la posición
                    let itemClass = 'difficulty-ranking-item';
                    if (index === 0) {
                        itemClass += ' top';
                    } else if (index === 1) {
                        itemClass += ' second';
                    } else if (index === 2) {
                        itemClass += ' third';
                    }
                    rankingItem.className = itemClass;
                    
                    const position = document.createElement('div');
                    position.className = 'difficulty-ranking-position';
                    position.textContent = `#${index + 1}`;
                    
                    const name = document.createElement('div');
                    name.className = 'difficulty-ranking-name';
                    
                    // Crear contenedor para foto de perfil
                    const profilePicContainer = document.createElement('div');
                    profilePicContainer.className = 'ranking-profile-picture';
                    name.appendChild(profilePicContainer);
                    
                    // Crear span para el nombre
                    const nameText = document.createElement('span');
                    nameText.textContent = item.nombre || 'Anónimo';
                    name.appendChild(nameText);
                    
                    // Cargar foto de perfil si hay userId
                    if (item.userId) {
                        if (window.loadUserProfilePicture) {
                            window.loadUserProfilePicture(item.userId, profilePicContainer);
                        } else {
                            const placeholder = document.createElement('div');
                            placeholder.className = 'placeholder';
                            placeholder.textContent = '👤';
                            profilePicContainer.appendChild(placeholder);
                        }
                    } else {
                        // Mostrar placeholder si no hay userId
                        const placeholder = document.createElement('div');
                        placeholder.className = 'placeholder';
                        placeholder.textContent = '👤';
                        profilePicContainer.appendChild(placeholder);
                    }
                    
                    const score = document.createElement('div');
                    score.className = 'difficulty-ranking-score';
                    score.textContent = item.puntos || 0;
                    
                    rankingItem.appendChild(position);
                    rankingItem.appendChild(name);
                    rankingItem.appendChild(score);
                    difficultyRankingList.appendChild(rankingItem);
                });
            } catch (error) {
                console.error('Error al cargar ranking:', error);
                difficultyRankingList.innerHTML = '<div style="text-align: center; padding: 20px; color: #f56565;">Error al cargar el ranking</div>';
            }
        }

        // Cargar ranking por nivel específico (para el modal durante el juego)
        async function loadMainRankingByLevel(level) {
            const mainRankingList = document.getElementById('mainRankingList');
            
            if (!mainRankingList) {
                console.error('mainRankingList no encontrado');
                return;
            }
            
            mainRankingList.innerHTML = '<div style="text-align: center; padding: 20px; color: #718096;">Cargando ranking...</div>';
            
            try {
                // Obtener ranking del nivel especificado
                const ranking = await window.obtenerRanking(level);
                
                if (ranking.length === 0) {
                    const nivelTexto = level === 'easy' ? 'Fácil' : (level === 'hard' ? 'Difícil' : (level === 'impossible' ? 'Imposible' : (level === 'god' ? 'Dios' : '')));
                    mainRankingList.innerHTML = `<div style="text-align: center; padding: 20px; color: #718096;">No hay puntuaciones aún en nivel ${nivelTexto}. ¡Sé el primero en jugar!</div>`;
                    return;
                }
                
                mainRankingList.innerHTML = '';
                ranking.forEach((item, index) => {
                    const rankingItem = document.createElement('div');
                    // Aplicar clases según la posición
                    let itemClass = 'main-ranking-item';
                    if (index === 0) {
                        itemClass += ' top';
                    } else if (index === 1) {
                        itemClass += ' second';
                    } else if (index === 2) {
                        itemClass += ' third';
                    }
                    rankingItem.className = itemClass;
                    
                    const position = document.createElement('div');
                    position.className = 'main-ranking-position';
                    position.textContent = `#${index + 1}`;
                    
                    const name = document.createElement('div');
                    name.className = 'main-ranking-name';
                    
                    // Crear contenedor para foto de perfil
                    const profilePicContainer = document.createElement('div');
                    profilePicContainer.className = 'ranking-profile-picture';
                    name.appendChild(profilePicContainer);
                    
                    // Crear span para el nombre
                    const nameText = document.createElement('span');
                    nameText.textContent = item.nombre || 'Anónimo';
                    name.appendChild(nameText);
                    
                    // Cargar foto de perfil si hay userId
                    if (item.userId) {
                        if (window.loadUserProfilePicture) {
                            window.loadUserProfilePicture(item.userId, profilePicContainer);
                        } else {
                            const placeholder = document.createElement('div');
                            placeholder.className = 'placeholder';
                            placeholder.textContent = '👤';
                            profilePicContainer.appendChild(placeholder);
                        }
                    } else {
                        // Mostrar placeholder si no hay userId
                        const placeholder = document.createElement('div');
                        placeholder.className = 'placeholder';
                        placeholder.textContent = '👤';
                        profilePicContainer.appendChild(placeholder);
                    }
                    
                    const score = document.createElement('div');
                    score.className = 'main-ranking-score';
                    score.textContent = item.puntos || 0;
                    
                    rankingItem.appendChild(position);
                    rankingItem.appendChild(name);
                    rankingItem.appendChild(score);
                    mainRankingList.appendChild(rankingItem);
                });
            } catch (error) {
                console.error('Error al cargar ranking:', error);
                mainRankingList.innerHTML = '<div style="text-align: center; padding: 20px; color: #f56565;">Error al cargar el ranking</div>';
            }
        }

        // Cargar y mostrar ranking principal (en la pantalla del juego)
        async function loadMainRanking() {
            const mainRankingList = document.getElementById('mainRankingList');
            
            if (!mainRankingList) {
                console.error('mainRankingList no encontrado');
                return;
            }
            
            mainRankingList.innerHTML = '<div style="text-align: center; padding: 20px; color: #718096;">Cargando ranking...</div>';
            
            try {
                // Obtener ranking del nivel actual
                const ranking = await window.obtenerRanking(difficulty);
                
                if (ranking.length === 0) {
                    const nivelTexto = difficulty === 'easy' ? 'Fácil' : (difficulty === 'hard' ? 'Difícil' : (difficulty === 'impossible' ? 'Imposible' : (difficulty === 'god' ? 'Dios' : '')));
                    mainRankingList.innerHTML = `<div style="text-align: center; padding: 20px; color: #718096;">No hay puntuaciones aún en nivel ${nivelTexto}. ¡Sé el primero en jugar!</div>`;
                    return;
                }
                
                mainRankingList.innerHTML = '';
                ranking.forEach((item, index) => {
                    const rankingItem = document.createElement('div');
                    // Aplicar clases según la posición
                    let itemClass = 'main-ranking-item';
                    if (index === 0) {
                        itemClass += ' top';
                    } else if (index === 1) {
                        itemClass += ' second';
                    } else if (index === 2) {
                        itemClass += ' third';
                    }
                    rankingItem.className = itemClass;
                    
                    const position = document.createElement('div');
                    position.className = 'main-ranking-position';
                    position.textContent = `#${index + 1}`;
                    
                    const name = document.createElement('div');
                    name.className = 'main-ranking-name';
                    
                    // Crear contenedor para foto de perfil
                    const profilePicContainer = document.createElement('div');
                    profilePicContainer.className = 'ranking-profile-picture';
                    name.appendChild(profilePicContainer);
                    
                    // Crear span para el nombre
                    const nameText = document.createElement('span');
                    nameText.textContent = item.nombre || 'Anónimo';
                    name.appendChild(nameText);
                    
                    // Cargar foto de perfil si hay userId
                    if (item.userId) {
                        window.loadUserProfilePicture(item.userId, profilePicContainer);
                    } else {
                        // Mostrar placeholder si no hay userId
                        const placeholder = document.createElement('div');
                        placeholder.className = 'placeholder';
                        placeholder.textContent = '👤';
                        profilePicContainer.appendChild(placeholder);
                    }
                    
                    const score = document.createElement('div');
                    score.className = 'main-ranking-score';
                    score.textContent = item.puntos || 0;
                    
                    rankingItem.appendChild(position);
                    rankingItem.appendChild(name);
                    rankingItem.appendChild(score);
                    mainRankingList.appendChild(rankingItem);
                });
            } catch (error) {
                console.error('Error al cargar ranking:', error);
                mainRankingList.innerHTML = '<div style="text-align: center; padding: 20px; color: #f56565;">Error al cargar el ranking</div>';
            }
        }

        // Terminar intento (eliminar vidas y volver a selección de modos)
        function endAttempt() {
            // Detener temporizador
            stopTimer();
            document.getElementById('timerContainer').style.display = 'none';
            
            // Eliminar todas las vidas para mostrar game over
            lives = 0;
            updateHearts();
            
            // Mostrar game over (como si hubiera perdido todas las vidas)
            showGameOver();
        }

        // Reiniciar juego
        function restartGame() {
            // Detener temporizador
            stopTimer();
            document.getElementById('timerContainer').style.display = 'none';
            
            score = 0;
            streak = 0;
            maxStreak = 0;
            lives = 3;
            answered = false;
            jokerAvailable = false;
            jokerUsed = false;
            // Resetear difficulty
            difficulty = null;
            timeLeft = 20;
            
            // Remover las clases de modo para que la pantalla de elegir nivel no tenga estilos del nivel anterior
            document.body.classList.remove('hell-mode', 'war-mode', 'easy-mode', 'god-mode');
            
            // Ocultar game over
            document.getElementById('gameOver').style.display = 'none';
            
            // Resetear UI
            document.getElementById('score').textContent = '0';
            document.getElementById('streak').textContent = '0';
            document.getElementById('message').textContent = '';
            document.getElementById('message').className = 'message';
            document.getElementById('nextBtn').classList.remove('show');
            document.getElementById('jokerBtn').style.display = 'none';
            document.getElementById('options').style.display = 'none';
            document.getElementById('loading').style.display = 'none';
            
            // Resetear botones de puntuación
            document.getElementById('saveScoreBtn').disabled = false;
            document.getElementById('saveScoreBtn').textContent = '💾 Guardar Puntuación';
            document.getElementById('nameInputContainer').style.display = 'none';
            document.getElementById('rankingContainer').style.display = 'none';
            document.getElementById('showRankingBtn').style.display = 'none';
            
            // Ocultar botón de ranking al reiniciar
            document.getElementById('viewRankingBtn').style.display = 'none';
            document.getElementById('mainRankingContainer').style.display = 'none';
            
            // Ocultar contenedor de ranking de dificultad si está visible
            const difficultyRankingContainer = document.getElementById('difficultyRankingContainer');
            if (difficultyRankingContainer) {
                difficultyRankingContainer.style.display = 'none';
            }
            
            // Mostrar selector de dificultad
            document.getElementById('difficultySelector').style.display = 'block';
            document.body.classList.add('difficulty-selector-active');
            
            // Crear partículas flotantes en el selector de dificultad
            createDifficultySelectorParticles();
            
            // Actualizar corazones
            updateHearts();
        }

        // Actualizar racha
        function updateStreak(isCorrect) {
            const fireEl = document.getElementById('streakFire');
            
            if (isCorrect) {
                streak++;
                // Actualizar máxima racha
                if (streak > maxStreak) {
                    maxStreak = streak;
                }
                // Hacer el fuego más intenso cuando la racha es alta
                // En modo imposible, se activa con 2 de racha
                const requiredStreak = difficulty === 'impossible' ? 2 : 5;
                if (streak >= requiredStreak) {
                    fireEl.classList.add('hot');
                }
            } else {
                streak = 0;
                jokerAvailable = false;
                jokerUsed = false;
                fireEl.classList.remove('hot');
            }
            
            document.getElementById('streak').textContent = streak;
            updateJokerButton();
        }

        // Frases motivadoras para aciertos
        const successMessages = [
            'Good boooy! 😊🎉',
            '¡Excelente! 😄🌟',
            '¡Perfecto! 😃⭐',
            '¡Increíble! 🤩🚀',
            '¡Genial! 😎💪',
            '¡Fantástico! 😁🎊',
            '¡Bien hecho! 😊👏',
            '¡Así se hace! 😄🔥',
            '¡Eres un crack! 🤩💎',
            '¡Sigue así! 😃🎯',
            '¡Increíble trabajo! 😊✨',
            '¡Lo hiciste genial! 😄🎉',
            '¡Perfecto! 😃👌',
            '¡Eres increíble! 🤩🌟',
            '¡Bien jugado! 😊💪'
        ];

        // Frases motivadoras para fallos
        const errorMessages = [
            '¡Casi! Sigue intentando 😊💪',
            'No te rindas, sigue adelante 😌🌟',
            'La próxima será mejor 😊🎯',
            '¡Sigue practicando! 😄💪',
            'Cada error es aprendizaje 😊📚',
            '¡Tú puedes! Sigue adelante 😃🚀',
            'No pasa nada, sigue jugando 😊',
            'La práctica hace al maestro 😌🎓',
            '¡Sigue intentando! 😊💪',
            'Cada intento te acerca más 😄🎯',
            '¡Ánimo! Lo conseguirás 😊✨',
            'Sigue adelante, tú puedes 😃💪',
            'No te desanimes 😌🌟',
            '¡La próxima vez será mejor! 😊🎯',
            'Sigue intentando, lo lograrás 😄💪'
        ];

        // Crear cohetes animados
        function createRockets() {
            const container = document.body;
            const rocketCount = 15;
            
            for (let i = 0; i < rocketCount; i++) {
                const rocket = document.createElement('div');
                rocket.className = 'rocket';
                rocket.textContent = '🚀';
                rocket.style.position = 'fixed';
                rocket.style.fontSize = '2em';
                rocket.style.pointerEvents = 'none';
                rocket.style.zIndex = '3000';
                
                // Posición inicial aleatoria
                const startX = Math.random() * window.innerWidth;
                const startY = window.innerHeight + 50;
                const endX = startX + (Math.random() - 0.5) * 200;
                const endY = -100;
                
                rocket.style.left = startX + 'px';
                rocket.style.top = startY + 'px';
                
                // Animación
                const angle = Math.atan2(endY - startY, endX - startX) * 180 / Math.PI;
                rocket.style.transform = `rotate(${angle + 90}deg)`;
                
                container.appendChild(rocket);
                
                // Animar cohete
                setTimeout(() => {
                    rocket.style.transition = 'all 2s ease-out';
                    rocket.style.left = endX + 'px';
                    rocket.style.top = endY + 'px';
                    rocket.style.opacity = '0';
                    rocket.style.transform = `rotate(${angle + 90}deg) scale(0.5)`;
                }, 10);
                
                // Remover cohete después de la animación
                setTimeout(() => {
                    if (container.contains(rocket)) {
                        container.removeChild(rocket);
                    }
                }, 2000);
            }
        }

        // Mostrar alerta estilizada
        function showAlert(type, message, details) {
            // Si es acierto, crear cohetes
            if (type === 'success') {
                createRockets();
            }
            
            const overlay = document.createElement('div');
            overlay.className = 'alert-overlay';
            
            const alertBox = document.createElement('div');
            alertBox.className = `alert-box ${type}`;
            
            const icon = document.createElement('div');
            icon.className = 'alert-icon';
            icon.textContent = type === 'success' ? '✅' : '❌';
            
            const messageEl = document.createElement('div');
            messageEl.className = 'alert-message';
            // Usar frase aleatoria
            if (type === 'success') {
                messageEl.textContent = successMessages[Math.floor(Math.random() * successMessages.length)];
            } else {
                messageEl.textContent = errorMessages[Math.floor(Math.random() * errorMessages.length)];
            }
            
            const detailsEl = document.createElement('div');
            detailsEl.className = 'alert-details';
            detailsEl.textContent = details;
            
            alertBox.appendChild(icon);
            alertBox.appendChild(messageEl);
            alertBox.appendChild(detailsEl);
            overlay.appendChild(alertBox);
            
            document.body.appendChild(overlay);
            
            // Remover después de 1.5 segundos
            setTimeout(() => {
                overlay.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => {
                    if (document.body.contains(overlay)) {
                        document.body.removeChild(overlay);
                    }
                }, 300);
            }, 1500);
        }

        // Actualizar botón comodín
        function updateJokerButton() {
            const jokerBtn = document.getElementById('jokerBtn');
            
            // En modo imposible, el comodín se activa con 2 de racha
            // En otros modos, se activa con 5 de racha
            const requiredStreak = difficulty === 'impossible' ? 2 : 5;
            
            if (streak >= requiredStreak && !jokerUsed) {
                jokerAvailable = true;
                if (jokerBtn) {
                    jokerBtn.style.display = 'block';
                }
            } else {
                jokerAvailable = false;
                if (jokerBtn) {
                    jokerBtn.style.display = 'none';
                }
            }
        }

        // Usar comodín
        function useJoker() {
            if (!jokerAvailable || jokerUsed || answered) return;

            jokerUsed = true;
            jokerAvailable = false;
            document.getElementById('jokerBtn').style.display = 'none';

            // Encontrar la respuesta correcta
            const correctAnswer = currentCountry.name.common;
            
            // Obtener todos los botones incorrectos
            const incorrectButtons = [];
            [1, 2, 3, 4].forEach(i => {
                const btn = document.getElementById(`option${i}`);
                if (btn.textContent !== correctAnswer) {
                    incorrectButtons.push(btn);
                }
            });

            // Eliminar 2 opciones incorrectas aleatoriamente
            const toRemove = incorrectButtons
                .sort(() => Math.random() - 0.5)
                .slice(0, 2);

            toRemove.forEach(btn => {
                btn.style.display = 'none';
                btn.disabled = true;
            });

            // Reducir la racha (se usó el comodín)
            // En modo imposible, se reduce en 2. En otros modos, en 5
            const streakReduction = difficulty === 'impossible' ? 2 : 5;
            streak = Math.max(0, streak - streakReduction);
            document.getElementById('streak').textContent = streak;
            
            // Actualizar el fuego
            const fireEl = document.getElementById('streakFire');
            const requiredStreak = difficulty === 'impossible' ? 2 : 5;
            if (streak < requiredStreak) {
                fireEl.classList.remove('hot');
            }
            
            updateJokerButton();
        }

        // Manejar selección de opción
        function selectOption(optionNumber) {
            if (answered) return;

            // Detener temporizador
            stopTimer();

            const selectedBtn = document.getElementById(`option${optionNumber}`);
            const selectedText = selectedBtn.textContent;
            const isCorrect = selectedText === currentCountry.name.common;

            answered = true;

            // Deshabilitar todos los botones
            [1, 2, 3, 4].forEach(i => {
                const btn = document.getElementById(`option${i}`);
                if (btn.style.display !== 'none') {
                    btn.disabled = true;
                    
                    if (btn.textContent === currentCountry.name.common) {
                        btn.classList.add('correct');
                    } else if (btn === selectedBtn && !isCorrect) {
                        btn.classList.add('incorrect');
                    }
                }
            });

            // Actualizar racha
            updateStreak(isCorrect);

            // Mostrar mensaje
            const messageEl = document.getElementById('message');
            if (isCorrect) {
                score++;
                messageEl.textContent = '¡Correcto! 🎉';
                messageEl.className = 'message correct';
                
                // Actualizar puntuación
                document.getElementById('score').textContent = score;
                
                // Mostrar alerta de acierto (con cohetes y frase motivadora)
                showAlert('success', '', '');
                
                // Pasar automáticamente a la siguiente bandera después de 2 segundos
                setTimeout(() => {
                    loadNewQuestion();
                }, 2000);
            } else {
                // Restar una vida
                lives--;
                updateHearts();
                
                messageEl.textContent = `Incorrecto. La respuesta correcta es: ${currentCountry.name.common}`;
                messageEl.className = 'message incorrect';
                
                // Actualizar puntuación
                document.getElementById('score').textContent = score;
                
                // Mostrar alerta de fallo (con frase motivadora)
                showAlert('error', '', `La respuesta correcta era: ${currentCountry.name.common}`);
                
                // Si se acabaron las vidas, mostrar game over
                if (lives <= 0) {
                    setTimeout(() => {
                        showGameOver();
                    }, 2000);
                } else {
                    // Pasar automáticamente a la siguiente bandera después de 2 segundos
                    setTimeout(() => {
                        loadNewQuestion();
                    }, 2000);
                }
            }
        }

        // Event listeners
        document.getElementById('option1').addEventListener('click', () => selectOption(1));
        document.getElementById('option2').addEventListener('click', () => selectOption(2));
        document.getElementById('option3').addEventListener('click', () => selectOption(3));
        document.getElementById('option4').addEventListener('click', () => selectOption(4));
        document.getElementById('jokerBtn').addEventListener('click', useJoker);
        document.getElementById('nextBtn').addEventListener('click', loadNewQuestion);
        document.getElementById('endAttemptBtn').addEventListener('click', endAttempt);
        
        // Crear partículas en el selector de dificultad al cargar la página
        const difficultySelector = document.getElementById('difficultySelector');
        if (difficultySelector && (difficultySelector.style.display !== 'none' && difficultySelector.style.display !== '')) {
            document.body.classList.add('difficulty-selector-active');
            createDifficultySelectorParticles();
        } else if (difficultySelector && !difficultySelector.style.display) {
            // Si no tiene estilo display definido, está visible por defecto
            document.body.classList.add('difficulty-selector-active');
            createDifficultySelectorParticles();
        }

        // Event listeners para selección de dificultad
        document.getElementById('easyBtn').addEventListener('click', () => selectDifficulty('easy'));
        document.getElementById('hardBtn').addEventListener('click', () => selectDifficulty('hard'));
        document.getElementById('impossibleBtn').addEventListener('click', () => selectDifficulty('impossible'));
        document.getElementById('godBtn').addEventListener('click', () => selectDifficulty('god'));
        document.getElementById('restartBtn').addEventListener('click', restartGame);
        document.getElementById('saveScoreBtn').addEventListener('click', saveScore);
        document.getElementById('showRankingBtn').addEventListener('click', loadRanking);
        document.getElementById('logoutBtn').addEventListener('click', handleLogout);
        const profileLogoutBtn = document.getElementById('profileLogoutBtn');
        if (profileLogoutBtn) {
            profileLogoutBtn.addEventListener('click', async () => {
                // Cerrar modal primero
                if (window.hideProfileModal) {
                    window.hideProfileModal();
                }
                // Luego cerrar sesión
                await handleLogout();
            });
        }

        // Event listeners para sistema de amigos
        const profileFriendsBtn = document.getElementById('profileFriendsBtn');
        if (profileFriendsBtn) {
            profileFriendsBtn.addEventListener('click', () => {
                if (window.showFriendsModal) {
                    window.showFriendsModal();
                }
            });
        }

        const profileInboxBtn = document.getElementById('profileInboxBtn');
        if (profileInboxBtn) {
            profileInboxBtn.addEventListener('click', () => {
                if (window.showInboxModal) {
                    window.showInboxModal();
                }
            });
        }

        const profileToggleScoresBtn = document.getElementById('profileToggleScoresBtn');
        if (profileToggleScoresBtn) {
            profileToggleScoresBtn.addEventListener('click', () => {
                if (window.toggleScoresVisibility) {
                    window.toggleScoresVisibility();
                }
            });
        }

        const friendProfileModalClose = document.getElementById('friendProfileModalClose');
        if (friendProfileModalClose) {
            friendProfileModalClose.addEventListener('click', () => {
                if (window.hideFriendProfileModal) {
                    window.hideFriendProfileModal();
                }
            });
        }

        // Cerrar modal de perfil de amigo al hacer clic fuera
        const friendProfileModal = document.getElementById('friendProfileModal');
        if (friendProfileModal) {
            friendProfileModal.addEventListener('click', (e) => {
                if (e.target === friendProfileModal) {
                    if (window.hideFriendProfileModal) {
                        window.hideFriendProfileModal();
                    }
                }
            });
        }

        // Event listener para guardar descripción
        const profileSaveDescriptionBtn = document.getElementById('profileSaveDescriptionBtn');
        if (profileSaveDescriptionBtn) {
            profileSaveDescriptionBtn.addEventListener('click', async () => {
                if (window.saveProfileDescription) {
                    await window.saveProfileDescription();
                }
            });
        }

        // Event listeners para chat
        const activeChatSendBtn = document.getElementById('activeChatSendBtn');
        const activeChatInput = document.getElementById('activeChatInput');
        const activeChatMinimize = document.getElementById('activeChatMinimize');
        
        if (activeChatSendBtn) {
            activeChatSendBtn.addEventListener('click', () => {
                if (window.sendChatMessage) {
                    window.sendChatMessage();
                }
            });
        }
        
        if (activeChatInput) {
            activeChatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    if (window.sendChatMessage) {
                        window.sendChatMessage();
                    }
                }
            });
        }
        
        if (activeChatMinimize) {
            activeChatMinimize.addEventListener('click', (e) => {
                e.stopPropagation();
                if (window.toggleChatMinimize) {
                    window.toggleChatMinimize();
                }
            });
        }
        
        // Hacer que el header sea clicable para maximizar si está minimizado
        const activeChatHeader = document.querySelector('.active-chat-header');
        if (activeChatHeader) {
            activeChatHeader.addEventListener('click', (e) => {
                // No hacer nada si se hace clic en el botón de minimizar
                if (e.target === activeChatMinimize || e.target.closest('.active-chat-minimize')) {
                    return;
                }
                const activeChat = document.getElementById('profileActiveChat');
                if (activeChat && activeChat.classList.contains('minimized')) {
                    if (window.toggleChatMinimize) {
                        window.toggleChatMinimize();
                    }
                }
            });
        }

        // Event listeners para biblioteca
        const libraryImageInput = document.getElementById('libraryImageInput');
        if (libraryImageInput) {
            libraryImageInput.addEventListener('change', async (e) => {
                const files = Array.from(e.target.files);
                if (files.length > 0) {
                    for (const file of files) {
                        await window.uploadLibraryImage(file);
                    }
                    e.target.value = ''; // Limpiar input
                }
            });
        }

        const libraryImageModalClose = document.getElementById('libraryImageModalClose');
        if (libraryImageModalClose) {
            libraryImageModalClose.addEventListener('click', () => {
                if (window.hideLibraryImage) {
                    window.hideLibraryImage();
                }
            });
        }

        const libraryImageModal = document.getElementById('libraryImageModal');
        if (libraryImageModal) {
            libraryImageModal.addEventListener('click', (e) => {
                if (e.target === libraryImageModal) {
                    if (window.hideLibraryImage) {
                        window.hideLibraryImage();
                    }
                }
            });
        }

        // Event listeners para el modal de zoom
        const libraryImageZoomCloseBack = document.getElementById('libraryImageZoomCloseBack');
        if (libraryImageZoomCloseBack) {
            libraryImageZoomCloseBack.addEventListener('click', () => {
                if (window.hideLibraryImageZoom) {
                    window.hideLibraryImageZoom();
                }
            });
        }

        const libraryImageZoomCloseAll = document.getElementById('libraryImageZoomCloseAll');
        if (libraryImageZoomCloseAll) {
            libraryImageZoomCloseAll.addEventListener('click', () => {
                if (window.hideLibraryImage) {
                    window.hideLibraryImage();
                }
            });
        }

        // Cerrar zoom al hacer click fuera de la imagen
        const libraryImageZoomModal = document.getElementById('libraryImageZoomModal');
        if (libraryImageZoomModal) {
            libraryImageZoomModal.addEventListener('click', (e) => {
                if (e.target === libraryImageZoomModal) {
                    if (window.hideLibraryImageZoom) {
                        window.hideLibraryImageZoom();
                    }
                }
            });
        }

        // Event listeners para likes y comentarios
        // Variables globales para la foto actual en el modal (declaradas antes de los event listeners)
        window.currentFotoId = null;
        window.currentFotoOwnerId = null;

        // Event listeners para likes y comentarios (usando delegación de eventos)
        document.addEventListener('click', async (e) => {
            // Botón de like
            if (e.target.closest('#libraryImageLikeBtn')) {
                e.preventDefault();
                e.stopPropagation();
                console.log('Botón de like clickeado, currentFotoId:', window.currentFotoId);
                if (window.currentFotoId && window.toggleFotoLike) {
                    try {
                        await window.toggleFotoLike(window.currentFotoId);
                    } catch (error) {
                        console.error('Error al dar like:', error);
                        alert('Error al dar like. Por favor, intenta de nuevo.');
                    }
                } else {
                    console.error('No hay fotoId o toggleFotoLike no está disponible');
                    if (!window.currentFotoId) {
                        alert('Error: No se pudo identificar la foto. Por favor, cierra y vuelve a abrir la imagen.');
                    }
                }
            }
            
            // Botón de comentario
            if (e.target.closest('#libraryImageCommentSubmit')) {
                e.preventDefault();
                e.stopPropagation();
                const commentInput = document.getElementById('libraryImageCommentInput');
                if (commentInput && window.currentFotoId && window.addFotoComment) {
                    const comentario = commentInput.value.trim();
                    console.log('Botón de comentario clickeado, fotoId:', window.currentFotoId, 'comentario:', comentario);
                    if (comentario) {
                        try {
                            await window.addFotoComment(window.currentFotoId, comentario);
                        } catch (error) {
                            console.error('Error al agregar comentario:', error);
                            alert('Error al agregar el comentario. Por favor, intenta de nuevo.');
                        }
                    } else {
                        alert('Por favor, escribe un comentario antes de enviar.');
                    }
                } else {
                    console.error('No hay fotoId, input o addFotoComment no está disponible');
                    if (!window.currentFotoId) {
                        alert('Error: No se pudo identificar la foto. Por favor, cierra y vuelve a abrir la imagen.');
                    }
                }
            }
        });

        // Event listener para Enter en el campo de comentario
        document.addEventListener('keypress', async (e) => {
            if (e.target.id === 'libraryImageCommentInput' && e.key === 'Enter') {
                e.preventDefault();
                const commentInput = document.getElementById('libraryImageCommentInput');
                if (commentInput && window.currentFotoId && window.addFotoComment) {
                    const comentario = commentInput.value.trim();
                    if (comentario) {
                        try {
                            await window.addFotoComment(window.currentFotoId, comentario);
                        } catch (error) {
                            console.error('Error al agregar comentario:', error);
                            alert('Error al agregar el comentario. Por favor, intenta de nuevo.');
                        }
                    }
                }
            }
        });

        const friendsModalClose = document.getElementById('friendsModalClose');
        if (friendsModalClose) {
            friendsModalClose.addEventListener('click', () => {
                if (window.hideFriendsModal) {
                    window.hideFriendsModal();
                }
            });
        }

        const inboxModalClose = document.getElementById('inboxModalClose');
        if (inboxModalClose) {
            inboxModalClose.addEventListener('click', () => {
                if (window.hideInboxModal) {
                    window.hideInboxModal();
                }
            });
        }

        // Cerrar modales al hacer clic fuera
        const friendsModal = document.getElementById('friendsModal');
        if (friendsModal) {
            friendsModal.addEventListener('click', (e) => {
                if (e.target === friendsModal) {
                    if (window.hideFriendsModal) {
                        window.hideFriendsModal();
                    }
                }
            });
        }

        const inboxModal = document.getElementById('inboxModal');
        if (inboxModal) {
            inboxModal.addEventListener('click', (e) => {
                if (e.target === inboxModal) {
                    if (window.hideInboxModal) {
                        window.hideInboxModal();
                    }
                }
            });
        }

        // Búsqueda de usuarios
        const friendsSearchBtn = document.getElementById('friendsSearchBtn');
        const friendsSearchInput = document.getElementById('friendsSearchInput');
        
        async function performSearch() {
            const searchTerm = friendsSearchInput.value.trim();
            const resultsEl = document.getElementById('friendsResults');
            
            if (!resultsEl) return;
            
            if (searchTerm.length < 2) {
                resultsEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #718096;">Escribe al menos 2 caracteres para buscar</div>';
                return;
            }
            
            resultsEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #718096;">Buscando...</div>';
            
            const users = await window.searchUsers(searchTerm);
            
            if (users.length === 0) {
                resultsEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #718096;">No se encontraron usuarios</div>';
                return;
            }
            
            resultsEl.innerHTML = '';
            users.forEach(user => {
                const userItem = document.createElement('div');
                userItem.className = 'friend-result-item';
                
                const picture = document.createElement('div');
                picture.className = 'friend-result-picture';
                if (user.fotoPerfil) {
                    const img = document.createElement('img');
                    img.src = user.fotoPerfil;
                    picture.appendChild(img);
                } else {
                    picture.textContent = '👤';
                }
                
                const info = document.createElement('div');
                info.className = 'friend-result-info';
                const name = document.createElement('div');
                name.className = 'friend-result-name';
                name.textContent = user.nombre;
                const email = document.createElement('div');
                email.className = 'friend-result-email';
                email.textContent = user.email;
                info.appendChild(name);
                info.appendChild(email);
                
                const actions = document.createElement('div');
                actions.className = 'friend-result-actions';
                
                const sendBtn = document.createElement('button');
                sendBtn.className = 'send-request-btn';
                sendBtn.textContent = '➕ Enviar Solicitud';
                sendBtn.onclick = async () => {
                    sendBtn.disabled = true;
                    sendBtn.textContent = 'Enviando...';
                    const success = await window.sendFriendRequest(user.id);
                    if (success) {
                        sendBtn.textContent = '✓ Enviada';
                        sendBtn.disabled = true;
                    } else {
                        sendBtn.textContent = '➕ Enviar Solicitud';
                        sendBtn.disabled = false;
                    }
                };
                
                actions.appendChild(sendBtn);
                
                userItem.appendChild(picture);
                userItem.appendChild(info);
                userItem.appendChild(actions);
                resultsEl.appendChild(userItem);
            });
        }
        
        if (friendsSearchBtn) {
            friendsSearchBtn.addEventListener('click', performSearch);
        }
        
        if (friendsSearchInput) {
            friendsSearchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
        }
        const viewRankingBtn = document.getElementById('viewRankingBtn');
        if (viewRankingBtn) {
            viewRankingBtn.addEventListener('click', showMainRanking);
        }
        
        const closeRankingBtn = document.getElementById('closeRankingBtn');
        if (closeRankingBtn) {
            closeRankingBtn.addEventListener('click', hideMainRanking);
        }
        
        // Función para inicializar los event listeners de los botones de clasificación
        function initRankingButtons() {
            // Event listeners para botones de clasificación por nivel usando delegación de eventos
            const rankingButtonsContainer = document.querySelector('.ranking-buttons');
            if (rankingButtonsContainer) {
                // Remover listener anterior si existe para evitar duplicados
                rankingButtonsContainer.removeEventListener('click', handleRankingButtonClick);
                rankingButtonsContainer.addEventListener('click', handleRankingButtonClick);
            }
            
            // También agregar listeners directos como respaldo
            const viewRankingEasyBtn = document.getElementById('viewRankingEasyBtn');
            if (viewRankingEasyBtn) {
                viewRankingEasyBtn.removeEventListener('click', handleEasyRankingClick);
                viewRankingEasyBtn.addEventListener('click', handleEasyRankingClick);
            }
            
            const viewRankingHardBtn = document.getElementById('viewRankingHardBtn');
            if (viewRankingHardBtn) {
                viewRankingHardBtn.removeEventListener('click', handleHardRankingClick);
                viewRankingHardBtn.addEventListener('click', handleHardRankingClick);
            }
            
            const viewRankingImpossibleBtn = document.getElementById('viewRankingImpossibleBtn');
            if (viewRankingImpossibleBtn) {
                viewRankingImpossibleBtn.removeEventListener('click', handleImpossibleRankingClick);
                viewRankingImpossibleBtn.addEventListener('click', handleImpossibleRankingClick);
            }
            
            const viewRankingGodBtn = document.getElementById('viewRankingGodBtn');
            if (viewRankingGodBtn) {
                viewRankingGodBtn.removeEventListener('click', handleGodRankingClick);
                viewRankingGodBtn.addEventListener('click', handleGodRankingClick);
            }
        }
        
        // Handler para delegación de eventos
        function handleRankingButtonClick(e) {
            // Buscar el botón clickeado (puede ser el botón mismo o un elemento hijo)
            const button = e.target.closest('.ranking-btn') || e.target;
            if (!button || !button.id) return;
            
            let level = null;
            
            if (button.id === 'viewRankingEasyBtn') {
                level = 'easy';
                console.log('Botón Clasificación Fácil clickeado');
            } else if (button.id === 'viewRankingHardBtn') {
                level = 'hard';
                console.log('Botón Clasificación Difícil clickeado');
            } else if (button.id === 'viewRankingImpossibleBtn') {
                level = 'impossible';
                console.log('Botón Clasificación Imposible clickeado');
            } else if (button.id === 'viewRankingGodBtn') {
                level = 'god';
                console.log('Botón Clasificación Dios clickeado');
            }
            
            if (level) {
                e.preventDefault();
                e.stopPropagation();
                if (window.showRankingByLevel) {
                    window.showRankingByLevel(level);
                } else {
                    console.error('showRankingByLevel no está disponible');
                }
            }
        }
        
        // Handlers individuales para cada botón
        function handleEasyRankingClick(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Botón Clasificación Fácil clickeado (directo)');
            if (window.showRankingByLevel) {
                window.showRankingByLevel('easy');
            } else {
                console.error('showRankingByLevel no está disponible');
            }
        }
        
        function handleHardRankingClick(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Botón Clasificación Difícil clickeado (directo)');
            if (window.showRankingByLevel) {
                window.showRankingByLevel('hard');
            } else {
                console.error('showRankingByLevel no está disponible');
            }
        }
        
        function handleImpossibleRankingClick(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Botón Clasificación Imposible clickeado (directo)');
            if (window.showRankingByLevel) {
                window.showRankingByLevel('impossible');
            } else {
                console.error('showRankingByLevel no está disponible');
            }
        }
        
        function handleGodRankingClick(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Botón Clasificación Dios clickeado (directo)');
            if (window.showRankingByLevel) {
                window.showRankingByLevel('god');
            } else {
                console.error('showRankingByLevel no está disponible');
            }
        }
        
        // Inicializar los botones cuando el DOM esté listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initRankingButtons);
        } else {
            // DOM ya está listo
            initRankingButtons();
        }
        
        // También inicializar después de un pequeño delay para asegurar que todo esté cargado
        setTimeout(initRankingButtons, 100);
        
        // Event listeners para autenticación
        document.getElementById('loginTab').addEventListener('click', () => switchAuthTab('login'));
        document.getElementById('registerTab').addEventListener('click', () => switchAuthTab('register'));
        document.getElementById('loginBtn').addEventListener('click', handleLogin);
        document.getElementById('registerBtn').addEventListener('click', handleRegister);
        
        // Permitir login/registro con Enter
        document.getElementById('loginEmail').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleLogin();
        });
        document.getElementById('loginPassword').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleLogin();
        });
        document.getElementById('registerName').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleRegister();
        });
        document.getElementById('registerEmail').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleRegister();
        });
        document.getElementById('registerPassword').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleRegister();
        });
        
        // Event listeners para foto de perfil
        const profilePictureCircle = document.getElementById('profilePictureCircle');
        const profileModalClose = document.getElementById('profileModalClose');
        const profilePictureInput = document.getElementById('profilePictureInput');
        const profileModal = document.getElementById('profileModal');
        
        if (profilePictureCircle) {
            profilePictureCircle.addEventListener('click', () => {
                if (window.showProfileModal) {
                    window.showProfileModal();
                }
            });
        }
        
        if (profileModalClose) {
            profileModalClose.addEventListener('click', () => {
                if (window.hideProfileModal) {
                    window.hideProfileModal();
                }
            });
        }
        
        // Cerrar modal al hacer clic fuera
        if (profileModal) {
            profileModal.addEventListener('click', (e) => {
                if (e.target === profileModal) {
                    if (window.hideProfileModal) {
                        window.hideProfileModal();
                    }
                }
            });
        }
        
        // Manejar subida de foto
        if (profilePictureInput) {
            profilePictureInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const saveBtn = document.getElementById('profileSaveBtn');
                    if (saveBtn) {
                        saveBtn.style.display = 'block';
                        saveBtn.textContent = '💾 Guardando...';
                        saveBtn.disabled = true;
                    }
                    
                    // Mostrar preview antes de subir
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const largeImg = document.getElementById('profilePictureLargeImg');
                        const largePlaceholder = document.getElementById('profilePictureLargePlaceholder');
                        if (largeImg) {
                            largeImg.src = event.target.result;
                            largeImg.style.display = 'block';
                            if (largePlaceholder) largePlaceholder.style.display = 'none';
                        }
                    };
                    reader.readAsDataURL(file);
                    
                    // Subir foto
                    const success = await window.uploadProfilePicture(file);
                    
                    if (saveBtn) {
                        if (success) {
                            saveBtn.textContent = '✅ Guardado';
                            setTimeout(() => {
                                saveBtn.style.display = 'none';
                            }, 2000);
                        } else {
                            saveBtn.textContent = '❌ Error';
                            saveBtn.disabled = false;
                        }
                    }
                    
                    // Limpiar input
                    e.target.value = '';
                }
            });
        }
        
        // Hacer funciones disponibles globalmente
        window.updateUserDisplay = updateUserDisplay;
        window.loadMainRanking = loadMainRanking;

        // Verificar y redirigir si es necesario (para PWA)
        if (window.location.pathname === '/' && !window.location.href.includes('Juego_Banderas')) {
            window.location.href = 'https://martinpenalva.github.io/Juego_Banderas/index.html';
        }

        // Inicializar corazones
        updateHearts();

        // No iniciar automáticamente - esperar a que el usuario seleccione dificultad
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs, doc, setDoc, getDoc, where, updateDoc, onSnapshot, writeBatch } 
            from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } 
            from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } 
            from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // Configuración de tu proyecto
        const firebaseConfig = {
            apiKey: "AIzaSyDyf2mRx0S1CBOH7u4N8kINoH6Bxe_ItZo",
            authDomain: "banderas-f31cf.firebaseapp.com",
            projectId: "banderas-f31cf",
            storageBucket: "banderas-f31cf.firebasestorage.app",
            messagingSenderId: "413939026360",
            appId: "1:413939026360:web:b6e8b65c1f86cc9cf2274d",
            measurementId: "G-H2LGX84Z2Z"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);

        // Marcar que Firebase está listo
        window.firebaseReady = true;

        // Definir funciones de autenticación inmediatamente para que estén disponibles
        window.iniciarSesion = async function(email, password) {
            try {
                // Verificar que auth esté inicializado
                if (!auth) {
                    console.error("Auth no está inicializado");
                    return { success: false, error: "Auth no está inicializado. Por favor, recarga la página." };
                }
                
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // Obtener nombre de usuario desde Firestore
                if (db) {
                    try {
                        const userDoc = await getDoc(doc(db, "usuarios", user.uid));
                        if (userDoc.exists()) {
                            window.currentUserName = userDoc.data().nombre;
                        } else {
                            window.currentUserName = user.email.split('@')[0];
                        }
                    } catch (dbError) {
                        console.error("Error al obtener datos del usuario desde Firestore:", dbError);
                        window.currentUserName = user.email.split('@')[0];
                    }
                } else {
                    window.currentUserName = user.email.split('@')[0];
                }
                
                window.currentUser = user;
                return { success: true, user: user };
            } catch (error) {
                console.error("Error al iniciar sesión: ", error);
                return { success: false, error: error.message || error.toString() };
            }
        };

        window.registrarUsuario = async function(email, password, nombre) {
            try {
                // Verificar que auth esté inicializado
                if (!auth) {
                    console.error("Auth no está inicializado");
                    return { success: false, error: "Auth no está inicializado. Por favor, recarga la página." };
                }
                
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // Guardar nombre de usuario en Firestore
                if (db) {
                    await setDoc(doc(db, "usuarios", user.uid), {
                        nombre: nombre,
                        email: email,
                        fechaRegistro: Date.now(),
                        amigos: [],
                        mostrarPuntuaciones: true
                    });
                } else {
                    console.error("Firestore no está inicializado");
                    return { success: false, error: "Firestore no está inicializado. Por favor, recarga la página." };
                }
                
                window.currentUser = user;
                window.currentUserName = nombre;
                return { success: true, user: user };
            } catch (error) {
                console.error("Error al registrar: ", error);
                return { success: false, error: error.message || error.toString() };
            }
        };

        // Limpiar bibliotecas (función auxiliar)
        function clearLibraries() {
            // Limpiar biblioteca propia
            const libraryGrid = document.getElementById('libraryGrid');
            if (libraryGrid) {
                libraryGrid.innerHTML = '';
            }
            
            // Limpiar biblioteca del amigo
            const friendLibraryGrid = document.getElementById('friendLibraryGrid');
            const friendLibrarySection = document.getElementById('friendLibrarySection');
            if (friendLibraryGrid) {
                friendLibraryGrid.innerHTML = '';
            }
            if (friendLibrarySection) {
                friendLibrarySection.style.display = 'none';
            }
            
            // Cerrar modal de imagen si está abierto
            if (window.hideLibraryImage) {
                window.hideLibraryImage();
            }
        }

        // Variable global para el usuario actual
        window.currentUser = null;
        window.currentUserName = null;


        window.cerrarSesion = async function() {
            try {
                await signOut(auth);
                window.currentUser = null;
                window.currentUserName = null;
                return true;
            } catch (error) {
                console.error("Error al cerrar sesión: ", error);
                return false;
            }
        };

        // Observar cambios en el estado de autenticación
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                window.currentUser = user;
                // Obtener nombre de usuario
                try {
                    const userDoc = await getDoc(doc(db, "usuarios", user.uid));
                    if (userDoc.exists()) {
                        window.currentUserName = userDoc.data().nombre;
                    } else {
                        window.currentUserName = user.email.split('@')[0];
                    }
                } catch (e) {
                    window.currentUserName = user.email.split('@')[0];
                }
                
                // Ocultar pantalla de autenticación y mostrar juego
                document.getElementById('authContainer').style.display = 'none';
                document.getElementById('gameContainer').style.display = 'block';
                document.getElementById('profilePictureContainer').style.display = 'block';
                if (window.updateUserDisplay) {
                    window.updateUserDisplay();
                }
                
                // Cargar foto de perfil
                loadProfilePicture();
                
                // Limpiar bibliotecas al cambiar de usuario
                clearLibraries();
                
                // No cargar ranking automáticamente - el usuario debe hacer clic en el botón "Ver Tabla"
            } else {
                window.currentUser = null;
                window.currentUserName = null;
                // Mostrar pantalla de autenticación y ocultar juego
                document.getElementById('authContainer').style.display = 'flex';
                document.getElementById('gameContainer').style.display = 'none';
                document.getElementById('profilePictureContainer').style.display = 'none';
                // Limpiar foto de perfil
                clearProfilePicture();
                // Limpiar bibliotecas
                clearLibraries();
            }
        });

        // ----------- FOTO DE PERFIL -------------
        // Cargar foto de perfil desde Firestore
        window.loadProfilePicture = async function() {
            if (!window.currentUser) return;
            
            try {
                // Obtener documento del usuario desde Firestore
                const userDocRef = doc(db, "usuarios", window.currentUser.uid);
                const userDoc = await getDoc(userDocRef);
                
                if (userDoc.exists() && userDoc.data().fotoPerfil) {
                    const fotoBase64 = userDoc.data().fotoPerfil;
                    
                    // Actualizar círculo pequeño
                    const smallImg = document.getElementById('profilePictureImg');
                    const smallPlaceholder = document.getElementById('profilePicturePlaceholder');
                    if (smallImg) {
                        smallImg.src = fotoBase64;
                        smallImg.style.display = 'block';
                        if (smallPlaceholder) smallPlaceholder.style.display = 'none';
                    }
                    
                    // Actualizar círculo grande en el modal
                    const largeImg = document.getElementById('profilePictureLargeImg');
                    const largePlaceholder = document.getElementById('profilePictureLargePlaceholder');
                    if (largeImg) {
                        largeImg.src = fotoBase64;
                        largeImg.style.display = 'block';
                        if (largePlaceholder) largePlaceholder.style.display = 'none';
                    }
                } else {
                    // No hay foto, mostrar placeholder
                    clearProfilePicture();
                }
            } catch (error) {
                console.log('No se pudo cargar la foto de perfil:', error.message);
                clearProfilePicture();
            }
        };

        // Cargar foto de perfil de un usuario específico (para ranking) desde Firestore
        window.loadUserProfilePicture = async function(userId, containerElement) {
            if (!userId || !containerElement) return;
            
            try {
                // Obtener documento del usuario desde Firestore
                const userDocRef = doc(db, "usuarios", userId);
                const userDoc = await getDoc(userDocRef);
                
                if (userDoc.exists() && userDoc.data().fotoPerfil) {
                    const fotoBase64 = userDoc.data().fotoPerfil;
                    
                    const img = document.createElement('img');
                    img.src = fotoBase64;
                    img.alt = 'Foto de perfil';
                    containerElement.innerHTML = '';
                    containerElement.appendChild(img);
                } else {
                    // No hay foto, mostrar placeholder
                    const placeholder = document.createElement('div');
                    placeholder.className = 'placeholder';
                    placeholder.textContent = '👤';
                    containerElement.innerHTML = '';
                    containerElement.appendChild(placeholder);
                }
            } catch (error) {
                console.log(`No se pudo cargar foto de perfil para usuario ${userId}:`, error.message);
                
                // Mostrar placeholder en caso de error
                const placeholder = document.createElement('div');
                placeholder.className = 'placeholder';
                placeholder.textContent = '👤';
                containerElement.innerHTML = '';
                containerElement.appendChild(placeholder);
            }
        };

        // Limpiar foto de perfil (mostrar placeholder)
        function clearProfilePicture() {
            const smallImg = document.getElementById('profilePictureImg');
            const smallPlaceholder = document.getElementById('profilePicturePlaceholder');
            if (smallImg) {
                smallImg.src = '';
                smallImg.style.display = 'none';
            }
            if (smallPlaceholder) smallPlaceholder.style.display = 'block';
            
            const largeImg = document.getElementById('profilePictureLargeImg');
            const largePlaceholder = document.getElementById('profilePictureLargePlaceholder');
            if (largeImg) {
                largeImg.src = '';
                largeImg.style.display = 'none';
            }
            if (largePlaceholder) largePlaceholder.style.display = 'block';
        }

        // Función para comprimir imagen
        function compressImage(file, maxWidth = 300, maxHeight = 300, quality = 0.8) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        // Calcular nuevas dimensiones manteniendo la proporción
                        if (width > height) {
                            if (width > maxWidth) {
                                height = (height * maxWidth) / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width = (width * maxHeight) / height;
                                height = maxHeight;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Convertir a base64 con compresión
                        const base64 = canvas.toDataURL('image/jpeg', quality);
                        resolve(base64);
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }

        // Subir foto de perfil (guardar como base64 en Firestore)
        window.uploadProfilePicture = async function(file) {
            if (!window.currentUser || !file) return false;
            
            try {
                // Validar que sea una imagen
                if (!file.type.startsWith('image/')) {
                    alert('Por favor, selecciona un archivo de imagen');
                    return false;
                }
                
                // Validar tamaño original (máximo 10MB antes de comprimir)
                if (file.size > 10 * 1024 * 1024) {
                    alert('La imagen es demasiado grande. Máximo 10MB');
                    return false;
                }
                
                // Comprimir imagen antes de guardar
                const compressedBase64 = await compressImage(file, 300, 300, 0.8);
                
                // Guardar en Firestore en el documento del usuario
                const userDocRef = doc(db, "usuarios", window.currentUser.uid);
                await updateDoc(userDocRef, {
                    fotoPerfil: compressedBase64,
                    fotoPerfilFecha: Date.now()
                });
                
                console.log('✅ Foto de perfil guardada en Firestore');
                
                // Actualizar círculo pequeño
                const smallImg = document.getElementById('profilePictureImg');
                const smallPlaceholder = document.getElementById('profilePicturePlaceholder');
                if (smallImg) {
                    smallImg.src = compressedBase64;
                    smallImg.style.display = 'block';
                    if (smallPlaceholder) smallPlaceholder.style.display = 'none';
                }
                
                // Actualizar círculo grande en el modal
                const largeImg = document.getElementById('profilePictureLargeImg');
                const largePlaceholder = document.getElementById('profilePictureLargePlaceholder');
                if (largeImg) {
                    largeImg.src = compressedBase64;
                    largeImg.style.display = 'block';
                    if (largePlaceholder) largePlaceholder.style.display = 'none';
                }
                
                return true;
            } catch (error) {
                console.error('Error al subir foto de perfil:', error);
                alert('Error al subir la foto. Intenta de nuevo.');
                return false;
            }
        };

        // Mostrar modal de perfil
        window.showProfileModal = function() {
            if (!window.currentUser) return;
            
            const modal = document.getElementById('profileModal');
            const profileName = document.getElementById('profileName');
            const profileEmail = document.getElementById('profileEmail');
            
            if (modal && profileName && profileEmail) {
                profileName.textContent = window.currentUserName || '-';
                profileEmail.textContent = window.currentUser.email || '-';
                modal.style.display = 'flex';
                
                // Cargar lista de amigos
                if (window.loadFriendsList) {
                    window.loadFriendsList();
                }
                
                // Cargar preferencia de mostrar puntuaciones
                if (window.loadScoresPreference) {
                    window.loadScoresPreference();
                }
                
                // Cargar puntuaciones si están visibles
                const scoresSection = document.getElementById('profileScoresSection');
                if (scoresSection && scoresSection.style.display !== 'none') {
                    if (window.loadUserScores) {
                        window.loadUserScores();
                    }
                }
                
                // Cargar descripción
                if (window.loadProfileDescription) {
                    window.loadProfileDescription();
                }
                
                // Cargar biblioteca (limpiar primero para evitar mostrar fotos de otro usuario)
                if (typeof clearLibraries === 'function') {
                    clearLibraries();
                }
                if (window.loadLibrary) {
                    window.loadLibrary();
                }
                
                // NO cargar la lista de chats automáticamente
                // Solo se abrirá cuando el usuario haga clic en el botón de mensaje de un amigo
                const chatsSection = document.getElementById('profileChatsSection');
                const activeChat = document.getElementById('profileActiveChat');
                if (chatsSection) {
                    chatsSection.style.display = 'none';
                }
                if (activeChat) {
                    activeChat.style.display = 'none';
                }
            }
        };

        // Ocultar modal de perfil
        window.hideProfileModal = function() {
            const modal = document.getElementById('profileModal');
            const saveBtn = document.getElementById('profileSaveBtn');
            const friendsModal = document.getElementById('friendsModal');
            const inboxModal = document.getElementById('inboxModal');
            const friendProfileModal = document.getElementById('friendProfileModal');
            if (modal) {
                modal.style.display = 'none';
            }
            if (saveBtn) {
                saveBtn.style.display = 'none';
            }
            if (friendsModal) {
                friendsModal.style.display = 'none';
            }
            if (inboxModal) {
                inboxModal.style.display = 'none';
            }
            if (friendProfileModal) {
                friendProfileModal.style.display = 'none';
            }
        };

        // Cargar preferencia de mostrar puntuaciones
        window.loadScoresPreference = async function() {
            if (!window.currentUser) return;
            
            try {
                const userDoc = await getDoc(doc(db, "usuarios", window.currentUser.uid));
                if (userDoc.exists()) {
                    const mostrarPuntuaciones = userDoc.data().mostrarPuntuaciones !== false; // Por defecto true
                    const toggleBtn = document.getElementById('profileToggleScoresBtn');
                    const scoresSection = document.getElementById('profileScoresSection');
                    
                    if (toggleBtn) {
                        if (mostrarPuntuaciones) {
                            toggleBtn.textContent = '🔒 Ocultar Puntuaciones';
                            toggleBtn.classList.remove('hidden');
                        } else {
                            toggleBtn.textContent = '📊 Mostrar Puntuaciones';
                            toggleBtn.classList.add('hidden');
                        }
                    }
                    
                    if (scoresSection) {
                        scoresSection.style.display = mostrarPuntuaciones ? 'block' : 'none';
                    }
                }
            } catch (error) {
                console.error('Error al cargar preferencia de puntuaciones:', error);
            }
        };

        // Toggle mostrar/ocultar puntuaciones
        window.toggleScoresVisibility = async function() {
            if (!window.currentUser) return;
            
            try {
                const userDoc = await getDoc(doc(db, "usuarios", window.currentUser.uid));
                const currentValue = userDoc.exists() ? (userDoc.data().mostrarPuntuaciones !== false) : true;
                const newValue = !currentValue;
                
                await updateDoc(doc(db, "usuarios", window.currentUser.uid), {
                    mostrarPuntuaciones: newValue
                });
                
                const toggleBtn = document.getElementById('profileToggleScoresBtn');
                const scoresSection = document.getElementById('profileScoresSection');
                
                if (toggleBtn) {
                    if (newValue) {
                        toggleBtn.textContent = '🔒 Ocultar Puntuaciones';
                        toggleBtn.classList.remove('hidden');
                    } else {
                        toggleBtn.textContent = '📊 Mostrar Puntuaciones';
                        toggleBtn.classList.add('hidden');
                    }
                }
                
                if (scoresSection) {
                    scoresSection.style.display = newValue ? 'block' : 'none';
                }
                
                // Recargar puntuaciones si se muestran
                if (newValue && window.loadUserScores) {
                    await window.loadUserScores();
                }
            } catch (error) {
                console.error('Error al actualizar preferencia de puntuaciones:', error);
                alert('Error al actualizar la preferencia');
            }
        };

        // Cargar puntuaciones del usuario actual
        window.loadUserScores = async function() {
            if (!window.currentUser) return;
            
            try {
                const scoresRef = collection(db, "puntuaciones");
                const q = query(
                    scoresRef,
                    where("userId", "==", window.currentUser.uid)
                );
                const snapshot = await getDocs(q);
                
                const scoresByLevel = {};
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const nivel = data.nivel || 'unknown';
                    const puntos = data.puntos || 0;
                    
                    // Guardar la puntuación máxima por nivel
                    if (!scoresByLevel[nivel] || puntos > scoresByLevel[nivel]) {
                        scoresByLevel[nivel] = puntos;
                    }
                });
                
                const scoresListEl = document.getElementById('scoresList');
                if (!scoresListEl) return;
                
                scoresListEl.innerHTML = '';
                
                const niveles = [
                    { key: 'easy', name: '🟢 Fácil' },
                    { key: 'hard', name: '🔴 Difícil' },
                    { key: 'impossible', name: '⚫ Imposible' }
                ];
                
                niveles.forEach(nivel => {
                    const scoreItem = document.createElement('div');
                    scoreItem.className = 'score-item';
                    
                    const level = document.createElement('div');
                    level.className = 'score-item-level';
                    level.textContent = nivel.name;
                    
                    const points = document.createElement('div');
                    points.className = 'score-item-points';
                    points.textContent = scoresByLevel[nivel.key] || '0';
                    
                    scoreItem.appendChild(level);
                    scoreItem.appendChild(points);
                    scoresListEl.appendChild(scoreItem);
                });
            } catch (error) {
                console.error('Error al cargar puntuaciones:', error);
            }
        };

        // Mostrar perfil de un amigo
        window.showFriendProfile = async function(friendId, friendData = null) {
            if (!friendId) return;
            
            try {
                // Cargar datos del amigo si no se proporcionaron
                if (!friendData) {
                    const friendDoc = await getDoc(doc(db, "usuarios", friendId));
                    if (!friendDoc.exists()) {
                        alert('Usuario no encontrado');
                        return;
                    }
                    friendData = friendDoc.data();
                }
                
                const modal = document.getElementById('friendProfileModal');
                const nameEl = document.getElementById('friendProfileName');
                const emailEl = document.getElementById('friendProfileEmail');
                const pictureLarge = document.getElementById('friendProfilePictureLarge');
                const pictureLargeImg = document.getElementById('friendProfilePictureLargeImg');
                const pictureLargePlaceholder = document.getElementById('friendProfilePictureLargePlaceholder');
                const scoresSection = document.getElementById('friendProfileScoresSection');
                
                if (!modal || !nameEl || !emailEl) return;
                
                // Mostrar información básica
                nameEl.textContent = friendData.nombre || 'Sin nombre';
                emailEl.textContent = friendData.email || '-';
                
                // Mostrar foto de perfil
                if (friendData.fotoPerfil) {
                    if (pictureLargeImg) {
                        pictureLargeImg.src = friendData.fotoPerfil;
                        pictureLargeImg.style.display = 'block';
                    }
                    if (pictureLargePlaceholder) {
                        pictureLargePlaceholder.style.display = 'none';
                    }
                } else {
                    if (pictureLargeImg) {
                        pictureLargeImg.style.display = 'none';
                    }
                    if (pictureLargePlaceholder) {
                        pictureLargePlaceholder.style.display = 'block';
                    }
                }
                
                // Mostrar descripción si existe (solo visible para amigos)
                const descriptionItem = document.getElementById('friendDescriptionItem');
                const descriptionEl = document.getElementById('friendProfileDescription');
                if (friendData.descripcion && friendData.descripcion.trim()) {
                    if (descriptionEl) {
                        descriptionEl.textContent = friendData.descripcion;
                    }
                    if (descriptionItem) {
                        descriptionItem.style.display = 'flex';
                    }
                } else {
                    if (descriptionItem) {
                        descriptionItem.style.display = 'none';
                    }
                }
                
                // Configurar botón de eliminar amigo
                const removeFriendBtn = document.getElementById('removeFriendBtn');
                if (removeFriendBtn) {
                    removeFriendBtn.onclick = async () => {
                        if (confirm(`¿Estás seguro de que quieres eliminar a ${friendData.nombre || 'este amigo'}?`)) {
                            const success = await window.removeFriend(friendId);
                            if (success) {
                                window.hideFriendProfileModal();
                                await window.loadFriendsList();
                            }
                        }
                    };
                }
                
                // Verificar si el amigo tiene la opción de mostrar puntuaciones activada
                const mostrarPuntuaciones = friendData.mostrarPuntuaciones !== false; // Por defecto true
                
                if (mostrarPuntuaciones) {
                    // Cargar puntuaciones del amigo
                    await loadFriendScores(friendId);
                    if (scoresSection) {
                        scoresSection.style.display = 'block';
                    }
                } else {
                    if (scoresSection) {
                        scoresSection.style.display = 'none';
                    }
                }
                
                // Limpiar biblioteca del amigo primero
                const friendLibraryGrid = document.getElementById('friendLibraryGrid');
                const friendLibrarySection = document.getElementById('friendLibrarySection');
                if (friendLibraryGrid) {
                    friendLibraryGrid.innerHTML = '';
                }
                if (friendLibrarySection) {
                    friendLibrarySection.style.display = 'none';
                }
                
                // Cargar biblioteca del amigo (solo visible para amigos)
                if (window.loadFriendLibrary) {
                    await window.loadFriendLibrary(friendId);
                }
                
                modal.style.display = 'flex';
            } catch (error) {
                console.error('Error al cargar perfil de amigo:', error);
                alert('Error al cargar el perfil del amigo');
            }
        };

        // Cargar puntuaciones de un amigo
        async function loadFriendScores(friendId) {
            try {
                const scoresRef = collection(db, "puntuaciones");
                const q = query(
                    scoresRef,
                    where("userId", "==", friendId)
                );
                const snapshot = await getDocs(q);
                
                const scoresByLevel = {};
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const nivel = data.nivel || 'unknown';
                    const puntos = data.puntos || 0;
                    
                    // Guardar la puntuación máxima por nivel
                    if (!scoresByLevel[nivel] || puntos > scoresByLevel[nivel]) {
                        scoresByLevel[nivel] = puntos;
                    }
                });
                
                const scoresListEl = document.getElementById('friendScoresList');
                if (!scoresListEl) return;
                
                scoresListEl.innerHTML = '';
                
                const niveles = [
                    { key: 'easy', name: '🟢 Fácil' },
                    { key: 'hard', name: '🔴 Difícil' },
                    { key: 'impossible', name: '⚫ Imposible' }
                ];
                
                niveles.forEach(nivel => {
                    const scoreItem = document.createElement('div');
                    scoreItem.className = 'score-item';
                    
                    const level = document.createElement('div');
                    level.className = 'score-item-level';
                    level.textContent = nivel.name;
                    
                    const points = document.createElement('div');
                    points.className = 'score-item-points';
                    points.textContent = scoresByLevel[nivel.key] || '0';
                    
                    scoreItem.appendChild(level);
                    scoreItem.appendChild(points);
                    scoresListEl.appendChild(scoreItem);
                });
            } catch (error) {
                console.error('Error al cargar puntuaciones del amigo:', error);
            }
        };

        // Ocultar modal de perfil de amigo
        window.hideFriendProfileModal = function() {
            const modal = document.getElementById('friendProfileModal');
            if (modal) {
                modal.style.display = 'none';
            }
        };

        // Guardar descripción del perfil
        window.saveProfileDescription = async function() {
            if (!window.currentUser) return false;
            
            try {
                const descriptionInput = document.getElementById('profileDescription');
                if (!descriptionInput) return false;
                
                const descripcion = descriptionInput.value.trim();
                
                await updateDoc(doc(db, "usuarios", window.currentUser.uid), {
                    descripcion: descripcion
                });
                
                const saveBtn = document.getElementById('profileSaveDescriptionBtn');
                if (saveBtn) {
                    const originalText = saveBtn.textContent;
                    saveBtn.textContent = '✅ Guardado';
                    saveBtn.disabled = true;
                    setTimeout(() => {
                        saveBtn.textContent = originalText;
                        saveBtn.disabled = false;
                    }, 2000);
                }
                
                return true;
            } catch (error) {
                console.error('Error al guardar descripción:', error);
                alert('Error al guardar la descripción');
                return false;
            }
        };

        // Cargar descripción del perfil
        window.loadProfileDescription = async function() {
            if (!window.currentUser) return;
            
            try {
                const userDoc = await getDoc(doc(db, "usuarios", window.currentUser.uid));
                if (userDoc.exists()) {
                    const descripcion = userDoc.data().descripcion || '';
                    const descriptionInput = document.getElementById('profileDescription');
                    if (descriptionInput) {
                        descriptionInput.value = descripcion;
                    }
                }
            } catch (error) {
                console.error('Error al cargar descripción:', error);
            }
        };

        // Comprimir imagen para biblioteca (similar a foto de perfil)
        async function compressLibraryImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const maxWidth = 800;
                        const maxHeight = 800;
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > height) {
                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width *= maxHeight / height;
                                height = maxHeight;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        const compressedBase64 = canvas.toDataURL('image/jpeg', 0.8);
                        resolve(compressedBase64);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // Subir foto a la biblioteca
        window.uploadLibraryImage = async function(file) {
            if (!window.currentUser) return false;
            
            try {
                const compressedBase64 = await compressLibraryImage(file);
                
                const userDoc = await getDoc(doc(db, "usuarios", window.currentUser.uid));
                const biblioteca = userDoc.exists() ? (userDoc.data().biblioteca || []) : [];
                
                biblioteca.push(compressedBase64);
                
                await updateDoc(doc(db, "usuarios", window.currentUser.uid), {
                    biblioteca: biblioteca
                });
                
                // Recargar biblioteca
                await window.loadLibrary();
                
                return true;
            } catch (error) {
                console.error('Error al subir foto a biblioteca:', error);
                alert('Error al subir la foto');
                return false;
            }
        };

        // Cargar biblioteca propia
        window.loadLibrary = async function() {
            if (!window.currentUser) return;
            
            try {
                const userDoc = await getDoc(doc(db, "usuarios", window.currentUser.uid));
                const biblioteca = userDoc.exists() ? (userDoc.data().biblioteca || []) : [];
                
                const libraryGrid = document.getElementById('libraryGrid');
                if (!libraryGrid) return;
                
                libraryGrid.innerHTML = '';
                
                // Usar Promise.all para esperar a que se generen todos los fotoIds
                const items = await Promise.all(biblioteca.map(async (imageBase64, index) => {
                    const libraryItem = document.createElement('div');
                    libraryItem.className = 'library-item';
                    
                    const img = document.createElement('img');
                    img.src = imageBase64;
                    img.alt = `Foto ${index + 1}`;
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'library-item-remove';
                    removeBtn.textContent = '✕';
                    removeBtn.onclick = async (e) => {
                        e.stopPropagation();
                        if (confirm('¿Estás seguro de que quieres eliminar esta foto?')) {
                            await window.removeLibraryImage(index);
                        }
                    };
                    
                    // Generar fotoId único
                    const fotoId = await generateFotoId(imageBase64, window.currentUser.uid, index);
                    console.log(`Foto ${index} - fotoId generado:`, fotoId);
                    
                    libraryItem.onclick = async () => {
                        console.log('Click en foto, abriendo con fotoId:', fotoId);
                        await window.showLibraryImage(imageBase64, fotoId, window.currentUser.uid);
                    };
                    
                    libraryItem.appendChild(img);
                    libraryItem.appendChild(removeBtn);
                    return libraryItem;
                }));
                
                items.forEach(item => libraryGrid.appendChild(item));
            } catch (error) {
                console.error('Error al cargar biblioteca:', error);
            }
        };

        // Cargar biblioteca del amigo
        window.loadFriendLibrary = async function(friendId) {
            if (!friendId) return;
            
            try {
                const friendDoc = await getDoc(doc(db, "usuarios", friendId));
                if (!friendDoc.exists()) return;
                
                const biblioteca = friendDoc.data().biblioteca || [];
                const friendLibraryGrid = document.getElementById('friendLibraryGrid');
                const friendLibrarySection = document.getElementById('friendLibrarySection');
                
                if (!friendLibraryGrid || !friendLibrarySection) return;
                
                if (biblioteca.length === 0) {
                    friendLibrarySection.style.display = 'none';
                    return;
                }
                
                friendLibrarySection.style.display = 'block';
                friendLibraryGrid.innerHTML = '';
                
                // Usar Promise.all para esperar a que se generen todos los fotoIds
                const items = await Promise.all(biblioteca.map(async (imageBase64, index) => {
                    const libraryItem = document.createElement('div');
                    libraryItem.className = 'friend-library-item';
                    
                    const img = document.createElement('img');
                    img.src = imageBase64;
                    img.alt = 'Foto de biblioteca';
                    
                    // Generar fotoId único
                    const fotoId = await generateFotoId(imageBase64, friendId, index);
                    console.log(`Foto amigo ${index} - fotoId generado:`, fotoId);
                    
                    libraryItem.onclick = async () => {
                        console.log('Click en foto de amigo, abriendo con fotoId:', fotoId);
                        await window.showLibraryImage(imageBase64, fotoId, friendId);
                    };
                    
                    libraryItem.appendChild(img);
                    return libraryItem;
                }));
                
                items.forEach(item => friendLibraryGrid.appendChild(item));
            } catch (error) {
                console.error('Error al cargar biblioteca del amigo:', error);
            }
        };

        // Eliminar foto de la biblioteca
        window.removeLibraryImage = async function(index) {
            if (!window.currentUser) return false;
            
            try {
                const userDoc = await getDoc(doc(db, "usuarios", window.currentUser.uid));
                const biblioteca = userDoc.exists() ? (userDoc.data().biblioteca || []) : [];
                
                biblioteca.splice(index, 1);
                
                await updateDoc(doc(db, "usuarios", window.currentUser.uid), {
                    biblioteca: biblioteca
                });
                
                // Recargar biblioteca
                await window.loadLibrary();
                
                return true;
            } catch (error) {
                console.error('Error al eliminar foto:', error);
                alert('Error al eliminar la foto');
                return false;
            }
        };

        // Generar ID único para una foto basado en su contenido
        async function generateFotoId(imageBase64, userId, index) {
            // Crear un hash del contenido de la imagen + userId + index para que sea único para cada foto
            // Incluir el índice para asegurar que cada foto tenga un ID único incluso si tienen contenido similar
            // Usar una parte del base64 (primeros 1000 caracteres) + userId + index
            const contentToHash = imageBase64.substring(0, 1000) + userId + '_' + index + '_' + imageBase64.length;
            const hash = await hashString(contentToHash);
            return `foto_${userId}_${index}_${hash}`;
        }

        // Función auxiliar para crear hash simple
        async function hashString(str) {
            const encoder = new TextEncoder();
            const data = encoder.encode(str);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('').substring(0, 16);
        }

        // Mostrar imagen en grande
        window.showLibraryImage = async function(imageBase64, fotoId = null, ownerId = null) {
            const modal = document.getElementById('libraryImageModal');
            const modalImg = document.getElementById('libraryImageModalImg');
            
            if (modal && modalImg) {
                modalImg.src = imageBase64;
                window.currentFotoId = fotoId;
                window.currentFotoOwnerId = ownerId;
                window.currentImageBase64 = imageBase64; // Guardar para la vista ampliada
                console.log('Mostrando imagen, fotoId:', fotoId, 'ownerId:', ownerId);
                modal.style.display = 'flex';
                
                // Agregar evento click en la imagen para vista ampliada
                const imageContainer = document.getElementById('libraryImageContainer');
                if (imageContainer) {
                    imageContainer.onclick = () => {
                        window.showLibraryImageZoom(imageBase64);
                    };
                }
                
                // Cargar likes y comentarios si hay fotoId
                if (fotoId) {
                    try {
                        await loadFotoLikes(fotoId);
                        await loadFotoComments(fotoId);
                    } catch (error) {
                        console.error('Error al cargar likes/comentarios:', error);
                    }
                } else {
                    console.warn('No hay fotoId, limpiando likes y comentarios');
                    // Si no hay fotoId, limpiar likes y comentarios
                    const likeCountEl = document.getElementById('libraryImageLikeCount');
                    const commentsListEl = document.getElementById('libraryImageCommentsList');
                    const likeBtn = document.getElementById('libraryImageLikeBtn');
                    if (likeCountEl) likeCountEl.textContent = '0';
                    if (commentsListEl) commentsListEl.innerHTML = '';
                    if (likeBtn) likeBtn.classList.remove('liked');
                }
            } else {
                console.error('Modal o imagen no encontrados');
            }
        };

        // Mostrar imagen en vista ampliada
        window.showLibraryImageZoom = function(imageBase64) {
            const zoomModal = document.getElementById('libraryImageZoomModal');
            const zoomImg = document.getElementById('libraryImageZoomImg');
            
            if (zoomModal && zoomImg) {
                zoomImg.src = imageBase64;
                zoomModal.classList.add('active');
            }
        };

        // Ocultar vista ampliada y volver a comentarios
        window.hideLibraryImageZoom = function() {
            const zoomModal = document.getElementById('libraryImageZoomModal');
            if (zoomModal) {
                zoomModal.classList.remove('active');
            }
        };

        // Ocultar imagen en grande
        window.hideLibraryImage = function() {
            const modal = document.getElementById('libraryImageModal');
            const zoomModal = document.getElementById('libraryImageZoomModal');
            if (modal) {
                modal.style.display = 'none';
                window.currentFotoId = null;
                window.currentFotoOwnerId = null;
                window.currentImageBase64 = null;
            }
            // También cerrar el zoom si está abierto
            if (zoomModal) {
                zoomModal.classList.remove('active');
            }
        };

        // ----------- LIKES Y COMENTARIOS DE FOTOS -------------
        
        // Dar like o quitar like a una foto
        window.toggleFotoLike = async function(fotoId) {
            if (!window.currentUser || !fotoId) {
                console.error('toggleFotoLike: No hay usuario o fotoId', { user: !!window.currentUser, fotoId });
                return false;
            }
            
            try {
                const userId = window.currentUser.uid;
                console.log('toggleFotoLike: Buscando like para fotoId:', fotoId, 'userId:', userId);
                const likesRef = collection(db, "fotoLikes");
                const q = query(likesRef, where("fotoId", "==", fotoId), where("userId", "==", userId));
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    // No hay like, agregar uno
                    console.log('toggleFotoLike: Agregando like');
                    await addDoc(likesRef, {
                        fotoId: fotoId,
                        userId: userId,
                        timestamp: Date.now()
                    });
                } else {
                    // Ya hay like, eliminarlo
                    console.log('toggleFotoLike: Eliminando like');
                    const deletePromises = snapshot.docs.map(docSnapshot => 
                        deleteDoc(doc(db, "fotoLikes", docSnapshot.id))
                    );
                    await Promise.all(deletePromises);
                }
                
                // Recargar likes
                await loadFotoLikes(fotoId);
                return true;
            } catch (error) {
                console.error('Error al dar like:', error);
                alert('Error al dar like: ' + error.message);
                return false;
            }
        };

        // Cargar likes de una foto
        async function loadFotoLikes(fotoId) {
            if (!fotoId) return;
            
            try {
                const likesRef = collection(db, "fotoLikes");
                const q = query(likesRef, where("fotoId", "==", fotoId));
                const snapshot = await getDocs(q);
                
                const likeCount = snapshot.size;
                const likeCountEl = document.getElementById('libraryImageLikeCount');
                if (likeCountEl) {
                    likeCountEl.textContent = likeCount;
                }
                
                // Verificar si el usuario actual dio like
                if (window.currentUser) {
                    const userLiked = snapshot.docs.some(doc => doc.data().userId === window.currentUser.uid);
                    const likeBtn = document.getElementById('libraryImageLikeBtn');
                    if (likeBtn) {
                        if (userLiked) {
                            likeBtn.classList.add('liked');
                        } else {
                            likeBtn.classList.remove('liked');
                        }
                    }
                }
            } catch (error) {
                console.error('Error al cargar likes:', error);
            }
        }

        // Agregar comentario a una foto (o respuesta a un comentario)
        window.addFotoComment = async function(fotoId, comentario, parentCommentId = null) {
            // Usar el fotoId del modal actual si no se proporciona uno
            if (!fotoId && window.currentFotoId) {
                fotoId = window.currentFotoId;
                console.log('addFotoComment: Usando fotoId del modal actual:', fotoId);
            }
            
            if (!window.currentUser || !fotoId || !comentario || comentario.trim() === '') {
                console.error('addFotoComment: Parámetros inválidos', { 
                    user: !!window.currentUser, 
                    fotoId, 
                    comentario: comentario ? comentario.trim() : '',
                    currentFotoId: window.currentFotoId
                });
                alert('Error: No se pudo identificar la foto. Por favor, cierra y vuelve a abrir la imagen.');
                return false;
            }
            
            try {
                const userId = window.currentUser.uid;
                console.log('addFotoComment: Agregando comentario para fotoId:', fotoId, 'parentCommentId:', parentCommentId);
                const userDoc = await getDoc(doc(db, "usuarios", userId));
                const nombreUsuario = userDoc.exists() ? (userDoc.data().nombre || 'Anónimo') : 'Anónimo';
                
                const comentariosRef = collection(db, "fotoComentarios");
                const commentData = {
                    fotoId: fotoId,  // Asegurar que el fotoId esté correctamente vinculado
                    userId: userId,
                    nombreUsuario: nombreUsuario,
                    comentario: comentario.trim(),
                    timestamp: Date.now()
                };
                
                // Si es una respuesta, agregar el parentCommentId
                if (parentCommentId) {
                    commentData.parentCommentId = parentCommentId;
                }
                
                await addDoc(comentariosRef, commentData);
                
                console.log('addFotoComment: Comentario agregado exitosamente para fotoId:', fotoId);
                
                // Recargar comentarios usando el mismo fotoId
                await loadFotoComments(fotoId);
                
                // Limpiar inputs
                const commentInput = document.getElementById('libraryImageCommentInput');
                if (commentInput) {
                    commentInput.value = '';
                }
                
                // Ocultar inputs de respuesta
                document.querySelectorAll('.comment-reply-input-container').forEach(container => {
                    container.classList.remove('active');
                    const input = container.querySelector('.comment-reply-input');
                    if (input) input.value = '';
                });
                
                return true;
            } catch (error) {
                console.error('Error al agregar comentario:', error);
                alert('Error al agregar el comentario: ' + error.message);
                return false;
            }
        };

        // Dar like o quitar like a un comentario
        window.toggleCommentLike = async function(commentId) {
            if (!window.currentUser || !commentId) {
                console.error('toggleCommentLike: No hay usuario o commentId');
                return false;
            }
            
            try {
                const userId = window.currentUser.uid;
                const likesRef = collection(db, "comentarioLikes");
                const q = query(likesRef, where("commentId", "==", commentId), where("userId", "==", userId));
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    // No hay like, agregar uno
                    await addDoc(likesRef, {
                        commentId: commentId,
                        userId: userId,
                        timestamp: Date.now()
                    });
                } else {
                    // Ya hay like, eliminarlo
                    const deletePromises = snapshot.docs.map(docSnapshot => 
                        deleteDoc(doc(db, "comentarioLikes", docSnapshot.id))
                    );
                    await Promise.all(deletePromises);
                }
                
                // Recargar comentarios para actualizar likes
                if (window.currentFotoId) {
                    await loadFotoComments(window.currentFotoId);
                }
                
                return true;
            } catch (error) {
                console.error('Error al dar like al comentario:', error);
                return false;
            }
        };

        // Cargar likes de un comentario
        async function loadCommentLikes(commentId) {
            if (!commentId) return { count: 0, userLiked: false };
            
            try {
                const likesRef = collection(db, "comentarioLikes");
                const q = query(likesRef, where("commentId", "==", commentId));
                const snapshot = await getDocs(q);
                
                const count = snapshot.size;
                const userLiked = window.currentUser ? 
                    snapshot.docs.some(doc => doc.data().userId === window.currentUser.uid) : false;
                
                return { count, userLiked };
            } catch (error) {
                console.error('Error al cargar likes del comentario:', error);
                return { count: 0, userLiked: false };
            }
        }

        // Función auxiliar para crear un elemento de comentario
        async function createCommentElement(data, isReply = false, parentAuthor = null) {
            const commentItem = document.createElement('div');
            commentItem.className = isReply ? 'comment-reply-item' : 'comment-item';
            commentItem.dataset.commentId = data.id;
            
            // Contenedor para foto de perfil
            const profilePicContainer = document.createElement('div');
            profilePicContainer.className = 'comment-profile-picture';
            
            // Cargar foto de perfil si hay userId
            if (data.userId && window.loadUserProfilePicture) {
                await window.loadUserProfilePicture(data.userId, profilePicContainer);
            } else {
                const placeholder = document.createElement('div');
                placeholder.className = 'placeholder';
                placeholder.textContent = '👤';
                profilePicContainer.appendChild(placeholder);
            }
            
            // Contenedor para el contenido del comentario
            const commentContent = document.createElement('div');
            commentContent.className = 'comment-content';
            
            // Si es una respuesta y tenemos el autor del comentario padre, mostrar indicador
            if (isReply && parentAuthor) {
                const replyIndicator = document.createElement('div');
                replyIndicator.className = 'comment-reply-indicator';
                replyIndicator.textContent = `Respondiendo a ${parentAuthor}`;
                commentContent.appendChild(replyIndicator);
            }
            
            const author = document.createElement('div');
            author.className = 'comment-author';
            author.textContent = data.nombreUsuario || 'Anónimo';
            
            const text = document.createElement('div');
            text.className = 'comment-text';
            text.textContent = data.comentario;
            
            // Cargar likes del comentario
            const likesData = await loadCommentLikes(data.id);
            
            // Acciones del comentario (tanto para comentarios principales como respuestas)
            const actions = document.createElement('div');
            actions.className = 'comment-actions';
            
            // Botón de like
            const likeBtn = document.createElement('button');
            likeBtn.className = 'comment-like-btn' + (likesData.userLiked ? ' liked' : '');
            likeBtn.dataset.commentId = data.id;
            likeBtn.innerHTML = `<span class="like-icon">${likesData.userLiked ? '❤️' : '🤍'}</span> <span class="like-count">${likesData.count}</span>`;
            likeBtn.onclick = async (e) => {
                e.stopPropagation();
                if (window.toggleCommentLike) {
                    await window.toggleCommentLike(data.id);
                }
            };
            
            // Botón de responder
            const replyBtn = document.createElement('button');
            replyBtn.className = 'comment-reply-btn';
            replyBtn.textContent = '💬 Responder';
            replyBtn.onclick = (e) => {
                e.stopPropagation();
                const replyContainer = commentItem.querySelector('.comment-reply-input-container');
                if (replyContainer) {
                    replyContainer.classList.toggle('active');
                    if (replyContainer.classList.contains('active')) {
                        const input = replyContainer.querySelector('.comment-reply-input');
                        if (input) input.focus();
                    }
                }
            };
            
            actions.appendChild(likeBtn);
            actions.appendChild(replyBtn);
            
            // Contenedor para input de respuesta
            const replyInputContainer = document.createElement('div');
            replyInputContainer.className = 'comment-reply-input-container';
            const replyInput = document.createElement('input');
            replyInput.type = 'text';
            replyInput.className = 'comment-reply-input';
            replyInput.placeholder = 'Escribe una respuesta...';
            const replySubmit = document.createElement('button');
            replySubmit.className = 'comment-reply-submit';
            replySubmit.textContent = 'Enviar';
            replySubmit.onclick = async (e) => {
                e.stopPropagation();
                const replyText = replyInput.value.trim();
                if (replyText && window.currentFotoId && window.addFotoComment) {
                    await window.addFotoComment(window.currentFotoId, replyText, data.id);
                }
            };
            replyInput.addEventListener('keypress', async (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const replyText = replyInput.value.trim();
                    if (replyText && window.currentFotoId && window.addFotoComment) {
                        await window.addFotoComment(window.currentFotoId, replyText, data.id);
                    }
                }
            });
            replyInputContainer.appendChild(replyInput);
            replyInputContainer.appendChild(replySubmit);
            
            commentContent.appendChild(author);
            commentContent.appendChild(text);
            commentContent.appendChild(actions);
            commentContent.appendChild(replyInputContainer);
            
            commentItem.appendChild(profilePicContainer);
            commentItem.appendChild(commentContent);
            
            return commentItem;
        }

        // Cargar comentarios de una foto
        async function loadFotoComments(fotoId) {
            if (!fotoId) {
                console.warn('loadFotoComments: No hay fotoId');
                return;
            }
            
            try {
                console.log('loadFotoComments: Cargando comentarios para fotoId:', fotoId);
                const comentariosRef = collection(db, "fotoComentarios");
                const q = query(comentariosRef, where("fotoId", "==", fotoId));
                const snapshot = await getDocs(q);
                console.log('loadFotoComments: Encontrados', snapshot.size, 'comentarios para fotoId:', fotoId);
                
                const commentsList = document.getElementById('libraryImageCommentsList');
                if (!commentsList) return;
                
                commentsList.innerHTML = '';
                
                if (snapshot.empty) {
                    commentsList.innerHTML = '<div style="text-align: center; color: #718096; padding: 20px;">No hay comentarios aún. ¡Sé el primero en comentar!</div>';
                    return;
                }
                
                // Separar comentarios principales de respuestas
                const allComments = snapshot.docs.map(docSnapshot => ({
                    id: docSnapshot.id,
                    ...docSnapshot.data()
                }));
                
                const mainComments = allComments.filter(c => !c.parentCommentId).sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
                const replies = allComments.filter(c => c.parentCommentId);
                
                // Función recursiva para construir el árbol de comentarios y respuestas
                async function buildCommentTree(comment, allReplies, depth = 0, parentAuthor = null) {
                    const element = await createCommentElement(comment, depth > 0, parentAuthor);
                    
                    // Buscar respuestas directas a este comentario (puede ser comentario principal o respuesta)
                    const directReplies = allReplies
                        .filter(r => r.parentCommentId === comment.id)
                        .sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
                    
                    if (directReplies.length > 0) {
                        const repliesContainer = document.createElement('div');
                        repliesContainer.className = 'comment-replies';
                        
                        // Construir recursivamente las respuestas (que pueden tener sus propias respuestas)
                        // Pasar el nombre del autor del comentario padre
                        const replyElements = await Promise.all(directReplies.map(reply => 
                            buildCommentTree(reply, allReplies, depth + 1, comment.nombreUsuario || 'Anónimo')
                        ));
                        
                        replyElements.forEach(replyEl => repliesContainer.appendChild(replyEl));
                        element.appendChild(repliesContainer);
                    }
                    
                    return element;
                }
                
                // Crear comentarios principales con sus respuestas (y respuestas a respuestas)
                const commentItems = await Promise.all(mainComments.map(mainComment => 
                    buildCommentTree(mainComment, replies, 0)
                ));
                
                // Agregar todos los comentarios al contenedor
                commentItems.forEach(item => commentsList.appendChild(item));
            } catch (error) {
                console.error('Error al cargar comentarios:', error);
                const commentsList = document.getElementById('libraryImageCommentsList');
                if (commentsList) {
                    commentsList.innerHTML = '<div style="text-align: center; color: #f56565; padding: 20px;">Error al cargar comentarios. Por favor, intenta de nuevo.</div>';
                }
            }
        }

        // Eliminar amigo
        window.removeFriend = async function(friendId) {
            if (!window.currentUser || !friendId) return false;
            
            try {
                const currentUserId = window.currentUser.uid;
                
                // Obtener datos de ambos usuarios
                const currentUserRef = doc(db, "usuarios", currentUserId);
                const friendUserRef = doc(db, "usuarios", friendId);
                
                const currentUserDoc = await getDoc(currentUserRef);
                const friendUserDoc = await getDoc(friendUserRef);
                
                if (!currentUserDoc.exists() || !friendUserDoc.exists()) {
                    alert('Error: Usuario no encontrado');
                    return false;
                }
                
                const currentUserAmigos = currentUserDoc.data().amigos || [];
                const friendUserAmigos = friendUserDoc.data().amigos || [];
                
                // Eliminar de ambas listas
                const updatedCurrentAmigos = currentUserAmigos.filter(id => id !== friendId);
                const updatedFriendAmigos = friendUserAmigos.filter(id => id !== currentUserId);
                
                // Actualizar ambas listas
                await updateDoc(currentUserRef, {
                    amigos: updatedCurrentAmigos
                });
                
                await updateDoc(friendUserRef, {
                    amigos: updatedFriendAmigos
                });
                
                return true;
            } catch (error) {
                console.error('Error al eliminar amigo:', error);
                alert('Error al eliminar el amigo');
                return false;
            }
        };

        // ----------- SISTEMA DE CHAT -------------
        let currentChatFriendId = null;
        let chatUnsubscribe = null;

        // Abrir chat con un amigo
        window.openChat = async function(friendId, friendData = null) {
            if (!window.currentUser || !friendId) return;
            
            try {
                // Cerrar chat anterior si existe
                if (chatUnsubscribe) {
                    chatUnsubscribe();
                    chatUnsubscribe = null;
                }
                
                currentChatFriendId = friendId;
                
                // Cargar datos del amigo si no se proporcionaron
                if (!friendData) {
                    const friendDoc = await getDoc(doc(db, "usuarios", friendId));
                    if (!friendDoc.exists()) {
                        alert('Usuario no encontrado');
                        return;
                    }
                    friendData = friendDoc.data();
                }
                
                const activeChat = document.getElementById('profileActiveChat');
                const headerName = document.getElementById('activeChatHeaderName');
                const headerPicture = document.getElementById('activeChatHeaderPicture');
                const messagesEl = document.getElementById('activeChatMessages');
                const chatInput = document.getElementById('activeChatInput');
                
                if (!activeChat || !headerName || !messagesEl) return;
                
                // Configurar header
                headerName.textContent = friendData.nombre || 'Amigo';
                
                if (friendData.fotoPerfil) {
                    headerPicture.innerHTML = `<img src="${friendData.fotoPerfil}" alt="Foto">`;
                } else {
                    headerPicture.innerHTML = '<div style="font-size: 1.2em;">👤</div>';
                }
                
                // Limpiar mensajes anteriores
                messagesEl.innerHTML = '';
                
                // Cargar mensajes
                await loadChatMessages(friendId);
                
                // Escuchar nuevos mensajes en tiempo real
                const messagesRef = collection(db, "mensajes");
                // Usar el chatId más pequeño alfabéticamente para mantener consistencia
                const chatId1 = `${window.currentUser.uid}_${friendId}`;
                const chatId2 = `${friendId}_${window.currentUser.uid}`;
                const finalChatId = chatId1 < chatId2 ? chatId1 : chatId2;
                
                // Usar query sin orderBy para evitar errores de índice
                const q = query(
                    messagesRef,
                    where("chatId", "==", finalChatId)
                );
                
                chatUnsubscribe = onSnapshot(q, async (snapshot) => {
                    const activeMessagesEl = document.getElementById('activeChatMessages');
                    if (!activeMessagesEl) {
                        console.error('No se encontró activeChatMessages en onSnapshot');
                        return;
                    }
                    
                    // Limpiar mensajes anteriores
                    activeMessagesEl.innerHTML = '';
                    
                    // Obtener todos los mensajes y ordenarlos por timestamp
                    const messages = [];
                    snapshot.forEach((doc) => {
                        const messageData = doc.data();
                        messages.push({
                            ...messageData,
                            id: doc.id
                        });
                    });
                    
                    // Ordenar por timestamp si no se usó orderBy
                    messages.sort((a, b) => {
                        const timeA = a.timestamp || 0;
                        const timeB = b.timestamp || 0;
                        return timeA - timeB;
                    });
                    
                    // Mostrar mensajes ordenados (cargar fotos de forma asíncrona)
                    for (const messageData of messages) {
                        await displayMessage(messageData);
                    }
                    
                    // Scroll al final
                    setTimeout(() => {
                        activeMessagesEl.scrollTop = activeMessagesEl.scrollHeight;
                    }, 100);
                }, (error) => {
                    console.error('Error en onSnapshot:', error);
                });
                
                // Ocultar sección de chats cuando se abre un chat activo
                const chatsSection = document.getElementById('profileChatsSection');
                if (chatsSection) {
                    chatsSection.style.display = 'none';
                }
                
                // Mostrar chat activo y asegurarse de que no esté minimizado
                activeChat.style.display = 'flex';
                activeChat.classList.remove('minimized');
                
                // Hacer scroll hacia el chat activo
                setTimeout(() => {
                    activeChat.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
                
                // Focus en el input
                if (chatInput) {
                    setTimeout(() => chatInput.focus(), 200);
                }
                
                // Marcar mensajes como leídos
                await markMessagesAsRead(friendId);
                
                // NO recargar lista de chats para evitar mostrar la foto y mensaje del amigo abajo
            } catch (error) {
                console.error('Error al abrir chat:', error);
                alert('Error al abrir el chat');
            }
        };

        // Cargar mensajes del chat
        async function loadChatMessages(friendId) {
            if (!window.currentUser) return;
            
            try {
                const messagesRef = collection(db, "mensajes");
                // Usar el chatId más pequeño alfabéticamente para mantener consistencia
                const chatId1 = `${window.currentUser.uid}_${friendId}`;
                const chatId2 = `${friendId}_${window.currentUser.uid}`;
                const finalChatId = chatId1 < chatId2 ? chatId1 : chatId2;
                
                const q = query(
                    messagesRef,
                    where("chatId", "==", finalChatId),
                    limit(50)
                );
                
                const snapshot = await getDocs(q);
                const messagesEl = document.getElementById('activeChatMessages');
                if (!messagesEl) {
                    console.error('No se encontró el elemento activeChatMessages');
                    return;
                }
                
                messagesEl.innerHTML = '';
                
                if (snapshot.empty) {
                    console.log('No hay mensajes en este chat');
                } else {
                    // Obtener todos los mensajes y ordenarlos por timestamp
                    const messages = [];
                    snapshot.forEach((doc) => {
                        const messageData = doc.data();
                        messages.push({
                            ...messageData,
                            id: doc.id
                        });
                    });
                    
                    // Ordenar por timestamp
                    messages.sort((a, b) => {
                        const timeA = a.timestamp || 0;
                        const timeB = b.timestamp || 0;
                        return timeA - timeB;
                    });
                    
                    // Mostrar mensajes ordenados
                    for (const messageData of messages) {
                        await displayMessage(messageData);
                    }
                }
                
                // Scroll al final
                setTimeout(() => {
                    messagesEl.scrollTop = messagesEl.scrollHeight;
                }, 100);
            } catch (error) {
                console.error('Error al cargar mensajes:', error);
                // Si hay error de índice, intentar sin orderBy
                try {
                    const messagesRef = collection(db, "mensajes");
                    const chatId1 = `${window.currentUser.uid}_${friendId}`;
                    const chatId2 = `${friendId}_${window.currentUser.uid}`;
                    const finalChatId = chatId1 < chatId2 ? chatId1 : chatId2;
                    
                    const q = query(
                        messagesRef,
                        where("chatId", "==", finalChatId),
                        limit(50)
                    );
                    
                    const snapshot = await getDocs(q);
                    const messagesEl = document.getElementById('activeChatMessages');
                    if (messagesEl) {
                        messagesEl.innerHTML = '';
                        const messagesToDisplay = [];
                        snapshot.forEach((doc) => {
                            messagesToDisplay.push(doc.data());
                        });
                        for (const messageData of messagesToDisplay) {
                            await displayMessage(messageData);
                        }
                        setTimeout(() => {
                            messagesEl.scrollTop = messagesEl.scrollHeight;
                        }, 100);
                    }
                } catch (retryError) {
                    console.error('Error al cargar mensajes (reintento):', retryError);
                }
            }
        }

        // Cache de fotos de perfil para evitar cargar múltiples veces
        const profilePicturesCache = {};
        
        // Cargar foto de perfil de un usuario
        async function loadUserProfilePicture(userId) {
            if (profilePicturesCache[userId]) {
                return profilePicturesCache[userId];
            }
            
            try {
                const userDoc = await getDoc(doc(db, "usuarios", userId));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    const fotoPerfil = userData.fotoPerfil || null;
                    profilePicturesCache[userId] = fotoPerfil;
                    return fotoPerfil;
                }
            } catch (error) {
                console.error('Error al cargar foto de perfil:', error);
            }
            
            return null;
        }
        
        // Mostrar un mensaje en el chat
        async function displayMessage(messageData) {
            const messagesEl = document.getElementById('activeChatMessages');
            if (!messagesEl) return;
            
            const isSent = messageData.fromUserId === window.currentUser.uid;
            const messageDiv = document.createElement('div');
            messageDiv.className = `active-chat-message ${isSent ? 'sent' : 'received'}`;
            
            const picture = document.createElement('div');
            picture.className = 'active-chat-message-picture';
            
            // Cargar foto de perfil del usuario que envió el mensaje
            const userId = messageData.fromUserId;
            const fotoPerfil = await loadUserProfilePicture(userId);
            
            if (fotoPerfil) {
                const img = document.createElement('img');
                img.src = fotoPerfil;
                img.alt = 'Foto de perfil';
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'cover';
                img.style.borderRadius = '50%';
                picture.appendChild(img);
            } else {
                picture.textContent = '👤';
            }
            
            const content = document.createElement('div');
            content.className = 'active-chat-message-content';
            
            const text = document.createElement('div');
            text.textContent = messageData.text || '';
            content.appendChild(text);
            
            const time = document.createElement('div');
            time.className = 'active-chat-message-time';
            const date = messageData.timestamp ? new Date(messageData.timestamp) : new Date();
            time.textContent = date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            content.appendChild(time);
            
            messageDiv.appendChild(picture);
            messageDiv.appendChild(content);
            messagesEl.appendChild(messageDiv);
        }

        // Enviar mensaje
        window.sendChatMessage = async function() {
            if (!window.currentUser || !currentChatFriendId) return;
            
            const chatInput = document.getElementById('activeChatInput');
            if (!chatInput) return;
            
            const text = chatInput.value.trim();
            if (!text) return;
            
            try {
                const chatId1 = `${window.currentUser.uid}_${currentChatFriendId}`;
                const chatId2 = `${currentChatFriendId}_${window.currentUser.uid}`;
                const finalChatId = chatId1 < chatId2 ? chatId1 : chatId2;
                
                await addDoc(collection(db, "mensajes"), {
                    chatId: finalChatId,
                    fromUserId: window.currentUser.uid,
                    toUserId: currentChatFriendId,
                    text: text,
                    timestamp: Date.now(),
                    read: false
                });
                
                // Limpiar input
                chatInput.value = '';
                
                // El onSnapshot se encargará de actualizar automáticamente en tiempo real
                // Scroll al final después de enviar (el onSnapshot también lo hará)
                setTimeout(() => {
                    const messagesEl = document.getElementById('activeChatMessages');
                    if (messagesEl) {
                        messagesEl.scrollTop = messagesEl.scrollHeight;
                    }
                }, 200);
            } catch (error) {
                console.error('Error al enviar mensaje:', error);
                alert('Error al enviar el mensaje');
            }
        };

        // Minimizar/maximizar chat
        window.toggleChatMinimize = function() {
            const activeChat = document.getElementById('profileActiveChat');
            const minimizeBtn = document.getElementById('activeChatMinimize');
            if (!activeChat) {
                console.error('No se encontró profileActiveChat');
                return;
            }
            
            const isMinimized = activeChat.classList.contains('minimized');
            if (isMinimized) {
                // Maximizar
                activeChat.classList.remove('minimized');
                if (minimizeBtn) {
                    minimizeBtn.textContent = '➖';
                }
                // Scroll al final cuando se maximiza
                setTimeout(() => {
                    const messagesEl = document.getElementById('activeChatMessages');
                    if (messagesEl) {
                        messagesEl.scrollTop = messagesEl.scrollHeight;
                    }
                }, 100);
            } else {
                // Minimizar - solo queda visible el header con la info del amigo
                activeChat.classList.add('minimized');
                if (minimizeBtn) {
                    minimizeBtn.textContent = '➕';
                }
            }
        };

        // Marcar mensajes como leídos
        async function markMessagesAsRead(friendId) {
            if (!window.currentUser) return;
            
            try {
                const messagesRef = collection(db, "mensajes");
                const chatId1 = `${window.currentUser.uid}_${friendId}`;
                const chatId2 = `${friendId}_${window.currentUser.uid}`;
                const finalChatId = chatId1 < chatId2 ? chatId1 : chatId2;
                
                const q = query(
                    messagesRef,
                    where("chatId", "==", finalChatId),
                    where("toUserId", "==", window.currentUser.uid),
                    where("read", "==", false)
                );
                
                const snapshot = await getDocs(q);
                const batch = writeBatch(db);
                
                snapshot.forEach((doc) => {
                    batch.update(doc.ref, { read: true });
                });
                
                await batch.commit();
            } catch (error) {
                console.error('Error al marcar mensajes como leídos:', error);
            }
        }

        // Cerrar chat
        window.closeChat = function() {
            const activeChat = document.getElementById('profileActiveChat');
            if (activeChat) {
                activeChat.style.display = 'none';
            }
            
            // Mostrar sección de chats cuando se cierra el chat activo
            const chatsSection = document.getElementById('profileChatsSection');
            if (chatsSection) {
                chatsSection.style.display = 'block';
            }
            
            if (chatUnsubscribe) {
                chatUnsubscribe();
                chatUnsubscribe = null;
            }
            
            currentChatFriendId = null;
        };

        // Cargar lista de chats
        window.loadChatsList = async function() {
            if (!window.currentUser) return;
            
            try {
                const userDoc = await getDoc(doc(db, "usuarios", window.currentUser.uid));
                if (!userDoc.exists()) return;
                
                const amigos = userDoc.data().amigos || [];
                const chatsListEl = document.getElementById('chatsList');
                const chatsSection = document.getElementById('profileChatsSection');
                
                if (!chatsListEl || !chatsSection) return;
                
                if (amigos.length === 0) {
                    chatsSection.style.display = 'none';
                    return;
                }
                
                chatsSection.style.display = 'block';
                chatsListEl.innerHTML = '';
                
                // Obtener últimos mensajes de cada amigo
                for (const friendId of amigos) {
                    try {
                        const friendDoc = await getDoc(doc(db, "usuarios", friendId));
                        if (friendDoc.exists()) {
                            const friendData = friendDoc.data();
                            
                            // Obtener último mensaje
                            const messagesRef = collection(db, "mensajes");
                            const chatId1 = `${window.currentUser.uid}_${friendId}`;
                            const chatId2 = `${friendId}_${window.currentUser.uid}`;
                            const finalChatId = chatId1 < chatId2 ? chatId1 : chatId2;
                            
                            const q = query(
                                messagesRef,
                                where("chatId", "==", finalChatId),
                                limit(50)
                            );
                            
                            const snapshot = await getDocs(q);
                            let lastMessage = null;
                            let unreadCount = 0;
                            
                            if (!snapshot.empty) {
                                // Obtener todos los mensajes y ordenarlos
                                const messages = [];
                                snapshot.forEach((doc) => {
                                    const messageData = doc.data();
                                    messages.push({
                                        ...messageData,
                                        id: doc.id
                                    });
                                });
                                
                                // Ordenar por timestamp descendente
                                messages.sort((a, b) => {
                                    const timeA = a.timestamp || 0;
                                    const timeB = b.timestamp || 0;
                                    return timeB - timeA;
                                });
                                
                                if (messages.length > 0) {
                                    lastMessage = messages[0];
                                }
                                
                                // Contar mensajes no leídos
                                const unreadQuery = query(
                                    messagesRef,
                                    where("chatId", "==", finalChatId),
                                    where("toUserId", "==", window.currentUser.uid),
                                    where("read", "==", false)
                                );
                                const unreadSnapshot = await getDocs(unreadQuery);
                                unreadCount = unreadSnapshot.size;
                            }
                            
                            const chatItem = document.createElement('div');
                            chatItem.className = 'chat-item';
                            chatItem.onclick = () => {
                                window.openChat(friendId, friendData);
                            };
                            
                            const picture = document.createElement('div');
                            picture.className = 'chat-item-picture';
                            if (friendData.fotoPerfil) {
                                const img = document.createElement('img');
                                img.src = friendData.fotoPerfil;
                                picture.appendChild(img);
                            } else {
                                picture.textContent = '👤';
                            }
                            
                            const info = document.createElement('div');
                            info.className = 'chat-item-info';
                            
                            const name = document.createElement('div');
                            name.className = 'chat-item-name';
                            name.textContent = friendData.nombre || 'Sin nombre';
                            
                            const lastMsg = document.createElement('div');
                            lastMsg.className = 'chat-item-last-message';
                            if (lastMessage) {
                                lastMsg.textContent = lastMessage.text || 'Sin mensajes';
                            } else {
                                lastMsg.textContent = 'Sin mensajes';
                            }
                            
                            info.appendChild(name);
                            info.appendChild(lastMsg);
                            
                            chatItem.appendChild(picture);
                            chatItem.appendChild(info);
                            
                            if (unreadCount > 0) {
                                const unread = document.createElement('div');
                                unread.className = 'chat-item-unread';
                                unread.textContent = unreadCount > 9 ? '9+' : unreadCount;
                                chatItem.appendChild(unread);
                            }
                            
                            chatsListEl.appendChild(chatItem);
                        }
                    } catch (error) {
                        console.error(`Error al cargar chat con ${friendId}:`, error);
                    }
                }
            } catch (error) {
                console.error('Error al cargar lista de chats:', error);
            }
        };

        // ----------- SISTEMA DE AMIGOS -------------
        // Buscar usuarios por nombre
        window.searchUsers = async function(searchTerm) {
            if (!searchTerm || searchTerm.trim().length < 2) {
                return [];
            }
            
            try {
                const usersRef = collection(db, "usuarios");
                const q = query(usersRef, where("nombre", ">=", searchTerm.trim()), where("nombre", "<=", searchTerm.trim() + "\uf8ff"));
                const snapshot = await getDocs(q);
                
                const users = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    // Excluir al usuario actual
                    if (doc.id !== window.currentUser.uid) {
                        users.push({
                            id: doc.id,
                            nombre: data.nombre || 'Sin nombre',
                            email: data.email || '',
                            fotoPerfil: data.fotoPerfil || null
                        });
                    }
                });
                
                return users;
            } catch (error) {
                console.error('Error al buscar usuarios:', error);
                return [];
            }
        };

        // Enviar solicitud de amistad
        window.sendFriendRequest = async function(toUserId) {
            if (!window.currentUser || !toUserId) return false;
            
            try {
                const fromUserId = window.currentUser.uid;
                
                // Verificar si ya existe una solicitud
                const requestsRef = collection(db, "solicitudesAmistad");
                const q = query(
                    requestsRef,
                    where("de", "==", fromUserId),
                    where("para", "==", toUserId),
                    where("estado", "==", "pendiente")
                );
                const existingRequest = await getDocs(q);
                
                if (!existingRequest.empty) {
                    alert('Ya has enviado una solicitud a este usuario');
                    return false;
                }
                
                // Verificar si ya son amigos
                const userDoc = await getDoc(doc(db, "usuarios", fromUserId));
                if (userDoc.exists()) {
                    const amigos = userDoc.data().amigos || [];
                    if (amigos.includes(toUserId)) {
                        alert('Ya son amigos');
                        return false;
                    }
                }
                
                // Crear solicitud
                await addDoc(collection(db, "solicitudesAmistad"), {
                    de: fromUserId,
                    para: toUserId,
                    estado: "pendiente",
                    fecha: Date.now()
                });
                
                return true;
            } catch (error) {
                console.error('Error al enviar solicitud:', error);
                return false;
            }
        };

        // Cargar solicitudes recibidas
        window.loadFriendRequests = async function() {
            if (!window.currentUser) return [];
            
            try {
                const requestsRef = collection(db, "solicitudesAmistad");
                const q = query(
                    requestsRef,
                    where("para", "==", window.currentUser.uid),
                    where("estado", "==", "pendiente")
                );
                const snapshot = await getDocs(q);
                
                const requests = [];
                for (const docSnap of snapshot.docs) {
                    const data = docSnap.data();
                    const fromUserDoc = await getDoc(doc(db, "usuarios", data.de));
                    if (fromUserDoc.exists()) {
                        const userData = fromUserDoc.data();
                        requests.push({
                            id: docSnap.id,
                            fromUserId: data.de,
                            nombre: userData.nombre || 'Sin nombre',
                            email: userData.email || '',
                            fotoPerfil: userData.fotoPerfil || null,
                            fecha: data.fecha
                        });
                    }
                }
                
                return requests;
            } catch (error) {
                console.error('Error al cargar solicitudes:', error);
                return [];
            }
        };

        // Aceptar solicitud de amistad
        window.acceptFriendRequest = async function(requestId, fromUserId) {
            if (!window.currentUser) return false;
            
            try {
                const currentUserId = window.currentUser.uid;
                
                // Actualizar estado de la solicitud
                const requestRef = doc(db, "solicitudesAmistad", requestId);
                await updateDoc(requestRef, {
                    estado: "aceptada"
                });
                
                // Agregar a la lista de amigos de ambos usuarios
                const currentUserRef = doc(db, "usuarios", currentUserId);
                const fromUserRef = doc(db, "usuarios", fromUserId);
                
                const currentUserDoc = await getDoc(currentUserRef);
                const fromUserDoc = await getDoc(fromUserRef);
                
                const currentUserAmigos = currentUserDoc.exists() ? (currentUserDoc.data().amigos || []) : [];
                const fromUserAmigos = fromUserDoc.exists() ? (fromUserDoc.data().amigos || []) : [];
                
                if (!currentUserAmigos.includes(fromUserId)) {
                    currentUserAmigos.push(fromUserId);
                }
                if (!fromUserAmigos.includes(currentUserId)) {
                    fromUserAmigos.push(currentUserId);
                }
                
                await updateDoc(currentUserRef, {
                    amigos: currentUserAmigos
                });
                
                await updateDoc(fromUserRef, {
                    amigos: fromUserAmigos
                });
                
                return true;
            } catch (error) {
                console.error('Error al aceptar solicitud:', error);
                return false;
            }
        };

        // Rechazar solicitud de amistad
        window.rejectFriendRequest = async function(requestId) {
            try {
                const requestRef = doc(db, "solicitudesAmistad", requestId);
                await updateDoc(requestRef, {
                    estado: "rechazada"
                });
                return true;
            } catch (error) {
                console.error('Error al rechazar solicitud:', error);
                return false;
            }
        };

        // Cargar lista de amigos
        window.loadFriendsList = async function() {
            if (!window.currentUser) return;
            
            try {
                const userDoc = await getDoc(doc(db, "usuarios", window.currentUser.uid));
                if (!userDoc.exists()) return;
                
                const amigos = userDoc.data().amigos || [];
                const friendsListEl = document.getElementById('friendsList');
                const friendsSection = document.getElementById('profileFriendsSection');
                
                if (!friendsListEl || !friendsSection) return;
                
                if (amigos.length === 0) {
                    friendsSection.style.display = 'none';
                    return;
                }
                
                friendsSection.style.display = 'block';
                friendsListEl.innerHTML = '';
                
                // Cargar información de cada amigo
                for (const friendId of amigos) {
                    try {
                        const friendDoc = await getDoc(doc(db, "usuarios", friendId));
                        if (friendDoc.exists()) {
                            const friendData = friendDoc.data();
                            const friendItem = document.createElement('div');
                            friendItem.className = 'friend-item';
                            
                            const picture = document.createElement('div');
                            picture.className = 'friend-item-picture';
                            if (friendData.fotoPerfil) {
                                const img = document.createElement('img');
                                img.src = friendData.fotoPerfil;
                                picture.appendChild(img);
                            } else {
                                picture.textContent = '👤';
                            }
                            
                            const name = document.createElement('div');
                            name.className = 'friend-item-name';
                            name.textContent = friendData.nombre || 'Sin nombre';
                            
                            // Botón para enviar mensaje
                            const messageBtn = document.createElement('button');
                            messageBtn.className = 'friend-item-message';
                            messageBtn.textContent = '💬';
                            messageBtn.title = 'Enviar mensaje';
                            messageBtn.onclick = async (e) => {
                                e.stopPropagation(); // Evitar que se abra el perfil
                                await window.openChat(friendId, friendData);
                            };
                            
                            // Botón para eliminar amigo
                            const removeBtn = document.createElement('button');
                            removeBtn.className = 'friend-item-remove';
                            removeBtn.textContent = '✕';
                            removeBtn.title = 'Eliminar amigo';
                            removeBtn.onclick = async (e) => {
                                e.stopPropagation(); // Evitar que se abra el perfil
                                if (confirm(`¿Estás seguro de que quieres eliminar a ${friendData.nombre || 'este amigo'}?`)) {
                                    const success = await window.removeFriend(friendId);
                                    if (success) {
                                        await window.loadFriendsList();
                                    }
                                }
                            };
                            
                            // Hacer el item clicable para ver el perfil del amigo
                            friendItem.style.cursor = 'pointer';
                            friendItem.onclick = () => {
                                window.showFriendProfile(friendId, friendData);
                            };
                            
                            friendItem.appendChild(picture);
                            friendItem.appendChild(name);
                            friendItem.appendChild(messageBtn);
                            friendItem.appendChild(removeBtn);
                            friendsListEl.appendChild(friendItem);
                        }
                    } catch (error) {
                        console.error(`Error al cargar amigo ${friendId}:`, error);
                    }
                }
            } catch (error) {
                console.error('Error al cargar lista de amigos:', error);
            }
        };

        // Mostrar modal de búsqueda de amigos
        window.showFriendsModal = function() {
            const modal = document.getElementById('friendsModal');
            if (modal) {
                modal.style.display = 'flex';
                document.getElementById('friendsResults').innerHTML = '';
                document.getElementById('friendsSearchInput').value = '';
            }
        };

        // Ocultar modal de búsqueda de amigos
        window.hideFriendsModal = function() {
            const modal = document.getElementById('friendsModal');
            if (modal) {
                modal.style.display = 'none';
            }
        };

        // Mostrar modal de bandeja
        window.showInboxModal = async function() {
            const modal = document.getElementById('inboxModal');
            if (modal) {
                modal.style.display = 'flex';
                await window.loadInboxRequests();
            }
        };

        // Ocultar modal de bandeja
        window.hideInboxModal = function() {
            const modal = document.getElementById('inboxModal');
            if (modal) {
                modal.style.display = 'none';
            }
        };

        // Cargar solicitudes en la bandeja
        window.loadInboxRequests = async function() {
            const requestsEl = document.getElementById('inboxRequests');
            if (!requestsEl) return;
            
            requestsEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #718096;">Cargando...</div>';
            
            const requests = await window.loadFriendRequests();
            
            if (requests.length === 0) {
                requestsEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #718096;">No tienes solicitudes pendientes</div>';
                return;
            }
            
            requestsEl.innerHTML = '';
            requests.forEach(request => {
                const requestItem = document.createElement('div');
                requestItem.className = 'inbox-request-item';
                
                const picture = document.createElement('div');
                picture.className = 'friend-result-picture';
                if (request.fotoPerfil) {
                    const img = document.createElement('img');
                    img.src = request.fotoPerfil;
                    picture.appendChild(img);
                } else {
                    picture.textContent = '👤';
                }
                
                const info = document.createElement('div');
                info.className = 'friend-result-info';
                const name = document.createElement('div');
                name.className = 'friend-result-name';
                name.textContent = request.nombre;
                const email = document.createElement('div');
                email.className = 'friend-result-email';
                email.textContent = request.email;
                info.appendChild(name);
                info.appendChild(email);
                
                const actions = document.createElement('div');
                actions.className = 'inbox-request-actions';
                
                const acceptBtn = document.createElement('button');
                acceptBtn.className = 'accept-request-btn';
                acceptBtn.textContent = '✓ Aceptar';
                acceptBtn.onclick = async () => {
                    acceptBtn.disabled = true;
                    const success = await window.acceptFriendRequest(request.id, request.fromUserId);
                    if (success) {
                        await window.loadInboxRequests();
                        await window.loadFriendsList();
                    } else {
                        alert('Error al aceptar la solicitud');
                        acceptBtn.disabled = false;
                    }
                };
                
                const rejectBtn = document.createElement('button');
                rejectBtn.className = 'reject-request-btn';
                rejectBtn.textContent = '✕ Rechazar';
                rejectBtn.onclick = async () => {
                    rejectBtn.disabled = true;
                    const success = await window.rejectFriendRequest(request.id);
                    if (success) {
                        await window.loadInboxRequests();
                    } else {
                        alert('Error al rechazar la solicitud');
                        rejectBtn.disabled = false;
                    }
                };
                
                actions.appendChild(acceptBtn);
                actions.appendChild(rejectBtn);
                
                requestItem.appendChild(picture);
                requestItem.appendChild(info);
                requestItem.appendChild(actions);
                requestsEl.appendChild(requestItem);
            });
        }

        // ----------- GUARDAR PUNTUACIÓN -------------
        window.guardarPuntuacion = async function(nombre, puntos, nivel) {
            try {
                const userId = window.currentUser ? window.currentUser.uid : null;
                const nivelActual = nivel || 'unknown';
                
                // Si hay un usuario autenticado, buscar si ya tiene una puntuación en este nivel
                if (userId) {
                    // Obtener todas las puntuaciones del usuario para este nivel
                    const q = query(
                        collection(db, "puntuaciones"),
                        where("userId", "==", userId)
                    );
                    
                    const snapshot = await getDocs(q);
                    
                    // Buscar si ya existe una puntuación para este nivel
                    let existingDoc = null;
                    let existingData = null;
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.nivel === nivelActual) {
                            existingDoc = doc;
                            existingData = data;
                        }
                    });
                    
                    if (existingDoc && existingData) {
                        // El usuario ya tiene una puntuación en este nivel
                        // Solo actualizar si la nueva puntuación es mejor
                        if (puntos > existingData.puntos) {
                            await updateDoc(existingDoc.ref, {
                                nombre: nombre,
                                puntos: puntos,
                                fecha: Date.now()
                            });
                            console.log("✔ Puntuación actualizada (mejor puntuación)");
                            return true;
                        } else {
                            console.log("ℹ Puntuación no actualizada (la anterior era mejor)");
                            return true; // No es un error, simplemente no se actualiza
                        }
                    }
                }
                
                // Si no hay puntuación existente o no hay usuario, crear una nueva
                await addDoc(collection(db, "puntuaciones"), {
                    nombre: nombre,
                    puntos: puntos,
                    nivel: nivelActual,
                    fecha: Date.now(),
                    userId: userId
                });
                console.log("✔ Puntuación guardada");
                return true;
            } catch (e) {
                console.error("Error al guardar puntuación: ", e);
                return false;
            }
        };

        // ----------- OBTENER RANKING ----------------
        window.obtenerRanking = async function(nivel) {
            try {
                let q;
                
                if (nivel) {
                    // Obtener todas las puntuaciones y filtrar por nivel en JavaScript
                    // Esto evita el problema del índice compuesto
                    q = query(
                        collection(db, "puntuaciones"),
                        orderBy("puntos", "desc")
                    );
                } else {
                    // Sin filtro (todos los niveles)
                    q = query(
                        collection(db, "puntuaciones"),
                        orderBy("puntos", "desc"),
                        limit(10)
                    );
                }

                const snapshot = await getDocs(q);
                const resultados = [];

                // Verificar cada puntuación para ver si el usuario aún existe
                for (const docSnapshot of snapshot.docs) {
                    const data = docSnapshot.data();
                    
                    // Si se especificó un nivel, filtrar por ese nivel
                    if (nivel && data.nivel !== nivel) {
                        continue;
                    }
                    
                    // Si tiene userId, verificar si el usuario aún existe
                    if (data.userId) {
                        try {
                            // Verificar si el usuario existe en la colección de usuarios
                            const userDoc = await getDoc(doc(db, "usuarios", data.userId));
                            if (!userDoc.exists()) {
                                // El usuario no existe en la colección, omitir esta puntuación
                                console.log(`Usuario ${data.userId} no existe en usuarios, omitiendo puntuación`);
                                continue;
                            }
                            
                            // Verificar también que el documento tenga un nombre válido
                            const userData = userDoc.data();
                            if (!userData || !userData.nombre) {
                                // El documento existe pero no tiene datos válidos, omitir
                                console.log(`Usuario ${data.userId} no tiene datos válidos, omitiendo puntuación`);
                                continue;
                            }
                            
                            // Verificar que el nombre en la puntuación coincida EXACTAMENTE con el nombre del usuario
                            // Si no coincide, puede ser que el usuario fue eliminado y recreado, o que hay una inconsistencia
                            if (data.nombre && userData.nombre) {
                                if (data.nombre.trim() !== userData.nombre.trim()) {
                                    // Los nombres no coinciden exactamente, omitir esta puntuación
                                    console.log(`Nombre no coincide para usuario ${data.userId}: "${data.nombre}" vs "${userData.nombre}", omitiendo puntuación`);
                                    continue;
                                }
                            } else if (data.nombre && !userData.nombre) {
                                // La puntuación tiene nombre pero el usuario no, omitir
                                console.log(`Usuario ${data.userId} no tiene nombre en su documento, omitiendo puntuación`);
                                continue;
                            }
                            
                            // Verificar que el documento no esté marcado como eliminado (si agregamos ese campo en el futuro)
                            if (userData.eliminado === true) {
                                console.log(`Usuario ${data.userId} está marcado como eliminado, omitiendo puntuación`);
                                continue;
                            }
                            
                            // Si el usuario existe y tiene datos válidos, agregar al ranking
                            resultados.push(data);
                        } catch (error) {
                            // Si hay error al verificar, omitir esta puntuación por seguridad
                            console.log(`Error al verificar usuario ${data.userId}:`, error);
                            continue;
                        }
                    } else {
                        // Si no tiene userId (puntuación anónima), incluirla
                        resultados.push(data);
                    }
                }
                
                // Ordenar por puntos (por si acaso) y limitar a 10
                resultados.sort((a, b) => (b.puntos || 0) - (a.puntos || 0));
                return resultados.slice(0, 10);
            } catch (e) {
                console.error("Error al obtener ranking: ", e);
                return [];
            }
        };
    </script>
</body>
</html>

